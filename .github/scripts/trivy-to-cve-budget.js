#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

function loadJson(filePath) {
  return JSON.parse(fs.readFileSync(filePath, 'utf8'));
}

function normalizeSeverity(value) {
  return (value || 'UNKNOWN').toUpperCase();
}

function selectCvss(vuln) {
  const sources = ['nvd', 'redhat', 'github'];
  for (const source of sources) {
    const score = vuln.CVSS?.[source]?.V3Score || vuln.CVSS?.[source]?.score;
    if (typeof score === 'number') {
      return score;
    }
  }
  return vuln.CVSS?.nvd?.V2Score || null;
}

function buildReport(trivyPath, serviceName, sbomPath, outputPath) {
  const trivyResult = loadJson(trivyPath);
  const vulnerabilities = [];

  for (const result of trivyResult.Results || []) {
    for (const vuln of result.Vulnerabilities || []) {
      vulnerabilities.push({
        id: vuln.VulnerabilityID || 'UNKNOWN',
        package: vuln.PkgName || result.Target,
        severity: normalizeSeverity(vuln.Severity),
        cvss: selectCvss(vuln),
        fix_available: Boolean(vuln.FixedVersion),
      });
    }
  }

  const report = {
    generated_at: new Date().toISOString(),
    scanner: 'trivy',
    services: [
      {
        name: serviceName,
        artifacts: [
          {
            type: 'sbom',
            image: serviceName,
            digest: '',
            sbom: path.resolve(sbomPath),
            signed: true,
            attestations: [
              {
                type: 'sbom',
                predicateType: 'spdx',
                verified: true,
              },
            ],
            vulnerabilities,
          },
        ],
      },
    ],
  };

  fs.writeFileSync(outputPath, JSON.stringify(report, null, 2));
  console.log(`Wrote Trivy vulnerability report to ${outputPath}`);
}

function main() {
  const [trivyPath, serviceName, sbomPath, outputPath] = process.argv.slice(2);
  if (!trivyPath || !serviceName || !sbomPath || !outputPath) {
    console.error(
      'Usage: node trivy-to-cve-budget.js <trivy.json> <service-name> <sbom-path> <output-path>',
    );
    process.exit(1);
  }

  buildReport(trivyPath, serviceName, sbomPath, outputPath);
}

main();
