name: sigstore-verify
description: Verify artifacts with cosign bundle-first inputs and version floor checks.
inputs:
  cosign_version:
    description: "Cosign version to install (e.g., 3.0.4)."
    required: true
  artifact_path:
    description: "Artifact path or reference to verify."
    required: true
  bundle_path:
    description: "Sigstore bundle file path."
    required: true
  trusted_root:
    description: "Optional trusted_root.json path."
    required: false
  signing_config:
    description: "Optional signing_config.json path."
    required: false
  require_trusted_root:
    description: "Require TRUSTED_ROOT to be set and valid."
    default: "false"
    required: false
  require_signing_config:
    description: "Require SIGNING_CONFIG to be set and valid."
    default: "false"
    required: false
runs:
  using: composite
  steps:
    - name: Verify cosign version floor
      shell: bash
      run: |
        set -euo pipefail
        COSIGN_VERSION="${{ inputs.cosign_version }}"
        case "$COSIGN_VERSION" in
          2.*)
            echo "cosign 2.x must be >= 2.6.2 due to CVE-2026-22703"; exit 1;;
          3.0.[0-3])
            echo "cosign 3.0.x must be >= 3.0.4 due to CVE-2026-22703"; exit 1;;
        esac

    - name: Install cosign (pinned)
      shell: bash
      run: |
        set -euo pipefail
        v="${{ inputs.cosign_version }}"
        os="$(uname | tr '[:upper:]' '[:lower:]')"
        arch="$(uname -m)"
        case "$arch" in
          x86_64) arch="amd64";;
          aarch64|arm64) arch="arm64";;
        esac
        curl -sSfL -o cosign "https://github.com/sigstore/cosign/releases/download/v${v}/cosign-${os}-${arch}"
        chmod +x cosign
        install_dir="/usr/local/bin"
        if [ ! -w "$install_dir" ]; then
          install_dir="$HOME/.local/bin"
          mkdir -p "$install_dir"
          echo "$install_dir" >> "$GITHUB_PATH"
        fi
        mv cosign "$install_dir/cosign"

    - name: Verify bundle signature
      shell: bash
      env:
        ARTIFACT: ${{ inputs.artifact_path }}
        BUNDLE: ${{ inputs.bundle_path }}
        TRUSTED_ROOT: ${{ inputs.trusted_root }}
        SIGNING_CONFIG: ${{ inputs.signing_config }}
        REQUIRE_TRUSTED_ROOT: ${{ inputs.require_trusted_root }}
        REQUIRE_SIGNING_CONFIG: ${{ inputs.require_signing_config }}
        SUMMIT_ATTESTATION_REQUIRED: "1"
      run: |
        set -euo pipefail
        bash ci/attest/verify.sh
