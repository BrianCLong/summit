name: sigstore-verify
description: Bundle-first Sigstore/Cosign verification with pinned cosign and evidence output
inputs:
  cosign_version:
    required: true
    default: "3.0.4"
  artifact:
    required: true
  bundle:
    required: true
  trusted_root:
    required: false
  signing_config:
    required: false
  evidence_id:
    required: true
runs:
  using: composite
  steps:
    - name: Verify cosign version floor
      shell: bash
      run: |
        set -euo pipefail
        .github/scripts/sigstore/check-cosign-version.sh "${{ inputs.cosign_version }}"
    - name: Install cosign (pinned)
      shell: bash
      run: |
        set -euo pipefail
        version="${{ inputs.cosign_version }}"
        os="$(uname | tr '[:upper:]' '[:lower:]')"
        arch="$(uname -m)"
        case "$arch" in
          x86_64) arch="amd64" ;;
          aarch64|arm64) arch="arm64" ;;
          *) echo "unsupported architecture: $arch" >&2; exit 1 ;;
        esac
        cosign_path="${RUNNER_TEMP}/cosign"
        curl -sSfL -o "$cosign_path" \
          "https://github.com/sigstore/cosign/releases/download/v${version}/cosign-${os}-${arch}"
        chmod +x "$cosign_path"
        echo "${RUNNER_TEMP}" >> "$GITHUB_PATH"
    - name: Verify (bundle-first)
      shell: bash
      run: |
        set -euo pipefail
        trusted_root="${{ inputs.trusted_root }}"
        signing_config="${{ inputs.signing_config }}"
        args=()
        if [[ -n "$trusted_root" ]]; then
          args+=(--trusted-root "$trusted_root")
        fi
        if [[ -n "$signing_config" ]]; then
          args+=(--signing-config "$signing_config")
        fi
        .github/scripts/sigstore/verify.sh \
          --artifact "${{ inputs.artifact }}" \
          --bundle "${{ inputs.bundle }}" \
          "${args[@]}" \
          --evidence-id "${{ inputs.evidence_id }}"
