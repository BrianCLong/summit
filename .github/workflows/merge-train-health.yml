name: Merge Train Health Check

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: read
  issues: write # For creating health report issues

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p gh &>/dev/null || {
            echo "Installing gh CLI..."
            (type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)) \
            && sudo mkdir -p -m 755 /etc/apt/keyrings \
            && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
            && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt update \
            && sudo apt install gh -y
          }

      - name: Configure GitHub CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      - name: Run health dashboard
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/merge-train-health-dashboard.sh
          ./scripts/merge-train-health-dashboard.sh

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: merge-train-health-report-${{ github.run_number }}
          path: /tmp/merge-train-health-*.md
          retention-days: 30

      - name: Extract health metrics
        id: metrics
        run: |
          REPORT=$(cat /tmp/merge-train-health-*.md)

          # Extract key metrics
          OPEN_PRS=$(echo "$REPORT" | grep "Total Open PRs" | grep -oE '[0-9]+' | head -1)
          CONFLICT_RATE=$(echo "$REPORT" | grep "Conflicting PRs" | grep -oE '[0-9]+\.[0-9]+' | head -1)
          HEALTH_SCORE=$(echo "$REPORT" | grep "Score:" | grep -oE '[0-9]+' | head -1)

          echo "open_prs=$OPEN_PRS" >> $GITHUB_OUTPUT
          echo "conflict_rate=$CONFLICT_RATE" >> $GITHUB_OUTPUT
          echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT

      - name: Create health report issue
        if: steps.metrics.outputs.health_score < 60
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPORT_CONTENT=$(cat /tmp/merge-train-health-*.md)

          gh issue create \
            --title "🚨 Merge Train Health Alert - Score: ${{ steps.metrics.outputs.health_score }}/100" \
            --label "merge-train,alert" \
            --body "## Merge Train Health Alert

          **Health Score:** ${{ steps.metrics.outputs.health_score }}/100 (CRITICAL)
          **Open PRs:** ${{ steps.metrics.outputs.open_prs }}
          **Conflict Rate:** ${{ steps.metrics.outputs.conflict_rate }}%

          ### Full Report

          \`\`\`
          $REPORT_CONTENT
          \`\`\`

          ### Recommended Actions

          1. Run \`make mt-triage\` to process conflicting PRs
          2. Run \`make mt-close-stale\` to clean up old drafts
          3. Review and merge express lane PRs: \`make mt-express-lane\`
          4. Check runbook: \`docs/merge-train-runbook.md\`

          ---

          🤖 Auto-generated by merge-train-health workflow"

      - name: Post to Slack (if configured)
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_MERGE_TRAIN_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            HEALTH_SCORE="${{ steps.metrics.outputs.health_score }}"
            OPEN_PRS="${{ steps.metrics.outputs.open_prs }}"
            CONFLICT_RATE="${{ steps.metrics.outputs.conflict_rate }}"

            if [ "$HEALTH_SCORE" -lt 60 ]; then
              COLOR="danger"
              STATUS="🚨 CRITICAL"
            elif [ "$HEALTH_SCORE" -lt 80 ]; then
              COLOR="warning"
              STATUS="⚠️ NEEDS ATTENTION"
            else
              COLOR="good"
              STATUS="✅ HEALTHY"
            fi

            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d "{
                \"attachments\": [{
                  \"color\": \"$COLOR\",
                  \"title\": \"Merge Train Health Report\",
                  \"text\": \"$STATUS\",
                  \"fields\": [
                    {\"title\": \"Health Score\", \"value\": \"$HEALTH_SCORE/100\", \"short\": true},
                    {\"title\": \"Open PRs\", \"value\": \"$OPEN_PRS\", \"short\": true},
                    {\"title\": \"Conflict Rate\", \"value\": \"$CONFLICT_RATE%\", \"short\": true}
                  ],
                  \"footer\": \"Merge Train Monitor\",
                  \"ts\": $(date +%s)
                }]
              }"
          fi

      - name: Comment on open PRs if unhealthy
        if: steps.metrics.outputs.health_score < 70
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PRs that are blocking (old + conflicting)
          gh pr list --state open --limit 50 --json number,createdAt,mergeable | \
            jq -r '.[] | select(.mergeable == "CONFLICTING" and ((now - (.createdAt | fromdateiso8601)) / 86400) > 60) | .number' | \
            head -10 | \
            while read pr; do
              gh pr comment "$pr" --body "⚠️ **Merge Train Health Notice**

              This PR has been in a conflicting state for >60 days and is contributing to merge train congestion.

              Please either:
              1. Rebase and resolve conflicts: \`git fetch origin && git rebase origin/main\`
              2. Close if no longer needed

              Current merge train health: ${{ steps.metrics.outputs.health_score }}/100

              See [merge train runbook](../blob/main/docs/merge-train-runbook.md) for guidance.

              ---
              🤖 Auto-generated by merge-train-health workflow"
            done || true
