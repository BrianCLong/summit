name: maestro-ci
on: [push, pull_request]
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm ci
      - run: npm run lint && npm run test
      - run: docker build -t ghcr.io/${{ github.repository }}/maestro-conductor:$GITHUB_SHA .
      - run: echo $CR_PAT | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
      - run: docker push ghcr.io/${{ github.repository }}/maestro-conductor:$GITHUB_SHA
      - uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository }}/maestro-conductor:${{ github.sha }}
      - uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository }}/maestro-conductor:${{ github.sha }}
      - uses: sigstore/cosign-installer@v3
      - run: cosign sign --yes ghcr.io/${{ github.repository }}/maestro-conductor:${{ github.sha }}
  chart-release:
    if: github.ref == 'refs/heads/main'
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
      - run: helm lint deploy/helm/maestro
      - run: helm package deploy/helm/maestro --version 0.1.$GITHUB_RUN_NUMBER
      - uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
