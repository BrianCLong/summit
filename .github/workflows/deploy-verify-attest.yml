name: deploy-verify-attest
on:
  workflow_dispatch:
    inputs:
      chart:
        description: 'Chart path (e.g., charts/maestro)'
        required: true
      namespace:
        description: 'K8s namespace'
        required: true
      release:
        description: 'Helm release name'
        required: true
permissions:
  contents: read
  id-token: write
jobs:
  verify-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cosign install
        uses: sigstore/cosign-installer@v3.6.0
      - name: Verify images (sign + attest) from values
        id: verify
        run: |
          node tools/policy/collect-chart-images.js "${{ github.event.inputs.chart }}" > /tmp/images.txt
          while read -r ref; do
            echo "Verifying $ref"
            cosign verify $ref
            cosign verify-attestation --type spdx $ref
            cosign verify-attestation --type slsa-provenance $ref
          done < /tmp/images.txt
      - name: Helm upgrade --install
        uses: azure/setup-helm@v4
      - name: Deploy
        run: |
          helm upgrade --install "${{ github.event.inputs.release }}" "${{ github.event.inputs.chart }}" \
            --namespace "${{ github.event.inputs.namespace }}" --create-namespace