name: Release SLO Weekly Report

on:
  schedule:
    - cron: "0 16 * * 1"
  workflow_dispatch:
    inputs:
      days:
        description: "Days to include in report"
        type: number
        default: 7
      create_issue:
        description: "Post report to rolling issue"
        type: boolean
        default: false

permissions:
  contents: read
  actions: read
  issues: write

env:
  DASHBOARD_WORKFLOW: release-train-dashboard.yml
  DASHBOARD_ARTIFACT: release-train-dashboard

jobs:
  generate-report:
    name: Generate Release SLO Report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.0.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Collect dashboard artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          DAYS=${{ github.event.inputs.days || 7 }}
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SINCE=$(date -u -d "${DAYS} days ago" +"%Y-%m-%dT%H:%M:%SZ")

          mkdir -p dist/release-slo/input

          RUNS_JSON=$(gh api "repos/${GITHUB_REPOSITORY}/actions/workflows/${DASHBOARD_WORKFLOW}/runs" -f status=completed -f per_page=100)
          RUN_IDS=$(echo "${RUNS_JSON}" | jq -r --arg since "${SINCE}" '.workflow_runs[] | select(.run_started_at >= $since) | .id')

          if [[ -z "${RUN_IDS}" ]]; then
            echo "::error::No workflow runs found since ${SINCE}"
            exit 1
          fi

          for RUN_ID in ${RUN_IDS}; do
            ARTIFACT_JSON=$(gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}/artifacts")
            ARTIFACT_ID=$(echo "${ARTIFACT_JSON}" | jq -r --arg name "${DASHBOARD_ARTIFACT}" '.artifacts[] | select(.name == $name) | .id' | head -n 1)
            if [[ -z "${ARTIFACT_ID}" || "${ARTIFACT_ID}" == "null" ]]; then
              echo "::warning::No dashboard artifact for run ${RUN_ID}"
              continue
            fi

            TARGET_DIR="dist/release-slo/input/${RUN_ID}"
            mkdir -p "${TARGET_DIR}"
            gh api "repos/${GITHUB_REPOSITORY}/actions/artifacts/${ARTIFACT_ID}/zip" > "${TARGET_DIR}/artifact.zip"
            unzip -q "${TARGET_DIR}/artifact.zip" -d "${TARGET_DIR}"
            if [[ -f "${TARGET_DIR}/artifacts/release-train/dashboard.json" ]]; then
              mv "${TARGET_DIR}/artifacts/release-train/dashboard.json" "${TARGET_DIR}/dashboard.json"
            fi
            if [[ -f "${TARGET_DIR}/dashboard.json" ]]; then
              sha256sum "${TARGET_DIR}/dashboard.json" > "${TARGET_DIR}/dashboard.json.sha256"
            fi
          done

          echo "now=${NOW}" >> $GITHUB_OUTPUT
          echo "since=${SINCE}" >> $GITHUB_OUTPUT

      - name: Extract release metrics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REQUIRE_DASHBOARD_SHA256: "1"
        run: |
          node scripts/release/extract_release_metrics.mjs \
            --dashboard-dir dist/release-slo/input \
            --output-dir dist/release-metrics

      - name: Generate weekly report
        run: |
          DAYS=${{ github.event.inputs.days || 7 }}
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          node scripts/release/generate_release_slo_report.mjs \
            --metrics-path dist/release-metrics/release-metrics.jsonl \
            --output-dir dist/release-slo \
            --slo-config release/RELEASE_SLO.yml \
            --days "${DAYS}" \
            --now "${NOW}"

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-metrics
          path: dist/release-metrics
          retention-days: 30
          if-no-files-found: error

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-slo-report
          path: dist/release-slo
          retention-days: 30
          if-no-files-found: error

      - name: Update Release SLO Weekly issue
        if: ${{ github.event.inputs.create_issue == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const reportPath = path.join('dist', 'release-slo', 'weekly-report.md');
            const reportBody = fs.readFileSync(reportPath, 'utf8');
            const title = 'Release SLO Weekly';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            let issue = issues.find((item) => item.title === title);
            if (!issue) {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: 'Rolling Release SLO weekly report thread.',
              });
              issue = created.data;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: reportBody,
            });
