name: deception-simulation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  sim:
    runs-on: ubuntu-latest
    continue-on-error: true   # informational by policy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create reports directory
        run: mkdir -p reports/deception

      - name: Run deception simulation
        run: |
          # If simulation script exists, run it
          if [ -f "./scripts/run-deception-sim.sh" ]; then
            ./scripts/run-deception-sim.sh
          else
            # Create mock baseline and current reports for testing
            cat > reports/deception/baseline.json << 'EOF'
          {
            "run_id": "baseline-001",
            "detection_latency_ms": 1200,
            "evasion_rate": 0.15,
            "false_negatives": 3,
            "blast_radius_score": 25
          }
          EOF

            cat > reports/deception/current.json << 'EOF'
          {
            "run_id": "current-${{ github.sha }}",
            "detection_latency_ms": 1150,
            "evasion_rate": 0.12,
            "false_negatives": 2,
            "blast_radius_score": 22
          }
          EOF
            echo "âœ… Mock deception simulation complete (no script found)"
          fi

      - name: Publish deception simulation report
        uses: actions/upload-artifact@v4
        with:
          name: deception-sim-report
          path: reports/deception/**
          retention-days: 30

      - name: Report status
        if: always()
        run: |
          echo "## ðŸŽ­ Deception Simulation (Informational)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow provides security metrics but does not block merges." >> $GITHUB_STEP_SUMMARY
          echo "Review the deception simulation report artifact for detailed analysis." >> $GITHUB_STEP_SUMMARY
