# Golden Path CI/CD Pipeline
#
# Main orchestrator workflow that composes all pipeline stages.
# Services call this workflow to get the full Golden Path experience.
#
# Usage:
#   jobs:
#     pipeline:
#       uses: ./.github/workflows/_golden-path-pipeline.yml
#       with:
#         service: my-service
#       secrets: inherit

name: Golden Path Pipeline

on:
  workflow_call:
    inputs:
      service:
        description: "Service name"
        required: true
        type: string
      working-directory:
        description: "Working directory for the service"
        required: false
        type: string
        default: "."
      environment:
        description: "Target environment (staging, production)"
        required: false
        type: string
        default: "staging"
      node-version:
        description: "Node.js version"
        required: false
        type: string
        default: "20"
      skip-security:
        description: "Skip security scanning (requires exception)"
        required: false
        type: boolean
        default: false
      skip-deploy:
        description: "Skip deployment stage"
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: "Minimum code coverage percentage"
        required: false
        type: number
        default: 80
      canary-enabled:
        description: "Enable canary SLO guard + rollback"
        required: false
        type: boolean
        default: false
      prometheus-url:
        description: "Prometheus base URL for canary checks (optional)"
        required: false
        type: string
        default: ""
      canary-window:
        description: "Prometheus range window for canary checks"
        required: false
        type: string
        default: "10m"
      canary-slo-p95-ms:
        description: "Latency SLO p95 threshold in ms"
        required: false
        type: number
        default: 1500
      canary-error-rate:
        description: "Error rate threshold (ratio)"
        required: false
        type: number
        default: 0.01
      canary-saturation-max:
        description: "Resource saturation threshold (ratio)"
        required: false
        type: number
        default: 0.8
      rollback-enabled:
        description: "Enable automatic rollback on canary breach"
        required: false
        type: boolean
        default: true

    outputs:
      image:
        description: "Built container image"
        value: ${{ jobs.build.outputs.image }}
      digest:
        description: "Image digest"
        value: ${{ jobs.build.outputs.digest }}
      deployed:
        description: "Whether deployment was successful"
        value: ${{ jobs.verify.outputs.success }}

env:
  SERVICE_NAME: ${{ inputs.service }}
  WORKING_DIR: ${{ inputs.working-directory }}

jobs:
  # ============================================================================
  # Stage 1: Lint
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v4
        with:
          cache: 'pnpm'
          node-version: ${{ inputs.node-version }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4 # v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: ESLint
        run: pnpm --filter @intelgraph/${{ inputs.service }} lint

      - name: TypeScript Check
        run: pnpm --filter @intelgraph/${{ inputs.service }} typecheck

      - name: Format Check
        run: pnpm --filter @intelgraph/${{ inputs.service }} format:check || true

  # ============================================================================
  # Stage 2: Test
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v4
        with:
          cache: 'pnpm'
          node-version: ${{ inputs.node-version }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4 # v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Unit Tests
        run: pnpm --filter @intelgraph/${{ inputs.service }} test:unit --coverage
        env:
          CI: true

      - name: Integration Tests
        run: pnpm --filter @intelgraph/${{ inputs.service }} test:integration || true
        env:
          CI: true
          DATABASE_URL: postgres://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379

      - name: Upload Coverage
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          directory: ${{ inputs.working-directory }}/coverage
          flags: ${{ inputs.service }}
          fail_ci_if_error: false

      - name: Check Coverage Threshold
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct // 0' coverage/coverage-summary.json)
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < ${{ inputs.coverage-threshold }}" | bc -l) )); then
              echo "::warning::Coverage $COVERAGE% is below threshold ${{ inputs.coverage-threshold }}%"
            fi
          fi

  # ============================================================================
  # Stage 3: Security
  # ============================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !inputs.skip-security }}
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v4
        with:
          cache: 'pnpm'
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Gitleaks - Secret Scanning
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependency Audit
        run: pnpm audit --audit-level=high || true
        continue-on-error: true

      - name: Trivy - Filesystem Scan
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # v0.24.0
        with:
          scan-type: "fs"
          scan-ref: ${{ inputs.working-directory }}
          format: "sarif"
          output: "trivy-fs-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        if: always()
        with:
          sarif_file: "trivy-fs-results.sarif"

  # ============================================================================
  # Stage 4: Build
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test, security]
    if: always() && !contains(needs.*.result, 'failure')
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      image: ${{ steps.meta.outputs.tags }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ inputs.service }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}

      - name: Build and Push
        id: build
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: ${{ inputs.working-directory }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Generate SBOM
        if: github.event_name != 'pull_request'
        uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
        with:
          image: ghcr.io/${{ github.repository }}/${{ inputs.service }}@${{ steps.build.outputs.digest }}
          output-file: sbom.spdx.json

      - name: Install Cosign
        if: github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@f713795cb21599bc4e5c4b58cbad1da852d7eeb9 # v3

      - name: Sign Image
        if: github.event_name != 'pull_request'
        run: |
          cosign sign --yes \
            ghcr.io/${{ github.repository }}/${{ inputs.service }}@${{ steps.build.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: 1

      - name: Upload SBOM
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sbom-${{ inputs.service }}
          path: sbom.spdx.json

  # ============================================================================
  # Stage 5: Deploy (Staging)
  # ============================================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    if: ${{ !inputs.skip-deploy && github.event_name != 'pull_request' }}
    environment: ${{ inputs.environment }}

    outputs:
      deployed: ${{ steps.deploy.outputs.success }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Deploy Notification
        run: |
          echo "ðŸš€ Deploying ${{ inputs.service }} to ${{ inputs.environment }}"
          echo "Image: ${{ needs.build.outputs.image }}"
          echo "Digest: ${{ needs.build.outputs.digest }}"

      # NOTE: Actual deployment steps would go here
      # This is a placeholder that simulates deployment
      - name: Simulate Deployment
        id: deploy
        run: |
          echo "Deploying to ${{ inputs.environment }}..."
          sleep 5
          echo "success=true" >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 6: Verify
  # ============================================================================
  verify:
    name: Verify
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: deploy
    if: ${{ !inputs.skip-deploy && github.event_name != 'pull_request' }}

    outputs:
      success: ${{ steps.verify.outputs.healthy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Verify Deployment
        id: verify
        run: |
          echo "Verifying deployment..."
          # Placeholder for actual verification
          echo "healthy=true" >> $GITHUB_OUTPUT

      - name: Post Verification Status
        run: |
          if [ "${{ steps.verify.outputs.healthy }}" == "true" ]; then
            echo "âœ… Deployment verified successfully"
          else
            echo "âŒ Deployment verification failed"
            exit 1
          fi

  # ============================================================================
  # Stage 7: Canary + Rollback Guard
  # ============================================================================
  canary-rollback:
    name: Canary + Rollback Guard
    needs: verify
    if: ${{ inputs['canary-enabled'] && !inputs.skip-deploy && github.event_name != 'pull_request' }}
    uses: ./.github/workflows/golden-path/_canary-rollback.yml
    with:
      service: ${{ inputs.service }}
      environment: ${{ inputs.environment }}
      prometheus-url: ${{ inputs['prometheus-url'] }}
      canary-window: ${{ inputs['canary-window'] }}
      canary-slo-p95-ms: ${{ inputs['canary-slo-p95-ms'] }}
      canary-error-rate: ${{ inputs['canary-error-rate'] }}
      canary-saturation-max: ${{ inputs['canary-saturation-max'] }}
      rollback-enabled: ${{ inputs['rollback-enabled'] }}

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security, build, deploy, verify, canary-rollback]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## Golden Path Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || needs.security.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || needs.deploy.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify | ${{ needs.verify.result == 'success' && 'âœ…' || needs.verify.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.verify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Canary + Rollback | ${{ needs['canary-rollback'].result == 'success' && 'âœ…' || needs['canary-rollback'].result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs['canary-rollback'].result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build.outputs.image }}" != "" ]; then
            echo "**Image:** \`${{ needs.build.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          fi
