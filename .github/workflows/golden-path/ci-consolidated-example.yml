name: CI - Consolidated Example

# Example of workflow consolidation pattern for #14512
# Demonstrates how to merge multiple similar workflows into one
# using matrix strategies for better maintainability and performance

# BEFORE: Had 5 separate workflows (test-unit.yml, test-integration.yml, etc.)
# AFTER: Single workflow with matrix-driven execution
# BENEFITS:
#   - 60% fewer workflow files
#   - Shared caching across all test suites
#   - Easier to maintain and update
#   - Consistent configuration
#   - Better resource utilization

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/golden-path/ci-consolidated-example.yml'
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # Single setup job that all test jobs can depend on
  setup:
    runs-on: ubuntu-latest
    name: üì¶ Setup Dependencies
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-primary-key }}
    
    steps:
      - uses: actions/checkout@v4 # v4
      
      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3
      - uses: actions/setup-node@v4 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      # Restore or create cache
      - name: Cache dependencies
        id: cache
        uses: actions/cache@v4 # v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            **/node_modules
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-
      
      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile
  
  # Matrix-driven test execution - replaces 5 separate workflows
  test:
    needs: setup
    runs-on: ${{ matrix.os }}
    name: üß™ Test - ${{ matrix.suite }} (${{ matrix.os }})
    
    strategy:
      fail-fast: false  # Continue other tests if one fails
      matrix:
        # Run different test suites in parallel
        suite:
          - unit
          - integration
          - e2e
          - performance
          - accessibility
        # Optionally test on multiple OS
        os:
          - ubuntu-latest
        # Can add node versions if needed
        # node-version: [18, 20]
        
        # Conditional includes for specific combinations
        include:
          # Run e2e tests on macOS too
          - suite: e2e
            os: macos-latest
    
    steps:
      - uses: actions/checkout@v4 # v4
      
      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3
      - uses: actions/setup-node@v4 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      # Restore cached dependencies from setup job
      - name: Restore dependencies
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            **/node_modules
          key: ${{ needs.setup.outputs.cache-key }}
      
      - name: Run ${{ matrix.suite }} tests
        run: pnpm test:${{ matrix.suite }}
        env:
          CI: true
          TEST_SUITE: ${{ matrix.suite }}
      
      - name: Upload coverage
        if: matrix.suite != 'e2e'  # Conditional step
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          files: ./coverage/coverage-final.json
          flags: ${{ matrix.suite }}
          name: ${{ matrix.suite }}-coverage
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-results-${{ matrix.suite }}-${{ matrix.os }}
          path: |
            test-results/
            coverage/
          retention-days: 30
  
  # Aggregate results from all test jobs
  test-summary:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    name: üìä Test Summary
    
    steps:
      - name: Check test results
        run: |
          echo "## üß™ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ All test suites passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some test suites failed. Review logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Part of [#14512](https://github.com/BrianCLong/summit/issues/14512) - Workflow Consolidation Example" >> $GITHUB_STEP_SUMMARY
  
  # Quality gates - run in parallel with tests
  lint:
    needs: setup
    runs-on: ubuntu-latest
    name: ‚ú® Lint
    
    steps:
      - uses: actions/checkout@v4 # v4
      
      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3
      - uses: actions/setup-node@v4 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Restore dependencies
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            **/node_modules
          key: ${{ needs.setup.outputs.cache-key }}
      
      - name: Run linters
        run: |
          pnpm lint
          pnpm typecheck
  
  # Example of conditional job based on changed files
  docker-build:
    if: contains(github.event.pull_request.labels.*.name, 'docker')
    needs: [test, lint]
    runs-on: ubuntu-latest
    name: üê≥ Docker Build
    
    steps:
      - uses: actions/checkout@v4 # v4
      
      - name: Build Docker image
        run: docker build -t summit-example:${{ github.sha }} .
      
      - name: Scan image
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image summit-example:${{ github.sha }}
