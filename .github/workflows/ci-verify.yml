name: ci-verify
on:
  pull_request:
  merge_group:

permissions:
  contents: read
  actions: read
  id-token: write
  attestations: write

jobs:
  verify:
    name: verify (${{ matrix.lane }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lane: [deps_scan, typecheck, jest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install (frozen)
        run: npm ci --ignore-scripts

      - name: Run lane
        run: |
          set -euo pipefail
          mkdir -p evidence/verify/${{ matrix.lane }}

          case "${{ matrix.lane }}" in
            deps_scan)
              # Keep non-fatal if you want advisory-only; make fatal if you want to block merges.
              npm audit --json > evidence/verify/deps_scan/npm-audit.json || true
              ;;
            typecheck)
              npm run typecheck
              ;;
            jest)
              npm test -- --ci
              ;;
          esac

      - name: Capture tooling metadata (deterministic)
        run: |
          node -e "const fs=require('fs'); const cp=require('child_process');
            const j={ lane:'${{ matrix.lane }}',
              node:process.version,
              npm:cp.execSync('npm -v').toString().trim(),
              lockHash:'${{ hashFiles('**/package-lock.json') }}' };
            fs.writeFileSync('evidence/verify/${{ matrix.lane }}/tooling.json', JSON.stringify(j,null,2)+'\n');"

      - name: Upload lane evidence
        uses: actions/upload-artifact@v4
        with:
          name: verify-${{ matrix.lane }}
          path: evidence/verify/${{ matrix.lane }}

  golden:
    name: golden-path (rebuild + attest)
    runs-on: ubuntu-latest
    needs: [verify]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Download verify evidence
        uses: actions/download-artifact@v4
        with:
          path: evidence/verify

      - name: Clean install + rebuild (hermetic)
        run: |
          rm -rf node_modules **/node_modules
          npm ci --ignore-scripts
          npm run build

      - name: Generate rebuild manifest (deterministic)
        run: |
          mkdir -p evidence
          # Adjust dist/ to your real build output root(s)
          node scripts/release/generate_rebuild_manifest.mjs --dir dist --out evidence/rebuild-manifest.json

      - name: Generate SBOM (CycloneDX)
        run: |
          mkdir -p evidence
          npx @cyclonedx/cyclonedx-npm --omit dev --output-file evidence/sbom.cdx.json

      - name: Compose provenance bundle
        run: |
          node scripts/release/generate_provenance_bundle.mjs \
            --verify-evidence evidence/verify \
            --sbom evidence/sbom.cdx.json \
            --rebuild-manifest evidence/rebuild-manifest.json \
            --out evidence/provenance.json

      - name: Verify provenance references
        run: |
          node scripts/ci/compare_artifact_hashes.mjs \
            --bundle evidence/provenance.json \
            --verify-evidence evidence/verify

      - name: Attest provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: evidence/provenance.json
