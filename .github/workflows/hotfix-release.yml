name: Hotfix Release (From GA)

# Controlled hotfix workflow from GA tags with deterministic cherry-picks,
# required checks enforcement, signed evidence, and hotfix records.

on:
  workflow_dispatch:
    inputs:
      base_tag:
        description: "GA base tag (e.g., v4.1.1)"
        required: true
        type: string
      target_version:
        description: "Target hotfix version (e.g., 4.1.2)"
        required: true
        type: string
      commits:
        description: "Commit SHAs to cherry-pick (one per line, in order)"
        required: true
        type: string
      publish:
        description: "Publish tag and GitHub release"
        required: true
        type: boolean
        default: true

concurrency:
  group: hotfix-${{ inputs.target_version }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  HOTFIX_POLICY: release/HOTFIX_POLICY.yml

jobs:
  prepare-hotfix:
    name: Prepare Hotfix Branch
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.cut.outputs.branch_name }}
      base_commit: ${{ steps.verify.outputs.base_commit }}
      head_commit: ${{ steps.cut.outputs.head_commit }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Write Commit List
        run: |
          printf '%s\n' "${{ inputs.commits }}" > hotfix-commits.txt

      - name: Verify Hotfix Selection
        id: verify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/release/verify_hotfix_selection.mjs \
            --base-tag "${{ inputs.base_tag }}" \
            --target-version "${{ inputs.target_version }}" \
            --commits-file hotfix-commits.txt \
            --policy "${{ env.HOTFIX_POLICY }}" \
            --actor "${{ github.actor }}" \
            --output artifacts/hotfix-selection.json

          echo "base_commit=$(jq -r '.base_commit' artifacts/hotfix-selection.json)" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cut Hotfix Branch
        id: cut
        run: |
          node scripts/release/cut_hotfix_branch.mjs \
            --base-tag "${{ inputs.base_tag }}" \
            --target-version "${{ inputs.target_version }}" \
            --commits-file hotfix-commits.txt \
            --policy "${{ env.HOTFIX_POLICY }}" \
            --output artifacts/hotfix-cut.json

          echo "branch_name=$(jq -r '.branch_name' artifacts/hotfix-cut.json)" >> "$GITHUB_OUTPUT"
          echo "head_commit=$(jq -r '.head_commit' artifacts/hotfix-cut.json)" >> "$GITHUB_OUTPUT"

      - name: Push Hotfix Branch
        run: |
          git push origin "${{ steps.cut.outputs.branch_name }}"

      - name: Tag Output
        id: tag
        run: |
          echo "tag=v${{ inputs.target_version }}" >> "$GITHUB_OUTPUT"

      - name: Upload Preparation Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: hotfix-prep-${{ steps.tag.outputs.tag }}
          path: |
            artifacts/hotfix-selection.json
            artifacts/hotfix-cut.json

  verify-hotfix:
    name: Verify Hotfix Gates
    needs: [prepare-hotfix]
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      evidence_sha: ${{ steps.evidence.outputs.evidence_sha }}
      dashboard_sha: ${{ steps.dashboard.outputs.dashboard_sha }}
    steps:
      - name: Checkout Hotfix Branch
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare-hotfix.outputs.branch_name }}
          fetch-depth: 0

      - name: Download Preparation Artifacts
        uses: actions/download-artifact@v7
        with:
          name: hotfix-prep-${{ needs.prepare-hotfix.outputs.tag }}
          path: .

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Release Readiness Gate
        run: pnpm release:ready

      - name: Required Checks Gate
        run: |
          scripts/release/verify-green-for-tag.sh \
            --commit "${{ needs.prepare-hotfix.outputs.head_commit }}" \
            --tag "${{ needs.prepare-hotfix.outputs.tag }}" \
            --base "${{ inputs.base_tag }}" \
            --report-only \
            > artifacts/hotfix-required-checks.json

      - name: Generate Release Dashboard
        run: |
          scripts/release/generate_release_dashboard.sh \
            --json artifacts/hotfix-dashboard/dashboard.json \
            --out artifacts/hotfix-dashboard/dashboard.md \
            --dry-run

      - name: Build Non-Sensitive Dashboard Summary
        id: dashboard
        run: |
          scripts/release/build_release_ops_site.sh \
            --artifacts-dir artifacts/hotfix-dashboard \
            --site-dir artifacts/hotfix-dashboard/site

          jq -e . artifacts/hotfix-dashboard/site/dashboard_summary.json >/dev/null

          DASHBOARD_SHA=$(sha256sum artifacts/hotfix-dashboard/site/dashboard_summary.json | awk '{print $1}')
          echo "dashboard_sha=${DASHBOARD_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build Signed Evidence Bundle
        id: evidence
        run: |
          scripts/release/build-hotfix-evidence.sh \
            --tag "${{ needs.prepare-hotfix.outputs.tag }}" \
            --commit "${{ needs.prepare-hotfix.outputs.head_commit }}" \
            --base-tag "${{ inputs.base_tag }}" \
            --output artifacts/hotfix-evidence \
            --policy "${{ env.HOTFIX_POLICY }}"

          echo "evidence_sha=$(jq -r '.evidence_sha256' artifacts/hotfix-evidence/evidence_summary.json)" >> "$GITHUB_OUTPUT"

      - name: Write Hotfix Record
        run: |
          node scripts/release/write_hotfix_record.mjs \
            --output "release/hotfix-records/${{ needs.prepare-hotfix.outputs.tag }}.json" \
            --selection artifacts/hotfix-selection.json \
            --evidence artifacts/hotfix-evidence/evidence_summary.json \
            --dashboard artifacts/hotfix-dashboard/site/dashboard_summary.json \
            --dashboard-sha "${{ steps.dashboard.outputs.dashboard_sha }}" \
            --final-commit "${{ needs.prepare-hotfix.outputs.head_commit }}" \
            --actor "${{ github.actor }}" \
            --workflow-run-id "${{ github.run_id }}" \
            --workflow-run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          node scripts/release/validate_hotfix_record.mjs \
            --record "release/hotfix-records/${{ needs.prepare-hotfix.outputs.tag }}.json" \
            --schema schemas/hotfix-record.schema.json

      - name: Commit Hotfix Record
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "release/hotfix-records/${{ needs.prepare-hotfix.outputs.tag }}.json"
          git commit -m "chore(release): add hotfix record ${{ needs.prepare-hotfix.outputs.tag }}"
          git push origin "${{ needs.prepare-hotfix.outputs.branch_name }}"

      - name: Create Hotfix PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh pr view "${{ needs.prepare-hotfix.outputs.branch_name }}" --json number >/dev/null 2>&1; then
            echo "PR already exists for ${{ needs.prepare-hotfix.outputs.branch_name }}"
            exit 0
          fi

          SELECTED_COMMITS=$(jq -r '.selected_commits[]' artifacts/hotfix-selection.json)
          EVIDENCE_SHA=$(jq -r '.evidence_sha256' artifacts/hotfix-evidence/evidence_summary.json)
          DASHBOARD_SHA="${{ steps.dashboard.outputs.dashboard_sha }}"

          PR_BODY=$(cat <<'BODY'
          ## Hotfix Summary

          - **Base tag:** ${{ inputs.base_tag }}
          - **Target version:** ${{ needs.prepare-hotfix.outputs.tag }}
          - **Selected commits:**
          $(printf '%s\n' "$SELECTED_COMMITS" | sed 's/^/- /')

          ## Evidence

          - **Evidence SHA256:** ${EVIDENCE_SHA}
          - **Dashboard SHA256:** ${DASHBOARD_SHA}

          ## Gates

          - ✅ Release readiness (`pnpm release:ready`)
          - ✅ Required checks (`verify-green-for-tag.sh`)
          - ✅ Signed evidence bundle
          - ✅ Dashboard summary validated
          BODY
          )

          gh pr create \
            --title "chore(release): hotfix ${{ needs.prepare-hotfix.outputs.tag }}" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ needs.prepare-hotfix.outputs.branch_name }}" \
            --label hotfix

      - name: Upload Verification Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: hotfix-verify-${{ needs.prepare-hotfix.outputs.tag }}
          path: |
            artifacts/hotfix-required-checks.json
            artifacts/hotfix-dashboard/site/dashboard_summary.json
            artifacts/hotfix-evidence/evidence.tar.gz
            artifacts/hotfix-evidence/evidence_summary.json
            release/hotfix-records/${{ needs.prepare-hotfix.outputs.tag }}.json

  publish-hotfix:
    name: Publish Hotfix
    needs: [verify-hotfix, prepare-hotfix]
    if: ${{ inputs.publish && needs.verify-hotfix.result == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: hotfix-release
      url: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.prepare-hotfix.outputs.tag }}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout Hotfix Branch
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare-hotfix.outputs.branch_name }}
          fetch-depth: 0

      - name: Download Verification Artifacts
        uses: actions/download-artifact@v7
        with:
          name: hotfix-verify-${{ needs.prepare-hotfix.outputs.tag }}
          path: hotfix-artifacts

      - name: Download Preparation Artifacts
        uses: actions/download-artifact@v7
        with:
          name: hotfix-prep-${{ needs.prepare-hotfix.outputs.tag }}
          path: .

      - name: Create Hotfix Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${{ needs.prepare-hotfix.outputs.tag }}" "${{ needs.prepare-hotfix.outputs.head_commit }}" -m "Hotfix Release ${{ needs.prepare-hotfix.outputs.tag }}"
          git push origin "${{ needs.prepare-hotfix.outputs.tag }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EVIDENCE_SHA=$(jq -r '.evidence_sha256' hotfix-artifacts/artifacts/hotfix-evidence/evidence_summary.json)
          DASHBOARD_SHA="${{ needs.verify-hotfix.outputs.dashboard_sha }}"
          SELECTED_COMMITS=$(jq -r '.selected_commits[]' artifacts/hotfix-selection.json)

          RELEASE_NOTES=$(cat <<'NOTES'
          ## Hotfix Release ${{ needs.prepare-hotfix.outputs.tag }}

          - **Base tag:** ${{ inputs.base_tag }}
          - **Evidence SHA256:** ${EVIDENCE_SHA}
          - **Dashboard SHA256:** ${DASHBOARD_SHA}

          ### Cherry-picks
          $(printf '%s\n' "$SELECTED_COMMITS" | sed 's/^/- /')
          NOTES
          )

          gh release create "${{ needs.prepare-hotfix.outputs.tag }}" hotfix-artifacts/artifacts/hotfix-evidence/evidence.tar.gz \
            --title "${{ needs.prepare-hotfix.outputs.tag }}" \
            --notes "$RELEASE_NOTES"
