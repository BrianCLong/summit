name: Hotfix Release

# EMERGENCY HOTFIX RELEASE WORKFLOW
# This workflow enables rapid, controlled production releases for critical fixes
# while maintaining governance, auditability, and mandatory post-mortem requirements.
#
# Requirements:
# - Requires hotfix-release environment with required reviewers
# - Mandatory justification and ticket reference
# - Post-mortem must be filed within 24 hours
#
# See docs/releases/HOTFIX_OVERRIDE.md for full documentation.

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Hotfix version (e.g., 4.1.2-hotfix.1 or 4.1.3)"
        required: true
        type: string
      commit_sha:
        description: "Exact commit SHA to release"
        required: true
        type: string
      justification:
        description: "Why is this hotfix needed? (min 50 characters)"
        required: true
        type: string
      ticket_url:
        description: "Incident ticket URL"
        required: true
        type: string
      risk_level:
        description: "Risk level assessment"
        required: true
        type: choice
        options:
          - low
          - medium
          - high

concurrency:
  group: hotfix-${{ inputs.version }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # Job 1: Validate inputs and verify the hotfix is safe to release
  verify-hotfix:
    name: Verify Hotfix
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      evidence_sha256: ${{ steps.bundle.outputs.evidence_sha256 }}
      provenance_sha256: ${{ steps.bundle.outputs.provenance_sha256 }}
      gates_passed: ${{ steps.gates.outputs.passed }}
    steps:
      - name: Validate Inputs
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"
          JUSTIFICATION="${{ inputs.justification }}"
          TICKET_URL="${{ inputs.ticket_url }}"
          RISK_LEVEL="${{ inputs.risk_level }}"

          echo "ðŸ“‹ Validating hotfix inputs..."
          echo ""
          echo "Version: ${VERSION}"
          echo "Commit:  ${COMMIT_SHA}"
          echo "Risk:    ${RISK_LEVEL}"
          echo "Ticket:  ${TICKET_URL}"
          echo ""

          # Validate version format
          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-hotfix\.[0-9]+)?$ ]]; then
            echo "::error::Invalid version format: ${VERSION}"
            echo "Expected: X.Y.Z or X.Y.Z-hotfix.N"
            exit 1
          fi

          # Validate commit SHA format
          if ! [[ "${COMMIT_SHA}" =~ ^[a-f0-9]{40}$ ]]; then
            echo "::error::Invalid commit SHA format: ${COMMIT_SHA}"
            echo "Expected: 40 character hex string"
            exit 1
          fi

          # Validate justification length
          if [ ${#JUSTIFICATION} -lt 50 ]; then
            echo "::error::Justification too short (${#JUSTIFICATION} chars)"
            echo "Minimum 50 characters required for audit trail"
            exit 1
          fi

          # Validate ticket URL
          if ! [[ "${TICKET_URL}" =~ ^https?:// ]]; then
            echo "::error::Invalid ticket URL: ${TICKET_URL}"
            echo "Expected: URL starting with http:// or https://"
            exit 1
          fi

          echo "âœ… Input validation passed"

      - name: Checkout at Commit
        uses: actions/checkout@v4 # v6
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0

      - name: Verify Commit Exists
        run: |
          COMMIT_SHA="${{ inputs.commit_sha }}"

          if ! git cat-file -e "${COMMIT_SHA}^{commit}"; then
            echo "::error::Commit ${COMMIT_SHA} not found in repository"
            exit 1
          fi

          echo "âœ… Commit verified: ${COMMIT_SHA}"
          echo ""
          git log -1 "${COMMIT_SHA}" --format="  Subject: %s%n  Author: %an%n  Date: %ci"

      - name: Extract Version Info
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v${VERSION}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Hotfix Tag: ${TAG}"

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Release Gates
        id: gates
        run: |
          echo "ðŸ”’ Running release gates..."

          # Create output directory
          mkdir -p dist/hotfix

          # Run release readiness check
          if pnpm release:ready 2>&1 | tee dist/hotfix/gate-output.txt; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo '{"gate": "release:ready", "passed": true}' > dist/hotfix/gate-result.json
            echo "âœ… Release gates passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo '{"gate": "release:ready", "passed": false}' > dist/hotfix/gate-result.json
            echo "::error::Release gates failed"
            exit 1
          fi

      - name: Build Evidence Bundle
        id: bundle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          mkdir -p hotfix-assets/sbom

          # Generate provenance manifest
          cat > hotfix-assets/provenance.json <<EOF
          {
            "_type": "https://summit.dev/provenance/hotfix/v1",
            "version": "1.0.0",
            "hotfix": {
              "tag": "${TAG}",
              "version": "${VERSION}",
              "commit": "${COMMIT_SHA}",
              "timestamp": "${TIMESTAMP}",
              "risk_level": "${{ inputs.risk_level }}",
              "justification": "${{ inputs.justification }}",
              "ticket_url": "${{ inputs.ticket_url }}",
              "triggered_by": "${{ github.actor }}",
              "workflow_run_id": "${{ github.run_id }}",
              "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            },
            "verification": {
              "release_gates": "${{ steps.gates.outputs.passed }}",
              "commit_verified": true
            }
          }
          EOF

          # Generate checksums
          cd hotfix-assets
          find . -type f ! -name SHA256SUMS -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS
          cd ..

          # Calculate bundle hashes
          PROVENANCE_SHA256=$(sha256sum hotfix-assets/provenance.json | awk '{print $1}')

          # Create evidence tarball
          tar -czf hotfix-assets/evidence.tar.gz -C hotfix-assets provenance.json SHA256SUMS

          EVIDENCE_SHA256=$(sha256sum hotfix-assets/evidence.tar.gz | awk '{print $1}')

          echo "evidence_sha256=${EVIDENCE_SHA256}" >> $GITHUB_OUTPUT
          echo "provenance_sha256=${PROVENANCE_SHA256}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Evidence bundle created"
          echo "  Evidence SHA256: ${EVIDENCE_SHA256}"
          echo "  Provenance SHA256: ${PROVENANCE_SHA256}"

      - name: Generate Required Checks Snapshot
        run: |
          cat > hotfix-assets/required_checks_snapshot.txt <<EOF
          # Hotfix Required Checks Snapshot
          # Tag: ${{ steps.version.outputs.tag }}
          # Commit: ${{ inputs.commit_sha }}
          # Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          release:ready: ${{ steps.gates.outputs.passed && 'passed' || 'failed' }}
          input_validation: passed
          commit_verification: passed
          EOF

      - name: Upload Hotfix Bundle
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: hotfix-bundle-${{ steps.version.outputs.tag }}
          path: hotfix-assets/
          retention-days: 90

      - name: Verification Summary
        run: |
          echo "### ðŸ”§ Hotfix Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ inputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Risk Level** | ${{ inputs.risk_level }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Gates Passed** | ${{ steps.gates.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Justification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ${{ inputs.justification }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ticket:** [${{ inputs.ticket_url }}](${{ inputs.ticket_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### â³ Awaiting Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The hotfix bundle is ready. Publishing requires approval from the \`hotfix-release\` environment." >> $GITHUB_STEP_SUMMARY

  # Job 2: Publish hotfix (requires environment approval)
  publish-hotfix:
    name: Publish Hotfix
    needs: [verify-hotfix]
    if: needs.verify-hotfix.outputs.gates_passed == 'true'
    runs-on: ubuntu-latest
    # HOTFIX APPROVAL GATE
    # Configure required reviewers in GitHub: Settings â†’ Environments â†’ hotfix-release
    environment:
      name: hotfix-release
      url: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.verify-hotfix.outputs.tag }}
    permissions:
      contents: write
      packages: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6
        with:
          ref: ${{ inputs.commit_sha }}

      - name: Download Hotfix Bundle
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: hotfix-bundle-${{ needs.verify-hotfix.outputs.tag }}
          path: hotfix-assets

      - name: Verify Bundle Integrity
        run: |
          EXPECTED_HASH="${{ needs.verify-hotfix.outputs.evidence_sha256 }}"
          ACTUAL_HASH=$(sha256sum hotfix-assets/evidence.tar.gz | awk '{print $1}')

          echo "ðŸ” Verifying hotfix bundle integrity..."
          echo "Expected: ${EXPECTED_HASH}"
          echo "Actual:   ${ACTUAL_HASH}"

          if [ "${ACTUAL_HASH}" != "${EXPECTED_HASH}" ]; then
            echo "::error::Bundle integrity check failed!"
            exit 1
          fi

          echo "âœ… Bundle integrity verified"

      - name: Generate Hotfix Record
        run: |
          TAG="${{ needs.verify-hotfix.outputs.tag }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > hotfix-assets/hotfix_record.json <<EOF
          {
            "version": "1.0.0",
            "hotfix": {
              "tag": "${TAG}",
              "commit_sha": "${{ inputs.commit_sha }}",
              "version": "${{ inputs.version }}",
              "risk_level": "${{ inputs.risk_level }}",
              "justification": "${{ inputs.justification }}",
              "ticket_url": "${{ inputs.ticket_url }}"
            },
            "approval": {
              "workflow_run_id": "${{ github.run_id }}",
              "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "environment": "hotfix-release",
              "approved_at": "${TIMESTAMP}",
              "triggered_by": "${{ github.actor }}",
              "repository": "${{ github.repository }}"
            },
            "verification": {
              "bundle_integrity": "verified",
              "evidence_sha256": "${{ needs.verify-hotfix.outputs.evidence_sha256 }}",
              "provenance_sha256": "${{ needs.verify-hotfix.outputs.provenance_sha256 }}"
            },
            "postmortem": {
              "required": true,
              "deadline": "24h after release",
              "path": "docs/releases/HOTFIX_POSTMORTEMS/${TAG}.md"
            },
            "audit_note": "Reviewer identity available in GitHub audit log"
          }
          EOF

          echo "ðŸ“‹ Hotfix record generated"
          cat hotfix-assets/hotfix_record.json

      - name: Upload Hotfix Record
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: hotfix-record-${{ needs.verify-hotfix.outputs.tag }}
          path: hotfix-assets/hotfix_record.json
          retention-days: 90

      - name: Create Hotfix Tag
        run: |
          TAG="${{ needs.verify-hotfix.outputs.tag }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"

          echo "ðŸ·ï¸ Creating hotfix tag: ${TAG}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "${TAG}" "${COMMIT_SHA}" -m "Hotfix Release ${TAG}

          Risk Level: ${{ inputs.risk_level }}
          Ticket: ${{ inputs.ticket_url }}
          Commit: ${COMMIT_SHA}

          Justification:
          ${{ inputs.justification }}

          Post-mortem required within 24 hours.
          See: docs/releases/HOTFIX_POSTMORTEMS/${TAG}.md

          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push tag
          git push origin "${TAG}"

          echo "âœ… Tag created and pushed: ${TAG}"

      - name: Create GitHub Release
        run: |
          TAG="${{ needs.verify-hotfix.outputs.tag }}"

          RELEASE_NOTES=$(cat <<'EOF'
          ## ðŸ”§ Emergency Hotfix Release

          **Risk Level:** ${{ inputs.risk_level }}
          **Ticket:** [${{ inputs.ticket_url }}](${{ inputs.ticket_url }})

          ### Justification

          ${{ inputs.justification }}

          ### Verification

          - âœ… Release gates passed
          - âœ… Bundle integrity verified
          - âœ… Approval granted via `hotfix-release` environment

          ### Post-Mortem

          âš ï¸ **Required within 24 hours**: `docs/releases/HOTFIX_POSTMORTEMS/${{ needs.verify-hotfix.outputs.tag }}.md`

          ---

          **Commit:** `${{ inputs.commit_sha }}`
          **Workflow Run:** [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )

          gh release create "${TAG}" hotfix-assets/evidence.tar.gz \
            --title "${TAG}" \
            --notes "${RELEASE_NOTES}" \
            --repo "$GITHUB_REPOSITORY"

          echo "âœ… GitHub Release created: ${TAG}"

      - name: Publish Summary
        run: |
          echo "### âœ… Hotfix Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${{ needs.verify-hotfix.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ inputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Risk Level** | ${{ inputs.risk_level }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release URL** | [${{ needs.verify-hotfix.outputs.tag }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.verify-hotfix.outputs.tag }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âš ï¸ Post-Mortem Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Create: \`docs/releases/HOTFIX_POSTMORTEMS/${{ needs.verify-hotfix.outputs.tag }}.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deadline:** Within 24 hours (or next business day)" >> $GITHUB_STEP_SUMMARY
