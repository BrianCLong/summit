# redaction-trend-alerts.yml
# Trend-based alerting for redaction metrics
#
# Automatically creates/updates incident issues when redaction metrics
# exceed thresholds. All issue content is counts-only - no sensitive data.
#
# Authority: docs/ci/REDACTION_TREND_ALERTS.md

name: Redaction Trend Alerts

on:
  # Trigger after Pages publish completes
  workflow_run:
    workflows: ["Publish Release Ops Pages"]
    types: [completed]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no issue creation)"
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  actions: read

env:
  SITE_DIR: site/release-ops
  STATE_FILE: docs/releases/_state/redaction_trend_alerts_state.json
  ALERT_POLICY: docs/ci/REDACTION_TREND_ALERT_POLICY.yml

jobs:
  check-trends:
    name: Check Redaction Trends
    runs-on: ubuntu-latest

    outputs:
      alert_level: ${{ steps.analyze.outputs.alert_level }}
      alert_triggers: ${{ steps.analyze.outputs.alert_triggers }}
      issue_action: ${{ steps.dedup.outputs.action }}
      issue_number: ${{ steps.dedup.outputs.issue_number }}
      state_key: ${{ steps.dedup.outputs.state_key }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Download Site Artifact
        id: download
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          name: release-ops-site
          path: ${{ env.SITE_DIR }}
        continue-on-error: true

      # If artifact download failed, try to get from Pages branch or rebuild
      - name: Fallback - Build Site
        if: steps.download.outcome == 'failure'
        run: |
          echo "::notice::Artifact not found, building site locally"
          mkdir -p ${{ env.SITE_DIR }}

          # Create minimal time series if none exists
          if [[ ! -f "${{ env.SITE_DIR }}/redaction_metrics_timeseries.json" ]]; then
            echo '{"version":"1.0","series":[]}' > "${{ env.SITE_DIR }}/redaction_metrics_timeseries.json"
          fi

      - name: Verify Time Series Exists
        run: |
          if [[ ! -f "${{ env.SITE_DIR }}/redaction_metrics_timeseries.json" ]]; then
            echo "::error::Time series file not found"
            exit 1
          fi

          echo "Time series entries:"
          jq '.series | length' "${{ env.SITE_DIR }}/redaction_metrics_timeseries.json"

      - name: Analyze Trends
        id: analyze
        run: |
          # Get triggering run ID
          TRIGGER_RUN_ID="${{ github.event.workflow_run.id || github.run_id }}"

          # Run checker
          ./scripts/release/check_redaction_trends.sh \
            --timeseries "${{ env.SITE_DIR }}/redaction_metrics_timeseries.json" \
            --policy "${{ env.ALERT_POLICY }}" \
            --out "artifacts/release-train/redaction_trend_alert_report.md" \
            --out-json "artifacts/release-train/redaction_trend_alert.json" \
            --run-id "${TRIGGER_RUN_ID}" \
            --verbose | tee analysis_output.txt

          # Parse outputs
          ALERT_LEVEL=$(grep "^ALERT_LEVEL=" analysis_output.txt | cut -d= -f2)
          ALERT_TRIGGERS=$(grep "^ALERT_TRIGGERS=" analysis_output.txt | cut -d= -f2)

          echo "alert_level=${ALERT_LEVEL}" >> $GITHUB_OUTPUT
          echo "alert_triggers=${ALERT_TRIGGERS}" >> $GITHUB_OUTPUT

          echo "### Trend Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Level:** ${ALERT_LEVEL}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggers:** ${ALERT_TRIGGERS:-none}" >> $GITHUB_STEP_SUMMARY

      - name: Upload Alert Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: redaction-trend-alert-report
          path: artifacts/release-train/redaction_trend_alert*
          retention-days: 30

      - name: Check Deduplication State
        id: dedup
        if: steps.analyze.outputs.alert_level != 'OK'
        run: |
          LEVEL="${{ steps.analyze.outputs.alert_level }}"
          TRIGGERS="${{ steps.analyze.outputs.alert_triggers }}"
          TODAY=$(date -u +%Y-%m-%d)
          STATE_KEY="${TODAY}_${LEVEL}_${TRIGGERS}"

          # Ensure state directory exists
          mkdir -p "$(dirname "${{ env.STATE_FILE }}")"

          # Initialize state file if needed
          if [[ ! -f "${{ env.STATE_FILE }}" ]]; then
            echo '{"alerts":{}}' > "${{ env.STATE_FILE }}"
          fi

          # Check for existing alert
          EXISTING=$(jq -r --arg key "${STATE_KEY}" '.alerts[$key] // empty' "${{ env.STATE_FILE }}")

          if [[ -n "${EXISTING}" ]]; then
            # Check cooldown (6 hours)
            LAST_UPDATE=$(echo "${EXISTING}" | jq -r '.last_updated // "1970-01-01T00:00:00Z"')
            LAST_EPOCH=$(date -d "${LAST_UPDATE}" +%s 2>/dev/null || echo 0)
            NOW_EPOCH=$(date +%s)
            COOLDOWN=$((6 * 3600))

            if [[ $((NOW_EPOCH - LAST_EPOCH)) -lt ${COOLDOWN} ]]; then
              echo "::notice::Alert already exists and within cooldown window"
              echo "action=skip" >> $GITHUB_OUTPUT
              echo "issue_number=$(echo "${EXISTING}" | jq -r '.issue_number')" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "action=update" >> $GITHUB_OUTPUT
            echo "issue_number=$(echo "${EXISTING}" | jq -r '.issue_number')" >> $GITHUB_OUTPUT
          else
            echo "action=create" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

          echo "state_key=${STATE_KEY}" >> $GITHUB_OUTPUT

  create-alert-issue:
    name: Create/Update Alert Issue
    runs-on: ubuntu-latest
    needs: check-trends
    if: |
      needs.check-trends.outputs.alert_level != 'OK' &&
      needs.check-trends.outputs.issue_action != 'skip' &&
      github.event.inputs.dry_run != 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Download Alert Report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          name: redaction-trend-alert-report
          path: artifacts

      - name: Determine Issue Details
        id: issue
        run: |
          LEVEL="${{ needs.check-trends.outputs.alert_level }}"
          TRIGGERS="${{ needs.check-trends.outputs.alert_triggers }}"
          TODAY=$(date -u +%Y-%m-%d)

          # Set title based on level and trigger type
          if [[ "${LEVEL}" == "P0" ]]; then
            TITLE="[Redaction Alert P0] Forbidden patterns detected — ${TODAY}"
            LABELS="release-ops,security,redaction-alert,severity:P0"
          elif echo "${TRIGGERS}" | grep -q "rollbacks"; then
            TITLE="[Redaction Alert P1] Rollback stability alert — ${TODAY}"
            LABELS="release-ops,redaction-alert,severity:P1"
          else
            TITLE="[Redaction Alert P1] Elevated WARN trend — ${TODAY}"
            LABELS="release-ops,redaction-alert,severity:P1"
          fi

          echo "title=${TITLE}" >> $GITHUB_OUTPUT
          echo "labels=${LABELS}" >> $GITHUB_OUTPUT

      - name: Generate Issue Body
        id: body
        run: |
          LEVEL="${{ needs.check-trends.outputs.alert_level }}"
          TRIGGERS="${{ needs.check-trends.outputs.alert_triggers }}"
          RUN_ID="${{ github.event.workflow_run.id || github.run_id }}"

          # Read metrics from JSON
          METRICS=$(cat artifacts/redaction_trend_alert.json)

          # Generate body
          cat > issue_body.md << 'BODY_EOF'
          ## Redaction Trend Alert

          **Level:** ${{ needs.check-trends.outputs.alert_level }}
          **Date:** $(date -u +%Y-%m-%d)
          **Triggers:** ${{ needs.check-trends.outputs.alert_triggers }}

          ### Metrics Summary (Counts Only)

          | Metric | Value |
          |--------|-------|
          BODY_EOF

          # Add metrics from JSON
          jq -r '
            "| Forbidden Hits | \(.metrics.forbidden_hits) |",
            "| Rollbacks (24h) | \(.metrics.rollbacks_24h) |",
            "| Rollbacks (7 entries) | \(.metrics.rollbacks_in_window) |",
            "| WARN/FAIL Count | \(.metrics.warn_count) |",
            "| Tokens Spike | \(.metrics.tokens_spike_pct)% |"
          ' artifacts/redaction_trend_alert.json >> issue_body.md

          cat >> issue_body.md << LINKS_EOF

          ### Links

          - [Triggering Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${RUN_ID})
          - [Trend Page](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/redaction_metrics_trend.html)
          - [Alert Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Remediation Checklist

          - [ ] Review triggered conditions above
          - [ ] Check trend page for patterns
          - [ ] Review triage packet (if WARN/FAIL)
          - [ ] Identify root cause
          - [ ] Apply fix
          - [ ] Verify fix resolves the trend

          ---

          *This issue was automatically created by the Redaction Trend Alert system.*
          *Counts only - no sensitive content.*
          LINKS_EOF

          # Escape for GitHub Actions
          BODY=$(cat issue_body.md)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Issue
        if: needs.check-trends.outputs.issue_action == 'create'
        id: create
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '${{ steps.issue.outputs.title }}',
              body: body,
              labels: '${{ steps.issue.outputs.labels }}'.split(',')
            });

            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

      - name: Update Issue
        if: needs.check-trends.outputs.issue_action == 'update'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const issueNumber = ${{ needs.check-trends.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## Alert Update (${new Date().toISOString()})\n\n${body}`
            });

            console.log(`Updated issue #${issueNumber}`);

      - name: Update State File
        run: |
          STATE_KEY="${{ needs.check-trends.outputs.state_key || '' }}"
          ISSUE_NUMBER="${{ steps.create.outputs.result || needs.check-trends.outputs.issue_number }}"
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [[ -n "${STATE_KEY}" ]]; then
            mkdir -p "$(dirname "${{ env.STATE_FILE }}")"

            if [[ ! -f "${{ env.STATE_FILE }}" ]]; then
              echo '{"alerts":{}}' > "${{ env.STATE_FILE }}"
            fi

            jq --arg key "${STATE_KEY}" \
               --arg issue "${ISSUE_NUMBER}" \
               --arg updated "${NOW}" \
               --arg level "${{ needs.check-trends.outputs.alert_level }}" \
               '.alerts[$key] = {
                  issue_number: ($issue | tonumber),
                  level: $level,
                  last_updated: $updated
                }' "${{ env.STATE_FILE }}" > state_tmp.json

            mv state_tmp.json "${{ env.STATE_FILE }}"
          fi

      - name: Commit State Update
        if: needs.check-trends.outputs.issue_action == 'create'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${{ env.STATE_FILE }}"
          git commit -m "chore: update redaction trend alert state" || true
          git push || echo "::warning::Could not push state update"

  auto-close-resolved:
    name: Auto-Close Resolved Alerts
    runs-on: ubuntu-latest
    needs: check-trends
    if: needs.check-trends.outputs.alert_level == 'OK'

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Check for Open Alerts to Close
        id: check-close
        run: |
          STATE_FILE="${{ env.STATE_FILE }}"

          if [[ ! -f "${STATE_FILE}" ]]; then
            echo "No state file, nothing to close"
            echo "should_close=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find open alerts
          OPEN_ALERTS=$(jq -r '.alerts | to_entries[] | select(.value.issue_number) | .value.issue_number' "${STATE_FILE}" 2>/dev/null || echo "")

          if [[ -z "${OPEN_ALERTS}" ]]; then
            echo "No open alerts to close"
            echo "should_close=false" >> $GITHUB_OUTPUT
          else
            echo "Found open alerts: ${OPEN_ALERTS}"
            echo "should_close=true" >> $GITHUB_OUTPUT
            echo "issue_numbers=${OPEN_ALERTS}" >> $GITHUB_OUTPUT
          fi

      - name: Close Resolved Issues
        if: steps.check-close.outputs.should_close == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const issueNumbers = '${{ steps.check-close.outputs.issue_numbers }}'.split('\n').filter(n => n);

            for (const issueNumber of issueNumbers) {
              try {
                // Check if issue is still open
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });

                if (issue.data.state === 'open') {
                  // Add comment and close
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `## Auto-Closed: Alert Resolved

            This alert has been automatically closed because the underlying metrics have returned to OK status.

            If problems persist, a new alert will be opened.

            ---
            *Closed by Redaction Trend Alert system*`
                  });

                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    state: 'closed'
                  });

                  console.log(`Closed issue #${issueNumber}`);
                }
              } catch (e) {
                console.log(`Could not close issue #${issueNumber}: ${e.message}`);
              }
            }

      - name: Clear State for Closed Alerts
        if: steps.check-close.outputs.should_close == 'true'
        run: |
          STATE_FILE="${{ env.STATE_FILE }}"

          if [[ -f "${STATE_FILE}" ]]; then
            # Clear alerts that were closed
            jq '.alerts = {}' "${STATE_FILE}" > state_tmp.json
            mv state_tmp.json "${STATE_FILE}"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add "${STATE_FILE}"
            git commit -m "chore: clear resolved redaction trend alerts" || true
            git push || echo "::warning::Could not push state update"
          fi

  summary:
    name: Alert Summary
    runs-on: ubuntu-latest
    needs: [check-trends, create-alert-issue]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          LEVEL="${{ needs.check-trends.outputs.alert_level }}"
          TRIGGERS="${{ needs.check-trends.outputs.alert_triggers }}"
          ACTION="${{ needs.check-trends.outputs.issue_action }}"

          echo "## Redaction Trend Alert Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${LEVEL}" == "OK" ]]; then
            echo "### ✅ All Clear" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All redaction metrics are within normal thresholds." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${LEVEL} Alert" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Triggers:** ${TRIGGERS}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            case "${ACTION}" in
              create)
                echo "**Action:** Created new issue" >> $GITHUB_STEP_SUMMARY
                ;;
              update)
                echo "**Action:** Updated existing issue" >> $GITHUB_STEP_SUMMARY
                ;;
              skip)
                echo "**Action:** Skipped (within cooldown window)" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          fi
