name: Preview Environment

permissions:
  contents: read
  pull-requests: write
  packages: write

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'server/**'
      - 'client/**'
      - 'deploy/**'
      - '.github/workflows/**'

env:
  REGISTRY: ghcr.io
  NAMESPACE_PREFIX: intelgraph-pr

concurrency:
  group: preview-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  build-images:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      server-image: ${{ steps.meta.outputs.server-image }}
      client-image: ${{ steps.meta.outputs.client-image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate metadata
        id: meta
        run: |
          PR_NUMBER=${{ github.event.number }}
          SERVER_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}/server:pr-${PR_NUMBER}"
          CLIENT_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}/client:pr-${PR_NUMBER}"
          echo "server-image=${SERVER_IMAGE}" >> $GITHUB_OUTPUT
          echo "client-image=${CLIENT_IMAGE}" >> $GITHUB_OUTPUT

      - name: Build and push server image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ steps.meta.outputs.server-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push client image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: ${{ steps.meta.outputs.client-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-preview:
    if: github.event.action != 'closed'
    needs: build-images
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Create namespace
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}"
          kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy preview environment
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}"
          PR_NUMBER=${{ github.event.number }}

          helm upgrade --install \
            intelgraph-pr-${PR_NUMBER} \
            ./deploy/helm/intelgraph \
            --namespace ${NAMESPACE} \
            --set image.server.repository=${{ env.REGISTRY }}/${{ github.repository }}/server \
            --set image.server.tag=pr-${PR_NUMBER} \
            --set image.client.repository=${{ env.REGISTRY }}/${{ github.repository }}/client \
            --set image.client.tag=pr-${PR_NUMBER} \
            --set ingress.enabled=true \
            --set ingress.host=pr-${PR_NUMBER}.preview.intelgraph.dev \
            --set resources.requests.cpu=100m \
            --set resources.requests.memory=256Mi \
            --set resources.limits.cpu=500m \
            --set resources.limits.memory=1Gi \
            --set autoscaling.enabled=false \
            --set replicaCount=1 \
            --set env.NODE_ENV=preview \
            --set env.DATABASE_URL="${{ secrets.PREVIEW_DATABASE_URL }}" \
            --set env.REDIS_URL="${{ secrets.PREVIEW_REDIS_URL }}" \
            --set env.NEO4J_URI="${{ secrets.PREVIEW_NEO4J_URI }}" \
            --timeout 10m \
            --wait

      - name: Verify deployment
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}"
          kubectl rollout status deployment/intelgraph-pr-${{ github.event.number }} -n ${NAMESPACE} --timeout=300s

  smoke-tests:
    if: github.event.action != 'closed'
    needs: deploy-preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.x'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm@9.12.0

      - name: Install dependencies
        run: pnpm install

      - name: Run smoke tests
        env:
          PREVIEW_URL: https://pr-${{ github.event.number }}.preview.intelgraph.dev
        run: |
          # Health check
          curl -f ${PREVIEW_URL}/health --max-time 30 --retry 3 --retry-delay 5

          # GraphQL health
          curl -f ${PREVIEW_URL}/health/graphql --max-time 30 --retry 3 --retry-delay 5

          # Basic GraphQL query
          curl -X POST ${PREVIEW_URL}/graphql \
            -H "Content-Type: application/json" \
            -d '{"query":"query Health { __typename }"}' \
            --max-time 30 --retry 3 --retry-delay 5

      - name: Run E2E golden path tests
        env:
          PREVIEW_URL: https://pr-${{ github.event.number }}.preview.intelgraph.dev
        run: |
          cd client
          pnpm test:golden-path

  update-pr:
    if: github.event.action != 'closed' && always()
    needs: [build-images, deploy-preview, smoke-tests]
    runs-on: ubuntu-latest
    env:
      HAS_KUBECONFIG: ${{ secrets.KUBECONFIG != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        if: env.HAS_KUBECONFIG == 'true'
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Configure kubeconfig
        if: env.HAS_KUBECONFIG == 'true'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Prepare preview metadata
        id: meta
        env:
          PREVIEW_URL: https://pr-${{ github.event.number }}.preview.intelgraph.dev
        run: |
          PREVIEW_URL="${PREVIEW_URL}"
          GRAPHQL_URL="${PREVIEW_URL}/graphql"
          HEALTH_URL="${PREVIEW_URL}/health"
          METRICS_URL="${PREVIEW_URL}/metrics"

          ENCODED_PREVIEW=$(python - <<'PY'
import os
import urllib.parse

print(urllib.parse.quote(os.environ.get("PREVIEW_URL", ""), safe=""))
PY
)
          ENCODED_GRAPHQL=$(python - <<'PY'
import os
import urllib.parse

print(urllib.parse.quote(os.environ.get("PREVIEW_URL", "") + "/graphql", safe=""))
PY
)

          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "graphql_url=${GRAPHQL_URL}" >> $GITHUB_OUTPUT
          echo "health_url=${HEALTH_URL}" >> $GITHUB_OUTPUT
          echo "metrics_url=${METRICS_URL}" >> $GITHUB_OUTPUT
          echo "preview_qr=https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${ENCODED_PREVIEW}" >> $GITHUB_OUTPUT
          echo "graphql_qr=https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${ENCODED_GRAPHQL}" >> $GITHUB_OUTPUT
          echo "deploy_status=${{ needs.deploy-preview.result }}" >> $GITHUB_OUTPUT
          echo "smoke_status=${{ needs.smoke-tests.result }}" >> $GITHUB_OUTPUT

      - name: Capture performance metrics
        id: perf
        env:
          PREVIEW_URL: https://pr-${{ github.event.number }}.preview.intelgraph.dev
        run: |
          set +e
          curl -w "http_code=%{http_code}\ntime_total=%{time_total}\ntime_connect=%{time_connect}\ntime_starttransfer=%{time_starttransfer}\nsize_download=%{size_download}\n" \
            -o /tmp/health_body.txt -s --max-time 20 "${PREVIEW_URL}/health" > /tmp/performance.txt
          status=$?
          set -e

          if [ $status -ne 0 ]; then
            SUMMARY="Health endpoint unreachable (curl exit ${status})."
          else
            HTTP_CODE=$(grep "http_code" /tmp/performance.txt | cut -d"=" -f2)
            TOTAL=$(grep "time_total" /tmp/performance.txt | cut -d"=" -f2)
            CONNECT=$(grep "time_connect" /tmp/performance.txt | cut -d"=" -f2)
            TTFB=$(grep "time_starttransfer" /tmp/performance.txt | cut -d"=" -f2)
            SIZE=$(grep "size_download" /tmp/performance.txt | cut -d"=" -f2)
            SUMMARY="HTTP ${HTTP_CODE} â€¢ total ${TOTAL}s â€¢ connect ${CONNECT}s â€¢ TTFB ${TTFB}s â€¢ bytes ${SIZE}"
          fi

          echo "summary=${SUMMARY}" >> $GITHUB_OUTPUT
          echo "raw<<'EOF'" >> $GITHUB_OUTPUT
          cat /tmp/performance.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Fetch deployment logs
        id: logs
        env:
          NAMESPACE: ${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}
        run: |
          if [ "${HAS_KUBECONFIG}" != "true" ]; then
            echo "Kubeconfig unavailable for this run; deployment logs not collected." > deployment.log
            echo "path=deployment.log" >> $GITHUB_OUTPUT
            exit 0
          fi

          set +e
          kubectl logs deployment/intelgraph-pr-${{ github.event.number }} -n ${NAMESPACE} --tail=80 > deployment.log
          status=$?
          set -e

          if [ $status -ne 0 ]; then
            echo "Deployment logs unavailable (exit ${status})." > deployment.log
          fi

          echo "path=deployment.log" >> $GITHUB_OUTPUT

      - name: Upload deployment logs
        uses: actions/upload-artifact@v4
        with:
          name: preview-deployment-logs-pr-${{ github.event.number }}
          path: ${{ steps.logs.outputs.path }}
          retention-days: 7

      - name: Update PR with preview details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIEW_URL: ${{ steps.meta.outputs.preview_url }}
          GRAPHQL_URL: ${{ steps.meta.outputs.graphql_url }}
          HEALTH_URL: ${{ steps.meta.outputs.health_url }}
          METRICS_URL: ${{ steps.meta.outputs.metrics_url }}
          PREVIEW_QR: ${{ steps.meta.outputs.preview_qr }}
          GRAPHQL_QR: ${{ steps.meta.outputs.graphql_qr }}
          DEPLOY_STATUS: ${{ steps.meta.outputs.deploy_status || 'skipped' }}
          SMOKE_STATUS: ${{ steps.meta.outputs.smoke_status || 'skipped' }}
          PERF_SUMMARY: ${{ steps.perf.outputs.summary }}
          PERF_RAW: ${{ steps.perf.outputs.raw }}
          SERVER_IMAGE: ${{ needs.build-images.outputs.server-image || '' }}
          CLIENT_IMAGE: ${{ needs.build-images.outputs.client-image || '' }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          format_status() {
            case "$1" in
              success) echo "âœ… Success" ;;
              failure) echo "âŒ Failed" ;;
              cancelled) echo "âš ï¸ Cancelled" ;;
              skipped) echo "âš ï¸ Skipped" ;;
              *) echo "â„¹ï¸ $1" ;;
            esac
          }

          DEPLOY_STATUS=${DEPLOY_STATUS:-skipped}
          SMOKE_STATUS=${SMOKE_STATUS:-skipped}
          PERF_SUMMARY=${PERF_SUMMARY:-"Performance metrics unavailable."}
          PERF_RAW=${PERF_RAW:-"No metrics captured."}
          SERVER_IMAGE=${SERVER_IMAGE:-"Unavailable (build failed or skipped)."}
          CLIENT_IMAGE=${CLIENT_IMAGE:-"Unavailable (build failed or skipped)."}

          DEPLOY_TEXT=$(format_status "${DEPLOY_STATUS}")
          SMOKE_TEXT=$(format_status "${SMOKE_STATUS}")

          LOG_SNIPPET=$(sed -n '1,60p' deployment.log)

          cat > pr-comment.md << EOF
          ## ðŸš€ Preview Environment Update

          | Check | Status |
          |-------|--------|
          | Deployment | ${DEPLOY_TEXT} |
          | Smoke & E2E | ${SMOKE_TEXT} |
          | Preview URL | [${PREVIEW_URL}](${PREVIEW_URL}) |
          | GraphQL Playground | [${GRAPHQL_URL}](${GRAPHQL_URL}) |
          | Health Check | [${HEALTH_URL}](${HEALTH_URL}) |
          | Metrics Endpoint | [${METRICS_URL}](${METRICS_URL}) |

          ### ðŸ“¦ Build Artifacts
          - Server image: \`${SERVER_IMAGE}\`
          - Client image: \`${CLIENT_IMAGE}\`
          - Workflow run artifacts: [Download from run](${RUN_URL}#artifacts)

          ### ðŸ“± Mobile Testing (QR Codes)
          | Preview | GraphQL |
          |---------|---------|
          | ![](${PREVIEW_QR}) | ![](${GRAPHQL_QR}) |

          ### ðŸ“Š Performance Snapshot
          - ${PERF_SUMMARY}

          <details>
          <summary>Raw metrics</summary>

          ```
          ${PERF_RAW}
          ```

          </details>

          ### ðŸ“œ Deployment Logs
          - Stored as artifact: **preview-deployment-logs-pr-${{ github.event.number }}**
          - Preview snippet:

          ```
          ${LOG_SNIPPET}
          ```

          > This preview environment updates automatically with each push. Resources will be reclaimed when the PR is closed.
          EOF

          gh pr comment ${{ github.event.number }} --body-file pr-comment.md

  teardown:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Teardown preview environment
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}"
          PR_NUMBER=${{ github.event.number }}

          # Remove Helm release
          helm uninstall intelgraph-pr-${PR_NUMBER} --namespace ${NAMESPACE} --ignore-not-found

          # Delete namespace
          kubectl delete namespace ${NAMESPACE} --ignore-not-found --timeout=300s

      - name: Cleanup container images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete PR-specific images
          gh api --method DELETE \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.repository }}%2Fserver/versions" \
            --field "tag=pr-${{ github.event.number }}" || true

          gh api --method DELETE \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.repository }}%2Fclient/versions" \
            --field "tag=pr-${{ github.event.number }}" || true

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.number }} --body "ðŸ§¹ Preview environment has been cleaned up and resources have been freed."
