name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  deploy-preview:
    if: contains(github.event.pull_request.labels.*.name, 'preview')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      # Kube auth (OIDC) - Replace with your cloud provider's action
      # - name: Authenticate to Cloud
      #   uses: aws-actions/configure-aws-credentials@v4 ...

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Build & Push Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}/app:${{ github.sha }}

      - name: Deploy Preview
        env:
          RELEASE_NAME: preview-${{ github.event.pull_request.number }}
          NAMESPACE: previews
        run: |
          helm upgrade --install $RELEASE_NAME ./deploy/helm/intelgraph \
            --namespace $NAMESPACE \
            --create-namespace \
            --set image.tag=${{ github.sha }} \
            --set ingress.host=$RELEASE_NAME.example.com \
            --wait

      - name: Seed Data
        run: |
          chmod +x ops/seed_demo.sh
          ./ops/seed_demo.sh

      - name: Post Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸš€ Preview Environment Deployed!
            URL: https://preview-${{ github.event.pull_request.number }}.example.com

  teardown-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      # Auth steps...
      - name: Uninstall Helm Release
        env:
          RELEASE_NAME: preview-${{ github.event.pull_request.number }}
          NAMESPACE: previews
        run: |
          helm uninstall $RELEASE_NAME --namespace $NAMESPACE || true
