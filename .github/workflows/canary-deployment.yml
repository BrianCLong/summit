name: Canary Deployment

permissions:
  contents: read
  packages: write
  deployments: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy as canary'
        required: true
        type: string
      canary_percentage:
        description: 'Percentage of traffic for canary (1-50)'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - '5'
          - '10'
          - '15'
          - '20'
          - '25'
          - '35'
          - '50'
          - '75'
          - '100'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - 'staging'
          - 'production'
      application:
        description: 'Target application'
        required: true
        type: choice
        options:
          - 'maestro'
          - 'intelgraph'
          - 'companyos'
      action:
        description: 'Canary action to perform'
        required: true
        type: choice
        options:
          - 'deploy'
          - 'promote'
          - 'abort'

env:
  REGISTRY: ghcr.io

concurrency:
  group: canary-${{ inputs.environment }}-${{ inputs.application }}
  cancel-in-progress: false

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      version-valid: ${{ steps.validate.outputs.version-valid }}
      namespace: ${{ steps.validate.outputs.namespace }}
      release-name: ${{ steps.validate.outputs.release-name }}
      canary-stages: ${{ steps.validate.outputs.canary-stages }}
      feature-flag: ${{ steps.validate.outputs.feature-flag }}
      resolved-canary-percent: ${{ steps.validate.outputs.resolved-canary-percent }}
    steps:
      - name: Validate inputs
        id: validate
        run: |
          CONFIG_PATH="summit_release_env_pack/canary/canary-traffic.json"

          if ! jq -e --arg app "${{ inputs.application }}" '.[$app]' "$CONFIG_PATH" >/dev/null; then
            echo "âŒ Application '${{ inputs.application }}' not found in $CONFIG_PATH"
            exit 1
          fi

          # Validate version format
          if [[ "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "version-valid=true" >> $GITHUB_OUTPUT
          else
            echo "version-valid=false" >> $GITHUB_OUTPUT
            echo "âŒ Invalid version format. Expected: vX.Y.Z"
            exit 1
          fi

          # Set namespace based on environment and application
          NAMESPACE=$(jq -r --arg app "${{ inputs.application }}" --arg env "${{ inputs.environment }}" '.[$app].namespaces[$env]' "$CONFIG_PATH")
          if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "null" ]; then
            echo "âŒ Namespace not defined for ${{ inputs.application }} in ${{ inputs.environment }}"
            exit 1
          fi
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

          RELEASE_NAME=$(jq -r --arg app "${{ inputs.application }}" '.[$app].releaseName' "$CONFIG_PATH")
          echo "release-name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          CANARY_STAGES=$(jq -r --arg app "${{ inputs.application }}" '.[$app].canaryStages | join(",")' "$CONFIG_PATH")
          echo "canary-stages=$CANARY_STAGES" >> $GITHUB_OUTPUT

          FEATURE_FLAG=$(jq -r --arg app "${{ inputs.application }}" '.[$app].featureFlag' "$CONFIG_PATH")
          echo "feature-flag=$FEATURE_FLAG" >> $GITHUB_OUTPUT

          # Validate canary percentage
          IFS=',' read -r -a STAGE_LIST <<< "$CANARY_STAGES"
          REQUESTED_PERCENT="${{ inputs.canary_percentage }}"
          if [ "$REQUESTED_PERCENT" = "auto" ]; then
            RESOLVED_PERCENT="${STAGE_LIST[0]}"
          else
            RESOLVED_PERCENT="$REQUESTED_PERCENT"
          fi

          VALID_PERCENT=false
          for stage in "${STAGE_LIST[@]}"; do
            if [ "$stage" = "$RESOLVED_PERCENT" ]; then
              VALID_PERCENT=true
            fi
          done

          if [ "$VALID_PERCENT" = false ]; then
            echo "âŒ Canary percentage ${RESOLVED_PERCENT}% is not permitted for ${{ inputs.application }} (allowed: ${CANARY_STAGES//,/%, }%)"
            exit 1
          fi
          echo "resolved-canary-percent=$RESOLVED_PERCENT" >> $GITHUB_OUTPUT

  pre-flight-checks:
    if: inputs.action == 'deploy'
    needs: validate-inputs
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connectivity
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Check current deployment health
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"
          CANARY_NAME="${RELEASE_NAME}-canary"

          # Check if main deployment is healthy
          kubectl get deployment "${RELEASE_NAME}" -n "${NAMESPACE}"
          kubectl rollout status deployment/"${RELEASE_NAME}" -n "${NAMESPACE}" --timeout=60s

          # Check if canary already exists
          if kubectl get deployment "${CANARY_NAME}" -n "${NAMESPACE}" 2>/dev/null; then
            echo "âš ï¸ Canary deployment already exists!"
            echo "Please promote or abort existing canary before deploying new one"
            exit 1
          fi

      - name: Verify image exists
        run: |
          # Check if the specified version exists in registry
          docker manifest inspect ${{ env.REGISTRY }}/${{ github.repository }}/server:${{ inputs.version }}
          docker manifest inspect ${{ env.REGISTRY }}/${{ github.repository }}/client:${{ inputs.version }}

  deploy-canary:
    if: inputs.action == 'deploy'
    needs: [validate-inputs, pre-flight-checks]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy canary
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          ./scripts/rollback-deployment.sh canary-deploy ${{ inputs.version }} \
            --namespace ${NAMESPACE} \
            --release ${RELEASE_NAME} \
            --canary-percent ${{ needs.validate-inputs.outputs.resolved-canary-percent }}

      - name: Run canary health checks (SLO Gate)
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          # Wait for canary to be ready
          kubectl rollout status deployment/${RELEASE_NAME}-canary -n ${NAMESPACE} --timeout=300s

          # Run comprehensive health checks
          ./scripts/rollback-deployment.sh health-check --namespace ${NAMESPACE}

          # CHECK SLOs (Simulated - TEMPLATE)
          # TODO: Implement real SLO check using Prometheus or similar.
          # Example: curl -s "http://prometheus/api/v1/query?query=..."
          # For this template, we simulate success.
          echo "Checking SLOs for canary..."
          echo "âœ… [TEMPLATE] SLO Check Passed: Error Rate < 1%, p95 Latency < 500ms"

      - name: Update deployment status
        run: |
          echo "ðŸš€ Canary deployment successful!"
          echo "Version: ${{ inputs.version }}"
          echo "Traffic: ${{ needs.validate-inputs.outputs.resolved-canary-percent }}%"
          echo "Environment: ${{ inputs.environment }}"

  promote-canary:
    if: inputs.action == 'promote'
    needs: validate-inputs
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup tools
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Pre-promote health check (SLO Gate)
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          # Verify canary exists and is healthy
          kubectl get deployment ${RELEASE_NAME}-canary -n ${NAMESPACE}
          kubectl rollout status deployment/${RELEASE_NAME}-canary -n ${NAMESPACE} --timeout=60s

          # Run health checks
          ./scripts/rollback-deployment.sh health-check --namespace ${NAMESPACE} --release ${RELEASE_NAME}

          # BURN RATE CHECK (Simulated - TEMPLATE)
          # TODO: Implement real burn rate check.
          echo "Checking Burn Rate..."
          echo "âœ… [TEMPLATE] Burn Rate within limits."

      - name: Promote canary to production
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          ./scripts/rollback-deployment.sh canary-promote --namespace ${NAMESPACE} --release ${RELEASE_NAME}

      - name: Post-promotion verification
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          # Verify promotion
          kubectl rollout status deployment/${RELEASE_NAME} -n ${NAMESPACE} --timeout=300s

          # Final health check
          ./scripts/rollback-deployment.sh health-check --namespace ${NAMESPACE} --release ${RELEASE_NAME}

      - name: Update deployment status
        run: |
          echo "âœ… Canary promoted to production!"
          echo "Version: ${{ inputs.version }}"
          echo "Traffic: 100%"
          echo "Environment: ${{ inputs.environment }}"

  abort-canary:
    if: inputs.action == 'abort'
    needs: validate-inputs
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup tools
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Abort canary deployment
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          ./scripts/rollback-deployment.sh canary-abort --namespace ${NAMESPACE} --release ${RELEASE_NAME}

      - name: Verify abort and rollback
        run: |
          NAMESPACE="${{ needs.validate-inputs.outputs.namespace }}"
          RELEASE_NAME="${{ needs.validate-inputs.outputs.release-name }}"

          # Verify canary is removed
          if kubectl get deployment ${RELEASE_NAME}-canary -n ${NAMESPACE} 2>/dev/null; then
            echo "âŒ Canary deployment still exists!"
            exit 1
          fi

          # Verify stable deployment is healthy
          kubectl rollout status deployment/${RELEASE_NAME} -n ${NAMESPACE} --timeout=300s

          # Health check
          ./scripts/rollback-deployment.sh health-check --namespace ${NAMESPACE} --release ${RELEASE_NAME}

      - name: Update deployment status
        run: |
          echo "ðŸ”„ Canary aborted and rolled back!"
          echo "Environment: ${{ inputs.environment }}"
          echo "Status: Stable deployment restored"

  notify-teams:
    if: always()
    needs: [deploy-canary, promote-canary, abort-canary]
    runs-on: ubuntu-latest
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ inputs.action }}" = "deploy" ]; then
            if [ "${{ needs.deploy-canary.result }}" = "success" ]; then
              echo "status=ðŸš€ Canary Deployed" >> $GITHUB_OUTPUT
              echo "color=good" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Canary Deploy Failed" >> $GITHUB_OUTPUT
              echo "color=danger" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ inputs.action }}" = "promote" ]; then
            if [ "${{ needs.promote-canary.result }}" = "success" ]; then
              echo "status=âœ… Canary Promoted" >> $GITHUB_OUTPUT
              echo "color=good" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Canary Promote Failed" >> $GITHUB_OUTPUT
              echo "color=danger" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ inputs.action }}" = "abort" ]; then
            if [ "${{ needs.abort-canary.result }}" = "success" ]; then
              echo "status=ðŸ”„ Canary Aborted" >> $GITHUB_OUTPUT
              echo "color=warning" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Canary Abort Failed" >> $GITHUB_OUTPUT
              echo "color=danger" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              attachments: [{
                color: '${{ steps.status.outputs.color }}',
                title: 'IntelGraph Canary Deployment',
                fields: [{
                  title: 'Status',
                  value: '${{ steps.status.outputs.status }}',
                  short: true
                }, {
                  title: 'Application',
                  value: '${{ inputs.application }}',
                  short: true
                }, {
                  title: 'Traffic',
                  value: '${{ needs.validate-inputs.outputs.resolved-canary-percent }}%',
                  short: true
                }, {
                  title: 'Flag',
                  value: '${{ needs.validate-inputs.outputs.feature-flag }}',
                  short: true
                }, {
                  title: 'Environment',
                  value: '${{ inputs.environment }}',
                  short: true
                }, {
                  title: 'Version',
                  value: '${{ inputs.version }}',
                  short: true
                }, {
                  title: 'Action',
                  value: '${{ inputs.action }}',
                  short: true
                }, {
                  title: 'Workflow',
                  value: '<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>',
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
