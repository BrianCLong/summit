name: "MVP-4-GA Hard Gate"

on:
  pull_request:
    branches: [main]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. Deterministic Build & Lint
  build-lint-strict:
    name: "Build & Lint (Strict)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # v6
      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9.12.0
      - name: Setup Node
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Strict Lint
        run: pnpm lint:strict
      - name: Typecheck
        run: pnpm typecheck

  quarantine-tests:
    name: "Quarantine Tests (Flaky)"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4 # v6
      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9.12.0
      - name: Setup Node
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Run Flaky Tests
        run: pnpm test:quarantine

  # 2. Security Gates
  security-gate:
    name: "Security Gate (Gitleaks + Snyk)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # v6
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9.12.0
      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Dependency Check
        run: |
          echo "Scanning for Critical CVEs..."
          pnpm audit --audit-level critical

  # 3. Policy Compliance
  policy-check:
    name: "Governance Policy Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # v6
      - name: Setup OPA
        uses:
          open-policy-agent/setup-opa@950f159a49aa91f9323f36f1de81c7f6b5de9576     # v2
        with:
          version: v0.61.0
      - name: Verify Policies
        run: |
          opa check policies/
          opa test policies/ -v

  # 4. Smoke Test (Golden Path)
  smoke-test:
    name: "Golden Path Smoke"
    needs: [build-lint-strict]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # v6
      - name: Bootstrap & Smoke
        run: |
          echo "Executing Golden Path Smoke Test..."
          make smoke

  # 5. Final GA Gate
  mvp4-ga-gate:
    name: "MVP-4-GA Promotion Gate"
    needs: [build-lint-strict, security-gate, policy-check, smoke-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Verify All Gates Passed
        run: |
          if [[ "${{ needs.build-lint-strict.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.security-gate.result }}" != "success" ]]; then exit 1; fi
          # Policy check is non-blocking until Rego syntax is modernized
          # if [[ "${{ needs.policy-check.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.smoke-test.result }}" != "success" ]]; then exit 1; fi
          echo "GATE PASSED: MVP-4-GA Candidate Verified."
