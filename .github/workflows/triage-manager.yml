name: Triage Manager

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  issues:
    types: [opened, reopened, unassigned]

jobs:
  triage-enforcement:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check for unassigned critical issues
        uses: actions/github-script@v7
        with:
          script: |
            const opts = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            };

            const issues = await github.paginate(github.rest.issues.listForRepo, opts);

            for (const issue of issues) {
              if (issue.pull_request) continue; // Skip PRs

              const labels = issue.labels.map(l => l.name);
              const isCritical = labels.includes('critical') || labels.includes('security') || labels.includes('P0');
              const hasAssignee = issue.assignees && issue.assignees.length > 0;
              const hasNeedsTriage = labels.includes('needs-triage');

              if (isCritical && !hasAssignee && !hasNeedsTriage) {
                console.log(`Issue #${issue.number} is critical/security but unassigned. Adding needs-triage label.`);
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['needs-triage']
                });

                // Add a comment to notify
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '⚠️ **Critical/Security Issue Unassigned**\n\nThis issue is marked as critical but has no assignee. Please assign an owner immediately to ensure it is addressed.\n\ncc: @' + context.repo.owner // Mentioning repo owner as fallback
                });
              }
            }
