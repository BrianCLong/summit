name: SLSA L3 Air-Gapped Build Pipeline

on:
  workflow_dispatch:
    inputs:
      bundle_version:
        description: 'Bundle version (e.g., v1.0.0)'
        required: true
        type: string
      target_classification:
        description: 'Target classification level'
        required: true
        type: choice
        options:
          - UNCLASSIFIED
          - CUI
          - SECRET
          - TOP_SECRET
        default: CUI
      transfer_media:
        description: 'Transfer media type'
        required: true
        type: choice
        options:
          - secure_usb
          - dvd_rom
          - tape_archive
          - encrypted_transfer
        default: secure_usb
      include_verification_tools:
        description: 'Include SLSA verification tools in bundle'
        type: boolean
        default: true
      fips_mode:
        description: 'Enable FIPS 140-2 compliance mode'
        type: boolean
        default: true

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_SERVER: ${{ github.repository }}/server
  IMAGE_NAME_WEB: ${{ github.repository }}/web
  BUNDLE_NAME: intelgraph-airgap-bundle

jobs:
  preflight:
    name: Air-Gap Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      bundle-id: ${{ steps.bundle-info.outputs.bundle-id }}
    steps:
      - uses: actions/checkout@v4
      - name: Generate bundle info
        id: bundle-info
        run: |
          VERSION="${{ inputs.bundle_version || github.ref_name }}"
          BUNDLE_ID="${{ env.BUNDLE_NAME }}-${VERSION}-$(date +%Y%m%d%H%M%S)"
          echo "bundle-id=$BUNDLE_ID" >> "$GITHUB_OUTPUT"

  build-server:
    needs: preflight
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Server
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_SERVER }}:airgap-${{ inputs.bundle_version }}
          provenance: mode=max
          sbom: true
      - name: Export Server Image
        run: |
          mkdir -p images
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_SERVER }}:airgap-${{ inputs.bundle_version }}
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_SERVER }}:airgap-${{ inputs.bundle_version }} -o images/server.tar
      - uses: actions/upload-artifact@v4
        with:
          name: server-image
          path: images/server.tar

  build-web:
    needs: preflight
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Web
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WEB }}:airgap-${{ inputs.bundle_version }}
          provenance: mode=max
          sbom: true
      - name: Export Web Image
        run: |
          mkdir -p images
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WEB }}:airgap-${{ inputs.bundle_version }}
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WEB }}:airgap-${{ inputs.bundle_version }} -o images/web.tar
      - uses: actions/upload-artifact@v4
        with:
          name: web-image
          path: images/web.tar

  create-bundle:
    needs: [preflight, build-server, build-web]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Create Bundle
        run: |
          mkdir -p bundle/images
          cp artifacts/server-image/server.tar bundle/images/
          cp artifacts/web-image/web.tar bundle/images/

          # Create manifest
          cat > bundle/manifest.json <<EOF
          {
            "bundleId": "${{ needs.preflight.outputs.bundle-id }}",
            "version": "${{ inputs.bundle_version }}",
            "serverDigest": "${{ needs.build-server.outputs.image-digest }}",
            "webDigest": "${{ needs.build-web.outputs.image-digest }}",
            "classification": "${{ inputs.target_classification }}"
          }
          EOF

          tar -czvf airgap-bundle.tar.gz bundle/
      - uses: actions/upload-artifact@v4
        with:
          name: airgap-bundle
          path: airgap-bundle.tar.gz
