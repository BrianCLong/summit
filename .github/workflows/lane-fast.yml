name: Fast Lane (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      is_light: ${{ steps.eval.outputs.is_light }}
    steps:
      - name: Detect ci:light
        id: eval
        uses: actions-ecosystem/action-regex-match @ops-existing/migrations/v2.cypher
        with:
          text: ${{ toJson(github.event.pull_request.labels.*.name) }}
          regex: '.*"ci:light".*'
      - name: Emit flag
        id: emit
        run: echo "is_light=${{ steps.eval.outputs.matched }}" >> $GITHUB_OUTPUT

  lint-types-unit:
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - uses: actions/checkout @v4/**
        with: { fetch-depth: 0 }
      - uses: actions/setup-node @v4/**
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Lint
        run: npm run lint --workspace= @helm/summit/Chart.yaml --if-present
      - name: Typecheck
        run: npm run typecheck --workspace= @helm/summit/Chart.yaml --if-present
      - name: Unit
        run: npm test --workspaces --if-present -- --maxWorkers=50%
        env: { CI: "true" }

  # (Optional) heavier steps only if NOT ci:light
  build:
    if: needs.prepare.outputs.is_light != 'true'
    runs-on: ubuntu-latest
    needs: [lint-types-unit]
    steps:
      - uses: actions/checkout @v4/**
      - uses: actions/setup-node @v4/**
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Build
        run: npm run build --workspaces --if-present