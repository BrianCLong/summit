name: golden-main
on:
  schedule: [cron: "*/30 * * * *"]
  workflow_dispatch:

env:
  REQUIRED_CHECKS: "Config Preflight,Lint & Typecheck,Unit Tests,Integration Tests,Verification Suite,Deterministic Build,Governance / Docs Integrity,Golden Path Smoke Test,E2E Tests (Playwright),SOC Control Verification,Governance / Branch Protection Drift,CI Core Gate ✅"

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: read
    steps:
      - uses: actions/checkout@v4
        with: {fetch-depth: 50}
      - name: Get last 3 main SHAs
        run: |
          git fetch origin main --deepen=50
          git checkout -q main
          git log --pretty=format:%H -n 3 > last3.txt
          cat last3.txt
      - name: Verify required checks are green
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const shas = fs.readFileSync('last3.txt','utf8').trim().split('\n');
            const required = (process.env.REQUIRED_CHECKS || '').split(',').map(s=>s.trim()).filter(Boolean);
            if (!required.length) core.setFailed('Set REQUIRED_CHECKS env (comma‑separated).');
            for (const sha of shas) {
              core.info(`Checking ${sha}`);
              const { data: runs } = await github.rest.checks.listForRef({
                owner: context.repo.owner, repo: context.repo.repo, ref: sha, per_page: 100
              });
              for (const req of required) {
                const match = runs.check_runs.find(r => r.name === req);
                if (!match) core.setFailed(`Missing check '${req}' on ${sha}`);
                else if (match.conclusion !== 'success')
                  core.setFailed(`Check '${req}' not green on ${sha} (state=${match.conclusion})`);
                else
                  core.info(`✅ ${req} passed on ${sha}`);
              }
            }
