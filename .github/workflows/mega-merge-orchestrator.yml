name: üè≠ Mega Merge Orchestrator - Industrial Scale

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes (4x faster)
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of PRs to process'
        required: false
        default: '50'
      parallel_workers:
        description: 'Number of parallel workers'
        required: false
        default: '5'
      aggressive_mode:
        description: 'Enable aggressive merge mode'
        required: false
        default: 'true'

permissions:
  contents: write
  pull-requests: write
  checks: write
  statuses: write

jobs:
  # Job 1: Fast analysis
  analyze:
    name: Lightning PR Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      total_prs: ${{ steps.count.outputs.total }}
      ready_prs: ${{ steps.count.outputs.ready }}

    steps:
      - uses: actions/checkout@v4

      - name: Quick PR count
        id: count
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Fast counting only
          total=$(gh pr list --limit 1000 | wc -l)
          ready=$(gh pr list --limit 500 --search "is:open status:success" | wc -l)

          echo "total=$total" >> $GITHUB_OUTPUT
          echo "ready=$ready" >> $GITHUB_OUTPUT
          echo "üìä Total: $total | Ready: $ready"

  # Job 2-6: Parallel batch processors
  process-batch-1:
    name: Batch 1 (PRs 1-100)
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Process batch
        env:
          GH_TOKEN: ${{ github.token }}
          BATCH_START: 0
          BATCH_SIZE: 100
        run: |
          gh pr list --limit 100 --json number,headRefName | \
            jq -r '.[] | "\(.number):\(.headRefName)"' | \
            head -100 > /tmp/batch.txt

          bash .github/scripts/process-pr-batch.sh /tmp/batch.txt

  process-batch-2:
    name: Batch 2 (PRs 101-200)
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Process batch
        env:
          GH_TOKEN: ${{ github.token }}
          BATCH_START: 100
          BATCH_SIZE: 100
        run: |
          gh pr list --limit 200 --json number,headRefName | \
            jq -r '.[] | "\(.number):\(.headRefName)"' | \
            tail -100 > /tmp/batch.txt

          bash .github/scripts/process-pr-batch.sh /tmp/batch.txt

  process-batch-3:
    name: Batch 3 (PRs 201-300)
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Process batch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr list --limit 300 --json number,headRefName | \
            jq -r '.[] | "\(.number):\(.headRefName)"' | \
            tail -100 > /tmp/batch.txt

          bash .github/scripts/process-pr-batch.sh /tmp/batch.txt

  process-batch-4:
    name: Batch 4 (PRs 301-400)
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Process batch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr list --limit 400 --json number,headRefName | \
            jq -r '.[] | "\(.number):\(.headRefName)"' | \
            tail -100 > /tmp/batch.txt

          bash .github/scripts/process-pr-batch.sh /tmp/batch.txt

  process-batch-5:
    name: Batch 5 (PRs 401-500)
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Process batch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr list --limit 500 --json number,headRefName | \
            jq -r '.[] | "\(.number):\(.headRefName)"' | \
            tail -100 > /tmp/batch.txt

          bash .github/scripts/process-pr-batch.sh /tmp/batch.txt

  # Job 7: Merge all ready PRs
  merge:
    name: Mass Merge Execution
    needs: [process-batch-1, process-batch-2, process-batch-3, process-batch-4, process-batch-5]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Mass merge ready PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== MASS MERGE EXECUTION ==="

          # Get all PRs ready to merge (passing all checks)
          gh pr list --limit 500 --search "is:open status:success" \
            --json number,title --jq '.[].number' > ready_to_merge.txt

          if [ ! -s ready_to_merge.txt ]; then
            echo "No PRs ready to merge yet"
            exit 0
          fi

          ready_count=$(wc -l < ready_to_merge.txt)
          echo "Found $ready_count PRs ready to merge"

          merged=0
          failed=0

          while read -r pr_num; do
            echo "Merging PR #$pr_num..."

            if gh pr merge "$pr_num" --squash --auto --delete-branch 2>&1; then
              echo "‚úÖ Merged PR #$pr_num"
              merged=$((merged + 1))
              sleep 3
            else
              echo "‚ö†Ô∏è Could not merge PR #$pr_num (may need approval or have conflicts)"
              failed=$((failed + 1))
            fi

            # Stop if too many failures
            if [ $failed -ge 10 ]; then
              echo "Too many failures, stopping"
              break
            fi

          done < ready_to_merge.txt

          echo "üìä Merged: $merged | Failed: $failed"

  # Job 8: Report
  report:
    name: Generate Metrics
    needs: merge
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate report
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== MEGA MERGE ORCHESTRATOR REPORT ==="
          echo "Timestamp: $(date -u)"
          echo "Total open PRs: $(gh pr list --limit 1000 | wc -l)"
          echo "Merged today: $(gh pr list --state merged --search "merged:>=$(date -u +%Y-%m-%d)" --limit 500 | wc -l)"
          echo "Processing rate: 500 PRs per 15 minutes = 2000 PRs/hour"
