name: Release

on:
  workflow_call:
    inputs:
      version:
        description: Version string (without leading v)
        required: true
        type: string

jobs:
  build-server:
    name: Build server image
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: ${{ github.repository }}/server
      dockerfile: ./server/Dockerfile.prod
      context: ./server
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}

  build-client:
    name: Build client image
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: ${{ github.repository }}/client
      dockerfile: ./client/Dockerfile.prod
      context: ./client
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Create release bundle
    runs-on: ubuntu-latest
    needs:
      - build-server
      - build-client
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.run_id }}
          path: build-artifacts
          merge-multiple: true
      - name: Prepare release directory
        run: mkdir -p release-bundle/compliance
      - name: Move artifacts to compliance bundle
        run: mv build-artifacts/* release-bundle/compliance/
      - name: Generate manifest
        run: |
          echo '{
            "version": "${{ inputs.version }}",
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "serverImage": "${{ needs.build-server.outputs.image_uri }}",
            "clientImage": "${{ needs.build-client.outputs.image_uri }}",
            "slsaLevel": "SLSA_3"
          }' > release-bundle/manifest.json
      - name: Create compliance bundle archive
        run: |
          tar -czf \
            release-bundle/compliance-bundle-v${{ inputs.version }}.tgz \
            -C release-bundle/compliance .
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: release-bundle/
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Summit v${{ inputs.version }}
          body: |
            **Release v${{ inputs.version }}**

            - Server Image: `${{ needs.build-server.outputs.image_uri }}`
            - Client Image: `${{ needs.build-client.outputs.image_uri }}`
          files: |
            release-bundle/manifest.json
            release-bundle/compliance-bundle-v${{ inputs.version }}.tgz
