name: ðŸ”§ Reusable - Environment Setup
# Universal setup workflow for Node.js, pnpm, Python, and caching
# Optimized for monorepo with Turbo and pnpm workspaces

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version (e.g., "20.x", "18.x", "20")'
        required: false
        type: string
        default: "20.x"
      pnpm-version:
        description: "pnpm version"
        required: false
        type: string
        default: "9.12.0"
      python-version:
        description: "Python version (optional)"
        required: false
        type: string
        default: ""
      install-deps:
        description: "Install dependencies"
        required: false
        type: boolean
        default: true
      cache-dependency-path:
        description: "Path to lockfile for cache key"
        required: false
        type: string
        default: "pnpm-lock.yaml"
      working-directory:
        description: "Working directory for installation"
        required: false
        type: string
        default: "."
    outputs:
      node-version:
        description: "Resolved Node.js version"
        value: ${{ jobs.setup.outputs.node }}
      pnpm-version:
        description: "Resolved pnpm version"
        value: ${{ jobs.setup.outputs.pnpm }}
      cache-hit:
        description: "Whether cache was hit"
        value: ${{ jobs.setup.outputs.cache-hit }}

permissions:
  contents: read

# Global environment - prevents V8 heap exhaustion
env:
  NODE_OPTIONS: --max-old-space-size=8192

jobs:
  setup:
    name: Setup Environment
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os: [ubuntu-latest]
    outputs:
      node: ${{ steps.versions.outputs.node }}
      pnpm: ${{ steps.versions.outputs.pnpm }}
      cache-hit: ${{ steps.cache-pnpm.outputs.cache-hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # v6

      - name: Install Git 2.47.1+ and disable bundle URIs
        shell: bash
        run: |
          set -euo pipefail
          sudo add-apt-repository ppa:git-core/ppa -y
          sudo apt-get update
          sudo apt-get install -y git
          git --version
          git config --global transfer.bundleURI false
          required_version="2.47.1"
          current_version="$(git --version | awk '{print $3}')"
          if [[ "$(printf '%s\n' "$required_version" "$current_version" | sort -V | head -n1)" != "$required_version" ]]; then
            echo "::error::Git version $current_version is below required $required_version."
            exit 1
          fi
          if [[ "$(git config --global --get transfer.bundleURI)" != "false" ]]; then
            echo "::error::transfer.bundleURI must be disabled."
            exit 1
          fi

      - name: Resolve versions
        id: versions
        run: |
          echo "node=${{ inputs.node-version }}" >> "$GITHUB_OUTPUT"
          echo "pnpm=${{ inputs.pnpm-version }}" >> "$GITHUB_OUTPUT"

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: ${{ inputs.node-version }}
          cache: "pnpm"
          cache-dependency-path: ${{ inputs.cache-dependency-path }}

      - name: Get pnpm store path
        id: pnpm-store
        shell: bash
        run: |
          echo "path=$(pnpm store path)" >> "$GITHUB_OUTPUT"

      - name: Cache dependencies
        id: cache-pnpm
        uses: actions/cache@v4 # v5
        with:
          path: |
            ~/.pnpm-store
            node_modules
            .next/cache
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        if: inputs.install-deps
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile

      - name: Setup Python (optional)
        if: inputs.python-version != ''
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: ${{ inputs.python-version }}
          cache: "pip"

      - name: Install Python dependencies (optional)
        if: inputs.python-version != '' && hashFiles('requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Log environment
        run: |
          echo "### ðŸ”§ Environment Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | $(node --version) |" >> $GITHUB_STEP_SUMMARY
          echo "| pnpm | $(pnpm --version) |" >> $GITHUB_STEP_SUMMARY
          echo "| npm | $(npm --version) |" >> $GITHUB_STEP_SUMMARY
          if command -v python3 &> /dev/null; then
            echo "| Python | $(python3 --version) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cache Status:** ${{ steps.cache-pnpm.outputs.cache-hit == 'true' && 'âœ… Hit' || 'âŒ Miss' }}" >> $GITHUB_STEP_SUMMARY
