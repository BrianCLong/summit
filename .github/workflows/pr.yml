name: pr
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true
jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      node_dirs: ${{ steps.paths.outputs.node_dirs }}
      python_dirs: ${{ steps.paths.outputs.python_dirs }}
    steps:
      - uses: actions/checkout@v4
      - id: paths
        run: |
          python3 ./.ci/scripts/changed_paths.py > matrix.json
          echo "node_dirs=$(jq -c '.node' matrix.json)" >> $GITHUB_OUTPUT
          echo "python_dirs=$(jq -c '.python' matrix.json)" >> $GITHUB_OUTPUT

  node_build_test:
    needs: discover
    if: ${{ needs.discover.outputs.node_dirs != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.node_dirs) }}
    uses: ./.github/workflows/wf-reuse-build-node.yml
    with: { working-directory: ${{ matrix.dir }} }

  node_tests:
    needs: [node_build_test]
    if: ${{ needs.discover.outputs.node_dirs != '[]' }}
    strategy:
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.node_dirs) }}
    uses: ./.github/workflows/wf-reuse-test-node.yml
    with: { working-directory: ${{ matrix.dir }}, shard-total: 2 }

  py_build:
    needs: discover
    if: ${{ needs.discover.outputs.python_dirs != '[]' }}
    strategy:
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.python_dirs) }}
    uses: ./.github/workflows/wf-reuse-build-python.yml
    with: { working-directory: ${{ matrix.dir }} }

  py_tests:
    needs: [py_build]
    if: ${{ needs.discover.outputs.python_dirs != '[]' }}
    strategy:
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.python_dirs) }}
    uses: ./.github/workflows/wf-reuse-test-python.yml
    with: { working-directory: ${{ matrix.dir }} }

  scan:
    needs: [node_tests, py_tests]
    uses: ./.github/workflows/ci-reusable-scan.yml

  package:
    needs: [scan]
    uses: ./.github/workflows/ci-reusable-package.yml
    secrets: inherit

  preview:
    needs: [package]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy preview env
        run: ./.ci/scripts/preview_deploy.sh