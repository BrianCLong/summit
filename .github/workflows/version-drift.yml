name: Version Drift Detection

# Detect inconsistencies between version specifications across the repository
# Ensures reproducibility by validating all version pins are synchronized

on:
  push:
    paths:
      - '.nvmrc'
      - '.node-version'
      - '.tool-versions'
      - 'package.json'
      - '**/package.json'
      - '**/.nvmrc'
  pull_request:
    paths:
      - '.nvmrc'
      - '.node-version'
      - '.tool-versions'
      - 'package.json'
      - '**/package.json'
      - '**/.nvmrc'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: version-drift-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-drift:
    name: Detect Version Drift
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Node.js Version Consistency
        id: node-check
        run: |
          echo "# Version Drift Report" > version-drift-report.md
          echo "" >> version-drift-report.md
          echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> version-drift-report.md
          echo "" >> version-drift-report.md

          DRIFT_FOUND=false

          # Expected canonical version from .nvmrc
          CANONICAL_NODE=$(cat .nvmrc 2>/dev/null | tr -d 'v' | tr -d '\n')
          echo "## Node.js Version Check" >> version-drift-report.md
          echo "" >> version-drift-report.md
          echo "**Canonical version (.nvmrc):** $CANONICAL_NODE" >> version-drift-report.md
          echo "" >> version-drift-report.md

          # Check .node-version
          if [ -f ".node-version" ]; then
            NODE_VERSION=$(cat .node-version | tr -d 'v' | tr -d '\n')
            if [ "$NODE_VERSION" != "$CANONICAL_NODE" ]; then
              echo "- ❌ **.node-version:** $NODE_VERSION (expected: $CANONICAL_NODE)" >> version-drift-report.md
              DRIFT_FOUND=true
            else
              echo "- ✅ **.node-version:** $NODE_VERSION" >> version-drift-report.md
            fi
          fi

          # Check .tool-versions
          if [ -f ".tool-versions" ]; then
            TOOL_NODE=$(grep "^nodejs" .tool-versions | awk '{print $2}' | tr -d '\n')
            if [ -n "$TOOL_NODE" ] && [ "$TOOL_NODE" != "$CANONICAL_NODE" ]; then
              echo "- ❌ **.tool-versions (nodejs):** $TOOL_NODE (expected: $CANONICAL_NODE)" >> version-drift-report.md
              DRIFT_FOUND=true
            else
              echo "- ✅ **.tool-versions (nodejs):** $TOOL_NODE" >> version-drift-report.md
            fi
          fi

          # Check package.json engines
          if [ -f "package.json" ]; then
            ENGINE_NODE=$(jq -r '.engines.node // empty' package.json)
            echo "- ℹ️ **package.json engines.node:** $ENGINE_NODE (range, not pinned)" >> version-drift-report.md
          fi

          # Check nested .nvmrc files
          echo "" >> version-drift-report.md
          echo "### Nested .nvmrc Files" >> version-drift-report.md
          echo "" >> version-drift-report.md

          while IFS= read -r nvmrc; do
            if [ "$nvmrc" != ".nvmrc" ]; then
              NESTED_VERSION=$(cat "$nvmrc" | tr -d 'v' | tr -d '\n')
              # Allow major version matching (e.g., "20" matches "20.19.0")
              CANONICAL_MAJOR=$(echo "$CANONICAL_NODE" | cut -d. -f1)
              NESTED_MAJOR=$(echo "$NESTED_VERSION" | cut -d. -f1)

              if [ "$NESTED_MAJOR" != "$CANONICAL_MAJOR" ]; then
                echo "- ❌ **$nvmrc:** $NESTED_VERSION (expected major: $CANONICAL_MAJOR)" >> version-drift-report.md
                DRIFT_FOUND=true
              else
                echo "- ✅ **$nvmrc:** $NESTED_VERSION" >> version-drift-report.md
              fi
            fi
          done < <(find . -name '.nvmrc' -not -path './node_modules/*' -not -path './.git/*')

          echo "drift_found=$DRIFT_FOUND" >> $GITHUB_OUTPUT

      - name: Check pnpm Version Consistency
        run: |
          echo "" >> version-drift-report.md
          echo "## pnpm Version Check" >> version-drift-report.md
          echo "" >> version-drift-report.md

          # Expected version from package.json packageManager
          CANONICAL_PNPM=$(jq -r '.packageManager // empty' package.json | sed 's/pnpm@//')
          echo "**Canonical version (package.json):** $CANONICAL_PNPM" >> version-drift-report.md
          echo "" >> version-drift-report.md

          # Check .tool-versions
          if [ -f ".tool-versions" ]; then
            TOOL_PNPM=$(grep "^pnpm" .tool-versions | awk '{print $2}' | tr -d '\n')
            if [ -n "$TOOL_PNPM" ] && [ "$TOOL_PNPM" != "$CANONICAL_PNPM" ]; then
              echo "- ❌ **.tool-versions (pnpm):** $TOOL_PNPM (expected: $CANONICAL_PNPM)" >> version-drift-report.md
            else
              echo "- ✅ **.tool-versions (pnpm):** $TOOL_PNPM" >> version-drift-report.md
            fi
          fi

      - name: Summary
        run: |
          echo "" >> version-drift-report.md
          echo "---" >> version-drift-report.md
          echo "" >> version-drift-report.md
          echo "## Remediation" >> version-drift-report.md
          echo "" >> version-drift-report.md
          echo "To fix version drift, update all version files to match the canonical sources:" >> version-drift-report.md
          echo "" >> version-drift-report.md
          echo "- **Node.js:** \`.nvmrc\` is the source of truth" >> version-drift-report.md
          echo "- **pnpm:** \`package.json packageManager\` field is the source of truth" >> version-drift-report.md
          echo "" >> version-drift-report.md
          echo "\`\`\`bash" >> version-drift-report.md
          echo "# Sync all version files" >> version-drift-report.md
          echo "NODE_VERSION=\$(cat .nvmrc)" >> version-drift-report.md
          echo "echo \"\$NODE_VERSION\" > .node-version" >> version-drift-report.md
          echo "sed -i \"s/^nodejs.*/nodejs \$NODE_VERSION/\" .tool-versions" >> version-drift-report.md
          echo "\`\`\`" >> version-drift-report.md

          cat version-drift-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Drift Report
        uses: actions/upload-artifact@v4
        with:
          name: version-drift-report
          path: version-drift-report.md
          retention-days: 30

      - name: Fail on Drift
        if: steps.node-check.outputs.drift_found == 'true'
        run: |
          echo "::error::Version drift detected! See report for details."
          exit 1
