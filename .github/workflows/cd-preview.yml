name: CD Preview Environments

on:
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    environment:
      name: preview-${{ github.event.pull_request.number }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@c9ef52556095b32f140b0c7d74474f53696d9000

      - name: Login to GHCR
        uses: docker/login-action@184bdaa
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and deploy preview environment
        id: deploy
        run: |
          # Generate a unique name for the environment
          ENV_NAME="preview-${{ github.event.pull_request.number }}"
          COMPOSE_PROJECT_NAME="$ENV_NAME"

          # Create a temporary directory for the compose file
          mkdir -p /tmp/$ENV_NAME
          cp docker-compose.dev.yml /tmp/$ENV_NAME/docker-compose.yml

          cat > /tmp/$ENV_NAME/docker-compose.resources.yml <<'EOF'
          version: '3.9'
          services:
            api:
              deploy:
                resources:
                  limits:
                    cpus: '1.0'
                    memory: 1g
                  reservations:
                    cpus: '0.25'
                    memory: 256m
            web:
              deploy:
                resources:
                  limits:
                    cpus: '0.5'
                    memory: 768m
                  reservations:
                    cpus: '0.2'
                    memory: 256m
            postgres:
              deploy:
                resources:
                  limits:
                    cpus: '0.5'
                    memory: 1g
                  reservations:
                    cpus: '0.2'
                    memory: 256m
            redis:
              deploy:
                resources:
                  limits:
                    cpus: '0.25'
                    memory: 512m
                  reservations:
                    cpus: '0.1'
                    memory: 128m
          EOF

          # Bring up services
          docker compose --compatibility -f /tmp/$ENV_NAME/docker-compose.yml -f /tmp/$ENV_NAME/docker-compose.resources.yml up -d --build --remove-orphans

          # Wait for server to be healthy
          SERVER_URL="http://localhost:4000"
          for i in {1..60}; do
            curl -fsS $SERVER_URL/health && break
            sleep 5
          done

          # Seed database (assuming seed script exists and can be run against the container)
          docker compose -f /tmp/$ENV_NAME/docker-compose.yml exec server npm run db:seed

          # Output URL (placeholder, actual URL depends on networking setup)
          echo "url=http://localhost:3000" >> $GITHUB_OUTPUT # Client URL

      - name: Comment PR with URL
        uses: actions/github-script@60a0d83
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview environment deployed! Access it here: ${{ steps.deploy.outputs.url }}`
            });

  teardown-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@c9ef52556095b32f140b0c7d74474f53696d9000

      - name: Teardown preview environment
        run: |
          ENV_NAME="preview-${{ github.event.pull_request.number }}"
          COMPOSE_PROJECT_NAME="$ENV_NAME"

          # Go to the temporary directory where the compose file was created
          cd /tmp/$ENV_NAME || true # Use || true to prevent failure if dir doesn't exist
          docker compose -f docker-compose.yml down -v
