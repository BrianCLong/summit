name: CI/CD Security Gate - SBOM & Vulnerability Scan
on:
  pull_request:
    branches: [ main, release-* ]
  push:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  sbom-vulnerability-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version

      - name: Install grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version

      - name: Install trivy
        uses: aquasecurity/trivy-action/install-trivy@master

      - name: Generate SBOM
        run: |
          mkdir -p sbom-output
          syft packages dir:. \
            --output cyclonedx-json=sbom-output/sbom.cyclonedx.json \
            --output spdx-json=sbom-output/sbom.spdx.json

      - name: Scan for vulnerabilities with Grype
        run: |
          grype dir:. \
            --fail-on medium \
            --output json \
            --file sbom-output/vulnerabilities.grype.json

      - name: Scan for vulnerabilities with Trivy
        run: |
          trivy fs . \
            --format json \
            --output sbom-output/vulnerabilities.trivy.json \
            --severity HIGH,CRITICAL

      - name: Analyze vulnerability results
        run: |
          # Count critical and high vulnerabilities
          CRITICAL_COUNT=$(jq -r '[.matches[]? | select(.vulnerability.severity == "Critical")] | length' sbom-output/vulnerabilities.grype.json)
          HIGH_COUNT=$(jq -r '[.matches[]? | select(.vulnerability.severity == "High")] | length' sbom-output/vulnerabilities.grype.json)
          
          echo "Critical vulnerabilities found: $CRITICAL_COUNT"
          echo "High vulnerabilities found: $HIGH_COUNT"
          
          if [[ $CRITICAL_COUNT -gt 0 ]] || [[ $HIGH_COUNT -gt 5 ]]; then
            echo "Vulnerability threshold exceeded. Failing build."
            exit 1
          else
            echo "Vulnerability check passed."
          fi

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-vulnerability-results
          path: sbom-output/
          retention-days: 90

      - name: Upload to Dependency Track
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ -n "${DEPENDENCY_TRACK_URL:-}" ] && [ -n "${DEPENDENCY_TRACK_API_KEY:-}" ]; then
            # Upload SBOM to Dependency Track for continuous monitoring
            curl -X "POST" "${DEPENDENCY_TRACK_URL}/api/v1/bom" \
              -H "Content-Type: multipart/form-data" \
              -H "X-API-Key: ${DEPENDENCY_TRACK_API_KEY}" \
              -F "project=@sbom-output/sbom.cyclonedx.json;type=application/json" \
              -F "autoCreate=true"
          fi
        env:
          DEPENDENCY_TRACK_URL: ${{ secrets.DEPENDENCY_TRACK_URL }}
          DEPENDENCY_TRACK_API_KEY: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}