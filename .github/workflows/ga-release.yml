name: GA Release

on:
  push:
    tags:
      - 'ga/v*'

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10195b02b81eb88bd40881fffc95b # v3.7.0

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea784236b2b76e330d4058d7913d12 # v5.3.0
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install build

      - name: Build Artifacts
        run: |
          python -m build --wheel --outdir dist/

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@f325610c9f50a54015d37c8d16cb3b0e2c8f4de0 # v0.18.0
        with:
          path: ./dist
          artifact-name: sbom.json
          output-file: dist/sbom.json
          format: cyclonedx-json

      - name: Sign and Attest Artifacts
        run: |
          for artifact in dist/*.whl; do
            echo "Signing $artifact..."
            cosign sign-blob --yes \
              --output-signature "${artifact}.sig" \
              --output-certificate "${artifact}.cert" \
              "$artifact"

            echo "Attesting SBOM for $artifact..."
            cosign attest-blob --yes \
              --predicate dist/sbom.json \
              --type cyclonedx \
              --output-attestation "${artifact}.att" \
              "$artifact"
          done

      - name: Prepare Evidence Bundle
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          EVIDENCE_DIR=".evidence/releases/$TAG"
          mkdir -p "$EVIDENCE_DIR"

          # Copy artifacts and signatures to evidence dir
          cp dist/* "$EVIDENCE_DIR/"

          # Generate Checksums
          cd dist
          sha256sum * > ../"$EVIDENCE_DIR/SHA256SUMS"
          cd ..

          # Metadata
          echo "Commit: $GITHUB_SHA" > "$EVIDENCE_DIR/metadata.txt"
          echo "Tag: $TAG" >> "$EVIDENCE_DIR/metadata.txt"
          echo "Timestamp: $(date -u)" >> "$EVIDENCE_DIR/metadata.txt"
          echo "Runner: $RUNNER_OS" >> "$EVIDENCE_DIR/metadata.txt"

          # Create Archive
          tar -czf evidence-bundle.tar.gz -C .evidence/releases/$TAG .

          # Create concise EVIDENCE.md
          echo "# Release Evidence for $TAG" > EVIDENCE.md
          echo "" >> EVIDENCE.md
          echo "## Artifacts" >> EVIDENCE.md
          echo "\`\`\`" >> EVIDENCE.md
          cat "$EVIDENCE_DIR/SHA256SUMS" >> EVIDENCE.md
          echo "\`\`\`" >> EVIDENCE.md
          echo "" >> EVIDENCE.md
          echo "## Verification" >> EVIDENCE.md
          echo "Verify using cosign:" >> EVIDENCE.md
          echo "\`\`\`bash" >> EVIDENCE.md
          echo "cosign verify-blob --certificate <artifact>.cert --signature <artifact>.sig <artifact>" >> EVIDENCE.md
          echo "\`\`\`" >> EVIDENCE.md

      - name: Create Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.0.1
        with:
          files: |
            dist/*.whl
            dist/*.json
            dist/*.sig
            dist/*.cert
            dist/*.att
            evidence-bundle.tar.gz
            EVIDENCE.md
          body_path: EVIDENCE.md
          draft: false
          prerelease: false
