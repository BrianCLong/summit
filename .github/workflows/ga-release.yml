name: GA Release

on:
  push:
    tags:
      - 'ga/v*'

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install -w

      - name: Build Release Artifacts
        id: build
        run: pnpm build:release

      - name: Verify Reproducibility
        id: verify
        run: pnpm verify:reproducible

      - name: Prepare Release Bundle
        run: |
          tar -czf release-artifacts.tar.gz -C dist/release .

      - name: Create Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.0.1
        with:
          files: |
            dist/release/manifest.json
            release-artifacts.tar.gz
          body: "GA release artifacts are attached. The manifest.json contains the hashes and metadata for all artifacts."
          draft: false
          prerelease: false
