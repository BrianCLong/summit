name: GA Release

on:
  push:
    tags:
      - 'ga/v*'

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10195b02b81eb88bd40881fffc95b # v3.7.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Server
        run: |
          cd server
          pnpm build
          cd ..

      - name: Build Client
        run: |
          cd client
          pnpm build
          cd ..

      - name: Build Web App
        run: |
          cd apps/web
          pnpm build
          cd ../..

      - name: Run SOC Verification Tests
        run: |
          mkdir -p .evidence
          npx tsx test/verification/soc_controls.test.ts > .evidence/soc_results.txt 2>&1
          cat .evidence/soc_results.txt

      - name: Package Artifacts
        run: |
          mkdir -p release-artifacts/server
          mkdir -p release-artifacts/client
          mkdir -p release-artifacts/web

          # Copy artifacts (adjust paths based on actual build output)
          # Assuming server outputs to dist/ or similar. Inspecting package.json suggests 'dist/src/index.js' as main.
          cp -r server/dist/* release-artifacts/server/ || echo "No server dist found"
          cp server/package.json release-artifacts/server/

          # Client
          cp -r client/dist/* release-artifacts/client/ || echo "No client dist found"

          # Web
          cp -r apps/web/dist/* release-artifacts/web/ || echo "No web dist found"

          # Create a single archive for the release
          tar -czf release-artifacts/intelgraph-platform.tar.gz -C release-artifacts server client web

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@f325610c9f50a54015d37c8d16cb3b0e2c8f4de0 # v0.18.0
        with:
          path: ./release-artifacts
          artifact-name: sbom.json
          output-file: release-artifacts/sbom.json
          format: cyclonedx-json

      - name: Sign and Attest Artifacts
        run: |
          # Sign the main tarball
          ARTIFACT="release-artifacts/intelgraph-platform.tar.gz"

          echo "Signing $ARTIFACT..."
          cosign sign-blob --yes \
            --output-signature "${ARTIFACT}.sig" \
            --output-certificate "${ARTIFACT}.cert" \
            "$ARTIFACT"

          echo "Attesting SBOM for $ARTIFACT..."
          cosign attest-blob --yes \
            --predicate release-artifacts/sbom.json \
            --type cyclonedx \
            --output-attestation "${ARTIFACT}.att" \
            "$ARTIFACT"

      - name: Prepare Evidence Bundle
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          EVIDENCE_DIR=".evidence/releases/$TAG"
          mkdir -p "$EVIDENCE_DIR"

          # Copy artifacts and signatures to evidence dir
          cp release-artifacts/intelgraph-platform.tar.gz "$EVIDENCE_DIR/"
          cp release-artifacts/*.sig "$EVIDENCE_DIR/"
          cp release-artifacts/*.cert "$EVIDENCE_DIR/"
          cp release-artifacts/*.att "$EVIDENCE_DIR/"
          cp release-artifacts/sbom.json "$EVIDENCE_DIR/"

          # Copy SOC test results
          cp .evidence/soc_results.txt "$EVIDENCE_DIR/SOC_VERIFICATION.txt"

          # Copy SOC Mapping
          cp docs/compliance/SOC_MAPPING.md "$EVIDENCE_DIR/"

          # Generate Checksums
          cd .evidence/releases/$TAG
          sha256sum * > SHA256SUMS
          cd ../../..

          # Metadata
          echo "Commit: $GITHUB_SHA" > "$EVIDENCE_DIR/metadata.txt"
          echo "Tag: $TAG" >> "$EVIDENCE_DIR/metadata.txt"
          echo "Timestamp: $(date -u)" >> "$EVIDENCE_DIR/metadata.txt"
          echo "Runner: $RUNNER_OS" >> "$EVIDENCE_DIR/metadata.txt"

          # Create Archive
          tar -czf evidence-bundle.tar.gz -C .evidence/releases/$TAG .

          # Create concise EVIDENCE.md
          echo "# Release Evidence for $TAG" > EVIDENCE.md
          echo "" >> EVIDENCE.md
          echo "## Compliance" >> EVIDENCE.md
          echo "- SOC 2 Controls Verified: YES (See SOC_VERIFICATION.txt)" >> EVIDENCE.md
          echo "- SBOM Generated: YES" >> EVIDENCE.md
          echo "- Artifacts Signed: YES" >> EVIDENCE.md
          echo "" >> EVIDENCE.md
          echo "## Artifacts" >> EVIDENCE.md
          echo "\`\`\`" >> EVIDENCE.md
          cat "$EVIDENCE_DIR/SHA256SUMS" >> EVIDENCE.md
          echo "\`\`\`" >> EVIDENCE.md
          echo "" >> EVIDENCE.md
          echo "## Verification" >> EVIDENCE.md
          echo "Verify using cosign:" >> EVIDENCE.md
          echo "\`\`\`bash" >> EVIDENCE.md
          echo "cosign verify-blob --certificate intelgraph-platform.tar.gz.cert --signature intelgraph-platform.tar.gz.sig intelgraph-platform.tar.gz" >> EVIDENCE.md
          echo "\`\`\`" >> EVIDENCE.md

      - name: Create Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.0.1
        with:
          files: |
            release-artifacts/intelgraph-platform.tar.gz
            release-artifacts/*.sig
            release-artifacts/*.cert
            release-artifacts/*.att
            release-artifacts/sbom.json
            evidence-bundle.tar.gz
            EVIDENCE.md
          body_path: EVIDENCE.md
          draft: false
          prerelease: false
