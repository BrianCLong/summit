name: "Supply Chain Integrity"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write

concurrency:
  group: ci-supply-chain-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_prove_sign:
    name: Build, SBOM, Provenance, Sign
    runs-on: ubuntu-22.04
    env:
      CI: "true"
      NODE_ENV: "production"
      EVIDENCE_DIR: "artifacts/supply-chain/${{ github.sha }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9"

      - name: Install
        run: pnpm -w install --frozen-lockfile

      - name: Build
        run: pnpm -w build

      - name: Prepare evidence dirs
        run: |
          mkdir -p "${EVIDENCE_DIR}/sbom"
          mkdir -p "${EVIDENCE_DIR}/provenance"
          mkdir -p "${EVIDENCE_DIR}/signatures"

      - name: Install Syft (SBOM)
        uses: anchore/sbom-action/download-syft@v0
        with:
          syft-version: "v1.14.0"

      - name: Generate SBOM (SPDX JSON)
        run: |
          syft . \
            --scope all-layers \
            -o spdx-json="${EVIDENCE_DIR}/sbom/sbom.spdx.json"

      - name: Generate SBOM (CycloneDX JSON)
        run: |
          syft . \
            --scope all-layers \
            -o cyclonedx-json="${EVIDENCE_DIR}/sbom/sbom.cdx.json"

      - name: Emit provenance metadata (deterministic)
        run: |
          node scripts/supply-chain/emit-provenance-metadata.mjs \
            --out "${EVIDENCE_DIR}/provenance/metadata.json"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.1

      - name: Sign SBOMs (key-based)
        if: ${{ secrets.COSIGN_PRIVATE_KEY != '' && secrets.COSIGN_PASSWORD != '' }}
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          cosign sign-blob \
            --key env://COSIGN_PRIVATE_KEY \
            --output-signature "${EVIDENCE_DIR}/signatures/sbom.spdx.sig" \
            "${EVIDENCE_DIR}/sbom/sbom.spdx.json"
          cosign sign-blob \
            --key env://COSIGN_PRIVATE_KEY \
            --output-signature "${EVIDENCE_DIR}/signatures/sbom.cdx.sig" \
            "${EVIDENCE_DIR}/sbom/sbom.cdx.json"

      - name: Create evidence manifest (hashes)
        run: |
          node scripts/supply-chain/emit-evidence-manifest.mjs \
            --dir "${EVIDENCE_DIR}" \
            --out "${EVIDENCE_DIR}/manifest.json"

      - name: Upload evidence artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-evidence-${{ github.sha }}
          path: artifacts/supply-chain/${{ github.sha }}
          if-no-files-found: error

  policy_enforcement:
    name: OPA Policy Gate
    needs: build_prove_sign
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download evidence artifact
        uses: actions/download-artifact@v4
        with:
          name: supply-chain-evidence-${{ github.sha }}
          path: _evidence

      - name: Prepare inputs for policy evaluation
        run: |
          mkdir -p _policy_input
          node scripts/supply-chain/emit-policy-input.mjs \
            --evidenceDir "_evidence" \
            --out "_policy_input/input.json"

      - name: Run Conftest
        uses: open-policy-agent/conftest-action@v0.58.0
        with:
          policy: policy
          data: policy/data
          input: _policy_input/input.json
          namespace: summit

  verify_evidence:
    name: Verify Evidence
    needs: build_prove_sign
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download evidence artifact
        uses: actions/download-artifact@v4
        with:
          name: supply-chain-evidence-${{ github.sha }}
          path: _evidence

      - name: Install Syft (SBOM validation)
        uses: anchore/sbom-action/download-syft@v0
        with:
          syft-version: "v1.14.0"

      - name: Validate SBOM JSON parseability
        run: |
          node -e "JSON.parse(require('fs').readFileSync('_evidence/sbom/sbom.spdx.json','utf8'));"
          node -e "JSON.parse(require('fs').readFileSync('_evidence/sbom/sbom.cdx.json','utf8'));"

      - name: Recompute and verify manifest hashes
        run: |
          node scripts/supply-chain/verify-evidence-manifest.mjs \
            --dir "_evidence" \
            --manifest "_evidence/manifest.json"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.1

      - name: Verify signatures (if present)
        if: ${{ secrets.COSIGN_PUBLIC_KEY != '' }}
        run: |
          node scripts/supply-chain/verify-cosign-signatures.mjs \
            --evidenceDir "_evidence" \
            --cosignPubKey "${COSIGN_PUBLIC_KEY}"
        env:
          COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
