name: CI Signal Gate
on:
  workflow_dispatch:
  schedule: [{cron: "*/30 * * * *"}]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup gh + jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          type gh || (type brew >/dev/null 2>&1 && brew install gh) || sudo apt-get install -y gh

      - name: Auth GH (GITHUB_TOKEN)
        run: gh auth setup-git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Harvest runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ./scripts/ci/harvest_actions_signals.sh "$REPO" 100

      - name: Compute metrics
        run: |
          REPO="${{ github.repository }}"
          jq -f scripts/ci/compute_metrics.jq --arg repo "$REPO" runs_raw.json > runs_metrics.json
          echo "Computed metrics:"
          cat runs_metrics.json | jq .success_rate_pct

      - name: Diff vs prior
        run: |
          # Create a dummy "today" file for the script logic (though the script logic in the user prompt was bash + jq)
          # We'll use a simpler approach here using the jq script we saved.

          # First, try to fetch the previous artifact if possible.
          # For now, we simulate "yesterday" if it doesn't exist, or just skip diffing if no history.
          # In a real setup, we'd download the artifact from the previous run.

          # NOTE: Fetching artifacts from previous runs is tricky without extra actions.
          # We will implement a simplified version that just diffs against itself if no prior artifact found (yielding 0 diff),
          # or if the user wants strictly persistent history, we'd need to use cache or external storage.
          # For this "tight" implementation, we'll assume we might not have yesterday's data in this ephemeral runner
          # unless we download it.

          # Attempt to download the latest 'ci-signal' artifact
          mkdir -p artifacts
          gh run download -n ci-signal -D artifacts || echo "No prior artifact found"

          if [ -f artifacts/runs_metrics.json ]; then
            jq -n --argjson cur "$(cat runs_metrics.json)" --argjson prev "$(cat artifacts/runs_metrics.json)" -f scripts/ci/diff_metrics.jq > runs_diff.json
            echo "Diff computed vs previous artifact."
          else
            echo "No prior metrics found to diff against."
            echo "{}" > runs_diff.json
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enforce policy
        run: |
          ./scripts/ci/gate_check.sh runs_metrics.json .ci/policy.json runs_diff.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-signal
          path: |
            runs_raw.json
            runs_metrics.json
            runs_diff.json
            gate_status.json
