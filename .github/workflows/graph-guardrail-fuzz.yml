name: Graph Guardrail Fuzz

on:
  schedule:
    - cron: "0 7 * * *"
  pull_request:
    branches: [main]
    paths:
      - "test/fuzz/graphGuardrails/**"
      - "server/src/middleware/cypher-sandbox.ts"
      - ".github/workflows/graph-guardrail-fuzz.yml"
      - "package.json"

jobs:
  guardrail-fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      - uses: pnpm/action-setup@feaa6391d8481eb0db9d5b066fba94be3691684c # v4
        with:
          version: 9.12.3
      - uses: actions/setup-node@1d1121627393d3093b167069a74422b94a9ec3f2 # v4
        with:
          node-version: 20.14.0
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run guardrail fuzz (PR subset)
        if: github.event_name == 'pull_request'
        run: pnpm test:fuzz:graph-guardrails
        env:
          GRAPH_GUARDRAIL_FUZZ_ITERATIONS: 80
          GRAPH_GUARDRAIL_FUZZ_SEED: 8339
          GRAPH_GUARDRAIL_FUZZ_MAX_ITERATIONS: 120
      - name: Run guardrail fuzz (nightly full)
        if: github.event_name == 'schedule'
        run: pnpm test:fuzz:graph-guardrails
        env:
          GRAPH_GUARDRAIL_FUZZ_ITERATIONS: 300
          GRAPH_GUARDRAIL_FUZZ_SEED: 8339
          GRAPH_GUARDRAIL_FUZZ_MAX_ITERATIONS: 300
