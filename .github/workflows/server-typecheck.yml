name: Server TypeScript Gate

# Dedicated CI gate for server TypeScript type safety.
# Fails fast on type errors and generates deterministic reports for debugging.
#
# See docs/ops/typescript/server-typecheck-plan.md for full documentation.

on:
  pull_request:
    branches: [main]
    paths:
      - "server/**/*.ts"
      - "server/**/*.tsx"
      - "server/tsconfig*.json"
      - "scripts/ci/server_typecheck_report.mjs"
      - ".github/workflows/server-typecheck.yml"

  push:
    branches: [main]
    paths:
      - "server/**/*.ts"
      - "server/**/*.tsx"
      - "server/tsconfig*.json"

  workflow_dispatch:
    inputs:
      baseline_mode:
        description: "Enable baseline comparison mode"
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  server-typecheck:
    name: Server TypeScript Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Server TypeScript Check
        id: typecheck
        run: |
          echo "=== Running Server TypeScript Check ==="
          cd server

          # Run typecheck and capture exit code
          EXIT_CODE=0
          pnpm run typecheck 2>&1 | tee ../typecheck-output.txt || EXIT_CODE=$?

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [[ $EXIT_CODE -eq 0 ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Server TypeScript check PASSED"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "::error::Server TypeScript check FAILED with $EXIT_CODE"
          fi

      - name: Generate Deterministic Report
        if: always()
        run: |
          mkdir -p artifacts
          node scripts/ci/server_typecheck_report.mjs --output artifacts/server-typecheck-report.json

          # Display summary
          echo "=== Report Summary ==="
          cat artifacts/server-typecheck-report.json | jq '{errorCount, fileCount}'

      - name: Baseline Comparison (if enabled)
        if: inputs.baseline_mode == true && hashFiles('docs/ops/typescript/server-typecheck-baseline.json') != ''
        run: |
          echo "=== Baseline Comparison Mode ==="
          node scripts/ci/server_typecheck_report.mjs \
            --output artifacts/server-typecheck-report.json \
            --baseline docs/ops/typescript/server-typecheck-baseline.json

      - name: Upload TypeScript Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: server-typecheck-report-${{ github.run_id }}
          path: |
            artifacts/server-typecheck-report.json
            typecheck-output.txt
          retention-days: 30

      - name: Job Summary
        if: always()
        run: |
          STATUS="${{ steps.typecheck.outputs.status }}"

          if [[ "$STATUS" == "success" ]]; then
            echo "### Server TypeScript Check PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No type errors detected in server codebase." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Server TypeScript Check FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Type errors detected. See artifact \`server-typecheck-report-${{ github.run_id }}\` for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Error Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat typecheck-output.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Report: \`artifacts/server-typecheck-report.json\`_" >> $GITHUB_STEP_SUMMARY

      - name: Fail on Type Errors
        if: steps.typecheck.outputs.status == 'failure'
        run: |
          echo "::error::Server TypeScript check failed. Fix type errors before merging."
          exit 1
