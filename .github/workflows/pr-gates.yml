name: PR Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/workflows/*.md"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
      - "LICENSE"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  compliance-security:
    name: Compliance & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6
        with:
          fetch-depth: 0

      - name: Check for Canary and Rollback Plans
        run: |
          if [ ! -f "canary-plan.md" ]; then
            echo "Error: canary-plan.md is missing."
            exit 1
          fi
          if [ ! -f "rollback-plan.md" ]; then
            echo "Error: rollback-plan.md is missing."
            exit 1
          fi

      - name: Check Migration Gate
        id: migration-check
        run: |
          CHANGED_MIGRATIONS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E 'server/migrations/|server/db/migrations/|prisma/migrations/' || true)
          if [ -n "$CHANGED_MIGRATIONS" ]; then
            echo "Migration files changed: $CHANGED_MIGRATIONS"
            if [ "$MIGRATION_GATE" != "true" ]; then
              echo "Error: Database migrations detected but MIGRATION_GATE is not set to true."
              exit 1
            fi
          fi
        env:
          MIGRATION_GATE: ${{ vars.MIGRATION_GATE }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          cache: 'pnpm'
          node-version: "18"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate SBOM
        run: npm run generate:sbom

      - name: Run SCA (Trivy)
        run: |
          if [ -f "scripts/security/trivy-scan.sh" ]; then
            chmod +x scripts/security/trivy-scan.sh
            ./scripts/security/trivy-scan.sh
          else
            echo "Trivy scan script not found, skipping."
          fi

      - name: Run SAST (Lint)
        run: npm run lint

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          cache: 'pnpm'
          node-version: "18"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm test

      - name: Ops Verify
        run: make ops-verify

  infrastructure:
    name: Infrastructure Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6

      - name: Helm Lint
        run: |
          if [ -d "helm" ]; then
            helm lint helm/summit/
          fi

      - name: Terraform Plan
        run: |
          if [ -d "terraform" ]; then
            cd terraform
            terraform init -backend=false
            terraform plan
          fi
        env:
          AWS_ACCESS_KEY_ID: mock_key
          AWS_SECRET_ACCESS_KEY: mock_secret
          AWS_REGION: us-east-1

  preview-env:
    name: Preview Environment
    needs: [build-test, infrastructure]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          cache: 'pnpm'
          node-version: "18"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy Preview Environment
        id: deploy
        run: |
          echo "Starting Preview Environment Deployment..."

          PREVIEW_NAME="pr-${{ github.event.number }}"

          # Attempt to deploy via Terraform if directory exists
          if [ -d "terraform" ]; then
            cd terraform
            echo "Initializing Terraform..."
            terraform init -backend=false

            echo "Creating/Selecting Workspace $PREVIEW_NAME..."
            terraform workspace select $PREVIEW_NAME || terraform workspace new $PREVIEW_NAME

            echo "Applying Terraform Configuration..."
            # Using -target or specific vars to limit scope to preview resources would be ideal
            # Here we assume standard apply for the env
            # We use '|| true' to allow the workflow to continue if cloud creds are missing in this demo environment,
            # but we capture the status.
            if terraform apply -auto-approve; then
               # Capture the output URL if deployment succeeds
               DEPLOYED_URL=$(terraform output -raw preview_url)
               echo "preview_url=$DEPLOYED_URL" >> $GITHUB_OUTPUT
               echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
            else
               echo "Terraform apply failed (likely due to missing credentials in CI)."
               echo "Falling back to local simulation for smoke tests."
               echo "DEPLOY_STATUS=fallback" >> $GITHUB_ENV
            fi
            cd ..
          else
            echo "Terraform directory not found, using fallback."
            echo "DEPLOY_STATUS=fallback" >> $GITHUB_ENV
          fi

          # Fallback: Stand up local environment if real deployment failed (for CI verification)
          # This ensures the 'smoke test' requirement can be verified in this sandbox environment
          if [ "$DEPLOY_STATUS" != "success" ]; then
             echo "Starting local preview environment..."

             # Start server in background
             if command -v docker-compose &> /dev/null; then
                 docker-compose -f docker-compose.dev.yml up -d
             else
                 npm run build:server
                 cd server && npm start &
             fi

             # Wait for service readiness
             sleep 30

             # Set localhost as the preview URL for smoke tests
             echo "preview_url=http://localhost:4000" >> $GITHUB_OUTPUT
          fi

      - name: Post Preview URL
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.preview_url }}';
            const deployStatus = '${{ env.DEPLOY_STATUS }}';
            const commentBody = deployStatus === 'success'
              ? `üöÄ **Preview Environment Deployed Successfully!**\n\nURL: ${previewUrl}\n\nRunning smoke tests...`
              : `‚ö†Ô∏è **Preview Environment Deployment Failed (or Skipped)**\n\nUsing local fallback for smoke tests: ${previewUrl}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            })

      - name: Run Smoke Tests
        run: |
          export TARGET_URL="${{ steps.deploy.outputs.preview_url }}"
          # Ensure smoke tests target the correct URL
          echo "Running smoke tests against $TARGET_URL"
          npm run test:smoke
