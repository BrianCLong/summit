name: sbom-and-scan

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout @v4

      - name: Install Syft
        uses: anchore/syft-action @v0
        with:
          version: v1.0.0

      - name: Generate SBOMs
        run: |
          syft packages dir:apps/intelgraph-api -o spdx-json > sbom-intelgraph-api.spdx.json
          syft packages dir:apps/companyos-console -o spdx-json > sbom-console.spdx.json
          syft packages dir:apps/mc-orchestrator -o spdx-json > sbom-mc.spdx.json

      - name: Upload SBOMs
        uses: actions/upload-artifact @v4
        with:
          name: sboms
          path: |
            sbom-*.spdx.json

  scan:
    runs-on: ubuntu-latest
    needs: sbom
    steps:
      - uses: actions/download-artifact @v4
        with:
          name: sboms

      - name: Install Grype
        uses: anchore/grype-action @v0
        with:
          version: v0.79.0

      - name: Scan SBOMs
        run: |
          grype sbom:sbom-intelgraph-api.spdx.json --fail-on high || true
          grype sbom:sbom-console.spdx.json --fail-on high || true
          grype sbom:sbom-mc.spdx.json --fail-on high || true
