name: Tenant Isolation Prover

on:
  push:
    paths:
      - 'tools/tip/**'
      - 'samples/tip/**'
      - '.github/workflows/tip.yml'
      - 'requirements.in'
  pull_request:
    paths:
      - 'tools/tip/**'
      - 'samples/tip/**'
      - '.github/workflows/tip.yml'
      - 'requirements.in'

jobs:
  tip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.in
      - name: Run TIP unit tests
        run: python -m unittest tools.tip.tests.test_tip
      - name: Run TIP on reference configuration
        run: python -m tools.tip.cli --manifests samples/tip/good/manifests.yaml --policies samples/tip/good/policies.yaml
      - name: Ensure known-bad scenario is rejected
        run: |
          if python -m tools.tip.cli --manifests samples/tip/bad/manifests.yaml --policies samples/tip/bad/policies.yaml; then
            echo "expected the bad scenario to fail"
            exit 1
          fi
