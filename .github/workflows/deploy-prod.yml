name: Deploy to Production

on:
  push:
    tags:
      - 'v*'

env:
  HELM_VERSION: v3.11.1
  KUBE_NAMESPACE: summit-prod
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3

      # Generic: Support KUBECONFIG secret if present
      - name: Set Kubeconfig (Generic)
        if: ${{ secrets.KUBECONFIG != '' }}
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      # AWS Specific: Configure credentials if generic KUBECONFIG is missing
      - name: Configure AWS Credentials
        if: ${{ secrets.KUBECONFIG == '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Kubeconfig for EKS
        if: ${{ secrets.KUBECONFIG == '' }}
        run: |
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Add Helm Repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Update Helm Dependencies
        run: |
          helm dependency update helm/summit

      - name: Deploy Helm Chart
        run: |
          helm upgrade --install summit helm/summit \
            -f helm/values.prod.yaml \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            --create-namespace \
            --set server.image.tag=${{ github.ref_name }} \
            --set client.image.tag=${{ github.ref_name }}

      - name: Apply Kustomize Overlays (Ingress, etc.)
        run: |
          kubectl apply -k k8s/overlays/prod -n ${{ env.KUBE_NAMESPACE }}
