name: Deploy to Prod (Canary + Auto-rollback)
run-name: Deploy ${{ inputs.image }} to prod
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Image tag (sha) to deploy'
        required: true

concurrency: prod-deploy

env:
  NAMESPACE: prod
  RELEASE: app
  IMAGE_REPOSITORY: ghcr.io/owner/app

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'
      - name: Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG_DATA}" | base64 -d > ~/.kube/config
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_PROD_B64 }}

      - name: Migration gate
        run: bash scripts/migration-gate.sh prod

      - name: Sign and attest release image
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          IMAGE_REF=${IMAGE_REPOSITORY}:${{ inputs.image }}
          cosign sign --yes "${IMAGE_REF}"
          cat > deploy-attestation.json <<EOF
          {
            "environment": "prod",
            "release": "${{ env.RELEASE }}",
            "image": "${IMAGE_REF}",
            "trigger": "deploy-prod",
            "run_id": "${{ github.run_id }}"
          }
          EOF
          cosign attest --yes --predicate deploy-attestation.json --type intelgraph.deployment "${IMAGE_REF}"

      - name: Canary 10%
        run: |
          helm upgrade --install $RELEASE charts/app \
            --namespace $NAMESPACE \
            -f charts/app/values.prod.yaml \
            --set image.tag=${{ inputs.image }} \
            --set canary.enabled=true --set canary.replicas=1

      - name: Wait for rollout
        run: kubectl -n $NAMESPACE rollout status deploy/$RELEASE --timeout=10m

      - name: Wait for SLO healthy (10m)
        run: bash scripts/wait-for-slo-healthy.sh $NAMESPACE $RELEASE 600

      - name: Promote to 100%
        run: |
          helm upgrade $RELEASE charts/app \
            --namespace $NAMESPACE \
            -f charts/app/values.prod.yaml \
            --set image.tag=${{ inputs.image }} \
            --set canary.enabled=false

      - name: Post-deploy smoke
        run: bash scripts/smoke-deploy.sh https://example.com

      - name: Tag release
        run: |
          git tag -a release/${{ inputs.image }} -m "prod deploy ${{ inputs.image }}"
          git push origin --tags
