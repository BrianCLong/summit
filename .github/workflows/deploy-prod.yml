name: Deploy to Prod (Canary + Auto-rollback)
run-name: Deploy ${{ inputs.image }} to prod
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Image tag (sha) to deploy'
        required: true

concurrency: prod-deploy

env:
  NAMESPACE: prod
  RELEASE: summit

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG_DATA}" | base64 -d > ~/.kube/config
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_PROD_B64 }}

      - name: Migration gate
        run: bash scripts/migration-gate.sh prod

      - name: Canary 10%
        run: |
          helm upgrade --install $RELEASE charts/summit \
            --namespace $NAMESPACE \
            -f charts/summit/values.prod.yaml \
            --set image.tag=${{ inputs.image }} \
            --set canary.enabled=true --set canary.replicas=1

      - name: Wait for rollout
        run: kubectl -n $NAMESPACE rollout status deploy/$RELEASE --timeout=10m

      - name: Wait for SLO healthy (10m)
        run: bash scripts/wait-for-slo-healthy.sh $NAMESPACE $RELEASE 600

      - name: Promote to 100%
        run: |
          helm upgrade $RELEASE charts/summit \
            --namespace $NAMESPACE \
            -f charts/summit/values.prod.yaml \
            --set image.tag=${{ inputs.image }} \
            --set canary.enabled=false

      - name: Post-deploy smoke
        run: bash scripts/smoke.sh https://summit.example.com

      - name: Tag release
        run: |
          git tag -a release/${{ inputs.image }} -m "prod deploy ${{ inputs.image }}"
          git push origin --tags
