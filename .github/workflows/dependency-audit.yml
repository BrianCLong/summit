name: Dependency Security Audit

# AUTOMATED DEPENDENCY VULNERABILITY SCANNING
# Runs pnpm audit to detect security vulnerabilities in dependencies.
#
# See docs/ci/DEPENDENCY_AUDIT.md for full documentation.

on:
  # Scheduled daily scan
  schedule:
    - cron: "0 6 * * *" # 6 AM UTC daily

  # On PRs to main
  pull_request:
    branches: [main]
    paths:
      - "package.json"
      - "pnpm-lock.yaml"
      - "**/package.json"

  # On push to main
  push:
    branches: [main]
    paths:
      - "package.json"
      - "pnpm-lock.yaml"
      - "**/package.json"

  # Manual trigger
  workflow_dispatch:
    inputs:
      threshold:
        description: "Fail threshold (critical, high, moderate, low)"
        type: choice
        options:
          - critical
          - high
          - moderate
          - low
        default: "high"
      production_only:
        description: "Audit production dependencies only"
        type: boolean
        default: false
      fix:
        description: "Attempt automatic fixes (creates PR)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    outputs:
      critical: ${{ steps.audit.outputs.critical }}
      high: ${{ steps.audit.outputs.high }}
      moderate: ${{ steps.audit.outputs.moderate }}
      low: ${{ steps.audit.outputs.low }}
      failed: ${{ steps.audit.outputs.failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

        with:
          version: 9.12.0
      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Security Audit
        id: audit
        continue-on-error: true
        run: |
          chmod +x scripts/release/dependency_audit.sh

          THRESHOLD="${{ inputs.threshold || 'high' }}"
          ARGS="--threshold $THRESHOLD --report"

          if [[ "${{ inputs.production_only }}" == "true" ]]; then
            ARGS="$ARGS --production"
          fi

          # Run audit and capture exit code
          EXIT_CODE=0
          ./scripts/release/dependency_audit.sh $ARGS || EXIT_CODE=$?

          # Parse results from state file
          if [[ -f docs/releases/_state/audit_state.json ]]; then
            CRITICAL=$(jq -r '.last_result.critical // 0' docs/releases/_state/audit_state.json)
            HIGH=$(jq -r '.last_result.high // 0' docs/releases/_state/audit_state.json)
            MODERATE=$(jq -r '.last_result.moderate // 0' docs/releases/_state/audit_state.json)
            LOW=$(jq -r '.last_result.low // 0' docs/releases/_state/audit_state.json)
            FAILED=$(jq -r '.last_result.failed // false' docs/releases/_state/audit_state.json)
          else
            CRITICAL=0
            HIGH=0
            MODERATE=0
            LOW=0
            FAILED=false
          fi

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: security-audit-${{ github.run_id }}
          path: artifacts/security-audit/
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const critical = ${{ steps.audit.outputs.critical || 0 }};
            const high = ${{ steps.audit.outputs.high || 0 }};
            const moderate = ${{ steps.audit.outputs.moderate || 0 }};
            const low = ${{ steps.audit.outputs.low || 0 }};
            const failed = ${{ steps.audit.outputs.failed || false }};
            const total = critical + high + moderate + low;

            let statusEmoji = '‚úÖ';
            let statusText = 'PASSED';
            if (failed) {
              statusEmoji = '‚ùå';
              statusText = 'FAILED';
            } else if (moderate > 0 || low > 0) {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'WARNING';
            }

            const body = `## ${statusEmoji} Dependency Security Audit ${statusText}

            | Severity | Count |
            |----------|-------|
            | üî¥ Critical | ${critical} |
            | üü† High | ${high} |
            | üü° Moderate | ${moderate} |
            | üîµ Low | ${low} |
            | **Total** | **${total}** |

            ${failed ? '‚ö†Ô∏è **Action Required:** Please address high/critical vulnerabilities before merging.' : total > 0 ? '‚ÑπÔ∏è Review moderate/low vulnerabilities when convenient.' : 'üéâ No vulnerabilities detected!'}

            <details>
            <summary>Remediation Commands</summary>

            \`\`\`bash
            # Attempt automatic fixes
            pnpm audit --fix

            # Update all packages
            pnpm update
            \`\`\`

            </details>

            ---
            _Generated by [Dependency Audit](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Dependency Security Audit')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Job Summary
        if: always()
        run: |
          CRITICAL="${{ steps.audit.outputs.critical || 0 }}"
          HIGH="${{ steps.audit.outputs.high || 0 }}"
          MODERATE="${{ steps.audit.outputs.moderate || 0 }}"
          LOW="${{ steps.audit.outputs.low || 0 }}"
          FAILED="${{ steps.audit.outputs.failed || false }}"

          echo "### Dependency Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$FAILED" == "true" ]]; then
            echo "**Status:** ‚ùå FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚úÖ PASSED" >> $GITHUB_STEP_SUMMARY
          fi

  auto-fix:
    name: Auto-Fix Vulnerabilities
    runs-on: ubuntu-latest
    needs: audit
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.fix == true &&
      needs.audit.outputs.failed == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

        with:
          version: 9.12.0
      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Attempt Fixes
        run: |
          pnpm audit --fix || true
          pnpm install

      - name: Check for Changes
        id: check
        run: |
          if git diff --quiet pnpm-lock.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Fix PR
        if: steps.check.outputs.changed == 'true'
        uses:
          peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0     # v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security(deps): auto-fix vulnerabilities"
          title: "security(deps): Auto-fix dependency vulnerabilities"
          body: |
            ## Automated Security Fix

            This PR was automatically generated by the Dependency Security Audit workflow.

            ### Changes
            - Applied `pnpm audit --fix` to address known vulnerabilities

            ### Audit Results (Before Fix)
            - Critical: ${{ needs.audit.outputs.critical }}
            - High: ${{ needs.audit.outputs.high }}
            - Moderate: ${{ needs.audit.outputs.moderate }}
            - Low: ${{ needs.audit.outputs.low }}

            ### Next Steps
            1. Review the changes in `pnpm-lock.yaml`
            2. Run tests to ensure no regressions
            3. Merge if all checks pass

            ---
            _Generated by [Dependency Audit](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_
          branch: security/auto-fix-deps
          delete-branch: true
          labels: |
            security
            dependencies
            automated
