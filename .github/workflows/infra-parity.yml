name: Infra Parity Gate
on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/infra-parity.yml'

permissions:
  id-token: write
  contents: read

jobs:
  parity:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, staging, prod]
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/summit-ci-oidc
          aws-region: us-east-1

      - uses: hashicorp/setup-terraform@v3

      - name: Init
        working-directory: terraform/environments/${{ matrix.env }}
        run: terraform init -input=false

      - name: Parity Plan (fail on drift)
        working-directory: terraform/environments/${{ matrix.env }}
        run: |
          set -e
          # Exit codes: 0=no changes, 1=error, 2=changes present
          terraform plan -input=false -no-color -detailed-exitcode || code=$?

          if [ "${code:-0}" = "2" ]; then
            echo "❌ Drift/non-parity detected in ${{ matrix.env }}"; exit 2
          elif [ "${code:-0}" = "1" ]; then
            echo "❌ Plan error in ${{ matrix.env }}"; exit 1
          else
            echo "✅ ${{ matrix.env }} is at parity."
          fi
