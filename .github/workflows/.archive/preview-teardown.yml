name: Preview Teardown
on:
  pull_request:
    types: [closed]

jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - name: Login cloud
        run: |
          echo "$CLOUD_AUTH" | base64 -d > /tmp/creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json
      - name: Destroy namespace
        run: |
          kubectl delete ns pr-${{ github.event.number }} --ignore-not-found
      - name: Terraform destroy (if used)
        working-directory: infra/preview
        run: |
          # terraform init -input=false
          # terraform destroy -auto-approve -input=false -var pr=${{ github.event.number }}
          echo "Terraform destroy placeholder"

on:
  pull_request:
    types: [closed]
    paths:
      - 'server/**'
      - 'client/**'
      - 'deploy/**'
      - '.github/workflows/**'

env:
  NAMESPACE_PREFIX: intelgraph-pr

jobs:
  teardown:
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Teardown preview environment
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}"
          PR_NUMBER=${{ github.event.number }}

          echo "üóëÔ∏è tearing down preview for PR #${PR_NUMBER} in namespace ${NAMESPACE}"

          # Remove Helm release
          helm uninstall intelgraph-pr-${PR_NUMBER} --namespace ${NAMESPACE} --ignore-not-found

          # Delete namespace
          kubectl delete namespace ${NAMESPACE} --ignore-not-found --timeout=300s

      - name: Cleanup container images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üßπ Cleaning up container images for PR #${{ github.event.number }}"
          # Delete PR-specific images
          gh api --method DELETE \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.repository }}%2Fserver/versions" \
            --field "tag=pr-${{ github.event.number }}" || true

          gh api --method DELETE \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.repository }}%2Fclient/versions" \
            --field "tag=pr-${{ github.event.number }}" || true

      - name: Report Cost & Leftover Detection
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Simulation of cost calculation and leftover detection
          COST="0.00" # Placeholder: In a real env, this would query cloud provider billing API
          LEFTOVERS=$(kubectl get all -n "${{ env.NAMESPACE_PREFIX }}-${{ github.event.number }}" 2>/dev/null || echo "None")

          if [ "$LEFTOVERS" != "None" ] && [ "$LEFTOVERS" != "" ]; then
             LEFTOVER_STATUS="‚ö†Ô∏è Some resources may remain manually."
          else
             LEFTOVER_STATUS="‚úÖ All resources cleaned up."
          fi

          echo "üí∞ Estimated Cost: $${COST}"
          echo "${LEFTOVER_STATUS}"

          gh pr comment ${{ github.event.number }} --body "üßπ **Preview Teardown Complete**<br/>üí∞ Estimated Cost: $${COST}<br/>${LEFTOVER_STATUS}"

permissions:
  contents: read
  pull-requests: write

jobs:
  destroy:
    name: destroy
    runs-on: ubuntu-latest
    steps:
      - name: Set up Terraform
        if: (hashFiles('infra/preview/*.tf') != '') && (env.CLOUD_AUTH != '')
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Login cloud
        env:
          CLOUD_AUTH: ${{ secrets.CLOUD_AUTH }}
        run: |
          echo "$CLOUD_AUTH" | base64 -d > /tmp/creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json
          echo "Cloud credentials configured for teardown"

      - name: Destroy namespace
        run: |
          if command -v kubectl >/dev/null 2>&1; then
            kubectl delete ns pr-${{ github.event.number }} --ignore-not-found
          else
            echo "kubectl not available; skipping cluster namespace deletion"
          fi

      - name: Terraform destroy (if used)
        run: |
          if [ -d infra/preview ]; then
            terraform -chdir=infra/preview init -input=false -backend=false
            terraform -chdir=infra/preview destroy -auto-approve -input=false -var pr=${{ github.event.number }}
          else
            echo "No infra/preview directory found; skipping terraform destroy"
          fi

      - name: Post cost + drift summary
        uses: actions/github-script@v7
        with:
          script: |
            core.summary.addHeading('Preview Teardown')
            core.summary.addRaw('Destroyed pr-${{github.event.number}}')
            await core.summary.write()
            core.summary.addRaw(`Destroyed pr-${{github.event.number}} or confirmed no resources`)
            await core.summary.write()
