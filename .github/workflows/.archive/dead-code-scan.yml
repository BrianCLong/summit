name: Dead Code Scan

on:
  schedule:
    - cron: "0 7 * * 1"
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Run PR generator in dry-run mode"
        required: false
        default: true
        type: boolean

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'pnpm'
          node-version: "20.x"

      - name: Enable corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run dead-code analyzer
        run: pnpm exec ts-node --project tsconfig.json --esm scripts/cleanup/find-dead-code.ts

      - name: Upload dead-code report
        uses: actions/upload-artifact@v4
        with:
          name: dead-code-report
          path: reports/dead-code-report.json

      - name: Generate cleanup PR (dry run)
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.dry-run != false }}
        env:
          DEAD_CODE_BRANCH: feature/dead-code-detector-pr-bot-01
        run: pnpm exec ts-node --project tsconfig.json --esm scripts/cleanup/create-dead-code-pr.ts

      - name: Generate cleanup PR (execute)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.dry-run == false }}
        env:
          DEAD_CODE_BRANCH: feature/dead-code-detector-pr-bot-01
        run: pnpm exec ts-node --project tsconfig.json --esm scripts/cleanup/create-dead-code-pr.ts --execute
