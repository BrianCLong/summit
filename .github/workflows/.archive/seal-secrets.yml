name: seal-secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to reseal"
        required: true
        default: dev
      actor:
        description: "Who initiated the reseal"
        required: true
        default: github-actions
  push:
    paths:
      - "secrets/envs/**"
      - ".sops.yaml"
      - ".ci/scripts/secrets/**"

jobs:
  reseal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: write
      pull-requests: write
    env:
      AGE_ORG_PUBLIC_KEY: ${{ secrets.AGE_ORG_PUBLIC_KEY }}
      AGE_ORG_PRIVATE_KEY: ${{ secrets.AGE_ORG_PRIVATE_KEY }}
      KUBESEAL_CERT: ${{ secrets.KUBESEAL_CERT }}
      RESEAL_ENV: ${{ github.event.inputs.environment || 'dev' }}
      ACTOR_NAME: ${{ github.event.inputs.actor || github.actor }}
    steps:
      - uses: actions/checkout@v4
      - name: Install sealing tools
        run: sudo apt-get update && sudo apt-get install -y sops kubeseal jq yq
      - name: Run seal script
        run: |
          chmod +x .ci/scripts/secrets/seal.sh
          .ci/scripts/secrets/seal.sh "$RESEAL_ENV" "$ACTOR_NAME"
      - name: Upload audit log
        uses: actions/upload-artifact@v4
        with:
          name: secrets-audit-${{ github.run_id }}
          path: /tmp/secrets-audit.json
