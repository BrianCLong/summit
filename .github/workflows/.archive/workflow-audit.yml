name: Workflow Audit & Analysis

# Part of #14512 - Workflow Rationalization & Optimization
# Automatically generates and updates workflow inventory report

on:
  workflow_dispatch:  # Manual trigger for on-demand analysis
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  push:
    paths:
      - '.github/workflows/**'
      - 'scripts/workflow-audit.sh'

permissions:
  contents: write
  pull-requests: write

jobs:
  audit-workflows:
    runs-on: ubuntu-latest
    name: ðŸ” Audit Workflows
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq yq
          chmod +x scripts/workflow-audit.sh
      
      - name: Run workflow audit
        id: audit
        run: |
          echo "::group::Running workflow audit"
          bash scripts/workflow-audit.sh
          echo "::endgroup::"
          
          # Capture summary stats
          total=$(find .github/workflows -name '*.yml' -o -name '*.yaml' | wc -l)
          echo "total_workflows=$total" >> $GITHUB_OUTPUT
          
          # Check if report was generated
          if [ -f docs/workflows/workflow-inventory.md ]; then
            echo "report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Generate workflow metrics
        run: |
          echo "::group::Extracting workflow metrics"
          
          # Count workflows by category
          for category in CI Build Release Security Operations Orchestration Reusable Other; do
            count=$(grep -c "| $category |" docs/workflows/workflow-inventory.md || echo "0")
            echo "${category}: ${count} workflows"
          done
          
          echo "::endgroup::"
      
      - name: Check for changes
        id: changes
        run: |
          git diff --exit-code docs/workflows/workflow-inventory.md > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in workflow inventory"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected - will create PR"
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs(workflows): Update workflow inventory report
            
            Part of #14512 - Workflow Rationalization & Optimization
            
            Auto-generated workflow audit found ${{ steps.audit.outputs.total_workflows }} workflows.
            Review the report at docs/workflows/workflow-inventory.md for optimization opportunities.
          branch: workflow-audit/inventory-update
          delete-branch: true
          title: 'ðŸ“Š Workflow Inventory Update - ${{ steps.audit.outputs.total_workflows }} workflows'
          body: |
            ## Automated Workflow Audit Report
            
            Part of #14512 - Workflow Rationalization & Optimization
            
            ### Summary
            - **Total workflows**: ${{ steps.audit.outputs.total_workflows }}
            - **Report location**: `docs/workflows/workflow-inventory.md`
            - **Triggered by**: ${{ github.event_name }}
            
            ### What Changed
            This PR updates the workflow inventory report with the latest analysis of all GitHub Actions workflows.
            
            ### Next Steps
            1. Review the report for consolidation opportunities
            2. Identify workflows that can be:
               - Merged using matrix strategies
               - Converted to reusable workflows
               - Optimized with caching and path filters
            3. Proceed with Phase 2 rationalization from #14512
            
            ---
            ðŸ¤– *This PR was automatically generated by the workflow audit system*
          labels: |
            CI/CD
            area:devops/ci
            documentation
            automated
      
      - name: Upload inventory report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-inventory-report
          path: docs/workflows/workflow-inventory.md
          retention-days: 90
      
      - name: Post summary
        if: always()
        run: |
          echo "## ðŸ“Š Workflow Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total workflows analyzed**: ${{ steps.audit.outputs.total_workflows }}" >> $GITHUB_STEP_SUMMARY
          echo "**Report generated**: ${{ steps.audit.outputs.report_generated }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes detected**: ${{ steps.changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View full report: [workflow-inventory.md](../docs/workflows/workflow-inventory.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Part of [#14512](https://github.com/BrianCLong/summit/issues/14512) - Workflow Rationalization & Optimization" >> $GITHUB_STEP_SUMMARY
