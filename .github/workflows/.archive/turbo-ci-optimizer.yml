name: ⚡ Turbo CI Optimizer - Advanced Performance

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  optimize:
    name: CI/CD Performance Optimization
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cancel redundant runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== CANCELING REDUNDANT WORKFLOW RUNS ==="

          # Cancel duplicate/stale runs to free up capacity
          gh run list --status queued --limit 100 --json databaseId,name,createdAt \
            --jq '.[] | select(.createdAt < (now - 1800 | todate)) | .databaseId' | \
          while read run_id; do
            echo "Canceling stale run: $run_id"
            gh run cancel "$run_id" 2>/dev/null || true
          done

      - name: Optimize PR queue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== PR QUEUE OPTIMIZATION ==="

          # Close PRs that are very old and have never passed checks
          gh pr list --limit 500 --search "is:open created:<2024-01-01" \
            --json number,title,statusCheckRollup | \
            jq -r '.[] | select(.statusCheckRollup | length == 0) | .number' | \
          while read pr_num; do
            echo "Marking very old PR #$pr_num for review..."
            gh pr edit "$pr_num" --add-label "needs-review,ancient" 2>/dev/null || true
          done

      - name: Priority boost
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== PRIORITY BOOSTING ==="

          # Add priority label to small, ready PRs
          gh pr list --limit 200 --search "is:open status:success" \
            --json number,additions,deletions | \
            jq -r '.[] | select((.additions + .deletions) < 100) | .number' | \
          while read pr_num; do
            gh pr edit "$pr_num" --add-label "priority,quick-merge" 2>/dev/null || true
          done

      - name: Auto-approve dependabot
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== AUTO-APPROVE DEPENDABOT ==="

          # Auto-approve and merge dependabot PRs
          gh pr list --author "app/dependabot" --limit 100 \
            --search "is:open status:success" --json number | \
            jq -r '.[].number' | \
          while read pr_num; do
            echo "Auto-approving dependabot PR #$pr_num"
            gh pr review "$pr_num" --approve --body "✅ Auto-approved by Turbo CI Optimizer" 2>/dev/null || true
            gh pr merge "$pr_num" --squash --auto 2>/dev/null || true
            sleep 2
          done

      - name: Generate optimization report
        run: |
          echo "=== TURBO CI OPTIMIZATION COMPLETE ==="
          echo "Timestamp: $(date -u)"
          echo "System optimized for maximum throughput"
