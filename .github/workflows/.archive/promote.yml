name: promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to promote"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  deployments: write
  id-token: write
  packages: read

env:
  REGISTRY: ghcr.io

jobs:
  guard-and-promote:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cosign and conftest
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          COSIGN_VERSION="v2.4.0"
          curl -sSL -o cosign.tgz "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64.tar.gz"
          tar -xzf cosign.tgz cosign && sudo mv cosign /usr/local/bin/
          curl -sSfL https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz | sudo tar -xz -C /usr/local/bin conftest

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify signatures, digests, and attestations
        id: verify-artifacts
        env:
          IMAGE_SERVER: ${{ env.REGISTRY }}/${{ github.repository }}/server:${{ inputs.version }}
          IMAGE_CLIENT: ${{ env.REGISTRY }}/${{ github.repository }}/client:${{ inputs.version }}
        run: |
          set -euo pipefail

          verify_and_pin() {
            local image="$1"
            local name="$2"

            verification=$(cosign verify --output json "$image")
            digest=$(echo "$verification" | jq -r '.[0].critical.image["docker-manifest-digest"]')

            if [ -z "$digest" ] || [ "$digest" = "null" ]; then
              echo "âŒ Unable to resolve digest after verification for $image" >&2
              exit 1
            fi

            pinned="${image%@*}@${digest}"
            echo "${name}-pinned=${pinned}" >> "$GITHUB_OUTPUT"

            cosign verify-attestation --type slsaprovenance "$pinned"
            cosign verify-attestation --type spdx "$pinned"
          }

          verify_and_pin "$IMAGE_SERVER" server
          verify_and_pin "$IMAGE_CLIENT" client

      - name: Download SBOM attestations
        env:
          IMAGE_SERVER: ${{ steps.verify-artifacts.outputs.server-pinned }}
          IMAGE_CLIENT: ${{ steps.verify-artifacts.outputs.client-pinned }}
        run: |
          set -euo pipefail
          for image in "$IMAGE_SERVER" "$IMAGE_CLIENT"; do
            target=$(echo "$image" | sed 's/[:\/]/-/g')
            cosign download attestation --predicate-type spdx "$image" > "${target}-att.json"
            cat "${target}-att.json" | jq -r '.attestations[0].payload' | base64 -d | jq -r '.predicate' > "${target}-sbom.json"
          done

      - name: Enforce SBOM policy with Conftest
        run: |
          for sbom in *sbom.json; do
            conftest test "$sbom" -p policy/sbom_policy.rego
          done

      - name: Promote rollout
        run: |
          NAMESPACE="${{ inputs.environment == 'production' && 'intelgraph-prod' || 'intelgraph-staging' }}"
          ./scripts/rollback-deployment.sh canary-promote --namespace ${NAMESPACE}

      - name: Rollback on failure
        if: failure()
        run: |
          NAMESPACE="${{ inputs.environment == 'production' && 'intelgraph-prod' || 'intelgraph-staging' }}"
          ./scripts/rollback-deployment.sh canary-abort --namespace ${NAMESPACE} || true
