name: secrets-lint

on:
  pull_request:
    paths:
      - "secrets/**"
      - ".sops.yaml"
      - ".ci/policies/**"
      - ".pre-commit-config.yaml"
      - "deploy/helm/intelgraph/secrets/**"
      - ".github/workflows/secrets-lint.yml"
  push:
    branches: [main]
    paths:
      - "secrets/**"
      - ".sops.yaml"
      - ".ci/policies/**"
      - "deploy/helm/intelgraph/secrets/**"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup tools
        uses: Homebrew/actions/install@master
        with:
          packages: sops gitleaks trivy conftest
      - name: Validate SOPS files
        run: |
          find secrets/envs -name '*.enc.yaml' -print0 | xargs -0 -I{} sh -c 'sops --verify {}'
      - name: Leak scan
        run: |
          chmod +x .ci/scripts/secrets/leak_scan.sh
          .ci/scripts/secrets/leak_scan.sh
      - name: OPA policy check
        run: |
          conftest test --policy .ci/policies --namespace secrets --all-namespaces
