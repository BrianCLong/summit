name: nightly-cve-scan
on:
  schedule:
    - cron: '0 2 * * *'

env:
  SERVICE_NAME: summit-platform
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json
      - name: Run cdxgen
        id: cdxgen
        run: |
          set +e
          npx cdxgen --fail-on "critical"
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
      - name: Emit vulnerability report
        run: |
          mkdir -p artifacts/security/${SERVICE_NAME}
          node -e "const fs=require('fs');const path=require('path');const service=process.env.SERVICE_NAME || 'summit-platform';const exitCode=Number(process.env.CDXGEN_EXIT_CODE || 0);const passed=exitCode===0;const payload={service,scanner:'cdxgen',generated_at:new Date().toISOString(),artifacts:{sbom:'sbom.json'},waiver:{present:false,applied:false},decision:{blocked:passed?0:1,passed},summary:{critical:passed?0:1}};fs.writeFileSync(\`vuln_report.${service}.json\`,JSON.stringify(payload,null,2));fs.writeFileSync(path.join('artifacts','security',service,'audit-trail.json'),JSON.stringify(payload,null,2));"
        env:
          CDXGEN_EXIT_CODE: ${{ steps.cdxgen.outputs.exit_code }}
      - name: Upload vulnerability artifacts
        if: (always()) && (steps.cdxgen.outputs.exit_code != '0')
        uses: actions/upload-artifact@v4
        with:
          name: vuln-report-${{ env.SERVICE_NAME }}
          path: |
            vuln_report.${{ env.SERVICE_NAME }}.json
            artifacts/security/${{ env.SERVICE_NAME }}/
      - name: Enforce cdxgen gate
        run: |
          echo "Critical vulnerabilities detected in nightly scan"
          exit 1
