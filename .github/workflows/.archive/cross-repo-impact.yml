name: Cross-repo impact advisory

on:
  pull_request:
    branches:
      - "*"

jobs:
  cross-repo-impact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
                  run_install: true
          install_command: pnpm install --frozen-lockfile

      - name: Run cross-repo impact analyzer
        id: analyze
        run: |
          pnpm exec ts-node scripts/architecture/analyze-cross-repo-impact.ts --base-ref=origin/${{ github.event.pull_request.base.ref }} | tee impact-report.txt

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('impact-report.txt', 'utf8');
            const heading = '### Cross-repo impact (advisory)';
            const commentBody = `${heading}\n\n${body}\n\n> Analyzer is advisory-only and does not block merges.`;
            const { owner, repo } = context.repo;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner,
              repo,
              body: commentBody,
            });
