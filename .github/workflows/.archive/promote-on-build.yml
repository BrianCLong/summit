name: promote-on-build
on:
  workflow_run:
    workflows: ["build-images"]
    types: [completed]

jobs:
  promote:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download SBOM artifacts from build run
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pattern: sbom-*
          merge-multiple: true
          path: sboms

      - name: Tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq skopeo
          COSIGN_VERSION="v2.2.4"
          curl -sSL -o cosign.tgz "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64.tar.gz"
          tar -xzf cosign.tgz cosign && sudo mv cosign /usr/local/bin/
          echo "COSIGN_EXPERIMENTAL=1" >> $GITHUB_ENV

      - name: Install Conftest
        run: |
          curl -sSL -o conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/download/v0.52.0/conftest_0.52.0_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz conftest
          sudo mv conftest /usr/local/bin/conftest

      - name: Enforce dependency policy on SBOMs
        env:
          SOURCE_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          shopt -s nullglob
          files=(sboms/*.spdx.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No SBOM artifacts found from build run ${SOURCE_RUN_ID}" >&2
            exit 1
          fi

          conftest test "${files[@]}" \
            --policy .ci/policies/deps.rego \
            --data .security/deps/policy.yaml

      - name: Fetch digests + verify
        env:
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          chmod +x scripts/fetch-digests.sh
          ./scripts/fetch-digests.sh

      - name: Update evidence placeholders
        run: |
          source ./.env.deploy
          FILE="audit/ga-core-evidence-pack.md"
          # Replace or append a block with the latest run/digests
          mkdir -p audit || true
          if [ ! -f "$FILE" ]; then touch "$FILE"; fi
          ts="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          {
            echo ""
            echo "## Image Evidence â€” build-images run ${RUN_ID} (${ts})"
            echo ""
            echo "- HEAD_REF: ${HEAD_REF}"
            echo "- HEAD_SHA: ${HEAD_SHA}"
            echo "- RUN_ID: ${RUN_ID}"
            echo "- WEB:    `${IMG_WEB}`"
            echo "- SERVER: `${IMG_SERVER}`"
            echo "- GATEWAY:`${IMG_GATEWAY}`"
          } >> "$FILE"

      - name: Commit evidence update
        run: |
          git config user.name "release-automation"
          git config user.email "release-automation@users.noreply.github.com"
          git add audit/ga-core-evidence-pack.md .env.deploy
          git commit -m "chore(evidence): attach GHCR digests from build-images run $RUN_ID" || echo "Nothing to commit"
          git push
