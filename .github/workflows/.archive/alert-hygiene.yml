name: Alert Hygiene

on:
  push:
    paths:
      - 'observability/alerts/catalog.yaml'
      - 'tools/alertsync/**'
      - '.ci/policies/alerts.rego'
  pull_request:
    paths:
      - 'observability/alerts/catalog.yaml'
      - 'tools/alertsync/**'
      - '.ci/policies/alerts.rego'

jobs:
  validate-and-generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r tools/alertsync/requirements.txt

      - name: Generate Prometheus Rules
        run: |
          python tools/alertsync/sync.py --catalog observability/alerts/catalog.yaml --output observability/alerts/generated

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: Validate Alert Catalog Policy
        run: |
          # Convert yaml to json for OPA input
          python -c 'import yaml, json, sys; print(json.dumps({"catalog": yaml.safe_load(open("observability/alerts/catalog.yaml"))}))' > input.json

          # Evaluate policy
          opa eval -i input.json -d .ci/policies/alerts.rego "data.policy.alerts.deny" --format json > result.json

          # Check for denials
          DENIALS=$(python -c 'import json; data=json.load(open("result.json")); print(len(data["result"][0]["expressions"][0]["value"]))')

          if [ "$DENIALS" -gt "0" ]; then
             echo "Policy check failed with $DENIALS violations:"
             opa eval -i input.json -d .ci/policies/alerts.rego "data.policy.alerts.deny" --format pretty
             exit 1
          fi
          echo "Policy check passed."

      - name: Check for Generated Changes
        run: |
          if [[ -n $(git status --porcelain observability/alerts/generated) ]]; then
            echo "Prometheus rules in observability/alerts/generated are out of sync with catalog."
            echo "Please run local generation script and commit changes."
            git status
            git diff
            exit 1
          fi
