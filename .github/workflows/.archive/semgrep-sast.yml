name: ðŸ” Semgrep SAST

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run Semgrep weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

# Prevent concurrent Semgrep runs
concurrency:
  group: semgrep-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  semgrep:
    name: Semgrep Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    container:
      image: semgrep/semgrep:latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Semgrep with custom config
        run: |
          semgrep scan \
            --config .semgrep.yml \
            --config auto \
            --sarif \
            --output semgrep-results.sarif \
            --verbose
        env:
          SEMGREP_RULES: auto
      
      - name: Upload Semgrep SARIF results
        if: (((always()) && (always())) && (github.event_name == 'push' || github.event_name == 'schedule')) && (always())
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
      
      - name: Upload Semgrep artifacts
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ github.sha }}
          path: semgrep-results.sarif
          retention-days: 30
  
  semgrep-supply-chain:
    name: Semgrep Supply Chain Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'
          cache: 'pnpm'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run Semgrep Supply Chain
        run: |
          npx semgrep@latest \
            --supply-chain \
            --json \
            --output semgrep-supply-chain.json
        continue-on-error: true
      
      - name: Upload supply chain results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-supply-chain-${{ github.sha }}
          path: semgrep-supply-chain.json
          retention-days: 30
  
  semgrep-summary:
    name: Semgrep Results Summary
    runs-on: ubuntu-latest
    needs: [semgrep, semgrep-supply-chain]
    
    steps:
      - name: Generate security summary
        run: |
          echo "# ðŸ” Semgrep SAST Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Analysis Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis | ${{ needs.semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Supply Chain | ${{ needs.semgrep-supply-chain.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed results, check the Security tab or download artifacts." >> $GITHUB_STEP_SUMMARY
