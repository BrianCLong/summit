name: release-ga
on:
  workflow_dispatch:
  push:
    tags: ["v*"]
jobs:
  build_sign_provenance:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - name: Install supply chain tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          COSIGN_VERSION="v2.4.0"
          curl -sSL -o cosign.tgz "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64.tar.gz"
          tar -xzf cosign.tgz cosign && sudo mv cosign /usr/local/bin/
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSfL https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz | sudo tar -xz -C /usr/local/bin conftest
      - run: npm ci && npm run build && npm test
      - name: Generate SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json
      - name: Generate SBOM (SPDX)
        run: syft dir:. -o spdx-json=sbom.spdx.json
      - name: Build container
        run: docker build -t ghcr.io/intelgraph/platform:${GITHUB_REF_NAME} .
      - name: Cosign sign & attest
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign ghcr.io/intelgraph/platform:${GITHUB_REF_NAME}
          cosign attest --predicate sbom.json --type cyclonedx ghcr.io/intelgraph/platform:${GITHUB_REF_NAME}
          cosign attest --predicate sbom.spdx.json --type spdx ghcr.io/intelgraph/platform:${GITHUB_REF_NAME}
      - name: SLSA provenance
        uses: slsa-framework/slsa-github-generator/actions/generator@v2
        with:
          artifact_path: "dist/**"
      - name: Verify signatures and attestations
        id: cosign-verify
        env:
          IMAGE: ghcr.io/intelgraph/platform:${GITHUB_REF_NAME}
        run: |
          set -euo pipefail
          verification=$(cosign verify --output json "${IMAGE}")
          digest=$(echo "${verification}" | jq -r '.[0].critical.image["docker-manifest-digest"]')

          if [ -z "${digest}" ] || [ "${digest}" = "null" ]; then
            echo "❌ Unable to resolve digest after verification for ${IMAGE}" >&2
            exit 1
          fi

          IMAGE_PINNED="${IMAGE%@*}@${digest}"
          echo "pinned=${IMAGE_PINNED}" >> "$GITHUB_OUTPUT"
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"

          cosign verify-attestation --type slsaprovenance "${IMAGE_PINNED}"
          cosign verify-attestation --type spdx "${IMAGE_PINNED}"
      - name: Enforce SBOM diff budget or exception
        env:
          SBOM_BASELINE: .github/sbom-baseline.spdx.json
          SBOM_CURRENT: sbom.spdx.json
          BUDGET_PERCENT: 5
          SBOM_DIFF_EXCEPTION: ${{ secrets.SBOM_DIFF_EXCEPTION != '' && secrets.SBOM_DIFF_EXCEPTION || 'false' }}
        run: |
          if [ ! -f "${SBOM_CURRENT}" ]; then
            echo "Current SBOM missing"; exit 1
          fi

          if [ -f "${SBOM_BASELINE}" ]; then
            baseline_packages=$(jq '.packages | length' "${SBOM_BASELINE}")
            current_packages=$(jq '.packages | length' "${SBOM_CURRENT}")
            allowed=$((baseline_packages + (baseline_packages * BUDGET_PERCENT / 100)))
            if [ "${current_packages}" -gt "${allowed}" ]; then
              echo "SBOM diff exceeds budget (${current_packages} vs ${allowed})";
              exit 1
            fi
            echo "✅ SBOM diff within ${BUDGET_PERCENT}% budget"
          else
            if [ "${SBOM_DIFF_EXCEPTION}" != "true" ]; then
              echo "SBOM baseline missing and no approved exception provided";
              exit 1
            fi
            echo "⚠️ Proceeding with approved SBOM diff exception"
          fi
      - name: Attach Rekor proof to release notes
        env:
          IMAGE_PINNED: ${{ steps.cosign-verify.outputs.pinned }}
          IMAGE_DIGEST: ${{ steps.cosign-verify.outputs.digest }}
        run: |
          TRIANGULATED=$(cosign triangulate "${IMAGE_PINNED}")
          printf "# Rekor Transparency Log\n\n" > release-notes.md
          echo "Image: ${IMAGE_PINNED}" >> release-notes.md
          echo "Digest: ${IMAGE_DIGEST}" >> release-notes.md
          echo "Rekor Entry: ${TRIANGULATED}" >> release-notes.md
          cosign verify "${IMAGE_PINNED}" --output-certificate rekor-cert.pem --output-signature rekor.sig
          echo "Certificate and signature artifacts emitted for transparency." >> release-notes.md
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
