name: üîç PR Validation
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

# Prevent concurrent validation runs on same PR
concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.11.1'
  PNPM_VERSION: '9.6.0'

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  security-events: write

jobs:
  # Quick validation for basic requirements
  validate-pr:
    name: üö¶ Basic Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_run_full_validation: ${{ steps.check.outputs.should_run_full_validation }}
      risk_level: ${{ steps.analyze.outputs.risk_level }}
      risk_tiers: ${{ steps.classify.outputs.risk_tiers }}
      risk_tier_count: ${{ steps.classify.outputs.risk_tier_count }}
      helm_changed: ${{ steps.change-detection.outputs.helm_changed }}
      database_changed: ${{ steps.change-detection.outputs.database_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR requirements
        id: check
        run: |
          # Skip validation for draft PRs unless explicitly requested
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "should_run_full_validation=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping validation for draft PR"
            exit 0
          fi

          # Always run validation for ready PRs
          echo "should_run_full_validation=true" >> $GITHUB_OUTPUT

      - name: Quick risk analysis
        id: analyze
        if: (((((((((((((((steps.check.outputs.should_run_full_validation == 'true') && (steps.check.outputs.should_run_full_validation == 'true')) && (steps.check.outputs.should_run_full_validation == 'true')) && (needs.validate-pr.outputs.should_run_full_validation == 'true')) && (needs.validate-pr.outputs.should_run_full_validation == 'true')) && (needs.validate-pr.outputs.should_run_full_validation == 'true')) && (always())) && (always())) && (always())) && (needs.validate-pr.outputs.should_run_full_validation == 'true')) && (needs.validate-pr.outputs.should_run_full_validation == 'true' && needs.validate-pr.outputs.helm_changed == 'true')) && (needs.validate-pr.outputs.should_run_full_validation == 'true' && needs.validate-pr.outputs.database_changed == 'true')) && (always() && needs.validate-pr.outputs.should_run_full_validation == 'true')) && (needs.validate-pr.outputs.risk_level == 'HIGH')) && (always())) && (always() && needs.validate-pr.outputs.should_run_full_validation == 'true')
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Calculate basic risk level
          RISK_SCORE=0

          # High risk patterns
          if echo "$CHANGED_FILES" | grep -E "(migration|schema)" > /dev/null; then
            RISK_SCORE=$((RISK_SCORE + 3))
          fi

          if echo "$CHANGED_FILES" | grep -E "(charts/|deploy/)" > /dev/null; then
            RISK_SCORE=$((RISK_SCORE + 2))
          fi

          if echo "$CHANGED_FILES" | grep -E "\.github/workflows/" > /dev/null; then
            RISK_SCORE=$((RISK_SCORE + 2))
          fi

          # File count risk
          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          if [[ $FILE_COUNT -gt 20 ]]; then
            RISK_SCORE=$((RISK_SCORE + 2))
          elif [[ $FILE_COUNT -gt 10 ]]; then
            RISK_SCORE=$((RISK_SCORE + 1))
          fi

          # Determine risk level
          if [[ $RISK_SCORE -ge 5 ]]; then
            RISK_LEVEL="HIGH"
          elif [[ $RISK_SCORE -ge 3 ]]; then
            RISK_LEVEL="MEDIUM"
          else
            RISK_LEVEL="LOW"
          fi

          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "üéØ Risk Level: $RISK_LEVEL (Score: $RISK_SCORE)"

          # Set labels based on risk
          gh pr edit ${{ github.event.pull_request.number }} --add-label "risk:$RISK_LEVEL"

          # Add high risk warning
          if [[ "$RISK_LEVEL" == "HIGH" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "
            ‚ö†Ô∏è **High Risk PR Detected**

            This PR has been flagged as high risk due to:
            - Database/schema changes
            - Infrastructure modifications
            - Large number of file changes

            **Additional validation will be performed:**
            - Extended test suite
            - Security scan
            - Manual review required

            Consider breaking this PR into smaller, focused changes if possible.
            "
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Classify PR risk tiers
        id: classify
        run: node .github/scripts/pr-risk-classifier.cjs
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_REF: ${{ github.event.pull_request.base.sha }}
          HEAD_REF: ${{ github.event.pull_request.head.sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Detect change scopes
        id: change-detection
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "helm_changed=false" >> $GITHUB_OUTPUT
          echo "database_changed=false" >> $GITHUB_OUTPUT

          if echo "$CHANGED_FILES" | grep -E '^(charts/|helm/|infra/helm/)' >/dev/null; then
            echo "helm_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -E '^(db/migrations/|db/seeds/|server/src/migrations/|ops/db/)' >/dev/null; then
            echo "database_changed=true" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -E "migration" >/dev/null; then
            echo "database_changed=true" >> $GITHUB_OUTPUT
          fi

  # Build & Typecheck validation
  build-and-typecheck:
    name: üî® Build & TypeCheck
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Enable corepack
        run: corepack enable && corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run build and typecheck
        run: |
          echo "üî® Running build and typecheck..."
          pnpm run build 2>&1 | tee build.log
          BUILD_EXIT=${PIPESTATUS[0]}
          pnpm run typecheck 2>&1 | tee typecheck.log
          TYPECHECK_EXIT=${PIPESTATUS[0]}
          if [[ $BUILD_EXIT -ne 0 || $TYPECHECK_EXIT -ne 0 ]]; then
            exit 1
          fi

  # Test validation
  test-validation:
    name: üß™ Test Suite
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Enable corepack
        run: corepack enable && corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Test Validation
        run: |
          echo "üß™ Running test validation..."

          # Unit tests with coverage
          pnpm run test --coverage 2>&1 | tee test.log

          # Extract coverage
          COVERAGE=$(grep -o "All files.*[0-9]\+\." test.log | grep -o "[0-9]\+\." | head -1 | tr -d '.')
          echo "Test coverage: ${COVERAGE}%"

          # Check coverage threshold
          if [[ ${COVERAGE:-0} -lt 80 ]]; then
            echo "‚ùå Test coverage below 80%"
            gh pr comment ${{ github.event.pull_request.number }} --body "
            üìä **Test Coverage Warning**

            Current test coverage: ${COVERAGE}%
            Minimum required: 80%

            Please add tests to improve coverage before merging.
            "
            exit 1
          fi

          echo "‚úÖ Test validation completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Security validation
  security-validation:
    name: üîí Security Scan
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Enable corepack
        run: corepack enable && corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Security Validation
        run: |
          echo "üîí Running security validation..."

          # Install security tools
          npm install -g audit-ci

          # Check for secrets in code
          echo "Scanning for potential secrets..."
          SECRET_PATTERNS=(
            "password\\s*[:=]\\s*['\"][^'\"]+['\"]"
            "api[_-]?key\\s*[:=]\\s*['\"][^'\"]+['\"]"
            "secret\\s*[:=]\\s*['\"][^'\"]+['\"]"
            "token\\s*[:=]\\s*['\"][^'\"]+['\"]"
          )

          SECRETS_FOUND=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E "$pattern" | grep -v test; then
              echo "‚ö†Ô∏è Potential secret found: $pattern"
              SECRETS_FOUND=true
            fi
          done

          if [[ "$SECRETS_FOUND" == "true" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "
            üö® **Potential Secrets Detected**

            The security scan found potential secrets in your code changes.
            Please review and remove any hardcoded credentials before merging.

            **What to do:**
            1. Remove hardcoded secrets from code
            2. Use environment variables or secret management
            3. Update \`.env.example\` if needed
            4. Consider if existing secrets need rotation
            "
            exit 1
          fi

          # NPM security audit with supply chain gate
          echo "Running supply chain security check..."
          pnpm audit --prod --json > audit.json || true

          # Install audit gate dependencies
          npm install -g audit-ci

          # Run audit gate
          node .github/scripts/audit-gate.js audit.json

      - name: Secret scan with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          args: '--redact --exit-code 1 --report-format sarif --report-path gitleaks.sarif'

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks

      - name: Secret scan with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified --json

      - name: Generate SBOM (CycloneDX)
        run: |
          # For Node.js projects
          if [[ -f "package.json" ]]; then
            npx @cyclonedx/bom generate --output-file cyclonedx-node.json --output-format json
          fi
          # For Python projects
          if [[ -f "requirements.txt" ]]; then
            pip install cyclonedx-bom
            cyclonedx-bom -r -o cyclonedx-python.json
          fi
          # For Go projects
          if ls *.go &> /dev/null; then
            go install github.com/CycloneDX/cyclonedx-go/cmd/cyclonedx-go@latest
            cyclonedx-go -output cyclonedx-go.json
          fi
          # For Rust projects
          if [[ -f "Cargo.toml" ]]; then
            cargo install cyclonedx-bom
            cyclonedx-bom -o cyclonedx-rust.json
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sbom-artifacts
          path: |
            cyclonedx-node.json
            cyclonedx-python.json
            cyclonedx-go.json
            cyclonedx-rust.json
          retention-days: 5

      - name: Run npm audit
        run: |
          if [[ -f "package.json" ]]; then
            npm audit --omit=dev --json > npm-audit.json || true
          else
            echo "Skipping npm audit; package.json not found."
          fi

      - name: Run pip-audit
        run: |
          if [[ -f "requirements.txt" ]]; then
            python3.12 -m pip install pip-audit
            pip-audit -r requirements.txt --json > pip-audit.json || true
          else
            echo "Skipping pip-audit; requirements.txt not found."
          fi

      - name: Run go vet
        run: |
          if ls *.go &> /dev/null; then
            go vet ./...
          else
            echo "Skipping go vet; no Go files detected."
          fi

      - name: Run cargo audit
        run: |
          if [[ -f "Cargo.toml" ]]; then
            cargo install cargo-audit
            cargo audit --json > cargo-audit.json || true
          else
            echo "Skipping cargo audit; Cargo.toml not found."
          fi

      - name: Run gradle dependencyCheck
        run: |
          if [[ -f "build.gradle" ]]; then
            ./gradlew dependencyCheckAnalyze
            # Convert XML report to SARIF if possible
          else
            echo "Skipping gradle dependencyCheck; build.gradle not found."
          fi

      - name: Generate security annotations
        run: |
          # Create security annotations for PR
          if [[ -f "gitleaks.sarif" ]]; then
            echo "üîç Processing security scan results..."

            # Extract findings from SARIF
            FINDINGS=$(jq -r '.runs[0].results[] | "::warning file=\(.locations[0].physicalLocation.artifactLocation.uri),line=\(.locations[0].physicalLocation.region.startLine)::\(.message.text)"' gitleaks.sarif 2>/dev/null || echo "")

            if [[ -n "$FINDINGS" ]]; then
              echo "Security findings detected:"
              echo "$FINDINGS"
            fi
          fi

          echo "‚úÖ Security validation completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Lint validation
  lint-validation:
    name: üéØ Code Quality
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Enable corepack
        run: corepack enable && corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Lint Validation
        run: |
          echo "üéØ Running code quality validation..."

          # Linting
          pnpm run lint 2>&1 | tee lint.log

          # Count lint errors
          LINT_ERRORS=$(grep -c "error" lint.log || echo "0")
          LINT_WARNINGS=$(grep -c "warning" lint.log || echo "0")

          echo "Lint results: $LINT_ERRORS errors, $LINT_WARNINGS warnings"

          if [[ $LINT_ERRORS -gt 0 ]]; then
            echo "‚ùå Linting errors found"
            gh pr comment ${{ github.event.pull_request.number }} --body "
            üéØ **Linting Errors**

            Found $LINT_ERRORS linting errors that must be fixed:

            ```
            $(grep "error" lint.log | head -10)
            ```

            Run \\`pnpm run lint --fix\\` to auto-fix some issues.
            "
            exit 1
          fi

          echo "‚úÖ Quality validation completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Helm lint validation
  helm-lint:
    name: ‚õµ Helm Lint
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Lint Helm charts
        run: |
          shopt -s nullglob
          FOUND=false
          for chart in charts/*/ helm/*/ infra/helm/*/; do
            if [[ -d "$chart" ]]; then
              FOUND=true
              echo "Validating $chart"
              helm lint "$chart"
            fi
          done

          if [[ "$FOUND" == false ]]; then
            echo "No Helm chart directories found to lint."
          fi

  # Migration validation
  migration-validation:
    name: üóÑÔ∏è Migration Gate
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run migration plan
        run: |
          chmod +x ops/db/migrate ops/db/verify
          ./ops/db/migrate --plan --no-apply
          ./ops/db/verify --shadow

  # Policy validation using OPA
  policy-validation:
    name: üìã Policy Validation
    needs:
      - validate-pr
      - build-and-typecheck
      - test-validation
      - security-validation
      - lint-validation
      - helm-lint
      - migration-validation
      - e2e-validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Validate against policies
        run: |
          echo "üìã Validating against Summit quality policies..."

          # Create policy input
          cat > policy-input.json << EOF
          {
            "pr": {
              "number": ${{ github.event.pull_request.number }},
              "title": "${{ github.event.pull_request.title }}",
              "author": "${{ github.event.pull_request.user.login }}",
              "draft": ${{ github.event.pull_request.draft }},
              "mergeable": ${{ github.event.pull_request.mergeable || true }}
            },
            "analysis": {
              "risk_level": "${{ needs.validate-pr.outputs.risk_level }}"
            },
            "quality_gates": {
              "build": ${{ needs.build-and-typecheck.result == 'success' }},
              "typecheck": ${{ needs.build-and-typecheck.result == 'success' }},
              "lint": ${{ needs.lint-validation.result == 'success' }},
              "tests": ${{ needs.test-validation.result == 'success' }},
              "security": ${{ needs.security-validation.result == 'success' }},
              "helm": ${{ needs.helm-lint.result == 'success' || needs.validate-pr.outputs.helm_changed != 'true' }},
              "migrations": ${{ needs.migration-validation.result == 'success' || needs.validate-pr.outputs.database_changed != 'true' }},
              "e2e": ${{ needs.e2e-validation.result == 'success' || needs.e2e-validation.result == 'skipped' }}
            },
            "changed_files": $(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | jq -R . | jq -s .)
          }
          EOF

          # Run policy evaluation
          opa eval -d .github/policies/ -i policy-input.json "data.summit.quality.decision" > policy-result.json

          # Extract results
          APPROVED=$(jq -r '.result.approved' policy-result.json)
          WARNINGS=$(jq -r '.result.warnings[]?' policy-result.json)
          REQUIREMENTS=$(jq -r '.result.requirements[]?' policy-result.json)

          echo "Policy evaluation result: $APPROVED"

          # Post policy results
          if [[ "$APPROVED" == "true" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "
            ‚úÖ **Policy Validation Passed**

            This PR meets all Summit quality standards and is approved for merge.
            "
          else
            COMMENT="‚ùå **Policy Validation Failed**

            This PR does not meet Summit quality standards.

            **Requirements:**
            $REQUIREMENTS

            **Warnings:**
            $WARNINGS

            Please address these issues before requesting review."

            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate policy output shape
        run: |
          jq -e '.result.approved | type == "boolean"' policy-result.json >/dev/null
          jq -e '(.result.requirements // []) | type == "array"' policy-result.json >/dev/null
          jq -e '(.result.warnings // []) | type == "array"' policy-result.json >/dev/null

  # High risk E2E validation
  e2e-validation:
    name: üé¨ E2E Validation
    needs: validate-pr
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup services for E2E
        run: |
          echo "üöÄ Starting services for E2E testing..."
          docker-compose -f deploy/compose/docker-compose.yml up -d --build

          # Wait for services
          timeout 300 bash -c 'until curl -f http://localhost:4000/health; do sleep 5; done'

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: |
          echo "üé¨ Running E2E tests for high risk PR..."
          BASE_URL=http://localhost:4000 npx playwright test --timeout=30000

      - name: Cleanup
        run: docker-compose -f deploy/compose/docker-compose.yml down

  # Summary status check
  validation-summary:
    name: üìä Validation Summary
    needs:
      - validate-pr
      - build-and-typecheck
      - test-validation
      - security-validation
      - lint-validation
      - helm-lint
      - migration-validation
      - e2e-validation
      - policy-validation
    runs-on: ubuntu-latest
    steps:
      - name: Check validation results
        run: |
          echo "üìä Summarizing validation results..."

          BUILD_STATUS="${{ needs.build-and-typecheck.result }}"
          TEST_STATUS="${{ needs.test-validation.result }}"
          SECURITY_STATUS="${{ needs.security-validation.result }}"
          LINT_STATUS="${{ needs.lint-validation.result }}"
          HELM_STATUS="${{ needs.helm-lint.result }}"
          MIGRATION_STATUS="${{ needs.migration-validation.result }}"
          E2E_STATUS="${{ needs.e2e-validation.result }}"
          POLICY_STATUS="${{ needs.policy-validation.result }}"

          if [[ "$BUILD_STATUS" == "success" && "$TEST_STATUS" == "success" && "$SECURITY_STATUS" == "success" && "$LINT_STATUS" == "success" && ("$HELM_STATUS" == "success" || "$HELM_STATUS" == "skipped") && ("$MIGRATION_STATUS" == "success" || "$MIGRATION_STATUS" == "skipped") && ("$E2E_STATUS" == "success" || "$E2E_STATUS" == "skipped") && "$POLICY_STATUS" == "success" ]]; then
            echo "‚úÖ All validations passed"
            gh pr comment ${{ github.event.pull_request.number }} --body "
            üéâ **All Validations Passed!**

            This PR is ready for review and merge:
            - ‚úÖ Build and type checking
            - ‚úÖ Test suite with coverage
            - ‚úÖ Security scanning
            - ‚úÖ Code quality checks
            - ‚úÖ Policy validation

            **Next steps:** Awaiting code review from maintainers.
            "
          else
            echo "‚ùå Some validations failed"
            gh pr comment ${{ github.event.pull_request.number }} --body "
            ‚ùå **Validation Issues Found**

            Some validations failed. Please check the details above and fix issues before requesting review.

            **Status:**
            - Build: $BUILD_STATUS
            - Tests: $TEST_STATUS
            - Security: $SECURITY_STATUS
            - Lint: $LINT_STATUS
            - Helm: $HELM_STATUS
            - Migrations: $MIGRATION_STATUS
            - E2E: $E2E_STATUS
            - Policy: $POLICY_STATUS

            Use `/merge-pr ${{ github.event.pull_request.number }} --dry-run` to run Release Captain analysis.
            "
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
