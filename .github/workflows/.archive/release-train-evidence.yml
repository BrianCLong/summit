name: Release Train Evidence

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build evidence for'
        required: false
      release_name:
        description: 'Release name override (optional)'
        required: false

permissions:
  contents: write
  actions: read
  id-token: write

jobs:
  build-evidence:
    name: Build Evidence Bundle
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.release_tag || github.ref_name }}
      RELEASE_NAME: ${{ github.event.release.name || github.event.inputs.release_name || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SBOM tooling
        uses: anchore/sbom-action/download-syft@v0.17.5

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install jsonschema pyyaml

      - name: Capture release notes from event
        run: |
          python - <<'PY'
import json
import os
from pathlib import Path

event = json.load(open(os.environ["GITHUB_EVENT_PATH"], "r"))
notes = ""
if "release" in event:
    notes = event.get("release", {}).get("body", "") or ""
Path(".github/release-notes.md").write_text(notes)
PY

      - name: Generate SBOM for repository
        run: syft dir:. -o spdx-json:release-sbom.spdx.json

      - name: Assemble evidence payload
        id: payload
        run: |
          BUNDLE_DIR=release-evidence/${RELEASE_TAG}
          mkdir -p "$BUNDLE_DIR"
          mv release-sbom.spdx.json "$BUNDLE_DIR"/
          if [ -f .github/release-notes.md ]; then
            mv .github/release-notes.md "$BUNDLE_DIR"/
          fi
          echo "bundle_dir=$BUNDLE_DIR" >> $GITHUB_OUTPUT

      - name: Create archive and checksum
        id: archive
        run: |
          BUNDLE_DIR=${{ steps.payload.outputs.bundle_dir }}
          tar -czf release-evidence-${RELEASE_TAG}.tar.gz -C "$BUNDLE_DIR" .
          sha256sum release-evidence-${RELEASE_TAG}.tar.gz > release-evidence-${RELEASE_TAG}.tar.gz.sha256
          echo "bundle_sha=$(cut -d' ' -f1 release-evidence-${RELEASE_TAG}.tar.gz.sha256)" >> $GITHUB_OUTPUT

      - name: Generate release metadata
        id: metadata
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          python - <<'PY'
import hashlib
import json
import os
from datetime import datetime, timezone
from pathlib import Path

import yaml
from jsonschema import Draft202012Validator

release_tag = os.environ.get("RELEASE_TAG")
release_name = os.environ.get("RELEASE_NAME", release_tag)
bundle_dir = Path(os.environ["BUNDLE_DIR"])
bundle_sha = os.environ["BUNDLE_SHA"]
run_id = os.environ.get("RUN_ID")

sbom_path = bundle_dir / "release-sbom.spdx.json"
notes_path = bundle_dir / "release-notes.md"

commit = os.popen("git rev-parse HEAD").read().strip()
branch = os.popen("git rev-parse --abbrev-ref HEAD").read().strip()
train_id = release_tag.replace("v", "").split("-")[0]

schema_path = Path("docs/release/release-metadata.schema.json")
schema = json.loads(schema_path.read_text())


def sha256sum(path: Path) -> str:
    digest = hashlib.sha256()
    with path.open("rb") as handle:
        for chunk in iter(lambda: handle.read(8192), b""):
            digest.update(chunk)
    return digest.hexdigest()

files = []
if sbom_path.exists():
    files.append({
        "path": sbom_path.name,
        "sha256": sha256sum(sbom_path),
        "description": "Repository SBOM (SPDX JSON)",
        "format": "spdx-json",
    })
if notes_path.exists():
    files.append({
        "path": notes_path.name,
        "sha256": sha256sum(notes_path),
        "description": "Release notes captured at publish time",
    })

metadata = {
    "schema_version": "1.0.0",
    "generated_at": datetime.now(timezone.utc).isoformat(),
    "release": {
        "train_id": train_id,
        "version": release_tag,
        "tag": release_tag,
        "commit": commit,
        "branch": branch,
        "pipeline_run_id": run_id,
        "release_notes": notes_path.read_text() if notes_path.exists() else "",
        "name": release_name,
    },
    "artifacts": [
        {
            "name": "source-repo",
            "type": "git",
            "location": f"https://github.com/{os.environ.get('GITHUB_REPOSITORY')}/tree/{commit}",
            "digest": commit,
        }
    ],
    "evidence": {
        "bundle_path": f"release-evidence-{release_tag}.tar.gz",
        "bundle_sha256": bundle_sha,
        "sbom": [item for item in files if item.get("format") == "spdx-json"],
        "tests": [
            {
                "name": "pr-quality-gate",
                "status": "unknown",
                "report": "",
            }
        ],
        "files": files,
    },
    "provenance": {
        "slsa_provenance": "",
        "signing": {"signer": "github-actions", "certificate": ""},
    },
}

Draft202012Validator(schema).validate(metadata)

json_path = Path("release-metadata.json")
yaml_path = Path("release-metadata.yaml")
json_path.write_text(json.dumps(metadata, indent=2))
yaml_path.write_text(yaml.safe_dump(metadata, sort_keys=False))

print(f"metadata_json={json_path}" )
print(f"metadata_yaml={yaml_path}" )
with open(os.environ["GITHUB_OUTPUT"], "a") as handle:
    handle.write(f"metadata_json={json_path}\n")
    handle.write(f"metadata_yaml={yaml_path}\n")
PY
        env:
          BUNDLE_DIR: ${{ steps.payload.outputs.bundle_dir }}
          BUNDLE_SHA: ${{ steps.archive.outputs.bundle_sha }}

      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-evidence-${{ env.RELEASE_TAG }}
          path: |
            release-evidence-${{ env.RELEASE_TAG }}.tar.gz
            release-evidence-${{ env.RELEASE_TAG }}.tar.gz.sha256
            release-metadata.json
            release-metadata.yaml

      - name: Attach evidence to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            release-evidence-${{ env.RELEASE_TAG }}.tar.gz
            release-evidence-${{ env.RELEASE_TAG }}.tar.gz.sha256
            release-metadata.json
            release-metadata.yaml

      - name: Summary
        run: |
          echo "## ðŸ“¦ Release evidence bundle ready" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: ${RELEASE_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: release-evidence-${RELEASE_TAG}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- Metadata: release-metadata.json / release-metadata.yaml" >> $GITHUB_STEP_SUMMARY
          echo "- Schema: docs/release/release-metadata.schema.json" >> $GITHUB_STEP_SUMMARY
