name: Graph Query Oracle

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'services/graph-core/**'
      - 'services/graph-api/**'
      - 'services/graph-algos/**'
      - 'packages/graph-*/**'
      - 'server/src/services/Graph*'
      - 'server/src/repos/*Repo.ts'
      - 'server/src/db/neo4j.ts'
      - 'testdata/intelgraph/**'
      - 'scripts/testing/run-graph-oracle.ts'
      - '.github/workflows/graph-oracle.yml'
  push:
    branches:
      - main
    paths:
      - 'services/graph-core/**'
      - 'services/graph-api/**'
      - 'services/graph-algos/**'
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Specific scenario to run (e.g., path-1.1)'
        required: false
        default: ''
      category:
        description: 'Category to run (e.g., pathfinding, neighborhood)'
        required: false
        default: ''
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: graph-oracle-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  HUSKY: 0

permissions:
  contents: read
  pull-requests: write

jobs:
  oracle:
    name: Graph Query Correctness Oracle
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      neo4j:
        image: neo4j:5.22-community
        env:
          NEO4J_AUTH: neo4j/testtest1
          NEO4J_server_memory_heap_initial__size: 256m
          NEO4J_server_memory_heap_max__size: 512m
          NEO4J_dbms_memory_pagecache_size: 256m
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -a bolt://localhost:7687 -u neo4j -p testtest1 'RETURN 1' || exit 1"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 60

      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: summit
          POSTGRES_PASSWORD: devpassword
          POSTGRES_DB: summit_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 3s
          --health-retries 30

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'pnpm'
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build graph-core service
        run: pnpm turbo run build --filter=@intelgraph/graph-core

      - name: Wait for Neo4j to be ready
        run: |
          echo "Waiting for Neo4j to be ready..."
          timeout 120 bash -c 'until nc -z localhost 7687; do sleep 1; done'
          echo "Neo4j is ready!"

      - name: Start graph-core API
        run: |
          cd services/graph-core
          NODE_ENV=test \
          NEO4J_URI=bolt://localhost:7687 \
          NEO4J_USERNAME=neo4j \
          NEO4J_PASSWORD=testtest1 \
          DATABASE_URL=postgresql://summit:devpassword@localhost:5432/summit_dev \
          REDIS_HOST=localhost \
          REDIS_PORT=6379 \
          PORT=4000 \
          pnpm start &

          echo "Waiting for API to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:4000/health > /dev/null 2>&1; do sleep 1; done'
          echo "API is ready!"
        env:
          NODE_ENV: test

      - name: Run Graph Oracle
        id: oracle
        run: |
          ARGS=""

          if [ -n "${{ github.event.inputs.scenario }}" ]; then
            ARGS="$ARGS --scenario ${{ github.event.inputs.scenario }}"
          fi

          if [ -n "${{ github.event.inputs.category }}" ]; then
            ARGS="$ARGS --category ${{ github.event.inputs.category }}"
          fi

          if [ "${{ github.event.inputs.verbose }}" == "true" ]; then
            ARGS="$ARGS --verbose"
          fi

          npx tsx scripts/testing/run-graph-oracle.ts \
            --api-url http://localhost:4000/graphql \
            --report-dir reports \
            --timeout 15000 \
            $ARGS
        continue-on-error: true

      - name: Upload Oracle Report
        if: ((((always()) && (github.event_name == 'pull_request' && always())) && (steps.oracle.outcome == 'failure')) && (github.event_name == 'push' && github.ref == 'refs/heads/main')) && (steps.metrics.outputs.avg_latency != '')
        uses: actions/upload-artifact@v4
        with:
          name: graph-oracle-report
          path: |
            reports/graph-oracle-report.md
            reports/graph-oracle-report.json
          retention-days: 30

      - name: Comment PR with Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'reports/graph-oracle-report.md');

            if (!fs.existsSync(reportPath)) {
              console.log('Report not found, skipping comment');
              return;
            }

            let report = fs.readFileSync(reportPath, 'utf8');

            // Truncate if too long
            if (report.length > 60000) {
              report = report.substring(0, 60000) + '\n\n... (truncated, see full report in artifacts)';
            }

            const oracleStatus = '${{ steps.oracle.outcome }}';
            const statusEmoji = oracleStatus === 'success' ? '✅' : '❌';

            const comment = `## ${statusEmoji} Graph Query Oracle Results\n\n${report}\n\n---\n*Oracle ran on commit ${context.sha.substring(0, 7)}*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Graph Query Oracle Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Check Oracle Status
        run: |
          echo "::error::Graph Query Oracle detected correctness violations!"
          echo "Review the oracle report for details on which scenarios failed."
          exit 1

  performance-tracking:
    name: Track Performance Metrics
    runs-on: ubuntu-latest
    needs: oracle

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Oracle Report
        uses: actions/download-artifact@v4
        with:
          name: graph-oracle-report
          path: reports

      - name: Extract Performance Metrics
        id: metrics
        run: |
          if [ -f reports/graph-oracle-report.json ]; then
            echo "Performance metrics from oracle report:"
            cat reports/graph-oracle-report.json | jq '.performanceSummary'

            # Store metrics for potential alerting
            AVG_LATENCY=$(cat reports/graph-oracle-report.json | jq '[.performanceSummary[].avgMs] | add / length')
            echo "avg_latency=$AVG_LATENCY" >> $GITHUB_OUTPUT
          else
            echo "No report found"
          fi

      - name: Performance Alert
        run: |
          AVG_LATENCY=${{ steps.metrics.outputs.avg_latency }}
          THRESHOLD=1000

          if (( $(echo "$AVG_LATENCY > $THRESHOLD" | bc -l) )); then
            echo "::warning::Average query latency ($AVG_LATENCY ms) exceeds threshold ($THRESHOLD ms)"
          else
            echo "Performance within acceptable range: $AVG_LATENCY ms average"
          fi
