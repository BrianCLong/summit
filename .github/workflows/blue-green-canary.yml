name: Blue-Green with Progressive Canary

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Container image tag/version to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        default: staging
        options:
          - staging
          - production
      application:
        description: 'Target application profile'
        required: true
        type: choice
        default: intelgraph
        options:
          - intelgraph
          - maestro
          - companyos

permissions:
  contents: read
  deployments: write
  packages: read

concurrency:
  group: blue-green-canary-${{ inputs.environment }}-${{ inputs.application }}
  cancel-in-progress: false

env:
  RELEASE_NAME: intelgraph
  SERVICE_NAME: intelgraph-service
  NAMESPACE_PREFIX: intelgraph
  CHART_PATH: infra/helm/intelgraph
  CANARY_CONFIG_PATH: summit_release_env_pack/k8s/optional/argo-rollouts/canary-traffic-config.json

jobs:
  create-deployment-record:
    runs-on: ubuntu-latest
    outputs:
      deployment_id: ${{ steps.create.outputs.deployment_id }}
      release_name: ${{ steps.canary-profile.outputs.release_name }}
      service_name: ${{ steps.canary-profile.outputs.service_name }}
      namespace_prefix: ${{ steps.canary-profile.outputs.namespace_prefix }}
      chart_path: ${{ steps.canary-profile.outputs.chart_path }}
      canary_weights: ${{ steps.canary-profile.outputs.canary_weights }}
      canary_feature_flag: ${{ steps.canary-profile.outputs.canary_feature_flag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load canary profile
        id: canary-profile
        env:
          APP_KEY: ${{ inputs.application }}
        run: |
          CONFIG="${{ env.CANARY_CONFIG_PATH }}"
          if [ ! -f "$CONFIG" ]; then
            echo "Config not found at $CONFIG"
            exit 1
          fi

          if ! jq -e --arg app "$APP_KEY" '.[$app]' "$CONFIG" >/tmp/profile.json; then
            echo "Profile for $APP_KEY missing in $CONFIG"
            exit 1
          fi

          RELEASE_NAME=$(jq -r '.release' /tmp/profile.json)
          SERVICE_NAME=$(jq -r '.service' /tmp/profile.json)
          NAMESPACE_PREFIX=$(jq -r '.namespacePrefix' /tmp/profile.json)
          CHART_PATH=$(jq -r '.chart' /tmp/profile.json)
          STAGES=$(jq -r '.trafficStages | join(",")' /tmp/profile.json)
          FEATURE_FLAG=$(jq -r '.featureFlags[0]' /tmp/profile.json)

          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"
          echo "service_name=${SERVICE_NAME}" >> "$GITHUB_OUTPUT"
          echo "namespace_prefix=${NAMESPACE_PREFIX}" >> "$GITHUB_OUTPUT"
          echo "chart_path=${CHART_PATH}" >> "$GITHUB_OUTPUT"
          echo "canary_weights=${STAGES},100" >> "$GITHUB_OUTPUT"
          echo "canary_feature_flag=${FEATURE_FLAG}" >> "$GITHUB_OUTPUT"

          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
### Canary Profile (${APP_KEY})
- Release: ${RELEASE_NAME}
- Service: ${SERVICE_NAME}
- Namespace prefix: ${NAMESPACE_PREFIX}
- Chart path: ${CHART_PATH}
- Traffic plan: ${STAGES}% → 100%
- Feature flag: ${FEATURE_FLAG}
EOF

      - name: Create deployment record
        id: create
        uses: actions/github-script@v7
        env:
          TARGET_ENV: ${{ inputs.environment }}
          DEPLOY_VERSION: ${{ inputs.version }}
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: process.env.TARGET_ENV,
              description: `Blue-green with progressive canary for ${process.env.DEPLOY_VERSION}`,
              auto_merge: false,
              required_contexts: [],
              production_environment: process.env.TARGET_ENV === 'production',
            });

            core.setOutput('deployment_id', deployment.data.id);

  blue-green:
    name: Blue-Green rollout
    runs-on: ubuntu-latest
    needs: create-deployment-record
    environment: ${{ inputs.environment }}
    env:
      RELEASE_NAME: ${{ needs.create-deployment-record.outputs.release_name }}
      SERVICE_NAME: ${{ needs.create-deployment-record.outputs.service_name }}
      NAMESPACE_PREFIX: ${{ needs.create-deployment-record.outputs.namespace_prefix }}
      CHART_PATH: ${{ needs.create-deployment-record.outputs.chart_path }}
    outputs:
      active_env: ${{ steps.traffic-state.outputs.active }}
      standby_env: ${{ steps.traffic-state.outputs.standby }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Execute blue-green deployment
        id: bluegreen
        env:
          NAMESPACE: ${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment }}
          RELEASE_NAME: ${{ env.RELEASE_NAME }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        run: |
          ./scripts/blue-green-deploy.sh "${{ inputs.environment }}" "${{ inputs.version }}"

      - name: Capture active/standby environments
        id: traffic-state
        env:
          NAMESPACE: ${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        run: |
          ACTIVE=$(kubectl get service "$SERVICE_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.selector.environment}')
          if [ "$ACTIVE" = "blue" ]; then
            STANDBY="green"
          else
            STANDBY="blue"
          fi

          echo "active=$ACTIVE" >> "$GITHUB_OUTPUT"
          echo "standby=$STANDBY" >> "$GITHUB_OUTPUT"

      - name: Update deployment status (blue-green complete)
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ needs.create-deployment-record.outputs.deployment_id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state: 'in_progress',
              description: 'Blue-green switch completed; starting canary ramp',
            });

  canary-progressive:
    name: Progressive canary (10% → 100%)
    runs-on: ubuntu-latest
    needs: [create-deployment-record, blue-green]
    environment: ${{ inputs.environment }}
    env:
      RELEASE_NAME: ${{ needs.create-deployment-record.outputs.release_name }}
      SERVICE_NAME: ${{ needs.create-deployment-record.outputs.service_name }}
      NAMESPACE_PREFIX: ${{ needs.create-deployment-record.outputs.namespace_prefix }}
      CHART_PATH: ${{ needs.create-deployment-record.outputs.chart_path }}
      CANARY_STAGE_WEIGHTS: ${{ needs.create-deployment-record.outputs.canary_weights }}
      CANARY_FEATURE_FLAG: ${{ needs.create-deployment-record.outputs.canary_feature_flag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Progressive canary rollout
        env:
          NAMESPACE: ${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment }}
          RELEASE_NAME: ${{ env.RELEASE_NAME }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          IMAGE_TAG: ${{ inputs.version }}
          CHART_PATH: ${{ env.CHART_PATH }}
          CANARY_STAGE_WEIGHTS: ${{ env.CANARY_STAGE_WEIGHTS }}
          CANARY_FEATURE_FLAG: ${{ env.CANARY_FEATURE_FLAG }}
        run: |
          ./scripts/canary/deploy-canary.sh

      - name: Update deployment status (canary complete)
        if: success()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ needs.create-deployment-record.outputs.deployment_id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state: 'success',
              description: 'Canary promoted to 100% traffic',
            });

      - name: Automatic rollback
        if: failure()
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          STANDBY_ENV: ${{ needs.blue-green.outputs.standby_env }}
        run: |
          echo "Canary gate failed; rolling traffic back to $STANDBY_ENV"
          ./scripts/rollback-blue-green.sh "$ENVIRONMENT" "$STANDBY_ENV"

  finalize-status:
    name: Finalize deployment status
    runs-on: ubuntu-latest
    needs: [create-deployment-record, blue-green, canary-progressive]
    if: always()
    steps:
      - name: Mark deployment result
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ needs.create-deployment-record.outputs.deployment_id }}
          CANARY_RESULT: ${{ needs.canary-progressive.result }}
        with:
          script: |
            const state = process.env.CANARY_RESULT === 'success' ? 'success' : 'failure';
            const description = state === 'success'
              ? 'Blue-green + canary rollout healthy'
              : 'Deployment failed; rollback executed';

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state,
              description,
            });
