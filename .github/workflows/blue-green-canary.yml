name: Blue-Green with Progressive Canary

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Container image tag/version to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        default: staging
        options:
          - staging
          - production
      service:
        description: 'Target service'
        required: true
        type: choice
        options:
          - maestro
          - intelgraph
          - companyos

permissions:
  contents: read
  deployments: write
  packages: read

concurrency:
  group: blue-green-canary-${{ inputs.environment }}
  cancel-in-progress: false

env:
  CANARY_CONFIG_PATH: summit_release_env_pack/k8s/canary/canary-stage-config.json

jobs:
  create-deployment-record:
    runs-on: ubuntu-latest
    outputs:
      deployment_id: ${{ steps.create.outputs.deployment_id }}
      release_name: ${{ steps.canary-config.outputs.release }}
      service_name: ${{ steps.canary-config.outputs.service_name }}
      namespace_prefix: ${{ steps.canary-config.outputs.namespace_prefix }}
      namespace: ${{ steps.canary-config.outputs.namespace }}
      chart_path: ${{ steps.canary-config.outputs.chart }}
      canary_weights: ${{ steps.canary-config.outputs.weights }}
      feature_flag: ${{ steps.canary-config.outputs.feature_flag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load canary service config
        id: canary-config
        env:
          SERVICE_KEY: ${{ inputs.service }}
          TARGET_ENV: ${{ inputs.environment }}
        run: |
          python - <<'PY'
import json, os, pathlib, sys

config_path = pathlib.Path(os.environ["CANARY_CONFIG_PATH"])
if not config_path.exists():
    sys.exit(f"Missing canary config at {config_path}")

service = os.environ["SERVICE_KEY"]
target_env = os.environ["TARGET_ENV"]
data = json.loads(config_path.read_text())
service_cfg = data.get("services", {}).get(service)
if not service_cfg:
    sys.exit(f"Service '{service}' not defined in {config_path}")

namespace_prefix = service_cfg.get("namespacePrefix", service)
namespace = service_cfg.get("namespaces", {}).get("production" if target_env == "production" else "staging", f"{namespace_prefix}-{target_env}")
release = service_cfg.get("release", service)
service_name = service_cfg.get("serviceName", f"{service}-service")
chart = service_cfg.get("chart", "infra/helm/intelgraph")
weights = service_cfg.get("trafficWeights", [])
feature_flag = service_cfg.get("featureFlag", f"{service}_canary_enabled")

with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
    fh.write(f"release={release}\n")
    fh.write(f"service_name={service_name}\n")
    fh.write(f"namespace_prefix={namespace_prefix}\n")
    fh.write(f"namespace={namespace}\n")
    fh.write(f"chart={chart}\n")
    fh.write(f"weights={','.join(map(str, weights))}\n")
    fh.write(f"feature_flag={feature_flag}\n")
PY

      - name: Create deployment record
        id: create
        uses: actions/github-script@v7
        env:
          TARGET_ENV: ${{ inputs.environment }}
          DEPLOY_VERSION: ${{ inputs.version }}
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: process.env.TARGET_ENV,
              description: `Blue-green with progressive canary for ${process.env.DEPLOY_VERSION}`,
              auto_merge: false,
              required_contexts: [],
              production_environment: process.env.TARGET_ENV === 'production',
            });

            core.setOutput('deployment_id', deployment.data.id);

  blue-green:
    name: Blue-Green rollout
    runs-on: ubuntu-latest
    needs: create-deployment-record
    environment: ${{ inputs.environment }}
    outputs:
      active_env: ${{ steps.traffic-state.outputs.active }}
      standby_env: ${{ steps.traffic-state.outputs.standby }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Execute blue-green deployment
        id: bluegreen
        env:
          NAMESPACE: ${{ needs.create-deployment-record.outputs.namespace }}
          RELEASE_NAME: ${{ needs.create-deployment-record.outputs.release_name }}
          SERVICE_NAME: ${{ needs.create-deployment-record.outputs.service_name }}
        run: |
          ./scripts/blue-green-deploy.sh "${{ inputs.environment }}" "${{ inputs.version }}"

      - name: Capture active/standby environments
        id: traffic-state
        env:
          NAMESPACE: ${{ needs.create-deployment-record.outputs.namespace }}
          SERVICE_NAME: ${{ needs.create-deployment-record.outputs.service_name }}
        run: |
          ACTIVE=$(kubectl get service "$SERVICE_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.selector.environment}')
          if [ "$ACTIVE" = "blue" ]; then
            STANDBY="green"
          else
            STANDBY="blue"
          fi

          echo "active=$ACTIVE" >> "$GITHUB_OUTPUT"
          echo "standby=$STANDBY" >> "$GITHUB_OUTPUT"

      - name: Update deployment status (blue-green complete)
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ needs.create-deployment-record.outputs.deployment_id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state: 'in_progress',
              description: 'Blue-green switch completed; starting canary ramp',
            });

  canary-progressive:
    name: Progressive canary (10% â†’ 100%)
    runs-on: ubuntu-latest
    needs: [create-deployment-record, blue-green]
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Progressive canary rollout
        env:
          NAMESPACE: ${{ needs.create-deployment-record.outputs.namespace }}
          RELEASE_NAME: ${{ needs.create-deployment-record.outputs.release_name }}
          SERVICE_NAME: ${{ needs.create-deployment-record.outputs.service_name }}
          IMAGE_TAG: ${{ inputs.version }}
          CHART_PATH: ${{ needs.create-deployment-record.outputs.chart_path }}
          CANARY_STAGES_CSV: ${{ needs.create-deployment-record.outputs.canary_weights }}
        run: |
          ./scripts/canary/deploy-canary.sh

      - name: Update deployment status (canary complete)
        if: success()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ needs.create-deployment-record.outputs.deployment_id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state: 'success',
              description: 'Canary promoted to 100% traffic',
            });

      - name: Automatic rollback
        if: failure()
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          STANDBY_ENV: ${{ needs.blue-green.outputs.standby_env }}
        run: |
          echo "Canary gate failed; rolling traffic back to $STANDBY_ENV"
          ./scripts/rollback-blue-green.sh "$ENVIRONMENT" "$STANDBY_ENV"

  finalize-status:
    name: Finalize deployment status
    runs-on: ubuntu-latest
    needs: [create-deployment-record, blue-green, canary-progressive]
    if: always()
    steps:
      - name: Mark deployment result
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ needs.create-deployment-record.outputs.deployment_id }}
          CANARY_RESULT: ${{ needs.canary-progressive.result }}
        with:
          script: |
            const state = process.env.CANARY_RESULT === 'success' ? 'success' : 'failure';
            const description = state === 'success'
              ? 'Blue-green + canary rollout healthy'
              : 'Deployment failed; rollback executed';

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state,
              description,
            });
