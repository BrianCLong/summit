name: PR Quality Gate

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: quality-gate-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  PNPM_CACHE_FOLDER: ~/.pnpm-store
  NODE_VERSION: '20.x'

jobs:
  # Lint & Check: Fast feedback (lint, typecheck, complexity)
  lint-check:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Enable Corepack
        run: corepack enable

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_CACHE_FOLDER }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Configure pnpm store
        run: pnpm config set store-dir $PNPM_CACHE_FOLDER

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Lint
        run: pnpm run lint

      - name: Run TypeScript check
        run: pnpm run typecheck

      - name: Run Complexity Check
        run: |
          echo "Running ESLint complexity rules (Report Only)..."
          pnpm exec eslint --config eslint.complexity.config.mjs \
            --format stylish \
            'server/src/**/*.ts' \
            'client/src/**/*.{ts,tsx}' \
            'packages/**/src/**/*.ts' || echo "::warning::Complexity issues found."

      - name: Check for TODO/FIXME count
        run: |
          TODO_COUNT=$(grep -rn "TODO\|FIXME\|XXX\|HACK" --include="*.ts" --include="*.tsx" server/ client/ packages/ 2>/dev/null | wc -l || echo "0")
          echo "Found $TODO_COUNT TODO/FIXME comments"
          if [ "$TODO_COUNT" -gt 250 ]; then
            echo "::warning::High number of TODO/FIXME comments ($TODO_COUNT). Consider addressing technical debt."
          fi

  # Coverage Gate: Unit tests with coverage (Mocked DB)
  coverage-gate:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Enable Corepack
        run: corepack enable

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_CACHE_FOLDER }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Configure pnpm store
        run: pnpm config set store-dir $PNPM_CACHE_FOLDER

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup test environment
        run: |
          cp .env.example .env.test || true
          echo "NODE_ENV=test" >> .env.test

      - name: Run tests with coverage
        run: pnpm run test:coverage
        env:
          NODE_ENV: test
          CI: true

      - name: Enforce coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              const thresholds = {
                lines: 80,
                statements: 80,
                functions: 80,
                branches: 75
              };

              const failed = [];

              if (total.lines.pct < thresholds.lines)
                failed.push('Lines: ' + total.lines.pct + '% < ' + thresholds.lines + '%');
              if (total.statements.pct < thresholds.statements)
                failed.push('Statements: ' + total.statements.pct + '% < ' + thresholds.statements + '%');
              if (total.functions.pct < thresholds.functions)
                failed.push('Functions: ' + total.functions.pct + '% < ' + thresholds.functions + '%');
              if (total.branches.pct < thresholds.branches)
                failed.push('Branches: ' + total.branches.pct + '% < ' + thresholds.branches + '%');

              if (failed.length > 0) {
                console.error('Coverage thresholds not met:');
                failed.forEach(f => console.error('  - ' + f));
                process.exit(1);
              }

              console.log('All coverage thresholds met!');
            "
          else
            echo "Coverage summary not found"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Golden Path: Integration tests using Docker
  golden-path:
    name: Golden Path (Smoke)
    runs-on: ubuntu-latest
    needs: [lint-check, coverage-gate]
    timeout-minutes: 30
    env:
      DOCKER_BUILDKIT: '1'
      COMPOSE_DOCKER_CLI_BUILD: '1'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Enable Corepack
        run: corepack enable

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_CACHE_FOLDER }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Configure pnpm store
        run: pnpm config set store-dir $PNPM_CACHE_FOLDER

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bootstrap repo (make bootstrap)
        run: make bootstrap

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('docker-compose.dev.yml', 'server/package.json', 'client/package.json') }}
          restore-keys: ${{ runner.os }}-buildx-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image (cached)
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile.dev
          tags: summit/api:ci
          push: false
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Build client image (cached)
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/Dockerfile.dev
          tags: summit/web:ci
          push: false
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # Move cache to prevent unbounded growth
      - name: Rotate Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

      - name: Bring up stack (make up)
        run: make up

      - name: Golden path smoke tests
        run: make smoke

      - name: Compose logs on failure
        if: failure()
        run: ./scripts/run-compose.sh -f docker-compose.dev.yml logs --tail=200

      - name: Tear down stack
        if: always()
        run: ./scripts/run-compose.sh -f docker-compose.dev.yml down -v

  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # Get diff stats
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)

          echo "PR Statistics:"
          echo "  Files changed: $FILES_CHANGED"
          echo "  Lines added: $ADDITIONS"
          echo "  Lines deleted: $DELETIONS"

          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))

          if [ "$TOTAL_CHANGES" -gt 1000 ]; then
            echo "::warning::Large PR detected ($TOTAL_CHANGES lines changed). Consider breaking into smaller PRs."
          fi

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "::warning::Many files changed ($FILES_CHANGED). Consider breaking into smaller PRs."
          fi
