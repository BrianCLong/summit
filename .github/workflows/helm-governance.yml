name: Helm governance and promotion

on:
  pull_request:
    paths:
      - 'helm/**'
      - 'charts/**'
      - '.github/workflows/helm-governance.yml'
      - 'scripts/helm/**'
  workflow_dispatch:
    inputs:
      image_repository:
        description: 'Image repository override for CI installs'
        required: false
        type: string
      image_tag:
        description: 'Image tag override for CI installs'
        required: false
        type: string

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  lint-and-template:
    name: Lint, template, and kubeconform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz \
            | sudo tar -xz -C /usr/local/bin kubeconform

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Lint charts/ with ct
        working-directory: charts
        env:
          CT_CONFIG: ct.yaml
        run: ct lint --config "$CT_CONFIG" --all

      - name: Lint helm/ with ct
        working-directory: helm
        env:
          CT_CONFIG: ct.yaml
        run: ct lint --config "$CT_CONFIG" --all

      - name: Render manifests for policy checks
        env:
          CI_IMAGE_REPOSITORY: ${{ inputs.image_repository || 'ghcr.io/stefanprodan/podinfo' }}
          CI_IMAGE_TAG: ${{ inputs.image_tag || '6.6.1' }}
        run: |
          mkdir -p artifacts/manifests
          scripts/helm/render-manifests.sh artifacts/manifests

      - name: Kubeconform rendered manifests
        run: kubeconform -summary -strict -ignore-missing-schemas artifacts/manifests/*.yaml

      - name: Upload rendered bundle
        uses: actions/upload-artifact@v4
        with:
          name: helm-manifests
          path: artifacts/manifests

  policy-scan:
    name: OPA and Kyverno policy scan
    runs-on: ubuntu-latest
    needs: lint-and-template
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: helm-manifests
          path: artifacts/manifests

      - name: Install conftest (OPA)
        uses: instrumenta/conftest-action@v1

      - name: Run OPA policy checks
        run: conftest test artifacts/manifests/*.yaml -p helm/policies/opa

      - name: Install Kyverno CLI
        run: |
          KYVERNO_VERSION=v1.12.0
          curl -L "https://github.com/kyverno/kyverno/releases/download/${KYVERNO_VERSION}/kyverno-cli_${KYVERNO_VERSION#v}_linux_x86_64.tar.gz" \
            | sudo tar -xz -C /usr/local/bin kyverno

      - name: Run Kyverno policies
        run: kyverno apply helm/policies/kyverno --resource artifacts/manifests/*.yaml --strict --audit-warnings=false

  kind-integration:
    name: Kind integration and smoke tests
    runs-on: ubuntu-latest
    needs: lint-and-template
    env:
      CI_IMAGE_REPOSITORY: ${{ inputs.image_repository || 'ghcr.io/stefanprodan/podinfo' }}
      CI_IMAGE_TAG: ${{ inputs.image_tag || '6.6.1' }}
      CI_NAMESPACE: helm-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          wait: 120s

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install ai-service with defaults
        run: |
          helm upgrade --install ai-service-default helm/ai-service \
            --namespace "$CI_NAMESPACE" \
            --create-namespace \
            --wait --timeout 5m0s \
            --set image.repository=${CI_IMAGE_REPOSITORY} \
            --set image.tag=${CI_IMAGE_TAG} \
            --set hpa.enabled=false --set serviceMonitor.enabled=false --set istio.enabled=false

      - name: Install ai-service with CI overrides
        run: |
          helm upgrade --install ai-service-override helm/ai-service \
            --namespace "$CI_NAMESPACE" \
            --create-namespace \
            --wait --timeout 5m0s \
            --values helm/ai-service/values.ci.yaml \
            --set image.repository=${CI_IMAGE_REPOSITORY} \
            --set image.tag=${CI_IMAGE_TAG}

      - name: Smoke tests
        env:
          NAMESPACE: ${{ env.CI_NAMESPACE }}
        run: charts/scripts/smoke-tests.sh

  docs-and-dashboards:
    name: Publish docs and dashboards
    runs-on: ubuntu-latest
    needs: lint-and-template
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install helm-docs
        run: |
          go install github.com/norwoodj/helm-docs/cmd/helm-docs@v1.13.1
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Generate helm docs bundle
        run: |
          mkdir -p artifacts/docs
          helm-docs --output-file README.md --output-dir artifacts/docs --chart-search-root charts --chart-search-root helm

      - name: Archive dashboards
        run: |
          mkdir -p artifacts/dashboards
          find charts -path "*/dashboards" -type d -print0 | xargs -0 -I {} cp -r {} artifacts/dashboards/
          tar -czf artifacts/dashboard-bundles.tar.gz -C artifacts dashboards

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: helm-governance-docs
          path: artifacts/docs

      - name: Upload dashboards
        uses: actions/upload-artifact@v4
        with:
          name: helm-dashboard-bundles
          path: artifacts/dashboard-bundles.tar.gz
