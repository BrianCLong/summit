name: Deploy to AWS

on:
  push:
    branches: ["main"]
  release:
    types: [published]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  EKS_CLUSTER: summit-prod-eks

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [maestro, prov-ledger, policy-lac]
        include:
          - service: maestro
            dockerfile: docker/Dockerfile.maestro
            context: .
            path: .
          - service: prov-ledger
            dockerfile: docker/Dockerfile.node
            context: .
            path: services/prov-ledger
          - service: policy-lac
            dockerfile: docker/Dockerfile.node
            context: .
            path: gateway/policy-lac

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e301518471c62803a63119ac606994770289f660 # v4.0.2
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Dependency Audit
        run: |
          if [ "${{ matrix.service }}" == "maestro" ]; then
            pip install safety && safety check
          else
            pnpm audit --audit-level=high
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@06990b21978a98f273e73481aa019a196fc90508 # v2

      - name: Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          trivy-config: trivy.yaml
          exit-code: "0" # Don't fail build yet, just report
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Build and Push Docker Image
        env:
          ECR_REPOSITORY: summit/${{ matrix.service }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -f ${{ matrix.dockerfile }} \
            --build-arg SERVICE_PATH=${{ matrix.path }} \
            ${{ matrix.context }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  deploy-infra:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a15682894f3640099451995ef08846f759c63284 # v3

      - name: Terraform Apply
        working-directory: terraform/environments/prod
        run: |
          terraform init
          terraform apply -auto-approve

  pre-deploy-gate:
    needs: deploy-infra
    uses: ./.github/workflows/_deploy.yml
    with:
      environment: prod

  deploy-k8s:
    needs: pre-deploy-gate
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e301518471c62803a63119ac606994770289f660 # v4.0.2
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }}

      - name: Deploy Manifests
        run: |
          # Deploy Maestro
          helm upgrade --install maestro charts/universal-app \
            --set image.repository=$ECR_REGISTRY/summit/maestro \
            --set image.tag=${{ github.sha }} \
            --set service.targetPort=8001 \
            --set ingress.enabled=true \
            --set ingress.hosts[0].host=api.summit.internal \
            --set ingress.hosts[0].paths[0].path=/maestro \
            --set ingress.hosts[0].paths[0].pathType=Prefix \
            --namespace default

          # Deploy Prov Ledger
          helm upgrade --install prov-ledger charts/universal-app \
            --set image.repository=$ECR_REGISTRY/summit/prov-ledger \
            --set image.tag=${{ github.sha }} \
            --set service.targetPort=4010 \
            --namespace default

          # Deploy Policy LAC
          helm upgrade --install policy-lac charts/universal-app \
            --set image.repository=$ECR_REGISTRY/summit/policy-lac \
            --set image.tag=${{ github.sha }} \
            --set service.targetPort=4000 \
            --namespace default

      - name: Post-Deployment Smoke Test
        run: |
          # Wait for rollout
          kubectl rollout status deployment/maestro --timeout=120s

          # Run the project's internal smoke test script
          # We use kubectl exec to run it from inside a pod or curl the ingress
          echo "Running Health Check..."
          ./scripts/verify-deployment.sh

          # Optional: Run app-level functional smoke tests
          # pnpm run test:smoke
