name: Governance CI

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  opa:
    name: OPA policy tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: OPA unit tests
        run: |
          opa version
          opa test governance/policies governance/tests -v

      - name: Demo eval (container policy)
        run: |
          cat > /tmp/container_input.json <<'JSON'
          {"image":{"user":"nonroot","vulnerabilities":[]}}
          JSON
          opa eval --format pretty -i /tmp/container_input.json -d governance/policies 'data.container.policy.deny'

  sbom:
    name: SBOM signature gate (cosign)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.6.0

      - name: Verify SBOM signature (non-blocking unless required)
        env:
          # Flip to 1 to hard-require signatures.
          REQUIRE_SBOM_SIGNATURE: "0"
        run: |
          cosign version
          chmod +x .ci/cosign-policy.sh
          ./.ci/cosign-policy.sh
