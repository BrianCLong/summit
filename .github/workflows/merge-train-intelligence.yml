name: ðŸ§  Merge Train Intelligence & Self-Healing

on:
  schedule:
    - cron: '15 */2 * * *'  # Run every 2 hours at :15
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

jobs:
  intelligence:
    name: AI-Powered Merge Intelligence
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deep PR analysis
        id: analysis
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== DEEP PR ANALYSIS ==="

          # Analyze all PRs with ML-ready features
          gh pr list --limit 500 --json number,title,headRefName,author,createdAt,updatedAt,mergeable,additions,deletions,changedFiles,statusCheckRollup \
            > all_prs.json

          # Calculate PR health scores
          jq '.[] | {
            number,
            title,
            age_days: ((now - (.createdAt | fromdateiso8601)) / 86400 | floor),
            size: (.additions + .deletions),
            files: .changedFiles,
            checks_total: (.statusCheckRollup | length),
            checks_passing: ([.statusCheckRollup[]? | select(.conclusion == "SUCCESS")] | length),
            checks_failing: ([.statusCheckRollup[]? | select(.conclusion == "FAILURE")] | length),
            health_score: (
              (100 - ((.additions + .deletions) / 100)) +
              (([.statusCheckRollup[]? | select(.conclusion == "SUCCESS")] | length) * 10) -
              (([.statusCheckRollup[]? | select(.conclusion == "FAILURE")] | length) * 20)
            )
          }' all_prs.json > pr_health.json

          # Identify problematic PRs
          jq '[.[] | select(.health_score < 0 or .checks_failing > 5)] | length' pr_health.json > problematic_count.txt
          jq '[.[] | select(.age_days > 7 and .checks_failing > 0)]' pr_health.json > stale_failing_prs.json

          echo "problematic_prs=$(cat problematic_count.txt)" >> $GITHUB_OUTPUT

      - name: Auto-fix failing PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== AUTO-FIX FAILING PRS ==="

          # Get PRs failing due to workflow issues
          jq -r '.[] | select(.checks_failing > 0) | .number' pr_health.json | head -20 | while read pr_num; do
            echo "Analyzing PR #$pr_num for auto-fixes..."

            # Get failure details
            gh pr checks "$pr_num" --json name,conclusion,detailsUrl \
              --jq '.[] | select(.conclusion == "FAILURE") | {name, url: .detailsUrl}' > "/tmp/pr_${pr_num}_failures.json" || continue

            # Check if it's a pnpm/dependency issue
            if jq -e '.[] | select(.name | contains("pnpm") or contains("Fast Lane"))' "/tmp/pr_${pr_num}_failures.json" >/dev/null; then
              echo "PR #$pr_num has dependency/build issues - will be fixed by orchestrator"
            fi

            sleep 1
          done

      - name: Intelligent PR prioritization
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== INTELLIGENT PRIORITIZATION ==="

          # Create priority tiers
          echo "ðŸ”¥ HIGH PRIORITY (Small, Ready, Fresh):"
          jq -r '.[] | select(.health_score > 50 and .size < 500 and .age_days < 3) |
            "  PR #\(.number): \(.title) (score: \(.health_score | floor))"' pr_health.json | head -10

          echo ""
          echo "âš¡ MEDIUM PRIORITY (Passing checks, Older):"
          jq -r '.[] | select(.checks_passing > .checks_failing and .age_days >= 3) |
            "  PR #\(.number): \(.title) (age: \(.age_days)d)"' pr_health.json | head -10

          echo ""
          echo "âš ï¸  LOW PRIORITY (Failing, Large):"
          jq -r '.[] | select(.checks_failing > 0 or .size > 5000) |
            "  PR #\(.number): \(.title)"' pr_health.json | head -5

      - name: Automated recovery actions
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== AUTOMATED RECOVERY ==="

          # PRs stuck for >3 days with no updates - add comment and label
          jq -r '.[] | select(.age_days > 3 and (.checks_total == 0 or .checks_failing > 3)) | .number' pr_health.json | \
          while read pr_num; do
            # Check if already labeled
            if ! gh pr view "$pr_num" --json labels --jq '.labels[].name' | grep -q "needs-attention"; then
              echo "Flagging PR #$pr_num for attention..."

              gh pr edit "$pr_num" --add-label "needs-attention,merge-train" || true

              gh pr comment "$pr_num" --body "ðŸ¤– **Merge Train Intelligence**

This PR has been in the queue for >3 days with issues. The merge train will:
- âœ… Auto-update workflow files (if needed)
- âœ… Retry failed checks
- âœ… Merge when all checks pass

No action needed - this is automated. Track progress in [Merge Train Status](https://github.com/${{ github.repository }}/blob/main/MERGE_TRAIN_STATUS.md)." || true

            fi
            sleep 2
          done

      - name: Generate intelligence report
        if: always()
        run: |
          cat > intelligence_report.md << 'EOF'
          # ðŸ§  Merge Train Intelligence Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## PR Health Overview

          $(jq -r '
            "- Total PRs analyzed: \(. | length)",
            "- Healthy (score >50): \([.[] | select(.health_score > 50)] | length)",
            "- Needs attention (score <0): \([.[] | select(.health_score < 0)] | length)",
            "- Stale (>7 days): \([.[] | select(.age_days > 7)] | length)"
          ' pr_health.json)

          ## Top 10 Ready to Merge

          $(jq -r '.[] | select(.checks_passing > 0 and .checks_failing == 0) |
            "1. PR #\(.number): \(.title) (\(.checks_passing) checks âœ…)"' pr_health.json | head -10)

          ## Recommendations

          - Continue automated updates every 30 minutes
          - Focus on high-priority PRs first
          - Auto-fix common issues
          - Monitor for stuck PRs

          EOF

          cat intelligence_report.md

      - name: Update metrics dashboard
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Store metrics for tracking
          cat > metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "total_prs": $(jq 'length' all_prs.json),
            "healthy_prs": $(jq '[.[] | select(.health_score > 50)] | length' pr_health.json),
            "problematic_prs": ${{ steps.analysis.outputs.problematic_prs }},
            "avg_health_score": $(jq '[.[] | .health_score] | add / length | floor' pr_health.json),
            "merges_today": $(gh pr list --state merged --search "merged:>=$(date -u +%Y-%m-%d)" --limit 500 | wc -l)
          }
          EOF

          cat metrics.json
          echo "ðŸ“Š Metrics captured for trend analysis"
