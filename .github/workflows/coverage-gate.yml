name: Test Coverage Gate

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

env:
  COVERAGE_THRESHOLD: 70
  COVERAGE_THRESHOLD_LINES: 70
  COVERAGE_THRESHOLD_BRANCHES: 70

jobs:
  coverage:
    name: Enforce Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage
        env:
          CI: true

      - name: Check coverage thresholds
        run: |
          echo "Checking coverage thresholds..."

          # Extract coverage from Jest output
          STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
          FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')
          LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')

          echo "Coverage Results:"
          echo "  Statements: ${STATEMENTS}%"
          echo "  Branches:   ${BRANCHES}%"
          echo "  Functions:  ${FUNCTIONS}%"
          echo "  Lines:      ${LINES}%"

          {
            echo "## Coverage summary"
            echo "| Metric | Coverage | Threshold |"
            echo "| --- | --- | --- |"
            echo "| Statements | ${STATEMENTS}% | ${COVERAGE_THRESHOLD}% |"
            echo "| Branches | ${BRANCHES}% | ${COVERAGE_THRESHOLD_BRANCHES}% |"
            echo "| Functions | ${FUNCTIONS}% | ${COVERAGE_THRESHOLD}% |"
            echo "| Lines | ${LINES}% | ${COVERAGE_THRESHOLD_LINES}% |"
          } >> "$GITHUB_STEP_SUMMARY"

          FAILED=0

          if (( $(echo "$STATEMENTS < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Statement coverage ${STATEMENTS}% is below threshold ${COVERAGE_THRESHOLD}%"
            FAILED=1
          fi

          if (( $(echo "$LINES < $COVERAGE_THRESHOLD_LINES" | bc -l) )); then
            echo "::error::Line coverage ${LINES}% is below threshold ${COVERAGE_THRESHOLD_LINES}%"
            FAILED=1
          fi

          if (( $(echo "$BRANCHES < $COVERAGE_THRESHOLD_BRANCHES" | bc -l) )); then
            echo "::error::Branch coverage ${BRANCHES}% is below threshold ${COVERAGE_THRESHOLD_BRANCHES}%"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo "::error::Coverage thresholds not met. Please add more tests."
            exit 1
          fi

          echo "::notice::All coverage thresholds met!"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

      - name: Generate coverage gap analysis
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = 'coverage/coverage-summary.json';
          const threshold = Number(process.env.COVERAGE_THRESHOLD);
          fs.mkdirSync('coverage', { recursive: true });

          if (!fs.existsSync(path)) {
            console.log('No coverage summary found for gap analysis.');
            process.exit(0);
          }

          const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
          const rows = Object.entries(summary)
            .filter(([file]) => file !== 'total')
            .map(([file, metrics]) => ({
              file,
              branches: metrics.branches?.pct ?? 0,
              functions: metrics.functions?.pct ?? 0,
              lines: metrics.lines?.pct ?? 0,
              statements: metrics.statements?.pct ?? 0,
            }))
            .map((entry) => ({ ...entry, min: Math.min(entry.branches, entry.functions, entry.lines, entry.statements) }))
            .filter((entry) => entry.min < threshold)
            .sort((a, b) => a.min - b.min)
            .slice(0, 10);

          let content = `## Coverage gap analysis (threshold ${threshold}%)\n`;
          if (!rows.length) {
            content += 'All tracked files meet or exceed the minimum coverage threshold.\n';
          } else {
            content += '| File | Branches | Functions | Lines | Statements |\n';
            content += '| --- | --- | --- | --- | --- |\n';
            content += rows
              .map((row) => `| ${row.file} | ${row.branches.toFixed(2)}% | ${row.functions.toFixed(2)}% | ${row.lines.toFixed(2)}% | ${row.statements.toFixed(2)}% |`)
              .join('\n');
          }

          fs.writeFileSync('coverage/gap-analysis.md', content);

          if (process.env.GITHUB_STEP_SUMMARY) {
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `\n${content}\n`);
          }
          NODE

      - name: Upload coverage gap analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-gap-analysis
          path: coverage/gap-analysis.md

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = summary.total;

            const body = `## Test Coverage Report

            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | Statements | ${total.statements.pct.toFixed(2)}% | ${process.env.COVERAGE_THRESHOLD}% | ${total.statements.pct >= process.env.COVERAGE_THRESHOLD ? '✅' : '❌'} |
            | Branches | ${total.branches.pct.toFixed(2)}% | ${process.env.COVERAGE_THRESHOLD_BRANCHES}% | ${total.branches.pct >= process.env.COVERAGE_THRESHOLD_BRANCHES ? '✅' : '❌'} |
            | Functions | ${total.functions.pct.toFixed(2)}% | ${process.env.COVERAGE_THRESHOLD}% | ${total.functions.pct >= process.env.COVERAGE_THRESHOLD ? '✅' : '❌'} |
            | Lines | ${total.lines.pct.toFixed(2)}% | ${process.env.COVERAGE_THRESHOLD_LINES}% | ${total.lines.pct >= process.env.COVERAGE_THRESHOLD_LINES ? '✅' : '❌'} |
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  coverage-diff:
    name: Coverage Diff Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get base coverage
        working-directory: base
        run: |
          pnpm install --frozen-lockfile
          pnpm test:coverage || true
          if [ -f coverage/coverage-summary.json ]; then
            cp coverage/coverage-summary.json /tmp/base-coverage.json
          else
            echo '{"total":{"statements":{"pct":0},"branches":{"pct":0},"functions":{"pct":0},"lines":{"pct":0}}}' > /tmp/base-coverage.json
          fi

      - name: Get PR coverage
        run: |
          pnpm install --frozen-lockfile
          pnpm test:coverage

      - name: Compare coverage
        run: |
          BASE_STMT=$(cat /tmp/base-coverage.json | jq '.total.statements.pct')
          PR_STMT=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          DIFF=$(echo "$PR_STMT - $BASE_STMT" | bc -l)

          echo "Coverage change: ${DIFF}%"

          if (( $(echo "$DIFF < -2" | bc -l) )); then
            echo "::error::Coverage decreased by more than 2%. Please add tests for new code."
            exit 1
          fi

          echo "::notice::Coverage change is acceptable (${DIFF}%)"
