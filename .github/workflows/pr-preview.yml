name: PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize]

concurrency:
  group: preview-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read
  pull-requests: write
  statuses: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.repository == 'summit/summit' && github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v4
          fetch-depth: 1
          submodules: false

      - name: Configure kubelogin
        run: ./scripts/preview/configure_kubelogin.sh

      - name: Build & push images
        run: ./scripts/preview/build_and_push.sh "${{ github.event.pull_request.number }}"

      - name: Deploy preview stack
        run: ./scripts/preview/deploy.sh "${{ github.event.pull_request.number }}"

      - name: Comment with preview URL
        run: ./scripts/preview/comment.sh "${{ github.event.pull_request.number }}"

      - name: Set status check
        if: always()
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -d '{"state":"success","description":"Preview environment ready","context":"preview/deployment"}'
