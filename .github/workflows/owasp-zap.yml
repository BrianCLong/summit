name: Security - OWASP ZAP

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run ZAP scans weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

# Ensure scan runs with necessary permissions

permissions:
  contents: read
  security-events: write
  issues: write

env:
  ZAP_VERSION: 'stable'

jobs:
  zap-baseline-web:
    name: ZAP Baseline - Web App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.12.0'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web application
        run: |
          cd apps/web
          pnpm run build || echo "Web build not configured"

      - name: Start web application
        run: |
          cd apps/web
          pnpm run start &
          echo $! > /tmp/web-app.pid
          
          # Wait for app to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 2; done' || echo "Health check skipped"
        continue-on-error: true

      - name: ZAP Baseline Scan - Web
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          fail_action: false
          allow_issue_writing: true
          artifact_name: 'zap-web-baseline-report'

      - name: Stop web application
        if: always()
        run: |
          if [ -f /tmp/web-app.pid ]; then
            kill $(cat /tmp/web-app.pid) || true
          fi

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-web-report-${{ github.sha }}
          path: |
            zap-web-baseline-report.html
            zap-web-baseline-report.json
            zap-web-baseline-report.md
          retention-days: 30

  zap-baseline-mobile:
    name: ZAP Baseline - Mobile Interface
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.12.0'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build mobile interface
        run: |
          cd apps/mobile-interface
          pnpm run build || echo "Mobile build not configured"
        continue-on-error: true

      - name: Start mobile interface
        run: |
          cd apps/mobile-interface
          pnpm run start &
          echo $! > /tmp/mobile-app.pid
          
          # Wait for app to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3001/health 2>/dev/null; do sleep 2; done' || echo "Health check skipped"
        continue-on-error: true

      - name: ZAP Baseline Scan - Mobile
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3001'
          cmd_options: '-a -j -l WARN'
          fail_action: false
          allow_issue_writing: true
          artifact_name: 'zap-mobile-baseline-report'
        continue-on-error: true

      - name: Stop mobile interface
        if: always()
        run: |
          if [ -f /tmp/mobile-app.pid ]; then
            kill $(cat /tmp/mobile-app.pid) || true
          fi

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-mobile-report-${{ github.sha }}
          path: |
            zap-mobile-baseline-report.html
            zap-mobile-baseline-report.json
            zap-mobile-baseline-report.md
          retention-days: 30
        continue-on-error: true

  zap-api-scan:
    name: ZAP API Scan - GraphQL/REST
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: summit_test
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

      redis:
        image: redis:7-alpine
        ports: ['6379:6379']
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.12.0'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start API server
        run: |
          cd server
          pnpm run start &
          echo $! > /tmp/api-server.pid
          
          # Wait for API to be ready
          timeout 60 bash -c 'until curl -f http://localhost:4000/health 2>/dev/null; do sleep 2; done'
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/summit_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

      - name: ZAP API Scan
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'http://localhost:4000/graphql'
          format: 'graphql'
          cmd_options: '-a -j -l WARN'
          fail_action: false
          allow_issue_writing: true
          artifact_name: 'zap-api-scan-report'

      - name: Stop API server
        if: always()
        run: |
          if [ -f /tmp/api-server.pid ]; then
            kill $(cat /tmp/api-server.pid) || true
          fi

      - name: Upload ZAP API Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-report-${{ github.sha }}
          path: |
            zap-api-scan-report.html
            zap-api-scan-report.json
            zap-api-scan-report.md
          retention-days: 30

  zap-results-summary:
    name: ZAP Results Summary
    runs-on: ubuntu-latest
    needs: [zap-baseline-web, zap-baseline-mobile, zap-api-scan]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "# OWASP ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ needs.zap-baseline-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile Interface | ${{ needs.zap-baseline-mobile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API (GraphQL/REST) | ${{ needs.zap-api-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
