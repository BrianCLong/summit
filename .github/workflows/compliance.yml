name: Compliance

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  restricted-path-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - uses: actions/setup-node@v4
        with:
          cache: 'pnpm'
          node-version: '20'

      - name: Check Restricted Paths
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Load contract
            let contract;
            try {
              const contractContent = fs.readFileSync('agent-contract.json', 'utf8');
              contract = JSON.parse(contractContent);
            } catch (error) {
              core.setFailed('Failed to parse agent-contract.json: ' + error.message);
              return;
            }

            const restrictedAreas = contract.restrictedAreas || [];
            const restrictedPrefixes = restrictedAreas.flatMap(area => area.paths);

            // Check for specific override labels from contract
            const overrideLabels = restrictedAreas.map(area => area.overrideLabel).filter(Boolean);
            const overrideToken = '"restricted_override": true';

            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(label => label.name);
            const hasOverride = labels.some(l => overrideLabels.includes(l)) || (pr.body || '').includes(overrideToken);

            if (hasOverride) {
              core.info('Override detected via label or metadata token; restricted path check skipped.');
              return;
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            const violations = files
              .map(file => file.filename)
              .filter(name => restrictedPrefixes.some(prefix => name.startsWith(prefix)));

            if (violations.length > 0) {
              const message = `Restricted paths modified without override: ${violations.join(', ')}. ` +
                `Add a relevant override label or include ${overrideToken} in the AGENT-METADATA block with justification.`;
              core.setFailed(message);
            } else {
              core.info('No restricted path changes detected.');
            }

  drift-detection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - uses: actions/setup-node@v4
        with:
          cache: 'pnpm'
          node-version: '20'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for configuration drift
        run: |
          # Placeholder
          echo "Checking for config drift..."
