name: Pre-Release Health Check

# UNIFIED RELEASE READINESS VERIFICATION
# Aggregates all CI audit results into a single pass/fail status.
#
# See docs/ci/PRE_RELEASE_HEALTH.md for full documentation.

on:
  # Before any release tag
  push:
    tags:
      - "v*"
      - "rc-*"

  # Scheduled check before business hours
  schedule:
    - cron: "0 5 * * 1-5" # 5 AM UTC, Mon-Fri

  # Manual trigger
  workflow_dispatch:
    inputs:
      strict:
        description: "Fail on any warning"
        type: boolean
        default: false
      run_fresh:
        description: "Run all audits fresh before check"
        type: boolean
        default: false

  # Can be called by release workflow
  workflow_call:
    inputs:
      strict:
        type: boolean
        default: false
    outputs:
      status:
        description: "Health check status (PASS/WARN/FAIL)"
        value: ${{ jobs.health-check.outputs.status }}
      score:
        description: "Health score percentage"
        value: ${{ jobs.health-check.outputs.score }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: read

jobs:
  run-fresh-audits:
    name: Run Fresh Audits
    runs-on: ubuntu-latest
    if: inputs.run_fresh == true

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-# version handled by package.json
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Dependency Audit
        run: ./scripts/release/dependency_audit.sh --threshold high || true
        continue-on-error: true

      - name: Run Type Safety Audit
        run: ./scripts/release/type_safety_audit.sh || true
        continue-on-error: true

  health-check:
    name: Aggregate Health Check
    runs-on: ubuntu-latest
    needs: [run-fresh-audits]
    if: always()
    outputs:
      status: ${{ steps.check.outputs.status }}
      score: ${{ steps.check.outputs.score }}
      passed: ${{ steps.check.outputs.passed }}
      failed: ${{ steps.check.outputs.failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Run Health Check
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/release/pre_release_health_check.sh

          ARGS="--report"
          if [[ "${{ inputs.strict }}" == "true" ]]; then
            ARGS="$ARGS --strict"
          fi

          # Run check and capture exit code
          EXIT_CODE=0
          ./scripts/release/pre_release_health_check.sh $ARGS --json > health_result.json || EXIT_CODE=$?

          # Parse results
          STATUS=$(jq -r '.status' health_result.json)
          SCORE=$(jq -r '.health_score' health_result.json)
          PASSED=$(jq -r '.summary.passed' health_result.json)
          FAILED=$(jq -r '.summary.failed' health_result.json)

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Output summary to console
          cat health_result.json | jq .

          exit $EXIT_CODE

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4 # v6
        with:
          name: health-check-report-${{ github.run_id }}
          path: |
            artifacts/health-check/
            health_result.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Job Summary
        if: always()
        run: |
          STATUS="${{ steps.check.outputs.status || 'UNKNOWN' }}"
          SCORE="${{ steps.check.outputs.score || 0 }}"
          PASSED="${{ steps.check.outputs.passed || 0 }}"
          FAILED="${{ steps.check.outputs.failed || 0 }}"

          STATUS_EMOJI="❓"
          [[ "$STATUS" == "PASS" ]] && STATUS_EMOJI="✅"
          [[ "$STATUS" == "WARN" ]] && STATUS_EMOJI="⚠️"
          [[ "$STATUS" == "FAIL" ]] && STATUS_EMOJI="❌"

          echo "### $STATUS_EMOJI Pre-Release Health Check: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health Score:** $SCORE%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f health_result.json ]]; then
            echo "### Individual Checks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.checks | to_entries[] | "| \(.key) | \(.value) |"' health_result.json >> $GITHUB_STEP_SUMMARY
          fi

  block-release:
    name: Block Release on Failure
    runs-on: ubuntu-latest
    needs: health-check
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/v') &&
      needs.health-check.outputs.status == 'FAIL'

    steps:
      - name: Fail Release
        run: |
          echo "❌ Pre-Release Health Check FAILED"
          echo ""
          echo "The following issues must be resolved before release:"
          echo "- Health Score: ${{ needs.health-check.outputs.score }}%"
          echo "- Failed Checks: ${{ needs.health-check.outputs.failed }}"
          echo ""
          echo "Run the health check locally to see details:"
          echo "  ./scripts/release/pre_release_health_check.sh --report"
          exit 1
