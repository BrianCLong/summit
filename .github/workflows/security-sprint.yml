name: Security Sprint Scans

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read
  issues: write
  actions: read
  security-events: write
  checks: write

env:
  REPORT_DIR: security-reports
  SNYK_FAIL_THRESHOLD: high

jobs:
  secret-scan:
    name: Secret scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7
        with:
          fetch-depth: 0
      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"
      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc # v2
        with:
          args: detect --source . --report-format sarif --report-path ${{ env.REPORT_DIR }}/gitleaks.sarif
      - name: Upload SARIF to GitHub Security
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/gitleaks.sarif
      - name: Persist report artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: security-reports
          path: ${{ env.REPORT_DIR }}/gitleaks.sarif

  sast:
    name: Static application security testing (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [javascript, python]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7
      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild (best effort)
        uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        continue-on-error: true
      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          category: "/language:${{ matrix.language }}"

  semgrep:
    name: Semgrep policy-as-code (SAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7
      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"
      - name: Run Semgrep CI ruleset
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1
        with:
          config: p/ci
          generateSarif: true
          sarifFile: ${{ env.REPORT_DIR }}/semgrep.sarif
          auditOn: push
      - name: Upload Semgrep SARIF
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/semgrep.sarif
      - name: Persist Semgrep report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: security-reports
          path: ${{ env.REPORT_DIR }}/semgrep.sarif

  dependency-scan:
    name: Dependency vulnerability scan (Snyk)
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7
      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"
      - name: Ensure SNYK_TOKEN is configured
        run: |
          if [ -z "${SNYK_TOKEN:-}" ]; then
            echo "SNYK_TOKEN secret is required for dependency scanning." >&2
            exit 1
          fi
      - name: Run Snyk test across all manifests
        uses: snyk/actions/node@9adf32b1121593767fc3c057af55b55db032dc04 # 1.0.0
        with:
          command: test
          args: >-
            --all-projects
            --severity-threshold=${{ env.SNYK_FAIL_THRESHOLD }}
            --fail-on=all
            --sarif-file-output=${{ env.REPORT_DIR }}/snyk.sarif
      - name: Upload Snyk SARIF
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/snyk.sarif
      - name: Persist Snyk report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: security-reports
          path: ${{ env.REPORT_DIR }}/snyk.sarif

  filesystem-scan:
    name: File system vulnerability scan (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7
      - name: Install Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1 # v0.2.4
      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"
      - name: Run Trivy FS scan
        run: |
          trivy fs \
            --scanners vuln,secret,misconfig \
            --ignore-unfixed \
            --exit-code 1 \
            --format sarif \
            --output "$REPORT_DIR/trivy-fs.sarif" \
            .
      - name: Upload filesystem SARIF
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/trivy-fs.sarif
      - name: Persist filesystem report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: security-reports
          path: ${{ env.REPORT_DIR }}/trivy-fs.sarif

  container-scan:
    name: Container image scan (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7
      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"
      - name: Build server image for scanning
        run: docker build -t security-suite/server ./server
      - name: Build client image for scanning
        run: docker build -t security-suite/client ./client
      - name: Scan server image
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # 0.16.0
        with:
          image-ref: security-suite/server
          format: sarif
          output: ${{ env.REPORT_DIR }}/trivy-server.sarif
          severity: HIGH,CRITICAL
          ignore-unfixed: true
      - name: Upload server SARIF
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/trivy-server.sarif
      - name: Scan client image
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # 0.16.0
        with:
          image-ref: security-suite/client
          format: sarif
          output: ${{ env.REPORT_DIR }}/trivy-client.sarif
          severity: HIGH,CRITICAL
          ignore-unfixed: true
      - name: Upload client SARIF
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/trivy-client.sarif
      - name: Persist container reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: security-reports
          path: |
            ${{ env.REPORT_DIR }}/trivy-server.sarif
            ${{ env.REPORT_DIR }}/trivy-client.sarif

  security-summary:
    name: Aggregate security coverage
    runs-on: ubuntu-latest
    needs:
      - secret-scan
      - sast
      - semgrep
      - dependency-scan
      - filesystem-scan
      - container-scan
    if: ${{ always() }}
    steps:
      - name: Download all security reports
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: security-reports
          path: aggregated-security
          merge-multiple: true
          if-no-artifact-found: warn
      - name: Generate coverage metrics
        id: metrics
        env:
          SECRET_STATUS: ${{ needs.secret-scan.result }}
          SAST_STATUS: ${{ needs.sast.result }}
          SEMGREP_STATUS: ${{ needs.semgrep.result }}
          DEP_STATUS: ${{ needs.dependency-scan.result }}
          FS_STATUS: ${{ needs.filesystem-scan.result }}
          IMG_STATUS: ${{ needs.container-scan.result }}
        run: |
          python - <<'PY'
            import json
            import os
            from pathlib import Path

            report_root = Path('aggregated-security')
            files = sorted(str(p.relative_to(report_root)) for p in report_root.rglob('*') if p.is_file())
            status = {
                "Secret scanning": os.environ.get('SECRET_STATUS', 'unknown'),
                "SAST": os.environ.get('SAST_STATUS', 'unknown'),
                "Semgrep": os.environ.get('SEMGREP_STATUS', 'unknown'),
                "Dependencies": os.environ.get('DEP_STATUS', 'unknown'),
                "Filesystem": os.environ.get('FS_STATUS', 'unknown'),
                "Container": os.environ.get('IMG_STATUS', 'unknown'),
            }
            summary = {
                "reportCount": len(files),
                "reports": files,
                "statuses": status,
            }
            report_root.mkdir(parents=True, exist_ok=True)
            with (report_root / 'security-summary.json').open('w', encoding='utf-8') as fh:
                json.dump(summary, fh, indent=2)
          PY
      - name: Publish job summary
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const summaryFile = path.join(process.cwd(), 'aggregated-security', 'security-summary.json');
            const payload = JSON.parse(fs.readFileSync(summaryFile, 'utf8'));
            const rows = Object.entries(payload.statuses).map(([k, v]) => ({status: v, name: k}));
            core.summary
              .addHeading('Security & Compliance Coverage')
              .addTable([
                [{data: 'Control', header: true}, {data: 'Status', header: true}],
                ...rows.map(({name, status}) => [name, status])
              ])
              .addHeading('Artifacts')
              .addList(payload.reports)
              .write();
      - name: Upload aggregated summary
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: security-reports
          path: aggregated-security/security-summary.json
