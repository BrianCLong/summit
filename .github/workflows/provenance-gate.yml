name: Provenance Gate

on:
  pull_request:
    branches: [main]
    paths:
      - 'policy/supply_chain.rego'
      - 'scripts/ci/enforce-provenance.sh'
      - '.github/workflows/provenance-gate.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  provenance-enforcement:
    name: Enforce Supply Chain Provenance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: Run Provenance Gate
        run: |
          # Note: In a real PR, the evidence bundle would be generated by a previous build step.
          # For this gate validation, we ensure the policy itself is sound.
          # If this was a release trigger, we would point to the real manifest.
          echo "Verifying provenance policy integrity..."
          opa test policy/ -v

          # Check if we have evidence to validate (only on release or when explicitly provided)
          if [ -f "evidence/provenance-input.json" ]; then
            bash scripts/ci/enforce-provenance.sh evidence/provenance-input.json
          else
            echo "ℹ️ No evidence bundle found to validate. Skipping runtime check, policy verified."
          fi
