name: Release Gate

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  release-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version is read from package.json packageManager field

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Targeted Tests
        run: |
          echo "Running release script tests..."
          if [ -f scripts/verify-evidence-bundle.test.ts ]; then
            npx tsx scripts/verify-evidence-bundle.test.ts
          else
            echo "Skipping tests: scripts/verify-evidence-bundle.test.ts not found"
          fi

      - name: Run Release Gate
        run: |
          pnpm release:bundle -- \
            --tag v0.0.0-pr.${{ github.event.pull_request.number || github.run_id }} \
            --override-freeze \
            --override-reason "PR gate run"

      - name: Write Release Review Summary
        if: always()
        run: node scripts/ci/write_release_review_summary.mjs
        env:
          ARTIFACTS_DIR: artifacts/release-review
          CHANNEL: ${{ github.event.inputs.channel || 'unknown' }}
          # Artifact paths can be overridden here if needed
          ARTIFACT_BUNDLE: dist/release/release-manifest.json
          ARTIFACT_DASHBOARD: dist/release/release-status.json
          ARTIFACT_CHECKLIST: dist/release/check-checklist.md
          ARTIFACT_NOTES: dist/release/release-notes.md
          ARTIFACT_WAIVERS: dist/release/waivers.md
          ARTIFACT_PLAN: dist/release/cut-plan.md

      - name: Upload Release Review Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-review-summary
          path: artifacts/release-review/
          retention-days: 7

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryPath = 'artifacts/release-review/summary.md';
            if (!fs.existsSync(summaryPath)) {
              console.log('Summary file not found, skipping comment update.');
              return;
            }
            const summaryBody = fs.readFileSync(summaryPath, 'utf8');
            const marker = '<!-- RELEASE_REVIEW_SUMMARY -->';
            const body = `${marker}\n${summaryBody}`;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            // Pagination to ensure we find existing comments in long threads
            let botComment = null;
            let page = 1;
            const per_page = 100;

            while (!botComment) {
              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number,
                per_page,
                page,
              });

              if (comments.data.length === 0) break;

              botComment = comments.data.find(comment =>
                comment.body.includes(marker) && comment.user.type === 'Bot'
              );

              page++;
            }

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body,
              });
              console.log(`Updated comment ${botComment.id}`);
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
              console.log('Created new comment');
            }

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle-pr-${{ github.event.pull_request.number || github.run_id }}
          path: dist/release/
          retention-days: 7
