name: UX Governance

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, labeled, unlabeled]

jobs:
  enforce-classification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check PR Semantic Versioning
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              console.log("Not a pull request, skipping.");
              return;
            }
            const labels = pr.labels.map(l => l.name);
            const title = pr.title;
            const classificationLabels = ['patch', 'minor', 'major'];

            console.log(`Title: ${title}`);
            console.log(`Current Labels: ${JSON.stringify(labels)}`);

            let hasClassification = labels.some(l => classificationLabels.includes(l));

            // Auto-infer from title if no classification label is present
            if (!hasClassification) {
              console.log("No classification label found. Attempting inference from title...");
              if (title.startsWith('feat:')) {
                labels.push('minor');
                console.log("Inferred 'minor' from 'feat:' prefix");
              }
              else if (title.startsWith('fix:')) {
                labels.push('patch');
                console.log("Inferred 'patch' from 'fix:' prefix");
              }
              else if (title.startsWith('docs:')) {
                labels.push('patch');
                console.log("Inferred 'patch' from 'docs:' prefix");
              }
              else if (title.startsWith('chore:')) {
                labels.push('patch');
                console.log("Inferred 'patch' from 'chore:' prefix");
              }
              else if (title.includes('BREAKING CHANGE')) {
                labels.push('major');
                console.log("Inferred 'major' from 'BREAKING CHANGE' in title");
              }

              // Re-evaluate
              hasClassification = labels.some(l => classificationLabels.includes(l));
            }

            if (!hasClassification) {
              core.setFailed("PR must have a classification label (patch, minor, or major) or use conventional commit prefixes (feat:, fix:, chore:, docs:) in the title.");
            } else {
              console.log("PR classification check passed.");
            }
