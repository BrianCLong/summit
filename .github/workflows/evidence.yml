name: evidence-gates

on:
  pull_request:
    paths:
      - "docs/tech-radar/**"
      - "docs/cogwar/**"
      - "schemas/cogwar/**"
      - "policy/**"
      - "evidence/**"
      - "tools/evidence/verify_evidence.py"
      - "tests/iw/**"
      - "tests/policy/**"
      - "tests/provenance/**"
      - "tests/tech_radar/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify_evidence_and_policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: python -m pip install --upgrade pip jsonschema pytest
      - name: Verify evidence and policy
        run: python tools/evidence/verify_evidence.py
      - name: Run cogwar contract tests
        run: |
          TEST_DIRS=()
          for d in tests/policy tests/iw tests/provenance tests/tech_radar; do
            if [ -d "$d" ]; then
              TEST_DIRS+=("$d")
            fi
          done
          if [ "${#TEST_DIRS[@]}" -eq 0 ]; then
            echo "No cogwar contract test directories present; skipping pytest step."
            exit 0
          fi
          pytest "${TEST_DIRS[@]}"
