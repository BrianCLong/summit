name: Golden Path Supply Chain

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.merge_group.head_sha || github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: write
  packages: write
  id-token: write
  attestations: write

jobs:
  build-server:
    if: ${{ github.event_name == 'merge_group' || github.event_name == 'push' || (github.event_name == 'pull_request' && vars.MERGE_SURGE != 'true') }}
    name: Build Server (SLSA L3)
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: server
      dockerfile: server/Dockerfile
      context: .
      push: ${{ github.event_name == 'push' }}
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  build-client:
    if: ${{ github.event_name == 'merge_group' || github.event_name == 'push' || (github.event_name == 'pull_request' && vars.MERGE_SURGE != 'true') }}
    name: Build Client (SLSA L3)
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: client
      dockerfile: client/Dockerfile
      context: .
      push: ${{ github.event_name == 'push' }}
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit
