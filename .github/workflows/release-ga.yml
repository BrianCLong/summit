name: GA Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write # For OIDC/Cosign if needed

jobs:
  release-pipeline:
    name: GA Release Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # P1: Verification Gates (Tests & Policy)
      - name: Run Server Tests
        run: npm run test:server
        continue-on-error: false

      - name: Run Policy Checks
        run: ./scripts/policy-test.sh
        continue-on-error: false

      - name: Verify Documentation Completeness
        run: ./scripts/check_traceability.cjs
        continue-on-error: false

      # Collect Test Artifacts (Simulated/Actual)
      - name: Collect Test Results
        run: |
          mkdir -p evidence/ga/test-results
          # Assuming test runners output to standard locations
          if [ -f junit.xml ]; then cp junit.xml evidence/ga/test-results/; fi
          if [ -f coverage/coverage-summary.json ]; then cp coverage/coverage-summary.json evidence/ga/test-results/; fi

      # P1: Deterministic Build & Artifact Generation
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.15.8

      - name: Build Server Image
        id: build-server
        run: |
          echo "Building Server..."
          # docker build ...
          echo "image=ghcr.io/${{ github.repository }}/server:${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Build Client Image
        id: build-client
        run: |
          echo "Building Client..."
          # docker build ...
          echo "image=ghcr.io/${{ github.repository }}/client:${{ github.ref_name }}" >> $GITHUB_OUTPUT

      # P1: SBOM Generation
      - name: Generate SBOMs
        run: ./scripts/compliance/generate_sbom.sh compliance/sbom

      # P2: Evidence Collection
      - name: Collect Evidence Bundle
        run: ./scripts/compliance/generate_evidence_bundle.sh evidence/ga

      # P1: Artifact Signing
      - name: Sign Evidence
        env:
          COSIGN_KEY_CONTENT: ${{ secrets.COSIGN_PRIVATE_KEY }}
          EVIDENCE_DIR: evidence/ga
        run: |
          if [ -n "$COSIGN_KEY_CONTENT" ]; then
            echo "$COSIGN_KEY_CONTENT" > cosign.key
            # Pass the filename, not the content
            export COSIGN_KEY=cosign.key
            ./scripts/sign-evidence.sh
            rm cosign.key
          else
            echo "Skipping signing (no key provided)"
          fi

      - name: Archive Release Bundle
        run: |
          tar -czf release-bundle.tar.gz evidence/ga compliance/sbom

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: release-bundle.tar.gz

      # P1: Release Notes & Publish
      - name: Generate Release Notes
        id: notes
        run: |
          # Simple placeholder notes
          echo "notes=GA Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-bundle.tar.gz
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
          generate_release_notes: true
