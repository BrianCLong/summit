name: GA Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write # For OIDC/Cosign if needed

env:
  EXPECTED_OIDC_ISSUER: https://token.actions.githubusercontent.com
  EXPECTED_OIDC_SUBJECT: https://github.com/${{ github.repository }}/.github/workflows/_reusable-slsa-build.yml@${{ github.ref }}

jobs:
  test-and-verify:
    name: Verification Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Server Tests
        run: pnpm test:server
        continue-on-error: false

      - name: Run Policy Checks
        run: ./scripts/policy-test.sh
        continue-on-error: false

      - name: Verify Documentation Completeness
        run: ./scripts/check_traceability.cjs
        continue-on-error: false

  build-server:
    name: Build Server
    needs: test-and-verify
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: server
      dockerfile: server/Dockerfile
      context: .
      push: true
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  build-client:
    name: Build Client
    needs: test-and-verify
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: client
      dockerfile: client/Dockerfile
      context: .
      push: true
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  verify-provenance:
    name: Verify signatures and provenance
    needs: [build-server, build-client]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
      attestations: read
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: v2.2.4

      - name: Verify server signature
        env:
          IMAGE: ${{ needs.build-server.outputs.image_uri }}
        run: cosign verify "$IMAGE" --certificate-identity "${EXPECTED_OIDC_SUBJECT}" --certificate-oidc-issuer "${EXPECTED_OIDC_ISSUER}"

      - name: Verify client signature
        env:
          IMAGE: ${{ needs.build-client.outputs.image_uri }}
        run: cosign verify "$IMAGE" --certificate-identity "${EXPECTED_OIDC_SUBJECT}" --certificate-oidc-issuer "${EXPECTED_OIDC_ISSUER}"

      - name: Verify SLSA provenance for server image
        uses: slsa-framework/slsa-verifier/actions/verify-image@v2.5.1
        with:
          image-ref: ${{ needs.build-server.outputs.image_uri }}
          certificate-oidc-issuer: ${{ env.EXPECTED_OIDC_ISSUER }}
          builder-id: https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
          source-uri: https://github.com/${{ github.repository }}

      - name: Verify SLSA provenance for client image
        uses: slsa-framework/slsa-verifier/actions/verify-image@v2.5.1
        with:
          image-ref: ${{ needs.build-client.outputs.image_uri }}
          certificate-oidc-issuer: ${{ env.EXPECTED_OIDC_ISSUER }}
          builder-id: https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
          source-uri: https://github.com/${{ github.repository }}

      - name: Enforce builder metadata attestations
        env:
          SERVER_IMAGE: ${{ needs.build-server.outputs.image_uri }}
          CLIENT_IMAGE: ${{ needs.build-client.outputs.image_uri }}
          SERVER_BUILDER_DIGEST: ${{ needs.build-server.outputs.builder-digest }}
          CLIENT_BUILDER_DIGEST: ${{ needs.build-client.outputs.builder-digest }}
          EXPECTED_OIDC_SUBJECT: ${{ env.EXPECTED_OIDC_SUBJECT }}
          EXPECTED_OIDC_ISSUER: ${{ env.EXPECTED_OIDC_ISSUER }}
        run: |
          set -euo pipefail

          verify_attestation() {
            local image="$1"
            local name="$2"
            local expected_digest="$3"

            cosign verify-attestation "$image" \
              --type summit.builder.metadata \
              --certificate-identity "${EXPECTED_OIDC_SUBJECT}" \
              --certificate-oidc-issuer "${EXPECTED_OIDC_ISSUER}" \
              --output-file "${name}-attestations.jsonl"

            python -c "import base64,json,sys; expected=sys.argv[1]; path=sys.argv[2]; envelopes=[json.loads(line) for line in open(path, encoding='utf-8') if line.strip()]; assert envelopes, 'No attestations returned for target'; valid=any((lambda p: p.get('builderDigest')==expected and p.get('buildTimestamp'))(json.loads(base64.b64decode(env['payload'])).get('predicate', {})) for env in envelopes); sys.exit(0 if valid else 1)" "$expected_digest" "${name}-attestations.jsonl"
          }

          verify_attestation "${SERVER_IMAGE}" server "${SERVER_BUILDER_DIGEST}"
          verify_attestation "${CLIENT_IMAGE}" client "${CLIENT_BUILDER_DIGEST}"

  release:
    name: Create Release
    needs: [build-server, build-client, verify-provenance]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Server Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-server-${{ github.run_id }}
          path: evidence/server

      - name: Download Client Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-client-${{ github.run_id }}
          path: evidence/client

      - name: Collect release assets
        run: |
          mkdir -p release-assets
          cp evidence/server/sbom.cdx.json release-assets/server-sbom.cdx.json
          cp evidence/client/sbom.cdx.json release-assets/client-sbom.cdx.json
          cp evidence/server/sbom.spdx.json release-assets/server-sbom.spdx.json
          cp evidence/client/sbom.spdx.json release-assets/client-sbom.spdx.json
          cp evidence/server/builder-metadata.json release-assets/server-builder-metadata.json
          cp evidence/client/builder-metadata.json release-assets/client-builder-metadata.json
          cp evidence/server/sbom-metadata.json release-assets/server-sbom-metadata.json
          cp evidence/client/sbom-metadata.json release-assets/client-sbom-metadata.json

      - name: Create Evidence Bundle
        run: |
          tar -czf release-assets/evidence.tar.gz evidence/

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: v2.2.4

      - name: Sign release assets
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          for file in release-assets/*; do
            cosign sign-blob --yes "$file" \
              --output-signature "$file.sig" \
              --output-certificate "$file.pem"
          done

      - name: Generate Release Notes
        id: notes
        run: |
          echo "notes=GA Release ${{ github.ref_name }} (SLSA L3 Compliant)" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/evidence.tar.gz
            release-assets/evidence.tar.gz.sig
            release-assets/evidence.tar.gz.pem
            release-assets/server-sbom.cdx.json
            release-assets/server-sbom.cdx.json.sig
            release-assets/server-sbom.cdx.json.pem
            release-assets/client-sbom.cdx.json
            release-assets/client-sbom.cdx.json.sig
            release-assets/client-sbom.cdx.json.pem
            release-assets/server-sbom.spdx.json
            release-assets/server-sbom.spdx.json.sig
            release-assets/server-sbom.spdx.json.pem
            release-assets/client-sbom.spdx.json
            release-assets/client-sbom.spdx.json.sig
            release-assets/client-sbom.spdx.json.pem
            release-assets/server-builder-metadata.json
            release-assets/server-builder-metadata.json.sig
            release-assets/server-builder-metadata.json.pem
            release-assets/client-builder-metadata.json
            release-assets/client-builder-metadata.json.sig
            release-assets/client-builder-metadata.json.pem
            release-assets/server-sbom-metadata.json
            release-assets/server-sbom-metadata.json.sig
            release-assets/server-sbom-metadata.json.pem
            release-assets/client-sbom-metadata.json
            release-assets/client-sbom-metadata.json.sig
            release-assets/client-sbom-metadata.json.pem
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
          generate_release_notes: true
