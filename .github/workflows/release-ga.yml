name: GA Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (if different from ref)"
        required: false
        type: string
      dry_run:
        description: "Validate release process without publishing"
        type: boolean
        default: false
        required: false
      override_freeze:
        description: "Override release freeze window?"
        type: boolean
        default: false
        required: false
      override_reason:
        description: "Reason for override (min 20 chars)"
        type: string
        default: ""
        required: false

concurrency:
  group: release-${{ inputs.tag || github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  id-token: write # For OIDC/Cosign if needed

jobs:
  test-and-verify:
    name: Verification Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Preflight Release
        run: node scripts/release/preflight-release.mjs

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Test Release Scripts
        run: pnpm -w test:release-scripts

      - name: Check Release Freeze Window
        env:
          OVERRIDE: ${{ inputs.override_freeze || 'false' }}
          OVERRIDE_REASON: ${{ inputs.override_reason || '' }}
        run: node scripts/release/check-freeze.mjs

      - name: Upload Freeze Evidence
        uses: actions/upload-artifact@v4
        with:
          name: freeze-evidence
          path: dist/release/freeze.json

      - name: Run Server Tests
        run: |
          mkdir -p dist/release
          if pnpm test:server; then
            echo '{"ok": true}' > dist/release/verify.json
          else
            echo '{"ok": false, "code": "VERIFY_FAILED"}' > dist/release/verify.json
            exit 1
          fi
        continue-on-error: false

      - name: Run Policy Checks
        run: |
          if ./scripts/policy-test.sh; then
            echo '{"ok": true}' > dist/release/preflight.json
          else
            echo '{"ok": false, "code": "SECURITY_GUARD"}' > dist/release/preflight.json
            exit 1
          fi
        continue-on-error: false

      - name: Verify Documentation Completeness
        run: ./scripts/check_traceability.cjs
        continue-on-error: false

      - name: Check Freeze Window
        if: always()
        run: |
          mkdir -p dist/release
          if ./scripts/check-freeze.sh; then
            echo '{"ok": true}' > dist/release/freeze.json
          else
            echo '{"ok": false, "code": "FREEZE_WINDOW", "message": "Freeze window is active"}' > dist/release/freeze.json
          fi

      - name: Generate Release Status
        if: always()
        run: node scripts/release/build-release-status.mjs

      - name: Validate Release Schemas
        if: always()
        run: node scripts/release/validate-bundle-schemas.mjs --dir dist/release --strict

      - name: Upload Release Status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-status
          path: dist/release/release-status.json

  build-server:
    name: Build Server
    needs: test-and-verify
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: server
      dockerfile: server/Dockerfile
      context: .
      push: true
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  build-client:
    name: Build Client
    needs: test-and-verify
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: client
      dockerfile: client/Dockerfile
      context: .
      push: true
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  release:
    name: Create Release
    needs: [build-server, build-client]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Server Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-server-${{ github.run_id }}
          path: evidence/server

      - name: Download Client Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-client-${{ github.run_id }}
          path: evidence/client

      - name: Download Freeze Evidence
        uses: actions/download-artifact@v4
        with:
          name: freeze-evidence
          path: evidence/freeze

      - name: Download Release Status
        uses: actions/download-artifact@v4
        with:
          name: release-status
          path: evidence/release

      - name: Create Evidence Bundle
        run: |
          mkdir -p release-assets

          # Generate Checksums for all evidence (This creates evidence/SHA256SUMS)
          # Use deterministic sorting to ensure stable hash
          cd evidence
          find . -type f ! -name SHA256SUMS -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS
          cd ..

          # Verify Evidence Linkage
          # We compare the digest of the generated artifacts (SHA256SUMS) against the
          # committed evidence file in release-evidence/<TAG>.json

          TAG="${{ inputs.tag || github.ref_name }}"
          # Strip refs/tags/ prefix if present
          TAG="${TAG#refs/tags/}"

          REPO_EVIDENCE="release-evidence/${TAG}.json"

          if [ -f "$REPO_EVIDENCE" ]; then
            echo "Verifying linkage against committed evidence: $REPO_EVIDENCE"

            # Compute digest of the FRESH SHA256SUMS (generated in previous step)
            # Note: SHA256SUMS is in the 'evidence/' directory
            ACTUAL_DIGEST=$(sha256sum evidence/SHA256SUMS | awk '{print $1}')

            # Validate the committed evidence file structure
            node scripts/release/validate-evidence.mjs --evidence "$REPO_EVIDENCE"

            # Check for mismatch
            EXPECTED_DIGEST=$(jq -r .bundle.digest "$REPO_EVIDENCE")

            if [ "$ACTUAL_DIGEST" != "$EXPECTED_DIGEST" ]; then
              echo "âŒ EVIDENCE_BUNDLE_DIGEST_MISMATCH"
              echo "Expected: $EXPECTED_DIGEST"
              echo "Actual:   $ACTUAL_DIGEST"

              # Emit failure report
              echo '{"ok": false, "digestMatched": false, "expectedDigest": "'"$EXPECTED_DIGEST"'", "actualDigest": "'"$ACTUAL_DIGEST"'"}' > evidence/evidence-check.json
              exit 1
            else
              echo "âœ… Evidence bundle digest matched: $ACTUAL_DIGEST"
              echo '{"ok": true, "digestMatched": true, "expectedDigest": "'"$EXPECTED_DIGEST"'", "actualDigest": "'"$ACTUAL_DIGEST"'"}' > evidence/evidence-check.json
            fi
          else
            echo "âš ï¸ No committed evidence found at $REPO_EVIDENCE, skipping linkage check."
          fi

          tar -czf release-assets/evidence.tar.gz evidence/

      - name: Generate Release Notes
        id: notes
        run: |
          echo "notes=GA Release ${{ inputs.tag || github.ref_name }} (SLSA L3 Compliant)" >> $GITHUB_OUTPUT

      - name: Idempotent Release
        id: publish
        if: ${{ inputs.dry_run != true }}
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          echo "Processing release for tag: $TAG"

          # Determine prerelease
          PRERELEASE=false
          if [[ "$TAG" == *"-rc"* ]]; then
            PRERELEASE=true
          fi

          # Check if release exists
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" > /dev/null 2>&1; then
            echo "Release $TAG exists. Updating..."
            EXISTED="true"
            ACTION="updated"

            # Pattern A: Update
            gh release upload "$TAG" release-assets/evidence.tar.gz --clobber --repo "$GITHUB_REPOSITORY"
            gh release edit "$TAG" \
              --notes "${{ steps.notes.outputs.notes }}" \
              --prerelease="$PRERELEASE" \
              --repo "$GITHUB_REPOSITORY"

          else
            echo "Release $TAG does not exist. Creating..."
            EXISTED="false"
            ACTION="created"

            gh release create "$TAG" release-assets/evidence.tar.gz \
              --title "$TAG" \
              --notes "${{ steps.notes.outputs.notes }}" \
              --prerelease="$PRERELEASE" \
              --repo "$GITHUB_REPOSITORY"
          fi

          echo "existed=$EXISTED" >> "$GITHUB_OUTPUT"
          echo "action=$ACTION" >> "$GITHUB_OUTPUT"

      - name: Dry Run Summary
        if: ${{ inputs.dry_run == true }}
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          echo "dry_run=true" >> "$GITHUB_OUTPUT"
          echo "### ðŸ§ª Dry Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Build: Server and Client images built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: All verification gates passed" >> $GITHUB_STEP_SUMMARY
          echo "- Evidence: Bundle created and checksums verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ Artifacts (not published)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release-assets/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ” Evidence Checksums" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat evidence/SHA256SUMS | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** This was a dry run. No release was published." >> $GITHUB_STEP_SUMMARY

      - name: Release Summary
        if: ${{ always() && inputs.dry_run != true }}
        run: |
          echo "### Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ inputs.tag || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Concurrency Group:** release-${{ inputs.tag || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Existed:** ${{ steps.publish.outputs.existed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action Taken:** ${{ steps.publish.outputs.action }}" >> $GITHUB_STEP_SUMMARY

  generate-war-room-checklist:
    name: Generate War Room Checklist
    needs: [test-and-verify]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download Prerequisite Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: |
            signoff-decision
            release-readiness-onepager
            release-cut-plan
          merge-multiple: true

      - name: Generate Checklist
        run: |
          # The download action places files in subdirectories named after the artifact.
          # Move them to the expected locations for the script.
          mkdir -p artifacts/signoff artifacts/release-readiness artifacts/release-cut
          mv artifacts/signoff-decision/decision.json artifacts/signoff/
          mv artifacts/release-readiness-onepager/onepager.md artifacts/release-readiness/
          mv artifacts/release-cut-plan/plan.md artifacts/release-cut/

          ./scripts/release/generate_war_room_checklist.mjs \
            --channel=ga \
            --target=${{ inputs.tag || github.ref_name }} \
            --out=artifacts/release-war-room/WAR_ROOM_ga_${{ inputs.tag || github.ref_name }}.md

      - name: Upload Checklist
        uses: actions/upload-artifact@v4
        with:
          name: release-war-room-checklist
          path: artifacts/release-war-room/
