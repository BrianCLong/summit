name: GA Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (if different from ref)"
        required: false
        type: string
      dry_run:
        description: "Validate release process without publishing"
        type: boolean
        default: false
        required: false
      override_freeze:
        description: "Override release freeze window?"
        type: boolean
        default: false
        required: false
      override_reason:
        description: "Reason for override (min 20 chars)"
        type: string
        default: ""
        required: false

concurrency:
  group: release-${{ inputs.tag || github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  id-token: write # For OIDC/Cosign if needed

jobs:
  test-and-verify:
    name: Verification Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Preflight Release
        run: node scripts/release/preflight-release.mjs

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Test Release Scripts
        run: pnpm -w test:release-scripts

      - name: Check Release Freeze Window
        env:
          OVERRIDE: ${{ inputs.override_freeze || 'false' }}
          OVERRIDE_REASON: ${{ inputs.override_reason || '' }}
        run: node scripts/release/check-freeze.mjs

      - name: Upload Freeze Evidence
        uses: actions/upload-artifact@v6
        with:
          name: freeze-evidence
          path: dist/release/freeze.json

      - name: Run Server Tests
        run: |
          mkdir -p dist/release
          if pnpm test:server; then
            echo '{"ok": true}' > dist/release/verify.json
          else
            echo '{"ok": false, "code": "VERIFY_FAILED"}' > dist/release/verify.json
            exit 1
          fi
        continue-on-error: false

      - name: Run Policy Checks
        run: |
          if ./scripts/policy-test.sh; then
            echo '{"ok": true}' > dist/release/preflight.json
          else
            echo '{"ok": false, "code": "SECURITY_GUARD"}' > dist/release/preflight.json
            exit 1
          fi
        continue-on-error: false

      - name: Verify Documentation Completeness
        run: ./scripts/check_traceability.cjs
        continue-on-error: false

      - name: Check Freeze Window
        if: always()
        run: |
          mkdir -p dist/release
          if ./scripts/check-freeze.sh; then
            echo '{"ok": true}' > dist/release/freeze.json
          else
            echo '{"ok": false, "code": "FREEZE_WINDOW", "message": "Freeze window is active"}' > dist/release/freeze.json
          fi

      - name: Generate Release Status
        if: always()
        run: node scripts/release/build-release-status.mjs

      - name: Validate Release Schemas
        if: always()
        run: node scripts/release/validate-bundle-schemas.mjs --dir dist/release --strict

      - name: Upload Release Status
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: release-status
          path: dist/release/release-status.json

  build-server:
    name: Build Server
    needs: test-and-verify
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: server
      dockerfile: server/Dockerfile
      context: .
      push: true
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  build-client:
    name: Build Client
    needs: test-and-verify
    uses: ./.github/workflows/_reusable-slsa-build.yml
    with:
      image_name: client
      dockerfile: client/Dockerfile
      context: .
      push: true
      sign: true
      sbom: true
      slsa_provenance: true
    secrets: inherit

  # Job: Collect and unify SBOM artifacts
  collect-sboms:
    name: Collect SBOMs & Generate Provenance
    needs: [build-server, build-client]
    runs-on: ubuntu-latest
    outputs:
      bundle_path: ${{ steps.collect.outputs.bundle_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract Tag and Version
        id: version
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          TAG="${TAG#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Tag: ${TAG}, Version: ${VERSION}"

      - name: Create Bundle Directory
        run: |
          mkdir -p artifacts/release/${{ steps.version.outputs.tag }}

      - name: Collect SBOM Artifacts
        id: collect
        run: |
          chmod +x scripts/release/collect_sbom_artifacts.sh

          # Run SBOM collection
          # Allow missing container SBOM initially - it may not exist yet
          ./scripts/release/collect_sbom_artifacts.sh \
            --tag "${{ steps.version.outputs.tag }}" \
            --sha "${{ github.sha }}" \
            --out "artifacts/release/${{ steps.version.outputs.tag }}" \
            --allow-missing-container || true

          echo "bundle_path=artifacts/release/${{ steps.version.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Generate Bundle SBOM
        run: |
          chmod +x scripts/release/generate_bundle_sbom.sh

          # Generate CycloneDX SBOM describing the bundle contents
          ./scripts/release/generate_bundle_sbom.sh \
            --bundle "artifacts/release/${{ steps.version.outputs.tag }}" \
            --tag "${{ steps.version.outputs.tag }}" \
            --sha "${{ github.sha }}"

      - name: Generate Provenance Manifest
        run: |
          chmod +x scripts/release/generate_provenance_manifest.sh

          # Generate provenance manifest (after bundle SBOM so it can reference it)
          ./scripts/release/generate_provenance_manifest.sh \
            --tag "${{ steps.version.outputs.tag }}" \
            --sha "${{ github.sha }}" \
            --bundle-dir "artifacts/release/${{ steps.version.outputs.tag }}" \
            --workflow-run "${{ github.run_id }}"

      - name: Upload SBOM Bundle
        uses: actions/upload-artifact@v6
        with:
          name: sbom-bundle-${{ steps.version.outputs.tag }}
          path: artifacts/release/${{ steps.version.outputs.tag }}/
          retention-days: 90

      - name: SBOM Collection Summary
        run: |
          echo "## SBOM Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Collected Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find artifacts/release/${{ steps.version.outputs.tag }} -type f -name "*.json" | while read f; do
            echo "$(basename $f): $(wc -c < $f | tr -d ' ') bytes"
          done >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job: Prepare release artifacts (runs automatically)
  prepare-release:
    name: Prepare Release Bundle
    needs: [build-server, build-client, collect-sboms]
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      evidence_sha256: ${{ steps.bundle.outputs.evidence_sha256 }}
      provenance_sha256: ${{ steps.bundle.outputs.provenance_sha256 }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Extract Tag
        id: version
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          TAG="${TAG#refs/tags/}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Download Server Artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts-server-${{ github.run_id }}
          path: evidence/server

      - name: Download Client Artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts-client-${{ github.run_id }}
          path: evidence/client

      - name: Download SBOM Bundle
        uses: actions/download-artifact@v7
        with:
          name: sbom-bundle-${{ steps.version.outputs.tag }}
          path: evidence/sbom-bundle

      - name: Download Freeze Evidence
        uses: actions/download-artifact@v7
        with:
          name: freeze-evidence
          path: evidence/freeze

      - name: Download Release Status
        uses: actions/download-artifact@v7
        with:
          name: release-status
          path: evidence/release

      - name: Create Evidence Bundle
        id: bundle
        run: |
          mkdir -p release-assets

          # Generate Checksums for all evidence (This creates evidence/SHA256SUMS)
          # Use deterministic sorting to ensure stable hash
          cd evidence
          find . -type f ! -name SHA256SUMS -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS
          cd ..

          # Verify Evidence Linkage
          # We compare the digest of the generated artifacts (SHA256SUMS) against the
          # committed evidence file in release-evidence/<TAG>.json

          TAG="${{ inputs.tag || github.ref_name }}"
          # Strip refs/tags/ prefix if present
          TAG="${TAG#refs/tags/}"

          REPO_EVIDENCE="release-evidence/${TAG}.json"

          if [ -f "$REPO_EVIDENCE" ]; then
            echo "Verifying linkage against committed evidence: $REPO_EVIDENCE"

            # Compute digest of the FRESH SHA256SUMS (generated in previous step)
            # Note: SHA256SUMS is in the 'evidence/' directory
            ACTUAL_DIGEST=$(sha256sum evidence/SHA256SUMS | awk '{print $1}')

            # Validate the committed evidence file structure
            node scripts/release/validate-evidence.mjs --evidence "$REPO_EVIDENCE"

            # Check for mismatch
            EXPECTED_DIGEST=$(jq -r .bundle.digest "$REPO_EVIDENCE")

            if [ "$ACTUAL_DIGEST" != "$EXPECTED_DIGEST" ]; then
              echo "âŒ EVIDENCE_BUNDLE_DIGEST_MISMATCH"
              echo "Expected: $EXPECTED_DIGEST"
              echo "Actual:   $ACTUAL_DIGEST"

              # Emit failure report
              echo '{"ok": false, "digestMatched": false, "expectedDigest": "'"$EXPECTED_DIGEST"'", "actualDigest": "'"$ACTUAL_DIGEST"'"}' > evidence/evidence-check.json
              exit 1
            else
              echo "âœ… Evidence bundle digest matched: $ACTUAL_DIGEST"
              echo '{"ok": true, "digestMatched": true, "expectedDigest": "'"$EXPECTED_DIGEST"'", "actualDigest": "'"$ACTUAL_DIGEST"'"}' > evidence/evidence-check.json
            fi
          else
            echo "âš ï¸ No committed evidence found at $REPO_EVIDENCE, skipping linkage check."
          fi

          # Calculate provenance hash if available
          PROVENANCE_SHA256=""
          if [ -f "evidence/sbom-bundle/provenance.json" ]; then
            PROVENANCE_SHA256=$(sha256sum evidence/sbom-bundle/provenance.json | awk '{print $1}')
          fi

          # Create release bundle tarball
          tar -czf release-assets/evidence.tar.gz evidence/

          # Calculate evidence tarball hash
          EVIDENCE_SHA256=$(sha256sum release-assets/evidence.tar.gz | awk '{print $1}')

          echo "evidence_sha256=${EVIDENCE_SHA256}" >> $GITHUB_OUTPUT
          echo "provenance_sha256=${PROVENANCE_SHA256}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Evidence bundle created"
          echo "  SHA256: ${EVIDENCE_SHA256}"

      - name: Generate Required Checks Snapshot
        run: |
          # Capture the list of required checks that were verified
          cat > release-assets/required_checks_snapshot.txt <<EOF
          # Required Checks Snapshot
          # Tag: ${{ steps.version.outputs.tag }}
          # Commit: ${{ github.sha }}
          # Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          test-and-verify: passed
          build-server: passed
          build-client: passed
          collect-sboms: passed
          EOF

      - name: Upload Release Bundle
        uses: actions/upload-artifact@v6
        with:
          name: release-bundle-${{ steps.version.outputs.tag }}
          path: release-assets/
          retention-days: 90

      - name: Prepare Release Summary
        run: |
          echo "### ðŸ“¦ Release Bundle Prepared" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Evidence Bundle SHA256:** \`${{ steps.bundle.outputs.evidence_sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### â³ Awaiting Two-Person Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release bundle is ready. Publishing requires approval from the \`ga-release\` environment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required reviewers** must approve in the GitHub Actions UI before the release is published." >> $GITHUB_STEP_SUMMARY

  # Job: Publish release (requires environment approval)
  publish:
    name: Publish Release
    needs: [prepare-release]
    runs-on: ubuntu-latest
    # TWO-PERSON APPROVAL: This job requires approval from the ga-release environment
    # Configure required reviewers in GitHub: Settings â†’ Environments â†’ ga-release
    environment:
      name: ga-release
      url: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.tag }}
    permissions:
      contents: write
      packages: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Release Bundle
        uses: actions/download-artifact@v7
        with:
          name: release-bundle-${{ needs.prepare-release.outputs.tag }}
          path: release-assets

      - name: Verify Bundle Integrity
        id: verify
        run: |
          TAG="${{ needs.prepare-release.outputs.tag }}"
          EXPECTED_HASH="${{ needs.prepare-release.outputs.evidence_sha256 }}"

          echo "ðŸ” Verifying release bundle integrity..."
          echo "Tag: ${TAG}"
          echo "Expected SHA256: ${EXPECTED_HASH}"

          # Verify the evidence tarball hash matches what was prepared
          ACTUAL_HASH=$(sha256sum release-assets/evidence.tar.gz | awk '{print $1}')
          echo "Actual SHA256: ${ACTUAL_HASH}"

          if [ "${ACTUAL_HASH}" != "${EXPECTED_HASH}" ]; then
            echo "::error::Evidence bundle hash mismatch! The artifact may have been tampered with."
            echo "Expected: ${EXPECTED_HASH}"
            echo "Actual:   ${ACTUAL_HASH}"
            exit 1
          fi

          echo "âœ… Evidence bundle integrity verified"
          echo "verified=true" >> $GITHUB_OUTPUT

      - name: Generate Approval Record
        id: approval
        run: |
          TAG="${{ needs.prepare-release.outputs.tag }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Generate approval record for audit trail
          cat > release-assets/approval_record.json <<EOF
          {
            "version": "1.0.0",
            "approval": {
              "workflow_run_id": "${{ github.run_id }}",
              "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "environment": "ga-release",
              "tag": "${TAG}",
              "commit_sha": "${{ github.sha }}",
              "evidence_sha256": "${{ needs.prepare-release.outputs.evidence_sha256 }}",
              "provenance_sha256": "${{ needs.prepare-release.outputs.provenance_sha256 }}",
              "approved_at": "${TIMESTAMP}",
              "triggered_by": "${{ github.actor }}",
              "repository": "${{ github.repository }}"
            },
            "verification": {
              "bundle_integrity": "verified",
              "required_checks": "passed",
              "environment_approval": "granted"
            },
            "audit_note": "Reviewer identity available in GitHub audit log for this workflow run"
          }
          EOF

          echo "ðŸ“‹ Approval record generated"
          cat release-assets/approval_record.json

      - name: Upload Approval Record
        uses: actions/upload-artifact@v6
        with:
          name: approval-record-${{ needs.prepare-release.outputs.tag }}
          path: release-assets/approval_record.json
          retention-days: 365 # Keep approval records for 1 year

      - name: Generate Release Notes
        id: notes
        run: |
          echo "notes=GA Release ${{ needs.prepare-release.outputs.tag }} (SLSA L3 Compliant)" >> $GITHUB_OUTPUT

      - name: Publish Release
        id: publish
        if: ${{ inputs.dry_run != true }}
        run: |
          TAG="${{ needs.prepare-release.outputs.tag }}"
          echo "Processing release for tag: $TAG"

          # Determine prerelease
          PRERELEASE=false
          if [[ "$TAG" == *"-rc"* ]]; then
            PRERELEASE=true
          fi

          # Check if release exists
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" > /dev/null 2>&1; then
            echo "Release $TAG exists. Updating..."
            EXISTED="true"
            ACTION="updated"

            # Pattern A: Update
            gh release upload "$TAG" release-assets/evidence.tar.gz --clobber --repo "$GITHUB_REPOSITORY"
            gh release edit "$TAG" \
              --notes "${{ steps.notes.outputs.notes }}" \
              --prerelease="$PRERELEASE" \
              --repo "$GITHUB_REPOSITORY"

          else
            echo "Release $TAG does not exist. Creating..."
            EXISTED="false"
            ACTION="created"

            gh release create "$TAG" release-assets/evidence.tar.gz \
              --title "$TAG" \
              --notes "${{ steps.notes.outputs.notes }}" \
              --prerelease="$PRERELEASE" \
              --repo "$GITHUB_REPOSITORY"
          fi

          echo "existed=$EXISTED" >> "$GITHUB_OUTPUT"
          echo "action=$ACTION" >> "$GITHUB_OUTPUT"

      - name: Dry Run Summary
        if: ${{ inputs.dry_run == true }}
        run: |
          TAG="${{ needs.prepare-release.outputs.tag }}"
          echo "dry_run=true" >> "$GITHUB_OUTPUT"
          echo "### ðŸ§ª Dry Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Build: Server and Client images built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: All verification gates passed" >> $GITHUB_STEP_SUMMARY
          echo "- Evidence: Bundle created and checksums verified" >> $GITHUB_STEP_SUMMARY
          echo "- Approval: Environment approval granted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ Artifacts (not published)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release-assets/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** This was a dry run. No release was published." >> $GITHUB_STEP_SUMMARY

      - name: Release Summary
        if: ${{ always() && inputs.dry_run != true }}
        run: |
          echo "### âœ… Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ needs.prepare-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Concurrency Group:** release-${{ needs.prepare-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Existed:** ${{ steps.publish.outputs.existed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action Taken:** ${{ steps.publish.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ” Two-Person Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ga-release" >> $GITHUB_STEP_SUMMARY
          echo "- **Approval Record:** See \`approval-record-${{ needs.prepare-release.outputs.tag }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "- **Audit Log:** GitHub audit log contains reviewer identity" >> $GITHUB_STEP_SUMMARY
