name: Deploy to Stage
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Image tag (sha) to deploy'
        required: true

env:
  NAMESPACE: stage
  RELEASE: summit

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG_DATA}" | base64 -d > ~/.kube/config
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_STAGE_B64 }}

      - name: Run migration gate (dry-run)
        run: bash scripts/migration-gate.sh stage --dry-run

      - name: Helm canary deploy (stage)
        run: |
          helm upgrade --install $RELEASE charts/summit \
            --namespace $NAMESPACE \
            -f charts/summit/values.stage.yaml \
            --set image.tag=${{ inputs.image }} \
            --set canary.enabled=true --set canary.replicas=1

      - name: Wait for rollout
        run: kubectl -n $NAMESPACE rollout status deploy/$RELEASE --timeout=5m

      - name: Wait for SLO healthy
        run: bash scripts/wait-for-slo-healthy.sh $NAMESPACE $RELEASE 300

      - name: Promote canary to 100%
        run: |
          helm upgrade $RELEASE charts/summit \
            --namespace $NAMESPACE \
            -f charts/summit/values.stage.yaml \
            --set image.tag=${{ inputs.image }} \
            --set canary.enabled=false

      - name: Run smoke tests
        run: bash scripts/smoke.sh https://summit-stage.example.com
