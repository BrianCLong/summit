name: release-ga-kit

on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write
  id-token: write

jobs:
  build-ga-pdf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
      - name: Build GA Kit PDF
        run: |
          mkdir -p dist
          pandoc \
            docs/runbooks/ga-operational-scorecard.md \
            docs/runbooks/ga-go-no-go-checklist.md \
            docs/incident/pagerduty-routing-matrix.md \
            docs/releases/RELEASE_NOTES_v1.0.0.md \
            -s -o dist/intelgraph-ga-kit-${{ github.ref_name }}.pdf
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/intelgraph-ga-kit-${{ github.ref_name }}.pdf

  attest-ga-pdf:
    needs: build-ga-pdf
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Download built artifact
        run: |
          echo "Fetching from release not needed as we build locally; verifying existence"
          test -f dist/intelgraph-ga-kit-${{ github.ref_name }}.pdf || exit 1
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'dist/intelgraph-ga-kit-${{ github.ref_name }}.pdf'

