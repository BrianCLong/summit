name: Branch Protection Drift Detection

# Governance workflow to detect drift between policy file and actual GitHub branch protection settings
# Authority: Platform Engineering
# Scope: Validates main branch protection matches REQUIRED_CHECKS_POLICY.yml

on:
  push:
    branches:
      - main
    paths:
      - 'docs/ci/REQUIRED_CHECKS_POLICY.yml'
      - '.github/workflows/branch-protection-drift.yml'

  schedule:
    # Run daily at 08:00 UTC to catch manual drift
    - cron: '0 8 * * *'

  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output for debugging'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  # Note: Reading branch protection requires admin:org or repo scope
  # GITHUB_TOKEN may not have sufficient permissions in some configurations

jobs:
  detect-drift:
    name: Detect Branch Protection Drift
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq (YAML processor)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Extract expected checks from policy
        id: policy
        run: |
          set -euo pipefail

          POLICY_FILE="docs/ci/REQUIRED_CHECKS_POLICY.yml"

          # Validate policy file exists
          if [[ ! -f "$POLICY_FILE" ]]; then
            echo "::error::Policy file not found: $POLICY_FILE"
            exit 1
          fi

          # Extract branch protection settings
          EXPECTED_BRANCH=$(yq eval '.branch_protection.branch' "$POLICY_FILE")
          EXPECTED_STRICT=$(yq eval '.branch_protection.required_status_checks.strict' "$POLICY_FILE")

          # Extract required check contexts as JSON array
          EXPECTED_CONTEXTS=$(yq eval '.branch_protection.required_status_checks.contexts | @json' "$POLICY_FILE")

          echo "branch=$EXPECTED_BRANCH" >> "$GITHUB_OUTPUT"
          echo "strict=$EXPECTED_STRICT" >> "$GITHUB_OUTPUT"
          echo "contexts=$EXPECTED_CONTEXTS" >> "$GITHUB_OUTPUT"

          # Also save to temp file for later comparison
          echo "$EXPECTED_CONTEXTS" | jq -S '.' > /tmp/expected-contexts.json

          echo "### Policy File Analysis" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Policy file:** \`$POLICY_FILE\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Target branch:** \`$EXPECTED_BRANCH\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Strict mode:** \`$EXPECTED_STRICT\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Expected checks count:** $(echo "$EXPECTED_CONTEXTS" | jq 'length')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>Expected Required Checks</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$EXPECTED_CONTEXTS" | jq -S '.' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Fetch actual branch protection settings
        id: actual
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          BRANCH="${{ steps.policy.outputs.branch }}"

          echo "Fetching branch protection for: $BRANCH"

          # Fetch branch protection settings via GitHub REST API
          # Note: This may fail if GITHUB_TOKEN lacks admin permissions
          RESPONSE=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/branches/$BRANCH/protection" \
            2>&1) || {
            echo "::error::Failed to fetch branch protection settings. GITHUB_TOKEN may lack required permissions (admin:org or repo scope)."
            echo "::error::Response: $RESPONSE"
            exit 1
          }

          # Extract required status checks
          ACTUAL_STRICT=$(echo "$RESPONSE" | jq -r '.required_status_checks.strict // false')
          ACTUAL_CONTEXTS=$(echo "$RESPONSE" | jq -c '.required_status_checks.contexts // []')

          echo "strict=$ACTUAL_STRICT" >> "$GITHUB_OUTPUT"
          echo "contexts=$ACTUAL_CONTEXTS" >> "$GITHUB_OUTPUT"

          # Save to temp file for comparison
          echo "$ACTUAL_CONTEXTS" | jq -S '.' > /tmp/actual-contexts.json

          echo "### GitHub Branch Protection (Actual)" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Branch:** \`$BRANCH\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Strict mode:** \`$ACTUAL_STRICT\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Actual checks count:** $(echo "$ACTUAL_CONTEXTS" | jq 'length')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>Actual Required Checks</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$ACTUAL_CONTEXTS" | jq -S '.' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Compare and detect drift
        run: |
          set -euo pipefail

          EXPECTED_STRICT="${{ steps.policy.outputs.strict }}"
          ACTUAL_STRICT="${{ steps.actual.outputs.strict }}"

          DRIFT_DETECTED=false

          echo "### Drift Detection Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Compare strict mode
          if [[ "$EXPECTED_STRICT" != "$ACTUAL_STRICT" ]]; then
            echo "::error::Drift detected in strict mode setting"
            echo "- **Strict Mode Drift:** Expected \`$EXPECTED_STRICT\`, Got \`$ACTUAL_STRICT\`" >> "$GITHUB_STEP_SUMMARY"
            DRIFT_DETECTED=true
          else
            echo "- **Strict Mode:** âœ… No drift (\`$EXPECTED_STRICT\`)" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Compare contexts (required checks)
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "#### Required Checks Comparison" >> "$GITHUB_STEP_SUMMARY"

          # Find missing checks (in policy but not in GitHub)
          MISSING_CHECKS=$(jq -n \
            --slurpfile expected /tmp/expected-contexts.json \
            --slurpfile actual /tmp/actual-contexts.json \
            '$expected[0] - $actual[0]')

          # Find extra checks (in GitHub but not in policy)
          EXTRA_CHECKS=$(jq -n \
            --slurpfile expected /tmp/expected-contexts.json \
            --slurpfile actual /tmp/actual-contexts.json \
            '$actual[0] - $expected[0]')

          MISSING_COUNT=$(echo "$MISSING_CHECKS" | jq 'length')
          EXTRA_COUNT=$(echo "$EXTRA_CHECKS" | jq 'length')

          if [[ "$MISSING_COUNT" -gt 0 ]]; then
            echo "::error::Drift detected: $MISSING_COUNT required checks missing from GitHub branch protection"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "##### âŒ Missing Required Checks ($MISSING_COUNT)" >> "$GITHUB_STEP_SUMMARY"
            echo "The following checks are defined in the policy but NOT enforced by GitHub:" >> "$GITHUB_STEP_SUMMARY"
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            echo "$MISSING_CHECKS" | jq '.' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            DRIFT_DETECTED=true
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "##### âœ… No Missing Checks" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "$EXTRA_COUNT" -gt 0 ]]; then
            echo "::warning::Drift detected: $EXTRA_COUNT checks enforced by GitHub but not in policy"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "##### âš ï¸ Extra Checks ($EXTRA_COUNT)" >> "$GITHUB_STEP_SUMMARY"
            echo "The following checks are enforced by GitHub but NOT in the policy:" >> "$GITHUB_STEP_SUMMARY"
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            echo "$EXTRA_CHECKS" | jq '.' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            DRIFT_DETECTED=true
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "##### âœ… No Extra Checks" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Final verdict
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ "$DRIFT_DETECTED" == "true" ]]; then
            echo "### ðŸš¨ DRIFT DETECTED" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Action Required:** Branch protection settings do not match the policy file." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Remediation Steps:**" >> "$GITHUB_STEP_SUMMARY"
            echo "1. Review the drift details above" >> "$GITHUB_STEP_SUMMARY"
            echo "2. Either update \`docs/ci/REQUIRED_CHECKS_POLICY.yml\` to match GitHub settings" >> "$GITHUB_STEP_SUMMARY"
            echo "3. OR update GitHub branch protection to match the policy file" >> "$GITHUB_STEP_SUMMARY"
            echo "4. Ensure policy file is the authoritative source of truth" >> "$GITHUB_STEP_SUMMARY"

            exit 1
          else
            echo "### âœ… NO DRIFT DETECTED" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Branch protection settings match the policy file exactly." >> "$GITHUB_STEP_SUMMARY"

            echo "No drift detected - policy and GitHub branch protection are synchronized"
          fi

      - name: Verbose output (debug)
        if: ${{ github.event.inputs.verbose == 'true' }}
        run: |
          echo "=== Full Policy File ==="
          cat docs/ci/REQUIRED_CHECKS_POLICY.yml

          echo ""
          echo "=== Expected Contexts (parsed) ==="
          cat /tmp/expected-contexts.json

          echo ""
          echo "=== Actual Contexts (from GitHub API) ==="
          cat /tmp/actual-contexts.json
