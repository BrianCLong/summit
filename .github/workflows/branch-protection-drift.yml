# branch-protection-drift.yml
# Detects drift between REQUIRED_CHECKS_POLICY.yml and GitHub branch protection
#
# Compares policy-as-code with actual GitHub enforcement.
# Opens/updates a deduped issue when drift is detected.
#
# Authority: docs/ci/BRANCH_PROTECTION_DRIFT.md

name: Branch Protection Drift Detection

on:
  # Daily check
  schedule:
    - cron: "0 10 * * *" # 10:00 UTC daily

  # On policy changes
  pull_request:
    paths:
      - "docs/ci/REQUIRED_CHECKS_POLICY.yml"

  # Manual trigger
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check"
        type: string
        default: "main"
      dry_run:
        description: "Dry run (no issue creation)"
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  actions: read

env:
  STATE_FILE: docs/releases/_state/branch_protection_drift_state.json
  OUT_DIR: artifacts/release-train

jobs:
  check-drift:
    name: Check Branch Protection Drift
    runs-on: ubuntu-latest

    outputs:
      drift_detected: ${{ steps.check.outputs.drift_detected }}
      missing_count: ${{ steps.check.outputs.missing_count }}
      extra_count: ${{ steps.check.outputs.extra_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

      - name: Determine Branch
        id: branch
        run: |
          if [[ -n "${{ github.event.inputs.branch }}" ]]; then
            BRANCH="${{ github.event.inputs.branch }}"
          else
            BRANCH="main"
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Checking branch: ${BRANCH}"

      - name: Run Drift Detection
        id: check
        env:
          # Use dedicated token for branch protection access if available, fallback to GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.GOVERNANCE_BOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p "${{ env.OUT_DIR }}"

          chmod +x scripts/release/check_branch_protection_drift.sh
          chmod +x scripts/release/extract_required_checks_from_policy.sh

          scripts/release/check_branch_protection_drift.sh \
            --repo "${{ github.repository }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --out-dir "${{ env.OUT_DIR }}" \
            --verbose

          # Extract results for outputs
          DRIFT=$(jq -r '.drift_detected' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
          MISSING=$(jq -r '.summary.missing_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
          EXTRA=$(jq -r '.summary.extra_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")

          echo "drift_detected=${DRIFT}" >> $GITHUB_OUTPUT
          echo "missing_count=${MISSING}" >> $GITHUB_OUTPUT
          echo "extra_count=${EXTRA}" >> $GITHUB_OUTPUT

          echo "Drift detected: ${DRIFT}"
          echo "Missing in GitHub: ${MISSING}"
          echo "Extra in GitHub: ${EXTRA}"

      - name: Upload Drift Report
        uses: actions/upload-artifact@0b2207062494160a33bd674828362627b9c46d9a # v4
        with:
          name: branch-protection-drift-report
          path: |
            ${{ env.OUT_DIR }}/branch_protection_drift_report.md
            ${{ env.OUT_DIR }}/branch_protection_drift_report.json
          retention-days: 30

      - name: Check Deduplication
        id: dedup
        if: steps.check.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"

          # Search for existing open drift issue for this branch
          QUERY="is:issue is:open repo:${{ github.repository }} label:governance label:ci \"[Governance Drift] Branch protection does not match REQUIRED_CHECKS_POLICY (${BRANCH})\""
          EXISTING_ISSUE=$(gh issue list --search "${QUERY}" --json number --jq '.[0].number')

          if [[ -n "${EXISTING_ISSUE}" ]]; then
            echo "action=update" >> $GITHUB_OUTPUT
            echo "issue_number=${EXISTING_ISSUE}" >> $GITHUB_OUTPUT
            echo "Found existing issue: #${EXISTING_ISSUE}"
          else
            echo "action=create" >> $GITHUB_OUTPUT
            echo "No existing issue found."
          fi

      - name: Generate Issue Body
        id: body
        if: (steps.dedup.outputs.action == 'create' || steps.dedup.outputs.action == 'update') && github.event.inputs.dry_run != 'true'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          REPORT_JSON="${{ env.OUT_DIR }}/branch_protection_drift_report.json"

          MISSING_CHECKS=$(jq -r '.missing_in_github[]' "${REPORT_JSON}" | head -10)
          EXTRA_CHECKS=$(jq -r '.extra_in_github[]' "${REPORT_JSON}" | head -10)
          API_ERROR=$(jq -r '.api_error // ""' "${REPORT_JSON}")

          cat > issue_body.md << 'EOF'
          ## Branch Protection Drift Detected

          Policy-as-code (`REQUIRED_CHECKS_POLICY.yml`) does not match GitHub branch protection enforcement.

          **Branch:** `${{ steps.branch.outputs.branch }}`
          **Detected:** $(date -u +"%Y-%m-%d %H:%M UTC")

          ---

          ### Summary

          | Category | Count |
          |----------|-------|
          | Missing in GitHub | ${{ steps.check.outputs.missing_count }} |
          | Extra in GitHub | ${{ steps.check.outputs.extra_count }} |

          EOF

          if [[ -n "$API_ERROR" ]]; then
            cat >> issue_body.md << EOF

          ### API Access Issue

          \`\`\`
          ${API_ERROR}
          \`\`\`

          EOF
          fi

          if [[ ${{ steps.check.outputs.missing_count }} -gt 0 ]]; then
            cat >> issue_body.md << 'MISSING_EOF'

          ### Checks Missing from GitHub Branch Protection

          These checks are required by policy but not enforced:

          MISSING_EOF

            jq -r '.missing_in_github[]' "${REPORT_JSON}" | while read -r check; do
              echo "- \`${check}\`" >> issue_body.md
            done
          fi

          if [[ ${{ steps.check.outputs.extra_count }} -gt 0 ]]; then
            cat >> issue_body.md << 'EXTRA_EOF'

          ### Extra Checks in GitHub Branch Protection

          These checks are enforced but not in policy:

          EXTRA_EOF

            jq -r '.extra_in_github[]' "${REPORT_JSON}" | while read -r check; do
              echo "- \`${check}\`" >> issue_body.md
            done
          fi

          cat >> issue_body.md << 'REMEDIATION_EOF'

          ---

          ### Remediation

          **Option A: Update GitHub branch protection to match policy**

          1. Go to **Settings** → **Branches** → **Branch protection rules**
          2. Edit the rule for the affected branch
          3. Add missing checks / remove extra checks

          **Option B: Update policy to match GitHub**

          1. Edit `docs/ci/REQUIRED_CHECKS_POLICY.yml`
          2. Add/remove entries from `always_required` section
          3. Create PR for review

          ---

          ### Links

          - [REQUIRED_CHECKS_POLICY.yml](../../docs/ci/REQUIRED_CHECKS_POLICY.yml)
          - [Branch Protection Settings](../../settings/branches)
          - [Drift Detection Documentation](../../docs/ci/BRANCH_PROTECTION_DRIFT.md)
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---

          *This issue is automatically created/updated by the Branch Protection Drift Detection workflow.*
          REMEDIATION_EOF

      - name: Create Issue
        if: steps.dedup.outputs.action == 'create' && github.event.inputs.dry_run != 'true'
        id: create
        uses: actions/github-script@604723e2c817b3a4a9cfd11897962b93198de70e # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const branch = '${{ steps.branch.outputs.branch }}';

            const title = `[Governance Drift] Branch protection does not match REQUIRED_CHECKS_POLICY (${branch})`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['governance', 'ci', 'release-ops', 'severity:P1']
            });

            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

      - name: Update Issue
        if: steps.dedup.outputs.action == 'update' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@604723e2c817b3a4a9cfd11897962b93198de70e # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const issueNumber = parseInt('${{ steps.dedup.outputs.issue_number }}');

            if (issueNumber > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## Drift Detected - Issue Updated\n\nBranch protection drift has been detected again. The main issue body has been updated with the latest details.\n\nTimestamp: ${new Date().toISOString()}`
              });

              console.log(`Updated issue #${issueNumber}`);
            }

      - name: Auto-Close on Resolution
        if: steps.check.outputs.drift_detected == 'false' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@604723e2c817b3a4a9cfd11897962b93198de70e # v7
        with:
          script: |
            // Find open drift issues and close them
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'governance',
              state: 'open'
            });

            for (const issue of issues.data) {
              if (issue.title.includes('[Governance Drift]') && issue.title.includes('Branch protection')) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '## Resolved\n\nBranch protection is now in sync with policy. Closing this issue.'
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });

                console.log(`Closed issue #${issue.number}`);
              }
            }

      - name: Generate Summary
        run: |
          echo "## Branch Protection Drift Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Drift Detected:** ${{ steps.check.outputs.drift_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check.outputs.drift_detected }}" == "true" ]]; then
            echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Missing in GitHub | ${{ steps.check.outputs.missing_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Extra in GitHub | ${{ steps.check.outputs.extra_count }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Policy and branch protection are in sync." >> $GITHUB_STEP_SUMMARY
          fi
