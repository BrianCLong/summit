# branch-protection-drift.yml
# Detects drift between REQUIRED_CHECKS_POLICY.yml and GitHub branch protection
#
# Compares policy-as-code with actual GitHub enforcement.
# Opens/updates a deduped issue when drift is detected.
#
# Authority: docs/ci/BRANCH_PROTECTION_DRIFT.md

name: Branch Protection Drift Detection

on:
  # Daily check
  schedule:
    - cron: "0 10 * * *" # 10:00 UTC daily

  # On policy changes
  pull_request:
    paths:
      - "docs/ci/REQUIRED_CHECKS_POLICY.yml"

  # Manual trigger
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check"
        type: string
        default: "main"
      dry_run:
        description: "Dry run (no issue creation)"
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  actions: read

env:
  STATE_FILE: docs/releases/_state/branch_protection_drift_state.json
  OUT_DIR: artifacts/release-train

jobs:
  check-drift:
    name: Check Branch Protection Drift
    runs-on: ubuntu-latest

    outputs:
      drift_detected: ${{ steps.check.outputs.drift_detected }}
      missing_count: ${{ steps.check.outputs.missing_count }}
      extra_count: ${{ steps.check.outputs.extra_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install -g pnpm && pnpm install

      - name: Determine Branch
        id: branch
        run: |
          if [[ -n "${{ github.event.inputs.branch }}" ]]; then
            BRANCH="${{ github.event.inputs.branch }}"
          else
            BRANCH="main"
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Checking branch: ${BRANCH}"

      - name: Run Drift Detection
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p "${{ env.OUT_DIR }}"

          # Use Node.js script (pnpm ci:branch-protection:check)
          node scripts/ci/check_branch_protection_drift.mjs \
            --repo "${{ github.repository }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --out-dir "${{ env.OUT_DIR }}" \
            --verbose

          # Extract results for outputs
          DRIFT=$(jq -r '.drift_detected' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
          MISSING=$(jq -r '.summary.missing_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
          EXTRA=$(jq -r '.summary.extra_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")

          echo "drift_detected=${DRIFT}" >> $GITHUB_OUTPUT
          echo "missing_count=${MISSING}" >> $GITHUB_OUTPUT
          echo "extra_count=${EXTRA}" >> $GITHUB_OUTPUT

          echo "Drift detected: ${DRIFT}"
          echo "Missing in GitHub: ${MISSING}"
          echo "Extra in GitHub: ${EXTRA}"

      - name: Upload Drift Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: branch-protection-drift-report
          path: |
            ${{ env.OUT_DIR }}/branch_protection_drift_report.md
            ${{ env.OUT_DIR }}/branch_protection_drift_report.json
          retention-days: 30

      - name: Check Deduplication
        id: dedup
        if: steps.check.outputs.drift_detected == 'true'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          MISSING="${{ steps.check.outputs.missing_count }}"
          EXTRA="${{ steps.check.outputs.extra_count }}"

          mkdir -p "$(dirname "${{ env.STATE_FILE }}")"

          if [[ ! -f "${{ env.STATE_FILE }}" ]]; then
            echo '{"version":"1.0","issues":{}}' > "${{ env.STATE_FILE }}"
          fi

          # Create a fingerprint of the drift state
          DRIFT_KEY="${BRANCH}_${MISSING}_${EXTRA}"

          EXISTING=$(jq -r --arg key "${DRIFT_KEY}" '.issues[$key] // empty' "${{ env.STATE_FILE }}")

          if [[ -n "${EXISTING}" ]]; then
            ISSUE_NUMBER=$(echo "${EXISTING}" | jq -r '.issue_number')
            LAST_UPDATE=$(echo "${EXISTING}" | jq -r '.last_updated')

            # Check cooldown (24 hours)
            LAST_TS=$(date -d "${LAST_UPDATE}" +%s 2>/dev/null || echo 0)
            NOW_TS=$(date +%s)
            DIFF=$((NOW_TS - LAST_TS))

            if [[ ${DIFF} -lt 86400 ]]; then
              echo "::notice::Issue #${ISSUE_NUMBER} updated within 24h, skipping"
              echo "action=skip" >> $GITHUB_OUTPUT
            else
              echo "action=update" >> $GITHUB_OUTPUT
              echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
            fi
          else
            echo "action=create" >> $GITHUB_OUTPUT
          fi

          echo "drift_key=${DRIFT_KEY}" >> $GITHUB_OUTPUT

      - name: Generate Issue Body
        id: body
        if: (steps.dedup.outputs.action == 'create' || steps.dedup.outputs.action == 'update') && github.event.inputs.dry_run != 'true'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          REPORT_JSON="${{ env.OUT_DIR }}/branch_protection_drift_report.json"

          MISSING_CHECKS=$(jq -r '.missing_in_github[]' "${REPORT_JSON}" | head -10)
          EXTRA_CHECKS=$(jq -r '.extra_in_github[]' "${REPORT_JSON}" | head -10)
          API_ERROR=$(jq -r '.api_error // ""' "${REPORT_JSON}")

          cat > issue_body.md << 'EOF'
          ## Branch Protection Drift Detected

          Policy-as-code (`REQUIRED_CHECKS_POLICY.yml`) does not match GitHub branch protection enforcement.

          **Branch:** `${{ steps.branch.outputs.branch }}`
          **Detected:** $(date -u +"%Y-%m-%d %H:%M UTC")

          ---

          ### Summary

          | Category | Count |
          |----------|-------|
          | Missing in GitHub | ${{ steps.check.outputs.missing_count }} |
          | Extra in GitHub | ${{ steps.check.outputs.extra_count }} |

          EOF

          if [[ -n "$API_ERROR" ]]; then
            cat >> issue_body.md << EOF

          ### API Access Issue

          \`\`\`
          ${API_ERROR}
          \`\`\`

          EOF
          fi

          if [[ ${{ steps.check.outputs.missing_count }} -gt 0 ]]; then
            cat >> issue_body.md << 'MISSING_EOF'

          ### Checks Missing from GitHub Branch Protection

          These checks are required by policy but not enforced:

          MISSING_EOF

            jq -r '.missing_in_github[]' "${REPORT_JSON}" | while read -r check; do
              echo "- \`${check}\`" >> issue_body.md
            done
          fi

          if [[ ${{ steps.check.outputs.extra_count }} -gt 0 ]]; then
            cat >> issue_body.md << 'EXTRA_EOF'

          ### Extra Checks in GitHub Branch Protection

          These checks are enforced but not in policy:

          EXTRA_EOF

            jq -r '.extra_in_github[]' "${REPORT_JSON}" | while read -r check; do
              echo "- \`${check}\`" >> issue_body.md
            done
          fi

          cat >> issue_body.md << 'REMEDIATION_EOF'

          ---

          ### Remediation

          **Option A: Update GitHub branch protection to match policy**

          1. Go to **Settings** → **Branches** → **Branch protection rules**
          2. Edit the rule for the affected branch
          3. Add missing checks / remove extra checks

          **Option B: Update policy to match GitHub**

          1. Edit `docs/ci/REQUIRED_CHECKS_POLICY.yml`
          2. Add/remove entries from `always_required` section
          3. Create PR for review

          ---

          ### Links

          - [REQUIRED_CHECKS_POLICY.yml](../../docs/ci/REQUIRED_CHECKS_POLICY.yml)
          - [Branch Protection Settings](../../settings/branches)
          - [Drift Detection Documentation](../../docs/ci/BRANCH_PROTECTION_DRIFT.md)
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---

          *This issue is automatically created/updated by the Branch Protection Drift Detection workflow.*
          REMEDIATION_EOF

      - name: Create Issue
        if: steps.dedup.outputs.action == 'create' && github.event.inputs.dry_run != 'true'
        id: create
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const branch = '${{ steps.branch.outputs.branch }}';

            const title = `[Governance Drift] Branch protection does not match REQUIRED_CHECKS_POLICY (${branch})`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['governance', 'ci', 'release-ops', 'severity:P1']
            });

            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

      - name: Update Issue
        if: steps.dedup.outputs.action == 'update' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const issueNumber = ${{ steps.dedup.outputs.issue_number || 0 }};

            if (issueNumber > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## Drift Update (${new Date().toISOString()})\n\n${body}`
              });

              console.log(`Updated issue #${issueNumber}`);
            }

      - name: Update State
        if: (steps.dedup.outputs.action == 'create' || steps.dedup.outputs.action == 'update') && github.event.inputs.dry_run != 'true'
        run: |
          DRIFT_KEY="${{ steps.dedup.outputs.drift_key }}"
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [[ "${{ steps.dedup.outputs.action }}" == "create" ]]; then
            ISSUE_NUMBER="${{ steps.create.outputs.result }}"
          else
            ISSUE_NUMBER="${{ steps.dedup.outputs.issue_number }}"
          fi

          jq --arg key "${DRIFT_KEY}" \
             --arg issue "${ISSUE_NUMBER}" \
             --arg updated "${NOW}" \
             '.issues[$key] = {
                issue_number: ($issue | tonumber),
                last_updated: $updated,
                drift_key: $key
              }' "${{ env.STATE_FILE }}" > state_tmp.json

          mv state_tmp.json "${{ env.STATE_FILE }}"

      - name: Commit State
        if: steps.dedup.outputs.action == 'create' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${{ env.STATE_FILE }}" 2>/dev/null || true
          git commit -m "chore: update branch protection drift state" || true
          git push || echo "::warning::Could not push state update"

      - name: Auto-Close on Resolution
        if: steps.check.outputs.drift_detected == 'false' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            // Find open drift issues and close them
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'governance',
              state: 'open'
            });

            for (const issue of issues.data) {
              if (issue.title.includes('[Governance Drift]') && issue.title.includes('Branch protection')) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '## Resolved\n\nBranch protection is now in sync with policy. Closing this issue.'
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });

                console.log(`Closed issue #${issue.number}`);
              }
            }

      - name: Generate Summary
        run: |
          echo "## Branch Protection Drift Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Drift Detected:** ${{ steps.check.outputs.drift_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check.outputs.drift_detected }}" == "true" ]]; then
            echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Missing in GitHub | ${{ steps.check.outputs.missing_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Extra in GitHub | ${{ steps.check.outputs.extra_count }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Policy and branch protection are in sync." >> $GITHUB_STEP_SUMMARY
          fi
