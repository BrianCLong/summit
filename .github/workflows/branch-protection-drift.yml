# branch-protection-drift.yml
# Detects drift between REQUIRED_CHECKS_POLICY.yml and GitHub branch protection
#
# Compares policy-as-code with actual GitHub enforcement.
# Opens/updates a deduped issue when drift is detected.
#
# Authority: docs/ci/BRANCH_PROTECTION_DRIFT.md

name: Branch Protection Drift Detection

on:
  # Daily check
  schedule:
    - cron: "0 10 * * *" # 10:00 UTC daily

  # On policy changes
  pull_request:
    paths:
      - "docs/ci/REQUIRED_CHECKS_POLICY.yml"

  # Manual trigger
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check"
        type: string
        default: "main"
      dry_run:
        description: "Dry run (no issue creation)"
        type: boolean
        default: false
      mode:
        description: "Run mode"
        required: false
        default: "normal"
        type: choice
        options:
          - normal
          - simulate_drift
          - simulate_permissions
          - simulate_error

permissions:
  contents: read
  issues: write
  actions: read

env:
  STATE_FILE: docs/releases/_state/branch_protection_drift_state.json
  OUT_DIR: artifacts/release-train

jobs:
  check-drift:
    name: Check Branch Protection Drift
    runs-on: ubuntu-latest

    outputs:
      drift_detected: ${{ steps.check.outputs.drift_detected }}
      missing_count: ${{ steps.check.outputs.missing_count }}
      extra_count: ${{ steps.check.outputs.extra_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Branch
        id: branch
        run: |
          if [[ -n "${{ github.event.inputs.branch }}" ]]; then
            BRANCH="${{ github.event.inputs.branch }}"
          else
            BRANCH="main"
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Checking branch: ${BRANCH}"

      - name: Run Drift Detection
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_PROTECTION_DRIFT_MODE: ${{ github.event.inputs.mode || 'normal' }}
        run: |
          mkdir -p "${{ env.OUT_DIR }}"

          chmod +x scripts/release/check_branch_protection_drift.sh
          chmod +x scripts/release/extract_required_checks_from_policy.sh

          set +e
          scripts/release/check_branch_protection_drift.sh \
            --repo "${{ github.repository }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --out-dir "${{ env.OUT_DIR }}" \
            --verbose
          EXIT_CODE=$?
          set -e

          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

          # Extract data if report exists
          if [[ -f "${{ env.OUT_DIR }}/branch_protection_drift_report.json" ]]; then
            DRIFT=$(jq -r '.drift_detected' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
            MISSING=$(jq -r '.summary.missing_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
            EXTRA=$(jq -r '.summary.extra_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
            echo "drift_detected=${DRIFT}" >> $GITHUB_OUTPUT
            echo "missing_count=${MISSING}" >> $GITHUB_OUTPUT
            echo "extra_count=${EXTRA}" >> $GITHUB_OUTPUT
          fi

      - name: Upload Drift Report
        uses: actions/upload-artifact@v4
        with:
          name: branch-protection-drift-report
          path: |
            ${{ env.OUT_DIR }}/branch_protection_drift_report.md
            ${{ env.OUT_DIR }}/branch_protection_drift_report.json
          retention-days: 30

      - name: "Escalation: Create or Update Issue"
        if: steps.check.outputs.exit_code == 2 && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const isSimulation = process.env.BRANCH_PROTECTION_DRIFT_MODE === 'simulate_drift';
            const label = isSimulation ? 'branch-protection-drift-test' : 'branch-protection-drift';
            const titlePrefix = isSimulation ? '[TEST] ' : '';
            const runId = context.runId;
            const repoUrl = `${process.env.GITHUB_SERVER_URL}/${owner}/${repo}`;
            const artifactUrl = `${repoUrl}/actions/runs/${runId}/artifacts/browse/branch-protection-drift-report`;
            const runbookUrl = `https://github.com/${owner}/${repo}/blob/main/docs/security/branch_protection_snapshots/DRIFT_RESPONSE_RUNBOOK.md`;

            // Ensure label exists
            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch (e) {
              await github.rest.issues.createLabel({
                owner, repo, name: label, color: isSimulation ? '5319e7' : 'e11d25',
                description: isSimulation ? 'Simulation of branch protection drift' : 'Active drift in branch protection settings'
              });
            }

            // Find existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo,
              labels: label, state: 'open'
            });

            const bodyPrefix = isSimulation ? "> [!IMPORTANT]\n> This is a SYNTHETIC DRIFT TEST. Please close this issue after verifying the escalation path works.\n\n" : "";

            const body = bodyPrefix + `## Branch Protection Drift Detected

            Policy (\`REQUIRED_CHECKS_POLICY.yml\`) does not match GitHub enforcement.

            - **Branch:** \`${{ steps.branch.outputs.branch }}\`
            - **Run:** [View Workflow Run](${repoUrl}/actions/runs/${runId})
            - **Report:** [View Artifacts](${artifactUrl})
            - **Runbook:** [Response Instructions](${runbookUrl})

            ### Next Steps
            1. Download the drift report artifact.
            2. Follow the [Runbook](${runbookUrl}) to remediate.
            3. The detector will automatically update this issue if drift remains.

            ---
            *This issue is managed by the Branch Protection Drift Detection workflow.*`;

            if (issues.length > 0) {
              const issueNumber = issues[0].number;
              await github.rest.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: `Drift persists in run [${runId}](${repoUrl}/actions/runs/${runId}).\n\n[Updated Report](${artifactUrl})`
              });
              console.log(`Updated issue #${issueNumber}`);
            } else {
              const { data: newIssue } = await github.rest.issues.create({
                owner, repo,
                title: `${titlePrefix}Branch protection drift detected on ${{ steps.branch.outputs.branch }}`,
                body: body,
                labels: [label, 'governance', 'severity:P1']
              });
              console.log(`Created issue #${newIssue.number}`);
            }

      - name: Auto-Close Resolved Issues
        if: steps.check.outputs.exit_code == 0 && github.event.inputs.dry_run != 'true'
        env:
          BRANCH_PROTECTION_DRIFT_MODE: ${{ github.event.inputs.mode || 'normal' }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const isSimulation = process.env.BRANCH_PROTECTION_DRIFT_MODE === 'simulate_drift';
            const label = isSimulation ? 'branch-protection-drift-test' : 'branch-protection-drift';
            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo,
              labels: label, state: 'open'
            });
            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issue.number,
                body: '## Resolved\n\nBranch protection is now in sync with policy. Closing issue.'
              });
              await github.rest.issues.update({
                owner, repo, issue_number: issue.number,
                state: 'closed'
              });
              console.log(`Closed issue #${issue.number}`);
            }

      - name: Generate Summary
        run: |
          echo "## Branch Protection Drift Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Exit Code:** ${{ steps.check.outputs.exit_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check.outputs.exit_code }}" == "2" ]]; then
            echo "::warning::Drift detected! See drift report artifact for details." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.check.outputs.exit_code }}" == "3" ]]; then
            echo "::error::Permission or API error occurred." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Policy and branch protection are in sync." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Finalize Status
        if: always()
        run: |
          if [[ "${{ steps.check.outputs.exit_code }}" != "0" ]]; then
            echo "Drift or error detected. Failing workflow for visibility."
            exit ${{ steps.check.outputs.exit_code }}
          fi
