# branch-protection-drift.yml
# Detects drift between REQUIRED_CHECKS_POLICY.yml and GitHub branch protection
#
# Compares policy-as-code with actual GitHub enforcement.
# Opens/updates a deduped issue when drift is detected.
#
# Authority: docs/ci/BRANCH_PROTECTION_DRIFT.md

name: Branch Protection Drift Detection

on:
  # Daily check
  schedule:
    - cron: "0 10 * * *" # 10:00 UTC daily

  # On policy changes
  pull_request:
    paths:
      - "docs/ci/REQUIRED_CHECKS_POLICY.yml"

  # Manual trigger
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check"
        type: string
        default: "main"
      dry_run:
        description: "Dry run (no issue creation)"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  actions: read

env:
  OUT_DIR: artifacts/release-train

jobs:
  check-drift:
    name: Check Branch Protection Drift
    runs-on: ubuntu-latest

    outputs:
      drift_detected: ${{ steps.check.outputs.drift_detected }}
      missing_count: ${{ steps.check.outputs.missing_count }}
      extra_count: ${{ steps.check.outputs.extra_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Determine Branch
        id: branch
        run: |
          if [[ -n "${{ github.event.inputs.branch }}" ]]; then
            BRANCH="${{ github.event.inputs.branch }}"
          else
            BRANCH="main"
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Checking branch: ${BRANCH}"

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        continue-on-error: true
        with:
          app-id: ${{ secrets.BRANCH_PROTECTION_APP_ID }}
          private-key: ${{ secrets.BRANCH_PROTECTION_APP_PRIVATE_KEY }}

      - name: Select branch protection token
        id: auth
        run: |
          if [[ -n "${{ steps.app-token.outputs.token }}" ]]; then
            echo "token=${{ steps.app-token.outputs.token }}" >> $GITHUB_OUTPUT
            echo "auth_source=github-app" >> $GITHUB_OUTPUT
            echo "::notice::GitHub App token acquired."
            echo "✅ GitHub App token acquired." >> $GITHUB_STEP_SUMMARY
          else
            echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
            echo "auth_source=github-token" >> $GITHUB_OUTPUT
            echo "::warning::GitHub App token unavailable; falling back to GITHUB_TOKEN."
            echo "⚠️ Fell back to GITHUB_TOKEN." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify GitHub App installation
        if: steps.auth.outputs.auth_source == 'github-app'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          gh api "/repos/${{ github.repository }}/installation" >/dev/null
          echo "✅ GitHub App installation verified." >> $GITHUB_STEP_SUMMARY

      - name: Run Drift Detection
        id: check
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          mkdir -p "${{ env.OUT_DIR }}"

          chmod +x scripts/release/check_branch_protection_drift.sh
          chmod +x scripts/release/extract_required_checks_from_policy.sh

          scripts/release/check_branch_protection_drift.sh \
            --repo "${{ github.repository }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --out-dir "${{ env.OUT_DIR }}" \
            --verbose

          # Extract results for outputs
          DRIFT=$(jq -r '.drift_detected' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
          MISSING=$(jq -r '.summary.missing_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")
          EXTRA=$(jq -r '.summary.extra_in_github_count' "${{ env.OUT_DIR }}/branch_protection_drift_report.json")

          echo "drift_detected=${DRIFT}" >> $GITHUB_OUTPUT
          echo "missing_count=${MISSING}" >> $GITHUB_OUTPUT
          echo "extra_count=${EXTRA}" >> $GITHUB_OUTPUT

          echo "Drift detected: ${DRIFT}"
          echo "Missing in GitHub: ${MISSING}"
          echo "Extra in GitHub: ${EXTRA}"

      - name: Upload Drift Report
        uses: actions/upload-artifact@v4 # v4
        with:
          name: branch-protection-drift-report
          path: |
            ${{ env.OUT_DIR }}/branch_protection_drift_report.md
            ${{ env.OUT_DIR }}/branch_protection_drift_report.json
          retention-days: 30

      - name: Check Deduplication
        id: dedup
        if: steps.check.outputs.drift_detected == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const branch = '${{ steps.branch.outputs.branch }}';
            const missing = ${{ steps.check.outputs.missing_count }};
            const extra = ${{ steps.check.outputs.extra_count }};

            // Create a fingerprint of the drift state
            const driftKey = `${branch}_${missing}_${extra}`;
            core.info(`Drift key: ${driftKey}`);

            // Search for existing drift issues with matching title
            const titlePattern = `[Governance Drift] Branch protection does not match REQUIRED_CHECKS_POLICY (${branch})`;

            // Use search API for deduplication (better for large repos)
            const q = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:governance in:title "${titlePattern}"`;

            const searchResult = await github.rest.search.issuesAndPullRequests({
              q: q,
              per_page: 1
            });

            const existingIssue = searchResult.data.items.length > 0 ? searchResult.data.items[0] : null;

            if (existingIssue) {
              core.info(`Found existing issue #${existingIssue.number}`);

              // Check if updated within 24h by looking at comments
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number
              });

              const lastUpdate = comments.data.length > 0
                ? new Date(comments.data[comments.data.length - 1].created_at)
                : new Date(existingIssue.created_at);

              const now = new Date();
              const diffHours = (now - lastUpdate) / (1000 * 60 * 60);

              if (diffHours < 24) {
                core.notice(`Issue #${existingIssue.number} updated within 24h, skipping`);
                core.setOutput('action', 'skip');
              } else {
                core.setOutput('action', 'update');
                core.setOutput('issue_number', existingIssue.number);
              }
            } else {
              core.info('No existing issue found, will create new one');
              core.setOutput('action', 'create');
            }

            core.setOutput('drift_key', driftKey);

      - name: Generate Issue Body
        id: body
        if: (steps.dedup.outputs.action == 'create' || steps.dedup.outputs.action == 'update') && github.event.inputs.dry_run != 'true'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          REPORT_JSON="${{ env.OUT_DIR }}/branch_protection_drift_report.json"

          MISSING_CHECKS=$(jq -r '.missing_in_github[]' "${REPORT_JSON}" | head -10)
          EXTRA_CHECKS=$(jq -r '.extra_in_github[]' "${REPORT_JSON}" | head -10)
          API_ERROR=$(jq -r '.api_error // ""' "${REPORT_JSON}")

          cat > issue_body.md << 'EOF'
          ## Branch Protection Drift Detected

          Policy-as-code (`REQUIRED_CHECKS_POLICY.yml`) does not match GitHub branch protection enforcement.

          **Branch:** `${{ steps.branch.outputs.branch }}`
          **Detected:** $(date -u +"%Y-%m-%d %H:%M UTC")

          ---

          ### Summary

          | Category | Count |
          |----------|-------|
          | Missing in GitHub | ${{ steps.check.outputs.missing_count }} |
          | Extra in GitHub | ${{ steps.check.outputs.extra_count }} |

          EOF

          if [[ -n "$API_ERROR" ]]; then
            cat >> issue_body.md << EOF

          ### API Access Issue

          \`\`\`
          ${API_ERROR}
          \`\`\`

          EOF
          fi

          if [[ ${{ steps.check.outputs.missing_count }} -gt 0 ]]; then
            cat >> issue_body.md << 'MISSING_EOF'

          ### Checks Missing from GitHub Branch Protection

          These checks are required by policy but not enforced:

          MISSING_EOF

            jq -r '.missing_in_github[]' "${REPORT_JSON}" | while read -r check; do
              echo "- \`${check}\`" >> issue_body.md
            done
          fi

          if [[ ${{ steps.check.outputs.extra_count }} -gt 0 ]]; then
            cat >> issue_body.md << 'EXTRA_EOF'

          ### Extra Checks in GitHub Branch Protection

          These checks are enforced but not in policy:

          EXTRA_EOF

            jq -r '.extra_in_github[]' "${REPORT_JSON}" | while read -r check; do
              echo "- \`${check}\`" >> issue_body.md
            done
          fi

          cat >> issue_body.md << 'REMEDIATION_EOF'

          ---

          ### Remediation

          **Option A: Update GitHub branch protection to match policy**

          1. Go to **Settings** → **Branches** → **Branch protection rules**
          2. Edit the rule for the affected branch
          3. Add missing checks / remove extra checks

          **Option B: Update policy to match GitHub**

          1. Edit `docs/ci/REQUIRED_CHECKS_POLICY.yml`
          2. Add/remove entries from `always_required` section
          3. Create PR for review

          **Option C: Sync via Workflow**

          1. Run the [Sync Branch Protection](${{ github.server_url }}/${{ github.repository }}/actions/workflows/sync-branch-protection.yml) workflow manually.
             - Branch: `${{ steps.branch.outputs.branch }}`
             - Dry Run: `false`

          ---

          ### Links

          - [REQUIRED_CHECKS_POLICY.yml](../../docs/ci/REQUIRED_CHECKS_POLICY.yml)
          - [Branch Protection Settings](../../settings/branches)
          - [Drift Detection Documentation](../../docs/ci/BRANCH_PROTECTION_DRIFT.md)
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---

          *This issue is automatically created/updated by the Branch Protection Drift Detection workflow.*
          REMEDIATION_EOF

      - name: Create Issue
        if: steps.dedup.outputs.action == 'create' && github.event.inputs.dry_run != 'true'
        id: create
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const branch = '${{ steps.branch.outputs.branch }}';

            const title = `[Governance Drift] Branch protection does not match REQUIRED_CHECKS_POLICY (${branch})`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['governance', 'ci', 'release-ops', 'severity:P1']
            });

            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

      - name: Update Issue
        if: steps.dedup.outputs.action == 'update' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue_body.md', 'utf8');
            const issueNumber = ${{ steps.dedup.outputs.issue_number || 0 }};

            if (issueNumber > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## Drift Update (${new Date().toISOString()})\n\n${body}`
              });

              console.log(`Updated issue #${issueNumber}`);
            }

      - name: Auto-Close on Resolution
        if: steps.check.outputs.drift_detected == 'false' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            // Find open drift issues and close them
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'governance',
              state: 'open'
            });

            for (const issue of issues.data) {
              if (issue.title.includes('[Governance Drift]') && issue.title.includes('Branch protection')) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '## Resolved\n\nBranch protection is now in sync with policy. Closing this issue.'
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });

                console.log(`Closed issue #${issue.number}`);
              }
            }

      - name: Generate Summary
        run: |
          echo "## Branch Protection Drift Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auth Source:** ${{ steps.auth.outputs.auth_source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Drift Detected:** ${{ steps.check.outputs.drift_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check.outputs.drift_detected }}" == "true" ]]; then
            echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Missing in GitHub | ${{ steps.check.outputs.missing_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Extra in GitHub | ${{ steps.check.outputs.extra_count }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Policy and branch protection are in sync." >> $GITHUB_STEP_SUMMARY
          fi
