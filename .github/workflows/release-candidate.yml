name: Release Candidate Cut

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'The base branch to cut the release candidate from.'
        required: true
        default: 'main'
      rc_number:
        description: 'Optional manual override for the RC number (the .N part).'
        required: false
      publish:
        description: 'If true, create a tag and a draft GitHub Release.'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  cut-branch:
    name: "1️⃣ Cut RC Branch"
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.cut.outputs.branch_name }}
      rc_number: ${{ steps.cut.outputs.rc_number }}
      version: ${{ steps.cut.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.base_branch }}
          fetch-depth: 0 # Needed for branch calculations

      - name: Setup pnpm with cache
        uses: ./.github/actions/setup-pnpm

      - name: Cut RC Branch
        id: cut
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Run the script and capture the JSON output directly.
          # All logs are now on stderr.
          json_output=$(node scripts/release/cut_rc_branch.mjs --push --rc-number=${{ github.event.inputs.rc_number }})

          # Set outputs for the next jobs
          branch_name=$(echo "$json_output" | jq -r .branchName)
          rc_number=$(echo "$json_output" | jq -r .rcNumber)
          version=$(echo "$json_output" | jq -r .version)
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "rc_number=$rc_number" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

  run-readiness-gates:
    name: "2️⃣ Run Readiness Gates"
    needs: cut-branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RC Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.cut-branch.outputs.branch_name }}

      - name: Setup pnpm with cache
        uses: ./.github/actions/setup-pnpm

      - name: Run Release Readiness Checks
        id: readiness
        run: |
          pnpm release:ready
          # In a real scenario, this would generate evidence and dashboard JSON files.
          # For this exercise, we'll create placeholder artifacts.
          mkdir -p artifacts
          echo "Release Readiness Passed" > artifacts/release-readiness.txt
          echo '{"version": "4.1.1", "gates": {"lint": "pass", "test": "pass"}}' > artifacts/release-dashboard.json
          echo "Evidence Bundle Content" > artifacts/evidence-bundle.txt

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

  create-pr-and-draft-notes:
    name: "3️⃣ Create PR and Draft Notes"
    needs: [cut-branch, run-readiness-gates]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Generate Release Notes
        id: notes
        run: |
          dashboard=$(cat artifacts/release-dashboard.json)
          version=$(echo "$dashboard" | jq -r .version)

          # This is a simplified release notes generator.
          # A more sophisticated version would parse commit history.
          release_notes=$(cat <<EOF
          ## Release Candidate: v${version}

          This is an automated release candidate.

          ### Readiness Gates
          - **Lint:** $(echo "$dashboard" | jq -r .gates.lint)
          - **Tests:** $(echo "$dashboard" | jq -r .gates.test)

          ### Artifacts
          - Release Readiness: [release-readiness.txt](placeholder)
          - Evidence Bundle: [evidence-bundle.txt](placeholder)
          - Release Dashboard: [release-dashboard.json](placeholder)
          EOF
          )
          echo "$release_notes" > artifacts/release-notes.md
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$release_notes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Upload Release Notes Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-artifact
          path: artifacts/release-notes.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): prepare for release v${{ steps.notes.outputs.version }}"
          title: "Release Candidate v${{ steps.notes.outputs.version }}"
          body: ${{ steps.notes.outputs.release_notes }}
          branch: ${{ needs.cut-branch.outputs.branch_name }}
          base: ${{ github.event.inputs.base_branch }}
          draft: true

  tag-and-publish:
    name: "4️⃣ Tag and Publish"
    if: ${{ github.event.inputs.publish == true }}
    needs: [cut-branch, run-readiness-gates, create-pr-and-draft-notes]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RC Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.cut-branch.outputs.branch_name }}

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Tag and Draft Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.cut-branch.outputs.version }}-rc.${{ needs.cut-branch.outputs.rc_number }}
          name: Release v${{ needs.cut-branch.outputs.version }} RC ${{ needs.cut-branch.outputs.rc_number }}
          body_path: artifacts/release-notes-artifact/release-notes.md
          draft: true
          files: |
            artifacts/release-artifacts/release-dashboard.json
            artifacts/release-artifacts/evidence-bundle.txt
