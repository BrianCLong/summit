name: Monorepo Build & Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm
          key: pnpm-client-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'client/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-client-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            airflow/requirements.txt

      - name: Cache Cargo registry and git index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true
          cache-dependency-path: |
            sdk/go/abac/go.sum

      - name: Bootstrap all languages
        run: make bootstrap

      - name: Run monorepo tests
        run: make test

      - name: Upload JS/TS test reports
        uses: actions/upload-artifact@v4
        with:
          name: client-test-artifacts
          path: |
            client/test-results
            client/coverage
          if-no-files-found: warn

      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-python-coverage
          path: backend/coverage.xml
          if-no-files-found: warn

      - name: Upload Airflow coverage
        uses: actions/upload-artifact@v4
        with:
          name: airflow-python-coverage
          path: airflow/coverage.xml
          if-no-files-found: warn

      - name: Upload Rust coverage
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage
          path: target/lcov.info
          if-no-files-found: warn

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: sdk/go/abac/coverage.txt
          if-no-files-found: warn
