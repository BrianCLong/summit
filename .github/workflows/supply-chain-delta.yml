name: ci/supply-chain-delta
on:
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Require deps delta doc when lockfiles change
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "$CHANGED" | grep -E "(package-lock.json|pnpm-lock.yaml|yarn.lock|requirements.txt|poetry.lock)" && LOCK_CHANGED=1 || LOCK_CHANGED=0
          if [ "$LOCK_CHANGED" = "1" ]; then
            echo "Lockfile change detected. Checking for docs/supply-chain/deps-delta.md..."
            if [ ! -f docs/supply-chain/deps-delta.md ]; then
              echo "Error: docs/supply-chain/deps-delta.md is required when lockfiles are modified."
              exit 1
            fi
            echo "deps-delta.md found."
          else
            echo "No lockfile changes detected."
          fi
