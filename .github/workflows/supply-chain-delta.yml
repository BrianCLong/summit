name: ci/supply-chain-delta
on:
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Require deps delta doc when lockfiles change
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git fetch --no-tags origin "$BASE_SHA" "$HEAD_SHA" --depth=1
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")
          echo "$CHANGED" | grep -E "(package-lock.json|pnpm-lock.yaml|yarn.lock|requirements.txt|poetry.lock)" && LOCK_CHANGED=1 || LOCK_CHANGED=0
          if [ "$LOCK_CHANGED" = "1" ]; then
            echo "Lockfile change detected. Checking for docs/supply-chain/deps-delta.md..."
            if [ ! -f docs/supply-chain/deps-delta.md ]; then
              echo "Error: docs/supply-chain/deps-delta.md is required when lockfiles are modified."
              exit 1
            fi
            echo "deps-delta.md found."
          else
            echo "No lockfile changes detected."
          fi
