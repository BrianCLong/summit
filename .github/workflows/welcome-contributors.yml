name: Welcome Contributors

on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - name: Welcome first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const pr = context.payload.pull_request;
            const isIssue = !!issue;
            const isPR = !!pr;
            const number = issue?.number || pr?.number;
            const author = issue?.user.login || pr?.user.login;
            
            // Check if this is the user's first contribution
            const { data: contributions } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: author,
              state: 'all',
              per_page: 100
            });
            
            const prContributions = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            const userPRs = prContributions.data.filter(p => p.user.login === author);
            
            const isFirstIssue = contributions.length === 1 && isIssue;
            const isFirstPR = userPRs.length === 1 && isPR;
            
            if (isFirstIssue) {
              const welcomeMessage = `ðŸ‘‹ Welcome to Summit, @${author}!

Thank you for opening your first issue! We're excited to have you contribute to the project.

### What happens next?

1. **Triage**: Our team or automation will review and label your issue
2. **Discussion**: We may ask questions or request more information
3. **Assignment**: If approved, someone will work on this or it may be marked as "help wanted"

### How you can help

- Provide as much detail as possible
- Respond to any questions promptly
- If you'd like to work on this yourself, let us know!

### Resources

- [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
- [Code of Conduct](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CODE_OF_CONDUCT.md)
- [Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/docs)

Welcome aboard! ðŸš€`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: welcomeMessage
              });
              
              // Add first-time label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['first-time-contributor']
              });
            }
            
            if (isFirstPR) {
              const welcomeMessage = `ðŸŽ‰ Congratulations on your first Pull Request to Summit, @${author}!

Thank you for contributing! We're thrilled to have you as part of the community.

### What happens next?

1. **Automated Checks**: GitHub Actions will run tests and checks
2. **Review**: A maintainer will review your code
3. **Feedback**: We may request changes or ask questions
4. **Merge**: Once approved, your PR will be merged!

### Tips for success

- Ensure all tests pass
- Respond to review comments promptly  
- Keep your PR focused on a single change
- Update documentation if needed
- Be patient - reviews may take a few days

### Resources

- [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
- [Code Style Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/docs/coding_standards)
- [PR Template](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/PULL_REQUEST_TEMPLATE.md)

Thank you for making Summit better! ðŸŒŸ`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: welcomeMessage
              });
              
              // Add first-time label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['first-time-contributor']
              });
            }
