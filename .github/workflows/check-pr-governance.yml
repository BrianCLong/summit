name: "Governance: PR Compliance"

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-pr-compliance:
    name: "PR Governance Check"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate PR Metadata
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";

            // 1. Check Change Class
            const patchCheck = /- \[x\] ğŸŸ¢ \*\*Patch\*\*/i.test(body);
            const minorCheck = /- \[x\] ğŸŸ¡ \*\*Minor\*\*/i.test(body);
            const breakingCheck = /- \[x\] ğŸ”´ \*\*Breaking\*\*/i.test(body);
            const hasClass = patchCheck || minorCheck || breakingCheck;

            if (!hasClass) {
              core.setFailed("âŒ Missing Change Class! Please check Patch, Minor, or Breaking.");
            }

            // 2. Check Velocity Lane
            const fastLaneCheck = /- \[x\] ğŸï¸ \*\*Fast Lane\*\*/i.test(body);
            const standardLaneCheck = /- \[x\] ğŸš— \*\*Standard Lane\*\*/i.test(body);
            const guardedLaneCheck = /- \[x\] ğŸ›¡ï¸ \*\*Guarded Lane\*\*/i.test(body);
            const hasLane = fastLaneCheck || standardLaneCheck || guardedLaneCheck;

            if (!hasLane) {
               core.setFailed("âŒ Missing Velocity Lane! Please check Fast, Standard, or Guarded Lane.");
            }

            // 3. Check Agent Metadata (if declared agent-generated)
            const isAgent = /- \[x\] ğŸ¤– \*\*Yes, this PR was generated by an agent\.\*\*/i.test(body);

            if (isAgent) {
              console.log("ğŸ¤– Agent-generated PR detected. Validating metadata...");

              const agentName = /-\s*\*\*Agent Name\*\*:\s*(.+)/i.exec(body);
              const promptFile = /-\s*\*\*Prompt File\*\*:\s*(.+)/i.exec(body);
              const promptVersion = /-\s*\*\*Prompt Version\*\*:\s*(.+)/i.exec(body);

              if (!agentName || agentName[1].trim() === "") {
                core.setFailed("âŒ Agent Name is required for agent-generated PRs.");
              }
              if (!promptFile || promptFile[1].trim() === "") {
                core.setFailed("âŒ Prompt File is required for agent-generated PRs.");
              }
              if (!promptVersion || promptVersion[1].trim() === "") {
                core.setFailed("âŒ Prompt Version is required for agent-generated PRs.");
              }
            } else {
              console.log("ğŸ‘¤ Human-generated PR (or agent did not declare). Skipping metadata check.");
            }

            if (hasClass && hasLane) {
              console.log("âœ… Basic governance checks passed.");
            }
