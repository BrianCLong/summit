name: üèóÔ∏è Mega PR Excavator - Mass Recovery

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours (2x faster)
  workflow_dispatch:
    inputs:
      max_prs:
        description: 'Max PRs to recover per run'
        required: false
        default: '50'
      recovery_mode:
        description: 'Recovery mode'
        required: false
        default: 'aggressive'
        type: choice
        options:
          - smart
          - aggressive
          - ultra

permissions:
  contents: write
  pull-requests: write

jobs:
  # Parallel excavation workers
  excavate-batch-1:
    name: Recovery Batch 1 (0-100)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "Mega Excavator Bot"
          git config user.email "excavator@summit.dev"
          git config pull.rebase false

      - name: Batch recovery
        env:
          GH_TOKEN: ${{ github.token }}
          BATCH_START: 0
          BATCH_SIZE: 100
        run: |
          bash .github/scripts/excavate-pr-batch.sh 0 100

  excavate-batch-2:
    name: Recovery Batch 2 (100-200)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "Mega Excavator Bot"
          git config user.email "excavator@summit.dev"
          git config pull.rebase false

      - name: Batch recovery
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          bash .github/scripts/excavate-pr-batch.sh 100 100

  excavate-batch-3:
    name: Recovery Batch 3 (200-300)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "Mega Excavator Bot"
          git config user.email "excavator@summit.dev"
          git config pull.rebase false

      - name: Batch recovery
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          bash .github/scripts/excavate-pr-batch.sh 200 100

  excavate-batch-4:
    name: Recovery Batch 4 (300-415)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "Mega Excavator Bot"
          git config user.email "excavator@summit.dev"
          git config pull.rebase false

      - name: Batch recovery
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          bash .github/scripts/excavate-pr-batch.sh 300 115

  report:
    name: Recovery Report
    needs: [excavate-batch-1, excavate-batch-2, excavate-batch-3, excavate-batch-4]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate recovery report
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== MEGA EXCAVATOR REPORT ==="
          echo "Timestamp: $(date -u)"
          echo "Total closed unmerged: $(gh pr list --state closed --limit 1000 --json mergedAt --jq '[.[] | select(.mergedAt == null)] | length')"
          echo "Recovery PRs created: $(gh pr list --search 'Recovery in:title' --limit 500 | wc -l)"
          echo "Processing capacity: 400+ PRs per 3 hours"
