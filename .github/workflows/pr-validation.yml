name: üîç PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

# Prevent concurrent validation runs on same PR
concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.11.1'
  PNPM_VERSION: '9.6.0'

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  security-events: write

jobs:
  # 1. Triage & Risk Assessment
  triage:
    name: üö¶ Risk Assessment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run_validation: ${{ steps.check.outputs.should_run }}
      risk_level: ${{ steps.analyze.outputs.risk_level }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR status
        id: check
        run: |
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping validation for draft PR"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze Risk
        id: analyze
        if: steps.check.outputs.should_run == 'true'
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          RISK_SCORE=0

          if echo "$CHANGED_FILES" | grep -E "(migration|schema)" > /dev/null; then RISK_SCORE=$((RISK_SCORE + 3)); fi
          if echo "$CHANGED_FILES" | grep -E "(charts/|deploy/)" > /dev/null; then RISK_SCORE=$((RISK_SCORE + 2)); fi
          if echo "$CHANGED_FILES" | grep -E "\.github/workflows/" > /dev/null; then RISK_SCORE=$((RISK_SCORE + 2)); fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          if [[ $FILE_COUNT -gt 20 ]]; then RISK_SCORE=$((RISK_SCORE + 2)); fi

          if [[ $RISK_SCORE -ge 5 ]]; then RISK_LEVEL="HIGH";
          elif [[ $RISK_SCORE -ge 3 ]]; then RISK_LEVEL="MEDIUM";
          else RISK_LEVEL="LOW"; fi

          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT

          # Label PR
          gh pr edit ${{ github.event.pull_request.number }} --add-label "risk:$RISK_LEVEL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. Fast Fail-Fast Checks (Lint, Typecheck, Build)
  fast-checks:
    name: ‚ö° Fast Checks
    needs: triage
    if: needs.triage.outputs.should_run_validation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
      - run: corepack enable
      - run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Typecheck
        run: pnpm run typecheck

      - name: Build (Dry Run)
        run: pnpm run build

  # 3. Parallel Matrix Checks (Test, Security, Quality)
  matrix-validation:
    name: üõ°Ô∏è Matrix Validation
    needs: fast-checks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: true
      matrix:
        check: [unit-test, security, quality]
    steps:
      - uses: actions/checkout@v4
        with:
           fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
      - run: corepack enable
      - run: pnpm install --frozen-lockfile

      # Unit Tests
      - name: Run Unit Tests
        if: matrix.check == 'unit-test'
        run: pnpm run test --coverage

      # Security Scans (Full Polyglot Support)
      - name: Run Security Scans
        if: matrix.check == 'security'
        run: |
          # Use pnpm audit (native)
          pnpm audit --prod --json > audit.json || true

          # Gate using the audit script if it exists, else fail on pnpm audit exit code
          if [[ -f ".github/scripts/audit-gate.js" ]]; then
            node .github/scripts/audit-gate.js audit.json
          else
             if [ ! -s audit.json ]; then
                pnpm audit --prod
             fi
          fi

          # Python audit
          if [[ -f "requirements.txt" ]]; then
            pip install pip-audit
            pip-audit -r requirements.txt --json > pip-audit.json || true
          fi

          # Go audit
          if ls *.go &> /dev/null; then
            go vet ./...
          fi

          # Cargo audit
          if [[ -f "Cargo.toml" ]]; then
            cargo install cargo-audit
            cargo audit --json > cargo-audit.json || true
          fi

          # Gradle audit
          if [[ -f "build.gradle" ]]; then
            ./gradlew dependencyCheckAnalyze || true
          fi

      - name: Gitleaks
        if: matrix.check == 'security'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          args: '--redact --exit-code 1 --report-format sarif --report-path gitleaks.sarif'

      - name: Generate SBOM (Polyglot)
        if: matrix.check == 'security'
        run: |
          # Node
          npx @cyclonedx/bom generate --output-file cyclonedx-node.json --output-format json

          # Python
          if [[ -f "requirements.txt" ]]; then
            pip install cyclonedx-bom
            cyclonedx-bom -r -o cyclonedx-python.json
          fi

          # Go
          if ls *.go &> /dev/null; then
            go install github.com/CycloneDX/cyclonedx-go/cmd/cyclonedx-go@latest
            cyclonedx-go -output cyclonedx-go.json
          fi

          # Rust
          if [[ -f "Cargo.toml" ]]; then
            cargo install cyclonedx-bom
            cyclonedx-bom -o cyclonedx-rust.json
          fi

      - name: Upload SBOM
        if: matrix.check == 'security'
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: cyclonedx-*.json

      # Quality/Helm Checks (Restored)
      - name: Helm Validation
        if: matrix.check == 'quality'
        run: |
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep "charts/"; then
             curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
             for chart in charts/*/; do
                if [[ -d "$chart" ]]; then
                   helm lint "$chart" || exit 1
                fi
             done
          fi

  # 4. E2E & Performance (Conditional)
  e2e-gates:
    name: üé¨ E2E & Performance
    needs: [triage, matrix-validation]
    if: needs.triage.outputs.risk_level == 'HIGH'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Services
        run: |
          # Using docker-compose.dev.yml (exists in root, confirmed)
          docker compose -f docker-compose.dev.yml up -d --build
          timeout 300 bash -c 'until curl -f http://localhost:4000/health; do sleep 5; done'

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run E2E Tests
        run: |
          BASE_URL=http://localhost:4000 npx playwright test --timeout=30000

      - name: Run k6 SLO Check
        run: |
          # Use host network to access localhost:4000
          docker run --network host -i grafana/k6 run -e BASE_URL=http://localhost:4000 - < k6/slo-probe.js

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.dev.yml down

  # 5. Final Policy Decision (OPA)
  policy-gate:
    name: üèõÔ∏è Policy Decision
    needs: [triage, fast-checks, matrix-validation, e2e-gates]
    if: always() && needs.triage.outputs.should_run_validation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Evaluate Policy
        run: |
          # Construct input JSON based on actual job results
          cat > input.json << EOF
          {
            "pr": {
              "number": ${{ github.event.pull_request.number }},
              "title": "${{ github.event.pull_request.title }}",
              "author": "${{ github.event.pull_request.user.login }}",
              "draft": ${{ github.event.pull_request.draft }},
              "mergeable": true
            },
            "analysis": {
              "risk_level": "${{ needs.triage.outputs.risk_level }}"
            },
            "quality_gates": {
              "build": ${{ needs.fast-checks.result == 'success' }},
              "typecheck": ${{ needs.fast-checks.result == 'success' }},
              "lint": ${{ needs.fast-checks.result == 'success' }},
              "tests": ${{ needs.matrix-validation.result == 'success' }},
              "security": ${{ needs.matrix-validation.result == 'success' }},
              "helm": ${{ needs.matrix-validation.result == 'success' }},
              "e2e": ${{ needs.e2e-gates.result == 'success' || needs.e2e-gates.result == 'skipped' }}
            },
            "changed_files": $(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | jq -R . | jq -s .)
          }
          EOF

          opa eval -d .github/policies/ -i input.json "data.summit.quality.decision" > result.json

          APPROVED=$(jq -r '.result.approved' result.json)
          if [[ "$APPROVED" == "true" ]]; then
            echo "‚úÖ Policy Approved"
          else
            echo "‚ùå Policy Denied"
            jq -r '.result.warnings[]?' result.json
            exit 1
          fi
