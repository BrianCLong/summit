name: validate-grafana-json
on:
  pull_request:
    paths:
      - 'grafana/dashboards/**/*.json'
      - 'summit_observability/**/*.json'
      - 'grafana/alerts/**/*.yml'
      - 'grafana/alerts/**/*.yaml'
      - 'grafana/alerts/**/*.json'
  push:
    branches: [main]
    paths:
      - 'grafana/dashboards/**/*.json'
      - 'summit_observability/**/*.json'
      - 'grafana/alerts/**/*.yml'
      - 'grafana/alerts/**/*.yaml'
      - 'grafana/alerts/**/*.json'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Grafana Dashboard JSON
        run: |
          echo "üîç Validating Grafana dashboard JSON files..."
          for dir in grafana/dashboards summit_observability; do
            if [[ -d "$dir" ]]; then
              find "$dir" -name "*.json" -type f | while read -r file; do
                echo "Checking: $file"
                if jq -e . "$file" >/dev/null; then
                  echo "‚úÖ $file is valid JSON"
                else
                  echo "‚ùå $file has invalid JSON syntax"
                  exit 1
                fi
              done
            else
              echo "‚ÑπÔ∏è Directory $dir not found, skipping."
            fi
          done
          echo "üéâ All Grafana dashboard JSON files are valid!"

      - name: Validate MC v0.3.5 Dashboard Structure
        run: |
          echo "üîç Validating MC v0.3.5 dashboard structure..."
          DASH_FILE="grafana/dashboards/mc-v035-tiles.json"
          if [[ -f "$DASH_FILE" ]]; then
            # Check for required panels
            PANEL_COUNT=$(jq '.panels | length' "$DASH_FILE")
            if [[ $PANEL_COUNT -ge 6 ]]; then
              echo "‚úÖ Dashboard has $PANEL_COUNT panels (‚â•6 required)"
            else
              echo "‚ùå Dashboard has only $PANEL_COUNT panels (<6 required)"
              exit 1
            fi

            # Check for required metrics
            if jq -r '.panels[].targets[]?.expr' "$DASH_FILE" | grep -q "mc_canary_composite_score"; then
              echo "‚úÖ Composite score metric found"
            else
              echo "‚ùå Missing mc_canary_composite_score metric"
              exit 1
            fi

            echo "üéâ MC v0.3.5 dashboard structure validated!"
          else
            echo "‚ö†Ô∏è MC v0.3.5 dashboard not found, skipping structure validation"
          fi

      - name: Validate Alert Rules
        run: |
          if [[ ! -d grafana/alerts ]]; then
            echo "‚ÑπÔ∏è No grafana/alerts directory found, skipping alert validation."
            exit 0
          fi

          python - <<'PY'
import json
import sys
from pathlib import Path

try:
    import yaml  # type: ignore
except ImportError:  # pragma: no cover - dependency bootstrap
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "pyyaml"])
    import yaml  # type: ignore

alert_dir = Path("grafana/alerts")
failures = []

for path in alert_dir.rglob("*"):
    if path.is_dir():
        continue
    try:
        if path.suffix.lower() == ".json":
            with path.open() as handle:
                content = json.load(handle)
        else:
            with path.open() as handle:
                content = yaml.safe_load(handle)
    except Exception as exc:  # pragma: no cover - validation
        failures.append(f"{path}: parse error ({exc})")
        continue

    groups = content.get("groups") if isinstance(content, dict) else None
    if not groups:
        failures.append(f"{path}: missing 'groups' definition")
        continue

    for group in groups:
        rules = group.get("rules") if isinstance(group, dict) else None
        if not rules:
            failures.append(f"{path}: group '{group.get('name', 'unknown')}' missing rules")
            continue
        for rule in rules:
            if not rule.get("alert") and not rule.get("title"):
                failures.append(f"{path}: rule missing alert/title")
            if not rule.get("expr") and not rule.get("condition"):
                failures.append(f"{path}: rule missing expr/condition")

if failures:
    for failure in failures:
        print(f"‚ùå {failure}")
    sys.exit(1)

print(\"‚úÖ Alert rule syntax and structure look good.\")
PY
