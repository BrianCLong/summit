name: validate-grafana-json
on:
  pull_request:
    paths:
      - 'observability/grafana/dashboards/**/*.json'
      - 'grafana/dashboards/**/*.json'
      - 'summit_observability/**/*.json'
      - 'observability/alerts/**/*.{yml,yaml,json}'
  push:
    branches: [main]
    paths:
      - 'observability/grafana/dashboards/**/*.json'
      - 'grafana/dashboards/**/*.json'
      - 'summit_observability/**/*.json'
      - 'observability/alerts/**/*.{yml,yaml,json}'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Grafana Dashboard JSON
        run: |
          echo "üîç Validating Grafana dashboard JSON files..."
          set -euo pipefail
          PATHS=(observability/grafana/dashboards grafana/dashboards summit_observability)
          found=0
          for dir in "${PATHS[@]}"; do
            if [[ -d "$dir" ]]; then
              while IFS= read -r file; do
                found=1
                echo "Checking: $file"
                if jq -e . "$file" >/dev/null; then
                  echo "‚úÖ $file is valid JSON"
                else
                  echo "‚ùå $file has invalid JSON syntax"
                  exit 1
                fi
              done < <(find "$dir" -name "*.json" -type f)
            fi
          done
          if [[ $found -eq 0 ]]; then
            echo "‚ö†Ô∏è No Grafana dashboard files found under ${PATHS[*]}"
          else
            echo "üéâ All Grafana dashboard JSON files are valid!"
          fi

      - name: Validate MC v0.3.5 Dashboard Structure
        run: |
          echo "üîç Validating MC v0.3.5 dashboard structure..."
          DASH_FILE="observability/grafana/dashboards/mc-v035-tiles.json"
          if [[ -f "$DASH_FILE" ]]; then
            # Check for required panels
            PANEL_COUNT=$(jq '.panels | length' "$DASH_FILE")
            if [[ $PANEL_COUNT -ge 6 ]]; then
              echo "‚úÖ Dashboard has $PANEL_COUNT panels (‚â•6 required)"
            else
              echo "‚ùå Dashboard has only $PANEL_COUNT panels (<6 required)"
              exit 1
            fi

            # Check for required metrics
            if jq -r '.panels[].targets[]?.expr' "$DASH_FILE" | grep -q "mc_canary_composite_score"; then
              echo "‚úÖ Composite score metric found"
            else
              echo "‚ùå Missing mc_canary_composite_score metric"
              exit 1
            fi

            echo "üéâ MC v0.3.5 dashboard structure validated!"
          else
            echo "‚ö†Ô∏è MC v0.3.5 dashboard not found, skipping structure validation"
          fi

      - name: Validate Summit RED dashboard coverage
        run: |
          set -euo pipefail
          DASH_FILE="observability/grafana/dashboards/summit-red-saturation.json"
          if [[ -f "$DASH_FILE" ]]; then
            REQUIRED=("Rate" "Error" "Latency" "Saturation")
            for keyword in "${REQUIRED[@]}"; do
              if jq -e --arg kw "$keyword" '.panels[].title | select(test($kw; "i"))' "$DASH_FILE" >/dev/null; then
                echo "‚úÖ Found panel matching \"$keyword\""
              else
                echo "‚ùå Missing panel containing \"$keyword\" in title"
                exit 1
              fi
            done
            echo "üéâ Summit RED dashboard has RED + saturation coverage"
          else
            echo "‚ö†Ô∏è Summit RED dashboard not found, skipping RED panel validation"
          fi

      - name: Validate alert rule files
        run: |
          set -euo pipefail
          pip install pyyaml >/dev/null
          python - <<'PY'
import json
import sys
from pathlib import Path

import yaml

paths = []
for base in ("observability/alerts", "summit_observability"):
    base_path = Path(base)
    if base_path.exists():
        paths.extend(base_path.rglob("*.yml"))
        paths.extend(base_path.rglob("*.yaml"))
        paths.extend(base_path.rglob("*.json"))

if not paths:
    print("‚ö†Ô∏è No alert rule files detected; skipping validation.")
    sys.exit(0)

for path in paths:
    try:
        if path.suffix == ".json":
            json.loads(path.read_text())
        else:
            yaml.safe_load(path.read_text())
    except Exception as exc:  # noqa: BLE001
        print(f"‚ùå {path}: {exc}")
        sys.exit(1)
    else:
        print(f"‚úÖ {path} parsed successfully")
print("üéâ Alert rules parsed without errors.")
PY
