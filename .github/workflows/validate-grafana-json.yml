name: validate-grafana-json
on:
  pull_request:
    paths:
      - 'observability/grafana/dashboards/**/*.json'
      - 'grafana/dashboards/**/*.json'
      - 'summit_observability/**/*.json'
      - 'observability/grafana/alerts/**/*.{yml,yaml,json}'
      - 'grafana/alerts/**/*.{yml,yaml,json}'
  push:
    branches: [main]
    paths:
      - 'observability/grafana/dashboards/**/*.json'
      - 'grafana/dashboards/**/*.json'
      - 'summit_observability/**/*.json'
      - 'observability/grafana/alerts/**/*.{yml,yaml,json}'
      - 'grafana/alerts/**/*.{yml,yaml,json}'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install validation dependencies
        run: python -m pip install --quiet pyyaml

      - name: Validate Grafana Dashboard JSON
        run: |
          echo "üîç Validating Grafana dashboard JSON files..."
          set -euo pipefail

          dashboard_dirs=(
            observability/grafana/dashboards
            grafana/dashboards
            summit_observability
          )

          found=false

          for dir in "${dashboard_dirs[@]}"; do
            if [[ -d "$dir" ]]; then
              while IFS= read -r file; do
                found=true
                echo "Checking: $file"
                if jq -e . "$file" >/dev/null; then
                  echo "‚úÖ $file is valid JSON"
                else
                  echo "‚ùå $file has invalid JSON syntax"
                  exit 1
                fi
              done < <(find "$dir" -name "*.json" -type f)
            fi
          done

          if [[ "$found" == "false" ]]; then
            echo "‚ÑπÔ∏è No Grafana dashboard JSON files found to validate."
          else
            echo "üéâ All Grafana dashboard JSON files are valid!"
          fi

      - name: Validate Grafana Alert Rules
        run: |
          echo "üîç Validating Grafana alert rule files..."
          set -euo pipefail

          alert_dirs=(
            observability/grafana/alerts
            grafana/alerts
          )

          alert_files=()
          for dir in "${alert_dirs[@]}"; do
            if [[ -d "$dir" ]]; then
              while IFS= read -r file; do
                alert_files+=("$file")
              done < <(find "$dir" -type f \( -name "*.yml" -o -name "*.yaml" -o -name "*.json" \))
            fi
          done

          if [[ ${#alert_files[@]} -eq 0 ]]; then
            echo "‚ÑπÔ∏è No Grafana alert rule files found; skipping."
            exit 0
          fi

          python - "${alert_files[@]}" <<'PY'
import json
import sys
from pathlib import Path

import yaml

paths = sys.argv[1:]
errors = []

for path_str in paths:
    path = Path(path_str)
    try:
        if path.suffix.lower() == '.json':
            with path.open() as f:
                content = json.load(f)
        else:
            with path.open() as f:
                content = yaml.safe_load(f)
    except Exception as exc:  # noqa: BLE001
        errors.append(f"{path}: unable to parse ({exc})")
        continue

    if not isinstance(content, dict):
        errors.append(f"{path}: expected a mapping at the top level")
        continue

    groups = content.get('groups')
    if not isinstance(groups, list) or not groups:
        errors.append(f"{path}: missing or empty 'groups' collection")
        continue

    for group in groups:
        if not isinstance(group, dict):
            errors.append(f"{path}: group entry is not a mapping")
            continue
        rules = group.get('rules')
        if not isinstance(rules, list) or not rules:
            errors.append(f"{path}: group '{group.get('name', '<unnamed>')}' has no rules")
            continue
        for rule in rules:
            if not isinstance(rule, dict):
                errors.append(f"{path}: rule entry is not a mapping")
                continue
            if not (rule.get('alert') or rule.get('title')):
                errors.append(f"{path}: rule missing 'alert' or 'title' key")
            if 'expr' not in rule and 'condition' not in rule:
                errors.append(f"{path}: rule '{rule.get('alert', rule.get('title', '<untitled>'))}' is missing 'expr'/'condition'")

if errors:
    for err in errors:
        print(f"‚ùå {err}")
    sys.exit(1)

print('üéâ All Grafana alert rule files look well-structured!')
PY

      - name: Validate MC v0.3.5 Dashboard Structure
        run: |
          echo "üîç Validating MC v0.3.5 dashboard structure..."
          DASH_FILE="observability/grafana/dashboards/mc-v035-tiles.json"
          if [[ -f "$DASH_FILE" ]]; then
            # Check for required panels
            PANEL_COUNT=$(jq '.panels | length' "$DASH_FILE")
            if [[ $PANEL_COUNT -ge 6 ]]; then
              echo "‚úÖ Dashboard has $PANEL_COUNT panels (‚â•6 required)"
            else
              echo "‚ùå Dashboard has only $PANEL_COUNT panels (<6 required)"
              exit 1
            fi

            # Check for required metrics
            if jq -r '.panels[].targets[]?.expr' "$DASH_FILE" | grep -q "mc_canary_composite_score"; then
              echo "‚úÖ Composite score metric found"
            else
              echo "‚ùå Missing mc_canary_composite_score metric"
              exit 1
            fi

            echo "üéâ MC v0.3.5 dashboard structure validated!"
          else
            echo "‚ö†Ô∏è MC v0.3.5 dashboard not found, skipping structure validation"
          fi
