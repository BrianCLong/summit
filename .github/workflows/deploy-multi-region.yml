name: Deploy to Multiple Regions

on:
  workflow_dispatch:
    inputs:
      regions:
        description: 'Comma-separated list of regions to deploy to (e.g., us-east-1,eu-west-1). Leave blank for all.'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Set up yq
        uses: mikefarah/yq@v4.30.8

      - name: Run multi-region deployment script and performance tests
        run: |
          REGIONS_TO_DEPLOY=$(echo "${{ github.event.inputs.regions }}" | tr ',' ' ')
          if [ -z "$REGIONS_TO_DEPLOY" ]; then
            REGIONS_TO_DEPLOY=$(yq e '.regions[].name' deploy/regions.yaml | tr '\n' ' ')
          fi

          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Deploying to $region ---"
            # In a real scenario, you'd remove --dry-run
            ./deploy/deploy-multi-region.sh $region

            echo "--- Running performance test for $region ---"
            k6 run \
              -e REGION=$region \
              k6/cross-region-latency.js
          done
