name: Deploy to Multiple Regions

on:
  workflow_dispatch:
    inputs:
      image_ref:
        description: "Container image reference with digest (e.g., ghcr.io/org/app@sha256:...)"
        required: true
      cosign_public_key:
        description: "Optional cosign public key path or value for verification"
        required: false
        default: ""
      expected_identity_regex:
        description: "Cosign certificate identity regex"
        required: false
        default: "^https://github.com/.+/.github/workflows/.+@.*$"
      expected_oidc_issuer:
        description: "Cosign certificate OIDC issuer"
        required: false
        default: "https://token.actions.githubusercontent.com"
      regions:
        description: "Comma-separated list of regions to deploy to (e.g., us-east-1,eu-west-1). Leave blank for all."
        required: false
        default: ""

jobs:
  resolve-regions:
    runs-on: ubuntu-latest
    outputs:
      regions: ${{ steps.set-regions.outputs.regions }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up yq
        uses: mikefarah/yq@v4.50.1
      - id: set-regions
        run: |
          INPUT_REGIONS="${{ github.event.inputs.regions }}"
          if [ -z "$INPUT_REGIONS" ]; then
            REGIONS_JSON=$(yq e '.regions[].name' deploy/regions.yaml -o=json | jq -c .)
          else
            REGIONS_JSON=$(echo "$INPUT_REGIONS" | tr ',' '\n' | jq -R . | jq -s -c .)
          fi
          echo "regions=$REGIONS_JSON" >> $GITHUB_OUTPUT

  pre-deploy-gate:
    needs: resolve-regions
    strategy:
      matrix:
        region: ${{ fromJson(needs.resolve-regions.outputs.regions) }}
    uses: ./.github/workflows/gate.yml
    with:
      region: ${{ matrix.region }}
      prometheus_url: ${{ secrets.PROMETHEUS_URL || 'http://prometheus:9090' }}

  deploy:
    needs: pre-deploy-gate
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment:
      name: production
      url: https://summit.example
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-role
          aws-region: us-east-1

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify SBOM attestation and signature (deployment gate)
        run: scripts/ci/verify-sbom-signature.sh "${{ inputs.image_ref }}"
        env:
          COSIGN_PUBLIC_KEY: ${{ inputs.cosign_public_key }}
          EXPECTED_IDENTITY_REGEX: ${{ inputs.expected_identity_regex }}
          EXPECTED_OIDC_ISSUER: ${{ inputs.expected_oidc_issuer }}

      - name: Upload supply chain compliance receipt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          retention-days: 14
          name: supply-chain-compliance-receipts
          path: artifacts/compliance-receipts

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.12.0"

      - name: Set up yq
        uses: mikefarah/yq@v4.50.1

      - name: Resolve target regions
        run: |
          REGIONS_TO_DEPLOY=$(echo '${{ needs.resolve-regions.outputs.regions }}' | jq -r '.[]' | tr '\n' ' ')
          echo "REGIONS_TO_DEPLOY=$REGIONS_TO_DEPLOY" >> "$GITHUB_ENV"

      - name: Run multi-region deployment script and performance tests
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Deploying to $region ---"
            # In a real scenario, you'd remove --dry-run
            ./deploy/deploy-multi-region.sh $region

            echo "--- Running performance test for $region ---"
            k6 run \
              -e REGION=$region \
              k6/cross-region-latency.js
          done

      - name: Canary synthetic probe
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Synthetic probe for $region ---"
            BASE_URL=${SERVICE_BASE_URL_TEMPLATE/\{region\}/$region}
            TARGET="$BASE_URL" k6 run k6/slo-probe.js
          done
        env:
          SERVICE_BASE_URL_TEMPLATE: ${{ secrets.SERVICE_BASE_URL_TEMPLATE || 'https://{region}.summit.example' }}

      - name: Promotion gate
        run: |
          echo "All canary gates passed. Ready to promote."

      - name: Promote canary to stable
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Promoting $region ---"
            ./deploy/promote-region.sh "$region"
          done
