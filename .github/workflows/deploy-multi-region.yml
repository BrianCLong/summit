name: Deploy to Multiple Regions

on:
  workflow_dispatch:
    inputs:
      regions:
        description: "Comma-separated list of regions to deploy to (e.g., us-east-1,eu-west-1). Leave blank for all."
        required: false
        default: ""
  push:
    branches: [main]

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-multi-region-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coverage-and-integration:
    name: Coverage + integration gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      - name: Run server coverage suite
        working-directory: server
        run: pnpm test:coverage -- --runInBand

      - name: Enforce coverage thresholds
        working-directory: server
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
          const thresholds = { lines: 80, statements: 80, branches: 70, functions: 80 };
          const totals = summary.total || {};

          for (const [metric, target] of Object.entries(thresholds)) {
            const value = (totals[metric] && totals[metric].pct) || 0;
            if (value < target) {
              throw new Error(`Coverage gate failed for ${metric}: ${value}% < ${target}%`);
            }
          }
          NODE

      - name: Run authz integration enforcement
        working-directory: server
        run: pnpm test:integration

      - name: Upload coverage summary
        uses: actions/upload-artifact@v4
        with:
          name: deploy-coverage-summary
          path: server/coverage/coverage-summary.json

  cve-scan:
    name: CVE gate (no bypass)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies for audit
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Enforce high/critical CVE gate
        run: pnpm audit --audit-level high

  smoke-tests:
    name: Smoke test gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run smoke tests
        env:
          CI: true
        run: pnpm run test:smoke

  deploy:
    name: Deploy after gates
    runs-on: ubuntu-latest
    needs: [coverage-and-integration, cve-scan, smoke-tests]
    environment:
      name: production
      url: https://summit.example
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.12.0"

      - name: Set up yq
        uses: mikefarah/yq@v4.30.8

      - name: Resolve target regions
        run: |
          REGIONS_TO_DEPLOY=$(echo "${{ github.event.inputs.regions }}" | tr ',' ' ')
          if [ -z "$REGIONS_TO_DEPLOY" ]; then
            REGIONS_TO_DEPLOY=$(yq e '.regions[].name' deploy/regions.yaml | tr '\n' ' ')
          fi
          echo "REGIONS_TO_DEPLOY=$REGIONS_TO_DEPLOY" >> "$GITHUB_ENV"

      - name: Run multi-region deployment script and performance tests
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Deploying to $region ---"
            ./deploy/deploy-multi-region.sh $region

            echo "--- Running performance test for $region ---"
            k6 run \
              -e REGION=$region \
              k6/cross-region-latency.js
          done

      - name: Canary error rate & latency gate
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Canary metrics gate for $region ---"
            PROMETHEUS_LABEL_FILTER="region=\"$region\"" ./scripts/canary-gate.sh
          done
        env:
          PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL || 'http://prometheus:9090' }}

      - name: Canary synthetic probe
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Synthetic probe for $region ---"
            BASE_URL=${SERVICE_BASE_URL_TEMPLATE/\{region\}/$region}
            TARGET="$BASE_URL" k6 run k6/slo-probe.js
          done
        env:
          SERVICE_BASE_URL_TEMPLATE: ${{ secrets.SERVICE_BASE_URL_TEMPLATE || 'https://{region}.summit.example' }}

      - name: Promotion gate
        run: |
          echo "All canary gates passed. Ready to promote."

      - name: Promote canary to stable
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Promoting $region ---"
            ./deploy/promote-region.sh "$region"
          done
