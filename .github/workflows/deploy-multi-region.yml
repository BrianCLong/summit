name: Deploy to Multiple Regions

on:
  workflow_dispatch:
    inputs:
      regions:
        description: "Comma-separated list of regions to deploy to (e.g., us-east-1,eu-west-1). Leave blank for all."
        required: false
        default: ""
      release_tag:
        description: "Release tag to deploy (must have signed provenance asset)."
        required: true
        default: "latest"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://summit.example
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.12.0"

      - name: Set up yq
        uses: mikefarah/yq@v4.30.8

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: v2.2.4

      - name: Download signed provenance
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p provenance
          gh release download "${{ inputs.release_tag }}" --pattern "provenance.json" --dir provenance --clobber
          gh release download "${{ inputs.release_tag }}" --pattern "provenance.json.sig" --dir provenance --clobber
          gh release download "${{ inputs.release_tag }}" --pattern "provenance.json.pem" --dir provenance --clobber

      - name: Verify provenance signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign verify-blob --yes \
            --cert provenance/provenance.json.pem \
            --signature provenance/provenance.json.sig \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/release-ga.yml@.*" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            provenance/provenance.json

      - name: Extract signed image URIs
        id: provenance
        run: |
          SERVER_IMAGE=$(jq -r '.images[] | select(.name=="server") | .uri' provenance/provenance.json)
          CLIENT_IMAGE=$(jq -r '.images[] | select(.name=="client") | .uri' provenance/provenance.json)

          if [ -z "$SERVER_IMAGE" ] || [ -z "$CLIENT_IMAGE" ]; then
            echo "Missing image references in provenance.json" >&2
            exit 1
          fi

          echo "server_image=$SERVER_IMAGE" >> "$GITHUB_OUTPUT"
          echo "client_image=$CLIENT_IMAGE" >> "$GITHUB_OUTPUT"

      - name: Verify server image signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign verify "${{ steps.provenance.outputs.server_image }}" \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/_reusable-slsa-build.yml@.*" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com

      - name: Verify client image signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign verify "${{ steps.provenance.outputs.client_image }}" \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/_reusable-slsa-build.yml@.*" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com

      - name: Resolve target regions
        run: |
          REGIONS_TO_DEPLOY=$(echo "${{ github.event.inputs.regions }}" | tr ',' ' ')
          if [ -z "$REGIONS_TO_DEPLOY" ]; then
            REGIONS_TO_DEPLOY=$(yq e '.regions[].name' deploy/regions.yaml | tr '\n' ' ')
          fi
          echo "REGIONS_TO_DEPLOY=$REGIONS_TO_DEPLOY" >> "$GITHUB_ENV"

      - name: Run multi-region deployment script and performance tests
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Deploying to $region ---"
            # In a real scenario, you'd remove --dry-run
            ./deploy/deploy-multi-region.sh $region

            echo "--- Running performance test for $region ---"
            k6 run \
              -e REGION=$region \
              k6/cross-region-latency.js
          done

      - name: Canary error rate & latency gate
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Canary metrics gate for $region ---"
            PROMETHEUS_LABEL_FILTER="region=\"$region\"" ./scripts/canary-gate.sh
          done
        env:
          PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL || 'http://prometheus:9090' }}

      - name: Canary synthetic probe
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Synthetic probe for $region ---"
            BASE_URL=${SERVICE_BASE_URL_TEMPLATE/\{region\}/$region}
            TARGET="$BASE_URL" k6 run k6/slo-probe.js
          done
        env:
          SERVICE_BASE_URL_TEMPLATE: ${{ secrets.SERVICE_BASE_URL_TEMPLATE || 'https://{region}.summit.example' }}

      - name: Promotion gate
        run: |
          echo "All canary gates passed. Ready to promote."

      - name: Promote canary to stable
        run: |
          for region in $REGIONS_TO_DEPLOY; do
            echo "--- Promoting $region ---"
            ./deploy/promote-region.sh "$region"
          done
