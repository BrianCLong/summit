name: Evidence Collection

# AUTOMATED GA RELEASE EVIDENCE COLLECTION
# Collects and archives verification evidence for compliance.
#
# See docs/ci/EVIDENCE_COLLECTION.md for full documentation.

on:
  # Run before scheduled releases
  schedule:
    - cron: "0 4 * * 1-5" # 4 AM UTC, Mon-Fri (before health check)

  # Manual trigger for on-demand collection
  workflow_dispatch:
    inputs:
      category:
        description: "Evidence category to collect"
        type: choice
        options:
          - all
          - ci
          - security
          - governance
          - audits
        default: all
      update_index:
        description: "Update evidence index"
        type: boolean
        default: false

  # Trigger on release tags
  push:
    tags:
      - "v*"
      - "rc-*"

  # Can be called by release workflow
  workflow_call:
    inputs:
      category:
        type: string
        default: "all"
    outputs:
      run_id:
        description: "Evidence collection run ID"
        value: ${{ jobs.collect.outputs.run_id }}
      status:
        description: "Collection status"
        value: ${{ jobs.collect.outputs.status }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: read

jobs:
  collect:
    name: Collect Evidence
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.collect.outputs.run_id }}
      status: ${{ steps.collect.outputs.status }}
      passed: ${{ steps.collect.outputs.passed }}
      failed: ${{ steps.collect.outputs.failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-# version handled by package.json
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Collect Evidence
        id: collect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/release/generate_evidence_bundle.sh

          CATEGORY="${{ inputs.category || 'all' }}"
          ARGS="--category $CATEGORY"

          if [[ "${{ inputs.update_index }}" == "true" ]]; then
            ARGS="$ARGS --update-index"
          fi

          # Run collection
          ./scripts/release/generate_evidence_bundle.sh $ARGS 2>&1 | tee collection.log

          # Parse summary file for outputs
          SUMMARY_FILE=$(ls artifacts/evidence/evidence-summary-*.md 2>/dev/null | tail -1)
          if [[ -n "$SUMMARY_FILE" ]]; then
            RUN_ID=$(basename "$SUMMARY_FILE" .md | sed 's/evidence-summary-//')
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

            # Count results
            PASSED=$(grep -c '✓' "$SUMMARY_FILE" || echo "0")
            FAILED=$(grep -c '✗' "$SUMMARY_FILE" || echo "0")
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT

            if [[ "$FAILED" -eq 0 ]]; then
              echo "status=PASS" >> $GITHUB_OUTPUT
            else
              echo "status=PARTIAL" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "run_id=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Upload Evidence Artifacts
        if: always()
        uses: actions/upload-artifact@v4 # v6
        with:
          name: evidence-${{ steps.collect.outputs.run_id || github.run_id }}
          path: |
            artifacts/evidence/
            collection.log
          retention-days: 90
          if-no-files-found: warn

      - name: Job Summary
        if: always()
        run: |
          STATUS="${{ steps.collect.outputs.status || 'UNKNOWN' }}"
          RUN_ID="${{ steps.collect.outputs.run_id || 'N/A' }}"
          PASSED="${{ steps.collect.outputs.passed || 0 }}"
          FAILED="${{ steps.collect.outputs.failed || 0 }}"

          STATUS_EMOJI="❓"
          [[ "$STATUS" == "PASS" ]] && STATUS_EMOJI="✅"
          [[ "$STATUS" == "PARTIAL" ]] && STATUS_EMOJI="⚠️"
          [[ "$STATUS" == "FAIL" ]] && STATUS_EMOJI="❌"

          echo "### $STATUS_EMOJI Evidence Collection: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`$RUN_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Evidence Collected | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Collection Failures | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Include summary if available
          SUMMARY_FILE=$(ls artifacts/evidence/evidence-summary-*.md 2>/dev/null | tail -1)
          if [[ -n "$SUMMARY_FILE" ]]; then
            echo "### Evidence Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
          fi

  archive:
    name: Archive Evidence
    runs-on: ubuntu-latest
    needs: collect
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Evidence
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: evidence-${{ needs.collect.outputs.run_id || github.run_id }}
          path: evidence/

      - name: Create Release Evidence Archive
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          ARCHIVE_NAME="evidence-${TAG}-${{ needs.collect.outputs.run_id }}.tar.gz"

          tar -czvf "$ARCHIVE_NAME" evidence/

          echo "Created archive: $ARCHIVE_NAME"
          ls -la "$ARCHIVE_NAME"

      - name: Upload Release Archive
        uses: actions/upload-artifact@v4 # v6
        with:
          name: release-evidence-${{ github.ref_name }}
          path: evidence-*.tar.gz
          retention-days: 90
