name: Canary Weight Progression
on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment (dev|staging|prod)'
        required: true
        default: 'staging'
      weight:
        description: 'Canary weight (0-100)'
        required: true
        default: '10'

jobs:
  set-weight:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env }}
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with: { version: 'v1.30.0' }
      - name: Auth to cluster
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Resolve namespace
        id: ns
        run: |
          if [ "${{ github.event.inputs.env }}" = "prod" ] || [ "${{ github.event.inputs.env }}" = "production" ]; then
            echo "name=intelgraph-prod" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.env }}" = "dev" ]; then
            echo "name=intelgraph-dev" >> $GITHUB_OUTPUT
          else
            echo "name=intelgraph-staging" >> $GITHUB_OUTPUT
          fi

      - name: Update canary weight annotation
        run: |
          kubectl annotate --overwrite ingress $(kubectl get ing -n ${{ steps.ns.outputs.name }} -o name | grep server) nginx.ingress.kubernetes.io/canary-weight="${{ github.event.inputs.weight }}" -n ${{ steps.ns.outputs.name }}
      - name: Verify SLOs after weight change
        env:
          PROMETHEUS_BASE_URL: ${{ secrets.PROMETHEUS_BASE_URL }}
          PROM_NAMESPACE: ${{ steps.ns.outputs.name }}
          TARGET_ENVIRONMENT: ${{ github.event.inputs.env }}
        run: ./.ci/scripts/verify_goldens.sh
