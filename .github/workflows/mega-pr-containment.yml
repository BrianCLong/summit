name: Mega PR Containment

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Number to analyze"
        required: true
        type: string
      generate_patches:
        description: "Generate patch files (experimental)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read

jobs:
  analyze-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
        with:
          fetch-depth: 0 # Needed for patch generation if used

      - name: Setup Node.js
        uses: actions/setup-node@1d1121627393d3093b167069a74422b94a9ec3f2 # v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@feaa6391d8481eb0db9d5b066fba94be3691684c # v4
        # version is read from package.json packageManager field

      - name: Install dependencies
        run: pnpm install

      - name: Run Containment Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FLAGS=""
          if [ "${{ inputs.generate_patches }}" = "true" ]; then
            FLAGS="--patches"
          fi

          # Create output directory
          mkdir -p artifacts/pr-containment/${{ inputs.pr_number }}

          npx tsx scripts/ops/mega_pr_containment.ts \
            --pr ${{ inputs.pr_number }} \
            --out artifacts/pr-containment/${{ inputs.pr_number }} \
            $FLAGS

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@0b2207062494160a33bd674828362627b9c46d9a # v4
        with:
          name: mega-pr-${{ inputs.pr_number }}-plan
          path: artifacts/pr-containment/${{ inputs.pr_number }}
          retention-days: 14
