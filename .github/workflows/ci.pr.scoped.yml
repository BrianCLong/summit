name: CI (PR scoped)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      workspaces: ${{ steps.compute.outputs.workspaces }}
      run_full: ${{ steps.compute.outputs.run_full }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20.14.x'
      - name: Compute affected workspaces
        id: compute
        run: |
          node scripts/ci/detect-affected-workspaces.js > result.json || echo '{"workspaces":[]}' > result.json
          workspaces=$(cat result.json | jq -c '.workspaces // []')
          if [ -z "$workspaces" ] || [ "$workspaces" = "[]" ]; then
            echo "run_full=true" >> $GITHUB_OUTPUT
          else
            echo "run_full=false" >> $GITHUB_OUTPUT
          fi
          echo "workspaces=${workspaces}" >> $GITHUB_OUTPUT

  scoped-ci:
    needs: detect
    if: needs.detect.outputs.run_full == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        workspace: ${{ fromJson(needs.detect.outputs.workspaces) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20.14.x'
          cache: 'pnpm'
      - name: Enable corepack + pnpm
        run: |
          corepack enable || true
          corepack prepare pnpm@9.12.3 --activate || true
      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false
      - name: Lint (affected workspace)
        run: pnpm --filter "${{ matrix.workspace }}" lint || pnpm lint
      - name: Typecheck (affected workspace)
        run: pnpm --filter "${{ matrix.workspace }}" typecheck || pnpm typecheck
      - name: Test (affected workspace)
        run: pnpm --filter "${{ matrix.workspace }}" test || pnpm test

  fallback-full:
    needs: detect
    if: needs.detect.outputs.run_full == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20.14.x'
          cache: 'pnpm'
      - name: Enable corepack + pnpm
        run: |
          corepack enable || true
          corepack prepare pnpm@9.12.3 --activate || true
      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false
      - name: Lint
        run: pnpm run lint || true
      - name: Typecheck
        run: pnpm run typecheck || true
      - name: Test
        run: pnpm run test || true
      - name: Build
        run: |
          if [ -x scripts/build-workspaces.sh ]; then
            bash scripts/build-workspaces.sh
          else
            echo "scripts/build-workspaces.sh not found; skipping"
          fi
