name: ci/trend-evidence
on:
  pull_request:
    paths:
      - "evidence/**"
      - "docs/trends/**"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate evidence directory exists
        run: test -f evidence/forbes-2026-trends/evidence/index.json
      - name: Basic JSON parse and Schema Validation (Ajv)
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          let Ajv;
          try {
            Ajv = require('ajv');
            console.log('Using Ajv for schema validation');
          } catch (e) {
            console.warn('Ajv not found, falling back to basic JSON parse');
          }

          const evidenceDir = 'evidence/forbes-2026-trends';
          const schemasDir = path.join(evidenceDir, 'schemas');

          const files = [
            ['evidence/index.json', 'index.schema.json'],
            ['report.json', 'report.schema.json'],
            ['metrics.json', 'metrics.schema.json'],
            ['stamp.json', null]
          ];

          let hasError = false;
          const ajv = Ajv ? new Ajv({ allErrors: true }) : null;

          files.forEach(([dataFile, schemaFile]) => {
            const dataPath = path.join(evidenceDir, dataFile);
            try {
              const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
              console.log('✓ ' + dataFile + ' is valid JSON');

              if (ajv && schemaFile) {
                const schemaPath = path.join(schemasDir, schemaFile);
                const schema = JSON.parse(fs.readFileSync(schemaPath, 'utf8'));
                const validate = ajv.compile(schema);
                const valid = validate(data);
                if (!valid) {
                  console.error('✗ Schema validation failed for ' + dataFile + ':', validate.errors);
                  hasError = true;
                } else {
                  console.log('✓ ' + dataFile + ' matches schema ' + schemaFile);
                }
              }
            } catch (err) {
              console.error('✗ Error processing ' + dataFile + ':', err.message);
              hasError = true;
            }
          });

          if (hasError) process.exit(1);
          "
