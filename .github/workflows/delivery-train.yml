name: Golden Path Delivery

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  packages: write
  pull-requests: read

jobs:
  unit:
    uses: ./.github/workflows/reusable/unit.yml

  contract:
    uses: ./.github/workflows/reusable/contract.yml

  e2e:
    uses: ./.github/workflows/reusable/e2e.yml

  sast_sca:
    uses: ./.github/workflows/reusable/sast_sca.yml

  sbom:
    uses: ./.github/workflows/reusable/sbom.yml

  iac_plan:
    uses: ./.github/workflows/reusable/iac_plan.yml

  policy_opa:
    uses: ./.github/workflows/reusable/policy_opa.yml

  migrations_gate:
    uses: ./.github/workflows/reusable/migrations_gate.yml

  package:
    needs: [unit, contract, e2e, sast_sca, sbom, iac_plan, policy_opa, migrations_gate]
    uses: ./.github/workflows/reusable/package.yml

  preview_deploy:
    needs: [unit, contract, e2e, sast_sca, sbom, iac_plan, policy_opa, migrations_gate, package]
    uses: ./.github/workflows/reusable/preview_deploy.yml

  attestation:
    name: attestation
    needs: package
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: package-artifacts
          path: package-artifacts

      - name: Generate provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: package-artifacts/build.tar.gz
