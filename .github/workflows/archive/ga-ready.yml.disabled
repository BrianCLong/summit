name: GA Readiness Check

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/workflows/*.md"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/workflows/*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ga-ready:
    name: GA Readiness Gate
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      pull-requests: write
      statuses: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: "10.0.0"

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prepare evidence directories
        run: |
          mkdir -p .evidence/ga
          mkdir -p artifacts/ga/ga-ready

      - name: Boot Minimal Stack
        run: |
          docker compose -f docker-compose.yml -f docker-compose.minimal.yml up -d
          # Wait for services to be healthy (basic wait)
          echo "Waiting for stack to boot..."
          sleep 30
          # We could use wait-for-it or healthcheck here

      - name: Run Gitleaks
        id: gitleaks
        continue-on-error: true
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

      - name: Run Trivy
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # v0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "secret,vuln"
          severity: "CRITICAL,HIGH"
          format: "json"
          output: "trivy-results.json"
          exit-code: "1"

      - name: Run GA Readiness Check
        id: ga_check
        run: |
          ./bin/ga-check.mjs

      - name: Enforce scan status
        if: always()
        run: |
          if [ "${{ steps.gitleaks.outcome }}" = "failure" ]; then
            echo "Gitleaks reported failure"
            exit 1
          fi
          if [ "${{ steps.trivy.outcome }}" = "failure" ]; then
            echo "Trivy reported failure"
            exit 1
          fi

      - name: Collect evidence bundle
        if: always()
        run: |
          # Preserve raw security scan output for determinism
          cp -f results.sarif .evidence/ga/gitleaks.sarif || true
          cp -f trivy-results.json .evidence/ga/trivy-results.json || true
          cp -rf .evidence/ga artifacts/ga/ga-ready/

      - name: Upload Evidence
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          retention-days: 14
          name: ga-evidence
          path: artifacts/ga/ga-ready/
          if-no-files-found: error

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the report file
            // Since sha might differ, we look in .evidence/ga/
            const evidenceDir = '.evidence/ga';
            if (!fs.existsSync(evidenceDir)) return;

            const dirs = fs.readdirSync(evidenceDir);
            if (dirs.length === 0) return;

            const reportPath = path.join(evidenceDir, dirs[0], 'report.md');
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              const status = '${{ job.status }}' === 'success' ? '✅ GA Ready' : '❌ GA Checks Failed';

              const body = `### ${status}\n\n${report}`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
