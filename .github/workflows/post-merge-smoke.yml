name: post-merge-smoke

permissions:
  contents: read
on:
  workflow_dispatch:
    inputs:
      preview_url: { description: 'Preview URL', required: false, type: string }
      prod_url: { description: 'Prod URL', required: false, type: string }
  workflow_run:
    workflows: ['ci', 'ui-ci']
    types: [completed]

jobs:
  smoke:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      PREVIEW_URL: ${{ github.event.inputs.preview_url || secrets.POSTMERGE_PREVIEW_URL || '' }}
      PROD_URL: ${{ github.event.inputs.prod_url    || secrets.POSTMERGE_PROD_URL    || '' }}
    steps:
      - name: Curl preview
        if: ${{ env.PREVIEW_URL != '' }}
        run: |
          echo "Preview: $PREVIEW_URL"
          curl -fsS "$PREVIEW_URL/healthz" | jq .
          curl -fsS "$PREVIEW_URL/readyz"  | jq .
      - name: Curl prod
        if: ${{ env.PROD_URL != '' }}
        run: |
          echo "Prod: $PROD_URL"
          curl -fsS "$PROD_URL/healthz" | jq .
          curl -fsS "$PROD_URL/readyz"  | jq .
