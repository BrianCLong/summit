name: Enqueue

on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  enqueue:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/checkout@v4

    - uses: actions/checkout@v4

    - name: Enqueue if ready
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        pr=${{ github.event.pull_request.number }}

        labels=$(gh pr view $pr --repo ${{ github.repository }} --json labels --jq '.labels[].name')
        approvals=$(gh pr view $pr --repo ${{ github.repository }} --json reviews --jq '[.reviews[] | select(.state=="APPROVED")] | length')
        checks=$(gh pr checks $pr --repo ${{ github.repository }} --required)

        if echo "$labels" | grep -q "queue:ready" && [ "$approvals" -ge 1 ]; then
          gh pr view $pr --repo ${{ github.repository }} --json number || echo "Ensuring context"
          gh api repos/${{ github.repository }}/pulls/$pr/merge-queue/enqueue \
            -f merge_method=squash || true
        fi
