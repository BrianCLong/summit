name: ğŸ“Š Metrics Export

on:
  schedule:
    # Export metrics every hour (reduced frequency)
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      export_type:
        description: 'Type of metrics to export'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - health
          - performance
          - security

# Only one metrics export at a time
concurrency:
  group: metrics-export
  cancel-in-progress: false

env:
  NODE_VERSION: '20.11.1'
  PNPM_VERSION: '9.6.0'

permissions:
  contents: read
  actions: read
  pull-requests: read
  issues: read

jobs:
  export-metrics:
    name: ğŸ“ˆ Export Release Captain Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.repository_owner == 'BrianCLong' }}
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false

    - name: Enable corepack
      run: corepack enable && corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Export Maestro & Summit metrics
      uses: actions/github-script@v7
      env:
        EXPORT_TYPE: ${{ inputs.export_type || 'all' }}
      with:
        script: |
          const fs = require('fs');

          console.log('ğŸ“Š Exporting Maestro & Summit metrics...');

          // Fetch recent workflow runs
          const { data: workflows } = await github.rest.actions.listWorkflowRunsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100,
            created: `>${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()}`
          });

          // Calculate metrics
          const totalRuns = workflows.workflow_runs.length;
          const successfulRuns = workflows.workflow_runs.filter(r => r.conclusion === 'success').length;
          const failedRuns = workflows.workflow_runs.filter(r => r.conclusion === 'failure').length;
          const healthRatio = totalRuns > 0 ? (successfulRuns / totalRuns).toFixed(4) : '1.0000';

          // Fetch recent deployments (via deployment API)
          let deployCount = 0;
          let deploySuccessCount = 0;
          try {
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50
            });
            deployCount = deployments.length;

            for (const deploy of deployments.slice(0, 20)) {
              const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deploy.id
              });
              if (statuses[0]?.state === 'success') deploySuccessCount++;
            }
          } catch (e) {
            console.log('âš ï¸ Deployment metrics unavailable:', e.message);
          }

          // Fetch PR metrics
          const { data: recentPRs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            per_page: 50,
            sort: 'updated',
            direction: 'desc'
          });

          const mergedPRs = recentPRs.filter(pr => pr.merged_at).length;
          const openPRs = recentPRs.filter(pr => pr.state === 'open').length;

          // Build Prometheus metrics
          const timestamp = Date.now();
          const metrics = `# Maestro & Summit Platform Metrics
# Generated at ${new Date().toISOString()}

# HELP maestro_workflow_runs_total Total workflow runs (7d)
# TYPE maestro_workflow_runs_total counter
maestro_workflow_runs_total ${totalRuns}

# HELP maestro_workflow_success_total Successful workflow runs (7d)
# TYPE maestro_workflow_success_total counter
maestro_workflow_success_total ${successfulRuns}

# HELP maestro_workflow_failed_total Failed workflow runs (7d)
# TYPE maestro_workflow_failed_total counter
maestro_workflow_failed_total ${failedRuns}

# HELP maestro_health_ratio Workflow success ratio
# TYPE maestro_health_ratio gauge
maestro_health_ratio ${healthRatio}

# HELP maestro_deployments_total Recent deployments
# TYPE maestro_deployments_total gauge
maestro_deployments_total ${deployCount}

# HELP maestro_deploy_success_total Successful deployments
# TYPE maestro_deploy_success_total gauge
maestro_deploy_success_total ${deploySuccessCount}

# HELP summit_prs_merged_total Merged PRs (recent 50)
# TYPE summit_prs_merged_total gauge
summit_prs_merged_total ${mergedPRs}

# HELP summit_prs_open Open PRs
# TYPE summit_prs_open gauge
summit_prs_open ${openPRs}

# HELP summit_metrics_export_timestamp_seconds Last export timestamp
# TYPE summit_metrics_export_timestamp_seconds gauge
summit_metrics_export_timestamp_seconds ${Math.floor(timestamp / 1000)}
`;

          fs.writeFileSync('/tmp/release-captain-metrics.prom', metrics);
          console.log('âœ… Metrics exported successfully');
          console.log(`ğŸ“Š Total runs: ${totalRuns}, Success: ${successfulRuns}, Health: ${healthRatio}`)

    - name: Upload metrics artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-captain-metrics-${{ github.run_number }}
        path: /tmp/release-captain-metrics.prom
        retention-days: 7

    - name: Generate metrics summary
      run: |
        echo "## ğŸ“Š Metrics Export Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
        echo "**Export Type**: ${{ inputs.export_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ -f "/tmp/release-captain-metrics.prom" ]]; then
          metric_count=$(grep -c "^[a-zA-Z]" /tmp/release-captain-metrics.prom || echo "0")
          file_size=$(du -h /tmp/release-captain-metrics.prom | cut -f1)

          echo "### âœ… Export Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Metrics Count**: $metric_count" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size**: $file_size" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: release-captain-metrics-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Export Failed" >> $GITHUB_STEP_SUMMARY
          echo "No metrics file generated" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ Key Metrics" >> $GITHUB_STEP_SUMMARY

        # Extract key metrics for summary
        if [[ -f "/tmp/release-captain-metrics.prom" ]]; then
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          # Circuit state
          circuit_state=$(grep "^rc_circuit_state " /tmp/release-captain-metrics.prom | awk '{print $2}' || echo "unknown")
          case "$circuit_state" in
            "0") circuit_display="ğŸŸ¢ CLOSED" ;;
            "1") circuit_display="ğŸŸ¡ HALF_OPEN" ;;
            "2") circuit_display="ğŸ”´ OPEN" ;;
            *) circuit_display="â“ UNKNOWN" ;;
          esac
          echo "| Circuit State | $circuit_display |" >> $GITHUB_STEP_SUMMARY

          # Recent deployments
          recent_deploys=$(grep "^rc_recent_deployments " /tmp/release-captain-metrics.prom | awk '{print $2}' || echo "0")
          echo "| Recent Deployments | $recent_deploys |" >> $GITHUB_STEP_SUMMARY

          # Health ratio
          health_ratio=$(grep "^rc_deploy_health_ratio" /tmp/release-captain-metrics.prom | head -1 | awk '{print $2}' || echo "0")
          health_percent=$(echo "$health_ratio * 100" | bc -l 2>/dev/null | cut -d. -f1 || echo "0")
          if [[ $health_percent -ge 99 ]]; then
            health_display="ğŸŸ¢ $health_percent%"
          elif [[ $health_percent -ge 95 ]]; then
            health_display="ğŸŸ¡ $health_percent%"
          else
            health_display="ğŸ”´ $health_percent%"
          fi
          echo "| Health Status | $health_display |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check for alerts
      run: |
        echo "ğŸš¨ Checking for metric-based alerts..."

        if [[ ! -f "/tmp/release-captain-metrics.prom" ]]; then
          echo "No metrics file to check"
          exit 0
        fi

        # Check circuit breaker state
        circuit_state=$(grep "^rc_circuit_state " /tmp/release-captain-metrics.prom | awk '{print $2}' || echo "0")
        if [[ "$circuit_state" == "2" ]]; then
          echo "âš ï¸ ALERT: Circuit breaker is OPEN"
          echo "circuit_open=true" >> $GITHUB_OUTPUT
        fi

        # Check health ratio
        health_ratio=$(grep "^rc_deploy_health_ratio" /tmp/release-captain-metrics.prom | head -1 | awk '{print $2}' || echo "1")
        if [[ $(echo "$health_ratio < 0.95" | bc -l) == "1" ]]; then
          echo "âš ï¸ ALERT: Health ratio below 95%"
          echo "health_low=true" >> $GITHUB_OUTPUT
        fi

        # Check for recent rollbacks
        rollbacks=$(grep "^rc_rollback_total" /tmp/release-captain-metrics.prom | awk '{print $2}' | sort -n | tail -1 || echo "0")
        if [[ $rollbacks -gt 0 ]]; then
          echo "âš ï¸ ALERT: Rollbacks detected"
          echo "rollbacks_detected=true" >> $GITHUB_OUTPUT
        fi

        echo "âœ… Alert checks completed"

    - name: Create alert issue
      if: steps.check-alerts.outputs.circuit_open == 'true' || steps.check-alerts.outputs.health_low == 'true'
      run: |
        echo "ğŸš¨ Creating alert issue for metric violations..."

        alert_title="ğŸš¨ Release Captain Alert - $(date +%Y-%m-%d)"
        alert_body="## Release Captain Alert

        **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
        **Trigger**: Automated metrics monitoring

        ### Alert Conditions

        "

        if [[ "${{ steps.check-alerts.outputs.circuit_open }}" == "true" ]]; then
          alert_body="$alert_body
        - ğŸ”´ **Circuit Breaker OPEN**: Deployments are blocked due to failures"
        fi

        if [[ "${{ steps.check-alerts.outputs.health_low }}" == "true" ]]; then
          alert_body="$alert_body
        - ğŸ”´ **Low Health Ratio**: System health below 95%"
        fi

        alert_body="$alert_body

        ### Immediate Actions

        1. Check the [Post-Deploy Health Dashboard](https://grafana.summit.dev/d/post-deploy-health)
        2. Review recent deployments and rollbacks
        3. Investigate service health endpoints
        4. Consider manual intervention if needed

        ### Metrics Data

        - **Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        - **Metrics Artifact**: release-captain-metrics-${{ github.run_number }}

        ---
        *This alert was automatically generated by Release Captain metrics monitoring.*
        "

        # Create the alert issue
        gh issue create \
          --title "$alert_title" \
          --body "$alert_body" \
          --label "release-captain,alert,monitoring,urgent" \
          --assignee "${{ github.actor }}" || echo "Failed to create alert issue"

        echo "ğŸ“ Alert issue created"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-metrics:
    name: ğŸ” Validate Metrics
    runs-on: ubuntu-latest
    needs: export-metrics
    if: always()
    steps:
    - name: Download metrics artifact
      uses: actions/download-artifact@v4
      with:
        name: release-captain-metrics-${{ github.run_number }}
        path: ./metrics

    - name: Validate Prometheus format
      run: |
        echo "ğŸ” Validating Prometheus metrics format..."

        metrics_file="./metrics/release-captain-metrics.prom"

        if [[ ! -f "$metrics_file" ]]; then
          echo "âŒ Metrics file not found"
          exit 1
        fi

        # Basic validation
        echo "ğŸ“„ Metrics file size: $(du -h $metrics_file | cut -f1)"
        echo "ğŸ“Š Total lines: $(wc -l < $metrics_file)"
        echo "ğŸ“ˆ Metric entries: $(grep -c "^[a-zA-Z]" $metrics_file)"

        # Check for required metrics
        required_metrics=(
          "rc_workflow_runs_total"
          "rc_deploy_health_ratio"
          "rc_circuit_state"
        )

        echo "ğŸ” Checking required metrics..."
        for metric in "${required_metrics[@]}"; do
          if grep -q "^$metric" "$metrics_file"; then
            echo "âœ… Found: $metric"
          else
            echo "âŒ Missing: $metric"
          fi
        done

        # Validate format
        echo "ğŸ” Validating Prometheus format..."
        if grep -qE "^# (HELP|TYPE)" "$metrics_file"; then
          echo "âœ… Contains help and type annotations"
        else
          echo "âš ï¸ Missing help/type annotations"
        fi

        echo "âœ… Metrics validation completed"

    - name: Metrics health check
      run: |
        echo "ğŸ¥ Performing metrics health check..."

        metrics_file="./metrics/release-captain-metrics.prom"

        # Check if metrics are recent
        if [[ -f "$metrics_file" ]]; then
          # Look for timestamp in metrics
          if grep -q "generated at" "$metrics_file"; then
            echo "âœ… Metrics contain timestamp"
          else
            echo "âš ï¸ No timestamp found in metrics"
          fi

          # Check metric freshness (file age)
          file_age=$(($(date +%s) - $(stat -c %Y "$metrics_file" 2>/dev/null || stat -f %m "$metrics_file")))
          if [[ $file_age -lt 600 ]]; then  # 10 minutes
            echo "âœ… Metrics are fresh (${file_age}s old)"
          else
            echo "âš ï¸ Metrics are stale (${file_age}s old)"
          fi
        fi

        echo "âœ… Health check completed"