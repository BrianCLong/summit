name: Persisted Queries

on:
  push:
    paths:
      - 'persisted/**/*.graphql'
  pull_request:
    paths:
      - 'persisted/**/*.graphql'

permissions:
  contents: write

jobs:
  build-manifest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: node tools/pq/build-manifest.mjs
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(pq): update persisted manifest'
          file_pattern: persisted/manifest.json

  check-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Check persisted query drift
        run: node scripts/check-persisted-queries.js

  generate:
    runs-on: ubuntu-latest
    needs: check-drift
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install deps (server)
        run: pnpm install --frozen-lockfile --prefix server
      - name: Check persisted query enforcement
        run: |
          echo "Testing persisted query enforcement..."
          # Start server in background
          cd server
          pnpm start &
          SERVER_PID=$!
          sleep 10
          
          # Test that unknown queries are rejected
          RESPONSE=$(curl -s -o /dev/null -w "%{{http_code}}" \
            -X POST http://localhost:4000/graphql \
            -H "Content-Type: application/json" \
            -d '{{"query": "query {{ __typename }}"}}
          )
          
          if [ "$RESPONSE" != "400" ]; then
            echo "❌ Server should reject unknown queries with 400, got $RESPONSE"
            kill $SERVER_PID
            exit 1
          fi
          
          echo "✅ Persisted query enforcement working"
          kill $SERVER_PID
        env:
          NODE_ENV: test
          JWT_SECRET: test-secret
          ALLOWED_ORIGINS: http://localhost
          RATE_LIMIT_MAX: 1000
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: persisted-queries
          path: .maestro/persisted-queries.json