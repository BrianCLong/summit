name: SOC Exception Renewal

on:
  schedule:
    - cron: '0 8 * * 1' # Weekly on Monday at 8am
  workflow_dispatch:

jobs:
  renewal-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pyyaml python-dateutil requests

      - name: Check Expiring Exceptions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cat << 'EOF' > check_renewals.py
          import os
          import sys
          import yaml
          import datetime
          import requests
          from dateutil import parser

          EXCEPTIONS_PATH = "compliance/exceptions/EXCEPTIONS.yml"
          RENEWAL_WINDOW_DAYS = 30
          GITHUB_TOKEN = os.environ.get("GITHUB_TOKEN")
          REPO_OWNER = os.environ.get("REPO_OWNER")
          REPO_NAME = os.environ.get("REPO_NAME")
          API_URL = f"https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}"

          def load_exceptions():
              if not os.path.exists(EXCEPTIONS_PATH):
                  return []
              with open(EXCEPTIONS_PATH, 'r') as f:
                  return yaml.safe_load(f) or []

          def create_issue(title, body, labels):
              headers = {
                  "Authorization": f"Bearer {GITHUB_TOKEN}",
                  "Accept": "application/vnd.github.v3+json"
              }

              # Check for existing open issue
              search_url = f"https://api.github.com/search/issues?q=repo:{REPO_OWNER}/{REPO_NAME}+is:issue+is:open+in:title+{title}"
              resp = requests.get(search_url, headers=headers)
              if resp.status_code == 200:
                  data = resp.json()
                  if data.get("total_count", 0) > 0:
                      print(f"Issue already exists: {title}")
                      return

              # Create new issue
              issue_data = {
                  "title": title,
                  "body": body,
                  "labels": labels
              }
              resp = requests.post(f"{API_URL}/issues", json=issue_data, headers=headers)
              if resp.status_code == 201:
                  print(f"Created issue: {title}")
              else:
                  print(f"Failed to create issue: {resp.text}")

          def main():
              exceptions = load_exceptions()
              now_utc = datetime.datetime.now(datetime.timezone.utc)

              for ex in exceptions:
                  if ex.get("status") != "active":
                      continue

                  try:
                      expires_at = parser.parse(ex["expires_at_utc"]).replace(tzinfo=datetime.timezone.utc)
                      days_until_expiry = (expires_at - now_utc).days

                      if 0 <= days_until_expiry <= RENEWAL_WINDOW_DAYS:
                          ex_id = ex["exception_id"]
                          print(f"Exception {ex_id} expires in {days_until_expiry} days")

                          title = f"[SOC Exception Renewal] {ex_id} expires {ex['expires_at_utc'].split('T')[0]}"
                          body = f"""
          ### Exception Renewal Required

          **Exception ID:** {ex_id}
          **Controls:** {', '.join(ex.get('control_ids', []))}
          **Expires:** {ex['expires_at_utc']} ({days_until_expiry} days remaining)
          **Owner:** {ex.get('owner', 'Unknown')}

          **Reason:** {ex.get('reason')}
          **Plan:** {ex.get('evidence_plan')}

          ### Action Required

          Please verify if this exception is still needed.

          - **Option 1 (Resolve):** Provide evidence and set status to `resolved`.
          - **Option 2 (Renew):** Submit a PR to extend the expiry date (max {ex.get('max_extension_days', 90)} days) with an updated plan.

          cc {ex.get('owner')}
                          """
                          create_issue(title, body, ["soc-exception", "governance", "renewal"])

                  except Exception as e:
                      print(f"Error checking exception {ex.get('exception_id')}: {e}")

          if __name__ == "__main__":
              main()
          EOF

          python3 check_renewals.py
