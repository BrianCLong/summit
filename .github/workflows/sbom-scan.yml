name: SBOM & Vulnerability Scanning
on: [push, pull_request]
permissions:
  contents: read
  security-events: write
jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      # Generate SBOM with Syft
      - uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom.json
      
      # Upload SBOM artifact with 90-day retention
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.json
          retention-days: 90
          if-no-files-found: error
      
      # Scan for vulnerabilities with Grype
      - name: Scan for Vulnerabilities
        uses: anchore/scan-action@v7
        id: scan
        with:
          sbom: sbom.json
          fail-build: true
          severity-cutoff: high  # Changed from 'critical' to 'high' per #1234
          only-fixed: true  # Only fail on vulnerabilities with available fixes
      
      # Apply allowlist if present
      - name: Check Allowlist
        if: always()
        run: |
          if [ -f security/grype-allowlist.yaml ]; then
            echo "Allowlist found at security/grype-allowlist.yaml"
            echo "Applying vulnerability exceptions..."
            # Grype allowlist is automatically applied via scan-action config
          else
            echo "No allowlist file found (optional)"
          fi
      
      # Upload scan results
      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-results
          path: |
            **/*scan-results*.json
            **/*vulnerability*.sarif
          retention-days: 90
          if-no-files-found: warn

# Addresses #1234:
# - CI fails on High/Critical vulnerabilities (severity-cutoff: high)
# - SBOM artifacts uploaded with 90-day retention
# - Allowlist mechanism at security/grype-allowlist.yaml (optional)
# - Only fails on fixable vulnerabilities (only-fixed: true)
