name: Error Budget Monitoring

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  deployments: write
  actions: write

env:
  PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}
  PROMETHEUS_TOKEN: ${{ secrets.PROMETHEUS_TOKEN }}
  GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
  SLO_ENVIRONMENT: production
  ROLLBACK_EVENT: slo-breach

jobs:
  error-budget-check:
    name: ðŸ“‰ Detect SLO Breaches
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      alert-needed: ${{ steps.report.outputs.alert-needed }}
      failing-slos: ${{ steps.evaluate.outputs.failing_slos }}
      rollback-target: ${{ steps.deployment.outputs.rollback_target }}
      deployment-sha: ${{ steps.deployment.outputs.current_sha }}
      responsible-engineer: ${{ steps.deployment.outputs.responsible_engineer }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install monitoring dependencies
        run: |
          python3 -m pip install --quiet --upgrade pip pyyaml

      - name: Evaluate SLOs from catalog
        id: evaluate
        env:
          PROMETHEUS_URL: ${{ env.PROMETHEUS_URL }}
          PROMETHEUS_TOKEN: ${{ env.PROMETHEUS_TOKEN }}
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json
          import os
          import sys
          import urllib.parse
          import urllib.request

          import yaml

          prom_url = os.environ.get("PROMETHEUS_URL", "").rstrip("/")
          prom_token = os.environ.get("PROMETHEUS_TOKEN")

          with open("slo-config.yaml", "r", encoding="utf-8") as handle:
            slo_config = yaml.safe_load(handle)

          headers = {"Accept": "application/json"}
          if prom_token:
            headers["Authorization"] = f"Bearer {prom_token}"

          results = []
          failing = []
          for objective in slo_config.get("spec", {}).get("objectives", []):
            name = objective.get("name", "unnamed")
            target = float(objective.get("target", 0))
            query = objective.get("sli", {}).get("query", "")
            measured = None
            status = "unknown"
            source = prom_url or "manual-input"

            if prom_url and query:
              try:
                params = urllib.parse.urlencode({"query": query})
                request = urllib.request.Request(
                  f"{prom_url}/api/v1/query?{params}", headers=headers
                )
                with urllib.request.urlopen(request, timeout=20) as response:
                  payload = json.load(response)
                vector = payload.get("data", {}).get("result", [])
                if vector:
                  raw_value = float(vector[0]["value"][1])
                  measured = raw_value * 100 if raw_value <= 1 else raw_value
                  status = "breach" if measured < target else "ok"
                else:
                  status = "unavailable"
              except Exception as exc:  # noqa: BLE001
                status = f"unavailable ({exc.__class__.__name__})"
            else:
              status = "unavailable"

            display_value = measured if measured is not None else "n/a"
            results.append(
              {
                "name": name,
                "target": target,
                "value": display_value,
                "status": status,
                "query": query,
                "source": source,
              }
            )

            if status == "breach":
              failing.append(name)

          with open("slo-report.json", "w", encoding="utf-8") as handle:
            json.dump(results, handle, indent=2)

          breached = bool(failing)
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
            output.write(f"breach={str(breached).lower()}\n")
            output.write(f"failing_slos={'|'.join(failing)}\n")
          PY

      - name: Resolve deployment context
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLO_ENVIRONMENT: ${{ env.SLO_ENVIRONMENT }}
        run: |
          set -euo pipefail

          ENVIRONMENT="${SLO_ENVIRONMENT:-production}"
          DEPLOYMENTS=$(gh api \
            --method GET \
            "/repos/$GITHUB_REPOSITORY/deployments?environment=${ENVIRONMENT}&per_page=5" 2>/dev/null || true)

          CURRENT_SHA=$(echo "$DEPLOYMENTS" | jq -r '.[0].sha // ""')
          RESPONSIBLE=$(echo "$DEPLOYMENTS" | jq -r '.[0].creator.login // ""')

          ROLLBACK_TARGET=""
          if [[ -n "$DEPLOYMENTS" && "$DEPLOYMENTS" != "[]" ]]; then
            while read -r sha id; do
              STATUS=$(gh api \
                "/repos/$GITHUB_REPOSITORY/deployments/$id/statuses?per_page=1" \
                --jq '.[0].state' 2>/dev/null || echo "unknown")

              if [[ "$STATUS" == "success" ]]; then
                if [[ "$sha" == "$CURRENT_SHA" ]]; then
                  continue
                fi
                ROLLBACK_TARGET="$sha"
                break
              fi
            done < <(echo "$DEPLOYMENTS" | jq -r '.[] | "\(.sha) \(.id)"')
          fi

          echo "current_sha=$CURRENT_SHA" >> "$GITHUB_OUTPUT"
          echo "responsible_engineer=$RESPONSIBLE" >> "$GITHUB_OUTPUT"
          echo "rollback_target=$ROLLBACK_TARGET" >> "$GITHUB_OUTPUT"

      - name: Generate Error Budget Report
        id: report
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json
          from datetime import datetime, timezone

          with open("slo-report.json", "r", encoding="utf-8") as handle:
            slo_results = json.load(handle)

          breached = any(item.get("status") == "breach" for item in slo_results)

          lines = [
            "# ðŸ“Š Error Budget Status Report",
            f"**Timestamp:** {datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')}",
            "",
            "## Service Level Objectives",
            "| Metric | Current | Target | Status | Source |",
            "|--------|---------|--------|--------|--------|",
          ]

          for item in slo_results:
            status = item.get("status")
            status_icon = "âŒ BREACH" if status == "breach" else "âœ… OK" if status == "ok" else "âš ï¸ unavailable"
            value = item.get("value", "n/a")
            lines.append(
              f"| {item.get('name')} | {value} | â‰¥ {item.get('target')} | {status_icon} | {item.get('source')} |"
            )

          if breached:
            lines.append("")
            lines.append("## Actions Required")
            lines.append("- ðŸš¨ One or more SLOs breached. Automatic rollback will be triggered.")

          with open("error-budget-report.md", "w", encoding="utf-8") as handle:
            handle.write("\n".join(lines))

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
            output.write(f"alert-needed={str(breached).lower()}\n")
          PY

      - name: Create or Update Issue
        if: steps.report.outputs.alert-needed == 'true'
        uses: actions/github-script@v7
        env:
          RESPONSIBLE: ${{ steps.deployment.outputs.responsible_engineer }}
          DEPLOYMENT_SHA: ${{ steps.deployment.outputs.current_sha }}
          FAILING_SLOS: ${{ steps.evaluate.outputs.failing_slos }}
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('error-budget-report.md', 'utf8');
            const failingSlos = (process.env.FAILING_SLOS || '').split('|').filter(Boolean);
            const assignees = process.env.RESPONSIBLE ? [process.env.RESPONSIBLE] : [];

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['error-budget', 'slo-violation'],
              state: 'open'
            });

            const latestDeployment = process.env.DEPLOYMENT_SHA || 'unavailable';
            const body = `${report}\n\n**Failing SLOs:** ${failingSlos.join(', ') || 'unknown'}\n**Latest deployment:** ${latestDeployment}`;

            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Error Budget Violation Detected',
                body,
                labels: ['error-budget', 'slo-violation', 'P0'],
                assignees
              });
            }

      - name: Notify Slack
        if: steps.report.outputs.alert-needed == 'true'
        env:
          RESPONSIBLE: ${{ steps.deployment.outputs.responsible_engineer }}
          DEPLOYMENT_SHA: ${{ steps.deployment.outputs.current_sha }}
          ROLLBACK_TARGET: ${{ steps.deployment.outputs.rollback_target }}
          FAILING_SLOS: ${{ steps.evaluate.outputs.failing_slos }}
        run: |
          set -euo pipefail

          if [[ -z "${SLACK_WEBHOOK:-}" ]]; then
            echo "Slack webhook not configured; skipping notification"
            exit 0
          fi

          FAILING_SLOS="${FAILING_SLOS:-}"
          RESPONSIBLE_HANDLE=${RESPONSIBLE:-on-call}

          curl -X POST "${SLACK_WEBHOOK}" \
            -H 'Content-type: application/json' \
            --data "{\
              \"text\": \"ðŸš¨ SLO violation detected in ${SLO_ENVIRONMENT}. Rollback will be triggered.\",\
              \"attachments\": [\
                {\
                  \"color\": \"danger\",\
                  \"title\": \"SLO Breach\",\
                  \"fields\": [\
                    {\"title\": \"Failing SLOs\", \"value\": \"${FAILING_SLOS:-unknown}\", \"short\": false},\
                    {\"title\": \"Latest Deployment\", \"value\": \"${DEPLOYMENT_SHA:-unknown}\", \"short\": true},\
                    {\"title\": \"Rollback Target\", \"value\": \"${ROLLBACK_TARGET:-pending}\", \"short\": true},\
                    {\"title\": \"Responsible Engineer\", \"value\": \"${RESPONSIBLE_HANDLE}\", \"short\": true}\
                  ]\
                }\
              ]\
            }"

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: error-budget-report-${{ github.run_number }}
          path: |
            error-budget-report.md
            slo-report.json
          retention-days: 30

      - name: Trigger rollback workflow
        if: steps.report.outputs.alert-needed == 'true' && steps.deployment.outputs.rollback_target != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESPONSIBLE: ${{ steps.deployment.outputs.responsible_engineer }}
        run: |
          set -euo pipefail

          PAYLOAD=$(jq -n \
            --arg env "$SLO_ENVIRONMENT" \
            --arg deployment_sha "${{ steps.deployment.outputs.current_sha }}" \
            --arg rollback_target "${{ steps.deployment.outputs.rollback_target }}" \
            --arg failing_slos "${{ steps.evaluate.outputs.failing_slos }}" \
            --arg triggered_by "${{ github.workflow }}" \
            --arg responsible "${RESPONSIBLE:-}" \
            '{environment: $env, deployment_sha: $deployment_sha, rollback_target: $rollback_target, failing_slos: $failing_slos, triggered_by: $triggered_by, responsible: $responsible}'
          )

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/$GITHUB_REPOSITORY/dispatches" \
            --input - <<<"{\"event_type\": \"${ROLLBACK_EVENT}\", \"client_payload\": $PAYLOAD}"
