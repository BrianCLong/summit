name: Pipeline - Rollback

on:
  repository_dispatch:
    types: [slo-breach]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      target_tag:
        description: 'Target Docker tag/SHA to rollback to'
        required: true

jobs:
  rollback:
    name: âª Rollback
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'repository_dispatch' && github.event.action == 'slo-breach')
    steps:
      - uses: actions/checkout@v4

      - name: Resolve rollback context
        id: context
        env:
          PAYLOAD_ENV: ${{ github.event.client_payload.environment }}
          PAYLOAD_TARGET: ${{ github.event.client_payload.rollback_target }}
          PAYLOAD_SHA: ${{ github.event.client_payload.deployment_sha }}
          PAYLOAD_SLOS: ${{ github.event.client_payload.failing_slos }}
          INPUT_ENV: ${{ inputs.environment }}
          INPUT_TARGET: ${{ inputs.target_tag }}
        run: |
          set -euo pipefail

          ENVIRONMENT="${PAYLOAD_ENV:-${INPUT_ENV:-production}}"
          TARGET="${PAYLOAD_TARGET:-${INPUT_TARGET:-}}"

          if [[ -z "$TARGET" && -n "${PAYLOAD_SHA:-}" ]]; then
            TARGET="$PAYLOAD_SHA"
          fi

          if [[ -z "$TARGET" ]]; then
            echo "No rollback target supplied via webhook or manual inputs." >&2
            exit 1
          fi

          echo "environment=$ENVIRONMENT" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"
          echo "slos=${PAYLOAD_SLOS:-}" >> "$GITHUB_OUTPUT"

      - name: Execute Rollback
        env:
          TARGET_TAG: ${{ steps.context.outputs.target }}
          TARGET_ENV: ${{ steps.context.outputs.environment }}
          FAILING_SLOS: ${{ steps.context.outputs.slos }}
        run: |
          echo "ðŸš¨ Initiating Rollback for ${TARGET_ENV} to version ${TARGET_TAG}"
          if [[ -n "${FAILING_SLOS:-}" ]]; then
            echo "SLO context: ${FAILING_SLOS}"
          fi
          ./scripts/deploy.sh -e "${TARGET_ENV}" -t "${TARGET_TAG}"

      - name: Post-Rollback Verification
        run: |
          echo "Verifying health of rolled-back service..."
          # In a real scenario, run k6 or curl check here
          echo "âœ… Service health verified."
