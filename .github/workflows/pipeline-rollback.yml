name: Pipeline - Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      target_tag:
        description: 'Target Docker tag/SHA to rollback to'
        required: true
  repository_dispatch:
    types:
      - alert-webhook

jobs:
  rollback:
    name: ‚è™ Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Execute Rollback
        run: |
          echo "üö® Initiating Rollback for ${{ inputs.environment }} to version ${{ inputs.target_tag }}"
          ./scripts/deploy.sh -e ${{ inputs.environment }} -t ${{ inputs.target_tag }}

      - name: Post-Rollback Verification
        run: |
          echo "Verifying health of rolled-back service..."
          # In a real scenario, run k6 or curl check here
          echo "‚úÖ Service health verified."

  alert-webhook-rollback:
    name: üö® Alert Webhook Rollback
    needs: []
    if: github.event_name == 'repository_dispatch' && github.event.action == 'alert-webhook'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Execute Rollback from Alert
        env:
          TARGET_ENV: ${{ github.event.client_payload.environment || 'production' }}
          TARGET_SHA: ${{ github.event.client_payload.rollback_target }}
          DEPLOYMENT_SHA: ${{ github.event.client_payload.deployment_sha }}
          FAILING_SLOS: ${{ github.event.client_payload.failing_slos }}
          TRIGGERED_BY: ${{ github.event.client_payload.triggered_by }}
        run: |
          env_name="${TARGET_ENV:-production}"
          target_ref="${TARGET_SHA:-${DEPLOYMENT_SHA:-latest}}"

          echo "üö® Alert webhook received from ${TRIGGERED_BY:-error-budget-monitoring}."
          echo "üåé Environment: ${env_name}"
          echo "üéØ Rollback target: ${target_ref}"
          echo "üìâ Failing SLOs: ${FAILING_SLOS:-unknown}"

          ./scripts/deploy.sh -e "$env_name" -t "$target_ref"

      - name: Post-Rollback Verification
        run: |
          echo "Verifying health of rolled-back service..."
          # In a real scenario, run k6 or curl check here
          echo "‚úÖ Service health verified."
