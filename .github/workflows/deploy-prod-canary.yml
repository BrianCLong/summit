name: Deploy to Prod (Canary + Auto-rollback)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image Tag to deploy (SHA)'
        required: true
      application:
        description: 'Target application'
        required: true
        type: choice
        default: intelgraph
        options:
          - intelgraph
          - maestro
          - companyos

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CANARY_CONFIG_PATH: summit_release_env_pack/k8s/optional/argo-rollouts/canary-traffic-config.json

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load canary profile
        id: canary-profile
        env:
          APP_KEY: ${{ inputs.application }}
        run: |
          CONFIG="${{ env.CANARY_CONFIG_PATH }}"
          if [ ! -f "$CONFIG" ]; then
            echo "Canary config not found at $CONFIG"
            exit 1
          fi

          if ! jq -e --arg app "$APP_KEY" '.[$app]' "$CONFIG" >/tmp/profile.json; then
            echo "No canary profile found for $APP_KEY"
            exit 1
          fi

          PROD_NS=$(jq -r '.namespaces.production' /tmp/profile.json)
          RELEASE_NAME=$(jq -r '.release' /tmp/profile.json)
          CHART_PATH=$(jq -r '.chart' /tmp/profile.json)
          HOSTNAME=$(jq -r '.host' /tmp/profile.json)
          STAGES=$(jq -r '.trafficStages | join(",")' /tmp/profile.json)
          FEATURE_FLAG=$(jq -r '.featureFlags[0]' /tmp/profile.json)

          echo "NAMESPACE=${PROD_NS}" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=${RELEASE_NAME}" >> "$GITHUB_ENV"
          echo "CHART_PATH=${CHART_PATH}" >> "$GITHUB_ENV"
          echo "HOSTNAME=${HOSTNAME}" >> "$GITHUB_ENV"
          echo "CANARY_STAGE_WEIGHTS=${STAGES},100" >> "$GITHUB_ENV"
          echo "CANARY_FEATURE_FLAG=${FEATURE_FLAG}" >> "$GITHUB_ENV"

          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
### Canary Profile ($APP_KEY)
- Namespace: ${PROD_NS}
- Release: ${RELEASE_NAME}
- Chart: ${CHART_PATH}
- Host: ${HOSTNAME}
- Traffic plan: ${STAGES}% â†’ 100%
- Feature flag: ${FEATURE_FLAG}
EOF

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.11.1'

      - name: Create Kubeconfig
        run: |
          set -euo pipefail
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PROD_B64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy to Prod
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          HOST: ${{ env.HOSTNAME }}
        run: |
          set -euo pipefail
          # The chart has Argo Rollouts enabled, so 'helm upgrade' applies the Rollout object.
          # Argo Rollouts controller handles the configured canary steps (from canary-traffic-config.json).
          helm upgrade --install "${RELEASE_NAME}" "${CHART_PATH}" \
            --namespace $NAMESPACE \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ inputs.image_tag }} \
            --set ingress.hosts[0].host=$HOST \
            --set ingress.tls[0].hosts[0]=$HOST \
            --set "canary.stages={${CANARY_STAGE_WEIGHTS}}" \
            --set "canary.featureFlag=${CANARY_FEATURE_FLAG}" \
            --atomic \
            --timeout 10m \
            --wait

      - name: Verify rollout health
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
        run: |
          set -euo pipefail
          release=${RELEASE_NAME}
          if kubectl -n "$NAMESPACE" get deployment "$release" >/dev/null 2>&1; then
            kubectl -n "$NAMESPACE" rollout status deployment "$release" --timeout=5m
          elif kubectl -n "$NAMESPACE" get statefulset "$release" >/dev/null 2>&1; then
            kubectl -n "$NAMESPACE" rollout status statefulset "$release" --timeout=5m
          else
            echo "::warning::No deployment or statefulset named $release; checking pods by label"
            kubectl -n "$NAMESPACE" wait --for=condition=Ready pod -l app.kubernetes.io/name=$release --timeout=5m
          fi
