name: OPA Policy Tests

# CI Quality Gate: Validates OPA/Rego policies before merge
# Addresses: Issue #1235 - CI: OPA Policy Simulation in PRs
# Authority: Platform Engineering
#
# Requirements:
# - CI fails on any policy test failure
# - Artifacts include JUnit + coverage

on:
  pull_request:
    branches: [main]
    paths:
      - "policy/**/*.rego"
      - "policy/**/*.json"
      - "policy/**/*.yaml"
      - ".github/workflows/opa-policy-test.yml"

  push:
    branches: [main]
    paths:
      - "policy/**/*.rego"
      - "policy/**/*.json"
      - "policy/**/*.yaml"

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write

env:
  OPA_VERSION: "0.70.0"

jobs:
  opa-policy-test:
    name: OPA Policy Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OPA
      - name: Ensure opa path is clean
        run: rm -rf opa
           |          curl -L -o opa-bin https://openpolicyagent.org/downloads/v${{ env.OPA_VERSION }}/opa_linux_amd64_static
          chmod 755 opa-bin
          sudo mv opa-bin /usr/local/bin/opa
          opa version

      - name: Validate Rego syntax
        run: |
          echo "Validating Rego syntax..."
          find policy -name '*.rego' -type f | while read -r file; do
            echo "Checking: $file"
            if ! opa fmt --fail "$file" 2>/dev/null; then
              echo "::warning file=$file::Format check failed (non-blocking)"
            fi
          done

      - name: Run ABAC Policy Tests
        id: abac-tests
        run: |
          echo "Running ABAC policy tests..."
          mkdir -p test-results

          # Run tests with JUnit output for ABAC
          opa test policy/abac policy/tests/abac_test.rego \
            --format junit \
            --coverage \
            > test-results/abac-junit.xml 2>&1 || true

          # Run tests again for readable output and coverage JSON
          opa test policy/abac policy/tests/abac_test.rego \
            --verbose \
            --coverage \
            > test-results/abac-coverage.json 2>&1

          # Check if tests passed
          if ! opa test policy/abac policy/tests/abac_test.rego; then
            echo "ABAC tests failed"
            exit 1
          fi

          echo "ABAC tests passed"

      - name: Run Additional Policy Tests
        id: additional-tests
        continue-on-error: true
        run: |
          echo "Running additional policy tests..."

          # Test authz policies
          if [ -f policy/authz/authz.rego ] && [ -f policy/tests/authz_test.rego ]; then
            echo "Testing authz policies..."
            opa test policy/authz policy/tests/authz_test.rego --verbose || true
          fi

          # Test governance policies
          if [ -f policy/governance.rego ] && [ -f policy/tests/governance_test.rego ]; then
            echo "Testing governance policies..."
            opa test policy/governance.rego policy/tests/governance_test.rego --verbose || true
          fi

          # Test export policies
          if [ -f policy/export.rego ] && [ -f policy/tests/export_test.rego ]; then
            echo "Testing export policies..."
            opa test policy/export.rego policy/tests/export_test.rego --verbose || true
          fi

      - name: Check Coverage Threshold
        run: |
          echo "Checking coverage threshold (90% required)..."
          COVERAGE=$(opa test policy/abac policy/tests/abac_test.rego --coverage 2>/dev/null | jq -r '.coverage // 0')
          echo "Coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below 90% threshold"
            exit 1
          fi

          echo "Coverage threshold met: $COVERAGE% >= 90%"

      - name: Generate Summary
        if: always()
        run: |
          echo "### OPA Policy Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Get coverage
          COVERAGE=$(opa test policy/abac policy/tests/abac_test.rego --coverage 2>/dev/null | jq -r '.coverage // "N/A"')

          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| ABAC Coverage | ${COVERAGE}% |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Threshold | 90% |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f test-results/abac-coverage.json ]; then
            echo "#### Coverage Details" >> "$GITHUB_STEP_SUMMARY"
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            cat test-results/abac-coverage.json >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4 # v4
        with:
          name: opa-test-results-${{ github.run_id }}
          path: |
            test-results/
          retention-days: 30
          if-no-files-found: warn

      - name: Publish JUnit Results
        if: always()
        uses: mikepenz/action-junit-report@db71d41eb79864e25ab0337e395c352e84523afe # v4
        with:
          report_paths: test-results/*-junit.xml
          fail_on_failure: true
          include_passed: true
          check_name: OPA Policy Tests
