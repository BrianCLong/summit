name: Auto Enqueue Merge Queue

on:
  pull_request:
    types: [labeled, unlabeled, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  pull-requests: write
  contents: read

jobs:
  enqueue:
    if: >
      github.event.pull_request &&
      github.event.pull_request.state == 'open' &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Enqueue if ready (risk-aware)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr=${{ github.event.pull_request.number }}

          labels=$(gh pr view $pr --json labels --jq '.labels[].name' | tr '\n' ' ')
          approvals=$(gh pr view $pr --json reviews --jq '[.reviews[] | select(.state=="APPROVED")] | length')
          required_checks=$(gh pr checks $pr --required || true)

          echo "PR #$pr labels: $labels"
          echo "PR #$pr approvals: $approvals"
          echo "$required_checks"

          # must be explicitly ready
          echo "$labels" | grep -q "queue:ready" || exit 0

          # Determine risk tier
          risk="med"
          echo "$labels" | grep -q "risk:low"  && risk="low"
          echo "$labels" | grep -q "risk:med"  && risk="med"
          echo "$labels" | grep -q "risk:high" && risk="high"

          # Approval policy
          min_approvals=1
          if [ "$risk" = "high" ]; then
            min_approvals=2
          fi

          if [ "$approvals" -lt "$min_approvals" ]; then
            echo "Not enough approvals: need $min_approvals for risk:$risk"
            exit 0
          fi

          # Enqueue
          gh api repos/${{ github.repository }}/pulls/$pr/merge-queue/enqueue -f merge_method=squash || true

          # Priority behavior: dequeue/re-enqueue once to bubble it up (best-effort)
          if echo "$labels" | grep -q "queue:priority"; then
            echo "Priority set; attempting best-effort bubble."
            gh api -X POST repos/${{ github.repository }}/pulls/$pr/merge-queue/dequeue || true
            gh api repos/${{ github.repository }}/pulls/$pr/merge-queue/enqueue -f merge_method=squash || true
          fi
