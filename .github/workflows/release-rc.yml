name: RC Tag Pipeline

# MVP-4 Stabilization Release Candidate Pipeline
# Triggers when an RC tag (vX.Y.Z-rc.N) is pushed
#
# This workflow:
# 1. Runs canonical release:ready gate on the tagged commit
# 2. Runs Promotion Guard to verify all required checks are green
# 3. Builds a Promotion Bundle artifact for safe RC → GA promotion
#
# The bundle contains everything needed to promote to GA:
# - github_release.md (release notes)
# - promote_to_ga.sh (operator script)
# - REQUIRED_CHECKS.txt (truth table snapshot)
# - PROMOTION_CHECKLIST.md (step-by-step guide)

on:
  push:
    tags:
      - "v*.*.*-rc.*"

permissions:
  contents: read
  actions: read

concurrency:
  group: release-rc-${{ github.ref_name }}
  cancel-in-progress: false # Don't cancel release workflows

jobs:
  # Job 1: Run canonical release readiness gate
  verify:
    name: Release Readiness Verification
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout at tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run release:ready
        run: |
          echo "Running release readiness gate for RC: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          pnpm release:ready

  # Job 2: Run Promotion Guard to verify all required checks
  promotion-guard:
    name: Promotion Guard Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: verify

    outputs:
      promotion_allowed: ${{ steps.guard.outputs.promotion_allowed }}

    steps:
      - name: Checkout at tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Run Promotion Guard
        id: guard
        run: |
          echo "Running Promotion Guard for RC: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

          chmod +x scripts/release/verify-green-for-tag.sh

          # Run verification - allow failure but capture result
          if scripts/release/verify-green-for-tag.sh \
              --tag "${{ github.ref_name }}" \
              --commit "${{ github.sha }}"; then
            echo "promotion_allowed=true" >> $GITHUB_OUTPUT
            echo "✅ Promotion Guard: PASSED"
          else
            echo "promotion_allowed=false" >> $GITHUB_OUTPUT
            echo "⚠️ Promotion Guard: Some checks pending/failed"
            echo "Note: Bundle will still be created for audit purposes"
          fi

      - name: Promotion Guard Summary
        if: always()
        run: |
          echo "## Promotion Guard Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **RC Tag**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.guard.outputs.promotion_allowed == 'true' && '✅ PASSED' || '⚠️ PENDING/FAILED' }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: Build Promotion Bundle
  bundle:
    name: Build Promotion Bundle
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [verify, promotion-guard]
    if: always() && needs.verify.result == 'success'

    steps:
      - name: Checkout at tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Build Promotion Bundle
        id: bundle
        run: |
          echo "Building Promotion Bundle for RC: ${{ github.ref_name }}"

          chmod +x scripts/release/build-promotion-bundle.sh

          scripts/release/build-promotion-bundle.sh \
            --tag "${{ github.ref_name }}" \
            --commit "${{ github.sha }}"

          # Extract bundle path
          BUNDLE_PATH="artifacts/promotion-bundles/${{ github.ref_name }}"
          echo "bundle_path=${BUNDLE_PATH}" >> $GITHUB_OUTPUT

      - name: Add metadata to bundle
        run: |
          BUNDLE_PATH="artifacts/promotion-bundles/${{ github.ref_name }}"

          # Add workflow run metadata
          cat >> "${BUNDLE_PATH}/WORKFLOW_METADATA.txt" <<EOF
          RC Pipeline Workflow Run
          ========================
          Tag: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Run ID: ${{ github.run_id }}
          Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Actor: ${{ github.actor }}
          Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          Verify Job: ${{ needs.verify.result }}
          Promotion Guard: ${{ needs.promotion-guard.outputs.promotion_allowed == 'true' && 'PASSED' || 'PENDING/FAILED' }}
          EOF

      - name: Upload Promotion Bundle
        uses: actions/upload-artifact@v4
        with:
          name: promotion-bundle-${{ github.ref_name }}
          path: artifacts/promotion-bundles/${{ github.ref_name }}/
          retention-days: 90

      - name: Generate Job Summary
        run: |
          BUNDLE_PATH="artifacts/promotion-bundles/${{ github.ref_name }}"

          echo "## RC Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RC Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RC Tag | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify Job | ${{ needs.verify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Promotion Guard | ${{ needs.promotion-guard.outputs.promotion_allowed == 'true' && '✅ PASSED' || '⚠️ PENDING' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Promotion Bundle" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`promotion-bundle-${{ github.ref_name }}\` artifact to promote this RC to GA." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle Contents:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la "${BUNDLE_PATH}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.promotion-guard.outputs.promotion_allowed }}" == "true" ]]; then
            echo "1. Download the promotion bundle artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Extract and review the contents" >> $GITHUB_STEP_SUMMARY
            echo "3. Run \`./promote_to_ga.sh\` to promote to GA" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Some required checks are still pending or failed.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Wait for all checks to complete, then re-verify with:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "./scripts/release/verify-green-for-tag.sh --tag ${{ github.ref_name }} --commit ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
