name: Release RC Pipeline

# Canonical RC Pipeline - Single authoritative workflow for RC tag events
# Consolidates verification + promotion bundle into one artifact.
#
# This workflow:
# 1. Runs release readiness gate on the tagged commit
# 2. Verifies all required checks are green (truth table)
# 3. Builds a Promotion Bundle with all materials
# 4. Produces single rc-pipeline-bundle-{tag} artifact
#
# See docs/ci/RELEASE_RC_PIPELINE.md for full documentation.

on:
  push:
    tags:
      - "v*.*.*-rc.*"

  # Manual dispatch for re-running without re-pushing tag
  workflow_dispatch:
    inputs:
      tag:
        description: "RC tag to process (e.g., v4.1.2-rc.1)"
        required: true
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: release-rc-${{ github.ref_name || inputs.tag }}
  cancel-in-progress: false # Don't cancel release workflows

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 1: Release Readiness Verification
  # Runs canonical release:ready gate on the tagged commit
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify:
    name: "1ï¸âƒ£ Release Readiness"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      tag: ${{ steps.params.outputs.tag }}
      commit: ${{ steps.params.outputs.commit }}
      version: ${{ steps.params.outputs.version }}

    steps:
      - name: Determine Parameters
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
            COMMIT="${{ github.sha }}"
          else
            TAG="${{ inputs.tag }}"
            COMMIT=""  # Will resolve from tag
          fi

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT

          # Extract version (e.g., 4.1.2 from v4.1.2-rc.1)
          VERSION=$(echo "${TAG}" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-rc\.[0-9]+$/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          echo "Tag: ${TAG}"
          echo "Commit: ${COMMIT:-'(will resolve from tag)'}"
          echo "Version: ${VERSION}"

      - name: Validate RC Tag Format
        run: |
          TAG="${{ steps.params.outputs.tag }}"
          if ! [[ "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
            echo "::error::Invalid RC tag format: ${TAG}. Expected vX.Y.Z-rc.N"
            exit 1
          fi
          echo "âœ… Valid RC tag format: ${TAG}"

      - name: Checkout at tagged commit
        uses: actions/checkout@v4 # v6
        with:
          ref: ${{ steps.params.outputs.tag }}
          fetch-depth: 0

      - name: Resolve Commit SHA
        id: resolve
        run: |
          if [[ -z "${{ steps.params.outputs.commit }}" ]]; then
            COMMIT=$(git rev-parse HEAD)
          else
            COMMIT="${{ steps.params.outputs.commit }}"
          fi
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "Resolved commit: ${COMMIT}"

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          cache: 'pnpm'
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run release:ready
        run: |
          TAG="${{ steps.params.outputs.tag }}"
          COMMIT="${{ steps.resolve.outputs.commit }}"

          echo "Running release readiness gate for RC: ${TAG}"
          echo "Commit: ${COMMIT}"
          pnpm release:ready

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 2: Promotion Guard Verification
  # Verifies all required checks are green using truth table
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  promotion-guard:
    name: "2ï¸âƒ£ Promotion Guard"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: verify

    outputs:
      promotion_allowed: ${{ steps.guard.outputs.promotion_allowed }}
      verification_output: ${{ steps.guard.outputs.output_file }}

    steps:
      - name: Checkout at tagged commit
        uses: actions/checkout@v4 # v6
        with:
          ref: ${{ needs.verify.outputs.tag }}
          fetch-depth: 0

      - name: Compute Base Reference
        id: base
        run: |
          TAG="${{ needs.verify.outputs.tag }}"
          COMMIT="${{ needs.verify.outputs.commit }}"

          echo "Computing base reference for RC: ${TAG}"

          chmod +x scripts/release/compute_base_for_commit.sh

          # Compute deterministic base
          BASE=$(scripts/release/compute_base_for_commit.sh --tag "${TAG}" --commit "${COMMIT}" --verbose 2>&1 | tail -1 || echo "${COMMIT}^")

          echo "Computed base: ${BASE}"
          echo "base=${BASE}" >> $GITHUB_OUTPUT

      - name: Run Promotion Guard
        id: guard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.verify.outputs.tag }}"
          COMMIT="${{ needs.verify.outputs.commit }}"
          BASE="${{ steps.base.outputs.base }}"

          echo "Running Promotion Guard for RC: ${TAG}"
          echo "Commit: ${COMMIT}"
          echo "Base: ${BASE}"

          chmod +x scripts/release/verify-green-for-tag.sh

          mkdir -p artifacts/verification
          OUTPUT_FILE="artifacts/verification/REQUIRED_CHECKS.txt"

          # Run verification with explicit base - allow failure but capture result
          set +e
          scripts/release/verify-green-for-tag.sh \
              --tag "${TAG}" \
              --commit "${COMMIT}" \
              --base "${BASE}" \
              --verbose 2>&1 | tee "${OUTPUT_FILE}"
          EXIT_CODE=$?
          set -e

          echo "output_file=${OUTPUT_FILE}" >> $GITHUB_OUTPUT

          if [[ ${EXIT_CODE} -eq 0 ]]; then
            echo "promotion_allowed=true" >> $GITHUB_OUTPUT
            echo "âœ… Promotion Guard: PASSED"
          else
            echo "promotion_allowed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Promotion Guard: Some checks pending/failed"
            echo "Note: Bundle will still be created for audit purposes"
          fi

      - name: Upload Verification Output
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: verification-output
          path: artifacts/verification/
          retention-days: 90

      - name: Promotion Guard Summary
        if: always()
        run: |
          TAG="${{ needs.verify.outputs.tag }}"
          COMMIT="${{ needs.verify.outputs.commit }}"
          ALLOWED="${{ steps.guard.outputs.promotion_allowed }}"

          echo "## Promotion Guard Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RC Tag | \`${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${COMMIT:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${ALLOWED} == 'true' && 'âœ… PASSED' || 'âš ï¸ PENDING/FAILED' |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 3: Build & Assemble RC Pipeline Bundle
  # Creates single authoritative artifact: rc-pipeline-bundle-{tag}
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  bundle:
    name: "3ï¸âƒ£ Assemble Pipeline Bundle"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [verify, promotion-guard]
    if: always() && needs.verify.result == 'success'

    steps:
      - name: Checkout at tagged commit
        uses: actions/checkout@v4 # v6
        with:
          ref: ${{ needs.verify.outputs.tag }}
          fetch-depth: 0

      - name: Download Verification Output
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: verification-output
          path: staging/verification

      - name: Build Promotion Bundle
        id: bundle
        run: |
          TAG="${{ needs.verify.outputs.tag }}"
          COMMIT="${{ needs.verify.outputs.commit }}"
          VERSION="${{ needs.verify.outputs.version }}"
          GA_TAG="v${VERSION}"

          echo "Building Promotion Bundle for RC: ${TAG}"

          chmod +x scripts/release/build-promotion-bundle.sh

          # Build bundle in staging area
          STAGING_DIR="staging/promotion-bundle"
          mkdir -p "${STAGING_DIR}"

          scripts/release/build-promotion-bundle.sh \
            --tag "${TAG}" \
            --commit "${COMMIT}" \
            --output "${STAGING_DIR}" || true

          echo "bundle_staging=${STAGING_DIR}" >> $GITHUB_OUTPUT

      - name: Assemble RC Pipeline Bundle
        id: assemble
        run: |
          TAG="${{ needs.verify.outputs.tag }}"
          COMMIT="${{ needs.verify.outputs.commit }}"
          VERSION="${{ needs.verify.outputs.version }}"
          GA_TAG="v${VERSION}"
          ALLOWED="${{ needs.promotion-guard.outputs.promotion_allowed }}"

          # Final bundle directory
          BUNDLE_DIR="rc-pipeline-bundle-${TAG}"
          mkdir -p "${BUNDLE_DIR}"

          echo "Assembling RC Pipeline Bundle: ${BUNDLE_DIR}"

          # Copy verification output
          cp staging/verification/REQUIRED_CHECKS.txt "${BUNDLE_DIR}/" 2>/dev/null || true

          # Copy promotion bundle contents
          cp -r staging/promotion-bundle/* "${BUNDLE_DIR}/" 2>/dev/null || true

          # Create pipeline_metadata.json using jq for proper JSON
          PROMO_BOOL="false"
          if [[ "${ALLOWED}" == "true" ]]; then
            PROMO_BOOL="true"
          fi

          jq -n \
            --arg version "1.0.0" \
            --arg pipeline "release-rc" \
            --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg rc_tag "${TAG}" \
            --arg ga_tag "${GA_TAG}" \
            --arg base_version "${VERSION}" \
            --arg commit_sha "${COMMIT}" \
            --arg verification_status "${ALLOWED}" \
            --argjson promotion_allowed "${PROMO_BOOL}" \
            --arg run_id "${{ github.run_id }}" \
            --arg run_number "${{ github.run_number }}" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg actor "${{ github.actor }}" \
            --arg event "${{ github.event_name }}" \
            --arg verify_result "${{ needs.verify.result }}" \
            --arg guard_result "${{ needs.promotion-guard.result }}" \
            '{
              version: $version,
              pipeline: $pipeline,
              generated_at: $generated_at,
              rc_tag: $rc_tag,
              ga_tag: $ga_tag,
              base_version: $base_version,
              commit_sha: $commit_sha,
              verification_status: $verification_status,
              promotion_allowed: $promotion_allowed,
              workflow: {
                run_id: $run_id,
                run_number: $run_number,
                run_url: $run_url,
                actor: $actor,
                event: $event
              },
              jobs: {
                verify: $verify_result,
                promotion_guard: $guard_result
              },
              artifacts: {
                verification: "REQUIRED_CHECKS.txt",
                promotion_script: "promote_to_ga.sh",
                release_notes: "github_release.md",
                checklist: "PROMOTION_CHECKLIST.md"
              }
            }' > "${BUNDLE_DIR}/pipeline_metadata.json"

          # Create README using printf to avoid heredoc YAML parsing issues
          {
            printf '%s\n' "# RC Pipeline Bundle"
            printf '\n'
            printf '%s\n' "This bundle was generated by the Release RC Pipeline workflow."
            printf '\n'
            printf '%s\n' "## Contents"
            printf '\n'
            printf '%s\n' "| File | Purpose |"
            printf '%s\n' "|------|---------|"
            printf '%s\n' "| \`pipeline_metadata.json\` | Machine-readable pipeline metadata |"
            printf '%s\n' "| \`REQUIRED_CHECKS.txt\` | Verification truth table output |"
            printf '%s\n' "| \`github_release.md\` | GitHub Release description |"
            printf '%s\n' "| \`promote_to_ga.sh\` | Script to promote RC to GA |"
            printf '%s\n' "| \`PROMOTION_CHECKLIST.md\` | Step-by-step promotion guide |"
            printf '\n'
            printf '%s\n' "## Usage"
            printf '\n'
            printf '%s\n' "\`\`\`bash"
            printf '%s\n' "# Review verification status"
            printf '%s\n' "cat REQUIRED_CHECKS.txt"
            printf '\n'
            printf '%s\n' "# Check pipeline metadata"
            printf '%s\n' "cat pipeline_metadata.json | jq ."
            printf '\n'
            printf '%s\n' "# Preview GA promotion"
            printf '%s\n' "./promote_to_ga.sh --dry-run"
            printf '\n'
            printf '%s\n' "# Execute promotion (after approval)"
            printf '%s\n' "./promote_to_ga.sh"
            printf '%s\n' "\`\`\`"
            printf '\n'
            printf '%s\n' "## Verification Status"
            printf '\n'
            if [[ "${ALLOWED}" == "true" ]]; then
              printf '%s\n' "âœ… **PASSED** - All required checks passed. Safe to promote."
            else
              printf '%s\n' "âš ï¸ **PENDING/FAILED** - Some required checks pending or failed."
              printf '%s\n' "Review REQUIRED_CHECKS.txt before promoting."
            fi
            printf '\n'
            printf '%s\n' "---"
            printf '%s\n' "Generated by [Release RC Pipeline](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } > "${BUNDLE_DIR}/README.md"

          echo "bundle_dir=${BUNDLE_DIR}" >> $GITHUB_OUTPUT

          # List contents
          echo ""
          echo "Bundle contents:"
          ls -la "${BUNDLE_DIR}/"

      - name: Upload RC Pipeline Bundle
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: rc-pipeline-bundle-${{ needs.verify.outputs.tag }}
          path: ${{ steps.assemble.outputs.bundle_dir }}
          retention-days: 90

      - name: Cleanup Intermediate Artifacts
        uses: geekyeggo/delete-artifact@f275313e70c08f6120db482d7a6b98377786765b # v5
        with:
          name: verification-output
          failOnError: false

      - name: Generate Job Summary
        run: |
          TAG="${{ needs.verify.outputs.tag }}"
          COMMIT="${{ needs.verify.outputs.commit }}"
          VERSION="${{ needs.verify.outputs.version }}"
          GA_TAG="v${VERSION}"
          ALLOWED="${{ needs.promotion-guard.outputs.promotion_allowed }}"

          if [[ "${ALLOWED}" == "true" ]]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="PASSED"
          else
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="PENDING/FAILED"
          fi

          echo "## ${STATUS_ICON} RC Pipeline Complete: ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release Readiness | âœ… ${{ needs.verify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Promotion Guard | ${STATUS_ICON} ${STATUS_TEXT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline Bundle | âœ… Assembled |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RC Tag | \`${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| GA Tag | \`${GA_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${COMMIT:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | \`rc-pipeline-bundle-${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Bundle Contents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`pipeline_metadata.json\` | Machine-readable pipeline metadata |" >> $GITHUB_STEP_SUMMARY
          echo "| \`REQUIRED_CHECKS.txt\` | Verification truth table output |" >> $GITHUB_STEP_SUMMARY
          echo "| \`github_release.md\` | GitHub Release description |" >> $GITHUB_STEP_SUMMARY
          echo "| \`promote_to_ga.sh\` | Script to promote RC to GA |" >> $GITHUB_STEP_SUMMARY
          echo "| \`PROMOTION_CHECKLIST.md\` | Step-by-step promotion guide |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${ALLOWED}" == "true" ]]; then
            echo "### ðŸš€ How to Promote" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the \`rc-pipeline-bundle-${TAG}\` artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Extract and navigate to the bundle directory" >> $GITHUB_STEP_SUMMARY
            echo "3. Review the checklist: \`cat PROMOTION_CHECKLIST.md\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Preview: \`./promote_to_ga.sh --dry-run\`" >> $GITHUB_STEP_SUMMARY
            echo "5. Execute: \`./promote_to_ga.sh\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Quick promotion commands" >> $GITHUB_STEP_SUMMARY
            echo "cd rc-pipeline-bundle-${TAG}" >> $GITHUB_STEP_SUMMARY
            echo "./promote_to_ga.sh --dry-run  # Preview" >> $GITHUB_STEP_SUMMARY
            echo "./promote_to_ga.sh            # Execute" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some required checks are still pending or failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Review \`REQUIRED_CHECKS.txt\` in the bundle" >> $GITHUB_STEP_SUMMARY
            echo "2. Wait for in-progress workflows to complete" >> $GITHUB_STEP_SUMMARY
            echo "3. Fix any test/build/lint failures" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-verify with Tag Verification workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "./scripts/release/verify-green-for-tag.sh --tag ${TAG} --commit ${COMMIT}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
