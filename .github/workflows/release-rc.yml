name: Release RC Pipeline

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Base version (e.g., 4.1.2). Defaults to package.json version."
        required: false
        type: string
      rc_number:
        description: "RC number override (e.g., 1). Auto-increments when omitted."
        required: false
        type: string
      target_sha:
        description: "Target commit SHA (defaults to main HEAD)."
        required: false
        type: string
      previous_tag:
        description: "Override previous tag for changelog range."
        required: false
        type: string
      confirm_tag:
        description: "Set true to create/push the RC tag."
        required: false
        default: false
        type: boolean
      publish:
        description: "Publish the RC release (default: draft only)."
        required: false
        default: false
        type: boolean
      allow_non_main:
        description: "Allow tagging commits not on main (governed exception)."
        required: false
        default: false
        type: boolean
      evidence_workflow:
        description: "Workflow file that produced the GA evidence bundle."
        required: false
        default: "ga-ready.yml"
        type: string
      evidence_artifact:
        description: "Artifact name containing the GA evidence bundle."
        required: false
        default: "ga-evidence"
        type: string
      trust_workflow:
        description: "Workflow file that produced the trust snapshot."
        required: false
        default: "publish-trust-snapshot.yml"
        type: string
      trust_artifact:
        description: "Artifact name containing the trust snapshot."
        required: false
        default: "trust-snapshot"
        type: string
      sbom_workflow:
        description: "Workflow file that produced SBOM artifacts (optional)."
        required: false
        default: ""
        type: string
      sbom_artifact:
        description: "Artifact name containing SBOM files (optional)."
        required: false
        default: ""
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: release-rc-${{ inputs.version || inputs.target_sha || github.run_id }}
  cancel-in-progress: false

jobs:
  resolve:
    name: Resolve Target + Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      target_sha: ${{ steps.target.outputs.sha }}
      version: ${{ steps.tag.outputs.version }}
      tag_exists: ${{ steps.tag.outputs.tag_exists }}
      tag_matches: ${{ steps.tag.outputs.tag_matches }}

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags and main
        run: |
          git fetch origin main --tags --prune

      - name: Resolve target SHA
        id: target
        run: |
          if [[ -n "${{ inputs.target_sha }}" ]]; then
            SHA="${{ inputs.target_sha }}"
          else
            SHA=$(git rev-parse origin/main)
          fi

          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "Target SHA: ${SHA}"

          if [[ "${{ inputs.allow_non_main }}" != "true" ]]; then
            if ! git merge-base --is-ancestor "${SHA}" origin/main; then
              echo "::error::Target SHA is not on main. Governed exception required."
              exit 1
            fi
          else
            echo "Governed exception: non-main SHA allowed."
          fi

      - name: Determine RC tag
        id: tag
        run: |
          VERSION_INPUT="${{ inputs.version }}"
          if [[ -z "${VERSION_INPUT}" ]]; then
            VERSION_INPUT=$(node -p "JSON.parse(require('fs').readFileSync('package.json','utf8')).version")
          fi

          VERSION_INPUT=${VERSION_INPUT#v}
          BASE_VERSION=${VERSION_INPUT%%-rc.*}

          RC_NUMBER="${{ inputs.rc_number }}"
          if [[ -z "${RC_NUMBER}" ]]; then
            LAST_RC=$(git tag -l "v${BASE_VERSION}-rc.*" --sort=-v:refname | head -n 1)
            if [[ -n "${LAST_RC}" ]]; then
              RC_NUMBER=$(echo "${LAST_RC}" | sed -E 's/.*-rc\.([0-9]+)$/\1/')
              RC_NUMBER=$((RC_NUMBER + 1))
            else
              RC_NUMBER=1
            fi
          fi

          TAG="v${BASE_VERSION}-rc.${RC_NUMBER}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${BASE_VERSION}" >> $GITHUB_OUTPUT

          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            TAG_SHA=$(git rev-parse "${TAG}")
            if [[ "${TAG_SHA}" == "${{ steps.target.outputs.sha }}" ]]; then
              echo "tag_exists=true" >> $GITHUB_OUTPUT
              echo "tag_matches=true" >> $GITHUB_OUTPUT
              echo "Tag already exists and matches target SHA."
            else
              echo "::error::Tag ${TAG} already exists for ${TAG_SHA}."
              exit 1
            fi
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "tag_matches=false" >> $GITHUB_OUTPUT
          fi

          echo "Resolved tag: ${TAG}"

  verify:
    name: Verify Preconditions
    runs-on: ubuntu-latest
    needs: resolve
    outputs:
      ga_gate_status: ${{ steps.gate.outputs.status }}
      ga_gate_run_id: ${{ steps.gate.outputs.run_id }}
      evidence_bundle_zip: ${{ steps.artifacts.outputs.evidence_bundle_zip }}
      trust_snapshot_file: ${{ steps.artifacts.outputs.trust_snapshot_file }}
      evidence_manifest: ${{ steps.artifacts.outputs.evidence_manifest }}
      sbom_dir: ${{ steps.artifacts.outputs.sbom_dir }}

    steps:
      - name: Checkout target SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.target_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run release readiness gate
        run: pnpm release:ready

      - name: Verify GA Gate status
        id: gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          SHA="${{ needs.resolve.outputs.target_sha }}"
          RUN_JSON=$(gh api "repos/${REPO}/actions/workflows/ga-gate.yml/runs?head_sha=${SHA}&status=completed" --jq '.workflow_runs[0]')

          if [[ -z "${RUN_JSON}" || "${RUN_JSON}" == "null" ]]; then
            echo "::error::No GA Gate run found for ${SHA}."
            exit 1
          fi

          RUN_ID=$(echo "${RUN_JSON}" | jq -r '.id')
          CONCLUSION=$(echo "${RUN_JSON}" | jq -r '.conclusion')

          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "status=${CONCLUSION}" >> $GITHUB_OUTPUT

          if [[ "${CONCLUSION}" != "success" ]]; then
            echo "::error::GA Gate is not green for ${SHA} (status: ${CONCLUSION})."
            exit 1
          fi

      - name: Download evidence + trust artifacts
        id: artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          SHA="${{ needs.resolve.outputs.target_sha }}"
          EVIDENCE_WORKFLOW="${{ inputs.evidence_workflow }}"
          EVIDENCE_ARTIFACT="${{ inputs.evidence_artifact }}"
          TRUST_WORKFLOW="${{ inputs.trust_workflow }}"
          TRUST_ARTIFACT="${{ inputs.trust_artifact }}"
          SBOM_WORKFLOW="${{ inputs.sbom_workflow }}"
          SBOM_ARTIFACT="${{ inputs.sbom_artifact }}"

          mkdir -p artifacts/rc/input

          download_artifact() {
            local workflow=$1
            local artifact=$2
            local dest=$3

            local run_id
            run_id=$(gh api "repos/${REPO}/actions/workflows/${workflow}/runs?head_sha=${SHA}&status=completed" --jq '.workflow_runs[0].id')
            if [[ -z "${run_id}" || "${run_id}" == "null" ]]; then
              echo "::error::No workflow runs found for ${workflow} and ${SHA}."
              exit 1
            fi

            local artifact_id
            artifact_id=$(gh api "repos/${REPO}/actions/runs/${run_id}/artifacts" --jq ".artifacts[] | select(.name==\"${artifact}\") | .id" | head -n 1)
            if [[ -z "${artifact_id}" || "${artifact_id}" == "null" ]]; then
              echo "::error::Artifact ${artifact} not found in ${workflow} run ${run_id}."
              exit 1
            fi

            gh api "repos/${REPO}/actions/artifacts/${artifact_id}/zip" > "${dest}.zip"
            unzip -q "${dest}.zip" -d "${dest}"
          }

          download_artifact "${EVIDENCE_WORKFLOW}" "${EVIDENCE_ARTIFACT}" "artifacts/rc/input/${EVIDENCE_ARTIFACT}"
          download_artifact "${TRUST_WORKFLOW}" "${TRUST_ARTIFACT}" "artifacts/rc/input/${TRUST_ARTIFACT}"

          TRUST_FILE=$(find "artifacts/rc/input/${TRUST_ARTIFACT}" -type f \( -name 'trust-snapshot.json' -o -name 'trust_snapshot.json' \) | head -n 1)
          if [[ -z "${TRUST_FILE}" ]]; then
            echo "::error::Trust snapshot JSON not found in ${TRUST_ARTIFACT} artifact."
            exit 1
          fi

          if [[ -n "${SBOM_WORKFLOW}" && -n "${SBOM_ARTIFACT}" ]]; then
            download_artifact "${SBOM_WORKFLOW}" "${SBOM_ARTIFACT}" "artifacts/rc/input/${SBOM_ARTIFACT}"
            mkdir -p artifacts/rc/input/sboms
            cp -R "artifacts/rc/input/${SBOM_ARTIFACT}/." artifacts/rc/input/sboms/
            echo "sbom_dir=artifacts/rc/input/sboms" >> $GITHUB_OUTPUT
          else
            echo "sbom_dir=" >> $GITHUB_OUTPUT
          fi

          echo "evidence_bundle_zip=artifacts/rc/input/${EVIDENCE_ARTIFACT}.zip" >> $GITHUB_OUTPUT
          echo "trust_snapshot_file=${TRUST_FILE}" >> $GITHUB_OUTPUT
          echo "evidence_manifest=EVIDENCE_BUNDLE.manifest.json" >> $GITHUB_OUTPUT

      - name: Validate evidence manifest + trust snapshot
        run: |
          pnpm exec tsx scripts/release/validate_evidence_manifest.ts --manifest EVIDENCE_BUNDLE.manifest.json
          pnpm exec tsx scripts/release/validate_trust_snapshot.ts --snapshot "${{ steps.artifacts.outputs.trust_snapshot_file }}"

      - name: Upload RC input artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rc-release-inputs-${{ needs.resolve.outputs.tag }}
          path: |
            ${{ steps.artifacts.outputs.evidence_bundle_zip }}
            ${{ steps.artifacts.outputs.trust_snapshot_file }}
            ${{ steps.artifacts.outputs.sbom_dir }}

  assemble:
    name: Assemble Release Notes
    runs-on: ubuntu-latest
    needs: [resolve, verify]
    outputs:
      release_notes_dir: ${{ steps.notes.outputs.dir }}

    steps:
      - name: Checkout target SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.target_sha }}

      - name: Download RC input artifacts
        uses: actions/download-artifact@v4
        with:
          name: rc-release-inputs-${{ needs.resolve.outputs.tag }}
          path: artifacts/rc/input

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Assemble release notes
        id: notes
        run: |
          OUT_DIR="artifacts/rc/release-notes"
          mkdir -p "${OUT_DIR}"

          EVIDENCE_ZIP="artifacts/rc/input/${{ inputs.evidence_artifact }}.zip"
          TRUST_FILE=$(find artifacts/rc/input -type f \( -name 'trust-snapshot.json' -o -name 'trust_snapshot.json' \) | head -n 1)

          if [[ -z "${TRUST_FILE}" ]]; then
            echo "::error::Trust snapshot JSON not found in downloaded artifacts."
            exit 1
          fi

          pnpm exec tsx scripts/release/assemble_release_notes.ts \
            --tag "${{ needs.resolve.outputs.tag }}" \
            --target-sha "${{ needs.resolve.outputs.target_sha }}" \
            --previous-tag "${{ inputs.previous_tag }}" \
            --trust-snapshot "${TRUST_FILE}" \
            --evidence-manifest "EVIDENCE_BUNDLE.manifest.json" \
            --evidence-bundle "${EVIDENCE_ZIP}" \
            --output-dir "${OUT_DIR}" \
            --repo "${{ github.repository }}" \
            --run-id "${{ github.run_id }}" \
            --ga-gate-status "${{ needs.verify.outputs.ga_gate_status }}"

          echo "dir=${OUT_DIR}" >> $GITHUB_OUTPUT

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: rc-release-notes-${{ needs.resolve.outputs.tag }}
          path: ${{ steps.notes.outputs.dir }}

  tag:
    name: Tag RC
    runs-on: ubuntu-latest
    needs: [resolve, verify, assemble]
    outputs:
      tag_ready: ${{ steps.tag.outputs.tag_ready }}

    steps:
      - name: Checkout target SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.target_sha }}

      - name: Create RC tag
        id: tag
        run: |
          TAG="${{ needs.resolve.outputs.tag }}"
          SHA="${{ needs.resolve.outputs.target_sha }}"
          TAG_EXISTS="${{ needs.resolve.outputs.tag_exists }}"

          if [[ "${TAG_EXISTS}" == "true" ]]; then
            echo "tag_ready=true" >> $GITHUB_OUTPUT
            echo "Tag already exists for ${TAG}."
            exit 0
          fi

          if [[ "${{ inputs.confirm_tag }}" != "true" ]]; then
            echo "::error::confirm_tag is false. RC tag will not be created."
            exit 1
          fi

          git tag -a "${TAG}" -m "Release Candidate ${TAG}" "${SHA}"
          git push origin "${TAG}"
          echo "tag_ready=true" >> $GITHUB_OUTPUT

  release-draft:
    name: Draft GitHub Release
    runs-on: ubuntu-latest
    needs: [resolve, verify, assemble, tag]
    if: needs.tag.outputs.tag_ready == 'true'
    outputs:
      release_url: ${{ steps.release.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download RC input artifacts
        uses: actions/download-artifact@v4
        with:
          name: rc-release-inputs-${{ needs.resolve.outputs.tag }}
          path: artifacts/rc/input

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: rc-release-notes-${{ needs.resolve.outputs.tag }}
          path: artifacts/rc/release-notes

      - name: Ensure draft release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.resolve.outputs.tag }}"
          NOTES_FILE="artifacts/rc/release-notes/release_notes.md"

          if gh release view "${TAG}" --json isDraft,isPrerelease,url >/dev/null 2>&1; then
            DRAFT=$(gh release view "${TAG}" --json isDraft --jq '.isDraft')
            if [[ "${DRAFT}" != "true" && "${{ inputs.publish }}" != "true" ]]; then
              echo "::error::Release ${TAG} is already published. Draft-only mode enforced."
              exit 1
            fi
            gh release edit "${TAG}" --draft --prerelease --notes-file "${NOTES_FILE}"
          else
            gh release create "${TAG}" --draft --prerelease --notes-file "${NOTES_FILE}"
          fi

          URL=$(gh release view "${TAG}" --json url --jq '.url')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.resolve.outputs.tag }}"
          EVIDENCE_ZIP="artifacts/rc/input/${{ inputs.evidence_artifact }}.zip"
          TRUST_FILE=$(find artifacts/rc/input -type f \( -name 'trust-snapshot.json' -o -name 'trust_snapshot.json' \) | head -n 1)

          if [[ -z "${TRUST_FILE}" ]]; then
            echo "::error::Trust snapshot JSON not found in downloaded artifacts."
            exit 1
          fi

          gh release upload "${TAG}" \
            "${EVIDENCE_ZIP}" \
            "${TRUST_FILE}" \
            "EVIDENCE_BUNDLE.manifest.json" \
            "artifacts/rc/release-notes/release_notes.md" \
            "artifacts/rc/release-notes/release_notes.json" \
            --clobber

          if [[ -d "artifacts/rc/input/sboms" ]]; then
            find "artifacts/rc/input/sboms" -maxdepth 2 -type f -print0 | \
              xargs -0 gh release upload "${TAG}" --clobber
          fi

  publish:
    name: Publish RC Release
    runs-on: ubuntu-latest
    needs: [resolve, release-draft]
    if: inputs.publish == true
    environment: rc-release-publish

    steps:
      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.resolve.outputs.tag }}"
          gh release edit "${TAG}" --draft=false --prerelease

      - name: Publish summary
        run: |
          echo "RC release ${{ needs.resolve.outputs.tag }} published." >> $GITHUB_STEP_SUMMARY
