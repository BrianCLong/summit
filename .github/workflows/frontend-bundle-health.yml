name: Frontend Bundle Health

on:
  pull_request:
    paths:
      - 'apps/web/**'
      - 'client/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - 'client/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-bundles:
    name: Analyze Bundle Sizes
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build apps/web with bundle analysis
        run: pnpm --filter @intelgraph/web build
        continue-on-error: true

      - name: Build client with bundle analysis
        run: pnpm --filter intelgraph-client build
        continue-on-error: true

      - name: Calculate bundle sizes
        id: bundle-sizes
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # apps/web bundle sizes
          if [ -d "apps/web/dist/assets" ]; then
            echo "### apps/web" >> $GITHUB_STEP_SUMMARY
            WEB_TOTAL=$(du -sh apps/web/dist/assets 2>/dev/null | cut -f1 || echo "N/A")
            WEB_JS=$(find apps/web/dist/assets -name "*.js" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "N/A")
            echo "- **Total assets:** $WEB_TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **JavaScript:** $WEB_JS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List largest JS files
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Largest JS bundles (apps/web)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lhS apps/web/dist/assets/*.js 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # client bundle sizes
          if [ -d "client/dist/assets" ]; then
            echo "### client" >> $GITHUB_STEP_SUMMARY
            CLIENT_TOTAL=$(du -sh client/dist/assets 2>/dev/null | cut -f1 || echo "N/A")
            CLIENT_JS=$(find client/dist/assets -name "*.js" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "N/A")
            echo "- **Total assets:** $CLIENT_TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **JavaScript:** $CLIENT_JS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List largest JS files
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Largest JS bundles (client)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lhS client/dist/assets/*.js 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload apps/web bundle stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-bundle-stats
          path: |
            apps/web/dist/stats.html
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload client bundle stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: client-bundle-stats
          path: |
            client/dist/stats.html
          if-no-files-found: ignore
          retention-days: 14

      - name: Check bundle size limits
        run: |
          # Check if main bundles exceed limits
          MAX_MAIN_BUNDLE_KB=2000  # 2MB limit for main bundle

          # Check apps/web
          if [ -f "apps/web/dist/assets/index-*.js" ] 2>/dev/null; then
            WEB_MAIN=$(find apps/web/dist/assets -name "index-*.js" -exec stat -c%s {} \; | head -1)
            WEB_MAIN_KB=$((WEB_MAIN / 1024))
            if [ "$WEB_MAIN_KB" -gt "$MAX_MAIN_BUNDLE_KB" ]; then
              echo "::warning::apps/web main bundle ($WEB_MAIN_KB KB) exceeds ${MAX_MAIN_BUNDLE_KB}KB limit"
            fi
          fi

          # Check client (has 3.4MB bundle - tracked separately)
          if [ -f "client/dist/assets/index-*.js" ] 2>/dev/null; then
            CLIENT_MAIN=$(find client/dist/assets -name "index-*.js" -exec stat -c%s {} \; | head -1)
            CLIENT_MAIN_KB=$((CLIENT_MAIN / 1024))
            echo "::notice::client main bundle is ${CLIENT_MAIN_KB}KB (optimization in progress)"
          fi

          echo "Bundle size check completed"
