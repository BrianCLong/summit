name: data-consistency

on:
  pull_request:
    paths:
      - 'db/**'
      - 'graph/**'
      - 'scripts/**'
      - '.github/workflows/data-consistency.yml'
  workflow_dispatch:

jobs:
  compare-digests:
    if: ${{ vars.DATA_CONSISTENCY_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: summit
          POSTGRES_PASSWORD: summit
          POSTGRES_DB: summit
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U summit"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      neo4j:
        image: neo4j:5
        env:
          NEO4J_AUTH: neo4j/summit
          NEO4J_PLUGINS: '["apoc"]'
          NEO4J_dbms_security_procedures_unrestricted: apoc.*
          NEO4J_dbms_security_procedures_allowlist: apoc.*
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "wget -qO- http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    env:
      PGHOST: localhost
      PGPORT: 5432
      PGDATABASE: summit
      PGUSER: summit
      PGPASSWORD: summit
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASS: summit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install clients
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client wget
          curl -fsSL https://dist.neo4j.org/neo4j-community-5.26.0-unix.tar.gz -o neo4j.tgz
          tar -xzf neo4j.tgz
          echo "$PWD/neo4j-community-5.26.0/bin" >> "$GITHUB_PATH"

      - name: Prepare Postgres extensions
        run: |
          psql -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
          psql -v ON_ERROR_STOP=1 -c "CREATE TABLE IF NOT EXISTS public.entities (id text, name text, kind text, updated_at timestamptz);"

      - name: Compare digests
        run: node scripts/ci/compare_digests.mjs

      - name: Upload evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-consistency-evidence
          path: artifacts/evidence/data_consistency/evidence_delta.json
