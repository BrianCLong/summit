name: Documentation Site Sync

# Syncs public documentation from /docs to the docs-site for publishing
# Filters sensitive content and maintains public documentation freshness

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'docs-site/**'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Force full sync of all documentation'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: docs-site-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Filter and sync public documentation
  # ═══════════════════════════════════════════════════════════════════════════
  sync:
    name: Sync Public Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Identify Changed Documentation
        id: changed-docs
        run: |
          if [ "${{ inputs.full_sync }}" == "true" ]; then
            echo "Performing full sync..."
            echo "full_sync=true" >> $GITHUB_OUTPUT
          else
            # Get changed files in docs/
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- docs/ || echo "")
            echo "Changed files: $CHANGED_FILES"

            if [ -z "$CHANGED_FILES" ]; then
              echo "No documentation changes detected"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Filter Public Documentation
        if: steps.changed-docs.outputs.has_changes == 'true' || steps.changed-docs.outputs.full_sync == 'true'
        run: |
          # Create sync manifest
          SYNC_DIR="docs-site/docs"
          mkdir -p "$SYNC_DIR"

          echo "# Documentation Sync Manifest" > sync-manifest.md
          echo "" >> sync-manifest.md
          echo "**Synced:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> sync-manifest.md
          echo "" >> sync-manifest.md

          # Define public documentation directories
          PUBLIC_DIRS=(
            "docs/getting-started"
            "docs/tutorials"
            "docs/api"
            "docs/api-reference"
            "docs/architecture"
            "docs/ADR"
            "docs/deployment"
            "docs/contributing"
            "docs/security"
            "docs/runbooks"
          )

          # Define files/patterns to exclude (sensitive content)
          EXCLUDE_PATTERNS=(
            "**/internal/**"
            "**/private/**"
            "**/*-internal.md"
            "**/*-private.md"
            "**/BLACK_PROJECTS*"
            "**/credentials*"
            "**/secrets*"
          )

          echo "## Synced Directories" >> sync-manifest.md
          echo "" >> sync-manifest.md

          for dir in "${PUBLIC_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              TARGET_DIR="$SYNC_DIR/$(basename "$dir")"
              mkdir -p "$TARGET_DIR"

              # Build rsync exclude arguments
              EXCLUDES=""
              for pattern in "${EXCLUDE_PATTERNS[@]}"; do
                EXCLUDES="$EXCLUDES --exclude='$pattern'"
              done

              # Sync directory
              eval rsync -av --delete $EXCLUDES "$dir/" "$TARGET_DIR/"

              FILE_COUNT=$(find "$TARGET_DIR" -name '*.md' | wc -l)
              echo "- **$(basename "$dir")**: $FILE_COUNT files" >> sync-manifest.md
            fi
          done

          echo "" >> sync-manifest.md
          echo "## Excluded Patterns" >> sync-manifest.md
          echo "" >> sync-manifest.md
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            echo "- \`$pattern\`" >> sync-manifest.md
          done

      - name: Update Docusaurus Sidebar
        if: steps.changed-docs.outputs.has_changes == 'true' || steps.changed-docs.outputs.full_sync == 'true'
        run: |
          # Generate sidebar configuration from synced docs
          SIDEBAR_FILE="docs-site/sidebars-generated.js"

          cat > "$SIDEBAR_FILE" << 'EOF'
          // Auto-generated sidebar configuration
          // Generated by docs-site-sync.yml workflow

          module.exports = {
            docs: [
              {
                type: 'category',
                label: 'Getting Started',
                items: [{ type: 'autogenerated', dirName: 'getting-started' }],
              },
              {
                type: 'category',
                label: 'Tutorials',
                items: [{ type: 'autogenerated', dirName: 'tutorials' }],
              },
              {
                type: 'category',
                label: 'API Reference',
                items: [{ type: 'autogenerated', dirName: 'api-reference' }],
              },
              {
                type: 'category',
                label: 'Architecture',
                items: [{ type: 'autogenerated', dirName: 'architecture' }],
              },
              {
                type: 'category',
                label: 'ADRs',
                items: [{ type: 'autogenerated', dirName: 'ADR' }],
              },
              {
                type: 'category',
                label: 'Deployment',
                items: [{ type: 'autogenerated', dirName: 'deployment' }],
              },
              {
                type: 'category',
                label: 'Security',
                items: [{ type: 'autogenerated', dirName: 'security' }],
              },
              {
                type: 'category',
                label: 'Runbooks',
                items: [{ type: 'autogenerated', dirName: 'runbooks' }],
              },
            ],
          };
          EOF

      - name: Check for Sync Changes
        id: check-sync
        run: |
          if git diff --quiet docs-site/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Sync
        if: steps.check-sync.outputs.changed == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs-site/
          git commit -m "docs: sync public documentation to docs-site [skip ci]"
          git push

      - name: Upload Sync Manifest
        uses: actions/upload-artifact@v4
        with:
          name: docs-sync-manifest
          path: sync-manifest.md
          retention-days: 7

      - name: Summary
        run: |
          echo "## Documentation Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f sync-manifest.md ]; then
            cat sync-manifest.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No sync performed - no changes detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ═══════════════════════════════════════════════════════════════════════════
  # Build documentation site (optional, for preview)
  # ═══════════════════════════════════════════════════════════════════════════
  build:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    needs: sync
    if: github.event_name == 'push' || inputs.full_sync == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'
          cache-dependency-path: docs-site/package-lock.json

      - name: Install Dependencies
        working-directory: docs-site
        run: npm ci || npm install

      - name: Build Site
        working-directory: docs-site
        run: npm run build || echo "Build script not configured"
        continue-on-error: true

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-site-build
          path: docs-site/build/
          retention-days: 7
