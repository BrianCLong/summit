# _reusable-ci-metrics.yml
# Collects CI run metrics for canary comparison and trend analysis
#
# Uploads metrics as JSON artifacts for post-analysis.
# Call this as a final job in any workflow to track performance.
#
# Authority: docs/ci/CI_METRICS.md

name: CI Metrics Collection

on:
  workflow_call:
    inputs:
      workflow_name:
        description: "Name of the calling workflow"
        required: true
        type: string
      run_type:
        description: "Type of run: canary, main, pr"
        required: false
        type: string
        default: "pr"
      include_job_timings:
        description: "Include per-job timing breakdown"
        required: false
        type: boolean
        default: true
    outputs:
      metrics_artifact_name:
        description: "Name of the uploaded metrics artifact"
        value: ${{ jobs.collect-metrics.outputs.artifact_name }}
      total_duration_minutes:
        description: "Total workflow duration in minutes"
        value: ${{ jobs.collect-metrics.outputs.duration_minutes }}
      success_rate:
        description: "Job success rate (0-100)"
        value: ${{ jobs.collect-metrics.outputs.success_rate }}

permissions:
  contents: read
  actions: read

jobs:
  collect-metrics:
    name: Collect CI Metrics
    runs-on: ubuntu-latest
    # Run even if previous jobs failed
    if: ${{ always() }}
    timeout-minutes: 5

    outputs:
      artifact_name: ${{ steps.upload.outputs.artifact_name }}
      duration_minutes: ${{ steps.metrics.outputs.duration_minutes }}
      success_rate: ${{ steps.metrics.outputs.success_rate }}

    steps:
      - name: Checkout (for scripts)
        uses: actions/checkout@v4 # v6
          sparse-checkout: scripts/ci

      - name: Collect Workflow Metrics
        id: metrics
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get workflow run details
          RUN_ID="${{ github.run_id }}"
          REPO="${{ github.repository }}"

          # Fetch job data from GitHub API
          JOBS_JSON=$(gh api "/repos/${REPO}/actions/runs/${RUN_ID}/jobs" --jq '.jobs')

          # Calculate metrics
          TOTAL_JOBS=$(echo "$JOBS_JSON" | jq 'length')
          SUCCESSFUL_JOBS=$(echo "$JOBS_JSON" | jq '[.[] | select(.conclusion == "success")] | length')
          FAILED_JOBS=$(echo "$JOBS_JSON" | jq '[.[] | select(.conclusion == "failure")] | length')
          SKIPPED_JOBS=$(echo "$JOBS_JSON" | jq '[.[] | select(.conclusion == "skipped")] | length')

          # Calculate success rate (excluding skipped jobs)
          COUNTABLE_JOBS=$((TOTAL_JOBS - SKIPPED_JOBS))
          if [ "$COUNTABLE_JOBS" -gt 0 ]; then
            SUCCESS_RATE=$((SUCCESSFUL_JOBS * 100 / COUNTABLE_JOBS))
          else
            SUCCESS_RATE=100
          fi

          # Get timing information
          START_TIME=$(echo "$JOBS_JSON" | jq -r '[.[] | .started_at // empty] | sort | first // empty')
          END_TIME=$(echo "$JOBS_JSON" | jq -r '[.[] | .completed_at // empty] | sort | last // empty')

          if [ -n "$START_TIME" ] && [ -n "$END_TIME" ]; then
            START_EPOCH=$(date -d "$START_TIME" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$START_TIME" +%s 2>/dev/null || echo 0)
            END_EPOCH=$(date -d "$END_TIME" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$END_TIME" +%s 2>/dev/null || echo 0)
            DURATION_SECONDS=$((END_EPOCH - START_EPOCH))
            DURATION_MINUTES=$((DURATION_SECONDS / 60))
          else
            DURATION_MINUTES=0
          fi

          # Calculate queue time (time from workflow trigger to first job start)
          WORKFLOW_CREATED="${{ github.event.workflow_run.created_at || github.event.pull_request.updated_at || '' }}"
          QUEUE_SECONDS=0
          if [ -n "$WORKFLOW_CREATED" ] && [ -n "$START_TIME" ]; then
            CREATED_EPOCH=$(date -d "$WORKFLOW_CREATED" +%s 2>/dev/null || echo 0)
            if [ "$CREATED_EPOCH" -gt 0 ] && [ "$START_EPOCH" -gt 0 ]; then
              QUEUE_SECONDS=$((START_EPOCH - CREATED_EPOCH))
            fi
          fi

          # Extract per-job timings if requested
          JOB_TIMINGS="[]"
          if [ "${{ inputs.include_job_timings }}" = "true" ]; then
            JOB_TIMINGS=$(echo "$JOBS_JSON" | jq '[.[] | {
              name: .name,
              status: .conclusion,
              started_at: .started_at,
              completed_at: .completed_at,
              duration_seconds: (
                if .started_at and .completed_at then
                  (((.completed_at | fromdateiso8601) - (.started_at | fromdateiso8601)))
                else 0 end
              ),
              runner_name: .runner_name
            }]')
          fi

          # Output summary
          echo "duration_minutes=${DURATION_MINUTES}" >> $GITHUB_OUTPUT
          echo "success_rate=${SUCCESS_RATE}" >> $GITHUB_OUTPUT

          # Create metrics JSON
          mkdir -p artifacts/ci-metrics
          cat > artifacts/ci-metrics/run-metrics.json << EOF
          {
            "run_id": "${{ github.run_id }}",
            "run_number": ${{ github.run_number }},
            "run_attempt": ${{ github.run_attempt }},
            "workflow_name": "${{ inputs.workflow_name }}",
            "run_type": "${{ inputs.run_type }}",
            "ref": "${{ github.ref }}",
            "ref_name": "${{ github.ref_name }}",
            "sha": "${{ github.sha }}",
            "event_name": "${{ github.event_name }}",
            "actor": "${{ github.actor }}",
            "repository": "${{ github.repository }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "metrics": {
              "total_jobs": ${TOTAL_JOBS},
              "successful_jobs": ${SUCCESSFUL_JOBS},
              "failed_jobs": ${FAILED_JOBS},
              "skipped_jobs": ${SKIPPED_JOBS},
              "success_rate": ${SUCCESS_RATE},
              "duration_minutes": ${DURATION_MINUTES},
              "duration_seconds": ${DURATION_SECONDS:-0},
              "queue_seconds": ${QUEUE_SECONDS}
            },
            "job_timings": ${JOB_TIMINGS}
          }
          EOF

          echo "::notice::CI Metrics: ${SUCCESS_RATE}% success rate, ${DURATION_MINUTES}m duration, ${QUEUE_SECONDS}s queue time"

      - name: Upload Metrics Artifact
        id: upload
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
          name: ci-metrics-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts/ci-metrics/
          retention-days: 30

      - name: Output Artifact Name
        run: |
          echo "artifact_name=ci-metrics-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
