name: Preview Environment
on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  CLUSTER_CONTEXT: ${{ secrets.KUBE_CONTEXT_DEV }}
  NAMESPACE: summit-pr-${{ github.event.number }}
  RELEASE: summit-pr-${{ github.event.number }}

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG_DATA}" | base64 -d > ~/.kube/config
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DEV_B64 }}

      - name: Create namespace
        run: |
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - name: Helm upgrade --install (preview)
        run: |
          helm upgrade --install $RELEASE charts/summit \
            --namespace $NAMESPACE \
            -f charts/summit/values.dev.yaml \
            --set image.repository=${{ secrets.REGISTRY }}/summit \
            --set image.tag=${{ github.sha }} \
            --set env.PR_NUMBER=${{ github.event.number }}

      - name: Output preview URL
        run: |
          kubectl -n $NAMESPACE get ing -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}' || true
