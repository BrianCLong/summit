name: Governance Policy Validation

# Validates governance policy files for syntax and required fields
# Ensures all policies are valid before they can affect deployments
#
# Authority: docs/ci/GOVERNANCE_LOCKFILE.md

on:
  # Run on policy file changes
  push:
    branches: [main]
    paths:
      - "docs/ci/*.yml"
      - "docs/ci/*.yaml"
      - "docs/releases/_state/*.json"

  pull_request:
    branches: [main]
    paths:
      - "docs/ci/*.yml"
      - "docs/ci/*.yaml"
      - "docs/releases/_state/*.json"

  # Manual trigger
  workflow_dispatch:
    inputs:
      strict_mode:
        description: "Treat warnings as errors"
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  validate-policies:
    name: Validate Governance Policies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install pyyaml
          # jq is pre-installed on ubuntu-latest

      - name: Make Scripts Executable
        run: chmod +x scripts/release/*.sh

      - name: Validate Policies
        id: validate
        run: |
          ARGS="--verbose"

          if [[ "${{ inputs.strict_mode }}" == "true" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ARGS="${ARGS} --strict"
          fi

          # Run validation
          RESULT=$(./scripts/release/validate_governance_policies.sh ${ARGS} --json 2>&1) || EXIT_CODE=$?

          echo "${RESULT}" > validation_report.json

          # Parse results
          TOTAL=$(echo "${RESULT}" | jq -r '.summary.total // 0')
          PASSED=$(echo "${RESULT}" | jq -r '.summary.passed // 0')
          FAILED=$(echo "${RESULT}" | jq -r '.summary.failed // 0')
          WARNINGS=$(echo "${RESULT}" | jq -r '.summary.warnings // 0')
          SKIPPED=$(echo "${RESULT}" | jq -r '.summary.skipped // 0')
          STATUS=$(echo "${RESULT}" | jq -r '.status // "unknown"')

          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED}" >> $GITHUB_OUTPUT
          echo "warnings=${WARNINGS}" >> $GITHUB_OUTPUT
          echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
          echo "status=${STATUS}" >> $GITHUB_OUTPUT

          # Summary
          echo "## Governance Policy Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Checks | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${PASSED} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${FAILED} |" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | ${WARNINGS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${STATUS} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${FAILED}" -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Validations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the following policy files before merging." >> $GITHUB_STEP_SUMMARY
          fi

          # Exit with validation status
          exit ${EXIT_CODE:-0}

      - name: Log to Audit Trail
        if: always()
        run: |
          # Determine status based on validation results
          FAILED="${{ steps.validate.outputs.failed }}"
          WARNINGS="${{ steps.validate.outputs.warnings }}"

          if [[ "${FAILED}" -gt 0 ]]; then
            STATUS="failure"
            MESSAGE="${FAILED} policy validation failure(s)"
          elif [[ "${WARNINGS}" -gt 0 ]]; then
            STATUS="warning"
            MESSAGE="${WARNINGS} policy validation warning(s)"
          else
            STATUS="success"
            MESSAGE="All ${{ steps.validate.outputs.passed }} policies valid"
          fi

          # Log to audit trail
          ./scripts/release/update_governance_audit_log.sh \
            --event-type validation \
            --status "${STATUS}" \
            --message "${MESSAGE}" \
            --run-id "${{ github.run_id }}" \
            --metadata "{\"total\": ${{ steps.validate.outputs.total }}, \"passed\": ${{ steps.validate.outputs.passed }}, \"failed\": ${FAILED}, \"warnings\": ${WARNINGS}}" \
            || echo "::warning::Failed to update audit log"

      - name: Upload Validation Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
          name: governance-validation-report-${{ github.run_number }}
          path: validation_report.json
          retention-days: 30

      - name: PR Comment on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
          script: |
            const fs = require('fs');
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('validation_report.json', 'utf8'));
            } catch (e) {
              report = { status: 'error', summary: { failed: 'unknown' } };
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ❌ Governance Policy Validation Failed

            The governance policy validation found issues that must be resolved before merging.

            | Metric | Value |
            |--------|-------|
            | Failed | ${report.summary?.failed || 'unknown'} |
            | Warnings | ${report.summary?.warnings || 'unknown'} |

            Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.

            ### Common Issues

            - **Invalid YAML syntax**: Check for indentation and special character issues
            - **Missing required fields**: Ensure all required fields are present
            - **Invalid JSON syntax**: Verify JSON files are valid

            ---
            *This comment was automatically generated by the governance policy validation workflow.*`
            });

      - name: Success Badge
        if: success()
        run: |
          echo "## ✅ All Governance Policies Valid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All ${{ steps.validate.outputs.passed }} policy validations passed." >> $GITHUB_STEP_SUMMARY
