name: nightly-cve-scan
on:
  schedule:
    - cron: '0 2 * * *'
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm

      - uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate SBOM
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Run CVE scan
        run: pnpm audit --json > audit-nightly.json || true

      - name: Generate vulnerability report
        run: node .github/scripts/audit-gate.js audit-nightly.json --record-only
        env:
          SERVICE_NAME: nightly-cve-scan
          VULN_REPORT_DIR: ${{ runner.temp }}
          VULN_REPORT_FILE: vuln_report.nightly-cve-scan.json
          WAIVER_ROOT: security/waivers
          AUDIT_EXIT_CODE: 0

      - name: Run CycloneDX cdxgen
        run: npx @cyclonedx/cdxgen -o cdx-report.json --fail-on critical || true

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-cve-scan-artifacts
          path: |
            sbom.json
            cdx-report.json
            audit-nightly.json
            ${{ runner.temp }}/vuln_report.nightly-cve-scan.json
            ${{ runner.temp }}/waiver.nightly-cve-scan.yml
            ${{ runner.temp }}/audit-trail.nightly-cve-scan.log
          if-no-files-found: ignore
