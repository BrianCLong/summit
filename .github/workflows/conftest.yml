name: Policy Gate
on: [pull_request]
jobs:
  opa:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Render Helm (stage) & policy test
        run: |
          helm dependency update infra/helm/intelgraph
          helm template intelgraph infra/helm/intelgraph -f infra/helm/intelgraph/values-stage.yaml > stage.yaml
          conftest test stage.yaml --policy policies/opa
      - name: Render Helm (prod) & policy test
        run: |
          helm template intelgraph infra/helm/intelgraph -f infra/helm/intelgraph/values-prod.yaml > prod.yaml
          conftest test prod.yaml --policy policies/opa