name: SOC Compliance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  soc-controls:
    name: SOC Control Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/workflows/_reusable-node-pnpm-setup.yml
        with:
          node-version: 18

      - name: Run SOC Control Tests
        run: |
          pnpm --filter intelgraph-server test -- server/tests/soc-controls/soc-controls.test.ts --reporters=default --reporters=jest-junit
        env:
          JEST_JUNIT_OUTPUT_DIR: soc-compliance-reports
          JEST_JUNIT_OUTPUT_NAME: soc-results.xml
          NODE_OPTIONS: --experimental-vm-modules

      - name: Archive SOC Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: soc-compliance-evidence
          path: soc-compliance-reports/
