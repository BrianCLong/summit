name: migrations_gate

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN:
        required: false

permissions:
  contents: read
  pull-requests: read

jobs:
  migrations_gate:
    name: migrations_gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce migration gate label
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('Not a pull request; skipping migration gate enforcement.');
              return;
            }
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });
            const migrationTouched = files.some(file => file.filename.match(/migrations\//i) || file.filename.match(/prisma\//i) || file.filename.match(/db\//i));
            if (!migrationTouched) {
              core.info('No migration or schema changes found.');
              return;
            }
            const labels = await github.paginate(github.rest.issues.listLabelsOnIssue, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              per_page: 100,
            });
            const labelNames = labels.map(label => label.name.toLowerCase());
            if (!labelNames.includes('migration-gate')) {
              core.setFailed('Detected migration/schema changes without required `migration-gate` label.');
            } else {
              core.info('Migration gate label present.');
            }

      - name: Backward/forward compatibility smoke
        if: ${{ success() }}
        run: |
          echo "Skipping real DB compatibility checks; ensure forward/backward coverage in migrations." > migration-gate-summary.txt
          cat migration-gate-summary.txt

      - name: Upload migration gate summary
        uses: actions/upload-artifact@v4
        with:
          name: migration-gate-summary
          path: migration-gate-summary.txt
          retention-days: 7
