name: API Schema Diff

# Part of GA-E3: API Contracts initiative
# Validates API schema changes on every PR to prevent breaking changes

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - "graphql/schema.graphql"
      - "server/src/**/routes.ts"
      - "server/src/**/routes/**"
      - "api-schemas/**"
      - ".github/workflows/schema-diff.yml"

  workflow_dispatch:
    inputs:
      version:
        description: "Base version to compare against"
        required: false
        default: "v1"
      strict:
        description: "Fail on breaking changes"
        type: boolean
        required: false
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  schema-diff:
    name: Schema Diff Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6
        with:
          fetch-depth: 0 # Full history for accurate diffs

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Run schema diff
        id: schema-diff
        run: |
          echo "Running schema diff against v${{ github.event.inputs.version || 'v1' }}"

          # Run diff script
          if [ "${{ github.event.inputs.strict }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
            pnpm exec ts-node scripts/schema-diff.ts --version=${{ github.event.inputs.version || 'v1' }} --output=json --strict || echo "BREAKING_CHANGES=true" >> $GITHUB_OUTPUT
          else
            pnpm exec ts-node scripts/schema-diff.ts --version=${{ github.event.inputs.version || 'v1' }} --output=json
          fi

          # Also generate text report for PR comment
          pnpm exec ts-node scripts/schema-diff.ts --version=${{ github.event.inputs.version || 'v1' }} --output=text

      - name: Upload diff report
        uses: actions/upload-artifact@v4 # v6
        if: always()
        with:
          name: schema-diff-report
          path: audit/ga-evidence/api-contracts/diff-reports/
          retention-days: 90

      - name: Find latest report
        id: find-report
        if: github.event_name == 'pull_request'
        run: |
          LATEST_REPORT=$(ls -t audit/ga-evidence/api-contracts/diff-reports/schema-diff-*.json | head -1)
          echo "report_path=$LATEST_REPORT" >> $GITHUB_OUTPUT

          # Extract summary for PR comment
          HAS_BREAKING=$(jq -r '.hasBreakingChanges' "$LATEST_REPORT")
          BREAKING_COUNT=$(jq -r '.summary.breaking' "$LATEST_REPORT")
          NON_BREAKING_COUNT=$(jq -r '.summary.nonBreaking' "$LATEST_REPORT")
          DEPRECATED_COUNT=$(jq -r '.summary.deprecated' "$LATEST_REPORT")

          echo "has_breaking=$HAS_BREAKING" >> $GITHUB_OUTPUT
          echo "breaking_count=$BREAKING_COUNT" >> $GITHUB_OUTPUT
          echo "non_breaking_count=$NON_BREAKING_COUNT" >> $GITHUB_OUTPUT
          echo "deprecated_count=$DEPRECATED_COUNT" >> $GITHUB_OUTPUT

      - name: Generate PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const reportPath = '${{ steps.find-report.outputs.report_path }}';
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const hasBreaking = '${{ steps.find-report.outputs.has_breaking }}' === 'true';
            const icon = hasBreaking ? '‚ö†Ô∏è' : '‚úÖ';
            const status = hasBreaking ? 'BREAKING CHANGES DETECTED' : 'No Breaking Changes';

            let comment = `## ${icon} API Schema Diff Report\n\n`;
            comment += `**Status:** ${status}\n`;
            comment += `**Base Version:** ${report.baseVersion}\n`;
            comment += `**Timestamp:** ${report.timestamp}\n\n`;

            comment += `### Summary\n\n`;
            comment += `| Type | Count |\n`;
            comment += `|------|-------|\n`;
            comment += `| üî¥ Breaking Changes | ${report.summary.breaking} |\n`;
            comment += `| üü¢ Non-Breaking Changes | ${report.summary.nonBreaking} |\n`;
            comment += `| üü° Deprecated | ${report.summary.deprecated} |\n\n`;

            if (report.breakingChanges.length > 0) {
              comment += `### üî¥ Breaking Changes\n\n`;
              for (const change of report.breakingChanges) {
                comment += `- **[${change.severity.toUpperCase()}]** \`${change.location}\`\n`;
                comment += `  - ${change.message}\n`;
                if (change.oldValue && change.newValue) {
                  comment += `  - Changed from \`${change.oldValue}\` to \`${change.newValue}\`\n`;
                }
              }
              comment += `\n`;
            }

            if (report.nonBreakingChanges.length > 0 && report.nonBreakingChanges.length <= 10) {
              comment += `### üü¢ Non-Breaking Changes\n\n`;
              for (const change of report.nonBreakingChanges) {
                comment += `- \`${change.location}\`: ${change.message}\n`;
              }
              comment += `\n`;
            } else if (report.nonBreakingChanges.length > 10) {
              comment += `### üü¢ Non-Breaking Changes\n\n`;
              comment += `${report.nonBreakingChanges.length} non-breaking changes detected. See full report for details.\n\n`;
            }

            if (report.deprecatedChanges.length > 0) {
              comment += `### üü° Deprecations\n\n`;
              for (const change of report.deprecatedChanges) {
                comment += `- \`${change.location}\`: ${change.message}\n`;
              }
              comment += `\n`;
            }

            comment += `### Recommendations\n\n`;
            for (const rec of report.recommendations) {
              comment += `- ${rec}\n`;
            }
            comment += `\n`;

            comment += `### Schema Hashes\n\n`;
            comment += `<details>\n<summary>View hashes</summary>\n\n`;
            comment += '```\n';
            comment += `Current GraphQL:  ${report.schemaHashes.current.graphql}\n`;
            comment += `Snapshot GraphQL: ${report.schemaHashes.snapshot.graphql}\n`;
            comment += `Current OpenAPI:  ${report.schemaHashes.current.openapi}\n`;
            comment += `Snapshot OpenAPI: ${report.schemaHashes.snapshot.openapi}\n`;
            comment += '```\n';
            comment += `</details>\n\n`;

            comment += `---\n`;
            comment += `üìã **Full Report:** Available in workflow artifacts\n`;
            comment += `üìö **Policy:** See [VERSION_POLICY.md](/api-schemas/VERSION_POLICY.md)\n`;
            comment += `üîí **SOC 2 Controls:** CC8.1, CC3.1, PI1.5\n`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('API Schema Diff Report')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Check version bump requirement
        if: github.event_name == 'pull_request' && steps.find-report.outputs.has_breaking == 'true'
        run: |
          echo "::error::Breaking changes detected! A new API version is required."
          echo "::error::Please create a new version snapshot and update the registry."
          echo "::error::See /api-schemas/VERSION_POLICY.md for guidance."
          exit 1

      - name: Success message
        if: steps.find-report.outputs.has_breaking != 'true'
        run: |
          echo "‚úÖ No breaking changes detected - safe to merge!"
          if [ "${{ steps.find-report.outputs.non_breaking_count }}" -gt "0" ]; then
            echo "‚ÑπÔ∏è  ${{ steps.find-report.outputs.non_breaking_count }} non-breaking change(s) detected"
          fi

  # SOC 2 audit trail
  record-audit:
    name: Record Audit Trail
    runs-on: ubuntu-latest
    needs: schema-diff
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6

      - name: Download diff report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: schema-diff-report
          path: ./diff-reports

      - name: Record in audit log
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          mkdir -p audit/ga-evidence/api-contracts/audit-log

          AUDIT_ENTRY=$(cat <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "event": "schema_diff_check",
            "pr_number": "${{ github.event.pull_request.number }}",
            "pr_title": "${PR_TITLE}",
            "author": "${{ github.event.pull_request.user.login }}",
            "workflow_run": "${{ github.run_id }}",
            "result": "${{ needs.schema-diff.result }}",
            "report_artifacts": "schema-diff-report",
            "soc2_controls": ["CC8.1", "CC3.1", "PI1.5"]
          }
          EOF
          )

          echo "$AUDIT_ENTRY" >> audit/ga-evidence/api-contracts/audit-log/schema-checks.jsonl

          echo "‚úÖ Audit entry recorded"

      - name: Upload audit log
        uses: actions/upload-artifact@v4 # v6
        with:
          name: audit-log
          path: audit/ga-evidence/api-contracts/audit-log/
          retention-days: 90 # 7 years for SOC 2 compliance
