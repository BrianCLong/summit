name: CD Deploy

on:
  workflow_run:
    workflows: ['CI Image']
    types:
      - completed

jobs:
  deploy-dev:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: https://dev.intelgraph.com # Placeholder
    steps:
      - name: Checkout code
        uses: actions/checkout@c9ef52556095b32f140b0c7d74474f53696d9000

      - name: Login to GHCR
        uses: docker/login-action@184bdaa
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Dev
        uses: appleboy/ssh-action@029f5b4
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -euo pipefail
            echo "Logging into registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            echo "Pulling services..."
            docker compose -f /opt/intelgraph/docker-compose.yml pull server client
            echo "Recreating services..."
            docker compose -f /opt/intelgraph/docker-compose.yml up -d server client
            echo "Pruning unused images..."
            docker image prune -f
            echo "Running database migrations..."
            node /opt/intelgraph/server/scripts/db_migrate.js
            echo "Database migrations completed."
