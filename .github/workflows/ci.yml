name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  soc-compliance:
    name: SOC Controls
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: "9.12.0"
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      - name: Run compliance checks
        run: ./scripts/compliance/check_soc.sh

  server-typecheck:
    name: Server TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: "9.12.0"
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run server typecheck
        run: |
          mkdir -p artifacts
          node scripts/ci/server_typecheck_report.mjs --output artifacts/server-typecheck-report.json

          # Display summary
          echo "=== Report Summary ==="
          cat artifacts/server-typecheck-report.json | jq '{errorCount, fileCount}'
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-typecheck-report-${{ github.run_id }}
          path: |
            artifacts/server-typecheck-report.json
            typecheck-output.txt
          retention-days: 30
      - name: Check status
        if: always()
        run: |
          STATUS=""

          if [[ "$STATUS" == "success" ]]; then
            echo "### Server TypeScript Check PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No type errors detected in server codebase." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Server TypeScript Check FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Type errors detected. See artifact \`server-typecheck-report-${{ github.run_id }}\` for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Error Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            if [ -f typecheck-output.txt ]; then
              cat typecheck-output.txt | head -50 >> $GITHUB_STEP_SUMMARY
            else
              echo "No output file found." >> $GITHUB_STEP_SUMMARY
            fi
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Report: \`artifacts/server-typecheck-report.json\`_" >> $GITHUB_STEP_SUMMARY

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: "9.12.0"
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: "9.12.0"
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm test
