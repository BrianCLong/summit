name: CI

on:
  pull_request:
  push:
    branches: [main]

# default per-run guard; the tuner can override via outputs
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  plan:
    name: Plan CI (learn from history)
    runs-on: ubuntu-latest
    outputs:
      node_matrix: ${{ steps.plan.outputs.node_matrix }}
      max_parallel: ${{ steps.plan.outputs.max_parallel }}
      cache_level: ${{ steps.plan.outputs.cache_level }}
      test_shard: ${{ steps.plan.outputs.test_shard }}
      changed_pkgs: ${{ steps.plan.outputs.changed_pkgs }}
      needs_graph: ${{ steps.plan.outputs.needs_graph }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Restore tuner memory
        uses: actions/cache@v4
        with:
          path: .ci/state
          key: tuner-${{ github.repository }}-${{ github.ref_name }}
          restore-keys: |
            tuner-${{ github.repository }}-
      - name: Analyze
        id: plan
        run: node .ci/tuner/plan.js

  install:
    name: Install (adaptive cache)
    needs: plan
    runs-on: ubuntu-latest
    strategy:
      max-parallel: ${{ fromJson(needs.plan.outputs.max_parallel) }}
      matrix:
        node: ${{ fromJson(needs.plan.outputs.node_matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - name: PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Cache deps (multi-tier)
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ matrix.node }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ needs.plan.outputs.cache_level }}
          restore-keys: |
            pnpm-${{ runner.os }}-${{ matrix.node }}-${{ hashFiles('**/pnpm-lock.yaml') }}-
            pnpm-${{ runner.os }}-${{ matrix.node }}-
            pnpm-${{ runner.os }}-
      - run: pnpm install --frozen-lockfile

  build:
    name: Build (targeted)
    needs: [plan, install]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build impacted only
        env:
          CHANGED_PKGS: ${{ needs.plan.outputs.changed_pkgs }}
        run: |
          pnpm -w turbo run build --filter "${CHANGED_PKGS:-...}" --cache-dir .ci/turbo

  test:
    name: Test (sharded & ordered)
    needs: [plan, build]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: ${{ fromJson(needs.plan.outputs.max_parallel) }}
      matrix:
        shard: ${{ fromJson(needs.plan.outputs.test_shard) }}
    steps:
      - uses: actions/checkout@v4
      - name: Run shard
        run: pnpm -w turbo run test -- --shard=${{ matrix.shard.index }}/${{ matrix.shard.total }}

  finalize:
    name: Finalize (write memory)
    needs: [install, build, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Summarize run & update memory
        run: node .ci/tuner/finalize.js
      - name: Save tuner memory
        uses: actions/cache/save@v4
        if: always()
        with:
          path: .ci/state
          key: tuner-${{ github.repository }}-${{ github.run_id }}
