name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  unit:
    uses: ./.github/workflows/reusable/unit.yml
  contract:
    uses: ./.github/workflows/reusable/contract.yml
  package:
    uses: ./.github/workflows/reusable/package.yml
  e2e:
    needs: [package]
    uses: ./.github/workflows/reusable/e2e.yml
  sast_sca:
    uses: ./.github/workflows/reusable/sast_sca.yml
  sbom:
    uses: ./.github/workflows/reusable/sbom.yml
  iac_plan:
    uses: ./.github/workflows/reusable/iac_plan.yml
  policy_opa:
    uses: ./.github/workflows/reusable/policy_opa.yml
  migrations_gate:
    uses: ./.github/workflows/reusable/migrations_gate.yml
  preview_deploy:
    needs: [unit, contract, e2e, sast_sca, sbom, iac_plan, policy_opa, migrations_gate]
    uses: ./.github/workflows/reusable/preview_deploy.yml
  attestation:
    needs: [preview_deploy]
    uses: ./.github/workflows/reusable/attestation.yml
