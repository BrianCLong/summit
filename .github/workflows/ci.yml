name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm format:check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - name: Check CJS files use CommonJS syntax
        run: pnpm lint:cjs
      - run: cd server && npx tsx scripts/check-error-codes-doc.ts

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck

  verify:
    name: Verification Suite
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run verification suite
        run: pnpm verify
      - name: Upload verification results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: verification-results
          path: |
            server/scripts/verify-*.log
          retention-days: 7

  test:
    name: Test (${{ matrix.test-suite }})
    needs: [lint, verify]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-suite: [unit, integration]
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run tests (deterministic TZ)
        run: pnpm test:${{ matrix.test-suite }}
        env:
          TZ: UTC
      - name: Run API authz e2e tests
        if: matrix.test-suite == 'integration'
        run: pnpm --filter @intelgraph/api test

  golden-path:
    name: Golden Path
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: make bootstrap
      - run: make up
      - run: make smoke
      - run: make down
        if: always()

  reproducible-build:
    name: Reproducible Build
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Build twice for deterministic output
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH=$(git log -1 --pretty=format:%ct)

          pnpm run build
          find client/dist server/dist -type f -print0 | sort -z | xargs -0 sha256sum > build-checksums-a.txt
          rm -rf client/dist server/dist

          pnpm run build
          find client/dist server/dist -type f -print0 | sort -z | xargs -0 sha256sum > build-checksums-b.txt

          if ! diff -u build-checksums-a.txt build-checksums-b.txt; then
            echo "::error::Build outputs are not deterministic between runs - CI BLOCKED"
            exit 1
          fi

  governance:
    name: Governance
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: npm run check:governance
      - run: npm test -- --testPathPattern="governance" --bail
      - name: Execute Governance Audit (Control the Arena)
        run: npx tsx scripts/governance/audit_ci.ts

  provenance:
    name: Provenance
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: npm test -- --testPathPattern="provenance" --bail

  schema-diff:
    name: Schema Diff
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Need full history for git diff references
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: npm run graphql:schema:check

  ecosystem-exports:
    name: Ecosystem Export Verification
    needs: test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:latest-pg14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: summit_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run database migrations
        run: |
          cd server
          npx tsx scripts/run-migrations.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/summit_test
      - name: Verify export schema conformance
        run: npm test -- test/verification/integrations.node.test.ts --bail
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/summit_test
      - name: Dry-run transparency report generation
        run: |
          cd scripts
          npx tsx generate-transparency-report.ts \
            --tenant 00000000-0000-0000-0000-000000000001 \
            --start $(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ) \
            --end $(date -u +%Y-%m-%dT%H:%M:%SZ) \
            --format json \
            --output /tmp/transparency-report-test.json
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/summit_test

  security:
    name: Security
    needs: golden-path
    uses: ./.github/workflows/ci-security.yml
    secrets:
      snyk_token: ${{ secrets.SNYK_TOKEN }}

  ga-risk-gate:
    name: GA Risk Gate
    needs: [lint] # Run early to fail fast
    uses: ./.github/workflows/ga-risk-gate.yml
    with:
      ref: ${{ github.sha }}
    secrets: inherit

  build-server-image:
    name: Build Server Image (Governance)
    needs: test
    uses: ./.github/workflows/reusable-golden-path.yml
    with:
      service_path: server
      image_name: intelgraph-server
    secrets: inherit

  observability:
    name: Observability
    needs: [security, reproducible-build, build-server-image]
    runs-on: ubuntu-latest
    steps:
      - name: Emit metrics
        run: echo "Emitting workflow metrics..."

  ga_gate:
    name: ga / gate
    if: ${{ always() }}
    needs:
      - format-check
      - lint
      - typecheck
      - verify
      - test
      - governance
      - provenance
      - schema-diff
      - reproducible-build
      - golden-path
    runs-on: ubuntu-latest
    steps:
      - name: Summarize GA gate dependencies
        env:
          FORMAT_CHECK_RESULT: ${{ needs['format-check'].result }}
          LINT_RESULT: ${{ needs.lint.result }}
          TYPECHECK_RESULT: ${{ needs.typecheck.result }}
          VERIFY_RESULT: ${{ needs.verify.result }}
          TEST_RESULT: ${{ needs.test.result }}
          GOVERNANCE_RESULT: ${{ needs.governance.result }}
          PROVENANCE_RESULT: ${{ needs.provenance.result }}
          SCHEMA_DIFF_RESULT: ${{ needs['schema-diff'].result }}
          REPRODUCIBLE_BUILD_RESULT: ${{ needs['reproducible-build'].result }}
          GOLDEN_PATH_RESULT: ${{ needs['golden-path'].result }}
        run: |
          set -euo pipefail
          checks=(
            "Format Check|${FORMAT_CHECK_RESULT:-missing}"
            "Lint|${LINT_RESULT:-missing}"
            "Typecheck|${TYPECHECK_RESULT:-missing}"
            "Verification Suite|${VERIFY_RESULT:-missing}"
            "Tests (unit + integration)|${TEST_RESULT:-missing}"
            "Governance|${GOVERNANCE_RESULT:-missing}"
            "Provenance|${PROVENANCE_RESULT:-missing}"
            "Schema Diff|${SCHEMA_DIFF_RESULT:-missing}"
            "Reproducible Build|${REPRODUCIBLE_BUILD_RESULT:-missing}"
            "Golden Path|${GOLDEN_PATH_RESULT:-missing}"
          )

          {
            echo "## GA Gate Dependency Results"
            echo ""
            echo "| Check | Result |"
            echo "| --- | --- |"
          } >> "$GITHUB_STEP_SUMMARY"

          failure=0
          for entry in "${checks[@]}"; do
            name="${entry%%|*}"
            result="${entry#*|}"
            echo "| ${name} | ${result} |" >> "$GITHUB_STEP_SUMMARY"
            if [[ "${result}" != "success" ]]; then
              failure=1
            fi
          done

          if [[ "${failure}" -ne 0 ]]; then
            echo "::error::ga / gate blocked: one or more required checks failed or were missing"
            exit 1
          fi
