name: CI Pipeline - Pull Request Validation

on:
  pull_request:
    branches: [main, 'release/*']
    paths-ignore: ['docs/**', '*.md']
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read
  security-events: write

env:
  REGISTRY: ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}
  NODE_VERSION: '20.11.1'
  PNPM_VERSION: '9.12.0'
jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      charts: ${{ steps.changes.outputs.charts }}
      terraform: ${{ steps.changes.outputs.terraform }}
      policies: ${{ steps.changes.outputs.policies }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          services:
            - 'services/**'
            - 'server/**'
            - 'client/**'
            - 'packages/**'
            - 'maestro/**'
            - 'package.json'
            - 'pnpm-lock.yaml'
          charts:
            - 'charts/**'
            - 'k8s/**'
          terraform:
            - 'terraform/**'
            - '*.tf'
          policies:
            - 'policy/**'

  build:
    name: Build & Quality Gates
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          check-latest: true
          cache: 'pnpm'
      - uses: pnpm/action-setup@v4
        with: { version: 9.12.0 }
      - run: pnpm install --frozen-lockfile

      - name: Verify pipeline digests
        run: |
          sha256sum --check .ci/maestro-digests.lock

      - name: typecheck
        run: pnpm run typecheck

      - name: lint
        run: pnpm run lint

      - name: Lint + Typecheck + Unit (changed only)
        run: pnpm dlx turbo run lint typecheck test --filter=...[HEAD^1] --cache-dir .turbo

      - name: Coverage enforcement (80% lines, 75% branches)
        run: |
          echo "ðŸ“Š Enforcing repo-wide coverage thresholds..."
          npm run coverage:enforce

      - name: Integration tests (docker-compose)
        run: npm run itest

      - name: TS Error Histogram
        run: |
          mkdir -p .artifacts
          pnpm run typecheck 2>&1 | tee .artifacts/tsc.log || true
          echo "## TypeScript Error Analysis" > .artifacts/ts-report.md
          echo "Generated at: $(date)" >> .artifacts/ts-report.md
          echo "" >> .artifacts/ts-report.md
          echo "### Top Error Codes" >> .artifacts/ts-report.md
          echo '```' >> .artifacts/ts-report.md
          grep -oE 'TS[0-9]{3,4}' .artifacts/tsc.log | sort | uniq -c | sort -nr | head -20 | tee .artifacts/tsc-top.txt >> .artifacts/ts-report.md
          echo '```' >> .artifacts/ts-report.md
          echo "" >> .artifacts/ts-report.md
          echo "### Total Errors: $(grep -c 'error TS' .artifacts/tsc.log || echo '0')" >> .artifacts/ts-report.md

      - name: sbom
        run: pnpm run sbom

      - name: sast
        run: pnpm run sast

      - name: e2e
        run: pnpm run e2e

      - name: otel:smoke
        run: pnpm run otel:smoke

      - name: helm:template
        run: |
          if [ -d "deploy/helm" ]; then
            echo "ðŸš¢ Running Helm template validation..."
            helm template deploy/helm/intelgraph --values deploy/helm/intelgraph/values.yaml --dry-run
          else
            echo "â„¹ï¸  No Helm charts found - skipping"
          fi

      - name: terraform:plan
        run: |
          if [ -d "terraform" ]; then
            echo "ðŸ—ï¸  Running Terraform plan..."
            cd terraform && terraform init -input=false && terraform plan -input=false
          else
            echo "â„¹ï¸  No Terraform found - skipping"
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-artifacts-${{ github.sha }}
          path: |
            .artifacts/
            **/junit*.xml
            **/playwright-report/**
            **/coverage/**
            coverage-junit.xml
            k6-summary.json
            test-results/**

  policy-validation:
    name: Policy-as-Code Validation
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: |
      needs.changes.outputs.services == 'true' ||
      needs.changes.outputs.charts == 'true' ||
      needs.changes.outputs.terraform == 'true' ||
      needs.changes.outputs.policies == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Conftest
      run: |
        curl -L -o conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
        tar xzf conftest.tar.gz
        sudo mv conftest /usr/local/bin/conftest
        conftest --version

    - name: Setup OPA
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
        chmod +x opa
        sudo mv opa /usr/local/bin/
        opa version

    - name: Validate policy bundle
      run: |
        set -euo pipefail
        if [ ! -d "policy" ]; then
          echo "âŒ policy/ directory is required for validation" >&2
          exit 1
        fi

        echo "ðŸ” Validating policy bundle..."
        NEEDS_FMT=$(opa fmt --list policy/ || true)
        if [ -n "$NEEDS_FMT" ]; then
          echo "âŒ Policy files require formatting:" >&2
          echo "$NEEDS_FMT" >&2
          exit 1
        fi

    - name: Run Rego unit tests with coverage
      run: |
        set -euo pipefail
        if [ ! -d "policies/opa" ]; then
          echo "âŒ policies/opa directory is required for validation" >&2
          exit 1
        fi

        NEEDS_FMT=$(opa fmt --list policies/opa || true)
        if [ -n "$NEEDS_FMT" ]; then
          echo "âŒ policies/opa files require formatting:" >&2
          echo "$NEEDS_FMT" >&2
          exit 1
        fi
        opa test policy/ policies/opa --timeout 60s --coverage | tee opa-coverage.txt

    - name: Run Dockerfile policy checks
      run: |
        set -euo pipefail
        echo "ðŸ³ Running Dockerfile policy checks..."
        DOCKERFILES=$(find . -name "Dockerfile*" -type f || echo "")

        if [ -z "$DOCKERFILES" ]; then
          echo "â„¹ï¸ No Dockerfiles found"
          exit 0
        fi

        for dockerfile in $DOCKERFILES; do
          echo "Checking $dockerfile..."
          conftest verify --policy policy/ "$dockerfile"
        done

    - name: Upload policy artifacts
      uses: actions/upload-artifact@v4
      with:
        name: policy-report-${{ github.sha }}
        path: |
          policy/
          policies/
          opa-coverage.txt

  security-scanning:
    name: Security & Supply Chain Scanning
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: needs.changes.outputs.services == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy

    - name: Setup Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: Scan repository for vulnerabilities
      run: |
        set -euo pipefail
        echo "ðŸ” Scanning repository for vulnerabilities..."
        trivy fs . --format json --severity CRITICAL,HIGH --ignore-unfixed --output trivy-repo-scan.json || true

        CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-repo-scan.json 2>/dev/null || echo "0")
        HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-repo-scan.json 2>/dev/null || echo "0")

        echo "ðŸ“Š Vulnerability scan results:"
        echo "  Critical: $CRITICAL"
        echo "  High: $HIGH"

        THRESHOLD="${{ vars.VULN_SEVERITY_THRESHOLD || 'high' }}"
        if [ "$THRESHOLD" = "critical" ]; then
          if [ "$CRITICAL" -gt 0 ]; then
            echo "ðŸš¨ Critical vulnerabilities found - failing build"
            exit 1
          fi
        else
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "ðŸš¨ High or critical vulnerabilities found - failing build"
            exit 1
          fi
        fi

    - name: Generate SBOM
      run: |
        echo "ðŸ“‹ Generating Software Bill of Materials..."
        syft . -o spdx-json=sbom.spdx.json

        if [ -f "sbom.spdx.json" ]; then
          COMPONENTS=$(jq '.packages | length' sbom.spdx.json)
          echo "âœ… SBOM generated with $COMPONENTS components"
        fi

    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-artifacts-${{ github.sha }}
        path: |
          trivy-repo-scan.json
          sbom.spdx.json

  cost-guard:
    name: CI Cost Guard
    runs-on: ubuntu-latest
    needs: [build, policy-validation, security-scanning]
    if: always()
    steps:
    - name: Calculate and check CI costs
      run: |
        # Calculate CI duration and cost estimate
        CI_DURATION_SECONDS=$(( $(date +%s) - $(date -d "${{ github.event.pull_request.created_at || github.run_started_at }}" +%s) ))
        CI_COST_ESTIMATE=$(echo "scale=4; $CI_DURATION_SECONDS * 0.008 / 60" | bc -l || echo "0.1")

        echo "ðŸ“Š CI Cost Analysis:"
        echo "  Duration: ${CI_DURATION_SECONDS}s"
        echo "  Estimated Cost: \$${CI_COST_ESTIMATE}"

        # Mock monthly calculation
        DAILY_RUNS=50
        MONTHLY_COST=$(echo "scale=2; $DAILY_RUNS * $CI_COST_ESTIMATE * 30" | bc -l || echo "150")
        DEV_BUDGET=1000
        BURN_RATE=$(echo "scale=1; $MONTHLY_COST / $DEV_BUDGET * 100" | bc -l || echo "15")

        echo "  Projected Monthly: \$${MONTHLY_COST}"
        echo "  Budget Burn Rate: ${BURN_RATE}%"

        if (( $(echo "$BURN_RATE > 80" | bc -l 2>/dev/null || echo "0") )); then
          echo "ðŸš¨ CI cost burn rate exceeds 80% threshold!"
        else
          echo "âœ… CI costs within budget"
        fi

    - name: Emit OpenTelemetry metrics
      if: vars.OTEL_ENDPOINT
      run: |
        CI_DURATION=$(( $(date +%s) - $(date -d "${{ github.run_started_at }}" +%s) ))

        # Emit to OTel endpoint if configured
        curl -X POST "${{ vars.OTEL_ENDPOINT }}/v1/metrics" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.OTEL_TOKEN }}" \
          -d '{
            "resourceMetrics": [{
              "resource": {
                "attributes": [
                  {"key": "service.name", "value": {"stringValue": "intelgraph-ci"}},
                  {"key": "ci.provider", "value": {"stringValue": "github-actions"}},
                  {"key": "repository", "value": {"stringValue": "${{ github.repository }}"}}
                ]
              },
              "scopeMetrics": [{
                "metrics": [
                  {
                    "name": "ci_duration_seconds",
                    "gauge": {"dataPoints": [{"asDouble": '$CI_DURATION', "timeUnixNano": "'$(date +%s%N)'"}]}
                  }
                ]
              }]
            }]
          }' || echo "âš ï¸ Failed to emit OTel metrics"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [changes, build, policy-validation, security-scanning, cost-guard]
    if: always()
    steps:
    - name: Generate CI summary
      run: |
        echo "## ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Validation**: ${{ needs.pr-validate.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Policy Validation**: ${{ needs.policy-validation.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scanning**: ${{ needs.security-scanning.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cost Guard**: ${{ needs.cost-guard.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Artifacts**: Check the Actions tab for security scan results and SBOM" >> $GITHUB_STEP_SUMMARY
