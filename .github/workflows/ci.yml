name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

env:
  PNPM_CACHE_FOLDER: ~/.pnpm-store
  NODE_VERSION: '20.x'

permissions:
  contents: read
  security-events: write

jobs:
  build-test:
    uses: ./.github/workflows/reusable/build-test.yml
    with:
      node_version: '20.x'
      pnpm_cache_folder: ~/.pnpm-store

  security:
    needs: [build-test]
    uses: ./.github/workflows/reusable/security.yml
    with:
      node_version: '20.x'

  smoke:
    needs: [build-test]
    uses: ./.github/workflows/reusable/smoke.yml
    with:
      node_version: '20.x'
      pnpm_cache_folder: ~/.pnpm-store

  migration-gate:
    uses: ./.github/workflows/reusable/migration.yml
