name: ci

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  format-check:
    name: format-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm format:check

  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - name: Check CJS files use CommonJS syntax
        run: pnpm lint:cjs
      - run: cd server && npx tsx scripts/check-error-codes-doc.ts

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck

  verify:
    name: verification
    needs: [lint, typecheck]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run verification suite
        run: pnpm verify
      - name: Upload verification results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: verification-results
          path: |
            server/scripts/verify-*.log
          retention-days: 7

  test-matrix:
    name: test (${{ matrix.test-suite }})
    needs: [lint, typecheck, verify]
    runs-on: ubuntu-latest
    # Both unit and integration tests are non-blocking until TypeScript/ESM issues are resolved
    # EXPIRY: 2026-01-15 - Must fix underlying TypeScript errors in test files
    # TICKET: See docs/release/GA_DECISIONS.md for follow-up plan
    continue-on-error: true
    strategy:
      matrix:
        test-suite: [unit, integration]
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run tests (deterministic TZ)
        run: pnpm test:${{ matrix.test-suite }}
        env:
          TZ: UTC
      - name: Run API authz e2e tests
        if: matrix.test-suite == 'integration'
        run: pnpm --filter @intelgraph/api test

  test:
    name: test
    needs: [test-matrix]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate matrix result
        run: |
          echo "=== Test Matrix Result ==="
          echo "Test Matrix: ${{ needs.test-matrix.result }}"
          if [[ "${{ needs.test-matrix.result }}" != "success" ]]; then
            echo "::error::Test matrix failed"
            exit 1
          fi

  smoke:
    name: smoke
    needs: [test]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: make bootstrap
      - run: make up
      - run: make smoke
      - run: make down
        if: always()

  build:
    name: build
    needs: [test]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Build twice for deterministic output
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH=$(git log -1 --pretty=format:%ct)

          pnpm run build
          find client/dist server/dist -type f -print0 | sort -z | xargs -0 sha256sum > build-checksums-a.txt
          rm -rf client/dist server/dist

          pnpm run build
          find client/dist server/dist -type f -print0 | sort -z | xargs -0 sha256sum > build-checksums-b.txt

          if ! diff -u build-checksums-a.txt build-checksums-b.txt; then
            echo "::error::Build outputs are not deterministic between runs - CI BLOCKED"
            exit 1
          fi

  governance:
    name: governance
    needs: [test]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    # Non-blocking until ESM test infrastructure is resolved
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: npm run check:governance
      - run: npm test -- --testPathPattern="governance" --bail
      - name: Execute Governance Audit (Control the Arena)
        run: npx tsx scripts/governance/audit_ci.ts

  provenance:
    name: provenance
    needs: [test]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    # Non-blocking until ESM test infrastructure is resolved
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: npm test -- --testPathPattern="provenance" --bail

  schema:
    name: schema
    needs: [test]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    # Non-blocking until graphql-inspector loader issues are resolved
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Need full history for git diff references
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: npm run graphql:schema:check

  ecosystem-exports:
    name: ecosystem-exports
    needs: [test]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:latest-pg14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: summit_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run database migrations
        run: |
          cd server
          npx tsx scripts/run-migrations.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/summit_test
      - name: Verify export schema conformance
        run: npm test -- test/verification/integrations.node.test.ts --bail
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/summit_test
      - name: Dry-run transparency report generation
        run: |
          cd scripts
          npx tsx generate-transparency-report.ts \
            --tenant 00000000-0000-0000-0000-000000000001 \
            --start $(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ) \
            --end $(date -u +%Y-%m-%dT%H:%M:%SZ) \
            --format json \
            --output /tmp/transparency-report-test.json
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/summit_test

  security:
    name: security
    needs: [smoke]
    if: ${{ always() }}
    uses: ./.github/workflows/ci-security.yml
    secrets:
      snyk_token: ${{ secrets.SNYK_TOKEN }}

  ga-risk-gate:
    name: ga-risk-gate
    needs: [lint] # Run early to fail fast
    uses: ./.github/workflows/ga-risk-gate.yml
    with:
      ref: ${{ github.sha }}
    secrets: inherit

  build-server-image:
    name: build-server-image
    needs: [test]
    if: ${{ always() }}
    uses: ./.github/workflows/reusable-golden-path.yml
    with:
      service_path: server
      image_name: intelgraph-server
    secrets: inherit

  observability:
    name: observability
    needs: [security, build, build-server-image]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Emit metrics
        run: echo "Emitting workflow metrics..."
