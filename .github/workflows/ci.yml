name: CI

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - 'LICENSE'
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - 'LICENSE'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  HUSKY: 0

permissions:
  contents: read
  security-events: write

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'apps/**'
              - 'client/**'
              - 'packages/**'
              - 'services/**'
              - 'server/**'
              - 'turbo.json'
              - 'pnpm-lock.yaml'
              - 'package.json'
              - 'tsconfig*'
            docker:
              - 'docker-compose*'
              - '**/Dockerfile*'
              - 'scripts/run-compose.sh'

  # Gate 1: Fast Quality Checks
  verify-fast:
    needs: [changes]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.core == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      # L1: Static
      - name: Lint & Typecheck
        run: pnpm turbo run lint typecheck --filter="!docs-site"

      # L2: Unit Tests (Fast)
      - name: Unit Tests
        run: pnpm test:unit

  # Gate 2: Integration & Build
  verify-integration:
    needs: [verify-fast]
    runs-on: ubuntu-latest-8-cores
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build
        run: pnpm turbo run build --filter="!docs-site"

      # L3: Integration Tests (Mocked/Containerized)
      # This runs the new integration suite we built
      - name: Integration Tests
        run: pnpm test:integration

  # Gate 3: Smoke / E2E
  verify-e2e-smoke:
    needs: [verify-integration]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.docker == 'true' }}
    runs-on: ubuntu-latest-8-cores
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}
          install: 'true'

      - name: Bootstrap & Start Stack
        run: |
          make bootstrap
          make up

      # L4: E2E Smoke (The old script + new playwright smoke if ready)
      - name: Legacy Smoke Script
        run: make smoke

      - name: Playwright E2E Smoke
        run: pnpm test:e2e:smoke
        continue-on-error: true # Allow failing for now while we build it out

      - name: Teardown
        if: always()
        run: make down

  # Reporting
  telemetry:
    needs: [verify-e2e-smoke]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report Status
        run: echo "Quality Gates Completed."

