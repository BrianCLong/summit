name: Monorepo CI Fan-out

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.filter.outputs.source }}
      contracts: ${{ steps.filter.outputs.contracts }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            source:
              - 'services/**'
              - 'apps/**'
              - 'infra/**'
              - 'scripts/**'
              - 'fixtures/**'
            contracts:
              - 'contracts/**'

  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run lint
        run: |
          echo "TODO: add lint commands per service/app"

  unit:
    name: Unit
    needs: lint
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run unit tests
        run: |
          echo "TODO: add unit test commands per service/app"

  contract-conformance:
    name: Contract conformance
    needs: unit
    if: needs.changes.outputs.contracts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate contracts
        run: |
          echo "TODO: add contract verification against published SDKs"

  docker-build:
    name: Docker build
    needs: contract-conformance
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build images
        run: |
          echo "TODO: add docker build matrix per service"

  golden-fixtures:
    name: Golden fixtures
    needs: docker-build
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate golden fixtures
        run: |
          echo "TODO: add golden fixture verification"
