name: CI

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - 'LICENSE'
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - 'LICENSE'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  HUSKY: 0 # Disable husky hooks in CI

permissions:
  contents: read
  security-events: write

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'apps/**'
              - 'client/**'
              - 'packages/**'
              - 'services/**'
              - 'server/**'
              - 'turbo.json'
              - 'pnpm-lock.yaml'
              - 'package.json'
              - 'tsconfig*'
            docker:
              - 'docker-compose*'
              - '**/Dockerfile*'
              - 'scripts/run-compose.sh'

  # Quality Lane: Lint and Typecheck (Parallelized by Turbo)
  quality:
    needs: [changes]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.core == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Code Quality Checks
        run: pnpm turbo run lint typecheck --filter="!docs-site"

      - name: Production Guardrails
        run: |
          set +e
          NODE_ENV=production \
          JWT_SECRET=weaksecret \
          JWT_REFRESH_SECRET=weaksecret2 \
          DATABASE_URL=postgresql://summit:devpassword@localhost:5432/summit_dev \
          NEO4J_URI=bolt://localhost:7687 \
          NEO4J_USERNAME=neo4j \
          NEO4J_PASSWORD=devpassword \
          REDIS_HOST=localhost \
          REDIS_PORT=6379 \
          REDIS_PASSWORD=devpassword \
          CORS_ORIGIN=* \
          pnpm ci:prod-guard
          status=$?
          if [ "$status" -eq 0 ]; then
            echo "Prod guardrails command succeeded unexpectedly"
            exit 1
          fi
          echo "Prod guardrails correctly blocked unsafe config"

  # Build Lane: Build artifacts
  build:
    needs: [changes]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.core == 'true' }}
    runs-on: ubuntu-latest-8-cores
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build Workspace
        run: pnpm turbo run build --filter="!docs-site"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist
            build
            apps/*/dist
            apps/*/build
            packages/*/dist
            services/*/dist
            server/dist
            client/dist
            .turbo
          retention-days: 1

  # Unit Tests Lane: Sharded Jest Tests
  unit-tests:
    needs: [build]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.core == 'true' }}
    runs-on: ubuntu-latest-8-cores
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Note: Jest tests run against source (ts-jest) so we don't strictly need build artifacts here.
      # This saves bandwidth.

      - name: Run Unit Tests (Shard ${{ matrix.shard }}/2)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 2
          # package.json defines "test:jest"
          command: pnpm run test:jest --shard ${{ matrix.shard }}/${{ strategy.job-total }}

  # Integration Lane: Golden Path Smoke Tests (Covers E2E)
  golden-path:
    needs: [build, quality]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.docker == 'true' }}
    runs-on: ubuntu-latest-8-cores
    env:
      DOCKER_BUILDKIT: '1'
      COMPOSE_DOCKER_CLI_BUILD: '1'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}
          install: 'true'

      - name: Bootstrap
        run: make bootstrap

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile.dev
          tags: summit/api:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Client image
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/Dockerfile.dev
          tags: summit/web:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start Stack
        run: make up

      - name: Smoke Tests
        run: make smoke

      - name: Logs on Failure
        if: failure()
        run: ./scripts/run-compose.sh -f docker-compose.dev.yml logs --tail=200

      - name: Teardown
        if: always()
        run: ./scripts/run-compose.sh -f docker-compose.dev.yml down -v

  # Compatibility Matrix (Non-blocking)
  compatibility:
    needs: [changes]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.core == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        node: ['18.x']
    steps:
      - uses: actions/checkout@v4
      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node }}

      - name: Build Workspace
        run: pnpm turbo run build --filter="!docs-site"

      - name: Unit Tests
        run: pnpm run test:jest

  # Security Lane
  security:
    needs: [changes]
    if: ${{ github.event_name == 'push' || needs.changes.outputs.core == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      # 1. Secret Scanning (Blocking)
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
          fail: true

      # 2. SBOM Generation
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json

      # 3. Vulnerability Scanning (Trivy)
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: 'json'
          output: 'trivy-results.json'
          exit-code: '0' # OPA decides policy

      # 4. Policy Gate Preparation
      - name: Generate OPA Input
        run: node scripts/ci/generate-opa-input.cjs --sbom sbom.spdx.json --trivy trivy-results.json --output opa-input.json

      # 5. OPA Setup
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      # 6. Policy Evaluation (Blocking)
      - name: Evaluate Security Policy
        run: |
          # Evaluate CI Gate policy
          VIOLATION_COUNT=$(opa eval --input opa-input.json --data policy/ --format json "count(data.ci_gate.deny)" | jq '.result[0].expressions[0].value')

          if [ "$VIOLATION_COUNT" -gt 0 ]; then
             echo "❌ Security Policy Gate Failed with $VIOLATION_COUNT violations:"
             opa eval --input opa-input.json --data policy/ --format pretty "data.ci_gate.deny"
             exit 1
          else
             echo "✅ Security Policy Gate Passed."
             # Warn about non-blocking issues
             opa eval --input opa-input.json --data policy/ --format pretty "data.ci_gate.warn"
          fi

      # 7. Upload Artifacts
      - name: Upload Security Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            sbom.spdx.json
            trivy-results.json
            opa-input.json
