name: Monorepo CI Fan-out

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.filter.outputs.source }}
      contracts: ${{ steps.filter.outputs.contracts }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            source:
              - 'services/**'
              - 'apps/**'
              - 'infra/**'
              - 'scripts/**'
              - 'fixtures/**'
            contracts:
              - 'contracts/**'

  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run lint
        run: |
          echo "TODO: add lint commands per service/app"

  unit:
    name: Unit
    needs: lint
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
<<<<<<< HEAD
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: Enable corepack
        run: corepack enable
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_CACHE_FOLDER }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
      - name: Configure pnpm store
        run: pnpm config set store-dir $PNPM_CACHE_FOLDER
      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build workspace
        run: pnpm -w run build
      - name: Unit & integration tests
        # Enforce 10 minute time budget (600s)
        run: bash scripts/ci-test-budget.sh 600 "pnpm -w run test"
      - name: Upload build artifacts for golden path
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .turbo
            node_modules/.cache
          retention-days: 1

  # Security lane: Run security scans (non-blocking on PR)
  security-scan:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          output-file: sbom.spdx.json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: sbom.spdx.json
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          format: table
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: '0'
          vuln-type: 'os,library'

  # Integration lane: Golden path smoke tests
  golden-path:
    runs-on: ubuntu-latest
    needs: [fast-checks, build-test]
    env:
      DOCKER_BUILDKIT: '1'
      COMPOSE_DOCKER_CLI_BUILD: '1'
      PNPM_CACHE_FOLDER: ~/.pnpm-store
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: Enable corepack
        run: corepack enable
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_CACHE_FOLDER }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
      - name: Configure pnpm store
        run: pnpm config set store-dir $PNPM_CACHE_FOLDER
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
        continue-on-error: true
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Bootstrap repo (make bootstrap)
        run: make bootstrap
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('docker-compose.dev.yml', 'server/package.json', 'client/package.json') }}
          restore-keys: ${{ runner.os }}-buildx-
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build API image (cached)
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile.dev
          tags: summit/api:ci
          push: false
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
      - name: Build client image (cached)
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/Dockerfile.dev
          tags: summit/web:ci
          push: false
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
      # Move cache to prevent unbounded growth
      - name: Rotate Docker cache
=======
      - name: Run unit tests
>>>>>>> main
        run: |
          echo "TODO: add unit test commands per service/app"

  contract-conformance:
    name: Contract conformance
    needs: unit
    if: needs.changes.outputs.contracts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate contracts
        run: |
          echo "TODO: add contract verification against published SDKs"

  docker-build:
    name: Docker build
    needs: contract-conformance
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build images
        run: |
          echo "TODO: add docker build matrix per service"

  golden-fixtures:
    name: Golden fixtures
    needs: docker-build
    if: needs.changes.outputs.source == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate golden fixtures
        run: |
          echo "TODO: add golden fixture verification"
