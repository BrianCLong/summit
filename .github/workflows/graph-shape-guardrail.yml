name: Graph Shape Guardrail

on:
  pull_request:
    paths:
      - 'etl/**'
      - 'mapping/**'
      - 'configs/graph_shape_guardrail.yaml'
  schedule:
    - cron: '0 2 * * *' # Nightly at 2 AM

jobs:
  guardrail:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml psycopg2-binary neo4j jsonschema

      - name: Run Graph Shape Guardrail
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          PG_HOST: ${{ secrets.PG_HOST }}
          PG_PORT: ${{ secrets.PG_PORT }}
          PG_DBNAME: ${{ secrets.PG_DBNAME }}
          PG_USER: ${{ secrets.PG_USER }}
          PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
        run: |
          # Use dynamic window based on current time for automated runs
          WINDOW_END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Assume 24h window for daily check
          WINDOW_START=$(date -u -d "24 hours ago" +"%Y-%m-%dT%H:%M:%SZ")

          PYTHONPATH=tools/graph-shape-guardrail python3 -m graph_shape_guardrail.main \
            --config configs/graph_shape_guardrail.yaml \
            --window-start "$WINDOW_START" \
            --window-end "$WINDOW_END"

      - name: Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: graph-shape-evidence
          path: artifacts/graph-shape-guardrail/
