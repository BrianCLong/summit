name: release
on:
  push:
    tags: ['v*.*.*']
permissions:
  contents: read
  id-token: write
  packages: write
jobs:
  build_sign_attest:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: corepack enable && pnpm i --frozen-lockfile
      - name: Build image (pinned base)
        run: |
          BASE_DIGEST=$(crane digest cgr.dev/chainguard/node:20)
          docker buildx build \
            --build-arg BASE_DIGEST=${BASE_DIGEST} \
            --label org.opencontainers.image.revision=${GITHUB_SHA} \
            --provenance=false \
            -t ghcr.io/${{ github.repository }}/app:${GITHUB_SHA} \
            -t ghcr.io/${{ github.repository }}/app:${GITHUB_REF_NAME} \
            --push .
      - name: Generate SBOM
        run: syft ghcr.io/${{ github.repository }}/app:${GITHUB_SHA} -o spdx-json=sbom.spdx.json
      - name: Vulnerability scan
        run: trivy image --scanners vuln --format json --severity CRITICAL,HIGH \
          --ignore-unfixed --exit-code 0 ghcr.io/${{ github.repository }}/app:${GITHUB_SHA} > trivy.json
      - name: Enforce vuln budget
        run: node scripts/enforceBudget.js trivy.json --critical 0 --high 3
      - name: Cosign sign (keyless OIDC)
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: cosign sign ghcr.io/${{ github.repository }}/app@$(crane digest ghcr.io/${{ github.repository }}/app:${GITHUB_SHA})
      - name: SLSA provenance attestation
        run: cosign attest --predicate slsa/predicate.json --type slsaprovenance \
          ghcr.io/${{ github.repository }}/app@$(crane digest ghcr.io/${{ github.repository }}/app:${GITHUB_SHA})
      - name: Trust report
        run:
          node scripts/trustReport.js --image ghcr.io/${{ github.repository }}/app:${GITHUB_SHA} \
          --sbom sbom.spdx.json --scan trivy.json > trust-report.json
      - uses: actions/upload-artifact@v4
        with:
          name: trust-artifacts
          path: |
            sbom.spdx.json
            trivy.json
            trust-report.json
