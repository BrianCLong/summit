name: Release 2025.11
on:
  pull_request:
    branches: [main]
    paths-ignore: ['**/*.md']
  workflow_dispatch:
jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - name: Install
        run: |
          npm ci
          npx playwright install --with-deps
      - name: Lint & Unit
        run: npm run lint && npm test -- --ci --reporters=default
      - name: Build
        run: npm run build
  perf-k6:
    needs: test-build
    runs-on: ubuntu-latest
    env:
      API: ${{ secrets.PERF_API_BASE }}
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6@server/src/migrations/020_v110_confcompute_privacy.ts
      - name: Bulk ops @tests/k6/soar_bulk_100rps.js ops/sec + idempotency
        run: k6 run tests/k6/soar_bulk_100rps.js
  e2e-playwright:
    needs: test-build
    runs-on: ubuntu-latest
    env:
      WEB_URL: ${{ vars.WEB_URL || 'http://localhost:3000' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - name: Start app
        run: npm run start:web & sleep 10
      - name: E2E
        run: npx playwright test
  policy-checks:
    needs: test-build
    runs-on: ubuntu-latest
    env:
      METRICS_ENDPOINT: ${{ secrets.METRICS_JSON_URL }}
    steps:
      - uses: actions/checkout@v4
      - name: OPA / license checks
        run: npm run policy:check
  release:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true }}
    needs: [perf-k6, e2e-playwright, policy-checks]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Tag and notify
        run: |
          git tag v2025.11.2
          git push origin v2025.11.2
          echo "Release v2025.11.2 cut"
