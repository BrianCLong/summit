name: CI Golden Path

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  push:
    branches: [main]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: golden-path-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  golden-path-smoke:
    name: Golden path smoke (install/migrate/core)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.14.0
          cache: pnpm

      - name: Bootstrap
        run: make bootstrap

      - name: Start stack
        run: make up

      - name: Smoke test
        run: make smoke

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-path-smoke
          path: |
            artifacts/golden-path.log
            logs/
          retention-days: 5

      - name: Teardown
        if: always()
        run: make down

  fast-lane:
    name: Fast lane (build + unit)
    uses: ./.github/workflows/_reusable-ci-fast.yml

  security:
    name: Security posture
    uses: ./.github/workflows/_reusable-ci-security.yml

  perf-slo:
    name: Perf SLO guardrail
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'perf:strict') || contains(github.event.pull_request.labels.*.name, 'needs-canary-plan')
    uses: ./.github/workflows/_reusable-ci-perf.yml

  promotion-gate:
    name: Gate summary
    needs: [golden-path-smoke, fast-lane, security, perf-slo]
    if: always()
    runs-on: ubuntu-latest
    env:
      PERF_REQUIRED: ${{ github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'perf:strict') || contains(github.event.pull_request.labels.*.name, 'needs-canary-plan') }}
    steps:
      - name: Evaluate stage results
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            const failures = [];
            const results = {
              golden: '${{ needs.golden-path-smoke.result }}',
              fast: '${{ needs.fast-lane.result }}',
              security: '${{ needs.security.result }}',
              perf: '${{ needs.perf-slo.result }}'
            };
            const perfRequired = process.env.PERF_REQUIRED === 'true';

            if (results.golden !== 'success') {
              failures.push('Golden-path smoke failed; fix install/migrate/smoke.');
            }
            if (results.fast !== 'success') {
              failures.push('Fast lane failed; fix build/test.');
            }
            if (results.security !== 'success') {
              failures.push('Security checks failed; review gitleaks/trivy outputs.');
            }
            if (perfRequired && results.perf !== 'success') {
              failures.push('Perf SLO guardrail failed; review k6 thresholds.');
            }

            const statusTable = [
              ['golden-path-smoke', results.golden],
              ['fast-lane', results.fast],
              ['security', results.security],
              ['perf-slo', perfRequired ? results.perf : `${results.perf} (not required)`]
            ];

            core.summary.addHeading('CI Golden Path status');
            core.summary.addTable([
              [{data: 'Stage', header: true}, {data: 'Result', header: true}],
              ...statusTable
            ]);
            core.summary.write();

            if (failures.length) {
              core.setFailed(failures.join(' '));
            }

      - name: Comment status on PR
        if: github.event.pull_request && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened' || github.event.action == 'ready_for_review' || github.event.action == 'labeled' || github.event.action == 'unlabeled')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS_GOLDEN='${{ needs.golden-path-smoke.result }}'
          STATUS_FAST='${{ needs.fast-lane.result }}'
          STATUS_SEC='${{ needs.security.result }}'
          STATUS_PERF='${{ needs.perf-slo.result }}'
          PERF_REQUIRED=${{ env.PERF_REQUIRED }}

          cat > golden-path.md <<'COMMENT'
          ## âœ… CI Golden Path

          | Stage | Result |
          |-------|--------|
          COMMENT

          {
            echo "| Golden path smoke | ${STATUS_GOLDEN} |"
            echo "| Fast lane | ${STATUS_FAST} |"
            echo "| Security | ${STATUS_SEC} |"
            if [ "${PERF_REQUIRED}" = "true" ]; then
              echo "| Perf SLO | ${STATUS_PERF} |"
            else
              echo "| Perf SLO | ${STATUS_PERF} (not required) |"
            fi
          } >> golden-path.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file golden-path.md || true
