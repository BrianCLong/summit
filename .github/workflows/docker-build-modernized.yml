name: ðŸ³ Docker - Multi-arch Build & Push
# Production-grade container builds with security scanning and signing

on:
  push:
    branches: [main, develop]
    paths:
      - '**/Dockerfile*'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'src/**'
      - 'server/**'
      - 'client/**'
      - 'apps/**'
      - 'services/**'
  pull_request:
    branches: [main]
    paths:
      - '**/Dockerfile*'
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Build platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      push-images:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: false

concurrency:
  group: docker-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write
  attestations: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/summit

jobs:
  # ============================================================================
  # PHASE 1: Prepare Build Matrix
  # ============================================================================

  prepare:
    name: ðŸ“‹ Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should-push: ${{ steps.config.outputs.push }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine push policy
        id: config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "push=${{ github.event.inputs.push-images }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "push=true" >> "$GITHUB_OUTPUT"
          else
            echo "push=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build matrix
        id: set-matrix
        run: |
          # Define components to build
          matrix='
          {
            "include": [
              {
                "name": "api",
                "dockerfile": "server/Dockerfile",
                "context": ".",
                "build-args": "NODE_ENV=production"
              },
              {
                "name": "web",
                "dockerfile": "client/Dockerfile",
                "context": ".",
                "build-args": "NODE_ENV=production"
              },
              {
                "name": "gateway",
                "dockerfile": "services/gateway/Dockerfile",
                "context": ".",
                "build-args": "NODE_ENV=production"
              }
            ]
          }
          '
          echo "matrix=$(echo $matrix | jq -c .)" >> "$GITHUB_OUTPUT"

  # ============================================================================
  # PHASE 2: Build & Push Images
  # ============================================================================

  build-push:
    name: ðŸ—ï¸ Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: [prepare]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to Container Registry
        if: needs.prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Summit ${{ matrix.name }}
            org.opencontainers.image.description=Summit Platform - ${{ matrix.name }} component
            org.opencontainers.image.vendor=IntelGraph Team
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Check Dockerfile exists
        id: dockerfile-check
        run: |
          if [ -f "${{ matrix.dockerfile }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Dockerfile found at ${{ matrix.dockerfile }}"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Dockerfile not found at ${{ matrix.dockerfile }}"
          fi

      - name: Build and push image
        if: steps.dockerfile-check.outputs.exists == 'true'
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ github.event.inputs.platforms || 'linux/amd64,linux/arm64' }}
          push: ${{ needs.prepare.outputs.should-push == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ matrix.build-args }}
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
          provenance: true
          sbom: true
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }},push-by-digest=false

      - name: Generate SBOM with Syft
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        run: |
          # Install Syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          # Generate SBOM in multiple formats
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:${{ github.sha }} \
            -o spdx-json=sbom-${{ matrix.name }}.spdx.json

          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:${{ github.sha }} \
            -o cyclonedx-json=sbom-${{ matrix.name }}.cyclonedx.json

      - name: Scan image with Trivy
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:${{ github.sha }}
          format: sarif
          output: trivy-${{ matrix.name }}.sarif
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: '0'
          vuln-type: os,library

      - name: Upload Trivy results to Security tab
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.name }}.sarif
          category: trivy-${{ matrix.name }}

      - name: Install Cosign
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: v2.2.4

      - name: Sign image with Cosign (keyless)
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}@${{ steps.build.outputs.digest }}

      - name: Verify signature
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign verify \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}@${{ steps.build.outputs.digest }}

      - name: Attest SBOM
        if: steps.dockerfile-check.outputs.exists == 'true' && needs.prepare.outputs.should-push == 'true'
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign attest --yes \
            --predicate sbom-${{ matrix.name }}.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}@${{ steps.build.outputs.digest }}

      - name: Upload SBOM artifacts
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.name }}-${{ github.run_number }}
          path: |
            sbom-${{ matrix.name }}.*.json
          retention-days: 90

      - name: Generate build summary
        if: steps.dockerfile-check.outputs.exists == 'true'
        run: |
          echo "## ðŸ³ Container Build - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.prepare.outputs.should-push }}" = "true" ]; then
            echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Platforms | ${{ github.event.inputs.platforms || 'linux/amd64,linux/arm64' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Signed | âœ… Yes (Cosign keyless) |" >> $GITHUB_STEP_SUMMARY
            echo "| SBOM | âœ… Generated & Attested |" >> $GITHUB_STEP_SUMMARY
            echo "| Security Scan | âœ… Trivy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | ðŸ”¨ Build only (not pushed) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # PHASE 3: Security & Compliance Report
  # ============================================================================

  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [build-push]
    if: always()
    steps:
      - name: Download all SBOMs
        uses: actions/download-artifact@v4
        with:
          pattern: sbom-*-${{ github.run_number }}
          path: sboms/

      - name: Generate security summary
        run: |
          echo "# ðŸ”’ Container Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "sboms" ]; then
            echo "| Component | SBOM | Format |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------|--------|" >> $GITHUB_STEP_SUMMARY

            for sbom in sboms/*/*.json; do
              if [ -f "$sbom" ]; then
                name=$(basename $(dirname "$sbom") | sed 's/sbom-//' | sed 's/-[0-9]*$//')
                format=$(echo "$sbom" | grep -o '\(spdx\|cyclonedx\)')
                echo "| $name | âœ… | $format |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "No SBOMs found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Measures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Multi-architecture builds (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Vulnerability scanning (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SBOM generation (Syft)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Image signing (Cosign keyless)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SBOM attestation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Provenance metadata" >> $GITHUB_STEP_SUMMARY
