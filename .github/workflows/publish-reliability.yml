name: Publish Reliability Declaration

on:
  push:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  publish-slo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Validate SLO Config Schema
        run: |
          # Basic validation to ensure it's valid YAML and has required fields
          # In a real setup, we might use a JSON schema validator (e.g., ajv-cli)
          # Here we use yq to check for key fields
          if ! command -v yq &> /dev/null; then
             # Install yq
             sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
             sudo chmod +x /usr/bin/yq
          fi

          echo "Validating slo-config.yaml..."
          yq e '.kind' slo-config.yaml | grep "ServiceLevelObjective"
          yq e '.spec.objectives | length' slo-config.yaml | grep -v "0"
          echo "Validation successful."

      - name: Publish SLO Config Artifact
        uses: actions/upload-artifact@v3
        with:
          name: reliability-declaration
          path: slo-config.yaml
