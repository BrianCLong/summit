name: Release Ops Orchestrator

# Single orchestrator workflow that runs the full Release Ops automation sequence
# deterministically and produces one comprehensive artifact bundle per cycle.
#
# Sequence:
#   1. Generate dashboard (policy engine)
#   2. Raise/update blocker issues (if enabled)
#   3. Apply routing labels/owner hints (if enabled)
#   4. Apply escalation thresholds (if enabled)
#   5. Generate daily digest (rate-limited)
#   6. Generate on-call handoff (rate-limited)
#   7. Upload single artifact bundle
#
# Authority: docs/ci/RELEASE_OPS_ORCHESTRATOR.md

on:
  # Primary schedule - every 60 minutes
  schedule:
    - cron: "0 * * * *" # Every hour on the hour

  # Manual trigger with configuration options
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (no state changes, no issue writes)"
        type: boolean
        default: false
      threshold_minutes:
        description: "Age threshold (minutes) before raising blocker issues"
        type: number
        default: 90
      enable_issue_writes:
        description: "Enable issue creation/updates"
        type: boolean
        default: true
      enable_routing:
        description: "Enable routing label application"
        type: boolean
        default: true
      enable_escalation:
        description: "Enable escalation threshold checks"
        type: boolean
        default: true
      enable_notify:
        description: "Enable notifications (Slack/email)"
        type: boolean
        default: false
      force_digest:
        description: "Force digest generation (ignore cadence window)"
        type: boolean
        default: false
      force_handoff:
        description: "Force handoff generation (ignore cadence window)"
        type: boolean
        default: false
      verbose:
        description: "Enable verbose logging"
        type: boolean
        default: false

  # Trigger on workflow changes (for testing)
  push:
    branches:
      - main
    paths:
      - ".github/workflows/release-ops-orchestrator.yml"

# Prevent concurrent runs - only one orchestrator cycle at a time
concurrency:
  group: release-ops-orchestrator
  cancel-in-progress: false # Let running cycles complete

permissions:
  contents: write # For state file commits
  issues: write # For issue creation/updates
  actions: read # For workflow status

jobs:
  # Check if we should skip (avoid infinite loops from state commits)
  pre-check:
    name: Pre-flight Check
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4 # v4
        with:
          fetch-depth: 2

      - name: Check for loop avoidance
        id: check
        run: |
          # Get the last commit message
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)

          # Skip if last commit was from this workflow (state update)
          if [[ "${LAST_COMMIT_MSG}" == "chore(release-ops):"* ]]; then
            echo "Skipping: last commit was a release-ops state update"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip if triggered by a paths-only push that was state files
          if [[ "${{ github.event_name }}" == "push" ]]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            STATE_ONLY=true

            while IFS= read -r file; do
              [[ -z "${file}" ]] && continue
              if [[ "${file}" != docs/releases/_state/* ]] && \
                 [[ "${file}" != docs/releases/RELEASE_TRAIN_DASHBOARD.md ]]; then
                STATE_ONLY=false
                break
              fi
            done <<< "${CHANGED_FILES}"

            if [[ "${STATE_ONLY}" == "true" ]] && [[ -n "${CHANGED_FILES}" ]]; then
              echo "Skipping: only state files changed"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "should_run=true" >> $GITHUB_OUTPUT

  orchestrate:
    name: Release Ops Cycle
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    timeout-minutes: 30

    env:
      DRY_RUN: ${{ inputs.dry_run || 'false' }}
      THRESHOLD_MINUTES: ${{ inputs.threshold_minutes || '90' }}
      ENABLE_ISSUE_WRITES: ${{ inputs.enable_issue_writes || 'true' }}
      ENABLE_ROUTING: ${{ inputs.enable_routing || 'true' }}
      ENABLE_ESCALATION: ${{ inputs.enable_escalation || 'true' }}
      ENABLE_NOTIFY: ${{ inputs.enable_notify || 'false' }}
      VERBOSE: ${{ inputs.verbose || 'false' }}

    steps:
      # =========================================================================
      # A) CHECKOUT
      # =========================================================================
      - name: Checkout
        uses: actions/checkout@v4 # v4
        with:
          fetch-depth: 0 # Full history for tag detection
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: |
          # jq is pre-installed on ubuntu-latest
          which jq || sudo apt-get install -y jq

          # Install yq for YAML processing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Make Scripts Executable
        run: |
          chmod +x scripts/release/*.sh || true

      - name: Create Artifact Directory
        run: |
          mkdir -p artifacts/release-train
          echo "Orchestrator cycle started at $(date -u +%Y-%m-%dT%H:%M:%SZ)" > artifacts/release-train/cycle_info.txt
          echo "Run ID: ${{ github.run_id }}" >> artifacts/release-train/cycle_info.txt
          echo "Dry Run: ${DRY_RUN}" >> artifacts/release-train/cycle_info.txt

      # =========================================================================
      # B) GENERATE DASHBOARD (Policy Engine)
      # =========================================================================
      - name: "Step 1: Generate Dashboard"
        id: dashboard
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Generate Dashboard"

          ARGS=""
          [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"
          [[ "${DRY_RUN}" == "true" ]] && ARGS="${ARGS} --dry-run"

          if [[ -x "scripts/release/generate_release_train_dashboard.sh" ]]; then
            ./scripts/release/generate_release_train_dashboard.sh ${ARGS} || {
              echo "::warning::Dashboard generation failed, creating minimal dashboard"
              echo '{"candidates":[],"summary":{"total_candidates":0,"promotable":0,"blocked":0,"pending":0},"generated_at":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > artifacts/release-train/dashboard.json
            }
          else
            echo "::warning::Dashboard generator not found, creating placeholder"
            echo '{"candidates":[],"summary":{"total_candidates":0,"promotable":0,"blocked":0,"pending":0},"generated_at":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > artifacts/release-train/dashboard.json
          fi

          # Copy dashboard to artifacts if generated elsewhere
          if [[ -f "artifacts/release-train/dashboard.json" ]]; then
            echo "dashboard_exists=true" >> $GITHUB_OUTPUT
          else
            echo "dashboard_exists=false" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      # =========================================================================
      # C) RAISE/UPDATE BLOCKER ISSUES
      # =========================================================================
      - name: "Step 2: Raise Blocker Issues"
        id: blocker_issues
        if: env.ENABLE_ISSUE_WRITES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Raise Blocker Issues"

          REPORT_FILE="artifacts/release-train/blocked_issues_report.md"

          if [[ -x "scripts/release/raise_blocked_release_issues.sh" ]]; then
            ARGS="--dashboard artifacts/release-train/dashboard.json"
            ARGS="${ARGS} --threshold ${THRESHOLD_MINUTES}"
            [[ "${DRY_RUN}" == "true" ]] && ARGS="${ARGS} --dry-run"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            ./scripts/release/raise_blocked_release_issues.sh ${ARGS} > "${REPORT_FILE}" 2>&1 || {
              echo "::warning::Blocker issues script failed"
              echo "# Blocked Issues Report" > "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "Script execution failed. See workflow logs for details." >> "${REPORT_FILE}"
            }
          else
            # Create placeholder report based on dashboard
            echo "# Blocked Issues Report" > "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"

            if [[ -f "artifacts/release-train/dashboard.json" ]]; then
              BLOCKED=$(jq -r '.summary.blocked // 0' artifacts/release-train/dashboard.json)
              echo "## Summary" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "- Blocked candidates: ${BLOCKED}" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              if [[ "${BLOCKED}" -gt 0 ]]; then
                echo "## Blocked Candidates" >> "${REPORT_FILE}"
                echo "" >> "${REPORT_FILE}"
                jq -r '.candidates[] | select(.promotable_state == "blocked") | "- **\(.tag)**: \(.top_blocker // "Unknown")"' \
                  artifacts/release-train/dashboard.json >> "${REPORT_FILE}" || true
              fi
            else
              echo "Dashboard not available." >> "${REPORT_FILE}"
            fi

            echo "" >> "${REPORT_FILE}"
            echo "_Note: raise_blocked_release_issues.sh not implemented. This is a placeholder report._" >> "${REPORT_FILE}"
          fi

          echo "::endgroup::"

      # =========================================================================
      # D) APPLY ROUTING LABELS
      # =========================================================================
      - name: "Step 3: Apply Routing"
        id: routing
        if: env.ENABLE_ROUTING == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Apply Routing"

          REPORT_FILE="artifacts/release-train/routing_report.md"

          if [[ -x "scripts/release/auto_triage_blockers.sh" ]]; then
            ARGS=""
            [[ "${DRY_RUN}" == "true" ]] && ARGS="${ARGS} --dry-run"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            ./scripts/release/auto_triage_blockers.sh ${ARGS} > "${REPORT_FILE}" 2>&1 || {
              echo "::warning::Routing script failed"
              echo "# Routing Report" > "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "Script execution failed. See workflow logs for details." >> "${REPORT_FILE}"
            }
          else
            echo "# Routing Report" > "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "Routing script not available." >> "${REPORT_FILE}"
          fi

          echo "::endgroup::"

      # =========================================================================
      # E) APPLY ESCALATION THRESHOLDS
      # =========================================================================
      - name: "Step 4: Apply Escalation"
        id: escalation
        if: env.ENABLE_ESCALATION == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Apply Escalation"

          REPORT_FILE="artifacts/release-train/escalation_report.md"

          if [[ -x "scripts/release/escalate_release_blockers.sh" ]]; then
            ARGS=""
            [[ "${DRY_RUN}" == "true" ]] && ARGS="${ARGS} --dry-run"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            ./scripts/release/escalate_release_blockers.sh ${ARGS} > "${REPORT_FILE}" 2>&1 || {
              echo "::warning::Escalation script failed"
              echo "# Escalation Report" > "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "Script execution failed. See workflow logs for details." >> "${REPORT_FILE}"
            }
          else
            echo "# Escalation Report" > "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "Escalation script not available." >> "${REPORT_FILE}"
          fi

          echo "::endgroup::"

      # =========================================================================
      # F) GENERATE DAILY DIGEST (Cadence-Gated: once per day in configured window)
      # =========================================================================
      - name: "Step 5: Check Digest Cadence"
        id: digest_cadence
        env:
          FORCE_RUN_DIGEST: ${{ inputs.force_digest || 'false' }}
        run: |
          # Check if digest should run based on policy window and cadence
          if [[ -x "scripts/release/should_run_task.sh" ]]; then
            STATE_FILE="docs/releases/_state/digest_state.json"
            ARGS="--task digest"
            [[ -f "${STATE_FILE}" ]] && ARGS="${ARGS} --state ${STATE_FILE}"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            if ./scripts/release/should_run_task.sh ${ARGS}; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            # No cadence helper - always run
            echo "::notice::Cadence helper not found, running digest unconditionally"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: "Step 5: Generate Digest"
        id: digest
        if: steps.digest_cadence.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Generate Digest"

          REPORT_FILE="artifacts/release-train/release_ops_digest.md"

          if [[ -x "scripts/release/generate_release_ops_digest.sh" ]]; then
            ARGS=""
            [[ "${DRY_RUN}" == "true" ]] && ARGS="${ARGS} --dry-run"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            ./scripts/release/generate_release_ops_digest.sh ${ARGS} > "${REPORT_FILE}" 2>&1 || {
              echo "::warning::Digest script failed"
              echo "# Release Ops Digest" > "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "Script execution failed. See workflow logs for details." >> "${REPORT_FILE}"
            }
          else
            echo "# Release Ops Digest" > "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "Digest script not available." >> "${REPORT_FILE}"
          fi

          echo "::endgroup::"

      - name: "Step 5: Skip Digest (Outside Window)"
        if: steps.digest_cadence.outputs.should_run != 'true'
        run: |
          REPORT_FILE="artifacts/release-train/release_ops_digest.md"
          echo "# Release Ops Digest" > "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"
          echo "**Skipped:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"
          echo "Digest skipped - outside configured window or cadence not elapsed." >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"
          echo "See \`docs/ci/RELEASE_OPS_DIGEST_POLICY.yml\` for window configuration." >> "${REPORT_FILE}"

      # =========================================================================
      # G) GENERATE ON-CALL HANDOFF (Cadence-Gated: shift-change windows)
      # =========================================================================
      - name: "Step 6: Check Handoff Cadence"
        id: handoff_cadence
        env:
          FORCE_RUN_HANDOFF: ${{ inputs.force_handoff || 'false' }}
        run: |
          # Check if handoff should run based on policy windows and cadence
          if [[ -x "scripts/release/should_run_task.sh" ]]; then
            STATE_FILE="docs/releases/_state/handoff_state.json"
            ARGS="--task handoff"
            [[ -f "${STATE_FILE}" ]] && ARGS="${ARGS} --state ${STATE_FILE}"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            if ./scripts/release/should_run_task.sh ${ARGS}; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            # No cadence helper - always run
            echo "::notice::Cadence helper not found, running handoff unconditionally"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: "Step 6: Generate Handoff"
        id: handoff
        if: steps.handoff_cadence.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Generate Handoff"

          REPORT_FILE="artifacts/release-train/oncall_handoff.md"

          if [[ -x "scripts/release/generate_oncall_handoff.sh" ]]; then
            ARGS=""
            [[ "${DRY_RUN}" == "true" ]] && ARGS="${ARGS} --dry-run"
            [[ "${VERBOSE}" == "true" ]] && ARGS="${ARGS} --verbose"

            ./scripts/release/generate_oncall_handoff.sh ${ARGS} > "${REPORT_FILE}" 2>&1 || {
              echo "::warning::Handoff script failed"
              echo "# On-Call Handoff" > "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "Script execution failed. See workflow logs for details." >> "${REPORT_FILE}"
            }
          else
            echo "# On-Call Handoff" > "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "Handoff script not available." >> "${REPORT_FILE}"
          fi

          echo "::endgroup::"

      - name: "Step 6: Skip Handoff (Outside Window)"
        if: steps.handoff_cadence.outputs.should_run != 'true'
        run: |
          REPORT_FILE="artifacts/release-train/oncall_handoff.md"
          echo "# On-Call Handoff" > "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"
          echo "**Skipped:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"
          echo "Handoff skipped - outside shift-change windows or cadence not elapsed." >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"
          echo "See \`docs/ci/ONCALL_HANDOFF_POLICY.yml\` for window configuration." >> "${REPORT_FILE}"

      # =========================================================================
      # G.5) GENERATE SINGLE PAGE SUMMARY
      # =========================================================================
      - name: "Step 7: Generate Single Page"
        id: single_page
        run: |
          echo "::group::Generate Single Page"

          if [[ -x "scripts/release/generate_release_ops_single_page.sh" ]]; then
            ./scripts/release/generate_release_ops_single_page.sh \
              --reports-dir artifacts/release-train \
              --run-id "${{ github.run_id }}" \
              --repo "${{ github.repository }}" \
              ${VERBOSE:+--verbose} || {
                echo "::warning::Single page generation failed"
                # Create minimal fallback
                echo "# Release Ops Single Page" > artifacts/release-train/release_ops_single_page.md
                echo "" >> artifacts/release-train/release_ops_single_page.md
                echo "_Generation failed. See workflow logs for details._" >> artifacts/release-train/release_ops_single_page.md
              }
          else
            echo "::notice::Single page generator not found, creating placeholder"
            echo "# Release Ops Single Page" > artifacts/release-train/release_ops_single_page.md
            echo "" >> artifacts/release-train/release_ops_single_page.md
            echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> artifacts/release-train/release_ops_single_page.md
            echo "" >> artifacts/release-train/release_ops_single_page.md
            echo "Single page generator script not available." >> artifacts/release-train/release_ops_single_page.md
          fi

          echo "::endgroup::"

      # =========================================================================
      # G.6) RENDER SINGLE PAGE AS HTML
      # =========================================================================
      - name: "Step 7b: Render Single Page HTML"
        id: single_page_html
        run: |
          echo "::group::Render Single Page HTML"

          MD_FILE="artifacts/release-train/release_ops_single_page.md"
          HTML_FILE="artifacts/release-train/release_ops_single_page.html"

          if [[ ! -f "${MD_FILE}" ]]; then
            echo "::warning::Markdown file not found, skipping HTML render"
            echo "html_rendered=false" >> $GITHUB_OUTPUT
          elif [[ -x "scripts/release/render_release_ops_single_page_html.sh" ]]; then
            ./scripts/release/render_release_ops_single_page_html.sh \
              --in "${MD_FILE}" \
              --out "${HTML_FILE}" \
              --title "${{ github.repository }} - Release Ops" \
              ${VERBOSE:+--verbose} && {
                echo "html_rendered=true" >> $GITHUB_OUTPUT
              } || {
                echo "::warning::HTML render failed, continuing without HTML"
                echo "html_rendered=false" >> $GITHUB_OUTPUT
              }
          else
            echo "::notice::HTML renderer not found, skipping"
            echo "html_rendered=false" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      # =========================================================================
      # G.7) GENERATE BUNDLE INDEX PAGE
      # =========================================================================
      - name: "Step 7c: Generate Bundle Index"
        id: bundle_index
        run: |
          echo "::group::Generate Bundle Index"

          if [[ -x "scripts/release/generate_release_ops_bundle_index_html.sh" ]]; then
            ./scripts/release/generate_release_ops_bundle_index_html.sh \
              --reports-dir artifacts/release-train \
              --run-id "${{ github.run_id }}" \
              --repo "${{ github.repository }}" \
              ${VERBOSE:+--verbose} && {
                echo "index_generated=true" >> $GITHUB_OUTPUT
              } || {
                echo "::warning::Index generation failed"
                echo "index_generated=false" >> $GITHUB_OUTPUT
              }
          else
            echo "::notice::Index generator not found, skipping"
            echo "index_generated=false" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      # =========================================================================
      # H) UPLOAD ARTIFACT BUNDLE
      # =========================================================================
      - name: "Step 8: Prepare Artifact Bundle"
        run: |
          echo "::group::Prepare Artifact Bundle"

          # Add state files snapshot to artifacts
          mkdir -p artifacts/release-train/state-snapshot
          if [[ -d "docs/releases/_state" ]]; then
            cp docs/releases/_state/*.json artifacts/release-train/state-snapshot/ 2>/dev/null || true
          fi

          # Add cycle summary
          SUMMARY_FILE="artifacts/release-train/cycle_summary.md"
          echo "# Release Ops Cycle Summary" > "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          echo "**Completed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${SUMMARY_FILE}"
          echo "**Run ID:** ${{ github.run_id }}" >> "${SUMMARY_FILE}"
          echo "**Trigger:** ${{ github.event_name }}" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"

          echo "## Configuration" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          echo "| Setting | Value |" >> "${SUMMARY_FILE}"
          echo "|---------|-------|" >> "${SUMMARY_FILE}"
          echo "| Dry Run | ${DRY_RUN} |" >> "${SUMMARY_FILE}"
          echo "| Threshold (min) | ${THRESHOLD_MINUTES} |" >> "${SUMMARY_FILE}"
          echo "| Issue Writes | ${ENABLE_ISSUE_WRITES} |" >> "${SUMMARY_FILE}"
          echo "| Routing | ${ENABLE_ROUTING} |" >> "${SUMMARY_FILE}"
          echo "| Escalation | ${ENABLE_ESCALATION} |" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"

          echo "## Dashboard Summary" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          if [[ -f "artifacts/release-train/dashboard.json" ]]; then
            PROMOTABLE=$(jq -r '.summary.promotable // 0' artifacts/release-train/dashboard.json)
            BLOCKED=$(jq -r '.summary.blocked // 0' artifacts/release-train/dashboard.json)
            PENDING=$(jq -r '.summary.pending // 0' artifacts/release-train/dashboard.json)
            TOTAL=$(jq -r '.summary.total_candidates // 0' artifacts/release-train/dashboard.json)

            echo "| Metric | Count |" >> "${SUMMARY_FILE}"
            echo "|--------|-------|" >> "${SUMMARY_FILE}"
            echo "| Total Candidates | ${TOTAL} |" >> "${SUMMARY_FILE}"
            echo "| Promotable | ${PROMOTABLE} |" >> "${SUMMARY_FILE}"
            echo "| Blocked | ${BLOCKED} |" >> "${SUMMARY_FILE}"
            echo "| Pending | ${PENDING} |" >> "${SUMMARY_FILE}"
          else
            echo "Dashboard not available." >> "${SUMMARY_FILE}"
          fi
          echo "" >> "${SUMMARY_FILE}"

          echo "## Quick Start" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          echo "**Open this first:** \`index.html\` (landing page with all links)" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          echo "Or go directly to:" >> "${SUMMARY_FILE}"
          echo "- \`release_ops_single_page.html\` (browser-friendly summary)" >> "${SUMMARY_FILE}"
          echo "- \`release_ops_single_page.md\` (markdown source)" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"

          echo "## Artifact Contents" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          echo '```' >> "${SUMMARY_FILE}"
          find artifacts/release-train -type f | sort >> "${SUMMARY_FILE}"
          echo '```' >> "${SUMMARY_FILE}"

          echo "::endgroup::"

      - name: "Upload Artifact Bundle"
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: release-ops-cycle-${{ github.run_id }}
          path: artifacts/release-train/
          retention-days: 30
          if-no-files-found: warn

      # =========================================================================
      # I) COMMIT STATE FILES (Optional)
      # =========================================================================
      - name: "Step 9: Commit State Updates"
        if: env.DRY_RUN != 'true' && env.ENABLE_ISSUE_WRITES == 'true'
        run: |
          echo "::group::Commit State Updates"

          # Check if any state files changed
          if git diff --quiet docs/releases/_state/ 2>/dev/null; then
            echo "No state file changes to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add docs/releases/_state/*.json 2>/dev/null || true

            # Only commit if there are staged changes
            if git diff --cached --quiet; then
              echo "No staged changes to commit"
            else
              git commit -m "chore(release-ops): update state files

          Automated state update from Release Ops Orchestrator.
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          [skip ci]"

              git push || echo "::warning::Failed to push state updates"
            fi
          fi

          echo "::endgroup::"

      # =========================================================================
      # GENERATE WORKFLOW SUMMARY
      # =========================================================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## Release Ops Orchestrator Cycle" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Completed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${DRY_RUN} |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold (min) | ${THRESHOLD_MINUTES} |" >> $GITHUB_STEP_SUMMARY
          echo "| Issue Writes | ${ENABLE_ISSUE_WRITES} |" >> $GITHUB_STEP_SUMMARY
          echo "| Routing | ${ENABLE_ROUTING} |" >> $GITHUB_STEP_SUMMARY
          echo "| Escalation | ${ENABLE_ESCALATION} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f "artifacts/release-train/dashboard.json" ]]; then
            echo "### Dashboard Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            PROMOTABLE=$(jq -r '.summary.promotable // 0' artifacts/release-train/dashboard.json)
            BLOCKED=$(jq -r '.summary.blocked // 0' artifacts/release-train/dashboard.json)
            PENDING=$(jq -r '.summary.pending // 0' artifacts/release-train/dashboard.json)

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Promotable | ${PROMOTABLE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Blocked | ${BLOCKED} |" >> $GITHUB_STEP_SUMMARY
            echo "| Pending | ${PENDING} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [[ "${BLOCKED}" -gt 0 ]]; then
              echo "### Blocked Candidates" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.candidates[] | select(.promotable_state == "blocked") | "- **\(.tag)**: \(.top_blocker // "-")"' \
                artifacts/release-train/dashboard.json >> $GITHUB_STEP_SUMMARY || true
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`release-ops-cycle-${{ github.run_id }}\` artifact for full reports." >> $GITHUB_STEP_SUMMARY
