name: Consolidated CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # YAML linting as a gate
  yaml-lint:
    name: YAML Linting
    uses: ./.github/workflows/lint-yaml.yml

  # Parallel test execution using reusable workflows
  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/_reusable-test-suite.yml
    with:
      test-type: unit
      upload-coverage: true
      timeout-minutes: 20

  integration-tests:
    name: Integration Tests
    uses: ./.github/workflows/_reusable-test-suite.yml
    with:
      test-type: integration
      timeout-minutes: 30

  lint-tests:
    name: Lint & Type Check
    uses: ./.github/workflows/_reusable-test-suite.yml
    with:
      test-type: lint
      timeout-minutes: 15

  # Security scanning
  security:
    name: Security Scan
    uses: ./.github/workflows/ci-security.yml

  # Performance tests (conditional)
  performance:
    name: Performance Tests
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/_reusable-test-suite.yml
    with:
      test-type: perf
      timeout-minutes: 45

  # Archive results using AWS workflow
  archive-results:
    name: Archive Test Results
    if: ${{ always() && (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    needs: [unit-tests, integration-tests, lint-tests, security]
    uses: ./.github/workflows/_reusable-aws.yml
    with:
      operation: upload
      source_path: artifacts
      s3_path: ci-results/${{ github.run_id }}
      has_aws: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: ${{ secrets.CI_ARTIFACTS_BUCKET }}

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [yaml-lint, unit-tests, integration-tests, lint-tests, security]
    steps:
      - name: Check results
        run: |
          echo "YAML Lint: ${{ needs.yaml-lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Lint/Type Check: ${{ needs.lint-tests.result }}"
          echo "Security: ${{ needs.security.result }}"
          
          # Fail if any critical job failed
          if [[ "${{ needs.unit-tests.result }}" == "failure" || "${{ needs.security.result }}" == "failure" ]]; then
            echo "❌ Critical CI jobs failed"
            exit 1
          fi
          
          echo "✅ CI pipeline completed successfully"