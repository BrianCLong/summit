name: CI/CD Supply Chain Integrity

on:
  push:
    branches: [main, develop]
    tags: ["v*.*.*"]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write # Enable OIDC for keyless signing
  packages: write # For container image signing

jobs:
  supply-chain-integrity:
    runs-on: ubuntu-latest
    outputs:
      release-version: ${{ steps.vars.outputs.release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7 (pinned to v4 branch tip)
        with:
          fetch-depth: 0

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.0.3
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.1.0
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.0.1
        with:
          go-version: "1.21"

      # Install supply chain tools with strict pinning
      - name: Install syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.39.0
          syft version

      - name: Install grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin v0.104.3
          grype version

      - name: Install cosign
        uses: sigstore/cosign-installer@053f9b74638557590800a301da1ba82351507e2c # v3.8.1

      # Set version variables
      - name: Set version variables
        id: vars
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/* ]]; then
            BRANCH=${GITHUB_REF#refs/heads/}
            VERSION="$BRANCH-${GITHUB_SHA::8}"
          else
            VERSION="pr-${{ github.event.number }}-${GITHUB_SHA::8}"
          fi
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # Run reproducibility check
      - name: Check Build Reproducibility
        if: github.event_name == 'push' && github.ref_type == 'tag'
        run: |
          chmod +x scripts/check-reproducibility.sh
          ./scripts/check-reproducibility.sh summit-platform "npm ci && npm run build" production 2 /tmp/build-test

      # Generate SBOM
      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh summit-platform ${{ env.VERSION }} ./sboms
          ls -la ./sboms/

      # Run vulnerability scan
      - name: Scan for Vulnerabilities
        run: |
          chmod +x scripts/scan-vulnerabilities.sh
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # On tags, fail on high and critical vulnerabilities
            ./scripts/scan-vulnerabilities.sh . ./vulnerability-reports true true json
          else
            # On PR/branch, just report vulnerabilities
            ./scripts/scan-vulnerabilities.sh . ./vulnerability-reports false false json || true
          fi

      # Build and push container image if Dockerfile exists
      - name: Build and Push Docker Image
        if: hash docker 2>/dev/null && [ -f "Dockerfile" ]
        run: |
          DOCKER_IMAGE=ghcr.io/${{ github.repository_owner }}/summit-platform
          DOCKER_TAG=${{ env.VERSION }}

          # Build image
          docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
          docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_IMAGE:latest

          # Generate SBOM for container image
          syft packages docker:$DOCKER_IMAGE:$DOCKER_TAG -o cyclonedx-json --file ./sboms/summit-platform-container-${{ env.VERSION }}.cdx.json

          # Scan container image
          grype docker:$DOCKER_IMAGE:$DOCKER_TAG -o json --file ./vulnerability-reports/summit-platform-container-${{ env.VERSION }}.json

      # Sign artifacts (only on main branch or tags)
      - name: Sign Artifacts
        if: github.ref == 'refs/heads/main' || github.ref_type == 'tag'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          DOCKER_IMAGE=ghcr.io/${{ github.repository_owner }}/summit-platform
          DOCKER_TAG=${{ env.VERSION }}

          # Sign container image with keyless signing
          if [ -f "Dockerfile" ] && [ -n "$DOCKER_TAG" ]; then
            echo "Signing container image: $DOCKER_IMAGE:$DOCKER_TAG"
            cosign sign --yes $DOCKER_IMAGE:$DOCKER_TAG
            
            # Verify the signature
            cosign verify $DOCKER_IMAGE:$DOCKER_TAG --certificate-identity-regexp=".*" --certificate-oidc-issuer-regexp=".*"
          fi

          # Sign SBOMs
          for sbom in ./sboms/*.json; do
            if [ -f "$sbom" ]; then
              echo "Signing SBOM: $sbom"
              cosign sign-blob --output-signature "${sbom}.sig" --yes "$sbom"
            fi
          done

      # Bundle release evidence
      - name: Bundle Release Evidence
        if: github.event_name == 'push' && github.ref_type == 'tag'
        run: |
          chmod +x scripts/bundle-release-evidence.sh
          ./scripts/bundle-release-evidence.sh ${{ env.VERSION }} summit-platform $GITHUB_SHA ./release-evidence

      # Upload SBOMs as artifacts
      - name: Upload SBOMs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.3.3
        with:
          name: sboms-${{ env.VERSION }}
          path: ./sboms/
          retention-days: 90

      # Upload vulnerability reports
      - name: Upload Vulnerability Reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.3.3
        with:
          name: vulnerability-reports-${{ env.VERSION }}
          path: ./vulnerability-reports/
          retention-days: 90

      # Upload release evidence bundle
      - name: Upload Release Evidence Bundle
        if: github.event_name == 'push' && github.ref_type == 'tag'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.3.3
        with:
          name: release-evidence-${{ env.VERSION }}
          path: ./release-evidence/summit-release-${{ env.VERSION }}-evidence.tar.gz
          retention-days: 365

  # CI Gate: Final verification of all supply chain integrity
  ci-gate:
    needs: supply-chain-integrity
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7

      - name: Download SBOMs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.1.7
        with:
          name: sboms-${{ needs.supply-chain-integrity.outputs.release-version }}
          path: ./sboms

      - name: Download Vulnerability Reports
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.1.7
        with:
          name: vulnerability-reports-${{ needs.supply-chain-integrity.outputs.release-version }}
          path: ./vulnerability-reports

      - name: Install tools
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.39.0
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin v0.104.3

      - name: Run CI Supply Chain Gate
        env:
          RELEASE_VERSION: ${{ needs.supply-chain-integrity.outputs.release-version }}
        run: |
          chmod +x scripts/ci-supply-chain-gate.sh
          ./scripts/ci-supply-chain-gate.sh summit-platform production true false true true true true

  # Create GitHub Release (only for tags)
  release:
    needs: [supply-chain-integrity, ci-gate]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref_type == 'tag'
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Download Release Evidence Bundle
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.1.7
        with:
          name: release-evidence-${{ needs.supply-chain-integrity.outputs.release-version }}
          path: ./releases

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.0.5
        with:
          name: "Release ${{ needs.supply-chain-integrity.outputs.release-version }}"
          body: |
            ## Summit Platform Release ${{ needs.supply-chain-integrity.outputs.release-version }}

            This release includes:
            - Supply chain security compliance (SLSA Level 3)
            - Software Bill of Materials (SBOM)
            - Signed artifacts and provenance
            - Vulnerability scans and security reports
            - Reproducible build verification

            ## Compliance
            - SBOMs included in release assets
            - Signed artifacts with Sigstore
            - Security scan reports included
            - All CI gates passed
          draft: false
          prerelease: ${{ contains(needs.supply-chain-integrity.outputs.release-version, 'rc') || contains(needs.supply-chain-integrity.outputs.release-version, 'beta') }}
          files: |
            ./releases/summit-release-${{ needs.supply-chain-integrity.outputs.release-version }}-evidence.tar.gz
            ./sboms/**
