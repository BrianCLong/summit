name: Release Readiness Gate

# AUTHORITATIVE RELEASE GATE for MVP-4
# This workflow provides a single, unambiguous answer: "Is this commit releasable?"
#
# Purpose: Ensure "green means releasable" with no ambiguity
# - Runs on ALL changes (no path-ignore rules)
# - Deterministic, fail-fast behavior
# - Clear diagnostics for any failure
#
# What it guarantees:
# 1. All TypeScript compiles (typecheck)
# 2. All linting rules pass (lint)
# 3. All builds succeed (build)
# 4. All unit tests pass (server test:unit)
# 5. All integration tests pass with coverage (server test:ci)
# 6. All workflow files are valid (actionlint)
# 7. Required workflows trigger on critical changes
#
# When it runs:
# - Every PR to main
# - Every push to main
# - Manual trigger (workflow_dispatch)

on:
  pull_request:
    branches: [main]
    # CRITICAL: NO paths-ignore rules
    # This gate MUST run on every change to guarantee release readiness
  push:
    branches: [main]
    # CRITICAL: NO paths-ignore rules
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.merge_group.head_sha || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  release-readiness:
    name: Release Readiness Gate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # v4
        # version is read from package.json packageManager field

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          cache: 'pnpm'
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Download actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv ./actionlint /usr/local/bin/
          actionlint -version

      - name: Run Release Readiness Checks
        id: readiness
        run: |
          echo "Starting Release Readiness Gate..."
          echo ""

          # Step 1: GA Verification (typecheck, lint, build, unit tests)
          echo "::group::GA Verification (typecheck, lint, build, unit tests)"
          pnpm ga:verify
          echo "::endgroup::"
          echo ""

          # Step 2: Server CI Tests (full test suite with coverage)
          echo "::group::Server CI Tests (full test suite with coverage)"
          pnpm --filter intelgraph-server test:ci
          echo "::endgroup::"
          echo ""

          # Step 3: Workflow Validation (actionlint)
          echo "::group::Workflow Validation (actionlint)"
          actionlint -color -verbose .github/workflows/**/*.yml .github/workflows/*.yml || {
            echo "::error::Workflow validation failed. Run 'actionlint .github/workflows/' locally to debug."
            exit 1
          }
          echo "::endgroup::"
          echo ""

          # Step 4: Workflow Filter Safety Check
          echo "::group::Workflow Filter Safety Check"
          bash scripts/ci/validate-workflow-filters.sh
          echo "::endgroup::"
          echo ""

          echo "✅ All release readiness checks passed"

      - name: Generate Release Readiness Summary
        if: always()
        run: |
          mkdir -p artifacts/release-readiness

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)

          # Determine status
          if [ "${{ steps.readiness.outcome }}" == "success" ]; then
            STATUS="✅ RELEASABLE"
            STATUS_EMOJI="✅"
            STATUS_COLOR="green"
          else
            STATUS="❌ NOT RELEASABLE"
            STATUS_EMOJI="❌"
            STATUS_COLOR="red"
          fi

          # Create summary artifact
          cat > artifacts/release-readiness/summary.md <<EOF
          # Release Readiness Report

          **Status:** $STATUS
          **Commit:** \`$COMMIT_SHA\`
          **Message:** $COMMIT_MSG
          **Timestamp:** $TIMESTAMP
          **Workflow:** ${{ github.workflow }} (#${{ github.run_number }})

          ## Checks Performed

          | Check | Description | Status |
          |-------|-------------|--------|
          | TypeCheck | All TypeScript compiles without errors | $STATUS_EMOJI |
          | Lint | All ESLint and Ruff rules pass | $STATUS_EMOJI |
          | Build | All packages build successfully | $STATUS_EMOJI |
          | Unit Tests | All unit tests pass | $STATUS_EMOJI |
          | CI Tests | Full test suite with coverage | $STATUS_EMOJI |
          | Workflow Lint | All GitHub Actions workflows are valid | $STATUS_EMOJI |
          | Filter Safety | Required workflows trigger on critical changes | $STATUS_EMOJI |

          ## Guarantees

          When this check is **green**, the following is guaranteed:

          - ✅ All code compiles without TypeScript errors
          - ✅ All linting rules are satisfied
          - ✅ All packages build successfully
          - ✅ All unit tests pass
          - ✅ All integration tests pass with adequate coverage
          - ✅ All CI workflows are valid and will not break
          - ✅ Required checks cannot be bypassed by path filters

          ## Next Steps

          EOF

          if [ "${{ steps.readiness.outcome }}" == "success" ]; then
            cat >> artifacts/release-readiness/summary.md <<EOF
          This commit is **RELEASABLE**. You may:
          - Merge this PR to main
          - Tag a release from this commit
          - Deploy to production with confidence

          **Green means releasable. No ambiguity.**
          EOF
          else
            cat >> artifacts/release-readiness/summary.md <<EOF
          This commit is **NOT RELEASABLE**. Action required:
          - Review failed checks in the workflow logs above
          - Fix all issues locally before pushing
          - Re-run the workflow after fixes

          **Red means not releasable. Fix before merge.**
          EOF
          fi

          # Add to job summary
          cat artifacts/release-readiness/summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Release Readiness Artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: release-readiness-report
          path: artifacts/release-readiness/
          retention-days: 30

      - name: Update PR Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('artifacts/release-readiness/summary.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Release Readiness Report')
            );

            const commentBody = `<!-- release-readiness-bot -->\n${summary}`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }
