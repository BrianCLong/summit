name: üõ†Ô∏è Reusable Toolchain Setup (Node + PNPM)

# Reusable workflow to detect Node version and set up toolchain
# Auto-detects from .nvmrc or package.json engines, with fallback to Node 20

on:
  workflow_call:
    inputs:
      node-version-file:
        description: "Path to .nvmrc or package.json (optional, defaults to auto-detect)"
        required: false
        type: string
      pnpm-version:
        description: "PNPM version (optional, defaults to repo pin)"
        required: false
        type: string
        default: "9.12.0"
      install-deps:
        description: "Whether to install dependencies (defaults to true)"
        required: false
        type: boolean
        default: true
    outputs:
      node-version:
        description: "The detected/resolved Node.js version"
        value: ${{ jobs.toolchain.outputs.node }}
      pnpm-version:
        description: "The resolved pnpm version"
        value: ${{ jobs.toolchain.outputs.pnpm }}

permissions:
  contents: read

jobs:
  toolchain:
    name: Detect and Setup Toolchain
    runs-on: ubuntu-latest
    outputs:
      node: ${{ steps.detect.outputs.version }}
      pnpm: ${{ steps.resolve-pnpm.outputs.pnpm }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # v6

      - name: Install Git 2.47.1+ and disable bundle URIs
        shell: bash
        run: |
          set -euo pipefail
          sudo add-apt-repository ppa:git-core/ppa -y
          sudo apt-get update
          sudo apt-get install -y git
          git --version
          git config --global transfer.bundleURI false
          required_version="2.47.1"
          current_version="$(git --version | awk '{print $3}')"
          if [[ "$(printf '%s\n' "$required_version" "$current_version" | sort -V | head -n1)" != "$required_version" ]]; then
            echo "::error::Git version $current_version is below required $required_version."
            exit 1
          fi
          if [[ "$(git config --global --get transfer.bundleURI)" != "false" ]]; then
            echo "::error::transfer.bundleURI must be disabled."
            exit 1
          fi

      - name: Detect Node.js version
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          # Priority 1: Check for .nvmrc
          if [[ -f .nvmrc ]]; then
            v=$(tr -d 'v' < .nvmrc | xargs)
            echo "‚úÖ Detected from .nvmrc: $v"

          # Priority 2: Check for package.json engines.node
          elif command -v jq >/dev/null 2>&1 && jq -e '.engines.node' package.json >/dev/null 2>&1; then
            v=$(jq -r '.engines.node' package.json | sed 's/[^0-9.]*//' | sed 's/\.x$//' | xargs)
            echo "‚úÖ Detected from package.json engines: $v"

          # Priority 3: Fallback to Node 20 (LTS)
          else
            v=20
            echo "‚ö†Ô∏è  No .nvmrc or engines.node found, using fallback: Node $v"
          fi

          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "üöÄ Will use Node.js version: $v"

      - name: Resolve pnpm version
        id: resolve-pnpm
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.pnpm-version }}" ]; then
            echo "pnpm=${{ inputs.pnpm-version }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if command -v jq >/dev/null 2>&1 && [ -f package.json ]; then
            pkg_manager=$(jq -r '.packageManager // ""' package.json)
            if [[ "$pkg_manager" == pnpm@* ]]; then
              echo "pnpm=${pkg_manager#pnpm@}" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "pnpm=9.12.0" >> "$GITHUB_OUTPUT"
          echo "‚ö†Ô∏è  Falling back to pinned pnpm 9.12.0"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # v4
        with:
          # version handled by package.json
          run_install: ${{ inputs.install-deps }}

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Log toolchain versions
        shell: bash
        run: |
          echo "üîß Toolchain Summary:"
          echo "  Node.js: $(node --version)"
          echo "  PNPM: $(pnpm --version) (requested ${{ steps.resolve-pnpm.outputs.pnpm }})"
          echo "  npm: $(npm --version)"
          echo ""
          echo "üì¶ pnpm store location:"
          pnpm store path

      - name: Cache validation
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "pnpm-lock.yaml" ]; then
            echo "‚úÖ pnpm-lock.yaml found"
          else
            echo "::warning::No pnpm-lock.yaml detected; pnpm cache may not be effective"
          fi
