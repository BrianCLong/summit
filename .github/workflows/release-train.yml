name: release-train

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "stage|prod"
        required: true
        default: "stage"

jobs:
  parity_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -fsSL https://get.helm.sh/helm-v3.15.2-linux-amd64.tar.gz | tar zx
          sudo mv linux-amd64/helm /usr/local/bin/
          curl -fsSL https://releases.hashicorp.com/terraform/1.8.5/terraform_1.8.5_linux_amd64.zip -o tf.zip
          unzip tf.zip
          sudo mv terraform /usr/local/bin/
      - name: IaC plan diff (stage vs prod)
        run: |
          mkdir -p artifacts
          scripts/ci/iac_plan_diff.sh scripts/ci/envs/stage scripts/ci/envs/prod > artifacts/iac.diff
          scripts/ci/deny_on_drift.sh artifacts/iac.diff
      - name: Secret parity check
        run: scripts/ci/secret_matrix_check.sh scripts/ci/configs/secrets.stage.json scripts/ci/configs/secrets.prod.json

  third_party_status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check provider status
        id: gate
        run: scripts/ci/provider_status_gate.sh scripts/ci/configs/providers.yaml
    outputs:
      ok: ${{ steps.gate.outputs.ok }}

  build_and_sign:
    needs: [parity_audit, third_party_status]
    if: ${{ always() && needs.third_party_status.outputs.ok == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.DIGEST }}
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        id: build
        run: |
          docker build -t registry/app:${{ github.sha }} .
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' registry/app:${{ github.sha }})
          echo "DIGEST=$DIGEST" >> $GITHUB_OUTPUT
      - name: Generate provenance
        run: scripts/ci/release-train/provenance_attest.sh ${{ steps.build.outputs.DIGEST }}
      - name: Push + record artifact
        run: scripts/ci/release-train/publish_and_record.sh ${{ steps.build.outputs.DIGEST }} scripts/ci/records/artifacts.json

  canary_rollout:
    needs: build_and_sign
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy canary (10%)
        run: scripts/ci/release-train/deploy.sh --env=${{ inputs.target_env }} --strategy=canary --percent=10 --digest=${{ needs.build_and_sign.outputs.digest }}
      - name: Pre-bake probes
        run: scripts/ci/release-train/probes.sh --env=${{ inputs.target_env }} --mode=pre --timeout=10m
      - name: Error-budget gate
        run: scripts/ci/release-train/error_budget_gate.sh --window=30m --env=${{ inputs.target_env }}

  progressive_rollout:
    needs: canary_rollout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Step up 25% → 50% → 100%
        run: scripts/ci/release-train/progressive.sh --env=${{ inputs.target_env }} --digest=${{ needs.build_and_sign.outputs.digest }}

  post_deploy_verification:
    needs: progressive_rollout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Post-deploy probes (latency/error rates/log SLOs)
        run: scripts/ci/release-train/probes.sh --env=${{ inputs.target_env }} --mode=post --timeout=20m
      - name: Enforce rollback on SLO breach
        run: scripts/ci/release-train/rollback_if_needed.sh --env=${{ inputs.target_env }}
