name: RC Preparation

# Deterministic RC Preparation Pipeline
# Prepares an MVP-4 stabilization release candidate with full artifact bundle.
#
# This workflow:
# 1. Runs release readiness verification
# 2. Computes the next RC tag deterministically
# 3. Generates an RC Preparation Bundle artifact
# 4. Does NOT create tags (operator runs commands.sh from bundle)
#
# See docs/ci/RC_PREPARATION.md for full documentation.

on:
  workflow_dispatch:
    inputs:
      base_version:
        description: "Base version (e.g., 4.1.2)"
        required: false
        default: ""
        type: string
      commit_sha:
        description: "Target commit SHA (default: main HEAD)"
        required: false
        default: ""
        type: string
      dry_run:
        description: "Dry run mode (no tag creation)"
        required: false
        default: true
        type: boolean
      skip_verification:
        description: "Skip release readiness check"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  actions: read

jobs:
  prepare-rc:
    name: Prepare Release Candidate
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.prepare.outputs.tag }}
      commit_sha: ${{ steps.params.outputs.commit_sha }}
      artifact_name: ${{ steps.prepare.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.commit_sha || 'main' }}

      - name: Determine Parameters
        id: params
        run: |
          # Determine commit SHA
          if [[ -n "${{ inputs.commit_sha }}" ]]; then
            COMMIT_SHA="${{ inputs.commit_sha }}"
          else
            COMMIT_SHA=$(git rev-parse HEAD)
          fi
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHA:0:7}" >> $GITHUB_OUTPUT

          # Determine version
          if [[ -n "${{ inputs.base_version }}" ]]; then
            VERSION="${{ inputs.base_version }}"
          else
            # Auto-detect from package.json or tags
            VERSION=$(grep '"version"' package.json | head -n1 | sed 's/.*"version": "\(.*\)".*/\1/' | cut -d'-' -f1)
          fi
          echo "base_version=${VERSION}" >> $GITHUB_OUTPUT

          echo "Commit SHA: ${COMMIT_SHA}"
          echo "Base Version: ${VERSION}"

      - name: Install pnpm
        uses: pnpm/action-setup@v4 # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          cache: 'pnpm'
          node-version: 20

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Release Readiness Check
        if: ${{ !inputs.skip_verification }}
        id: verify
        run: |
          echo "Running release readiness verification..."

          # Try pnpm release:ready if available, otherwise run individual checks
          if pnpm run release:ready 2>/dev/null; then
            echo "âœ… Release readiness check passed"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ release:ready not available, running fallback checks..."
            # Fallback: run typecheck and build
            pnpm run typecheck || true
            pnpm --filter intelgraph-server build || true
            echo "status=fallback" >> $GITHUB_OUTPUT
          fi

      - name: Prepare RC Bundle
        id: prepare
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/release/prepare-stabilization-rc.sh

          COMMIT_SHA="${{ steps.params.outputs.commit_sha }}"
          BASE_VERSION="${{ steps.params.outputs.base_version }}"

          # Build version argument if base_version provided
          VERSION_ARG=""
          if [[ -n "${BASE_VERSION}" ]]; then
            # Compute next RC number
            EXISTING_RC=$(git tag -l "v${BASE_VERSION}-rc.*" --sort=-v:refname | head -n1 || echo "")
            if [[ -n "${EXISTING_RC}" ]]; then
              # Increment RC number
              RC_NUM=$(echo "${EXISTING_RC}" | sed -E 's/.*-rc\.([0-9]+)$/\1/')
              NEXT_RC=$((RC_NUM + 1))
            else
              NEXT_RC=1
            fi
            VERSION_ARG="--version v${BASE_VERSION}-rc.${NEXT_RC}"
          fi

          # Run preparation script
          OUTPUT=$(./scripts/release/prepare-stabilization-rc.sh \
            --dry-run \
            --json \
            --commit "${COMMIT_SHA}" \
            ${VERSION_ARG} 2>&1) || true

          echo "${OUTPUT}"

          # Parse JSON output (last line)
          JSON_LINE=$(echo "${OUTPUT}" | tail -1)

          if echo "${JSON_LINE}" | jq -e '.tag' >/dev/null 2>&1; then
            TAG=$(echo "${JSON_LINE}" | jq -r '.tag')
            ARTIFACT_DIR=$(echo "${JSON_LINE}" | jq -r '.artifact_dir')
          else
            echo "::error::Failed to parse script output"
            exit 1
          fi

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "artifact_dir=${ARTIFACT_DIR}" >> $GITHUB_OUTPUT
          echo "artifact_name=rc-prep-bundle-${TAG}" >> $GITHUB_OUTPUT

          echo "Generated RC: ${TAG}"
          echo "Artifacts: ${ARTIFACT_DIR}"

      - name: Capture Verification Status
        if: always()
        run: |
          TAG="${{ steps.prepare.outputs.tag }}"
          ARTIFACT_DIR="${{ steps.prepare.outputs.artifact_dir }}"
          COMMIT_SHA="${{ steps.params.outputs.commit_sha }}"

          # Try to capture verification truth table if script exists
          if [[ -f scripts/release/verify-green-for-tag.sh ]]; then
            chmod +x scripts/release/verify-green-for-tag.sh
            ./scripts/release/verify-green-for-tag.sh \
              --tag "${TAG}" \
              --commit "${COMMIT_SHA}" > "${ARTIFACT_DIR}/required_checks_snapshot.txt" 2>&1 || true
          else
            echo "Verification script not available" > "${ARTIFACT_DIR}/required_checks_snapshot.txt"
          fi

      - name: Upload RC Bundle Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ steps.prepare.outputs.artifact_name }}
          path: ${{ steps.prepare.outputs.artifact_dir }}
          retention-days: 90

      - name: Job Summary
        run: |
          TAG="${{ steps.prepare.outputs.tag }}"
          COMMIT_SHA="${{ steps.params.outputs.commit_sha }}"
          ARTIFACT_NAME="${{ steps.prepare.outputs.artifact_name }}"

          echo "### ðŸ“¦ RC Preparation Bundle: ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RC Tag | \`${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${COMMIT_SHA:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | \`${ARTIFACT_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“‹ Bundle Contents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`commands.sh\` | Executable script to create and push RC tag |" >> $GITHUB_STEP_SUMMARY
          echo "| \`github_release.md\` | Release notes for GitHub Release |" >> $GITHUB_STEP_SUMMARY
          echo "| \`summary.json\` | Machine-readable bundle metadata |" >> $GITHUB_STEP_SUMMARY
          echo "| \`commits.txt\` | List of commits in this RC |" >> $GITHUB_STEP_SUMMARY
          echo "| \`evidence.json\` | Verification commands and CI references |" >> $GITHUB_STEP_SUMMARY
          echo "| \`required_checks_snapshot.txt\` | CI verification status |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš€ How to Create the RC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`${ARTIFACT_NAME}\` artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract and navigate to the bundle directory" >> $GITHUB_STEP_SUMMARY
          echo "3. Run the commands:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Create and push the RC tag" >> $GITHUB_STEP_SUMMARY
          echo "chmod +x commands.sh" >> $GITHUB_STEP_SUMMARY
          echo "./commands.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Œ Individual Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Step 1: Create the annotated tag" >> $GITHUB_STEP_SUMMARY
          echo "git tag -a ${TAG} ${COMMIT_SHA} -m 'MVP-4 Stabilization RC ${TAG}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Step 2: Push the tag" >> $GITHUB_STEP_SUMMARY
          echo "git push origin ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Step 3: Create GitHub Release (optional)" >> $GITHUB_STEP_SUMMARY
          echo "gh release create ${TAG} --prerelease --title '${TAG} - MVP-4 Stabilization RC'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
