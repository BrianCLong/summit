name: Agent Guardrails

on:
  pull_request:
    branches: [ main ]

jobs:
  pr-metadata-check:
    name: Check PR Metadata
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9.12.0
          run_install: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 20
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      # ... other steps ...

  pii-scan:
    name: Scan for PII
    runs-on: ubuntu-latest
    continue-on-error: true # Rate limits are common
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9.12.0
          run_install: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 20
      - uses: actions/github-script@v7
        with:
          script: |
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            // Return JSON string of filenames to handle spaces safely
            return JSON.stringify(files.map(f => f.filename));
          result-encoding: string

  s-aos-enforcement:
    name: S-AOS Enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9.12.0
          run_install: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 20
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
