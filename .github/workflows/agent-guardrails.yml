name: agent-guardrails

on:
  pull_request:
    types: [opened, reopened, synchronize, edited, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read

jobs:
  guardrails:
    name: Agent Guardrails Enforcement
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # v6

      - name: Setup Node
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"

      - name: Get PR details and changed files
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            // Output filenames for other steps
            core.setOutput('files', JSON.stringify(files.map(f => f.filename)));

            // Check for restricted path violations
            const fs = require('fs');
            let contract;
            try {
              contract = JSON.parse(fs.readFileSync('agent-contract.json', 'utf8'));
            } catch (error) {
              core.setFailed('Failed to parse agent-contract.json: ' + error.message);
              return;
            }

            const restrictedAreas = contract.restrictedAreas || [];
            const restrictedPrefixes = restrictedAreas.flatMap(area => area.paths);
            const overrideLabels = restrictedAreas.map(area => area.overrideLabel).filter(Boolean);
            const overrideToken = '"restricted_override": true';
            const labels = (pr.labels || []).map(label => label.name);
            const hasOverride = labels.some(l => overrideLabels.includes(l)) || (pr.body || '').includes(overrideToken);

            if (!hasOverride) {
              const violations = files
                .map(file => file.filename)
                .filter(name => restrictedPrefixes.some(prefix => name.startsWith(prefix)));

              if (violations.length > 0) {
                core.error(`Restricted paths modified without override: ${violations.join(', ')}. ` +
                  `Add a relevant override label or include ${overrideToken} in the AGENT-METADATA block with justification.`);
                process.exitCode = 1;
              }
            } else {
              core.info('Restricted path override detected.');
            }

      - name: Check PR Metadata
        if: always()
        run: node scripts/ga/check-pr-metadata.mjs
        env:
          PR_BODY: ${{ github.event.pull_request.body }}

      - name: Verify S-AOS Compliance
        if: always()
        run: node scripts/ga/verify-saos.mjs
        env:
          PR_BODY: ${{ github.event.pull_request.body }}

      - name: Scan for PII
        if: always()
        run: |
          files='${{ steps.pr_details.outputs.files }}'
          echo "$files" | jq -r '.[]' | xargs -d '\n' node scripts/ga/scan-pii.mjs
