name: GA Evidence Pack with OIDC Attestations

# Generates cryptographically verifiable GA Evidence Pack with OIDC attestations
# Uses keyless signing (Sigstore/cosign) with GitHub OIDC tokens
# Non-publishing by default - attestations stored as artifacts

on:
  # Primary trigger: manual workflow dispatch
  workflow_dispatch:
    inputs:
      create_tarball:
        description: "Create evidence tarball"
        type: boolean
        default: true
      check_determinism:
        description: "Verify deterministic build"
        type: boolean
        default: false

  # Optional: trigger on main branch (for testing)
  # Uncomment to enable automatic attestation on main pushes
  # push:
  #   branches: ["main"]

# LEAST-PRIVILEGE PERMISSIONS:
# - Top-level: read-only by default
# - generate-pack job: contents read only (no signing)
# - attest job: id-token write for OIDC signing
permissions:
  contents: read

env:
  # Sigstore experimental mode for keyless signing
  COSIGN_EXPERIMENTAL: "1"

jobs:
  # Job 1: Generate Evidence Pack (no special permissions needed)
  generate-pack:
    name: Generate Evidence Pack
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read  # For evidence collection (release blockers)
    outputs:
      evidence_hash: ${{ steps.pack.outputs.evidence_hash }}
      run_timestamp: ${{ steps.pack.outputs.timestamp }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6
        with:
          fetch-depth: 0  # Full history for git metadata

      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # v4      - name: Setup Node.js
        uses: actions/setup-node@v4 # v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install syft (SBOM generator)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.4.1

      - name: Install gitleaks (secret scanner)
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Generate Evidence Pack
        id: pack
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ github.event.repository.updated_at }}
        run: |
          chmod +x scripts/release/generate_ga_evidence_pack.sh

          PACK_ARGS="--output dist/ga-evidence"

          if [[ "${{ inputs.create_tarball }}" == "true" ]]; then
            PACK_ARGS="$PACK_ARGS --tarball"
          fi

          if [[ "${{ inputs.check_determinism }}" == "true" ]]; then
            PACK_ARGS="$PACK_ARGS --check-determinism"
          fi

          # Generate evidence pack
          ./scripts/release/generate_ga_evidence_pack.sh $PACK_ARGS --verbose

          # Capture evidence hash for verification
          EVIDENCE_HASH=$(sha256sum dist/ga-evidence/evidence.sha256 | cut -d' ' -f1)
          echo "evidence_hash=${EVIDENCE_HASH}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

          echo "Evidence pack hash: ${EVIDENCE_HASH}"

      - name: Upload Evidence Pack
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ga-evidence-pack-${{ github.run_id }}
          path: dist/ga-evidence/
          retention-days: 90
          if-no-files-found: error

      - name: Job Summary
        run: |
          echo "### ðŸ“¦ GA Evidence Pack Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Evidence Hash:** \`${{ steps.pack.outputs.evidence_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f "dist/ga-evidence/manifest.json" ]]; then
            echo "#### Manifest" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat dist/ga-evidence/manifest.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Attest Evidence Pack (requires id-token: write)
  attest:
    name: Attest with OIDC
    runs-on: ubuntu-latest
    needs: generate-pack
    # CRITICAL: Only this job has id-token: write
    permissions:
      contents: read
      id-token: write  # Required for OIDC keyless signing
    outputs:
      attestation_status: ${{ steps.attest.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v6

      - name: Download Evidence Pack
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: ga-evidence-pack-${{ github.run_id }}
          path: dist/ga-evidence/

      - name: Install Cosign
        uses: sigstore/cosign-installer@f713795cb21599bc4e5c4b58cbad1da852d7eeb9 # v3
        with:
          cosign-release: v2.2.4

      - name: Verify Cosign Installation
        run: |
          cosign version
          echo "OIDC token URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:0:50}..."

      - name: Generate Attestations
        id: attest
        env:
          # GitHub OIDC token automatically available in Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/release/attest_ga_evidence.sh

          # Generate OIDC attestations
          ./scripts/release/attest_ga_evidence.sh \
            --evidence-dir dist/ga-evidence \
            --verbose

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Verify Attestations
        run: |
          chmod +x scripts/release/verify_ga_evidence_attestations.sh

          # Verify attestations were generated correctly
          ./scripts/release/verify_ga_evidence_attestations.sh \
            --evidence-dir dist/ga-evidence \
            --expected-repo "${{ github.repository }}" \
            --verbose

      - name: Upload Attestations
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ga-evidence-attestations-${{ github.run_id }}
          path: dist/ga-evidence/attestations/
          retention-days: 90
          if-no-files-found: error

      - name: Upload Complete Evidence Bundle
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ga-evidence-complete-${{ github.run_id }}
          path: dist/ga-evidence/
          retention-days: 90
          if-no-files-found: error

      - name: Job Summary
        run: |
          echo "### ðŸ” Attestations Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f "dist/ga-evidence/attestations/attestation-manifest.json" ]]; then
            echo "#### Attestation Manifest" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat dist/ga-evidence/attestations/attestation-manifest.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`ga-evidence-complete-${{ github.run_id }}\` artifact and run:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd attestations && cat verify.md" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 3: Final Summary
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [generate-pack, attest]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Workflow Summary
        run: |
          echo "# GA Evidence Pack Attestation Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Evidence Generation | ${{ needs.generate-pack.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.generate-pack.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OIDC Attestation | ${{ needs.attest.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.attest.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.attest.result }}" == "success" ]]; then
            echo "## âœ… Attestation Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- \`ga-evidence-complete-${{ github.run_id }}\`: Full evidence pack with attestations" >> $GITHUB_STEP_SUMMARY
            echo "- \`ga-evidence-attestations-${{ github.run_id }}\`: Attestations only" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Trust Anchor" >> $GITHUB_STEP_SUMMARY
            echo "- **OIDC Issuer:** \`https://token.actions.githubusercontent.com\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Run ID:** \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Verification" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download \`ga-evidence-complete-${{ github.run_id }}\` and verify:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Verify checksums" >> $GITHUB_STEP_SUMMARY
            echo "sha256sum -c evidence.sha256" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Verify attestations" >> $GITHUB_STEP_SUMMARY
            echo "cd attestations" >> $GITHUB_STEP_SUMMARY
            echo "cosign verify-blob-attestation \\" >> $GITHUB_STEP_SUMMARY
            echo "  --certificate-identity-regexp 'https://github.com/${{ github.repository }}/.github/workflows/.*' \\" >> $GITHUB_STEP_SUMMARY
            echo "  --certificate-oidc-issuer 'https://token.actions.githubusercontent.com' \\" >> $GITHUB_STEP_SUMMARY
            echo "  --type slsaprovenance \\" >> $GITHUB_STEP_SUMMARY
            echo "  --bundle provenance.intoto.jsonl \\" >> $GITHUB_STEP_SUMMARY
            echo "  ../evidence.sha256" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See \`attestations/verify.md\` for complete verification instructions." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Attestation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check job logs for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This workflow does NOT publish or tag releases. Attestations are stored as artifacts only." >> $GITHUB_STEP_SUMMARY
