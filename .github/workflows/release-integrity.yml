name: Release Integrity

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true
jobs:
  integrity:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: npm install tsx --no-save

      - name: Generate SBOM
        run: npx tsx scripts/compliance/generate_sbom.ts

      - name: Sign Artifacts
        run: npx tsx scripts/compliance/sign_artifacts.ts

      - name: Vulnerability Scan & OPA Input Generation
        run: npx tsx scripts/security/mock_scan.ts

      - name: Policy Gate (OPA)
        run: |
          # Install OPA
          curl -L -o opa https://openpolicyagent.org/downloads/v0.60.0/opa_linux_amd64_static
          chmod +x opa

          # Evaluate Policy
          ./opa eval -i .evidence/results/input.json -d policy/release-gates/ "data.release_gates.allow" | grep "true" || exit 1
