name: Release Integrity

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      - uses: pnpm/action-setup@feaa6391d8481eb0db9d5b066fba94be3691684c # v4
      - uses: actions/setup-node@1d1121627393d3093b167069a74422b94a9ec3f2 # v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: npm install tsx --no-save

      - name: Generate SBOM
        run: npx tsx scripts/compliance/generate_sbom.ts

      - name: Sign Artifacts
        run: npx tsx scripts/compliance/sign_artifacts.ts

      - name: Vulnerability Scan & OPA Input Generation
        run: npx tsx scripts/security/mock_scan.ts

      - name: Policy Gate (OPA)
        run: |
          # Install OPA
          curl -L -o opa https://openpolicyagent.org/downloads/v0.60.0/opa_linux_amd64_static
          chmod +x opa

          # Evaluate Policy
          ./opa eval -i .evidence/results/input.json -d policy/release-gates/ "data.release_gates.allow" | grep "true" || exit 1
