name: Maintainability Metrics Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:

concurrency:
  group: maintainability-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'

jobs:
  # Quick sanity check - validates setup exists
  sanity-check:
    name: Sanity Check
    runs-on: ubuntu-latest
    outputs:
      has-config: ${{ steps.check.outputs.has_config }}
      has-scripts: ${{ steps.check.outputs.has_scripts }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts
            .eslintrc.complexity.cjs
            package.json
          sparse-checkout-cone-mode: false

      - name: Check required files
        id: check
        run: |
          echo "Checking maintainability setup..."

          HAS_CONFIG="false"
          HAS_SCRIPTS="false"

          if [ -f ".eslintrc.complexity.cjs" ]; then
            echo "âœ“ ESLint complexity config found"
            HAS_CONFIG="true"
          fi

          if [ -f "scripts/maintainability-report.cjs" ]; then
            echo "âœ“ Report script found"
            HAS_SCRIPTS="true"
          fi

          echo "has_config=$HAS_CONFIG" >> $GITHUB_OUTPUT
          echo "has_scripts=$HAS_SCRIPTS" >> $GITHUB_OUTPUT

          echo ""
          echo "Config ready: $HAS_CONFIG"
          echo "Scripts ready: $HAS_SCRIPTS"

  # Main metrics job - lightweight, always succeeds
  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    needs: sanity-check
    outputs:
      large-files: ${{ steps.analyze.outputs.large_files }}
      todo-count: ${{ steps.analyze.outputs.todo_count }}
      total-files: ${{ steps.analyze.outputs.total_files }}
    steps:
      - uses: actions/checkout@v4

      - name: Install cloc
        run: sudo apt-get install -y -qq cloc 2>/dev/null || true

      - name: Analyze codebase
        id: analyze
        run: |
          mkdir -p reports

          # Find source directories that exist
          DIRS=""
          for d in server/src client/src apps packages services; do
            [ -d "$d" ] && DIRS="$DIRS $d"
          done

          # Default values
          LARGE_FILES=0
          TODO_COUNT=0
          TOTAL_FILES=0

          if [ -n "$DIRS" ]; then
            # Count total files
            TOTAL_FILES=$(find $DIRS -type f \( -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" \) \
              -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*" 2>/dev/null | wc -l)

            # Count large files
            LARGE_FILES=$(find $DIRS -type f \( -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" \) \
              -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*" \
              -exec wc -l {} \; 2>/dev/null | awk '$1 > 500' | wc -l)

            # Count TODOs
            TODO_COUNT=$(grep -r "TODO\|FIXME" $DIRS \
              --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" \
              --exclude-dir=node_modules --exclude-dir=dist 2>/dev/null | wc -l || echo 0)

            # Generate LOC report
            if command -v cloc &> /dev/null; then
              cloc --exclude-dir=node_modules,dist,build,coverage,.turbo --json --out=reports/cloc.json $DIRS 2>/dev/null || true
              cloc --exclude-dir=node_modules,dist,build,coverage,.turbo --md $DIRS 2>/dev/null > reports/loc.md || true
            fi
          fi

          # Output metrics
          echo "large_files=$LARGE_FILES" >> $GITHUB_OUTPUT
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT

          # Create summary report
          cat > reports/metrics-summary.md << EOF
          # Code Metrics Summary

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}

          ## Key Metrics

          | Metric | Value |
          |--------|-------|
          | Total Files | $TOTAL_FILES |
          | Large Files (>500 lines) | $LARGE_FILES |
          | Technical Debt Markers | $TODO_COUNT |

          ## Status

          EOF

          if [ "$LARGE_FILES" -gt 100 ]; then
            echo "- âš ï¸ High number of large files" >> reports/metrics-summary.md
          else
            echo "- âœ… Large files within acceptable range" >> reports/metrics-summary.md
          fi

          if [ "$TODO_COUNT" -gt 200 ]; then
            echo "- âš ï¸ High technical debt" >> reports/metrics-summary.md
          else
            echo "- âœ… Technical debt manageable" >> reports/metrics-summary.md
          fi

          echo ""
          echo "ðŸ“Š Metrics Summary:"
          echo "   Total Files: $TOTAL_FILES"
          echo "   Large Files: $LARGE_FILES"
          echo "   TODOs: $TODO_COUNT"

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics
          path: reports/
          retention-days: 30

  # Generate full report (if script exists)
  full-report:
    name: Full Report
    runs-on: ubuntu-latest
    needs: [sanity-check, code-metrics]
    if: needs.sanity-check.outputs.has-scripts == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate report
        run: |
          mkdir -p reports
          if [ -f "scripts/maintainability-report.cjs" ]; then
            node scripts/maintainability-report.cjs --output=reports/full-report.md --json 2>/dev/null || \
            echo "# Report Generation\n\nScript execution had issues. See code-metrics for basic data." > reports/full-report.md
          fi

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: full-report
          path: reports/
          retention-days: 30

  # Post summary to PR
  summary:
    name: Post Summary
    runs-on: ubuntu-latest
    needs: [code-metrics]
    if: github.event_name == 'pull_request'
    steps:
      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š Maintainability Metrics

          | Metric | Value |
          |--------|-------|
          | **Total Files** | ${{ needs.code-metrics.outputs.total-files }} |
          | **Large Files (>500 lines)** | ${{ needs.code-metrics.outputs.large-files }} |
          | **Technical Debt (TODO/FIXME)** | ${{ needs.code-metrics.outputs.todo-count }} |

          ### Quick Assessment

          EOF

          LARGE=${{ needs.code-metrics.outputs.large-files }}
          TODOS=${{ needs.code-metrics.outputs.todo-count }}

          if [ "$LARGE" -lt 50 ] && [ "$TODOS" -lt 100 ]; then
            echo "âœ… **Good** - Metrics are within healthy ranges" >> $GITHUB_STEP_SUMMARY
          elif [ "$LARGE" -lt 200 ] && [ "$TODOS" -lt 300 ]; then
            echo "âš ï¸ **Warning** - Some metrics need attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Needs Work** - Consider addressing technical debt" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF

          ---

          *Run \`pnpm run metrics:report\` locally for detailed analysis*
          EOF

  # Weekly report (scheduled only)
  weekly-report:
    name: Weekly Report
    runs-on: ubuntu-latest
    needs: [code-metrics, full-report]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: Create weekly report
        run: |
          DATE=$(date +"%Y-%m-%d")

          cat > weekly-report.md << EOF
          # ðŸ“Š Weekly Maintainability Report

          **Date:** $DATE
          **Repository:** ${{ github.repository }}

          ---

          ## Summary

          | Metric | Value |
          |--------|-------|
          | Total Files | ${{ needs.code-metrics.outputs.total-files }} |
          | Large Files | ${{ needs.code-metrics.outputs.large-files }} |
          | Technical Debt | ${{ needs.code-metrics.outputs.todo-count }} |

          ---

          ## Recommendations

          1. **Large Files** - Break files over 500 lines into smaller modules
          2. **Technical Debt** - Convert TODOs to tracked issues
          3. **Complexity** - Run \`pnpm run metrics:complexity\` locally

          ---

          ## Next Steps

          - Review files over 1000 lines for refactoring opportunities
          - Address FIXME comments as priority items
          - Track trends over time using weekly reports

          ---

          *Generated automatically by maintainability-check workflow*
          EOF

          cat weekly-report.md

      - name: Upload weekly report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_id }}
          path: weekly-report.md
          retention-days: 90

      - name: Create issue (scheduled only)
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];

            let body = '# Weekly Maintainability Report\n\n';
            body += `**Date:** ${date}\n\n`;
            body += `## Metrics\n\n`;
            body += `| Metric | Value |\n|--------|-------|\n`;
            body += `| Total Files | ${{ needs.code-metrics.outputs.total-files }} |\n`;
            body += `| Large Files | ${{ needs.code-metrics.outputs.large-files }} |\n`;
            body += `| Technical Debt | ${{ needs.code-metrics.outputs.todo-count }} |\n\n`;
            body += `---\n\n*Auto-generated by maintainability-check workflow*`;

            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“Š Weekly Maintainability Report - ${date}`,
                body: body,
                labels: ['maintainability', 'automated']
              });
            } catch (e) {
              console.log('Could not create issue:', e.message);
            }
