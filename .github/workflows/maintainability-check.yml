name: Maintainability Metrics Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

concurrency:
  group: maintainability-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  # Job 1: Code Metrics Analysis (always runs, fast)
  code-metrics:
    name: Code Metrics Analysis
    runs-on: ubuntu-latest
    outputs:
      large-files: ${{ steps.metrics.outputs.large_files }}
      todo-count: ${{ steps.metrics.outputs.todo_count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install cloc
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq cloc

      - name: Generate Lines of Code report
        id: loc
        run: |
          mkdir -p reports

          # Generate LOC report - handle missing directories gracefully
          DIRS=""
          for dir in server/src client/src apps packages services; do
            if [ -d "$dir" ]; then
              DIRS="$DIRS $dir"
            fi
          done

          if [ -n "$DIRS" ]; then
            cloc \
              --exclude-dir=node_modules,dist,build,coverage,.turbo,archive,generated \
              --json \
              --out=reports/cloc-report.json \
              $DIRS 2>/dev/null || echo '{"header":{},"SUM":{"code":0}}' > reports/cloc-report.json

            echo "# Lines of Code Report" > reports/metrics-report.md
            echo "" >> reports/metrics-report.md
            echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> reports/metrics-report.md
            echo "" >> reports/metrics-report.md

            cloc \
              --exclude-dir=node_modules,dist,build,coverage,.turbo,archive,generated \
              --md \
              $DIRS 2>/dev/null >> reports/metrics-report.md || true
          else
            echo '{"header":{},"SUM":{"code":0}}' > reports/cloc-report.json
            echo "# Lines of Code Report" > reports/metrics-report.md
            echo "No source directories found." >> reports/metrics-report.md
          fi

      - name: Find large files and count metrics
        id: metrics
        run: |
          echo "" >> reports/metrics-report.md
          echo "---" >> reports/metrics-report.md
          echo "" >> reports/metrics-report.md
          echo "# Large Files (> 500 lines)" >> reports/metrics-report.md
          echo "" >> reports/metrics-report.md
          echo "| File | Lines |" >> reports/metrics-report.md
          echo "|------|-------|" >> reports/metrics-report.md

          LARGE_FILES=0
          for dir in server/src client/src apps packages services; do
            if [ -d "$dir" ]; then
              find "$dir" \
                -type f \( -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" \) \
                -not -path "*/node_modules/*" \
                -not -path "*/dist/*" \
                -not -path "*/build/*" \
                -not -path "*/.turbo/*" \
                -not -path "*/generated/*" \
                -exec wc -l {} \; 2>/dev/null | \
                sort -rn | \
                awk -v count=0 '$1 > 500 {print "| " $2 " | " $1 " |"; count++} END {print count > "/tmp/large_count.txt"}' >> reports/metrics-report.md || true

              if [ -f /tmp/large_count.txt ]; then
                LARGE_FILES=$((LARGE_FILES + $(cat /tmp/large_count.txt)))
              fi
            fi
          done

          echo "large_files=$LARGE_FILES" >> $GITHUB_OUTPUT

          # Count TODO/FIXME comments
          echo "" >> reports/metrics-report.md
          echo "---" >> reports/metrics-report.md
          echo "" >> reports/metrics-report.md
          echo "# Technical Debt (TODO/FIXME)" >> reports/metrics-report.md
          echo "" >> reports/metrics-report.md

          TODO_COUNT=0
          FIXME_COUNT=0

          for dir in server/src client/src apps packages services; do
            if [ -d "$dir" ]; then
              TODO_COUNT=$((TODO_COUNT + $(grep -r "TODO" "$dir" \
                --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" \
                --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=build 2>/dev/null | wc -l || echo 0)))

              FIXME_COUNT=$((FIXME_COUNT + $(grep -r "FIXME" "$dir" \
                --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" \
                --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=build 2>/dev/null | wc -l || echo 0)))
            fi
          done

          TOTAL_DEBT=$((TODO_COUNT + FIXME_COUNT))

          echo "- **TODO comments:** $TODO_COUNT" >> reports/metrics-report.md
          echo "- **FIXME comments:** $FIXME_COUNT" >> reports/metrics-report.md
          echo "- **Total debt markers:** $TOTAL_DEBT" >> reports/metrics-report.md

          echo "todo_count=$TOTAL_DEBT" >> $GITHUB_OUTPUT

          # Summary
          echo "" >> reports/metrics-report.md
          echo "---" >> reports/metrics-report.md
          echo "" >> reports/metrics-report.md
          echo "## Summary" >> reports/metrics-report.md
          echo "" >> reports/metrics-report.md
          echo "- **Large files (>500 lines):** $LARGE_FILES" >> reports/metrics-report.md
          echo "- **Technical debt markers:** $TOTAL_DEBT" >> reports/metrics-report.md

      - name: Upload metrics reports
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics-report
          path: reports/
          retention-days: 30

  # Job 2: ESLint Complexity Check (runs if config exists)
  eslint-complexity:
    name: ESLint Complexity Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the workflow if ESLint has issues
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if complexity config exists
        id: check-config
        run: |
          if [ -f ".eslintrc.complexity.cjs" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "Complexity config not found, skipping ESLint complexity check"
          fi

      - name: Setup pnpm
        if: steps.check-config.outputs.config_exists == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        if: steps.check-config.outputs.config_exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        if: steps.check-config.outputs.config_exists == 'true'
        run: pnpm install --frozen-lockfile=false

      - name: Run ESLint with complexity rules
        if: steps.check-config.outputs.config_exists == 'true'
        id: eslint
        run: |
          mkdir -p reports

          # Try to run ESLint, but don't fail if there are issues
          pnpm exec eslint \
            --config .eslintrc.complexity.cjs \
            --format json \
            --output-file reports/eslint-report.json \
            "server/src/**/*.{js,ts}" \
            "client/src/**/*.{js,jsx,ts,tsx}" \
            2>/dev/null || echo '[]' > reports/eslint-report.json

          # Generate readable report
          node -e "
          const fs = require('fs');
          let report = [];

          try {
            const content = fs.readFileSync('reports/eslint-report.json', 'utf8');
            report = JSON.parse(content);
          } catch (e) {
            console.log('Could not parse ESLint report');
            report = [];
          }

          if (!Array.isArray(report)) report = [];

          const errorCount = report.reduce((sum, f) => sum + (f.errorCount || 0), 0);
          const warningCount = report.reduce((sum, f) => sum + (f.warningCount || 0), 0);

          let md = '# ESLint Complexity Report\n\n';
          md += 'Generated: ' + new Date().toISOString() + '\n\n';
          md += '## Summary\n\n';
          md += '- **Total Errors:** ' + errorCount + '\n';
          md += '- **Total Warnings:** ' + warningCount + '\n';
          md += '- **Files Analyzed:** ' + report.length + '\n\n';

          const filesWithIssues = report.filter(f => (f.errorCount || 0) > 0 || (f.warningCount || 0) > 0);

          if (filesWithIssues.length > 0) {
            md += '## Files with Issues (Top 20)\n\n';
            md += '| File | Errors | Warnings |\n';
            md += '|------|--------|----------|\n';

            filesWithIssues.slice(0, 20).forEach(file => {
              const shortPath = file.filePath.replace(process.cwd() + '/', '');
              md += '| ' + shortPath + ' | ' + (file.errorCount || 0) + ' | ' + (file.warningCount || 0) + ' |\n';
            });
          } else {
            md += '## Result\n\n';
            md += 'No complexity issues found! âœ…\n';
          }

          fs.writeFileSync('reports/complexity-report.md', md);
          console.log(md);
          " || echo "# ESLint Complexity Report\n\nCould not generate report." > reports/complexity-report.md

      - name: Upload ESLint report
        if: steps.check-config.outputs.config_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: eslint-complexity-report
          path: reports/
          retention-days: 30

  # Job 3: Generate Maintainability Report
  maintainability-report:
    name: Generate Maintainability Report
    runs-on: ubuntu-latest
    needs: [code-metrics]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Check if report script exists
        id: check-script
        run: |
          if [ -f "scripts/maintainability-report.cjs" ]; then
            echo "script_exists=true" >> $GITHUB_OUTPUT
          else
            echo "script_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate maintainability report
        run: |
          mkdir -p reports

          if [ -f "scripts/maintainability-report.cjs" ]; then
            node scripts/maintainability-report.cjs \
              --output=reports/maintainability-report.md \
              --json 2>/dev/null || echo "Report generation had issues"
          fi

          # Create fallback report if script failed or doesn't exist
          if [ ! -f "reports/maintainability-report.md" ]; then
            cat > reports/maintainability-report.md << 'REPORT'
          # Maintainability Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Summary

          Report generated from CI metrics.

          - **Large Files:** ${{ needs.code-metrics.outputs.large-files || 'N/A' }}
          - **Technical Debt:** ${{ needs.code-metrics.outputs.todo-count || 'N/A' }} markers

          ## Recommendations

          1. Refactor files over 500 lines into smaller modules
          2. Address TODO/FIXME comments systematically
          3. Run `pnpm run metrics:report` locally for detailed analysis
          REPORT
          fi

      - name: Upload maintainability report
        uses: actions/upload-artifact@v4
        with:
          name: maintainability-report
          path: reports/
          retention-days: 30

  # Job 4: Weekly Summary (only on schedule)
  weekly-summary:
    name: Weekly Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: [code-metrics, eslint-complexity, maintainability-report]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Combine reports
        run: |
          REPORT_DATE=$(date +"%Y-%m-%d")
          REPORT_FILE="weekly-report-${REPORT_DATE}.md"

          cat > "$REPORT_FILE" << EOF
          # Weekly Maintainability Report

          **Date:** ${REPORT_DATE}
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ---

          EOF

          # Append maintainability report if available
          if [ -f "artifacts/maintainability-report/maintainability-report.md" ]; then
            cat artifacts/maintainability-report/maintainability-report.md >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "---" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          fi

          # Append ESLint report if available
          if [ -f "artifacts/eslint-complexity-report/complexity-report.md" ]; then
            cat artifacts/eslint-complexity-report/complexity-report.md >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "---" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          fi

          # Append metrics report if available
          if [ -f "artifacts/code-metrics-report/metrics-report.md" ]; then
            cat artifacts/code-metrics-report/metrics-report.md >> "$REPORT_FILE"
          fi

          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Next Steps" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "1. Review files over 500 lines and plan refactoring" >> "$REPORT_FILE"
          echo "2. Address critical complexity issues" >> "$REPORT_FILE"
          echo "3. Convert TODOs to tracked GitHub issues" >> "$REPORT_FILE"
          echo "4. Run \`pnpm run metrics:all\` locally for detailed analysis" >> "$REPORT_FILE"

          cat "$REPORT_FILE"

      - name: Upload weekly report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-maintainability-report
          path: weekly-report-*.md
          retention-days: 90

      - name: Create GitHub Issue
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];

            // Find the report file
            const files = fs.readdirSync('.').filter(f => f.startsWith('weekly-report-'));
            if (files.length === 0) {
              console.log('No report file found');
              return;
            }

            const reportContent = fs.readFileSync(files[0], 'utf8');

            // Truncate if too long for GitHub issue
            const maxLength = 65000;
            const body = reportContent.length > maxLength
              ? reportContent.substring(0, maxLength) + '\n\n... (truncated)'
              : reportContent;

            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“Š Weekly Maintainability Report - ${date}`,
                body: body,
                labels: ['maintainability', 'automated', 'metrics']
              });
              console.log('Issue created successfully');
            } catch (error) {
              console.log('Could not create issue:', error.message);
            }
