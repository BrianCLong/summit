name: Batch Merge Plan
on:
  schedule: [{ cron: "17 3 * * *" }]  # daily 03:17 UTC
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write
jobs:
  plan-train:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: '18' }
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Auth gh
        run: gh auth setup-git && gh auth status
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
      - name: Batch plan
        run: ./scripts/batch-automerge.sh
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
      - name: Integration train
        run: ./scripts/integration-train.sh
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: batch-merge-reports
          path: reports/