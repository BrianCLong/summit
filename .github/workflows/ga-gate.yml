name: GA Gate

on:
  pull_request:
    branches: [main]
    # SAFETY: Conservative paths-ignore to prevent skipping required checks
    # This workflow MUST run on any code/config/dependency changes
    # Only skip for pure documentation changes
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
      - "LICENSE"
      - ".gitignore"
      # NOTE: We do NOT ignore:
      # - .github/workflows/** (workflow changes must trigger this)
      # - package.json, pnpm-lock.yaml, .pnpmfile.cjs (dependency changes must trigger this)
      # - scripts/**, tools/** (build/test script changes must trigger this)
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ga_gate:
    name: ga / gate
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version is read from package.json packageManager field

      - name: Install Dependencies
        run: |
          make bootstrap

      - name: Run GA Gate
        # CANONICAL ENTRYPOINT: Uses make ga -> scripts/ga-gate.sh
        # This is the official GA verification entrypoint (equivalent to pnpm ga:verify)
        run: |
          make ga

      - name: Generate GA Snapshot
        if: always()
        run: |
          mkdir -p artifacts/ga
          ./scripts/ga/ga-snapshot \
            --out artifacts/ga/ga_snapshot.json \
            --allow-missing \
            --include-ci \
            --include-release

      - name: Upload GA Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ga-report
          path: artifacts/ga/

      - name: Job Summary
        if: always()
        run: |
          if [ -f artifacts/ga/ga_report.md ]; then
            cat artifacts/ga/ga_report.md >> $GITHUB_STEP_SUMMARY
          fi

  ga_evidence_bundle:
    name: ga / evidence-bundle
    runs-on: ubuntu-latest
    needs: ga_gate
    if: ${{ needs.ga_gate.result == 'success' }}
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Collect GA Evidence Bundle
        run: |
          chmod +x scripts/release/collect_evidence.sh
          ./scripts/release/collect_evidence.sh --category all --output artifacts/ga/evidence

      - name: Download GA Report
        uses: actions/download-artifact@v7
        with:
          name: ga-report
          path: ga-report

      - name: Add GA Reports to Evidence Bundle
        run: |
          cp -f ga-report/ga_report.json artifacts/ga/evidence/ga_report.json || true
          cp -f ga-report/ga_snapshot.json artifacts/ga/evidence/ga_snapshot.json || true

      - name: Write Bundle Metadata
        run: |
          node_version=$(node --version)
          pnpm_version=$(pnpm --version)
          generated_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat <<EOF > artifacts/ga/evidence/bundle_metadata.json
          {
            "git_sha": "${GITHUB_SHA}",
            "workflow_run_id": "${GITHUB_RUN_ID}",
            "generated_at_utc": "${generated_at}",
            "tool_versions": {
              "node": "${node_version}",
              "pnpm": "${pnpm_version}"
            }
          }
          EOF

      - name: Upload GA Evidence Bundle
        uses: actions/upload-artifact@v6
        with:
          name: ga-evidence-bundle
          path: artifacts/ga/evidence/
          retention-days: 90
          if-no-files-found: error

  trust_snapshot:
    name: ga / trust-snapshot
    runs-on: ubuntu-latest
    needs: [ga_gate, ga_evidence_bundle]
    if: ${{ needs.ga_gate.result == 'success' }}
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download GA Evidence Bundle
        uses: actions/download-artifact@v7
        with:
          name: ga-evidence-bundle
          path: ga-evidence

      - name: Generate Trust Snapshot
        run: |
          pnpm exec tsx scripts/release/generate_trust_snapshot.ts \
            --bundle ga-evidence \
            --out-dir trust-snapshot \
            --metadata ga-evidence/bundle_metadata.json

      - name: Package Trust Snapshot
        run: |
          zip_name="trust-snapshot_${GITHUB_SHA}_${GITHUB_RUN_ID}.zip"
          cd trust-snapshot
          zip -j "../${zip_name}" trust_snapshot.json trust_snapshot.md
          cd ..
          echo "TRUST_SNAPSHOT_ZIP=${zip_name}" >> $GITHUB_ENV

      - name: Upload Trust Snapshot Archive
        uses: actions/upload-artifact@v6
        with:
          name: trust-snapshot
          path: ${{ env.TRUST_SNAPSHOT_ZIP }}
          retention-days: 30
          if-no-files-found: error

      - name: Upload Trust Snapshot JSON
        uses: actions/upload-artifact@v6
        with:
          name: trust-snapshot-json
          path: trust-snapshot/trust_snapshot.json
          retention-days: 30
          if-no-files-found: error
