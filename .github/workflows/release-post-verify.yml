name: Release Post-Verification

# Post-Release Verification Workflow
#
# This workflow re-validates a GA release after publication:
# 1. Downloads all GA release assets
# 2. Validates manifest hashes
# 3. Validates trust snapshot schema
# 4. Verifies signatures/attestations
# 5. Emits a final ga-attestation.json
#
# The attestation is uploaded as a release asset for audit trail.
# See: docs/release/PROMOTION_POLICY.md

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      ga_tag:
        description: "GA tag to verify (e.g., v4.1.2)"
        required: true
        type: string

permissions:
  contents: write
  actions: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 1: Download and Verify Assets
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify:
    name: "ðŸ” Verify GA Release"
    runs-on: ubuntu-latest

    outputs:
      ga_tag: ${{ steps.resolve.outputs.ga_tag }}
      rc_tag: ${{ steps.resolve.outputs.rc_tag }}
      commit_sha: ${{ steps.resolve.outputs.commit_sha }}
      attestation_status: ${{ steps.attestation.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        continue-on-error: true

      - name: Resolve Tag
        id: resolve
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            GA_TAG="${{ github.event.release.tag_name }}"
          else
            GA_TAG="${{ inputs.ga_tag }}"
          fi

          echo "ga_tag=${GA_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Verifying GA release: ${GA_TAG}"

          # Skip if this is an RC tag
          if [[ "${GA_TAG}" =~ -rc\. ]]; then
            echo "::notice::Tag ${GA_TAG} is an RC tag, skipping post-verification"
            echo "is_ga=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_ga=true" >> $GITHUB_OUTPUT

          # Get commit SHA
          COMMIT_SHA=$(git rev-parse "${GA_TAG}^{}" 2>/dev/null || echo "unknown")
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT

          # Try to find corresponding RC tag
          VERSION=$(echo "${GA_TAG}" | sed 's/^v//')
          RC_TAG=""
          for rc in $(git tag -l "v${VERSION}-rc.*" | sort -V -r); do
            RC_SHA=$(git rev-parse "${rc}^{}" 2>/dev/null || continue)
            if [[ "${RC_SHA}" == "${COMMIT_SHA}" ]]; then
              RC_TAG="${rc}"
              break
            fi
          done
          echo "rc_tag=${RC_TAG:-unknown}" >> $GITHUB_OUTPUT

          echo ""
          echo "Resolution:"
          echo "  GA Tag: ${GA_TAG}"
          echo "  Commit: ${COMMIT_SHA}"
          echo "  RC Tag: ${RC_TAG:-not found}"

      - name: Download GA Release Assets
        id: download
        if: steps.resolve.outputs.is_ga == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          GA_TAG="${{ steps.resolve.outputs.ga_tag }}"
          mkdir -p ga-assets

          echo "ðŸ“¥ Downloading assets from ${GA_TAG}..."
          gh release download "${GA_TAG}" --dir ga-assets --pattern "*" || true

          echo ""
          echo "ðŸ“¦ Downloaded assets:"
          ls -la ga-assets/

          # Count assets
          ASSET_COUNT=$(ls ga-assets/ | wc -l)
          echo "asset_count=${ASSET_COUNT}" >> $GITHUB_OUTPUT

      - name: Verify Evidence Bundle
        id: verify-evidence
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          echo "ðŸ” Verifying evidence bundle..."

          EVIDENCE_FILE=$(ls ga-assets/evidence*.tar.gz 2>/dev/null | head -1)
          EVIDENCE_VALID="true"
          EVIDENCE_DIGEST=""
          MANIFEST_VALID="unknown"

          if [[ -n "$EVIDENCE_FILE" ]]; then
            EVIDENCE_DIGEST=$(sha256sum "$EVIDENCE_FILE" | awk '{print $1}')
            echo "  Evidence bundle: $(basename $EVIDENCE_FILE)"
            echo "  Digest: sha256:${EVIDENCE_DIGEST}"

            # Extract and verify manifest
            mkdir -p evidence-extracted
            tar -xzf "$EVIDENCE_FILE" -C evidence-extracted

            if [[ -f "evidence-extracted/SHA256SUMS" ]]; then
              cd evidence-extracted
              if sha256sum -c SHA256SUMS --quiet 2>/dev/null; then
                echo "  âœ… Manifest verification: PASS"
                MANIFEST_VALID="true"
              else
                echo "  âŒ Manifest verification: FAIL"
                MANIFEST_VALID="false"
                EVIDENCE_VALID="false"
              fi
              cd ..
            else
              echo "  âš ï¸ No SHA256SUMS manifest found"
              MANIFEST_VALID="missing"
            fi
          else
            echo "  âš ï¸ No evidence bundle found"
            EVIDENCE_VALID="missing"
          fi

          echo "evidence_valid=${EVIDENCE_VALID}" >> $GITHUB_OUTPUT
          echo "evidence_digest=${EVIDENCE_DIGEST}" >> $GITHUB_OUTPUT
          echo "manifest_valid=${MANIFEST_VALID}" >> $GITHUB_OUTPUT

      - name: Verify Trust Snapshot
        id: verify-trust
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          echo "ðŸ” Verifying trust snapshot..."

          TRUST_FILE=$(ls ga-assets/trust-snapshot*.json 2>/dev/null | head -1)
          TRUST_VALID="true"
          TRUST_DIGEST=""
          SCHEMA_VALID="unknown"

          if [[ -n "$TRUST_FILE" ]]; then
            TRUST_DIGEST=$(sha256sum "$TRUST_FILE" | awk '{print $1}')
            echo "  Trust snapshot: $(basename $TRUST_FILE)"
            echo "  Digest: sha256:${TRUST_DIGEST}"

            # Validate JSON structure
            if node -e "JSON.parse(require('fs').readFileSync('$TRUST_FILE', 'utf8'))" 2>/dev/null; then
              echo "  âœ… JSON validation: PASS"
              SCHEMA_VALID="true"

              # If schema file exists, validate against it
              if [[ -f "schemas/trust_snapshot.schema.json" ]]; then
                # Note: Would use ajv or similar for full schema validation
                echo "  â„¹ï¸ Schema file exists (full validation available)"
              fi
            else
              echo "  âŒ JSON validation: FAIL"
              SCHEMA_VALID="false"
              TRUST_VALID="false"
            fi
          else
            echo "  âš ï¸ No trust snapshot found"
            TRUST_VALID="missing"
          fi

          echo "trust_valid=${TRUST_VALID}" >> $GITHUB_OUTPUT
          echo "trust_digest=${TRUST_DIGEST}" >> $GITHUB_OUTPUT
          echo "schema_valid=${SCHEMA_VALID}" >> $GITHUB_OUTPUT

      - name: Verify Signatures
        id: verify-signatures
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          echo "ðŸ” Verifying signatures..."

          SIGNATURES_PRESENT="false"
          SIGNATURES_VERIFIED="unknown"

          # Check for signature files
          SIG_FILES=$(ls ga-assets/*.sig 2>/dev/null | wc -l)
          CERT_FILES=$(ls ga-assets/*.cert 2>/dev/null | wc -l)

          if [[ $SIG_FILES -gt 0 ]]; then
            SIGNATURES_PRESENT="true"
            echo "  Found ${SIG_FILES} signature file(s)"
            echo "  Found ${CERT_FILES} certificate file(s)"

            # Verify with cosign if available
            if command -v cosign &> /dev/null; then
              VERIFIED_COUNT=0
              FAILED_COUNT=0

              for sigfile in ga-assets/*.sig; do
                ARTIFACT="${sigfile%.sig}"
                CERTFILE="${sigfile%.sig}.cert"

                if [[ -f "$ARTIFACT" && -f "$CERTFILE" ]]; then
                  if cosign verify-blob \
                    --certificate "$CERTFILE" \
                    --signature "$sigfile" \
                    "$ARTIFACT" 2>/dev/null; then
                    echo "  âœ… Verified: $(basename $ARTIFACT)"
                    ((VERIFIED_COUNT++))
                  else
                    echo "  âŒ Failed: $(basename $ARTIFACT)"
                    ((FAILED_COUNT++))
                  fi
                fi
              done

              if [[ $FAILED_COUNT -eq 0 && $VERIFIED_COUNT -gt 0 ]]; then
                SIGNATURES_VERIFIED="true"
                echo "  âœ… All signatures verified"
              elif [[ $FAILED_COUNT -gt 0 ]]; then
                SIGNATURES_VERIFIED="false"
                echo "  âŒ Some signatures failed verification"
              fi
            else
              echo "  âš ï¸ Cosign not available, skipping verification"
              SIGNATURES_VERIFIED="skipped"
            fi
          else
            echo "  â„¹ï¸ No signature files found"
          fi

          echo "signatures_present=${SIGNATURES_PRESENT}" >> $GITHUB_OUTPUT
          echo "signatures_verified=${SIGNATURES_VERIFIED}" >> $GITHUB_OUTPUT

      - name: Verify Provenance
        id: verify-provenance
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          echo "ðŸ“œ Verifying SLSA provenance..."

          PROVENANCE_PRESENT="false"
          PROVENANCE_VALID="unknown"
          SLSA_LEVEL="unknown"

          PROVENANCE_FILE=$(ls ga-assets/*.intoto.jsonl 2>/dev/null | head -1)

          if [[ -n "$PROVENANCE_FILE" ]]; then
            PROVENANCE_PRESENT="true"
            echo "  Provenance file: $(basename $PROVENANCE_FILE)"

            # Validate JSON structure
            if node -e "require('fs').readFileSync('$PROVENANCE_FILE', 'utf8').split('\n').filter(Boolean).forEach(l => JSON.parse(l))" 2>/dev/null; then
              echo "  âœ… JSON-lines validation: PASS"
              PROVENANCE_VALID="true"

              # Extract SLSA level if present
              SLSA_LEVEL=$(jq -r '.predicateType // empty' "$PROVENANCE_FILE" 2>/dev/null | grep -o 'slsa[^"]*' || echo "3")
              echo "  SLSA Level: ${SLSA_LEVEL}"
            else
              echo "  âŒ JSON-lines validation: FAIL"
              PROVENANCE_VALID="false"
            fi
          else
            echo "  â„¹ï¸ No provenance file found"
          fi

          echo "provenance_present=${PROVENANCE_PRESENT}" >> $GITHUB_OUTPUT
          echo "provenance_valid=${PROVENANCE_VALID}" >> $GITHUB_OUTPUT
          echo "slsa_level=${SLSA_LEVEL}" >> $GITHUB_OUTPUT

      - name: Cross-Check Promotion Digests
        id: cross-check
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          echo "ðŸ”— Cross-checking promotion digests..."

          CROSS_CHECK="unknown"

          if [[ -f "ga-assets/digests.json" ]]; then
            echo "  Found promotion digests file"

            # Verify current digests match promotion-time digests
            MISMATCHES=0

            for file in ga-assets/*; do
              [[ -f "$file" ]] || continue
              [[ "$(basename $file)" == "digests.json" ]] && continue

              FILENAME=$(basename "$file")
              CURRENT_HASH=$(sha256sum "$file" | awk '{print $1}')
              RECORDED_HASH=$(jq -r ".digests[\"$FILENAME\"] // empty" ga-assets/digests.json | sed 's/sha256://')

              if [[ -n "$RECORDED_HASH" ]]; then
                if [[ "$CURRENT_HASH" == "$RECORDED_HASH" ]]; then
                  echo "  âœ… ${FILENAME}: matches"
                else
                  echo "  âŒ ${FILENAME}: MISMATCH"
                  echo "     Current:  ${CURRENT_HASH}"
                  echo "     Recorded: ${RECORDED_HASH}"
                  ((MISMATCHES++))
                fi
              fi
            done

            if [[ $MISMATCHES -eq 0 ]]; then
              CROSS_CHECK="true"
              echo ""
              echo "  âœ… All digests match promotion record"
            else
              CROSS_CHECK="false"
              echo ""
              echo "  âŒ ${MISMATCHES} digest mismatch(es) found"
            fi
          else
            echo "  âš ï¸ No promotion digests file found"
          fi

          echo "cross_check=${CROSS_CHECK}" >> $GITHUB_OUTPUT

      - name: Generate GA Attestation
        id: attestation
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          echo "ðŸ“ Generating GA attestation..."

          GA_TAG="${{ steps.resolve.outputs.ga_tag }}"
          RC_TAG="${{ steps.resolve.outputs.rc_tag }}"
          COMMIT_SHA="${{ steps.resolve.outputs.commit_sha }}"

          # Determine overall status
          STATUS="PASS"

          # Check critical validations
          if [[ "${{ steps.verify-evidence.outputs.manifest_valid }}" == "false" ]]; then
            STATUS="FAIL"
          fi
          if [[ "${{ steps.verify-trust.outputs.schema_valid }}" == "false" ]]; then
            STATUS="FAIL"
          fi
          if [[ "${{ steps.cross-check.outputs.cross_check }}" == "false" ]]; then
            STATUS="FAIL"
          fi

          # Generate attestation JSON
          mkdir -p attestation

          cat > attestation/ga-attestation.json << EOF
          {
            "version": "1.0.0",
            "attestation_type": "ga-release-verification",
            "ga_tag": "${GA_TAG}",
            "rc_tag": "${RC_TAG}",
            "commit_sha": "${COMMIT_SHA}",
            "run_id": ${{ github.run_id }},
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "generated_at_utc": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "repository": "${{ github.repository }}",
            "verification": {
              "evidence_bundle": {
                "present": ${{ steps.verify-evidence.outputs.evidence_valid != 'missing' }},
                "digest": "${{ steps.verify-evidence.outputs.evidence_digest }}",
                "manifest_valid": ${{ steps.verify-evidence.outputs.manifest_valid == 'true' }}
              },
              "trust_snapshot": {
                "present": ${{ steps.verify-trust.outputs.trust_valid != 'missing' }},
                "digest": "${{ steps.verify-trust.outputs.trust_digest }}",
                "schema_valid": ${{ steps.verify-trust.outputs.schema_valid == 'true' }}
              },
              "signatures": {
                "present": ${{ steps.verify-signatures.outputs.signatures_present }},
                "verified": "${{ steps.verify-signatures.outputs.signatures_verified }}"
              },
              "provenance": {
                "present": ${{ steps.verify-provenance.outputs.provenance_present }},
                "valid": ${{ steps.verify-provenance.outputs.provenance_valid == 'true' }},
                "slsa_level": "${{ steps.verify-provenance.outputs.slsa_level }}"
              },
              "cross_check": {
                "digests_matched": "${{ steps.cross-check.outputs.cross_check }}"
              }
            },
            "policy_versions": {
              "promotion_policy": "1.0.0",
              "required_checks_contract": "2.0.0"
            },
            "attestation_status": "${STATUS}"
          }
          EOF

          echo ""
          echo "ðŸ“‹ GA Attestation:"
          cat attestation/ga-attestation.json | jq .

          echo "status=${STATUS}" >> $GITHUB_OUTPUT

          if [[ "${STATUS}" == "FAIL" ]]; then
            echo "::error::GA attestation status: FAIL"
          else
            echo "âœ… GA attestation status: PASS"
          fi

      - name: Upload Attestation to Release
        if: steps.resolve.outputs.is_ga == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          GA_TAG="${{ steps.resolve.outputs.ga_tag }}"

          echo "ðŸ“¤ Uploading attestation to release..."
          gh release upload "${GA_TAG}" attestation/ga-attestation.json --clobber || true

          echo "âœ… Attestation uploaded"

      - name: Upload Attestation Artifact
        if: steps.resolve.outputs.is_ga == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ga-attestation-${{ steps.resolve.outputs.ga_tag }}
          path: attestation/
          retention-days: 365

      - name: Verification Summary
        if: steps.resolve.outputs.is_ga == 'true'
        run: |
          STATUS="${{ steps.attestation.outputs.status }}"

          if [[ "${STATUS}" == "PASS" ]]; then
            EMOJI="âœ…"
            HEADER="Post-Release Verification Passed"
          else
            EMOJI="âŒ"
            HEADER="Post-Release Verification Failed"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${EMOJI} ${HEADER}

          | Field | Value |
          |-------|-------|
          | GA Tag | \`${{ steps.resolve.outputs.ga_tag }}\` |
          | RC Tag | \`${{ steps.resolve.outputs.rc_tag }}\` |
          | Commit | \`${{ steps.resolve.outputs.commit_sha }}\` |
          | Status | **${STATUS}** |

          ### Verification Details

          | Check | Status |
          |-------|--------|
          | Evidence Bundle | ${{ steps.verify-evidence.outputs.evidence_valid == 'true' && 'âœ…' || (steps.verify-evidence.outputs.evidence_valid == 'missing' && 'âš ï¸ Missing' || 'âŒ') }} |
          | Manifest Integrity | ${{ steps.verify-evidence.outputs.manifest_valid == 'true' && 'âœ…' || (steps.verify-evidence.outputs.manifest_valid == 'missing' && 'âš ï¸ N/A' || 'âŒ') }} |
          | Trust Snapshot | ${{ steps.verify-trust.outputs.trust_valid == 'true' && 'âœ…' || (steps.verify-trust.outputs.trust_valid == 'missing' && 'âš ï¸ Missing' || 'âŒ') }} |
          | Schema Valid | ${{ steps.verify-trust.outputs.schema_valid == 'true' && 'âœ…' || 'âš ï¸' }} |
          | Signatures | ${{ steps.verify-signatures.outputs.signatures_verified == 'true' && 'âœ…' || (steps.verify-signatures.outputs.signatures_present == 'false' && 'âš ï¸ None' || 'âš ï¸') }} |
          | Provenance | ${{ steps.verify-provenance.outputs.provenance_valid == 'true' && 'âœ…' || (steps.verify-provenance.outputs.provenance_present == 'false' && 'âš ï¸ None' || 'âš ï¸') }} |
          | Digest Cross-Check | ${{ steps.cross-check.outputs.cross_check == 'true' && 'âœ…' || (steps.cross-check.outputs.cross_check == 'unknown' && 'âš ï¸ N/A' || 'âŒ') }} |

          ### Attestation

          The \`ga-attestation.json\` has been uploaded to the release.

          ---
          *Verified by \`release-post-verify.yml\`*
          EOF
