name: Supply Chain Gates

on:
  pull_request:
  release:
    types: [published]

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write
  pull-requests: write
  packages: write

jobs:
  gates:
    name: Supply Chain Gates
    runs-on: ubuntu-latest
    env:
      SBOM_DIR: artifacts/sbom
      VULN_DIR: artifacts/vulns
      ATTEST_DIR: artifacts/attestations
      SIGN_DIR: artifacts/signatures
      REPORT_DIR: artifacts/reports
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin v1.18.0
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin v0.76.0
          curl -sSfL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o /usr/local/bin/osv-scanner
          sudo chmod +x /usr/local/bin/osv-scanner

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.5.0
        with:
          cosign-release: 'v2.2.4'

      - name: Prepare environment
        id: prep
        run: |
          mkdir -p "$SBOM_DIR" "$VULN_DIR" "$ATTEST_DIR" "$SIGN_DIR" "$REPORT_DIR" artifacts/build
          echo "SERVICE_NAME=${GITHUB_REPOSITORY##*/}" >> "$GITHUB_ENV"
          echo "SHORT_SHA=${GITHUB_SHA::12}" >> "$GITHUB_ENV"

      - name: Generate cosign key pair
        env:
          COSIGN_PASSWORD: ""
        run: |
          cosign generate-key-pair

      - name: Build artifacts
        run: |
          tar -czf artifacts/build/${SERVICE_NAME}-${SHORT_SHA}.tar.gz .

      - name: Prepare baseline worktree
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin main --depth=1
          git worktree add /tmp/origin-main origin/main

      - name: Generate SBOM (current)
        run: ./.ci/scripts/sbom/generate_syft.sh . "${SERVICE_NAME}" "${SHORT_SHA}" "$SBOM_DIR"

      - name: Generate SBOM (baseline)
        if: github.event_name == 'pull_request'
        run: ./.ci/scripts/sbom/generate_syft.sh /tmp/origin-main "${SERVICE_NAME}-baseline" "${SHORT_SHA}" "$SBOM_DIR"

      - name: Grype scan (current)
        run: ./.ci/scripts/sbom/scan_grype.sh "$SBOM_DIR/${SERVICE_NAME}-${SHORT_SHA}.spdx.json" "$VULN_DIR/grype-${SERVICE_NAME}-${SHORT_SHA}"

      - name: Grype scan (baseline)
        if: github.event_name == 'pull_request'
        run: ./.ci/scripts/sbom/scan_grype.sh "$SBOM_DIR/${SERVICE_NAME}-baseline-${SHORT_SHA}.spdx.json" "$VULN_DIR/grype-${SERVICE_NAME}-baseline-${SHORT_SHA}"

      - name: OSV scan (current)
        run: ./.ci/scripts/sbom/scan_osv.sh "$SBOM_DIR/${SERVICE_NAME}-${SHORT_SHA}.spdx.json" "$VULN_DIR/osv-${SERVICE_NAME}-${SHORT_SHA}"

      - name: OSV scan (baseline)
        if: github.event_name == 'pull_request'
        run: ./.ci/scripts/sbom/scan_osv.sh "$SBOM_DIR/${SERVICE_NAME}-baseline-${SHORT_SHA}.spdx.json" "$VULN_DIR/osv-${SERVICE_NAME}-baseline-${SHORT_SHA}"

      - name: Diff budget gate
        id: diff
        run: |
          BASELINE_REPORT=""
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASELINE_REPORT="$VULN_DIR/grype-${SERVICE_NAME}-baseline-${SHORT_SHA}.json"
          fi
          python3 ./.ci/scripts/sbom/diff_budget.py \
            --new-report "$VULN_DIR/grype-${SERVICE_NAME}-${SHORT_SHA}.json" \
            ${BASELINE_REPORT:+--baseline-report "$BASELINE_REPORT"} \
            --budget .maestro/ci_budget.json \
            --output "$REPORT_DIR/diff-budget.json"

      - name: Create attestation predicate
        run: |
          cat > "$ATTEST_DIR/${SERVICE_NAME}-${SHORT_SHA}-predicate.json" <<PRED
          {
            "buildType": "https://slsa.dev/spec/v1.0",
            "subject": [
              {"name": "${SERVICE_NAME}", "digest": {"sha256": "${SHORT_SHA}"}}
            ],
            "metadata": {
              "sbom": "$SBOM_DIR/${SERVICE_NAME}-${SHORT_SHA}.spdx.json",
              "scans": {
                "grype": "$VULN_DIR/grype-${SERVICE_NAME}-${SHORT_SHA}.json",
                "osv": "$VULN_DIR/osv-${SERVICE_NAME}-${SHORT_SHA}.json"
              }
            }
          }
PRED

      - name: Generate attestation
        run: ./.ci/scripts/attest/attest_slsa.sh "$SBOM_DIR/${SERVICE_NAME}-${SHORT_SHA}.spdx.json" "$ATTEST_DIR/${SERVICE_NAME}-${SHORT_SHA}-predicate.json" "$ATTEST_DIR/${SERVICE_NAME}-${SHORT_SHA}"

      - name: Sign artifacts
        run: |
          for artifact in "$SBOM_DIR/${SERVICE_NAME}-${SHORT_SHA}.spdx.json" "$VULN_DIR/grype-${SERVICE_NAME}-${SHORT_SHA}.json" "$VULN_DIR/osv-${SERVICE_NAME}-${SHORT_SHA}.json" "$ATTEST_DIR/${SERVICE_NAME}-${SHORT_SHA}-predicate.json" "artifacts/build/${SERVICE_NAME}-${SHORT_SHA}.tar.gz"; do
            base_name=$(basename "$artifact" | sed 's/\.[^.]*$//')
            ./.ci/scripts/signing/cosign_sign_verify.sh "$artifact" "$SIGN_DIR/${base_name}"
          done

      - name: Verify attestation bundle
        run: |
          cosign verify-blob --key cosign.pub --signature "$ATTEST_DIR/${SERVICE_NAME}-${SHORT_SHA}.sig" "$ATTEST_DIR/${SERVICE_NAME}-${SHORT_SHA}.json"

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: ${{ env.SBOM_DIR }}
          retention-days: 400

      - name: Upload vulnerability scans
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports-${{ github.sha }}
          path: ${{ env.VULN_DIR }}
          retention-days: 400

      - name: Upload attestations and signatures
        uses: actions/upload-artifact@v4
        with:
          name: attestations-${{ github.sha }}
          path: |
            ${{ env.ATTEST_DIR }}
            ${{ env.SIGN_DIR }}
            ${{ env.REPORT_DIR }}
          retention-days: 400

      - name: Post PR summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = `${process.env.REPORT_DIR}/diff-budget.json`;
            const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
            const status = summary.status.toUpperCase();
            const headline = `Supply Chain Gates: ${status}`;
            const body = `### ${headline}\n\n` +
              `**Budget Status:** ${summary.status}\n\n` +
              `| Severity | Baseline | Current | Delta |\n|---|---|---|---|\n` +
              summary.summary.map(row => `| ${row.severity} | ${row.baseline} | ${row.current} | ${row.delta} |`).join('\n') +
              `\n\nArtifacts: SBOMs, vulnerability reports, signatures, and attestations are attached to this workflow run. Rekor transparency log entries are generated when supported; see workflow logs for indexes.`;
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.user.login === 'github-actions[bot]' && c.body.includes('Supply Chain Gates'));
            if (existing) {
              await github.rest.issues.updateComment({
                ...context.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body,
              });
            }
