name: supply-chain-gates

on:
  pull_request:
    branches: ["main", "develop", "release/*"]
  push:
    branches: ["main", "release/*"]
  workflow_dispatch: {}

env:
  SBOM_PATH: artifacts/sbom/repo-${{ github.sha }}.spdx.json
  VULN_DIR: artifacts/vulns
  ATTESTATION_PATH: attestations/repo-${{ github.sha }}.intoto.jsonl
  BUDGETS: .maestro/ci_budget.json

jobs:
  supply-chain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install supply chain toolchain
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3-pip
          pip3 install --user --upgrade pip
          COSIGN_VERSION="v2.4.0"
          curl -sSL -o cosign.tgz "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64.tar.gz"
          tar -xzf cosign.tgz cosign && sudo mv cosign /usr/local/bin/
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSfL https://github.com/google/osv-scanner/releases/download/v1.7.3/osv-scanner_1.7.3_linux_amd64.tar.gz | sudo tar -xz -C /usr/local/bin osv-scanner
          curl -sSfL https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz | sudo tar -xz -C /usr/local/bin conftest

      - name: Generate SBOM
        run: |
          mkdir -p artifacts/sbom
          .ci/scripts/sbom/generate_syft.sh . "${SBOM_PATH}"

      - name: Vulnerability scanning (Grype)
        run: |
          mkdir -p "${VULN_DIR}"
          .ci/scripts/sbom/scan_grype.sh "${SBOM_PATH}" "${VULN_DIR}/grype.json" "${VULN_DIR}/grype.sarif"

      - name: Vulnerability scanning (OSV)
        run: |
          .ci/scripts/sbom/scan_osv.sh "${SBOM_PATH}" "${VULN_DIR}/osv.json" "${VULN_DIR}/osv.sarif"

      - name: Generate baseline from origin/main
        run: |
          git fetch origin main --depth=2
          git worktree add /tmp/main origin/main
          .ci/scripts/sbom/generate_syft.sh /tmp/main "${VULN_DIR}/baseline.sbom.spdx.json"
          .ci/scripts/sbom/scan_grype.sh "${VULN_DIR}/baseline.sbom.spdx.json" "${VULN_DIR}/baseline.grype.json" "${VULN_DIR}/baseline.grype.sarif"

      - name: Enforce diff budget
        run: |
          python .ci/scripts/sbom/diff_budget.py "${VULN_DIR}/baseline.grype.json" "${VULN_DIR}/grype.json" "${BUDGETS}" --summary "${VULN_DIR}/budget-summary.json"

      - name: Attest provenance
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          mkdir -p attestations
          .ci/scripts/attest/attest_slsa.sh "${SBOM_PATH}" "repo-sbom" "${ATTESTATION_PATH}"

      - name: Sign and verify SBOM
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign-blob --yes --output-signature artifacts/sbom.sig --output-certificate artifacts/sbom.cert "${SBOM_PATH}"
          cosign verify-blob --certificate artifacts/sbom.cert --signature artifacts/sbom.sig "${SBOM_PATH}"

      - name: Policy enforcement
        run: |
          conftest test "${SBOM_PATH}" -p .ci/policies -i json --combine

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "${VULN_DIR}/grype.sarif"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-artifacts
          path: |
            ${SBOM_PATH}
            ${VULN_DIR}
            ${ATTESTATION_PATH}
            artifacts/sbom.sig
            artifacts/sbom.cert

      - name: PR summary comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## Supply chain summary
            - SBOM: `${SBOM_PATH}`
            - Grype: `${VULN_DIR}/grype.json`
            - OSV: `${VULN_DIR}/osv.json`
            - Budget: `${VULN_DIR}/budget-summary.json`
            - Attestation: `${ATTESTATION_PATH}`
            - Signatures: `artifacts/sbom.sig`
