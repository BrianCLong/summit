name: Feature Flag Branch CI

on:
  push:
    branches:
      - feat/atsh
      - feat/saga
      - feat/prompt-registry
  pull_request:
    branches:
      - feat/atsh
      - feat/saga
      - feat/prompt-registry

env:
  ATSH_ENABLED: 'true'
  SAGA_ENABLED: 'true'
  PROMPT_REGISTRY_ENABLED: 'true'
  FEATURE_FLAG_LABELS: feature:ATSH_ENABLED,feature:SAGA_ENABLED,feature:PROMPT_REGISTRY_ENABLED
  CI: 'true'

permissions:
  contents: read
  actions: write
  pull-requests: write

concurrency:
  group: feature-flag-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Lint
        run: pnpm run lint

  unit-tests:
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Run unit tests
        run: pnpm run test:unit

  contract-tests:
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Run policy/contract tests
        run: pnpm run test:policy

  playwright:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    needs: contract-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run Playwright smoke suite
        run: pnpm run e2e

  preview-environment:
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [lint, unit-tests, contract-tests, playwright]
    if: github.event_name == 'pull_request'
    environment: preview
    steps:
      - uses: actions/checkout@v4

      - name: Record preview metadata
        run: |
          cat <<'JSON' > preview-metadata.json
          {
            "featureFlags": "${FEATURE_FLAG_LABELS}",
            "branch": "${GITHUB_HEAD_REF:-${GITHUB_REF##*/}}",
            "workflow": "feature-flag-branches",
            "preview": "requires preview-env rollout with auto-rollback on failure"
          }
          JSON

      - name: Upload preview metadata
        uses: actions/upload-artifact@v4
        with:
          name: preview-flags
          path: preview-metadata.json

      - name: Comment preview expectations
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.GITHUB_HEAD_REF || process.env.GITHUB_REF?.replace('refs/heads/', '');
            const body = [
              `Preview environment requested for **${branch}** with flags: ${process.env.FEATURE_FLAG_LABELS}.`,
              'CI gates: lint → unit → policy/contract → Playwright.',
              'Preview deploy must honor feature flags and be wired to auto-rollback on failure.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

  auto-rollback-hook:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    needs: [lint, unit-tests, contract-tests, playwright]
    if: always()
    steps:
      - name: Evaluate gating results
        id: gates
        run: |
          failing=0
          for result in "${{ needs.lint.result }}" "${{ needs.unit-tests.result }}" "${{ needs.contract-tests.result }}" "${{ needs.playwright.result }}"; do
            if [ "$result" != "success" ]; then
              failing=1
            fi
          done
          echo "failing=$failing" >> $GITHUB_OUTPUT

      - name: Dispatch auto-rollback workflow on failure
        if: steps.gates.outputs.failing == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const ref = context.payload.pull_request ? context.payload.pull_request.head.ref : context.ref.replace('refs/heads/', '');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-rollback.yml',
              ref,
            });
            core.info(`Triggered auto-rollback workflow for ${ref}`);
