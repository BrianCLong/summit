# Air-Gapped Deployment CI/CD Workflow
# Validates air-gapped infrastructure, SLSA/SBOM, and security controls
name: Air-Gapped Deployment CI

on:
  push:
    branches:
      - main
      - 'feat/airgapped-deploy'
      - 'claude/*'
    paths:
      - 'infra/airgap/**'
      - '.github/workflows/airgap-deployment.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/airgap/**'
      - '.github/workflows/airgap-deployment.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

permissions:
  contents: read
  id-token: write
  security-events: write
  packages: write

env:
  TF_VERSION: '1.6.0'
  COSIGN_VERSION: '2.2.0'
  SYFT_VERSION: '0.98.0'
  GRYPE_VERSION: '0.72.0'

jobs:
  # ============================================================================
  # Terraform Validation
  # ============================================================================
  terraform-validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/airgap/terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: TFSec Security Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra/airgap/terraform
          soft_fail: false

      - name: Checkov IaC Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/airgap/terraform
          framework: terraform
          output_format: sarif
          output_file_path: results.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  # ============================================================================
  # Kubernetes Manifest Validation
  # ============================================================================
  kubernetes-validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kubeconform
        run: |
          curl -sLO https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes Manifests
        run: |
          find infra/airgap/kubernetes -name '*.yaml' -type f | \
          xargs kubeconform \
            -strict \
            -ignore-missing-schemas \
            -summary

      - name: Setup Kyverno CLI
        run: |
          curl -sLO https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          tar xzf kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/

      - name: Validate Kyverno Policies
        run: |
          kyverno validate infra/airgap/sbom/slsa-sbom-policy.yaml || true

      - name: Kubeval Validation
        uses: instrumenta/kubeval-action@master
        with:
          files: infra/airgap/kubernetes
          ignore_missing_schemas: true

  # ============================================================================
  # Security Policy Tests
  # ============================================================================
  security-policy-tests:
    name: Security Policy Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Test Dependencies
        run: |
          pip install pytest pyyaml jsonschema

      - name: Run Policy Tests
        run: |
          python -m pytest infra/airgap/tests/ -v --tb=short

      - name: Verify Network Policies
        run: |
          # Check that default-deny exists for all namespaces
          for ns in intelgraph-airgap intelgraph-scanning intelgraph-monitoring intelgraph-siem; do
            if ! grep -q "default-deny" infra/airgap/kubernetes/network-policies.yaml; then
              echo "ERROR: Missing default-deny policy for ${ns}"
              exit 1
            fi
          done
          echo "All network policies validated"

      - name: Verify Pod Security Standards
        run: |
          # Check that all namespaces have restricted PSS
          if ! grep -q "pod-security.kubernetes.io/enforce: restricted" infra/airgap/kubernetes/namespace.yaml; then
            echo "ERROR: Missing restricted PSS enforcement"
            exit 1
          fi
          echo "Pod Security Standards validated"

  # ============================================================================
  # SBOM Generation Test
  # ============================================================================
  sbom-test:
    name: SBOM Generation Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | \
          sh -s -- -b /usr/local/bin v${{ env.SYFT_VERSION }}

      - name: Setup Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | \
          sh -s -- -b /usr/local/bin v${{ env.GRYPE_VERSION }}

      - name: Test SBOM Script Syntax
        run: |
          bash -n infra/airgap/scripts/generate-sbom.sh
          echo "SBOM script syntax validated"

      - name: Generate Test SBOM
        run: |
          # Generate SBOM for a test image
          syft alpine:latest -o cyclonedx-json > /tmp/test-sbom.json

          # Validate SBOM structure
          jq -e '.bomFormat == "CycloneDX"' /tmp/test-sbom.json
          jq -e '.specVersion' /tmp/test-sbom.json
          echo "SBOM generation validated"

      - name: Run Vulnerability Scan
        run: |
          grype sbom:/tmp/test-sbom.json -o json > /tmp/vulns.json
          echo "Vulnerability scanning validated"

  # ============================================================================
  # Cosign Signing Test
  # ============================================================================
  cosign-test:
    name: Cosign Signing Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: v${{ env.COSIGN_VERSION }}

      - name: Generate Test Key Pair
        run: |
          cosign generate-key-pair --output-key-prefix=test
          echo "Cosign key generation validated"

      - name: Test Blob Signing
        run: |
          echo "test content" > /tmp/test-blob.txt
          cosign sign-blob \
            --key test.key \
            --output-signature /tmp/test-blob.sig \
            --tlog-upload=false \
            /tmp/test-blob.txt

          # Verify signature
          cosign verify-blob \
            --key test.pub \
            --signature /tmp/test-blob.sig \
            --insecure-ignore-tlog=true \
            /tmp/test-blob.txt

          echo "Cosign signing validated"

  # ============================================================================
  # Documentation Validation
  # ============================================================================
  docs-validate:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint Documentation
        run: |
          markdownlint infra/airgap/docs/*.md --ignore node_modules || true

      - name: Check Required Sections
        run: |
          REQUIRED_SECTIONS=(
            "Executive Summary"
            "Architecture Overview"
            "Security Zones"
            "Network Segmentation"
            "Malware Scanning"
            "SNMP Health Monitoring"
            "Supply Chain Security"
            "Compliance Mapping"
          )

          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "$section" infra/airgap/docs/DEFENSE-IN-DEPTH.md; then
              echo "ERROR: Missing required section: $section"
              exit 1
            fi
          done
          echo "All required documentation sections present"

  # ============================================================================
  # Integration Test
  # ============================================================================
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs:
      - terraform-validate
      - kubernetes-validate
      - security-policy-tests
      - sbom-test
      - cosign-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          cluster_name: airgap-test

      - name: Apply Namespace Configuration
        run: |
          kubectl apply -f infra/airgap/kubernetes/namespace.yaml
          kubectl get namespaces

      - name: Apply Network Policies
        run: |
          kubectl apply -f infra/airgap/kubernetes/network-policies.yaml
          kubectl get networkpolicies --all-namespaces

      - name: Verify Namespace Labels
        run: |
          # Verify security labels are applied
          kubectl get ns intelgraph-airgap -o jsonpath='{.metadata.labels}' | \
          grep -q "pod-security.kubernetes.io/enforce"

          echo "Namespace configuration validated"

      - name: Test Network Policy Enforcement
        run: |
          # Create test pods
          kubectl run test-pod-1 --image=busybox --restart=Never \
            -n intelgraph-airgap -- sleep 3600 || true

          # Verify default-deny is working (pod should be isolated)
          kubectl describe networkpolicy default-deny-all -n intelgraph-airgap

          echo "Network policy enforcement validated"

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name airgap-test

  # ============================================================================
  # Final Status
  # ============================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - terraform-validate
      - kubernetes-validate
      - security-policy-tests
      - sbom-test
      - cosign-test
      - docs-validate
      - integration-test
    if: always()
    steps:
      - name: Check CI Status
        run: |
          if [[ "${{ needs.terraform-validate.result }}" != "success" ]] || \
             [[ "${{ needs.kubernetes-validate.result }}" != "success" ]] || \
             [[ "${{ needs.security-policy-tests.result }}" != "success" ]] || \
             [[ "${{ needs.sbom-test.result }}" != "success" ]] || \
             [[ "${{ needs.cosign-test.result }}" != "success" ]] || \
             [[ "${{ needs.integration-test.result }}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          echo "::notice::All CI jobs passed successfully"
