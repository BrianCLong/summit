name: chatops
on:
  repository_dispatch:
    types: [chatops]
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b
      - name: Execute command
        env: { KUBECONFIG: ${{ secrets.PROD_KUBECONFIG }} }
        shell: bash
        run: |
          case "${{ github.event.client_payload.command }}" in
            rollback)
              argo rollouts abort app -n prod || true
              argo rollouts promote --to-last-stable app -n prod
              ;;
            status)
              kubectl -n prod get rollouts
              ;;
            *)
              echo "Unknown command: ${{ github.event.client_payload.command }}"
              exit 1
              ;;
          esac
