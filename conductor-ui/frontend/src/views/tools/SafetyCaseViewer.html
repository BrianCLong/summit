<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Live Safety Case Viewer</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
          Arial, sans-serif;
        margin: 0;
        background: #f8f9fa;
      }
      #dock {
        position: fixed;
        right: 16px;
        top: 16px;
        width: 450px;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 16px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      .gsn-node {
        padding: 8px;
        border-left: 3px solid;
        margin-bottom: 4px;
      }
      .gsn-goal {
        font-weight: bold;
        border-left-color: #007bff;
        background: #e7f3ff;
      }
      .gsn-strategy {
        margin-left: 20px;
        border-left-color: #ffc107;
        background: #fff9e6;
      }
      .gsn-claim {
        margin-left: 40px;
        border-left-color: #fd7e14;
      }
      .gsn-evidence {
        margin-left: 60px;
        font-style: italic;
        color: #555;
        border-left-color: #28a745;
        background: #eafaf1;
      }
      .buttons {
        margin-top: 16px;
        border-top: 1px solid #eee;
        padding-top: 16px;
        display: flex;
        gap: 8px;
      }
      button {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        background: #f8f9fa;
      }
      button:hover {
        background: #e9ecef;
      }
      #status {
        margin-top: 10px;
        padding: 8px;
        background: #f1f3f5;
        border-radius: 6px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div id="dock">
      <div id="lsc-container"></div>
      <div class="buttons">
        <button id="sim">Run Twin Simulation</button>
        <button id="merge">Request Merge</button>
      </div>
      <div id="status"></div>
    </div>

    <script>
      $(function () {
        const prId =
          new URLSearchParams(window.location.search).get('pr') || 'pr-123';
        updateStatus(`Fetching Live Safety Case for PR #${prId}...`);

        $.getJSON(`/api/lsc/case/${prId}`)
          .done(function (lsc) {
            updateStatus('Safety Case loaded successfully.');
            buildGsnTree(lsc);
          })
          .fail(function () {
            updateStatus('Failed to load Safety Case.', true);
            $('#lsc-container').html(
              '<p style="color:red;">Could not load safety case.</p>',
            );
          });

        function updateStatus(msg, isError = false) {
          const color = isError ? '#ffe3e3' : '#f1f3f5';
          $('#status')
            .html(`<p><i>${new Date().toLocaleTimeString()}: ${msg}</i></p>`)
            .css('background', color);
        }

        $('#sim').on('click', () => {
          updateStatus('Requesting twin simulation...');
          setTimeout(
            () => updateStatus('Twin simulation passed: perf delta -7%'),
            1000,
          );
        });

        $('#merge').on('click', () => {
          updateStatus('Requesting merge...');
          setTimeout(() => updateStatus('Merge request queued.'), 500);
        });
      });
    </script>
  </body>
</html>
