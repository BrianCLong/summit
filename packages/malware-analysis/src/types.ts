import { z } from 'zod';

/**
 * Malware Analysis Types
 */
export const malwareTypeEnum = z.enum([
  'TROJAN',
  'RANSOMWARE',
  'WORM',
  'VIRUS',
  'ROOTKIT',
  'BACKDOOR',
  'SPYWARE',
  'ADWARE',
  'BOTNET',
  'CRYPTOMINER',
  'INFOSTEALER',
  'LOADER',
  'DROPPER',
  'RAT',
  'EXPLOIT_KIT',
  'PUA',
  'UNKNOWN',
]);

export const analysisTypeEnum = z.enum([
  'STATIC',
  'DYNAMIC',
  'BEHAVIORAL',
  'CODE_ANALYSIS',
  'NETWORK_TRAFFIC',
]);

export const analysisStatusEnum = z.enum([
  'PENDING',
  'RUNNING',
  'COMPLETED',
  'FAILED',
  'TIMEOUT',
]);

/**
 * Malware Sample Schema
 */
export const malwareSampleSchema = z.object({
  id: z.string(),
  name: z.string(),
  fileType: z.string(),
  fileSize: z.number().int(),

  // File hashes
  md5: z.string(),
  sha1: z.string(),
  sha256: z.string(),
  ssdeep: z.string().optional(),
  imphash: z.string().optional(),

  // Classification
  malwareType: malwareTypeEnum,
  malwareFamily: z.string().optional(),
  confidence: z.number().min(0).max(100),
  severity: z.enum(['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO']),

  // Tags and metadata
  tags: z.array(z.string()).default([]),
  packer: z.string().optional(),
  obfuscated: z.boolean().default(false),
  encrypted: z.boolean().default(false),
  signed: z.boolean().default(false),
  signatureInfo: z.object({
    valid: z.boolean(),
    issuer: z.string().optional(),
    subject: z.string().optional(),
  }).optional(),

  // Analysis results
  staticAnalysis: z.string().optional(), // Analysis ID
  dynamicAnalysis: z.string().optional(), // Analysis ID

  // Timeline
  firstSeen: z.string().datetime(),
  lastSeen: z.string().datetime(),
  submittedAt: z.string().datetime(),

  tenantId: z.string(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Static Analysis Schema
 */
export const staticAnalysisSchema = z.object({
  id: z.string(),
  sampleId: z.string(),
  status: analysisStatusEnum,

  // PE/ELF metadata
  peInfo: z.object({
    compilationTimestamp: z.string().optional(),
    entryPoint: z.string().optional(),
    sections: z.array(z.object({
      name: z.string(),
      virtualSize: z.number(),
      rawSize: z.number(),
      entropy: z.number(),
      suspicious: z.boolean(),
    })).default([]),
    imports: z.array(z.object({
      dll: z.string(),
      functions: z.array(z.string()),
    })).default([]),
    exports: z.array(z.string()).default([]),
    resources: z.array(z.object({
      type: z.string(),
      name: z.string(),
      size: z.number(),
      entropy: z.number(),
    })).default([]),
  }).optional(),

  // Strings extraction
  strings: z.array(z.object({
    value: z.string(),
    type: z.enum(['ASCII', 'UNICODE', 'BASE64', 'HEX']),
    suspicious: z.boolean(),
  })).default([]),

  // Indicators
  suspiciousPatterns: z.array(z.string()).default([]),
  capabilities: z.array(z.string()).default([]),
  antiDebugging: z.boolean().default(false),
  antiVM: z.boolean().default(false),
  antiSandbox: z.boolean().default(false),

  // YARA matches
  yaraMatches: z.array(z.object({
    ruleName: z.string(),
    tags: z.array(z.string()),
    meta: z.record(z.string(), z.unknown()).optional(),
  })).default([]),

  // Results
  verdict: z.enum(['MALICIOUS', 'SUSPICIOUS', 'CLEAN', 'UNKNOWN']),
  score: z.number().min(0).max(100),

  startedAt: z.string().datetime(),
  completedAt: z.string().datetime().optional(),
  duration: z.number().int().optional(), // milliseconds

  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Dynamic Analysis Schema
 */
export const dynamicAnalysisSchema = z.object({
  id: z.string(),
  sampleId: z.string(),
  status: analysisStatusEnum,

  // Sandbox environment
  sandboxType: z.enum(['CUCKOO', 'VMRAY', 'ANY_RUN', 'JOE_SANDBOX', 'HYBRID_ANALYSIS', 'CUSTOM']),
  environment: z.object({
    os: z.string(),
    version: z.string(),
    architecture: z.enum(['x86', 'x64', 'arm']),
  }),

  // Behavioral analysis
  processes: z.array(z.object({
    pid: z.number().int(),
    name: z.string(),
    commandLine: z.string().optional(),
    parentPid: z.number().int().optional(),
    children: z.array(z.number().int()).default([]),
  })).default([]),

  fileActivity: z.array(z.object({
    operation: z.enum(['CREATE', 'MODIFY', 'DELETE', 'READ', 'WRITE']),
    path: z.string(),
    timestamp: z.string().datetime(),
  })).default([]),

  registryActivity: z.array(z.object({
    operation: z.enum(['CREATE', 'MODIFY', 'DELETE', 'READ']),
    key: z.string(),
    value: z.string().optional(),
    timestamp: z.string().datetime(),
  })).default([]),

  networkActivity: z.array(z.object({
    protocol: z.enum(['TCP', 'UDP', 'HTTP', 'HTTPS', 'DNS', 'ICMP']),
    source: z.string(),
    destination: z.string(),
    port: z.number().int().optional(),
    data: z.string().optional(),
    timestamp: z.string().datetime(),
  })).default([]),

  // C2 Communication
  c2Servers: z.array(z.object({
    host: z.string(),
    port: z.number().int().optional(),
    protocol: z.string(),
    confidence: z.number().min(0).max(100),
  })).default([]),

  // Persistence mechanisms
  persistenceMechanisms: z.array(z.object({
    type: z.string(),
    location: z.string(),
    value: z.string().optional(),
  })).default([]),

  // Screenshots
  screenshots: z.array(z.object({
    timestamp: z.string().datetime(),
    path: z.string(),
    description: z.string().optional(),
  })).default([]),

  // Memory dumps
  memoryDumps: z.array(z.object({
    pid: z.number().int(),
    path: z.string(),
    size: z.number().int(),
  })).default([]),

  // Results
  verdict: z.enum(['MALICIOUS', 'SUSPICIOUS', 'CLEAN', 'UNKNOWN']),
  score: z.number().min(0).max(100),

  // Extracted IOCs
  extractedIocs: z.array(z.string()).default([]),

  startedAt: z.string().datetime(),
  completedAt: z.string().datetime().optional(),
  duration: z.number().int().optional(), // milliseconds

  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Malware Family Schema
 */
export const malwareFamilySchema = z.object({
  id: z.string(),
  name: z.string(),
  aliases: z.array(z.string()).default([]),
  type: malwareTypeEnum,
  description: z.string().optional(),

  // Characteristics
  capabilities: z.array(z.string()).default([]),
  targetedPlatforms: z.array(z.string()).default([]),
  propagationMethods: z.array(z.string()).default([]),

  // MITRE ATT&CK
  mitreTactics: z.array(z.string()).default([]),
  mitreTechniques: z.array(z.string()).default([]),

  // Threat actors
  associatedActors: z.array(z.string()).default([]),

  // Statistics
  sampleCount: z.number().int().default(0),
  firstSeen: z.string().datetime(),
  lastSeen: z.string().datetime(),

  // YARA rules
  yaraRules: z.array(z.string()).default([]),

  tenantId: z.string(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Type exports
 */
export type MalwareSample = z.infer<typeof malwareSampleSchema>;
export type MalwareType = z.infer<typeof malwareTypeEnum>;
export type StaticAnalysis = z.infer<typeof staticAnalysisSchema>;
export type DynamicAnalysis = z.infer<typeof dynamicAnalysisSchema>;
export type MalwareFamily = z.infer<typeof malwareFamilySchema>;
export type AnalysisStatus = z.infer<typeof analysisStatusEnum>;
