import { z } from 'zod';

/**
 * Vulnerability Intelligence Types
 */
export const vulnerabilitySeverityEnum = z.enum([
  'CRITICAL',
  'HIGH',
  'MEDIUM',
  'LOW',
  'INFO',
]);

export const exploitAvailabilityEnum = z.enum([
  'PUBLIC',
  'WEAPONIZED',
  'POC',
  'FUNCTIONAL',
  'UNPROVEN',
  'NOT_AVAILABLE',
]);

/**
 * Vulnerability Schema
 */
export const vulnerabilitySchema = z.object({
  id: z.string(),
  cveId: z.string().optional(),
  title: z.string(),
  description: z.string(),

  // Severity and scoring
  severity: vulnerabilitySeverityEnum,
  cvssV3: z.object({
    baseScore: z.number().min(0).max(10),
    vectorString: z.string(),
    attackVector: z.enum(['NETWORK', 'ADJACENT', 'LOCAL', 'PHYSICAL']),
    attackComplexity: z.enum(['LOW', 'HIGH']),
    privilegesRequired: z.enum(['NONE', 'LOW', 'HIGH']),
    userInteraction: z.enum(['NONE', 'REQUIRED']),
    scope: z.enum(['UNCHANGED', 'CHANGED']),
    confidentialityImpact: z.enum(['NONE', 'LOW', 'HIGH']),
    integrityImpact: z.enum(['NONE', 'LOW', 'HIGH']),
    availabilityImpact: z.enum(['NONE', 'LOW', 'HIGH']),
  }).optional(),

  cvssV2: z.object({
    baseScore: z.number().min(0).max(10),
    vectorString: z.string(),
  }).optional(),

  // CWE
  cweId: z.string().optional(),
  cweDescription: z.string().optional(),

  // Affected products
  affectedProducts: z.array(z.object({
    vendor: z.string(),
    product: z.string(),
    versions: z.array(z.string()),
    platforms: z.array(z.string()).default([]),
  })).default([]),

  // References
  references: z.array(z.object({
    url: z.string().url(),
    source: z.string(),
    tags: z.array(z.string()).default([]),
  })).default([]),

  // Exploit information
  exploitAvailable: exploitAvailabilityEnum,
  exploitUrls: z.array(z.string().url()).default([]),
  exploitMaturity: z.string().optional(),

  // Patch/Mitigation
  patchAvailable: z.boolean().default(false),
  patchUrls: z.array(z.string().url()).default([]),
  mitigations: z.array(z.string()).default([]),
  workarounds: z.array(z.string()).default([]),

  // Dates
  publishedDate: z.string().datetime(),
  lastModifiedDate: z.string().datetime(),
  disclosureDate: z.string().datetime().optional(),
  patchReleaseDate: z.string().datetime().optional(),

  // Threat intelligence
  exploitedInWild: z.boolean().default(false),
  ransomwareUsage: z.boolean().default(false),
  threatActors: z.array(z.string()).default([]),
  malwareFamilies: z.array(z.string()).default([]),

  // Prioritization
  epssScore: z.number().min(0).max(1).optional(), // Exploit Prediction Scoring System
  priorityScore: z.number().min(0).max(100),

  tenantId: z.string(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Exploit Schema
 */
export const exploitSchema = z.object({
  id: z.string(),
  vulnerabilityId: z.string(),
  cveId: z.string().optional(),

  title: z.string(),
  description: z.string(),
  type: z.enum(['LOCAL', 'REMOTE', 'WEB', 'DOS', 'PRIVILEGE_ESCALATION']),

  // Availability
  availability: exploitAvailabilityEnum,
  sourceUrl: z.string().url().optional(),
  code: z.string().optional(),

  // Metadata
  author: z.string().optional(),
  platform: z.string().optional(),
  verified: z.boolean().default(false),
  reliability: z.enum(['EXCELLENT', 'GOOD', 'NORMAL', 'AVERAGE', 'POOR', 'UNKNOWN']).default('UNKNOWN'),

  publishedDate: z.string().datetime(),
  lastUpdatedDate: z.string().datetime(),

  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Asset Vulnerability Schema
 */
export const assetVulnerabilitySchema = z.object({
  id: z.string(),
  assetId: z.string(),
  vulnerabilityId: z.string(),

  // Status
  status: z.enum(['OPEN', 'MITIGATED', 'PATCHED', 'ACCEPTED', 'FALSE_POSITIVE']),
  priority: z.enum(['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']),

  // Risk assessment
  riskScore: z.number().min(0).max(100),
  exploitability: z.number().min(0).max(100),
  impact: z.number().min(0).max(100),

  // Remediation
  remediationPlan: z.string().optional(),
  dueDate: z.string().datetime().optional(),
  assignedTo: z.string().optional(),

  // Timeline
  discoveredAt: z.string().datetime(),
  firstSeenAt: z.string().datetime(),
  lastSeenAt: z.string().datetime(),
  patchedAt: z.string().datetime().optional(),

  tenantId: z.string(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Type exports
 */
export type Vulnerability = z.infer<typeof vulnerabilitySchema>;
export type VulnerabilitySeverity = z.infer<typeof vulnerabilitySeverityEnum>;
export type Exploit = z.infer<typeof exploitSchema>;
export type ExploitAvailability = z.infer<typeof exploitAvailabilityEnum>;
export type AssetVulnerability = z.infer<typeof assetVulnerabilitySchema>;
