groups:
  - name: intelgraph.application
    rules:
      - alert: HighErrorRate
        expr: rate(application_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          service: intelgraph
        annotations:
          summary: "High application error rate"
          description: "Application error rate is {{ $value }} errors/s"
          runbook_url: "https://docs.intelgraph.com/runbooks/high-error-rate"

      - alert: HighGraphQLErrorRate
        expr: sum(rate(graphql_errors_total[5m])) by (operation) / sum(rate(graphql_requests_total[5m])) by (operation) > 0.05
        for: 5m
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "High GraphQL error rate for {{ $labels.operation }}"
          description: "GraphQL operation {{ $labels.operation }} has >5% error rate"
          runbook_url: "https://docs.intelgraph.com/runbooks/high-graphql-errors"

      - alert: HighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1.5
        for: 5m
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "High HTTP Latency"
          description: "95th percentile HTTP latency is > 1.5s"
          runbook_url: "https://docs.intelgraph.com/runbooks/high-latency"

      - alert: DatabaseSlow
        expr: histogram_quantile(0.95, sum(rate(db_query_duration_seconds_bucket[5m])) by (le, database)) > 0.5
        for: 5m
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "Database query latency high"
          description: "95th percentile DB latency for {{ $labels.database }} is > 500ms"
          runbook_url: "https://docs.intelgraph.com/runbooks/db-latency"

      - alert: SignerFailure
        expr: rate(ledger_signer_failures_total[5m]) > 0.001
        for: 2m
        labels:
          severity: critical
          service: intelgraph
        annotations:
          summary: "Ledger Signer Failure"
          description: "Evidence Ledger signer failure rate is {{ $value }} failures/s"
          runbook_url: "https://docs.intelgraph.com/runbooks/signer-failures"

      - alert: IndexFreshnessLag
        expr: (time() - index_last_update_timestamp_seconds) > 300
        for: 5m
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "Index Freshness Lag"
          description: "Index has not updated in > 5 minutes"
          runbook_url: "https://docs.intelgraph.com/runbooks/index-staleness"

  - name: intelgraph.business
    rules:
      - alert: DropInSignups
        expr: sum(rate(business_user_signups_total[1h])) == 0
        for: 1h
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "Zero signups in last hour"
          description: "No user signups detected in the last hour"
          runbook_url: "https://docs.intelgraph.com/runbooks/zero-signups"

      - alert: DropInRevenue
        expr: sum(rate(business_revenue_total[1h])) < 100
        for: 1h
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "Low revenue detected"
          description: "Revenue rate dropped below threshold"
          runbook_url: "https://docs.intelgraph.com/runbooks/low-revenue"

  - name: intelgraph.infrastructure
    rules:
      - alert: HighMemoryUsage
        expr: application_memory_usage_bytes{component="heap_used"} / application_memory_usage_bytes{component="heap_total"} > 0.9
        for: 5m
        labels:
          severity: critical
          service: intelgraph
        annotations:
          summary: "High Memory Usage"
          description: "Heap usage is over 90%"
          runbook_url: "https://docs.intelgraph.com/runbooks/high-memory"

      - alert: SLOBurn
        expr: slo_burn_rate_1h > 10
        for: 2m
        labels:
          severity: critical
          service: intelgraph
        annotations:
          summary: "SLO Burn Rate High"
          description: "SLO is burning at 10x rate"
          runbook_url: "https://docs.intelgraph.com/runbooks/slo-burn"

      - alert: NarrativeVelocityAnomaly
        expr: narrative_velocity_score > 3
        for: 5m
        labels:
          severity: warning
          service: intelgraph
        annotations:
          summary: "Narrative Velocity Anomaly"
          description: "Z-score of narrative velocity > 3"
          runbook_url: "https://docs.intelgraph.com/runbooks/narrative-velocity"

  - name: intelgraph.ai
    rules:
      - alert: LLMErrorRate
        expr: sum(rate(llm_requests_total{status="error"}[5m])) / sum(rate(llm_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          service: intelgraph-ai
        annotations:
          summary: "High LLM Error Rate"
          description: "LLM error rate is > 5%"
          runbook_url: "https://docs.intelgraph.com/runbooks/llm-errors"

      - alert: LLMHighLatency
        expr: histogram_quantile(0.95, sum(rate(llm_request_duration_seconds_bucket[5m])) by (le)) > 10
        for: 5m
        labels:
          severity: warning
          service: intelgraph-ai
        annotations:
          summary: "High LLM Latency"
          description: "95th percentile LLM latency is > 10s"
          runbook_url: "https://docs.intelgraph.com/runbooks/llm-latency"

      - alert: AIJobQueueBacklog
        expr: ai_jobs_queued > 50
        for: 5m
        labels:
          severity: warning
          service: intelgraph-ai
        annotations:
          summary: "AI Job Queue Backlog"
          description: "More than 50 AI jobs queued for > 5 minutes"
          runbook_url: "https://docs.intelgraph.com/runbooks/ai-queue-backlog"

  - name: maestro.orchestration
    rules:
      - alert: MaestroDeploymentFailure
        expr: increase(maestro_deployments_total{status="failed"}[1h]) > 0
        for: 1m
        labels:
          severity: critical
          service: maestro
        annotations:
          summary: "Maestro Deployment Failed"
          description: "A deployment failed in the last hour"
          runbook_url: "https://docs.intelgraph.com/runbooks/maestro-deployment-failure"

      - alert: MaestroChangeFailureRateHigh
        expr: maestro_change_failure_rate > 0.1
        for: 15m
        labels:
          severity: warning
          service: maestro
        annotations:
          summary: "High Change Failure Rate"
          description: "Change failure rate is > 10%"
          runbook_url: "https://docs.intelgraph.com/runbooks/maestro-cfr"

      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state == 1
        for: 1m
        labels:
          severity: critical
          service: intelgraph
        annotations:
          summary: "Circuit Breaker Open"
          description: "Circuit breaker for {{ $labels.service }} is OPEN"
          runbook_url: "https://docs.intelgraph.com/runbooks/circuit-breaker"
