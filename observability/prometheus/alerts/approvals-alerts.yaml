groups:
  - name: approvals-service-alerts
    interval: 30s
    rules:
      # ===========================================================================
      # SLO: Latency
      # ===========================================================================
      - alert: ApprovalsHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(approvals_http_request_duration_seconds_bucket{job="approvals-service"}[5m])) by (le)
          ) > 1.5
        for: 5m
        labels:
          severity: warning
          component: approvals-service
          slo: latency
        annotations:
          summary: "Approvals service p95 latency is high"
          description: "The 95th percentile latency for the approvals service has been above 1.5s for 5 minutes. Current value: {{ $value | humanizeDuration }}"
          runbook_url: "https://runbooks.summit.io/approvals/high-latency"

      - alert: ApprovalsLatencyCritical
        expr: |
          histogram_quantile(0.95,
            sum(rate(approvals_http_request_duration_seconds_bucket{job="approvals-service"}[5m])) by (le)
          ) > 3
        for: 2m
        labels:
          severity: critical
          component: approvals-service
          slo: latency
        annotations:
          summary: "Approvals service latency is critical"
          description: "The 95th percentile latency has exceeded 3s for 2 minutes. This is blocking approval workflows."
          runbook_url: "https://runbooks.summit.io/approvals/high-latency"

      # ===========================================================================
      # SLO: Error Rate
      # ===========================================================================
      - alert: ApprovalsHighErrorRate
        expr: |
          (
            sum(rate(approvals_http_requests_total{job="approvals-service",status_code=~"5.."}[5m]))
            /
            sum(rate(approvals_http_requests_total{job="approvals-service"}[5m]))
          ) > 0.005
        for: 5m
        labels:
          severity: warning
          component: approvals-service
          slo: error_rate
        annotations:
          summary: "Approvals service error rate elevated"
          description: "Error rate has exceeded 0.5% for 5 minutes. Current rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://runbooks.summit.io/approvals/high-error-rate"

      - alert: ApprovalsErrorRateCritical
        expr: |
          (
            sum(rate(approvals_http_requests_total{job="approvals-service",status_code=~"5.."}[5m]))
            /
            sum(rate(approvals_http_requests_total{job="approvals-service"}[5m]))
          ) > 0.01
        for: 2m
        labels:
          severity: critical
          component: approvals-service
          slo: error_rate
        annotations:
          summary: "Approvals service error rate is critical"
          description: "Error rate has exceeded 1% for 2 minutes. Approval workflows are failing."
          runbook_url: "https://runbooks.summit.io/approvals/high-error-rate"

      # ===========================================================================
      # OPA Health
      # ===========================================================================
      - alert: ApprovalsOPAUnavailable
        expr: |
          sum(increase(approvals_opa_errors_total{job="approvals-service",error_type="unavailable"}[5m])) > 5
        for: 2m
        labels:
          severity: critical
          component: approvals-service
          dependency: opa
        annotations:
          summary: "OPA service is unavailable"
          description: "The approvals service cannot reach OPA. Policy evaluation is failing. Count: {{ $value }}"
          runbook_url: "https://runbooks.summit.io/approvals/opa-unavailable"

      - alert: ApprovalsOPAHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(approvals_opa_latency_seconds_bucket{job="approvals-service"}[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          component: approvals-service
          dependency: opa
        annotations:
          summary: "OPA policy evaluation is slow"
          description: "OPA p95 latency has exceeded 500ms for 5 minutes. Current: {{ $value | humanizeDuration }}"
          runbook_url: "https://runbooks.summit.io/approvals/opa-slow"

      # ===========================================================================
      # Database Health
      # ===========================================================================
      - alert: ApprovalsDatabaseErrors
        expr: |
          sum(increase(approvals_db_errors_total{job="approvals-service"}[5m])) > 10
        for: 2m
        labels:
          severity: critical
          component: approvals-service
          dependency: database
        annotations:
          summary: "Database errors in approvals service"
          description: "Database errors detected: {{ $value }} in last 5 minutes"
          runbook_url: "https://runbooks.summit.io/approvals/database-errors"

      - alert: ApprovalsDatabaseSlowQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(approvals_db_query_duration_seconds_bucket{job="approvals-service"}[5m])) by (le)
          ) > 1
        for: 5m
        labels:
          severity: warning
          component: approvals-service
          dependency: database
        annotations:
          summary: "Database queries are slow"
          description: "p95 query latency has exceeded 1s. Current: {{ $value | humanizeDuration }}"
          runbook_url: "https://runbooks.summit.io/approvals/slow-queries"

      # ===========================================================================
      # Provenance Health
      # ===========================================================================
      - alert: ApprovalsProvenanceErrors
        expr: |
          sum(increase(approvals_provenance_errors_total{job="approvals-service"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          component: approvals-service
          dependency: provenance
        annotations:
          summary: "Provenance receipt creation failing"
          description: "Provenance errors detected: {{ $value }} in last 5 minutes. Audit trail may be incomplete."
          runbook_url: "https://runbooks.summit.io/approvals/provenance-errors"

      # ===========================================================================
      # Business Metrics
      # ===========================================================================
      - alert: ApprovalsPendingBacklog
        expr: |
          sum(approvals_requests_active{job="approvals-service"}) > 100
        for: 30m
        labels:
          severity: warning
          component: approvals-service
        annotations:
          summary: "Large backlog of pending approvals"
          description: "There are {{ $value }} pending approval requests. This may indicate blocked workflows."
          runbook_url: "https://runbooks.summit.io/approvals/pending-backlog"

      - alert: ApprovalsExpiredSurge
        expr: |
          sum(increase(approvals_expired_total{job="approvals-service"}[1h])) > 10
        for: 5m
        labels:
          severity: warning
          component: approvals-service
        annotations:
          summary: "High number of expired approvals"
          description: "{{ $value }} approval requests have expired in the last hour. Workflows may be stuck."
          runbook_url: "https://runbooks.summit.io/approvals/expired-surge"

      # ===========================================================================
      # Service Availability
      # ===========================================================================
      - alert: ApprovalsServiceDown
        expr: |
          up{job="approvals-service"} == 0
        for: 1m
        labels:
          severity: critical
          component: approvals-service
        annotations:
          summary: "Approvals service is down"
          description: "The approvals service is not responding to health checks."
          runbook_url: "https://runbooks.summit.io/approvals/service-down"

      - alert: ApprovalsNoTraffic
        expr: |
          sum(rate(approvals_http_requests_total{job="approvals-service"}[10m])) == 0
        for: 15m
        labels:
          severity: warning
          component: approvals-service
        annotations:
          summary: "No traffic to approvals service"
          description: "The approvals service has received no traffic for 15 minutes. This may indicate routing issues."
          runbook_url: "https://runbooks.summit.io/approvals/no-traffic"
