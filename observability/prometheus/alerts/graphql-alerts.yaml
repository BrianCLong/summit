# GraphQL API Alerting Rules
# SLO-based alerts for GraphQL gateway performance and availability

groups:
  - name: graphql_api_slo
    interval: 30s
    rules:
      # === SEVERE (Sev-1) Alerts ===

      - alert: GraphQLHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(graphql_query_duration_ms_bucket[5m])) by (le, operation)
          ) > 2000
        for: 5m
        labels:
          severity: critical
          component: graphql-gateway
        annotations:
          summary: 'GraphQL API p95 latency > 2s for {{ $labels.operation }}'
          description: |
            The 95th percentile latency for GraphQL operation {{ $labels.operation }}
            has been above 2 seconds for the past 5 minutes.
            Current value: {{ $value | humanizeDuration }}
          runbook_url: 'https://github.com/BrianCLong/summit/blob/main/RUNBOOKS/graphql-high-latency.md'

      - alert: GraphQLHighErrorRate
        expr: |
          (
            sum(rate(graphql_requests_total{status="error"}[5m])) by (operation)
            /
            sum(rate(graphql_requests_total[5m])) by (operation)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: graphql-gateway
        annotations:
          summary: 'GraphQL error rate > 5% for {{ $labels.operation }}'
          description: |
            The error rate for GraphQL operation {{ $labels.operation }}
            has exceeded 5% for the past 5 minutes.
            Current error rate: {{ $value | humanizePercentage }}
          runbook_url: 'https://github.com/BrianCLong/summit/blob/main/RUNBOOKS/graphql-high-error-rate.md'

      - alert: GoldenPathBroken
        expr: |
          (
            sum(rate(golden_path_success_total[10m])) by (step)
            /
            (sum(rate(golden_path_success_total[10m])) by (step) +
             sum(rate(golden_path_errors_total[10m])) by (step))
          ) < 0.95
        for: 10m
        labels:
          severity: critical
          component: golden-path
          slo: availability
        annotations:
          summary: 'Golden path success rate < 95% for step {{ $labels.step }}'
          description: |
            The golden path step {{ $labels.step }} has a success rate below 95%
            for the past 10 minutes. This violates our core SLO.
            Current success rate: {{ $value | humanizePercentage }}
          runbook_url: 'https://github.com/BrianCLong/summit/blob/main/RUNBOOKS/golden-path-failure.md'

      - alert: GraphQLGatewayDown
        expr: up{job="graphql-gateway"} == 0
        for: 1m
        labels:
          severity: critical
          component: graphql-gateway
        annotations:
          summary: 'GraphQL Gateway is down'
          description: |
            The GraphQL Gateway instance {{ $labels.instance }} has been down
            for more than 1 minute.
          runbook_url: 'https://github.com/BrianCLong/summit/blob/main/RUNBOOKS/service-down.md'

      # === WARNING (Sev-2) Alerts ===

      - alert: GraphQLModerateLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(graphql_query_duration_ms_bucket[10m])) by (le, operation)
          ) > 1000
        for: 10m
        labels:
          severity: warning
          component: graphql-gateway
        annotations:
          summary: 'GraphQL API p95 latency > 1s for {{ $labels.operation }}'
          description: |
            The 95th percentile latency for GraphQL operation {{ $labels.operation }}
            has been above 1 second for the past 10 minutes.
            Current value: {{ $value | humanizeDuration }}

      - alert: GraphQLModerateErrorRate
        expr: |
          (
            sum(rate(graphql_requests_total{status="error"}[10m])) by (operation)
            /
            sum(rate(graphql_requests_total[10m])) by (operation)
          ) > 0.02
        for: 10m
        labels:
          severity: warning
          component: graphql-gateway
        annotations:
          summary: 'GraphQL error rate > 2% for {{ $labels.operation }}'
          description: |
            The error rate for GraphQL operation {{ $labels.operation }}
            has exceeded 2% for the past 10 minutes.
            Current error rate: {{ $value | humanizePercentage }}

      - alert: GoldenPathDegraded
        expr: |
          (
            sum(rate(golden_path_success_total[15m])) by (step)
            /
            (sum(rate(golden_path_success_total[15m])) by (step) +
             sum(rate(golden_path_errors_total[15m])) by (step))
          ) < 0.98
        for: 15m
        labels:
          severity: warning
          component: golden-path
          slo: availability
        annotations:
          summary: 'Golden path success rate < 98% for step {{ $labels.step }}'
          description: |
            The golden path step {{ $labels.step }} has a success rate below 98%
            for the past 15 minutes.
            Current success rate: {{ $value | humanizePercentage }}

      - alert: Neo4jSlowQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(neo4j_query_duration_ms_bucket[10m])) by (le)
          ) > 500
        for: 10m
        labels:
          severity: warning
          component: neo4j
        annotations:
          summary: 'Neo4j p95 query latency > 500ms'
          description: |
            Neo4j queries are running slow. The 95th percentile latency
            has been above 500ms for the past 10 minutes.
            Current value: {{ $value | humanizeDuration }}

      - alert: GraphQLHighQueryComplexity
        expr: |
          avg(graphql_query_complexity) by (operation) > 100
        for: 5m
        labels:
          severity: warning
          component: graphql-gateway
        annotations:
          summary: 'GraphQL query complexity > 100 for {{ $labels.operation }}'
          description: |
            The average query complexity for {{ $labels.operation }} is {{ $value }}.
            Consider implementing query cost limits or optimizing the query.

      - alert: GraphQLLowCacheHitRate
        expr: |
          (
            sum(rate(graphql_cache_hits_total[10m])) by (operation)
            /
            (sum(rate(graphql_cache_hits_total[10m])) by (operation) +
             sum(rate(graphql_cache_misses_total[10m])) by (operation))
          ) < 0.5
        for: 15m
        labels:
          severity: warning
          component: graphql-gateway
        annotations:
          summary: 'GraphQL cache hit rate < 50% for {{ $labels.operation }}'
          description: |
            The cache hit rate for {{ $labels.operation }} is only {{ $value | humanizePercentage }}.
            Consider reviewing cache configuration or TTL settings.
