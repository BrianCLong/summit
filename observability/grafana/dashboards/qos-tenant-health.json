{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "type": "datasource",
      "pluginId": "prometheus"
    }
  ],
  "folder": {
    "name": "/Platform/QoS"
  },
  "title": "QoS Tenant Health",
  "panels": [
    {
      "title": "Top Tenants by Exploration Cap Denies (30d)",
      "type": "table",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "topk(20, sum by (tenant) (increase(admission_decision_total{decision=\"deny\",reason=~\"exploration cap.*\"}[30d])))",
          "legendFormat": "{{tenant}}"
        }
      ],
      "overrides": [
        {
          "matcher": {
            "id": "byName",
            "options": "tenant"
          },
          "properties": [
            {
              "id": "links",
              "value": [
                {
                  "title": "Create Upgrade Ticket",
                  "url": "https://slack.com/app_redirect?team=T012345&channel=C67890&text=Upgrade%20ticket%20for%20tenant%3A%20${__cell:text}"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "title": "Tenant Cost (24h)",
      "type": "table",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "sum by (tenant) (tenant:cost_usd_24h)",
          "legendFormat": "{{tenant}}"
        }
      ]
    },
    {
      "title": "Quota Breaches (15m)",
      "type": "table",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "sum by (tenant, quota_type) (increase(tenant_quota_breach_total[15m]))",
          "legendFormat": "{{tenant}}/{{quota_type}}"
        }
      ]
    },
    {
      "title": "Tenant Ramp State",
      "type": "table",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "max by (tenant, state) (tenant:ramp_state)",
          "legendFormat": "{{tenant}}/{{state}}"
        }
      ]
    },
    {
      "title": "Purge Queue Depth",
      "type": "table",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "max by (tenant, queue) (tenant:purge_queue_depth)",
          "legendFormat": "{{tenant}}/{{queue}}"
        }
      ]
    },
    {
      "title": "Restore Freshness (hours)",
      "type": "table",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "max by (tenant) (tenant:restore_freshness_seconds) / 3600",
          "legendFormat": "{{tenant}}"
        }
      ]
    }
  ]
}
