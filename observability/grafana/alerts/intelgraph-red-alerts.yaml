apiVersion: 1
groups:
  - name: intelgraph-red
    interval: 1m
    rules:
      - alert: IntelGraphHighErrorRate
        expr: >-
          sum by (service) (rate(http_requests_total{status=~"5..",service!=""}[5m]))
            /
          sum by (service) (rate(http_requests_total{service!=""}[5m]))
            > 0.05
        for: 5m
        labels:
          severity: critical
          team: sre
          channel: pager
        annotations:
          summary: "High error rate for {{ $labels.service }}"
          description: >-
            5xx error ratio is above 5% for service {{ $labels.service }} over the last 5 minutes.
            Investigate recent deploys, dependency health, and upstream timeouts.
          runbook_url: docs/observability/runbooks/error-budget-runbook.md

      - alert: IntelGraphP95LatencyRegression
        expr: >-
          histogram_quantile(0.95, sum by (service, le) (rate(http_request_duration_seconds_bucket{service!=""}[5m])))
            > 0.75
        for: 10m
        labels:
          severity: warning
          team: sre
          channel: alerts
        annotations:
          summary: "p95 latency regression for {{ $labels.service }}"
          description: >-
            The 95th percentile latency is above 750ms for 10m. Check downstream dependency health
            and recent configuration changes before paging end users.
          runbook_url: docs/observability/runbooks/latency-slo-runbook.md

      - alert: IntelGraphCpuSaturation
        expr: >-
          sum by (namespace) (rate(container_cpu_usage_seconds_total{container!="",namespace!=""}[5m]))
            /
          clamp_min(sum by (namespace) (kube_pod_container_resource_limits_cpu_cores{namespace!="",container!=""}), 0.001)
            > 0.85
        for: 10m
        labels:
          severity: warning
          team: sre
          channel: alerts
        annotations:
          summary: "CPU saturation in {{ $labels.namespace }}"
          description: >-
            Namespace {{ $labels.namespace }} is consuming more than 85% of provisioned CPU for 10m.
            Consider scaling the workload or checking for runaway requests.
          runbook_url: docs/observability/runbooks/saturation-runbook.md

      - alert: IntelGraphMemorySaturation
        expr: >-
          sum by (namespace) (container_memory_working_set_bytes{container!="",namespace!=""})
            /
          clamp_min(sum by (namespace) (kube_pod_container_resource_limits_memory_bytes{namespace!="",container!=""}), 1)
            > 0.9
        for: 10m
        labels:
          severity: warning
          team: sre
          channel: alerts
        annotations:
          summary: "Memory saturation in {{ $labels.namespace }}"
          description: >-
            Namespace {{ $labels.namespace }} is above 90% of provisioned memory for 10m. Review pod
            limits and recent deployment changes to avoid OOMKills.
          runbook_url: docs/observability/runbooks/saturation-runbook.md
