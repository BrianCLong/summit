version: '3.9'

services:
  postgres:
    image: postgres:16-alpine
    container_name: summit-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: summit_dev
      POSTGRES_USER: summit
      POSTGRES_PASSWORD: devpassword
    ports:
      - '5432:5432'
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -U summit -d summit_dev' ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - summit

  redis:
    image: redis:7-alpine
    container_name: summit-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - '6379:6379'
    healthcheck:
      test: [ 'CMD', 'redis-cli', 'ping' ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - summit

  neo4j:
    image: neo4j:5-community
    container_name: summit-neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: neo4j/devpassword
      NEO4J_dbms_security_procedures_unrestricted: gds.*,apoc.*
      NEO4J_PLUGINS: '["apoc","graph-data-science"]'
    ports:
      - '7474:7474'
      - '7687:7687'
    healthcheck:
      test: [ 'CMD-SHELL', 'cypher-shell -u neo4j -p devpassword "RETURN 1"' ]
      interval: 15s
      timeout: 10s
      retries: 5
    networks:
      - summit

  api:
    image: summit-server:latest
    container_name: summit-api
    restart: unless-stopped
    environment:
      PORT: 4000
      DATABASE_URL: postgresql://summit:devpassword@postgres:5432/summit_dev
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: devpassword
      REDIS_URL: redis://redis:6379
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      JWT_SECRET: a_very_long_secret_for_hardening_verification_32_chars
      JWT_REFRESH_SECRET: another_very_long_secret_for_hardening_verification_32_chars
      NODE_ENV: development
      SKIP_FEDERAL_CHECKS: "true"
      ALLOW_SOFTWARE_CRYPTO: "true"
      OTEL_SERVICE_NAME: summit-api
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    ports:
      - '4001:4000'
    volumes:
      - ./server/src/index-hardening.ts:/app/src/index.ts
      - ./server/src/app-hardening.ts:/app/src/app.ts
      - ./server/src/federal/hsm-enforcement.ts:/app/src/federal/hsm-enforcement.ts
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      neo4j:
        condition: service_started
    healthcheck:
      test: [ 'CMD', 'curl', '-f', 'http://localhost:4000/health/ready' ]
      interval: 15s
      timeout: 10s
      retries: 5
    networks:
      - summit

  gateway:
    image: summit-gateway:latest
    container_name: summit-gateway
    restart: unless-stopped
    environment:
      PORT: 4000
      NODE_ENV: development
      GRAPH_SERVICE_URL: http://api:4000/graphql
      OTEL_SERVICE_NAME: summit-gateway
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    volumes:
      - ./gateway-proxy.js:/app/server.js
    depends_on:
      api:
        condition: service_healthy
    ports:
      - '4000:4000'
    healthcheck:
      test: [ 'CMD', 'curl', '-f', 'http://localhost:4000/health' ]
      interval: 15s
      timeout: 5s
      retries: 5
    networks:
      - summit

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.87.0
    container_name: summit-otel-collector
    command: [ '--config=/etc/otel-collector-config.yml' ]
    volumes:
      - ./observability/otel/collector-config-dev.yaml:/etc/otel-collector-config.yml
    networks:
      - summit

networks:
  summit:
    driver: bridge
