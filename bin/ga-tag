#!/bin/bash
set -e

# GA Tagging Script
# Validates state, extracts version, and creates a canonical GA tag.
# Usage: ./bin/ga-tag [optional-version-override]

TAG_PREFIX="ga/v"
PYPROJECT_FILE="pyproject.toml"

# 1. Validate Clean Git State
if [ -n "$(git status --porcelain)" ]; then
  echo "❌ Error: Dirty git state. Please commit or stash changes before cutting a GA tag."
  exit 1
fi

# 2. Determine Version
VERSION=""
if [ -f "$PYPROJECT_FILE" ]; then
  # Extract version using python to handle toml parsing robustly
  VERSION=$(python3 -c "
import sys
import re

try:
    import tomllib
    with open('$PYPROJECT_FILE', 'rb') as f:
        data = tomllib.load(f)
        v = data.get('project', {}).get('version')
        if v:
            print(v)
            sys.exit(0)
except ImportError:
    pass

# Fallback regex if tomllib is missing or structure differs
with open('$PYPROJECT_FILE', 'r') as f:
    content = f.read()
    match = re.search(r'^\s*version\s*=\s*\"([^\"]+)\"', content, re.MULTILINE)
    if match:
        print(match.group(1))
    else:
        sys.exit(1)
" 2>/dev/null || true)
fi

# Fallback to command line argument if extraction failed
if [ -z "$VERSION" ]; then
  if [ -n "$1" ]; then
    # Strip potential 'v' prefix from input
    VERSION="${1#v}"
    echo "⚠️  Could not determine version from $PYPROJECT_FILE. Using input: $VERSION"
  else
    echo "❌ Error: Could not determine version from $PYPROJECT_FILE and no argument provided."
    echo "Usage: ./bin/ga-tag <version>"
    exit 1
  fi
fi

TAG="${TAG_PREFIX}${VERSION}"

# 3. Idempotency Check
if git rev-parse "$TAG" >/dev/null 2>&1; then
  echo "⚠️  Tag '$TAG' already exists."
  # Dereference tag to commit for comparison
  EXISTING_COMMIT=$(git rev-parse "$TAG^{commit}")
  CURRENT_COMMIT=$(git rev-parse HEAD)

  if [ "$EXISTING_COMMIT" = "$CURRENT_COMMIT" ]; then
    echo "✅ Tag points to current HEAD. Nothing to do."
    exit 0
  else
    echo "❌ Error: Tag '$TAG' exists but points to a different commit ($EXISTING_COMMIT)."
    exit 1
  fi
fi

# 4. Create Annotated Tag
echo "Creating GA tag: $TAG"
git tag -a "$TAG" -m "GA Release $VERSION"

echo "✅ Tag created: $TAG"
echo "To push this tag and trigger the release pipeline, run:"
echo "  git push origin $TAG"
