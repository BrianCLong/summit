version: "3.9"

services:
  # Open Policy Agent
  opa:
    image: openpolicyagent/opa:latest-debug
    container_name: conductor-opa
    command:
      - "run"
      - "--server"
      - "--config-file=/config/config.yaml"
      - "--log-level=debug"
    ports:
      - "8181:8181"
    depends_on:
      bundle-server:
        condition: service_started
    volumes:
      - ./opa/config.yaml:/config/config.yaml:ro
      - ./opa/data:/data:ro
    environment:
      - OPA_LOG_LEVEL=debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  bundle-server:
    build: ./bundle-server
    ports:
      - "3001:3001"
    volumes:
      - ./bundle-server/bundles:/usr/src/app/bundles:ro

  # Redis for caching and queues
  redis:
    image: redis:7-alpine
    container_name: conductor-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Conductor API with OPA integration
  conductor-api:
    build: .
    container_name: conductor-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - REDIS_URL=redis://redis:6379
      - OPA_BASE_URL=http://opa:8181
      - OPA_POLICY_VERSION=1.0
      - CONDUCTOR_ROLE=api
    depends_on:
      opa:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./server/src:/app/src:ro
      - ./opa:/app/opa:ro

volumes:
  redis-data:
    driver: local
