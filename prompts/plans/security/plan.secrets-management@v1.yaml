meta:
  id: plan.secrets-management@v1
  owner: 'security-engineering'
  purpose: 'Centralize secret handling with vault integration and rotation policies'
  tags:
    - security
    - secrets
    - vault
    - rotation
    - compliance
  guardrails:
    - 'No secrets in source code or logs'
    - 'Rotation must not cause outages'
    - 'Access to secrets must be audited'
    - 'Emergency access procedures documented'

modelConfig:
  model: 'gpt-4'
  temperature: 0.2
  maxTokens: 4000

inputs:
  secret_types: string
  current_storage: string
  rotation_requirements: string
  access_patterns: string
  compliance_requirements: string

template: |
  You are a Security Engineer designing secrets management for Summit/IntelGraph.

  **Objective:** Centralize secret handling and rotation.

  **Secret Types:**
  {{secret_types}}

  **Current Storage:**
  {{current_storage}}

  **Rotation Requirements:**
  {{rotation_requirements}}

  **Access Patterns:**
  {{access_patterns}}

  **Compliance Requirements:**
  {{compliance_requirements}}

  ## Deliverables

  ### 1. Vault Integration Plan
  ```yaml
  vault_architecture:
    provider: HashiCorp Vault | AWS Secrets Manager | Azure Key Vault
    deployment:
      - HA cluster with 3+ nodes
      - Auto-unseal (cloud KMS)
      - Audit logging enabled

    engines:
      - kv-v2: Static secrets
      - database: Dynamic database credentials
      - pki: Certificate management
      - transit: Encryption as a service

    authentication:
      kubernetes:
        - ServiceAccount JWT
        - Namespace-scoped
        - Role per service
      appRole:
        - CI/CD pipelines
        - Wrapped secret IDs

    policies:
      - name: api-server
        paths:
          - "secret/data/api/*": ["read"]
          - "database/creds/api-db": ["read"]
      - name: worker
        paths:
          - "secret/data/worker/*": ["read"]
  ```

  ### 2. Secret Categories and Storage
  | Category | Examples | Storage | Rotation | Access |
  |----------|----------|---------|----------|--------|
  | Database | PostgreSQL, Neo4j creds | Vault dynamic | 24h | Services only |
  | API Keys | Third-party APIs | Vault KV | 90 days | Services only |
  | JWT Secrets | Signing keys | Vault transit | 30 days | Auth service |
  | Encryption Keys | Data encryption | Vault transit | Annual | Encryption service |
  | Service Tokens | Inter-service auth | Vault AppRole | 1h | Each service |

  ### 3. Rotation Cadence and Playbooks
  ```yaml
  rotation:
    database_credentials:
      frequency: 24 hours
      method: dynamic (Vault database engine)
      zero_downtime: true
      playbook:
        1. Vault generates new credential
        2. Application fetches new credential
        3. Connection pool refreshed
        4. Old credential remains valid for TTL
        5. Automatic cleanup

    api_keys:
      frequency: 90 days
      method: manual with notification
      zero_downtime: true
      playbook:
        1. Generate new key in provider
        2. Store in Vault
        3. Deploy with new key
        4. Verify functionality
        5. Revoke old key

    jwt_secrets:
      frequency: 30 days
      method: key rotation with grace period
      zero_downtime: true
      playbook:
        1. Generate new signing key
        2. Add to JWKS with new kid
        3. Start signing with new key
        4. Old key valid for verification (7 days)
        5. Remove old key from JWKS

    emergency_rotation:
      triggers:
        - Suspected compromise
        - Employee departure
        - Security incident
      playbook:
        1. Assess blast radius
        2. Rotate affected secrets immediately
        3. Audit access logs
        4. Update all consuming services
        5. Post-incident review
  ```

  ### 4. CI/CD Secrets Integration
  ```yaml
  ci_integration:
    github_actions:
      method: OIDC with Vault
      configuration:
        - GitHub OIDC provider in Vault
        - Bound claims: repository, ref
        - Short-lived tokens (15 min)

    pipeline_secrets:
      - NPM_TOKEN: From Vault, per-job
      - DOCKER_REGISTRY: From Vault, per-job
      - DEPLOY_KEY: From Vault, ephemeral

    best_practices:
      - Never log secrets
      - Mask in CI output
      - Use Vault Agent sidecar
      - Prefer dynamic over static
      - Audit all access
  ```

  ### 5. Access Control and Auditing
  ```yaml
  access_control:
    authentication:
      - Kubernetes ServiceAccount for apps
      - OIDC for humans (via SSO)
      - AppRole for CI/CD

    authorization:
      - Least privilege policies
      - Namespace isolation
      - Time-based access (break-glass)

    auditing:
      - All access logged
      - Log forwarding to SIEM
      - Alerting on anomalies
      - Retention: 1 year

    monitoring:
      metrics:
        - vault_token_count
        - vault_secret_reads
        - vault_auth_failures
      alerts:
        - High auth failure rate
        - Unusual access patterns
        - Policy violations
  ```

  ### 6. Implementation Tasks
  ```
  [ ] Task 1: [description] (estimated: Xh, risk: low/med/high)
  [ ] Task 2: [description] (estimated: Xh, risk: low/med/high)
  ...
  ```

  ## Acceptance Criteria
  - [ ] Vault deployed and accessible
  - [ ] All services migrated to Vault
  - [ ] Rotation policies in place
  - [ ] Access audited and logged
  - [ ] Emergency procedures documented

  ## Rollback Plan
  - Keep backup of old secrets
  - Fallback to K8s secrets if Vault unavailable
  - Document manual rotation procedures

  **Confidence Level:** [0-100]%

examples:
  - name: 'vault-integration'
    inputs:
      secret_types: 'Database credentials, API keys, JWT signing keys, encryption keys'
      current_storage: 'Kubernetes secrets, environment variables, some in .env files'
      rotation_requirements: 'Database: daily, API keys: quarterly, JWT: monthly'
      access_patterns: '10 services, CI/CD pipelines, admin access for ops'
      compliance_requirements: 'SOC2, audit logging, access controls'
    expected_contains:
      - 'Vault Integration'
      - 'Rotation'
      - 'CI/CD'
      - 'Access Control'
