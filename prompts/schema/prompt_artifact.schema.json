{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://topicality.co/schemas/prompt_artifact.schema.json",
  "title": "Prompt Artifact Model",
  "type": "object",
  "required": [
    "id",
    "name",
    "version",
    "owner",
    "intent",
    "inputs",
    "outputs",
    "invariants",
    "determinism",
    "tools",
    "safety",
    "evals",
    "composition"
  ],
  "properties": {
    "id": { "type": "string", "pattern": "^prompt\\.[a-z0-9_\\.\\-]+$" },
    "name": { "type": "string", "minLength": 3 },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z\\-\\.]+)?(?:\\+[0-9A-Za-z\\-\\.]+)?$"
    },
    "owner": { "type": "string", "minLength": 2 },
    "status": { "type": "string", "enum": ["active", "deprecated", "experimental"] },
    "intent": { "type": "string", "minLength": 10 },
    "non_goals": { "type": "array", "items": { "type": "string" } },

    "targets": {
      "type": "object",
      "properties": {
        "models": { "type": "array", "items": { "type": "string" } },
        "min_context_tokens": { "type": "integer", "minimum": 1 },
        "max_output_tokens": { "type": "integer", "minimum": 1 }
      },
      "additionalProperties": false
    },

    "inputs": {
      "type": "object",
      "required": ["required_fields"],
      "properties": {
        "required_fields": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "optional_fields": { "type": "array", "items": { "type": "string" } },
        "constraints": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },

    "outputs": {
      "type": "object",
      "required": ["format", "schema"],
      "properties": {
        "format": { "type": "string", "enum": ["json", "markdown", "text"] },
        "schema": { "type": "object" },
        "example": { "type": "object" }
      },
      "additionalProperties": false
    },

    "invariants": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "level", "assertion"],
        "properties": {
          "id": { "type": "string", "pattern": "^inv\\.[a-z0-9_\\.\\-]+$" },
          "level": { "type": "string", "enum": ["must", "should"] },
          "assertion": { "type": "string", "minLength": 8 }
        },
        "additionalProperties": false
      }
    },

    "determinism": {
      "type": "object",
      "required": ["temperature", "cache_policy", "replay_policy"],
      "properties": {
        "temperature": { "type": "number", "enum": [0] },
        "seed_policy": { "type": "string", "enum": ["none", "fixed"] },
        "cache_policy": { "type": "string", "enum": ["content_addressed", "disabled"] },
        "replay_policy": { "type": "string", "enum": ["replay_only_ci", "allow_record_local"] },
        "prompt_fingerprint": { "type": "string", "enum": ["sha256"] }
      },
      "additionalProperties": false
    },

    "tools": {
      "type": "object",
      "required": ["allowed", "forbidden"],
      "properties": {
        "allowed": { "type": "array", "items": { "type": "string" } },
        "forbidden": { "type": "array", "items": { "type": "string" } },
        "tool_contract_version": { "type": "string" }
      },
      "additionalProperties": false
    },

    "safety": {
      "type": "object",
      "required": ["redaction", "prohibited"],
      "properties": {
        "redaction": { "type": "array", "items": { "type": "string" } },
        "prohibited": { "type": "array", "items": { "type": "string" } },
        "data_handling": { "type": "string" }
      },
      "additionalProperties": false
    },

    "evals": {
      "type": "object",
      "required": ["gates"],
      "properties": {
        "gates": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "datasets": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },

    "composition": {
      "type": "object",
      "required": ["fragments"],
      "properties": {
        "order": {
          "type": "array",
          "items": { "type": "string", "enum": ["role", "policy", "tools", "task", "io", "style"] },
          "minItems": 1
        },
        "fragments": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["type", "path"],
            "properties": {
              "type": { "type": "string", "enum": ["role", "policy", "tools", "task", "io", "style"] },
              "path": { "type": "string", "minLength": 3 }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
