# Core SLO and health probe alerts for IntelGraph services
# These rules compute per-service latency and availability and page when we burn error budgets or probes fail.
groups:
  - name: service-slos
    interval: 30s
    rules:
      - record: service:p95_latency_seconds:rate5m
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service!=""}[5m])) by (le, service))

      - record: service:error_ratio:rate5m
        expr: |
          sum by (service) (rate(http_requests_total{service!="",status=~"5.."}[5m]))
            / clamp_min(sum by (service) (rate(http_requests_total{service!=""}[5m])), 0.001)

      - record: service:error_ratio:rate30m
        expr: |
          sum by (service) (rate(http_requests_total{service!="",status=~"5.."}[30m]))
            / clamp_min(sum by (service) (rate(http_requests_total{service!=""}[30m])), 0.001)

      - alert: ServiceP95LatencyHigh
        expr: service:p95_latency_seconds:rate5m > 1
        for: 10m
        labels:
          severity: page
          slo: latency
          pagerduty: "true"
        annotations:
          summary: "Service p95 latency breaching SLO"
          description: |
            {{ $labels.service }} p95 latency is {{ $value | printf "%.2f" }}s (limit 1.0s) for 10m.
            Check upstream dependencies, cache effectiveness, and recent deploys.
          runbook_url: https://runbooks.intelgraph.io/observability#slo-latency

      - alert: ServiceAvailabilityErrorBudgetBurn
        expr: (service:error_ratio:rate5m > 0.02) and (service:error_ratio:rate30m > 0.01)
        for: 5m
        labels:
          severity: page
          slo: availability
          pagerduty: "true"
        annotations:
          summary: "Service error budget burning too fast"
          description: |
            {{ $labels.service }} 5xx ratio above 2% (5m) and 1% (30m). Investigate recent deploys, dependency errors, and rollout status.
          runbook_url: https://runbooks.intelgraph.io/observability#error-budget

      - alert: HealthProbeFailure
        expr: avg_over_time(probe_success{job="blackbox"}[5m]) < 0.99
        for: 2m
        labels:
          severity: page
          pagerduty: "true"
          slo: availability
        annotations:
          summary: "Blackbox probe failing for {{ $labels.instance }}"
          description: |
            Endpoint {{ $labels.instance }} has <99% success over 5m. Verify ingress, TLS, auth headers, and upstream readiness.
          runbook_url: https://runbooks.intelgraph.io/observability#health-probes
