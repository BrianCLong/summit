apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: agent-queue-scaler
  namespace: intelgraph
  labels:
    app: agent-worker
    component: autoscaler
spec:
  scaleTargetRef:
    name: agent-worker
  pollingInterval: 15
  cooldownPeriod: 150
  minReplicaCount: 2
  maxReplicaCount: 50
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 180
          policies:
            - type: Percent
              value: 100
              periodSeconds: 60
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
            - type: Percent
              value: 50
              periodSeconds: 120
  fallback:
    failureThreshold: 3
    replicaCount: 6
  triggers:
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring:9090
        metricName: agent_queue_slo_pressure
        query: |
          max_over_time(agent_queue_slo_pressure{queue="agent-default"}[2m])
        threshold: "1"
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring:9090
        metricName: agent_workload_latency_burn
        query: |
          histogram_quantile(0.95, rate(agent_workload_queue_wait_seconds_bucket[5m])) / 2
        threshold: "1"
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring:9090
        metricName: agent_queue_cost_pressure
        query: |
          max_over_time(agent_queue_cost_pressure{queue="agent-default"}[5m])
        threshold: "1.05"
