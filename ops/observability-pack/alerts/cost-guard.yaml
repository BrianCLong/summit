# Cost Guard Alerts
# Budget monitoring and automatic cost control

groups:
  - name: cost-guard
    rules:
      # Daily compute budget warning
      - alert: DailyComputeBudgetWarning
        expr: |
          sum(increase(cloud_cost_compute_dollars[24h])) > 400
        for: 5m
        labels:
          severity: warning
          category: cost
        annotations:
          summary: "Daily compute spend at 80% of budget"
          description: "Current daily compute spend: ${{ $value | printf \"%.2f\" }} (budget: $500)"
          runbook_url: "https://runbooks.intelgraph.com/cost-spike"

      # Daily compute budget exceeded
      - alert: DailyComputeBudgetExceeded
        expr: |
          sum(increase(cloud_cost_compute_dollars[24h])) > 500
        for: 5m
        labels:
          severity: critical
          category: cost
        annotations:
          summary: "Daily compute budget exceeded"
          description: "Current daily compute spend: ${{ $value | printf \"%.2f\" }} (budget: $500)"
          runbook_url: "https://runbooks.intelgraph.com/cost-spike"

      # Storage cost spike
      - alert: StorageCostSpike
        expr: |
          (
            sum(increase(cloud_cost_storage_dollars[1h]))
            / sum(increase(cloud_cost_storage_dollars[1h] offset 1d))
          ) > 2
        for: 15m
        labels:
          severity: warning
          category: cost
        annotations:
          summary: "Storage cost spike detected"
          description: "Storage costs are 2x higher than same time yesterday"

      # Network egress spike
      - alert: NetworkEgressSpike
        expr: |
          sum(rate(cloud_network_egress_bytes[1h])) > 100000000
        for: 10m
        labels:
          severity: warning
          category: cost
        annotations:
          summary: "High network egress detected"
          description: "Network egress rate: {{ $value | humanize }}B/s"

      # Monthly budget projection
      - alert: MonthlyBudgetProjectionHigh
        expr: |
          (
            sum(increase(cloud_cost_total_dollars[7d])) / 7 * 30
          ) > 12000
        for: 1h
        labels:
          severity: warning
          category: cost
        annotations:
          summary: "Monthly cost projection exceeds 80% of budget"
          description: "Projected monthly cost: ${{ $value | printf \"%.0f\" }} (budget: $15,000)"

  - name: slow-query-killer
    rules:
      # Long-running Neo4j query
      - alert: SlowNeo4jQuery
        expr: neo4j_query_duration_seconds > 30
        for: 0s
        labels:
          severity: warning
          auto_action: kill_query
        annotations:
          summary: "Long-running Neo4j query detected"
          description: "Query {{ $labels.query_id }} running for {{ $value | humanizeDuration }}"
          action: "Auto-kill after 60s if not completed"

      # Runaway query (auto-kill)
      - alert: RunawayNeo4jQuery
        expr: neo4j_query_duration_seconds > 60
        for: 0s
        labels:
          severity: critical
          auto_action: kill_query_immediate
        annotations:
          summary: "Runaway Neo4j query - auto-killing"
          description: "Query {{ $labels.query_id }} exceeded 60s limit, terminating"

      # Slow PostgreSQL query
      - alert: SlowPostgresQuery
        expr: pg_stat_activity_query_duration_seconds > 30
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "Long-running PostgreSQL query"
          description: "Query on {{ $labels.datname }} running for {{ $value | humanizeDuration }}"

      # High query count (potential runaway)
      - alert: HighQueryRate
        expr: |
          sum(rate(http_requests_total{handler=~".*query.*"}[1m])) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Unusually high query rate"
          description: "{{ $value | printf \"%.0f\" }} queries/second - potential runaway client"

  - name: resource-utilization
    rules:
      # High CPU utilization
      - alert: HighCPUUtilization
        expr: |
          (
            sum(rate(container_cpu_usage_seconds_total[5m])) by (pod)
            / sum(container_spec_cpu_quota / container_spec_cpu_period) by (pod)
          ) > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU utilization"
          description: "Pod {{ $labels.pod }} CPU at {{ $value | humanizePercentage }}"

      # Memory pressure
      - alert: HighMemoryUtilization
        expr: |
          (
            sum(container_memory_working_set_bytes) by (pod)
            / sum(container_spec_memory_limit_bytes) by (pod)
          ) > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory utilization"
          description: "Pod {{ $labels.pod }} memory at {{ $value | humanizePercentage }}"
