{
  "title": "Service Ops & Governance Overview",
  "description": "Health, latency, error budgets, and governance verdict distribution with correlation IDs",
  "editable": true,
  "schemaVersion": 38,
  "version": 1,
  "refresh": "30s",
  "timezone": "UTC",
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h"]
  },
  "templating": {
    "list": [
      {
        "name": "environment",
        "type": "custom",
        "label": "Environment",
        "options": [
          { "text": "prod", "value": "prod", "selected": true },
          { "text": "staging", "value": "staging" },
          { "text": "dev", "value": "dev" }
        ],
        "current": { "text": "prod", "value": "prod" },
        "includeAll": true,
        "multi": true
      },
      {
        "name": "service",
        "type": "custom",
        "label": "Service",
        "options": [
          { "text": "intelgraph-api", "value": "intelgraph-api", "selected": true },
          { "text": "intelgraph-gateway", "value": "intelgraph-gateway" },
          { "text": "intelgraph-ingest", "value": "intelgraph-ingest" }
        ],
        "current": { "text": "intelgraph-api", "value": "intelgraph-api" },
        "includeAll": true,
        "multi": true
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Availability (past 30m)",
      "description": "Success ratio by correlation id so retries are deduped",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "targets": [
        {
          "expr": "(1 - (sum(rate(http_requests_total{job=~\"$service\",environment=~\"$environment\",status=~\"5..\"}[30m])) / sum(rate(http_requests_total{job=~\"$service\",environment=~\"$environment\"}[30m])))) * 100",
          "legendFormat": "Availability",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": 0 },
              { "color": "yellow", "value": 99.0 },
              { "color": "green", "value": 99.5 }
            ]
          }
        },
        "overrides": []
      }
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "Request Latency p95 (ms)",
      "gridPos": { "h": 8, "w": 9, "x": 6, "y": 0 },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job=~\"$service\",environment=~\"$environment\"}[5m])) by (le)) * 1000",
          "legendFormat": "p95",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": 0 },
              { "color": "yellow", "value": 250 },
              { "color": "red", "value": 500 }
            ]
          }
        },
        "overrides": []
      }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Error Budget Remaining",
      "gridPos": { "h": 4, "w": 5, "x": 15, "y": 0 },
      "description": "Remaining error budget computed from SLO burn rate",
      "targets": [
        {
          "expr": "avg(slo_error_budget_remaining{service=~\"$service\",environment=~\"$environment\"}) * 100",
          "legendFormat": "Budget Remaining",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": 0 },
              { "color": "yellow", "value": 25 },
              { "color": "green", "value": 40 }
            ]
          }
        },
        "overrides": []
      }
    },
    {
      "id": 4,
      "type": "bargauge",
      "title": "Governance Verdict Distribution",
      "gridPos": { "h": 8, "w": 9, "x": 0, "y": 4 },
      "description": "Breakdown of allow/deny/escalate decisions with correlation linkage",
      "targets": [
        {
          "expr": "sum(increase(governance_verdict_total{service=~\"$service\",environment=~\"$environment\"}[1h])) by (verdict)",
          "legendFormat": "{{verdict}}",
          "refId": "A"
        }
      ],
      "options": {
        "displayMode": "gradient",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": ["last"],
          "fields": "",
          "values": false
        },
        "showUnfilled": true
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      }
    },
    {
      "id": 5,
      "type": "table",
      "title": "Correlation Coverage",
      "gridPos": { "h": 8, "w": 15, "x": 9, "y": 8 },
      "description": "Trace counts grouped by correlation.id to spot propagation gaps",
      "targets": [
        {
          "expr": "topk(25, sum by (correlation_id) (rate(traces_spanmetrics_calls_total{service_name=~\"$service\",environment=~\"$environment\"}[5m])))",
          "legendFormat": "{{correlation_id}}",
          "refId": "A"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "renameByName": { "Value": "req/s" }
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "req/s",
          "decimals": 2
        },
        "overrides": []
      }
    }
  ]
}
