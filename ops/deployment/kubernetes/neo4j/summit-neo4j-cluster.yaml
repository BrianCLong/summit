apiVersion: neo4j.com/v1
kind: Neo4j
metadata:
  name: summit-neo4j
  namespace: graph-operators
  labels:
    app.kubernetes.io/name: summit-neo4j
    app.kubernetes.io/part-of: summit-data-plane
spec:
  adminUser:
    name: NEO4J_AUTH
    valueFrom:
      secretKeyRef:
        name: summit-neo4j-auth
        key: password
  deploymentMode: CausalCluster
  disablePodMonitor: false
  image: neo4j:5.20.0-enterprise
  core:
    numberOfServers: 3
    persistentVolumeClaim:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
    resources:
      requests:
        cpu: 1
        memory: 4Gi
      limits:
        cpu: 2
        memory: 8Gi
  replica:
    numberOfServers: 2
    persistentVolumeClaim:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 1
        memory: 4Gi
  routing:
    enabled: true
    serviceType: ClusterIP
  config:
    dbms.mode: CORE
    dbms.cluster.raft.minimum_core_cluster_size_at_runtime: "3"
    dbms.routing.enabled: "true"
  podSpec:
    containers:
      - name: neo4j
        env:
          - name: NEO4J_ACCEPT_LICENSE_AGREEMENT
            value: "yes"
        ports:
          - containerPort: 7474
            name: http
          - containerPort: 7687
            name: bolt
        readinessProbe:
          httpGet:
            path: /ready
            port: 7474
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /live
            port: 7474
          initialDelaySeconds: 60
          periodSeconds: 30
    sidecars:
      - name: metrics
        image: ghcr.io/neo4j-contrib/neo4j-prometheus-exporter:4.0.2
        ports:
          - name: metrics
            containerPort: 2004
        env:
          - name: NEO4J_URI
            value: bolt://localhost:7687
          - name: NEO4J_USERNAME
            valueFrom:
              secretKeyRef:
                name: summit-neo4j-auth
                key: username
          - name: NEO4J_PASSWORD
            valueFrom:
              secretKeyRef:
                name: summit-neo4j-auth
                key: password
