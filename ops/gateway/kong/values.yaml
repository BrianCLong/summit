image:
  repository: kong/kong-gateway
  tag: "3.7"

env:
  database: "off"
  role: traditional
  router_flavor: traditional_compatible
  log_level: info
  trusted_ips: 0.0.0.0/0,::/0
  real_ip_recursive: "on"
  anonymous_reports: "off"
  nginx_worker_processes: "auto"
  lua_ssl_verify_depth: 3
  ssl_cipher_suite: modern
  nginx_http_ssl_protocols: "TLSv1.2 TLSv1.3"
  nginx_proxy_real_ip_header: "X-Forwarded-For"
  nginx_proxy_real_ip_recursive: "on"
  proxy_access_log: /dev/stdout
  proxy_error_log: /dev/stderr
  admin_access_log: /dev/stdout
  admin_error_log: /dev/stderr
  status_listen: 0.0.0.0:8100
  dbless_config: /kong_dbless/kong.yaml

proxy:
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
  http:
    enabled: true
    servicePort: 80
  tls:
    enabled: true
    servicePort: 443
    parameters:
      - maxVersion: TLSv1_3
        minVersion: TLSv1_2
        cipherSuites:
          - TLS_AES_256_GCM_SHA384
          - TLS_CHACHA20_POLY1305_SHA256
          - TLS_AES_128_GCM_SHA256

admin:
  enabled: false

status:
  enabled: true
  http:
    enabled: true
    servicePort: 8100

metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s

tracing:
  enabled: true
  sampler: 1.0
  reporter_endpoint: http://jaeger-collector.observability:14268/api/traces
  component_name: kong-gateway

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: 50

nodeSelector: {}

podAnnotations:
  traffic.sidecar.istio.io/includeInboundPorts: "80,443"
  prometheus.io/scrape: "true"
  prometheus.io/port: "8100"

dblessConfig:
  config: |-
    _format_version: "3.0"
    _transform: true
    info:
      select_tags:
        - summit
      description: Summit gateway config
    services:
      - name: catalog-service-v1
        url: http://catalog-v1.default.svc.cluster.local:8080
        retries: 3
        write_timeout: 5000
        read_timeout: 5000
        connect_timeout: 1500
        routes:
          - name: catalog-v1-route
            paths:
              - /api/v1/catalog
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: cors
            config:
              origins:
                - https://app.example.com
              methods:
                - GET
                - POST
              headers:
                - Authorization
                - Content-Type
              exposed_headers:
                - Link
              max_age: 86400
              credentials: true
      - name: catalog-service-v2
        url: http://catalog-v2.default.svc.cluster.local:8080
        retries: 2
        write_timeout: 5000
        read_timeout: 5000
        connect_timeout: 1500
        routes:
          - name: catalog-v2-route
            paths:
              - /api/v2/catalog
              - /api/latest/catalog
            strip_path: true
            methods:
              - GET
              - POST
              - PUT
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
              key_claim_name: kid
              secret_is_base64: false
              run_on_preflight: false
          - name: rate-limiting
            config:
              minute: 1200
              policy: local
              fault_tolerant: true
          - name: request-transformer
            config:
              add:
                headers:
                  - x-api-version: v2
      - name: orders-service
        url: http://orders.default.svc.cluster.local:8080
        retries: 2
        write_timeout: 6000
        read_timeout: 6000
        connect_timeout: 2000
        routes:
          - name: orders-route
            paths:
              - /api/v1/orders
            strip_path: true
            methods:
              - GET
              - POST
              - PATCH
        plugins:
          - name: acl
            config:
              allow:
                - orders-role
          - name: request-termination
            config:
              status_code: 503
              message: "Orders temporarily unavailable"
              trigger:
                fail_on_unhealthy: true
      - name: bff-service
        url: http://bff.default.svc.cluster.local:8080
        routes:
          - name: bff-route
            paths:
              - /api/v1/bff
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: correlation-id
            config:
              header_name: x-request-id
              generator: uuid
              echo_downstream: true
          - name: response-transformer
            config:
              add:
                headers:
                  - x-api-gateway: kong
    upstreams:
      - name: catalog-v1
        healthchecks:
          active:
            type: http
            http_path: /health
            healthy:
              successes: 2
              interval: 10
            unhealthy:
              http_failures: 3
              tcp_failures: 3
              timeouts: 2
              interval: 5
          passive:
            healthy:
              http_statuses:
                - 200
                - 201
              successes: 3
            unhealthy:
              http_statuses:
                - 429
                - 500
                - 502
                - 503
              http_failures: 2
              tcp_failures: 2
              timeouts: 2
      - name: catalog-v2
        slots: 10000
        hash_on: ip
        healthchecks:
          active:
            type: http
            http_path: /health
            timeout: 3
            healthy:
              successes: 2
              interval: 15
            unhealthy:
              http_failures: 2
              tcp_failures: 2
              timeouts: 2
              interval: 5
          passive:
            healthy:
              http_statuses:
                - 200
                - 201
              successes: 1
            unhealthy:
              http_failures: 2
              http_statuses:
                - 500
                - 502
                - 503
                - 504
              tcp_failures: 2
              timeouts: 2
      - name: orders
        healthchecks:
          active:
            type: https
            https_sni: orders.default.svc.cluster.local
            http_path: /health
            healthy:
              interval: 10
              successes: 2
            unhealthy:
              interval: 5
              http_failures: 2
              timeouts: 2
          passive:
            healthy:
              http_statuses:
                - 200
              successes: 1
            unhealthy:
              http_statuses:
                - 429
                - 500
                - 502
                - 503
                - 504
              http_failures: 2
              timeouts: 2
      - name: degraded
        healthchecks:
          passive:
            unhealthy:
              http_statuses:
                - 500
                - 502
                - 503
              http_failures: 1
    plugins:
      - name: prometheus
      - name: bot-detection
        config:
          allow:
            - "Mozilla/5.0"
      - name: request-size-limiting
        config:
          allowed_payload_size: 2
          require_content_length: true
