name: GA Orchestrator (stateful)

on:
  workflow_dispatch:
    inputs:
      command:
        description: "orchestrator command (init|plan|build|release-dry|merge-prs|cleanup-branches|tag-ga|resume)"
        required: true
        default: "plan"
      confirm:
        description: "Set to 1 to allow mutating actions"
        required: false
        default: "0"
  push:
    branches: ["release/**"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore orchestrator state
        uses: actions/download-artifact@v4
        with:
          name: ops-state
          path: .
        continue-on-error: true

      - name: Install minimal deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq yq
          echo "CONFIRM=${{ github.event.inputs.confirm || '0' }}" >> $GITHUB_ENV

      - name: Unpack Ops Orchestrator Kit
        run: |
          mkdir -p ops
          if [ -f ops/ga_orchestrator.sh ]; then echo "Orchestrator already present."; else
            echo "Please commit the ops kit to the repo root (recommended)"
          fi
          chmod +x ops/ga_orchestrator.sh || true

      - name: Run orchestrator
        env:
          CONFIRM: ${{ env.CONFIRM }}
          BASE_BRANCH: ${{ github.base_ref || 'main' }}
        run: |
          set -euxo pipefail
          cmd="${{ github.event.inputs.command || 'plan' }}"
          ./ops/ga_orchestrator.sh "$cmd"

      - name: Upload state and logs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: ops-state
          path: |
            ops-state.json
            ops-logs/**
          if-no-files-found: warn
