version: "3.9"

services:
  companyos-opa:
    image: openpolicyagent/opa:0.68.0-rootless
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "/policies"
    volumes:
      - ../companyos/policies:/policies:ro
    ports:
      - "8181:8181"

  companyos-db:
    image: postgres:15
    environment:
      POSTGRES_USER: companyos
      POSTGRES_PASSWORD: companyos
      POSTGRES_DB: companyos
    ports:
      - "5432:5432"
    volumes:
      - companyos-db-data:/var/lib/postgresql/data

  companyos-api:
    build:
      context: ..
      dockerfile: companyos/services/companyos-api/Dockerfile
    environment:
      PORT: 4100
      OPA_URL: http://companyos-opa:8181/v1/data/companyos/authz/customer/decision
    depends_on:
      - companyos-db
      - companyos-opa
    ports:
      - "4100:4100"

volumes:
  companyos-db-data:
