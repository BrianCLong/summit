{{- $np := .Values.networkPolicy -}}
{{- if $np.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "intelgraph.fullname" . }}-default-deny
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "intelgraph.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
{{- $root := . -}}
{{- range $serviceKey, $serviceVal := .Values.services }}
  {{- if $serviceVal.enabled }}
    {{- $service := deepCopy $serviceVal }}
    {{- if not $service.name }}
      {{- $_ := set $service "name" $serviceKey }}
    {{- end }}
    {{- $svcNP := $service.networkPolicy | default dict }}
    {{- $ingress := $svcNP.ingress | default dict }}
    {{- if $ingress.enabled | default false }}
      {{- $fromScratch := dict "entries" (list) }}
      {{- if $ingress.allowIngressControllers | default true }}
        {{- range $np.ingressControllers | default (list (dict "namespaceSelector" (dict "matchLabels" (dict "name" "ingress-nginx")))) }}
          {{- $rendered := tpl (toYaml .) $root | fromYaml }}
          {{- $_ := set $fromScratch "entries" (append ($fromScratch.entries) $rendered) }}
        {{- end }}
      {{- end }}
      {{- if $ingress.allowSameNamespace | default true }}
        {{- $_ := set $fromScratch "entries" (append ($fromScratch.entries) (dict "podSelector" (dict "matchLabels" (dict "app.kubernetes.io/part-of" "intelgraph")))) }}
      {{- end }}
      {{- range $ingress.additionalFrom | default list }}
        {{- $rendered := tpl (toYaml .) $root | fromYaml }}
        {{- $_ := set $fromScratch "entries" (append ($fromScratch.entries) $rendered) }}
      {{- end }}
      {{- $portsScratch := dict "entries" (list) }}
      {{- if $ingress.ports }}
        {{- range $ingress.ports }}
          {{- $rendered := tpl (toYaml .) $root | fromYaml }}
          {{- $_ := set $portsScratch "entries" (append ($portsScratch.entries) $rendered) }}
        {{- end }}
      {{- else }}
        {{- if $service.port }}
          {{- $_ := set $portsScratch "entries" (append ($portsScratch.entries) (dict "protocol" "TCP" "port" $service.port)) }}
        {{- end }}
        {{- if or ($ingress.includeMetrics | default true) (and (not $service.port) ($root.Values.global.prometheus.port)) }}
          {{- $_ := set $portsScratch "entries" (append ($portsScratch.entries) (dict "protocol" "TCP" "port" ($root.Values.global.prometheus.port | default 9090))) }}
        {{- end }}
      {{- end }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "intelgraph.fullname" . }}-allow-{{ $service.name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "intelgraph.serviceLabels" (dict "serviceName" $service.name "root" $root) | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ $service.name }}
  policyTypes:
    - Ingress
  ingress:
    - from:
        {{- range $fromScratch.entries }}
        - {{- toYaml . | nindent 10 }}
        {{- end }}
      ports:
        {{- range $portsScratch.entries }}
        - {{- toYaml . | nindent 10 }}
        {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- if $np.interService.enabled | default true }}
  {{- $portScratch := dict "entries" (list) }}
  {{- range $serviceKey, $serviceVal := .Values.services }}
    {{- if and $serviceVal.enabled $serviceVal.port }}
      {{- $_ := set $portScratch "entries" (append ($portScratch.entries) (dict "protocol" "TCP" "port" $serviceVal.port)) }}
    {{- end }}
  {{- end }}
  {{- range $np.interService.additionalPorts | default list }}
    {{- $rendered := tpl (toYaml .) $root | fromYaml }}
    {{- $_ := set $portScratch "entries" (append ($portScratch.entries) $rendered) }}
  {{- end }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "intelgraph.fullname" . }}-inter-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "intelgraph.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: intelgraph
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: intelgraph
      ports:
        {{- range $portScratch.entries }}
        - {{- toYaml . | nindent 10 }}
        {{- end }}
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: intelgraph
      ports:
        {{- range $portScratch.entries }}
        - {{- toYaml . | nindent 10 }}
        {{- end }}
{{- end }}
  {{- $egressEntries := dict "list" (list) }}
  {{- range $np.externalDestinations | default list }}
    {{- $rendered := tpl (toYaml .) $root | fromYaml }}
    {{- $_ := set $egressEntries "list" (append ($egressEntries.list) $rendered) }}
  {{- end }}
  {{- if $np.dns.enabled | default true }}
    {{- $dnsNamespaceSelector := $np.dns.namespaceSelector | default (dict "matchLabels" (dict "kubernetes.io/metadata.name" "kube-system")) }}
    {{- $dnsPodSelector := $np.dns.podSelector | default (dict "matchLabels" (dict "k8s-app" "kube-dns")) }}
    {{- $dnsPeer := dict "namespaceSelector" $dnsNamespaceSelector "podSelector" $dnsPodSelector }}
    {{- $dnsPorts := list (dict "protocol" "UDP" "port" 53) (dict "protocol" "TCP" "port" 53) }}
    {{- $dnsRule := dict "to" (list $dnsPeer) "ports" $dnsPorts }}
    {{- $_ := set $egressEntries "list" (append ($egressEntries.list) $dnsRule) }}
  {{- end }}
  {{- range $np.externalCidrs | default list }}
    {{- $_ := set $egressEntries "list" (append ($egressEntries.list) (dict "to" (list (dict "ipBlock" .)))) }}
  {{- end }}
  {{- if gt (len $egressEntries.list) 0 }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "intelgraph.fullname" . }}-egress-controlled
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "intelgraph.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: intelgraph
  policyTypes:
    - Egress
  egress:
    {{- range $egressEntries.list }}
    - {{- if .to }}
        to:
          {{- range .to }}
          - {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- end }}
      {{- if .ports }}
        ports:
          {{- range .ports }}
          - {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
