{{- $root := . -}}
{{- range $serviceKey, $serviceVal := .Values.services }}
  {{- if $serviceVal.enabled }}
    {{- $service := deepCopy $serviceVal }}
    {{- if not $service.name }}
      {{- $_ := set $service "name" $serviceKey }}
    {{- end }}
    {{- $ctx := dict "service" $service "root" $root }}
    {{- $saConfig := (include "intelgraph.serviceAccountConfig" $ctx | fromYaml) }}
    {{- if $saConfig.create }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "intelgraph.serviceAccountName" $ctx }}
  namespace: {{ $root.Release.Namespace }}
  labels:
    {{- include "intelgraph.serviceLabels" (dict "serviceName" $service.name "root" $root) | nindent 4 }}
  {{- with $saConfig.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: {{ $saConfig.automount | default false }}
    {{- end }}
    {{- if and $saConfig.rbac ($saConfig.rbac.create | default true) (gt (len $saConfig.rbac.rules) 0) }}
      {{- $roleName := default (printf "%s-access" (include "intelgraph.serviceAccountName" $ctx)) $saConfig.rbac.name }}
      {{- $bindingName := default (printf "%s-binding" $roleName) $saConfig.rbac.bindingName }}
      {{- if $saConfig.rbac.clusterRole }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ $roleName | trunc 63 | trimSuffix "-" }}
  labels:
    {{- include "intelgraph.serviceLabels" (dict "serviceName" $service.name "root" $root) | nindent 4 }}
rules:
    {{- toYaml $saConfig.rbac.rules | nindent 2 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ $bindingName | trunc 63 | trimSuffix "-" }}
  labels:
    {{- include "intelgraph.serviceLabels" (dict "serviceName" $service.name "root" $root) | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ $roleName | trunc 63 | trimSuffix "-" }}
subjects:
  - kind: ServiceAccount
    name: {{ include "intelgraph.serviceAccountName" $ctx }}
    namespace: {{ $root.Release.Namespace }}
      {{- else }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $roleName | trunc 63 | trimSuffix "-" }}
  namespace: {{ $root.Release.Namespace }}
  labels:
    {{- include "intelgraph.serviceLabels" (dict "serviceName" $service.name "root" $root) | nindent 4 }}
rules:
    {{- toYaml $saConfig.rbac.rules | nindent 2 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $bindingName | trunc 63 | trimSuffix "-" }}
  namespace: {{ $root.Release.Namespace }}
  labels:
    {{- include "intelgraph.serviceLabels" (dict "serviceName" $service.name "root" $root) | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $roleName | trunc 63 | trimSuffix "-" }}
subjects:
  - kind: ServiceAccount
    name: {{ include "intelgraph.serviceAccountName" $ctx }}
    namespace: {{ $root.Release.Namespace }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
