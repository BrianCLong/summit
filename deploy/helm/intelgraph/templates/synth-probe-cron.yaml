apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "intelgraph.fullname" . }}-synth-probe
  labels:
    app.kubernetes.io/name: synth-probe
spec:
  schedule: {{ .Values.synthProbe.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: synth-probe
        spec:
          restartPolicy: OnFailure
          containers:
            - name: synth-probe
              image: {{ .Values.synthProbe.image | default "ghcr.io/example/synth-probe:latest" | quote }}
              imagePullPolicy: IfNotPresent
              env:
                - name: BASE_URL
                  value: {{ .Values.synthProbe.baseUrl | quote }}
                - name: AUTH_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.synthProbe.secretName | default "synth-probe" }}
                      key: token
                - name: DEPLOY_ENV
                  value: {{ .Values.environment | default "stage" | quote }}
                - name: K8S_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                - name: OTEL_EXPORTER_OTLP_ENDPOINT
                  value: {{ .Values.synthProbe.otelEndpoint | quote }}
                - name: GP_METRICS_PORT
                  value: "9464"
              args:
                - run
                - "--journey"
                - {{ .Values.synthProbe.journey | default "GP-001" | quote }}
                - "--base"
                - "$(BASE_URL)"
                - "--tenant"
                - {{ .Values.synthProbe.tenant | default "stage" | quote }}
                - "--samples"
                - {{ .Values.synthProbe.samples | default 1 | quote }}
                - "--export"
                - prometheus
              ports:
                - name: metrics
                  containerPort: 9464
          securityContext:
            runAsNonRoot: true
            fsGroup: 65534
