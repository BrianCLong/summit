# GPU-optimised overrides for the IntelGraph Helm chart
services:
  mlEngine:
    replicaCount: 1
    resources:
      requests:
        cpu: '1'
        memory: '4Gi'
        nvidia.com/gpu: 1
      limits:
        cpu: '4'
        memory: '12Gi'
        nvidia.com/gpu: 1
    nodeSelector:
      nvidia.com/gpu.present: 'true'
    tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
    env:
      - name: PORT
        value: '8082'
      - name: POSTGRES_URI
        valueFrom:
          secretKeyRef:
            name: '{{ .Values.external.postgres.userSecretRef }}'
            key: uri
      - name: REDIS_HOST
        value: '{{ .Values.external.redis.host }}'
      - name: MODEL_CACHE_DIR
        value: '/app/.cache/models'
      - name: METRICS_ENABLED
        value: 'true'
      - name: METRICS_PORT
        value: '{{ .Values.global.prometheus.port }}'
      - name: METRICS_PATH
        value: '{{ .Values.global.prometheus.path }}'
      - name: GPU_ENABLED
        value: 'true'
      - name: GPU_DEVICE_ORDINAL
        value: '0'
      - name: GPU_POLL_INTERVAL_MS
        value: '10000'
      - name: GPU_HALF_PRECISION
        value: 'true'

# Deploy NVIDIA's device plugin alongside the workloads
gpuDevicePlugin:
  enabled: true
  args:
    - --mig-strategy=single
