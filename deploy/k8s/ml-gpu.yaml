apiVersion: apps/v1
kind: Deployment
metadata:
  name: intelgraph-ml-gpu
  namespace: intelgraph
  labels:
    app: intelgraph-ml-gpu
    component: ml-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: intelgraph-ml-gpu
  template:
    metadata:
      labels:
        app: intelgraph-ml-gpu
        component: ml-service
      annotations:
        sidecar.istio.io/inject: 'true'
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: accelerator
                    operator: In
                    values:
                      - nvidia-tesla-k80
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      containers:
        - name: ml-service
          image: intelgraph/ml:latest-gpu
          ports:
            - containerPort: 8081
          env:
            - name: UVICORN_HOST
              value: '0.0.0.0'
            - name: UVICORN_PORT
              value: '8081'
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: intelgraph-secrets
                  key: redis-url
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: intelgraph-secrets
                  key: jwt-public-key
            - name: ML_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: intelgraph-secrets
                  key: ml-webhook-secret
            - name: USE_SPACY
              value: 'true'
          resources:
            requests:
              memory: '2Gi'
              cpu: '1'
              nvidia.com/gpu: 1
            limits:
              memory: '8Gi'
              cpu: '4'
              nvidia.com/gpu: 1
          livenessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 5
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: intelgraph-ml-gpu-service
  namespace: intelgraph
  labels:
    app: intelgraph-ml-gpu
spec:
  selector:
    app: intelgraph-ml-gpu
  ports:
    - port: 8081
      targetPort: 8081
      protocol: TCP
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: intelgraph-ml-worker-gpu
  namespace: intelgraph
  labels:
    app: intelgraph-ml-worker-gpu
    component: ml-worker
spec:
  replicas: 2
  selector:
    matchLabels:
      app: intelgraph-ml-worker-gpu
  template:
    metadata:
      labels:
        app: intelgraph-ml-worker-gpu
        component: ml-worker
      annotations:
        sidecar.istio.io/inject: 'true'
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: accelerator
                    operator: In
                    values:
                      - nvidia-tesla-k80
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      containers:
        - name: ml-worker
          image: intelgraph/ml:latest-gpu
          command:
            [
              'celery',
              '-A',
              'app.celery_app',
              'worker',
              '--loglevel=INFO',
              '--concurrency=1',
            ]
          env:
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: intelgraph-secrets
                  key: redis-url
            - name: ML_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: intelgraph-secrets
                  key: ml-webhook-secret
            - name: USE_SPACY
              value: 'true'
          resources:
            requests:
              memory: '1Gi'
              cpu: '0.5'
              nvidia.com/gpu: 1
      limits:
        memory: '4Gi'
        cpu: '2'
        nvidia.com/gpu: 1

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: intelgraph-ml-gpu
  namespace: intelgraph
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: intelgraph-ml-gpu
  minReplicas: 1
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
