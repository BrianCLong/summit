name: dependabot-guard
on:
  pull_request_target:
    types: [opened, edited, synchronize, labeled]
permissions: { pull-requests: write, contents: read }
jobs:
  guard:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title || "";
            const major = /bbump .* to (d+)./i.exec(title)?.[1];
            const labels = pr.labels.map(l=>l.name);
            if (major && parseInt(major,10) > 0) {
              if (!labels.includes("major-bump")) {
                await github.rest.issues.addLabels({ ...context.repo, issue_number: pr.number, labels: ["major-bump","high-risk"] });
              }
              // disable automerge by clearing it if set
              try { await github.request('DELETE /repos/{owner}/{repo}/pulls/{pull_number}/auto-merge', { ...context.repo, pull_number: pr.number }); } catch {}
              core.info("Major bump detectedâ€”automerge disabled.");
            } else {
              core.info("Not a major bump.");
            }
