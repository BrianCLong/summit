name: ci
on:
  pull_request:
    branches: [ main ]
  merge_group:
    branches: [ main ]

concurrency:
  group: ci-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: intelgraph
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=10s
      neo4j:
        image: neo4j:5.22
        env: { NEO4J_AUTH: neo4j/test }
        ports: ['7687:7687','7474:7474']

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: '18.20.4', cache: 'npm' }

      - name: Enable Corepack (Yarn)
        run: corepack enable

      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      - name: Install JS deps
        run: |
          if [ -f yarn.lock ]; then yarn --immutable; else npm ci; fi

      - name: Install Python deps
        run: pip install -r requirements.txt

      - name: commitlint (PR commits & title)
        uses: wagoid/commitlint-github-action@v6

      - name: Lint (JS/TS & Python)
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Unit tests (JS & Py) with coverage
        run: |
          npm test -- --coverage
          pytest --cov-fail-under=85

      - name: GraphQL schema diff
        run: npm run graphql:schema:check

      - name: Postgres (Prisma) migrate + generate
        if: ${{ hashFiles('packages/db/prisma/schema.prisma') != '' }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/intelgraph
        run: |
          npm run db:pg:generate
          npm run db:pg:migrate
          npm run db:pg:status

      - name: Postgres (Knex) migrate
        if: ${{ hashFiles('packages/db/knex/knexfile.cjs') != '' }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/intelgraph
        run: npm run db:knex:migrate

      - name: Neo4j migrations
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test
        run: npm run db:neo4j:migrate

      - name: actionlint (GitHub Workflows)
        uses: reviewdog/action-actionlint@v1

      - name: hadolint (Dockerfiles)
        uses: hadolint/hadolint-action@v3.1.0
        with: { dockerfile: '**/Dockerfile' }

      - name: Trivy (dependency & fs scan)
        uses: aquasecurity/trivy-action@0.16.0
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: gitleaks (secrets)
        uses: gitleaks/gitleaks-action@v2
        with: { args: --no-git -v }

      - name: License check (JS)
        run: npx license-checker --production --excludePrivatePackages --summary

      - name: Build
        run: if [ -f yarn.lock ]; then yarn build; else npm run build; fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with: { name: coverage, path: coverage }