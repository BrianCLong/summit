<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IntelGraph Orchestra Dashboard</title>
  <style>
    html,body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:#0b0e13;color:#e6edf3}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-weight:700;font-size:28px;margin:0 0 12px;color:#58a6ff}
    .subtitle{color:#8b949e;margin-bottom:20px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .card{background:#111722;border:1px solid #202b3a;border-radius:14px;padding:18px}
    .card-header{font-weight:600;font-size:16px;margin:0 0 12px;color:#f0f6fc}
    .k{opacity:.7;font-size:14px}
    .ok{color:#2ecc71}.bad{color:#ff6b6b}.warn{color:#f1c40f}
    code,pre{background:#0e1420;border:1px solid #202b3a;border-radius:8px;padding:12px;display:block;overflow:auto;font-size:13px}
    button{background:#1f6feb;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:500}
    button:hover{background:#388bfd}
    .row{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .status-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #202b3a}
    .status-item:last-child{border-bottom:none}
    .model-list{max-height:120px;overflow-y:auto}
    .model-item{font-size:12px;padding:4px 8px;background:#0e1420;margin:2px 0;border-radius:4px}
    .env-badge{background:#2d3748;color:#e2e8f0;padding:4px 8px;border-radius:16px;font-size:12px;font-weight:500}
    .metric{text-align:center;padding:12px}
    .metric-value{font-size:24px;font-weight:700;color:#58a6ff}
    .metric-label{font-size:12px;color:#8b949e;text-transform:uppercase;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üéº IntelGraph Orchestra</h1>
    <div class="subtitle">Conductor Dashboard ‚Ä¢ Real-time Symphony Status</div>
    
    <div class="row">
      <button onclick="refresh()">üîÑ Refresh</button>
      <span id="when" class="k"></span>
      <div style="margin-left:auto">
        <span id="env-badges"></span>
      </div>
    </div>
    
    <div class="grid">
      <div class="card">
        <div class="card-header">üéµ Services</div>
        <div id="svc"></div>
      </div>
      
      <div class="card">
        <div class="card-header">ü§ñ AI Models</div>
        <div id="models"></div>
      </div>
      
      <div class="card">
        <div class="card-header">üìö RAG Knowledge</div>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <div class="metric">
            <div class="metric-value" id="rag-rows">‚Äì</div>
            <div class="metric-label">Documents</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="rag-files">‚Äì</div>
            <div class="metric-label">Files</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">‚ö° Quick Actions</div>
        <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
          <button onclick="runAction('smoke')">üîç Smoke Test</button>
          <button onclick="runAction('status')">üìä Status</button>
          <button onclick="runAction('health')">‚ù§Ô∏è Health</button>
          <button onclick="runAction('backup')">üíæ Backup</button>
        </div>
        <div class="k" style="margin-top:8px;font-size:12px">
          Actions require local proxy on :4381
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-top:16px">
      <div class="card-header">üîç Raw Status Data</div>
      <pre id="raw"></pre>
    </div>
  </div>

<script>
async function load() {
  try{
    const r = await fetch('status.json?ts=' + Date.now());
    const j = await r.json();
    
    // Update timestamp
    document.getElementById('when').textContent = 'Updated ' + new Date(j.time).toLocaleString();
    
    // Environment badges
    const env = j.environment || {};
    document.getElementById('env-badges').innerHTML = 
      `<span class="env-badge">Profile: ${env.profile || 'dev'}</span> ` +
      `<span class="env-badge">LOA: ${env.autonomy || 1}</span> ` +
      `<span class="env-badge">RAG-K: ${env.rag_topk || 5}</span>`;
    
    // Services status
    const svc = j.services || {};
    const statusIcon = (b) => b === true ? 'üü¢' : (b === false ? 'üî¥' : 'üü°');
    const statusText = (b) => b === true ? '<span class="ok">Online</span>' : (b === false ? '<span class="bad">Offline</span>' : '<span class="warn">Unknown</span>');
    
    document.getElementById('svc').innerHTML = 
      `<div class="status-item">
        <span>${statusIcon(svc.ollama)} Ollama :11434</span>
        ${statusText(svc.ollama)}
      </div>
      <div class="status-item">
        <span>${statusIcon(svc.litellm)} LiteLLM :4000</span>
        ${statusText(svc.litellm)}
      </div>
      <div class="status-item">
        <span>${statusIcon(svc.neo4j_ephemeral)} Neo4j (ephemeral)</span>
        ${statusText(svc.neo4j_ephemeral)}
      </div>`;
    
    // Models
    const models = j.models || {};
    document.getElementById('models').innerHTML = 
      `<div class="metric">
        <div class="metric-value">${models.count ?? '‚Äì'}</div>
        <div class="metric-label">Available</div>
      </div>
      <div class="model-list">
        ${(models.models || []).map(m => `<div class="model-item">${m}</div>`).join('')}
      </div>`;
    
    // RAG stats
    const rag = j.rag || {};
    document.getElementById('rag-rows').textContent = rag.rows ?? '‚Äì';
    document.getElementById('rag-files').textContent = rag.files ?? '‚Äì';
    
    // Raw data
    document.getElementById('raw').textContent = JSON.stringify(j, null, 2);
    
  } catch(e) {
    document.getElementById('when').textContent = 'No status.json yet. Run "just dash-refresh".';
    document.getElementById('raw').textContent = (e && e.message) || String(e);
  }
}

function refresh() { 
  load(); 
}

async function runAction(action) {
  try {
    const actionMap = {
      'smoke': 'just%20--justfile%20Justfile.orchestra%20orchestra-smoke',
      'status': 'python3%20tools/status_json.py',
      'health': 'just%20--justfile%20Justfile.orchestra%20orchestra-fast',
      'backup': 'just%20--justfile%20Justfile.orchestra%20backup'
    };
    
    const cmd = actionMap[action];
    if (!cmd) return;
    
    window.open(`http://127.0.0.1:4381/api/run?cmd=${cmd}`, '_blank');
  } catch(e) {
    alert('Action requires local proxy. Run: node tools/proxy.js');
  }
}

// Auto-refresh every 30 seconds
setInterval(refresh, 30000);
load();
</script>
</body>
</html>