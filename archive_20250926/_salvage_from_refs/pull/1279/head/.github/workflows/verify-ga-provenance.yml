name: Verify GA Provenance

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch release assets
        uses: actions/github-script@v7
        with:
          script: |
            const tag = (context.payload.release && context.payload.release.tag_name) || (context.ref || '').replace('refs/tags/','');
            const { data: rel } = await github.rest.repos.getReleaseByTag({ owner: context.repo.owner, repo: context.repo.repo, tag });
            core.info('Release assets: ' + rel.assets.map(a => a.name).join(', '));

      - name: Install slsa-verifier
        run: |
          VERSION=v2.5.1
          curl -sL https://github.com/slsa-framework/slsa-verifier/releases/download/${VERSION}/slsa-verifier-linux-amd64 -o slsa-verifier
          chmod +x slsa-verifier

      - name: Download GA Kit PDF
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ github.repository }}
          tag: ${{ github.event.release.tag_name }}
          fileName: "GA-Kit-*.pdf"
          out-file-path: dist

      - name: Verify provenance
        run: ./slsa-verifier verify-artifact dist/GA-Kit-*.pdf --source-uri github.com/${{ github.repository }} --source-tag ${{ github.event.release.tag_name }}

