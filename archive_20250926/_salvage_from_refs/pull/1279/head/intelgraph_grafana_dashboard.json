{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "Primary Prometheus datasource",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.x" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "10.x" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "10.x" },
    { "type": "panel", "id": "bargauge", "name": "Bar gauge", "version": "10.x" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "2.x" }
  ],
  "title": "IntelGraph — GA SLO & Hypercare",
  "uid": "intelgraph-ga-slo",
  "timezone": "browser",
  "tags": ["intelgraph", "ga", "slo", "hypercare"],
  "schemaVersion": 38,
  "version": 1,
  "editable": true,
  "panels": [
    {
      "type": "row",
      "title": "Overview",
      "collapsed": false,
      "gridPos": {"h":1, "w":24, "x":0, "y":0}
    },
    {
      "type": "stat",
      "title": "Availability (Success Ratio)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":4, "w":6, "x":0, "y":1},
      "targets": [
        {
          "expr": "100 * (sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\",status_class=~\"2..|3..\"}[5m])) + sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\",status=\"403\",reason=\"policy_denied\"}[5m]))) / sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))",
          "legendFormat": "success%"
        }
      ],
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto"}
    },
    {
      "type": "stat",
      "title": "Error Budget Burn (est. %/day)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":4, "w":6, "x":6, "y":1},
      "targets": [
        {
          "expr": "(1 - (sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\",status_class=~\"2..|3..|4..\"}[5m])) / sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m])))) * 1000 * (1440/5)",
          "legendFormat": "burn%/day"
        }
      ]
    },
    {
      "type": "bargauge",
      "title": "Traffic by Tenant (req/s)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":4, "w":12, "x":12, "y":1},
      "targets": [
        {"expr": "sum by (tenant) (rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))", "legendFormat": "{{tenant}}"}
      ],
      "options": {"displayMode": "lcd"}
    },

    {"type": "row", "title": "Latency SLOs (GraphQL)", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":5}},
    {
      "type": "timeseries",
      "title": "GraphQL Read p95 (ms)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":8, "w":12, "x":0, "y":6},
      "targets": [
        {"expr": "histogram_quantile(0.95, sum by (le, op, tenant) (rate(graphql_read_latency_ms_bucket{env=\"$env\",tenant=~\"$tenant\"}[5m])))", "legendFormat": "{{tenant}} {{op}}"}
      ],
      "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 350}]}}}
    },
    {
      "type": "timeseries",
      "title": "GraphQL Write p95 (ms)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":8, "w":12, "x":12, "y":6},
      "targets": [
        {"expr": "histogram_quantile(0.95, sum by (le, op, tenant) (rate(graphql_write_latency_ms_bucket{env=\"$env\",tenant=~\"$tenant\"}[5m])))", "legendFormat": "{{tenant}} {{op}}"}
      ],
      "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 700}]}}}
    },
    {
      "type": "timeseries",
      "title": "Error Rates (total vs 5xx)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":24, "x":0, "y":14},
      "targets": [
        {"expr": "100 * sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\",status_class=~\"4..|5..\"}[5m])) / sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))", "legendFormat": "4xx+5xx %"},
        {"expr": "100 * sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\",status_class=\"5..\"}[5m])) / sum(rate(http_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))", "legendFormat": "5xx %"}
      ]
    },

    {"type": "row", "title": "Caching (Persisted & Response)", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":20}},
    {
      "type": "timeseries",
      "title": "Persisted Query Cache Hit %",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":0, "y":21},
      "targets": [{"expr": "100 * sum(rate(pq_cache_hits_total{env=\"$env\",tenant=~\"$tenant\"}[5m])) / sum(rate(pq_cache_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))", "legendFormat": "{{tenant}}"}],
      "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "green", "value": 85}]}}}
    },
    {
      "type": "timeseries",
      "title": "Response Cache Hit %",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":12, "y":21},
      "targets": [{"expr": "100 * sum(rate(resp_cache_hits_total{env=\"$env\",tenant=~\"$tenant\"}[5m])) / sum(rate(resp_cache_requests_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))", "legendFormat": "{{tenant}}"}]
    },
    {
      "type": "timeseries",
      "title": "LRU Evictions / min",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":5, "w":24, "x":0, "y":27},
      "targets": [{"expr": "rate(pq_lru_evictions_total{env=\"$env\",tenant=~\"$tenant\"}[1m])", "legendFormat": "{{tenant}}"}]
    },

    {"type": "row", "title": "Redis", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":32}},
    {
      "type": "timeseries",
      "title": "Redis P99 Command Duration (s)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":0, "y":33},
      "targets": [{"expr": "histogram_quantile(0.99, sum by (le, cmd) (rate(redis_cmd_duration_seconds_bucket{env=\"$env\"}[5m])))", "legendFormat": "{{cmd}}"}],
      "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 0.005}]}}}
    },
    {
      "type": "timeseries",
      "title": "Evictions vs Expirations (per min)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":12, "y":33},
      "targets": [
        {"expr": "rate(redis_evicted_keys_total{env=\"$env\"}[1m])", "legendFormat": "evicted"},
        {"expr": "rate(redis_expired_keys_total{env=\"$env\"}[1m])", "legendFormat": "expired"}
      ]
    },
    {
      "type": "timeseries",
      "title": "CPU Utilization %",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":4, "w":24, "x":0, "y":39},
      "targets": [{"expr": "100 * avg(redis_cpu_utilization_ratio{env=\"$env\"}) by (instance)", "legendFormat": "{{instance}}"}]
    },

    {"type": "row", "title": "Neo4j", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":43}},
    {
      "type": "timeseries",
      "title": "Replica Lag (ms)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":0, "y":44},
      "targets": [{"expr": "neo4j_replication_lag_milliseconds{env=\"$env\"}", "legendFormat": "{{instance}}"}],
      "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 250}]}}}
    },
    {
      "type": "timeseries",
      "title": "Query p95 (ms)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":12, "y":44},
      "targets": [{"expr": "histogram_quantile(0.95, sum by (le, query_type) (rate(neo4j_query_duration_ms_bucket{env=\"$env\"}[5m])))", "legendFormat": "{{query_type}}"}]
    },
    {
      "type": "timeseries",
      "title": "Page Cache Hit %",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":4, "w":24, "x":0, "y":50},
      "targets": [{"expr": "100 * avg(neo4j_page_cache_hit_ratio{env=\"$env\"}) by (instance)", "legendFormat": "{{instance}}"}]
    },

    {"type": "row", "title": "Event Reasoner (ER)", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":54}},
    {
      "type": "timeseries",
      "title": "Consumer Lag (s)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":0, "y":55},
      "targets": [{"expr": "er_consumer_lag_seconds{env=\"$env\",tenant=~\"$tenant\"}", "legendFormat": "{{tenant}} {{consumer}}"}]
    },
    {
      "type": "timeseries",
      "title": "DLQ Rate %",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":12, "y":55},
      "targets": [{"expr": "100 * sum(rate(er_dlq_messages_total{env=\"$env\",tenant=~\"$tenant\"}[5m])) / sum(rate(er_processed_messages_total{env=\"$env\",tenant=~\"$tenant\"}[5m]))", "legendFormat": "{{tenant}}"}]
    },

    {"type": "row", "title": "Policy & Auth (OPA/WebAuthn)", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":61}},
    {
      "type": "timeseries",
      "title": "OPA Decision p95 (ms)",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":0, "y":62},
      "targets": [{"expr": "histogram_quantile(0.95, sum by (le, policy) (rate(opa_decision_duration_ms_bucket{env=\"$env\"}[5m])))", "legendFormat": "{{policy}}"}],
      "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 60}]}}}
    },
    {
      "type": "timeseries",
      "title": "Policy Cache Hit %",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":12, "y":62},
      "targets": [{"expr": "100 * sum(rate(opa_cache_hits_total{env=\"$env\"}[5m])) / sum(rate(opa_cache_requests_total{env=\"$env\"}[5m]))", "legendFormat": "cache hit %"}]
    },
    {
      "type": "timeseries",
      "title": "WebAuthn Fail % & Step‑up Prompts",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":24, "x":0, "y":68},
      "targets": [
        {"expr": "100 * sum(rate(webauthn_failures_total{env=\"$env\"}[5m])) / sum(rate(webauthn_attempts_total{env=\"$env\"}[5m]))", "legendFormat": "fail %"},
        {"expr": "sum(rate(stepup_prompts_total{env=\"$env\"}[5m]))", "legendFormat": "step‑up prompts/s"}
      ]
    },

    {"type": "row", "title": "FinOps", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":74}},
    {
      "type": "timeseries",
      "title": "Spend Rate vs Forecast",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":0, "y":75},
      "targets": [
        {"expr": "cost_spend_rate{env=\"$env\"}", "legendFormat": "spend"},
        {"expr": "cost_forecast_rate{env=\"$env\"}", "legendFormat": "forecast"}
      ]
    },
    {
      "type": "timeseries",
      "title": "Sampling Rate vs Floor",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":12, "x":12, "y":75},
      "targets": [
        {"expr": "observability_sampling_rate{env=\"$env\"}", "legendFormat": "sampling"},
        {"expr": "sampling_floor{env=\"$env\"}", "legendFormat": "floor"}
      ]
    },

    {"type": "row", "title": "Supply Chain / Provenance", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":81}},
    {
      "type": "timeseries",
      "title": "Verification Failures & Bypass Events",
      "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
      "gridPos": {"h":6, "w":24, "x":0, "y":82},
      "targets": [
        {"expr": "sum(rate(provenance_verify_failures_total{env=\"$env\"}[5m]))", "legendFormat": "verify failures/s"},
        {"expr": "sum(increase(provenance_emergency_bypass_total{env=\"$env\"}[1h]))", "legendFormat": "bypass/hr"}
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "name": "env",
        "label": "Environment",
        "type": "query",
        "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
        "refresh": 2,
        "query": "label_values(http_requests_total, env)",
        "includeAll": false,
        "multi": false,
        "current": {"text": "prod", "value": "prod"}
      },
      {
        "name": "tenant",
        "label": "Tenant",
        "type": "query",
        "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
        "refresh": 2,
        "query": "label_values(http_requests_total{env=\"$env\"}, tenant)",
        "includeAll": true,
        "multi": true,
        "allValue": ".*",
        "current": {"text": "All", "value": ".*"}
      }
    ]
  },
  "time": {"from": "now-6h", "to": "now"},
  "timepicker": {"refresh_intervals": ["5s", "10s", "30s", "1m", "5m"]},
  "refresh": "10s"
}