groups:
- name: intelgraph-slo
  rules:
  - alert: HighErrorBudgetBurn
    expr: |
      (
        (
          sum by (tenant) (rate(apollo_request_errors_total{tenant=~".+"}[5m]))
          / sum by (tenant) (rate(apollo_request_total{tenant=~".+"}[5m]))
        ) / (1 - 0.9995)
      ) > 1
      and
      (
        (
          sum by (tenant) (rate(apollo_request_errors_total{tenant=~".+"}[1h]))
          / sum by (tenant) (rate(apollo_request_total{tenant=~".+"}[1h]))
        ) / (1 - 0.9995)
      ) > 1
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "High error-budget burn (5m & 1h) on IntelGraph"
      description: "Burn rate > 1 against 99.95% SLO in both 5m and 1h windows. Tenant={{ $labels.tenant }}"

  - alert: ModerateErrorBudgetBurn
    expr: |
      (
        (
          sum by (tenant) (rate(apollo_request_errors_total{tenant=~".+"}[30m]))
          / sum by (tenant) (rate(apollo_request_total{tenant=~".+"}[30m]))
        ) / (1 - 0.9995)
      ) > 0.5
      and
      (
        (
          sum by (tenant) (rate(apollo_request_errors_total{tenant=~".+"}[6h]))
          / sum by (tenant) (rate(apollo_request_total{tenant=~".+"}[6h]))
        ) / (1 - 0.9995)
      ) > 0.5
    for: 15m
    labels:
      severity: ticket
    annotations:
      summary: "Moderate error-budget burn (30m & 6h)"
      description: "Burn rate > 0.5 against 99.95% SLO sustained. Tenant={{ $labels.tenant }}"

- name: intelgraph-slo-ops
  rules:
  - alert: HighOpErrorBudgetBurn
    expr: |
      (
        ( sum by (tenant,operation) (rate(apollo_request_errors_total[5m]))
          / sum by (tenant,operation) (rate(apollo_request_total[5m])) ) / (1 - 0.9995)
      ) > 1
      and
      (
        ( sum by (tenant,operation) (rate(apollo_request_errors_total[1h]))
          / sum by (tenant,operation) (rate(apollo_request_total[1h])) ) / (1 - 0.9995)
      ) > 1
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "High error-budget burn (op) — tenant={{ $labels.tenant }} op={{ $labels.operation }}"
      description: "Burn > 1 against 99.95% SLO in both 5m and 1h windows."

  - alert: ModerateOpErrorBudgetBurn
    expr: |
      (
        ( sum by (tenant,operation) (rate(apollo_request_errors_total[30m]))
          / sum by (tenant,operation) (rate(apollo_request_total[30m])) ) / (1 - 0.9995)
      ) > 0.5
      and
      (
        ( sum by (tenant,operation) (rate(apollo_request_errors_total[6h]))
          / sum by (tenant,operation) (rate(apollo_request_total[6h])) ) / (1 - 0.9995)
      ) > 0.5
    for: 15m
    labels:
      severity: ticket
    annotations:
      summary: "Moderate error-budget burn (op) — tenant={{ $labels.tenant }} op={{ $labels.operation }}"
      description: "Burn > 0.5 against 99.95% SLO in 30m & 6h windows."
