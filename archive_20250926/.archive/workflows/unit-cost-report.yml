name: unit-cost-report
on:
  workflow_dispatch:
    inputs:
      events:
        description: 'Events processed this period'
        required: true
      eventsCost:
        description: 'USD cost for ingest infra'
        required: true
      graphql:
        description: 'GraphQL requests this period'
        required: true
      graphqlCost:
        description: 'USD cost for API infra'
        required: true
permissions: { contents: write }
jobs:
  calc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: node tools/cost/unit-cost.mjs --events ${{ inputs.events }} --events-cost ${{ inputs.eventsCost }} --graphql ${{ inputs.graphql }} --graphql-cost ${{ inputs.graphqlCost }} | tee unit-cost.json
      - uses: actions/upload-artifact@v4
        with:
          name: unit-cost
          path: unit-cost.json
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(cost): update unit-cost snapshot'
          file_pattern: unit-cost.json