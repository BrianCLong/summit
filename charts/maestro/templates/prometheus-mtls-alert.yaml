apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: maestro-mtls-alerts
  namespace:
    {
      { .Values.metrics.prometheusRule.namespace | default .Release.Namespace },
    }
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: maestro.mtls
      rules:
        - alert: MaestroMTLSBelowTarget
          expr: |
            (100 * sum(rate(istio_requests_total{reporter="destination",connection_security_policy="mutual_tls"}[5m]))
             / sum(rate(istio_requests_total{reporter="destination"}[5m]))) < 100
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: 'mTLS ratio below 100%'
            description: 'mTLS percent over last 5m dropped below 100%. Investigate plaintext traffic.'
