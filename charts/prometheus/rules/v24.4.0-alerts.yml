# Maestro Conductor v24.4.0 - Prometheus Alert Rules
# Epic E18-E22: Provenance + Abuse + Cost + RTBF + SLO

groups:
  # Provenance & Trust Alerts
  - name: provenance-integrity
    interval: 30s
    rules:
      - alert: ProvenanceHashChainBroken
        expr: increase(provenance_ledger_verify_failures_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: provenance
          epic: E18
        annotations:
          summary: 'Provenance ledger hash chain integrity violated'
          description: 'Hash chain verification failed for tenant {{ $labels.tenant_id }} in the last 5 minutes. This indicates potential data tampering.'
          runbook_url: 'https://runbooks.maestro.dev/provenance/hash-chain-broken'

      - alert: MerkleRootSigningFailed
        expr: increase(provenance_merkle_root_sign_failures_total[1h]) > 0
        for: 0m
        labels:
          severity: critical
          service: provenance
          epic: E18
        annotations:
          summary: 'Daily Merkle root signing failed'
          description: 'Failed to sign Merkle root with cosign. Manual intervention required to maintain provenance integrity.'
          runbook_url: 'https://runbooks.maestro.dev/provenance/merkle-signing-failed'

      - alert: ProvenanceLedgerHighLatency
        expr: histogram_quantile(0.95, provenance_ledger_append_duration_seconds_bucket) > 1.0
        for: 5m
        labels:
          severity: warning
          service: provenance
          epic: E18
        annotations:
          summary: 'Provenance ledger append latency high'
          description: 'P95 append latency is {{ $value }}s, above 1s threshold. May impact write performance.'

  # Abuse Detection & Mitigation Alerts
  - name: abuse-detection
    interval: 30s
    rules:
      - alert: AbuseGuardHighFalsePositives
        expr: (increase(abuseguard_false_positive_total[1h]) / increase(abuseguard_throttles_total[1h])) * 100 > 1.0
        for: 10m
        labels:
          severity: warning
          service: abuse-guard
          epic: E19
        annotations:
          summary: 'Abuse guard false positive rate high'
          description: 'False positive rate is {{ $value }}% over 1h, above 1% threshold for tenant {{ $labels.tenant_id }}'
          runbook_url: 'https://runbooks.maestro.dev/abuse/tune-thresholds'

      - alert: GraphComplexityAttack
        expr: increase(graph_guard_block_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          service: graph-guard
          epic: E19
        annotations:
          summary: 'Potential graph complexity attack detected'
          description: '{{ $value }} graph queries blocked for complexity in 5m for tenant {{ $labels.tenant_id }}. Possible attack or misconfigured client.'
          runbook_url: 'https://runbooks.maestro.dev/graph/complexity-attack'

      - alert: IngestValidationStormDetected
        expr: increase(ingest_malformed_total[1m]) > 100
        for: 1m
        labels:
          severity: warning
          service: ingest-validator
          epic: E19
        annotations:
          summary: 'High volume of malformed ingest detected'
          description: '{{ $value }} malformed payloads in 1m for tenant {{ $labels.tenant_id }}. Possible attack or client misconfiguration.'

      - alert: AbuseGuardServiceDown
        expr: up{job="abuse-guard"} == 0
        for: 2m
        labels:
          severity: critical
          service: abuse-guard
          epic: E19
        annotations:
          summary: 'Abuse guard service is down'
          description: 'Abuse guard service is not responding. System vulnerable to abuse attacks.'
          runbook_url: 'https://runbooks.maestro.dev/abuse/service-restart'

  # Cost & Tenancy Alerts
  - name: cost-tenancy
    interval: 60s
    rules:
      - alert: TenantCostForecastErrorHigh
        expr: tenant_cost_forecast_error_percentage > 10
        for: 3h
        labels:
          severity: warning
          service: cost-service
          epic: E20
        annotations:
          summary: 'Tenant cost forecast accuracy degraded'
          description: 'Cost forecast error is {{ $value }}% for tenant {{ $labels.tenant_id }}, above 10% threshold for 3h'
          runbook_url: 'https://runbooks.maestro.dev/cost/forecast-tuning'

      - alert: TenantPartitionThrashing
        expr: increase(tenant_partition_migrations_total[1h]) > 3
        for: 0m
        labels:
          severity: warning
          service: partitioning
          epic: E20
        annotations:
          summary: 'Tenant partition thrashing detected'
          description: '{{ $value }} partition migrations in 1h for tenant {{ $labels.tenant_id }}. Enable dampening.'
          runbook_url: 'https://runbooks.maestro.dev/partitioning/enable-dampening'

      - alert: CIBudgetExhausted
        expr: ci_budget_remaining_percentage < 10
        for: 0m
        labels:
          severity: critical
          service: ci-budget
          epic: E20
        annotations:
          summary: 'CI budget critically low'
          description: 'Only {{ $value }}% CI budget remaining for tenant {{ $labels.tenant_id }}. Pipelines will be throttled.'
          runbook_url: 'https://runbooks.maestro.dev/ci/budget-exhausted'

      - alert: TenantCostSpike
        expr: (tenant_cost_current - tenant_cost_baseline) / tenant_cost_baseline * 100 > 50
        for: 30m
        labels:
          severity: warning
          service: cost-service
          epic: E20
        annotations:
          summary: 'Tenant cost spike detected'
          description: 'Cost increased {{ $value }}% above baseline for tenant {{ $labels.tenant_id }} over 30m'

  # RTBF & Privacy Alerts
  - name: rtbf-privacy
    interval: 60s
    rules:
      - alert: RTBFJobDurationExceeded
        expr: rtbf_job_duration_seconds > 7200 # 2 hours
        for: 0m
        labels:
          severity: critical
          service: rtbf
          epic: E21
        annotations:
          summary: 'RTBF job exceeded SLA duration'
          description: 'RTBF job {{ $labels.job_id }} took {{ $value }}s, exceeding 2h SLA for tenant {{ $labels.tenant_id }}'
          runbook_url: 'https://runbooks.maestro.dev/rtbf/performance-tuning'

      - alert: RTBFJobHighRetryRate
        expr: (increase(rtbf_retry_total[1h]) / increase(rtbf_items_processed_total[1h])) * 100 > 5
        for: 10m
        labels:
          severity: warning
          service: rtbf
          epic: E21
        annotations:
          summary: 'RTBF job high retry rate'
          description: '{{ $value }}% retry rate for RTBF jobs over 1h, above 5% threshold'
          runbook_url: 'https://runbooks.maestro.dev/rtbf/retry-investigation'

      - alert: RTBFAuditLogMissing
        expr: increase(rtbf_audit_entries_total[1h]) == 0 and increase(rtbf_items_processed_total[1h]) > 0
        for: 15m
        labels:
          severity: critical
          service: rtbf-audit
          epic: E21
        annotations:
          summary: 'RTBF audit logging failed'
          description: 'RTBF operations occurred without audit log entries. Compliance violation.'
          runbook_url: 'https://runbooks.maestro.dev/rtbf/audit-recovery'

      - alert: RTBFWorkerPoolDepleted
        expr: rtbf_workers_active < rtbf_workers_required
        for: 5m
        labels:
          severity: warning
          service: rtbf
          epic: E21
        annotations:
          summary: 'RTBF worker pool insufficient'
          description: 'Only {{ $labels.rtbf_workers_active }} workers active, need {{ $labels.rtbf_workers_required }}'
          runbook_url: 'https://runbooks.maestro.dev/rtbf/scale-workers'

  # Tenant SLO & Observability Alerts
  - name: tenant-slo
    interval: 30s
    rules:
      - alert: TenantErrorBudgetCriticalBurn
        expr: tenant_error_budget_burn_rate_5m >= 14.4 and tenant_error_budget_burn_rate_1h >= 6.0
        for: 2m
        labels:
          severity: critical
          service: slo
          epic: E22
        annotations:
          summary: 'Tenant error budget burning critically fast'
          description: 'Tenant {{ $labels.tenant_id }} burning error budget at {{ $value }}x rate (5m) and {{ $labels.tenant_error_budget_burn_rate_1h }}x (1h)'
          runbook_url: 'https://runbooks.maestro.dev/slo/critical-burn-response'

      - alert: TenantErrorBudgetWarningBurn
        expr: tenant_error_budget_burn_rate_30m >= 6.0 and tenant_error_budget_burn_rate_6h >= 3.0
        for: 15m
        labels:
          severity: warning
          service: slo
          epic: E22
        annotations:
          summary: 'Tenant error budget burn rate elevated'
          description: 'Tenant {{ $labels.tenant_id }} burning error budget at {{ $value }}x rate, monitor closely'
          runbook_url: 'https://runbooks.maestro.dev/slo/elevated-burn-response'

      - alert: TenantSLOViolation
        expr: tenant_slo_compliance{slo_type="availability"} == 0
        for: 5m
        labels:
          severity: critical
          service: slo
          epic: E22
        annotations:
          summary: 'Tenant SLO violation - availability'
          description: 'Tenant {{ $labels.tenant_id }} violating availability SLO for 5+ minutes'
          runbook_url: 'https://runbooks.maestro.dev/slo/availability-violation'

      - alert: SyntheticTestFailure
        expr: synthetic_test_success == 0
        for: 5m
        labels:
          severity: warning
          service: synthetic-tests
          epic: E22
        annotations:
          summary: 'Synthetic test failing for tenant'
          description: '{{ $labels.test_type }} synthetic test failing for tenant {{ $labels.tenant_id }} for 5+ minutes'
          runbook_url: 'https://runbooks.maestro.dev/synthetic/test-failure'

      - alert: TenantBudgetExhaustionImminent
        expr: tenant_error_budget_exhaustion_hours < 48
        for: 0m
        labels:
          severity: warning
          service: slo
          epic: E22
        annotations:
          summary: 'Tenant error budget exhaustion in {{ $value }} hours'
          description: 'Tenant {{ $labels.tenant_id }} will exhaust error budget in {{ $value }}h at current burn rate'

  # System Health & Performance
  - name: system-health-v24.4.0
    interval: 30s
    rules:
      - alert: MultipleEpicServicesDown
        expr: count(up{job=~"provenance|abuse-guard|cost-service|rtbf|slo-service"} == 0) >= 2
        for: 2m
        labels:
          severity: critical
          service: platform
        annotations:
          summary: 'Multiple v24.4.0 services are down'
          description: '{{ $value }} critical services from v24.4.0 are down, platform stability at risk'
          runbook_url: 'https://runbooks.maestro.dev/platform/multi-service-outage'

      - alert: PrometheusRuleEvaluationSlow
        expr: prometheus_rule_evaluation_duration_seconds{rule_group=~"provenance-integrity|abuse-detection|cost-tenancy|rtbf-privacy|tenant-slo"} > 30
        for: 5m
        labels:
          severity: warning
          service: monitoring
        annotations:
          summary: 'Prometheus rule evaluation slow for v24.4.0'
          description: 'Rule group {{ $labels.rule_group }} taking {{ $value }}s to evaluate, above 30s threshold'

  # Deployment & Rollback Readiness
  - name: deployment-readiness
    interval: 60s
    rules:
      - alert: KillSwitchActivated
        expr: (abuse_guard_enabled == 0) or (graph_guard_enabled == 0) or (tenant_partitioning_enabled == 0)
        for: 0m
        labels:
          severity: warning
          service: platform
        annotations:
          summary: 'Emergency kill switch activated'
          description: 'One or more v24.4.0 features disabled via kill switch. Check deployment status.'
          runbook_url: 'https://runbooks.maestro.dev/deployment/kill-switch-recovery'

      - alert: VersionSkewDetected
        expr: count(count by (version) (maestro_version_info)) > 1
        for: 10m
        labels:
          severity: warning
          service: deployment
        annotations:
          summary: 'Multiple versions running simultaneously'
          description: '{{ $value }} different versions detected, possible incomplete deployment'
          runbook_url: 'https://runbooks.maestro.dev/deployment/version-skew'
