groups:
  - name: query-cost-guard
    rules:
      - record: service:graphql_request_latency_ms:avg5m
        expr: avg_over_time(http_request_duration_ms{route="/graphql"}[5m])

      - alert: HighGraphQLLatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{route="/graphql"}[5m])) by (le)) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: 'High GraphQL latency (p95 > 500ms)'
          description: 'p95 latency exceeded 500ms for 10m. Investigate query cost and depth.'

      - alert: QueryCostGuardBudgetExceeded
        expr: increase(policy_evaluation_error_total[15m]) > 0 or increase(prov_ledger_bundle_verify_fail_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Budget exceeded (policy or provenance failures)'
          description: 'Policy evaluation errors or provenance verify failures exceeded thresholds.'
