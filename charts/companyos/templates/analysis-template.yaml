apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: slo-analysis-template
spec:
  args:
    - name: service-name
    - name: namespace
  metrics:
    - name: error-rate
      interval: 1m
      failureLimit: 1
      provider:
        prometheus:
          address: http://prometheus-kube-prometheus-stack-prometheus:9090 # Adjust if Prometheus is elsewhere
          query: |
            sum(rate(http_requests_total{job="{{args.service-name}}", namespace="{{args.namespace}}", code=~"5.."}[1m]))
            /
            sum(rate(http_requests_total{job="{{args.service-name}}", namespace="{{args.namespace}}"}[1m]))
      successCondition: "{{ .value < 0.01 }}" # Error rate < 1%
      failureCondition: "{{ .value >= 0.01 }}" # Error rate >= 0.01 (1%)
    - name: p99-latency
      interval: 1m
      failureLimit: 1
      provider:
        prometheus:
          address: http://prometheus-kube-prometheus-stack-prometheus:9090 # Adjust if Prometheus is elsewhere
          query: |
            histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="{{args.service-name}}", namespace="{{args.namespace}}"}[1m])) by (le))
      successCondition: "{{ .value < 0.5 }}" # p99 latency < 500ms
      failureCondition: "{{ .value >= 0.5 }}" # p99 latency >= 500ms
