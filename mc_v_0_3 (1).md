# MC v0.3.5 Planning Pack — **Attest · Adapt · Accelerate**

> Objective: Deepen trust guarantees (end‑to‑end attestations), adapt operations in real time (self‑tuning gates/budgets), and accelerate throughput (latency & cost) while maintaining all MC guardrails.

---

## Conductor Summary
**Goal:** Ship verifiable provenance/attestations at response and system levels, adaptive guardrails (canary + budgets + autoscaling), and performance/cost accelerators without regressing privacy/residency/SLOs.  
**Non‑Goals:** New data sources, schema overhauls, or net‑new LLM providers.  
**Constraints:** Existing SLOs & cost guardrails; persisted‑only and OPA enforcement; residency compliance.  
**Risks:** Over‑tight adaptive controls causing false holds; attestation overhead; autoscaling oscillation.  
**Definition of Done:** All epics meet AC & verification; CI gates pass; evidence `dist/evidence-v0.3.5-mc.json` signed; error‑budget burn <20% during rollout.

---

## Timeline & Milestones (5 weeks)
- **W1:** Attestation graph & API v1; adaptive canary controller skeleton; perf baselines
- **W2:** Budget auto‑tune v2 (per‑tenant/route); p95/p99 tail optimizer; cache/model picks
- **W3:** Signed response tokens + client verifiers; adaptive canary in staging
- **W4:** Prod canary + DR drill; A/B cost trials; finalize dashboards
- **W5:** GA; evidence bundle; post‑deploy review & audit addendum

---

## Epics → Stories → Tasks (with AC & Verification)

### E1 — **Attest**: End‑to‑End Verifiable Responses
**Stories**
1. **Provenance Graph v2** (signed DAG of tool hops, policies, sources)  
   **AC:** `prov_id` resolves to signed DAG; verification API returns `valid=true`; p95 ≤200ms at 100 RPS.  
   **Verify:** k6 load, signature check unit tests, evidence: `evidence/v0.3.5/attest/prov-dag.json`.
2. **Signed Response Tokens** (Ed25519)  
   **AC:** Every agentic response ships a detached JWS including hashes to inputs/outputs; client verifier PoC.  
   **Verify:** contract tests + negative tests (tamper → fail), evidence: samples + public key set (JWKS).
3. **Attestation Ledger Export**  
   **AC:** Daily ledger rollups signed + archived (7‑year); SIEM ingest parity.  
   **Verify:** nightly CI artifact + S3 upload proofs.

**Tasks:** JWKS rotation job; `services/provenance/jws.ts`; DAG builder; verifier lib (`pkg/attest/verify`); prom + dashboard panels for attestation rates.

---

### E2 — **Adapt**: Self‑Tuning Canary & Budgets
**Stories**
1. **Adaptive Canary Controller** (composite score: p95, error rate, cost per 1k, tail p99)  
   **AC:** PROMOTE if score ≥ threshold; HOLDS auto‑reduce traffic and extend bake; manual override logged.  
   **Verify:** replay harness with v0.3.4 data; evidence: decision logs + score parameters JSON.
2. **Budget Auto‑Tune v2** (per‑tenant & per‑route)  
   **AC:** breach → throttle ≤120s; post‑breach back‑off; noise <5% FPs.  
   **Verify:** synthetic breaches; evidence: throttle events + FP/FN report.
3. **HPA Guarded Learning** (anti‑oscillation)  
   **AC:** no more than 1 scale action per 2 min; SLO maintained under load tests.  
   **Verify:** k6 stress; HPA event logs analysis.

**Tasks:** `controllers/adaptive-canary.py`; `services/guard/budgets_v2.py`; prom rules for composite; workflow wiring + Slack decision cards.

---

### E3 — **Accelerate**: Throughput & Cost Wins
**Stories**
1. **Tail Latency Optimizer** (p99 target)  
   **AC:** p99 ↓ ≥10% without p50 regression; cache tier hints added.  
   **Verify:** A/B with canary; evidence: histograms before/after.
2. **Persisted‑Only Model Picks** (provider/model per route)  
   **AC:** policy‑gated routing; cost ↓ ≥10% at equal quality.  
   **Verify:** cost panel deltas; policy sim green.
3. **Cache Policy Tuner** (LLM + GraphQL)  
   **AC:** hit rate +5–10% with ≤1% stale risk; alarms on anomaly.  
   **Verify:** cache metrics; e2e tests with TTL sweeps.

**Tasks:** routing matrix; TTL auto‑tune; persisted query → model map; prom + Grafana panels.

---

### E4 — **Autonomy Expansion** (Shadow → Enact)
**Stories**
1. **TENANT_006 Shadow Mode** (computed ops replay)  
   **AC:** sim success ≥99.9%; comp ≤0.5%; 0 residency/privacy violations.  
2. **TENANT_006 Enact (HITL)**  
   **AC:** 48h canary; thresholds respected; rollback safe.  
3. **TENANT_007 Readiness**  
   **AC:** readiness ≥95%; DR enrolled.

**Tasks:** scenarios; tripwires; canary schedule; evidence capture.

---

## CI/CD Gates
- **Quality:** lint/type/tests, promtool, k6, trajectory goldens, grounding ≥95%.  
- **Policy:** OPA allow; residency/purpose; persisted‑only compliance.  
- **Config Attestation:** pre/post signed snapshots; drift blocks.  
- **Adaptive Canary Gate:** composite score ≥ threshold; Slack PROMOTE/HOLD.  
- **Evidence:** bundle signed with attestation DAGs, budget v2 logs, canary decisions, cost/latency deltas.

---

## Evidence Model Additions (v0.3.5)
- `evidence/v0.3.5/attest/prov-dag.json`, `jwks.json`, `signed-samples/*.jws`  
- `evidence/v0.3.5/adapt/canary-decisions.json`, `budget-autotune-report.json`  
- `evidence/v0.3.5/accelerate/latency-histograms-{before,after}.json`, `cost-deltas.json`  
- `evidence/v0.3.5/autonomy/TENANT_006/{sim,canary}.json`

---

## Runbooks (delta)
- **Attestation Failure:** serve response without JWS? → fail closed; return explain + retry; page SecOps.  
- **Adaptive Canary HOLD:** analyze score breakdown; override via feature flag; attach rationale to evidence.  
- **Budget Thrash:** dampening factor ↑; noise filters; revert to static limits.

---

## RACI
| Stream | R | A | C | I |
|---|---|---|---|---|
| Attest | Platform Sec | MC | AI Eng, SRE | PM |
| Adapt | SRE | MC | FinOps | PM |
| Accelerate | DevEx | MC | FinOps, SRE | PM |
| Autonomy (006/007) | SRE | MC | Platform Sec | PM |

---

## Quick Commands (operators)
```bash
# Attestation: snapshot keys & JWKS
python3 ops/attest/jwks-rotate.py --out evidence/v0.3.5/attest/jwks.json

# Adaptive canary (staging)
python3 controllers/adaptive-canary.py --window 10 --score-weights p95=0.5,error=0.3,cost=0.2 \
  --baseline https://stage-blue.example.com --candidate https://stage-green.example.com \
  --out evidence/v0.3.5/adapt/canary-decisions.json

# Budget v2 simulation
python3 services/guard/budgets_v2.py --simulate --tenant TENANT_001 --window 120 \
  --report evidence/v0.3.5/adapt/budget-autotune-report.json

# Tail latency A/B
k6 run tests/k6/graphql-ab-p99.js --out json=evidence/v0.3.5/accelerate/latency-histograms-before.json
```

---

## ADR Drafts
1. **ADR‑004:** Signed response tokens (JWS/Ed25519) as default for agentic answers.  
2. **ADR‑005:** Adopt adaptive composite canary scores for PROMOTE/HOLD.  
3. **ADR‑006:** Route persisted queries to policy‑approved provider/model matrix.

---

## Definition of Done (v0.3.5)
- All epics’ AC met with passing CI gates.  
- Evidence bundle `dist/evidence-v0.3.5-mc.json` signed, including attestation DAGs, adaptive decisions, budget v2 reports, performance deltas, and autonomy artifacts.  
- Ops dashboards updated (attestation rate, composite canary score, p99 tail, cost per 1k) with alerts.  
- Post‑deploy Day‑7 review attached with error‑budget burn <20%.

