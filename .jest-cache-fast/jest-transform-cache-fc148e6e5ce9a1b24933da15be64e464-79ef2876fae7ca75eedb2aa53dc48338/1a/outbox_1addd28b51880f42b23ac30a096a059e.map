{"file":"/Users/brianlong/Developer/summit/server/src/sync/outbox.ts","mappings":";;AAIA,kCAKC;AAED,oBAUC;AArBD,2BAA0B;AAE1B,MAAM,EAAE,GAAG,IAAI,SAAI,CAAC,EAAE,gBAAgB,EAAE,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC,CAAC;AAE7D,KAAK,UAAU,WAAW,CAAC,MAAc,EAAE,IAAyC,EAAE,GAAW,EAAE,OAAgB;IACxH,MAAM,EAAE,CAAC,KAAK,CACZ,wEAAwE,EACxE,CAAC,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,OAAO,IAAI,IAAI,CAAC,CACrC,CAAC;AACJ,CAAC;AAEM,KAAK,UAAU,IAAI,CAAC,MAAc,EAAE,IAAkC;IAC3E,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,EAAE,CAAC,KAAK,CAC7B,sFAAsF,EACtF,CAAC,MAAM,CAAC,CACT,CAAC;IACF,KAAK,MAAM,CAAC,IAAI,IAAI,EAAE,CAAC;QACrB,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC;QACzB,IAAI,EAAE;YAAE,MAAM,EAAE,CAAC,KAAK,CAAC,kDAAkD,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;;YAC9E,MAAM,EAAE,CAAC,KAAK,CAAC,sDAAsD,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;IACtF,CAAC;AACH,CAAC","names":[],"sources":["/Users/brianlong/Developer/summit/server/src/sync/outbox.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pg = new Pool({ connectionString: process.env.DATABASE_URL });\n\nexport async function enqueueSync(siteId: string, kind: 'artifact' | 'provenance' | 'event', ref: string, payload?: Buffer) {\n  await pg.query(\n    `INSERT INTO sync_outbox(site_id,kind,ref,payload) VALUES ($1,$2,$3,$4)`,\n    [siteId, kind, ref, payload || null],\n  );\n}\n\nexport async function pump(siteId: string, send: (m: any) => Promise<boolean>) {\n  const { rows } = await pg.query(\n    `SELECT * FROM sync_outbox WHERE site_id=$1 AND status='QUEUED' ORDER BY id LIMIT 500`,\n    [siteId],\n  );\n  for (const r of rows) {\n    const ok = await send(r);\n    if (ok) await pg.query(`UPDATE sync_outbox SET status='SENT' WHERE id=$1`, [r.id]);\n    else await pg.query(`UPDATE sync_outbox SET retries=retries+1 WHERE id=$1`, [r.id]);\n  }\n}\n\n"],"version":3}