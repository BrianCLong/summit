e608f9e230cdae9e4071a5f14cf0c476
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.enqueueSync = enqueueSync;
exports.pump = pump;
const pg_1 = require("pg");
const pg = new pg_1.Pool({ connectionString: process.env.DATABASE_URL });
async function enqueueSync(siteId, kind, ref, payload) {
    await pg.query(`INSERT INTO sync_outbox(site_id,kind,ref,payload) VALUES ($1,$2,$3,$4)`, [siteId, kind, ref, payload || null]);
}
async function pump(siteId, send) {
    const { rows } = await pg.query(`SELECT * FROM sync_outbox WHERE site_id=$1 AND status='QUEUED' ORDER BY id LIMIT 500`, [siteId]);
    for (const r of rows) {
        const ok = await send(r);
        if (ok)
            await pg.query(`UPDATE sync_outbox SET status='SENT' WHERE id=$1`, [r.id]);
        else
            await pg.query(`UPDATE sync_outbox SET retries=retries+1 WHERE id=$1`, [r.id]);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvc3luYy9vdXRib3gudHMiLCJtYXBwaW5ncyI6Ijs7QUFJQSxrQ0FLQztBQUVELG9CQVVDO0FBckJELDJCQUEwQjtBQUUxQixNQUFNLEVBQUUsR0FBRyxJQUFJLFNBQUksQ0FBQyxFQUFFLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztBQUU3RCxLQUFLLFVBQVUsV0FBVyxDQUFDLE1BQWMsRUFBRSxJQUF5QyxFQUFFLEdBQVcsRUFBRSxPQUFnQjtJQUN4SCxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQ1osd0VBQXdFLEVBQ3hFLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsT0FBTyxJQUFJLElBQUksQ0FBQyxDQUNyQyxDQUFDO0FBQ0osQ0FBQztBQUVNLEtBQUssVUFBVSxJQUFJLENBQUMsTUFBYyxFQUFFLElBQWtDO0lBQzNFLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQzdCLHNGQUFzRixFQUN0RixDQUFDLE1BQU0sQ0FBQyxDQUNULENBQUM7SUFDRixLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3JCLE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLElBQUksRUFBRTtZQUFFLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxrREFBa0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDOztZQUM5RSxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsc0RBQXNELEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN0RixDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvYnJpYW5sb25nL0RldmVsb3Blci9zdW1taXQvc2VydmVyL3NyYy9zeW5jL291dGJveC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQb29sIH0gZnJvbSAncGcnO1xuXG5jb25zdCBwZyA9IG5ldyBQb29sKHsgY29ubmVjdGlvblN0cmluZzogcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMIH0pO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZW5xdWV1ZVN5bmMoc2l0ZUlkOiBzdHJpbmcsIGtpbmQ6ICdhcnRpZmFjdCcgfCAncHJvdmVuYW5jZScgfCAnZXZlbnQnLCByZWY6IHN0cmluZywgcGF5bG9hZD86IEJ1ZmZlcikge1xuICBhd2FpdCBwZy5xdWVyeShcbiAgICBgSU5TRVJUIElOVE8gc3luY19vdXRib3goc2l0ZV9pZCxraW5kLHJlZixwYXlsb2FkKSBWQUxVRVMgKCQxLCQyLCQzLCQ0KWAsXG4gICAgW3NpdGVJZCwga2luZCwgcmVmLCBwYXlsb2FkIHx8IG51bGxdLFxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHVtcChzaXRlSWQ6IHN0cmluZywgc2VuZDogKG06IGFueSkgPT4gUHJvbWlzZTxib29sZWFuPikge1xuICBjb25zdCB7IHJvd3MgfSA9IGF3YWl0IHBnLnF1ZXJ5KFxuICAgIGBTRUxFQ1QgKiBGUk9NIHN5bmNfb3V0Ym94IFdIRVJFIHNpdGVfaWQ9JDEgQU5EIHN0YXR1cz0nUVVFVUVEJyBPUkRFUiBCWSBpZCBMSU1JVCA1MDBgLFxuICAgIFtzaXRlSWRdLFxuICApO1xuICBmb3IgKGNvbnN0IHIgb2Ygcm93cykge1xuICAgIGNvbnN0IG9rID0gYXdhaXQgc2VuZChyKTtcbiAgICBpZiAob2spIGF3YWl0IHBnLnF1ZXJ5KGBVUERBVEUgc3luY19vdXRib3ggU0VUIHN0YXR1cz0nU0VOVCcgV0hFUkUgaWQ9JDFgLCBbci5pZF0pO1xuICAgIGVsc2UgYXdhaXQgcGcucXVlcnkoYFVQREFURSBzeW5jX291dGJveCBTRVQgcmV0cmllcz1yZXRyaWVzKzEgV0hFUkUgaWQ9JDFgLCBbci5pZF0pO1xuICB9XG59XG5cbiJdLCJ2ZXJzaW9uIjozfQ==