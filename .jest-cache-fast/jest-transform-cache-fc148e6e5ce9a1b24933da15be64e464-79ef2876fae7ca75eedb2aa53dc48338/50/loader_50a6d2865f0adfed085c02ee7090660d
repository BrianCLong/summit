84e232529f1eaed2e01a1d984d6e81b6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadSignedPolicy = loadSignedPolicy;
const node_child_process_1 = require("node:child_process");
const fs_1 = require("fs");
async function loadSignedPolicy(bundlePath, sigPath) {
    const allowUnsigned = (process.env.ALLOW_UNSIGNED_POLICY || 'false').toLowerCase() === 'true';
    if (!sigPath && !allowUnsigned) {
        throw new Error('unsigned policy not allowed (set ALLOW_UNSIGNED_POLICY=true to override)');
    }
    if (sigPath) {
        await new Promise((res, rej) => (0, node_child_process_1.execFile)('cosign', ['verify-blob', '--signature', sigPath, bundlePath], (e) => (e ? rej(e) : res())));
    }
    const buf = await fs_1.promises.readFile(bundlePath);
    if (!buf || buf.length === 0)
        throw new Error('empty policy bundle');
    return { ok: true };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvcG9saWN5L2xvYWRlci50cyIsIm1hcHBpbmdzIjoiOztBQUdBLDRDQWFDO0FBaEJELDJEQUE4QztBQUM5QywyQkFBb0M7QUFFN0IsS0FBSyxVQUFVLGdCQUFnQixDQUFDLFVBQWtCLEVBQUUsT0FBZ0I7SUFDekUsTUFBTSxhQUFhLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLE1BQU0sQ0FBQztJQUM5RixJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQywwRUFBMEUsQ0FBQyxDQUFDO0lBQzlGLENBQUM7SUFDRCxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ1osTUFBTSxJQUFJLE9BQU8sQ0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUNuQyxJQUFBLDZCQUFRLEVBQUMsUUFBUSxFQUFFLENBQUMsYUFBYSxFQUFFLGFBQWEsRUFBRSxPQUFRLEVBQUUsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FDdEcsQ0FBQztJQUNKLENBQUM7SUFDRCxNQUFNLEdBQUcsR0FBRyxNQUFNLGFBQUUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDMUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDckUsT0FBTyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQVcsQ0FBQztBQUMvQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9icmlhbmxvbmcvRGV2ZWxvcGVyL3N1bW1pdC9zZXJ2ZXIvc3JjL3BvbGljeS9sb2FkZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlY0ZpbGUgfSBmcm9tICdub2RlOmNoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgcHJvbWlzZXMgYXMgZnMgfSBmcm9tICdmcyc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkU2lnbmVkUG9saWN5KGJ1bmRsZVBhdGg6IHN0cmluZywgc2lnUGF0aD86IHN0cmluZykge1xuICBjb25zdCBhbGxvd1Vuc2lnbmVkID0gKHByb2Nlc3MuZW52LkFMTE9XX1VOU0lHTkVEX1BPTElDWSB8fCAnZmFsc2UnKS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gIGlmICghc2lnUGF0aCAmJiAhYWxsb3dVbnNpZ25lZCkge1xuICAgIHRocm93IG5ldyBFcnJvcigndW5zaWduZWQgcG9saWN5IG5vdCBhbGxvd2VkIChzZXQgQUxMT1dfVU5TSUdORURfUE9MSUNZPXRydWUgdG8gb3ZlcnJpZGUpJyk7XG4gIH1cbiAgaWYgKHNpZ1BhdGgpIHtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPigocmVzLCByZWopID0+XG4gICAgICBleGVjRmlsZSgnY29zaWduJywgWyd2ZXJpZnktYmxvYicsICctLXNpZ25hdHVyZScsIHNpZ1BhdGghLCBidW5kbGVQYXRoXSwgKGUpID0+IChlID8gcmVqKGUpIDogcmVzKCkpKSxcbiAgICApO1xuICB9XG4gIGNvbnN0IGJ1ZiA9IGF3YWl0IGZzLnJlYWRGaWxlKGJ1bmRsZVBhdGgpO1xuICBpZiAoIWJ1ZiB8fCBidWYubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2VtcHR5IHBvbGljeSBidW5kbGUnKTtcbiAgcmV0dXJuIHsgb2s6IHRydWUgfSBhcyBjb25zdDtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==