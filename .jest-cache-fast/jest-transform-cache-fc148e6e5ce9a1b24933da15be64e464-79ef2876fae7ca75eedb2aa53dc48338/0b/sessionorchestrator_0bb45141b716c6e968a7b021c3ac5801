15bf23df241ed44c627332b35e81c48b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.crystalOrchestrator = exports.CrystalSessionOrchestrator = void 0;
const events_1 = require("events");
const crypto_1 = require("crypto");
const adapter_registry_js_1 = require("./adapter-registry.js");
const provenance_ledger_js_1 = require("./provenance-ledger.js");
const slo_metrics_js_1 = require("./slo-metrics.js");
const worktree_engine_js_1 = require("./worktree-engine.js");
const types_js_1 = require("./types.js");
class RunLogEmitter extends events_1.EventEmitter {
    emitLog(event) {
        this.emit('log', event);
    }
    onLog(listener) {
        this.on('log', listener);
        return () => this.off('log', listener);
    }
}
function clone(value) {
    return structuredClone ? structuredClone(value) : JSON.parse(JSON.stringify(value));
}
function buildPanels(presets) {
    const items = presets?.length
        ? presets
        : [
            { type: types_js_1.PanelType.AGENT, name: 'Claude Code' },
            { type: types_js_1.PanelType.AGENT, name: 'Codex' },
            { type: types_js_1.PanelType.TERMINAL, name: 'Terminal' },
            { type: types_js_1.PanelType.DIFF, name: 'Diff Viewer' },
            { type: types_js_1.PanelType.EDITOR, name: 'Editor' },
            { type: types_js_1.PanelType.LOGS, name: 'Run Logs' },
        ];
    return items.map((panel, index) => ({
        id: (0, crypto_1.randomUUID)(),
        type: panel.type,
        name: panel.name ?? panel.type,
        layout: {
            x: (index % 2) * 6,
            y: Math.floor(index / 2) * 6,
            w: 6,
            h: 6,
            preset: panel.preset,
        },
    }));
}
function buildRunScripts(defs) {
    return (defs || []).map((def) => ({
        id: (0, crypto_1.randomUUID)(),
        name: def.name,
        command: def.command,
        timeoutMs: def.timeoutMs,
        environment: def.environment,
    }));
}
function buildAgents(adapters) {
    const adapterKeys = adapters?.length ? adapters : ['claude-code', 'codex'];
    return adapterKeys.map((key) => {
        const adapter = adapter_registry_js_1.adapterRegistry.get(key);
        return {
            id: (0, crypto_1.randomUUID)(),
            adapterKey: adapter.key,
            status: 'idle',
            capabilities: adapter.capabilities(),
            createdAt: new Date().toISOString(),
        };
    });
}
function buildAttachments(input) {
    return (input || []).map((attachment) => ({
        id: (0, crypto_1.randomUUID)(),
        type: attachment.type,
        name: attachment.name,
        size: attachment.size,
        contentType: attachment.contentType,
        purpose: attachment.purpose,
        retention: attachment.retention || 'standard-365d',
        uri: attachment.uri,
        createdAt: new Date().toISOString(),
    }));
}
class CrystalSessionOrchestrator {
    sessions = new Map();
    runLogEmitters = new Map();
    deps;
    constructor(deps) {
        this.deps = {
            worktreeEngine: worktree_engine_js_1.worktreeEngine,
            metrics: slo_metrics_js_1.sloMetrics,
            ...deps,
        };
    }
    listSessions() {
        return Array.from(this.sessions.values()).map((session) => clone(session));
    }
    getSession(id) {
        const session = this.sessions.get(id);
        return session ? clone(session) : undefined;
    }
    getAdapters() {
        return adapter_registry_js_1.adapterRegistry.list().map((adapter) => ({
            key: adapter.key,
            name: adapter.name,
            description: `${adapter.name} adapter`,
            capabilities: adapter.capabilities(),
        }));
    }
    getCostSnapshot() {
        return this.deps.metrics.getCostSnapshot();
    }
    async createSession(input) {
        if (!input.projectPath) {
            throw new Error('projectPath is required');
        }
        const worktree = await this.deps.worktreeEngine.create({
            sessionId: 'pending',
            projectPath: input.projectPath,
            mainBranch: input.mainBranch,
        });
        const runScripts = buildRunScripts(input.runScripts);
        const agents = buildAgents(input.adapters);
        const panels = buildPanels(input.panelPresets);
        const attachments = buildAttachments(input.attachments);
        const sessionId = (0, crypto_1.randomUUID)();
        const now = new Date().toISOString();
        const provenance = provenance_ledger_js_1.provenanceLedger.record('crystal', 'session-created', {
            sessionId,
            worktreeId: worktree.id,
            projectPath: input.projectPath,
            agents: agents.map((agent) => agent.adapterKey),
        });
        const session = {
            id: sessionId,
            name: input.name,
            description: input.description,
            status: 'active',
            theme: input.theme || 'light',
            createdAt: now,
            updatedAt: now,
            purposeTags: input.purposeTags?.length ? input.purposeTags : ['investigation'],
            retention: input.retention || 'standard-365d',
            worktree,
            panels,
            attachments,
            runScripts,
            runs: [],
            agents,
            messages: [],
            provenanceId: provenance.id,
            slo: this.deps.metrics.getSLOSnapshot(),
            cost: this.deps.metrics.getCostSnapshot(),
        };
        this.sessions.set(sessionId, session);
        this.deps.metrics.recordCost('dev', 25);
        this.deps.metrics.observeGateway('write', 120);
        return clone(session);
    }
    async startRun(input) {
        const session = this.requireSession(input.sessionId);
        const definition = session.runScripts.find((script) => script.id === input.runDefinitionId);
        if (!definition) {
            throw new Error(`Unknown run script ${input.runDefinitionId}`);
        }
        const command = input.overrides?.command || definition.command;
        const environment = {
            ...definition.environment,
            ...input.overrides?.environment,
        };
        const timeoutMs = input.overrides?.timeoutMs ?? definition.timeoutMs ?? 5 * 60 * 1000;
        const runId = (0, crypto_1.randomUUID)();
        const startedAt = new Date().toISOString();
        const provenance = provenance_ledger_js_1.provenanceLedger.record('crystal', 'run-started', {
            sessionId: session.id,
            runId,
            command,
            environment,
            timeoutMs,
        });
        const run = {
            id: runId,
            definitionId: definition.id,
            status: 'running',
            startedAt,
            provenanceId: provenance.id,
            logs: [],
        };
        session.runs = [run, ...session.runs];
        this.touch(session);
        const emitter = this.getEmitter(session.id, run.id);
        const pushLog = (stream, message) => {
            const entry = {
                id: (0, crypto_1.randomUUID)(),
                timestamp: new Date().toISOString(),
                stream,
                message,
            };
            run.logs.push(entry);
            emitter.emitLog({ sessionId: session.id, runId: run.id, entry });
        };
        pushLog('system', `Running ${command}`);
        const phases = command.split('&&').map((segment) => segment.trim());
        for (const phase of phases) {
            pushLog('stdout', `$ ${phase}`);
            await new Promise((resolve) => setTimeout(resolve, 0));
        }
        pushLog('stdout', 'Execution completed successfully.');
        run.status = 'succeeded';
        run.exitCode = 0;
        run.completedAt = new Date().toISOString();
        this.touch(session);
        this.deps.metrics.observeGateway('read', 180);
        this.deps.metrics.observeGraph(2, 240);
        this.deps.metrics.recordCost('dev', 5);
        provenance_ledger_js_1.provenanceLedger.record('crystal', 'run-completed', {
            sessionId: session.id,
            runId: run.id,
            exitCode: run.exitCode,
        });
        return clone(run);
    }
    async recordMessage(input) {
        const session = this.requireSession(input.sessionId);
        const agent = session.agents.find((candidate) => candidate.id === input.agentId);
        if (!agent) {
            throw new Error(`Unknown agent ${input.agentId}`);
        }
        const adapter = adapter_registry_js_1.adapterRegistry.get(agent.adapterKey);
        const role = input.role === 'system' ? 'system' : 'user';
        const userMessage = {
            id: (0, crypto_1.randomUUID)(),
            agentId: agent.id,
            role,
            content: input.content,
            createdAt: new Date().toISOString(),
            attachmentIds: input.attachmentIds,
            richOutput: input.richOutput,
        };
        session.messages.push(userMessage);
        provenance_ledger_js_1.provenanceLedger.record('crystal', 'user-message', userMessage);
        const assistantMessage = await adapter.sendMessage({
            sessionId: session.id,
            agentId: agent.id,
            content: input.content,
            attachments: input.attachmentIds,
        });
        session.messages.push(assistantMessage);
        agent.status = 'idle';
        this.touch(session);
        this.deps.metrics.observeGateway('read', 150);
        this.deps.metrics.recordCost('llm', 1.2);
        return clone(assistantMessage);
    }
    async summarize(sessionId, agentId) {
        const session = this.requireSession(sessionId);
        const agent = session.agents.find((candidate) => candidate.id === agentId);
        if (!agent) {
            throw new Error(`Unknown agent ${agentId}`);
        }
        const adapter = adapter_registry_js_1.adapterRegistry.get(agent.adapterKey);
        return adapter.summarizeThread(sessionId, agentId);
    }
    updatePanels(input) {
        const session = this.requireSession(input.sessionId);
        const layoutMap = new Map(input.panels.map((panel) => [panel.panelId, panel.layout]));
        session.panels = session.panels.map((panel) => layoutMap.has(panel.id)
            ? { ...panel, layout: layoutMap.get(panel.id) }
            : panel);
        this.touch(session);
        provenance_ledger_js_1.provenanceLedger.record('crystal', 'panel-layout-updated', {
            sessionId: session.id,
            panels: input.panels,
        });
        return clone(session);
    }
    async closeSession(input) {
        const session = this.requireSession(input.sessionId);
        session.status = 'closing';
        this.touch(session);
        await this.deps.worktreeEngine.deleteQueued(session.worktree.id);
        session.status = 'closed';
        this.touch(session);
        provenance_ledger_js_1.provenanceLedger.record('crystal', 'session-closed', { sessionId: session.id });
        return clone(session);
    }
    subscribeToRunLogs(sessionId, runId, listener) {
        const emitter = this.getEmitter(sessionId, runId);
        return emitter.onLog(listener);
    }
    getEmitter(sessionId, runId) {
        const key = `${sessionId}:${runId}`;
        if (!this.runLogEmitters.has(key)) {
            this.runLogEmitters.set(key, new RunLogEmitter());
        }
        return this.runLogEmitters.get(key);
    }
    requireSession(id) {
        const session = this.sessions.get(id);
        if (!session) {
            throw new Error(`Unknown session ${id}`);
        }
        return session;
    }
    touch(session) {
        session.updatedAt = new Date().toISOString();
        session.slo = this.deps.metrics.getSLOSnapshot();
        session.cost = this.deps.metrics.getCostSnapshot();
    }
}
exports.CrystalSessionOrchestrator = CrystalSessionOrchestrator;
exports.crystalOrchestrator = new CrystalSessionOrchestrator();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvY3J5c3RhbC9zZXNzaW9uLW9yY2hlc3RyYXRvci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBc0M7QUFDdEMsbUNBQW9DO0FBQ3BDLCtEQUF3RDtBQUN4RCxpRUFBMEQ7QUFDMUQscURBQTBEO0FBQzFELDZEQUFzRTtBQUN0RSx5Q0Flb0I7QUFRcEIsTUFBTSxhQUFjLFNBQVEscUJBQVk7SUFDdEMsT0FBTyxDQUFDLEtBQWtCO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxLQUFLLENBQUMsUUFBc0M7UUFDMUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDekIsT0FBTyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBQ0Y7QUFFRCxTQUFTLEtBQUssQ0FBSSxLQUFRO0lBQ3hCLE9BQU8sZUFBZSxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQ3RGLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUE0QztJQUMvRCxNQUFNLEtBQUssR0FBRyxPQUFPLEVBQUUsTUFBTTtRQUMzQixDQUFDLENBQUMsT0FBTztRQUNULENBQUMsQ0FBQztZQUNFLEVBQUUsSUFBSSxFQUFFLG9CQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7WUFDOUMsRUFBRSxJQUFJLEVBQUUsb0JBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRTtZQUN4QyxFQUFFLElBQUksRUFBRSxvQkFBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsVUFB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QUUsQ0FBQztJQUNyRCxDQUFDO0NBQ0Y7QUE3UUQsZ0VBNlFDO0FBRVksUUFBQSxtQkFBbUIsR0FBRyxJQUFJLDBCQUEwQixFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvY3J5c3RhbC9zZXNzaW9uLW9yY2hlc3RyYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBhZGFwdGVyUmVnaXN0cnkgfSBmcm9tICcuL2FkYXB0ZXItcmVnaXN0cnkuanMnO1xuaW1wb3J0IHsgcHJvdmVuYW5jZUxlZGdlciB9IGZyb20gJy4vcHJvdmVuYW5jZS1sZWRnZXIuanMnO1xuaW1wb3J0IHsgc2xvTWV0cmljcywgU0xPTWV0cmljcyB9IGZyb20gJy4vc2xvLW1ldHJpY3MuanMnO1xuaW1wb3J0IHsgd29ya3RyZWVFbmdpbmUsIFdvcmt0cmVlRW5naW5lIH0gZnJvbSAnLi93b3JrdHJlZS1lbmdpbmUuanMnO1xuaW1wb3J0IHtcbiAgUGFuZWxUeXBlLFxuICB0eXBlIEFnZW50UmVnaXN0cmF0aW9uLFxuICB0eXBlIEFzc2lzdGFudE1lc3NhZ2UsXG4gIHR5cGUgQ2xvc2VTZXNzaW9uSW5wdXQsXG4gIHR5cGUgQ3JlYXRlU2Vzc2lvbklucHV0LFxuICB0eXBlIENyeXN0YWxQYW5lbCxcbiAgdHlwZSBDcnlzdGFsU2Vzc2lvbixcbiAgdHlwZSBSZWNvcmRNZXNzYWdlSW5wdXQsXG4gIHR5cGUgUnVuRXhlY3V0aW9uLFxuICB0eXBlIFJ1bkxvZ0VudHJ5LFxuICB0eXBlIFJ1blNjcmlwdERlZmluaXRpb24sXG4gIHR5cGUgU3RhcnRSdW5JbnB1dCxcbiAgdHlwZSBVcGRhdGVQYW5lbHNJbnB1dCxcbiAgdHlwZSBQYW5lbExheW91dCxcbn0gZnJvbSAnLi90eXBlcy5qcyc7XG5cbmludGVyZmFjZSBSdW5Mb2dFdmVudCB7XG4gIHNlc3Npb25JZDogc3RyaW5nO1xuICBydW5JZDogc3RyaW5nO1xuICBlbnRyeTogUnVuTG9nRW50cnk7XG59XG5cbmNsYXNzIFJ1bkxvZ0VtaXR0ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBlbWl0TG9nKGV2ZW50OiBSdW5Mb2dFdmVudCkge1xuICAgIHRoaXMuZW1pdCgnbG9nJywgZXZlbnQpO1xuICB9XG5cbiAgb25Mb2cobGlzdGVuZXI6IChldmVudDogUnVuTG9nRXZlbnQpID0+IHZvaWQpIHtcbiAgICB0aGlzLm9uKCdsb2cnLCBsaXN0ZW5lcik7XG4gICAgcmV0dXJuICgpID0+IHRoaXMub2ZmKCdsb2cnLCBsaXN0ZW5lcik7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2xvbmU8VD4odmFsdWU6IFQpOiBUIHtcbiAgcmV0dXJuIHN0cnVjdHVyZWRDbG9uZSA/IHN0cnVjdHVyZWRDbG9uZSh2YWx1ZSkgOiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkUGFuZWxzKHByZXNldHM/OiBDcmVhdGVTZXNzaW9uSW5wdXRbJ3BhbmVsUHJlc2V0cyddKTogQ3J5c3RhbFBhbmVsW10ge1xuICBjb25zdCBpdGVtcyA9IHByZXNldHM/Lmxlbmd0aFxuICAgID8gcHJlc2V0c1xuICAgIDogW1xuICAgICAgICB7IHR5cGU6IFBhbmVsVHlwZS5BR0VOVCwgbmFtZTogJ0NsYXVkZSBDb2RlJyB9LFxuICAgICAgICB7IHR5cGU6IFBhbmVsVHlwZS5BR0VOVCwgbmFtZTogJ0NvZGV4JyB9LFxuICAgICAgICB7IHR5cGU6IFBhbmVsVHlwZS5URVJNSU5BTCwgbmFtZTogJ1Rlcm1pbmFsJyB9LFxuICAgICAgICB7IHR5cGU6IFBhbmVsVHlwZS5ESUZGLCBuYW1lOiAnRGlmZiBWaWV3ZXInIH0sXG4gICAgICAgIHsgdHlwZTogUGFuZWxUeXBlLkVESVRPUiwgbmFtZTogJ0VkaXRvcicgfSxcbiAgICAgICAgeyB0eXBlOiBQYW5lbFR5cGUuTE9HUywgbmFtZTogJ1J1biBMb2dzJyB9LFxuICAgICAgXTtcbiAgcmV0dXJuIGl0ZW1zLm1hcCgocGFuZWwsIGluZGV4KSA9PiAoe1xuICAgIGlkOiByYW5kb21VVUlEKCksXG4gICAgdHlwZTogcGFuZWwudHlwZSxcbiAgICBuYW1lOiBwYW5lbC5uYW1lID8/IHBhbmVsLnR5cGUsXG4gICAgbGF5b3V0OiB7XG4gICAgICB4OiAoaW5kZXggJSAyKSAqIDYsXG4gICAgICB5OiBNYXRoLmZsb29yKGluZGV4IC8gMikgKiA2LFxuICAgICAgdzogNixcbiAgICAgIGg6IDYsXG4gICAgICBwcmVzZXQ6IHBhbmVsLnByZXNldCxcbiAgICB9LFxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkUnVuU2NyaXB0cyhkZWZzPzogQ3JlYXRlU2Vzc2lvbklucHV0WydydW5TY3JpcHRzJ10pOiBSdW5TY3JpcHREZWZpbml0aW9uW10ge1xuICByZXR1cm4gKGRlZnMgfHwgW10pLm1hcCgoZGVmKSA9PiAoe1xuICAgIGlkOiByYW5kb21VVUlEKCksXG4gICAgbmFtZTogZGVmLm5hbWUsXG4gICAgY29tbWFuZDogZGVmLmNvbW1hbmQsXG4gICAgdGltZW91dE1zOiBkZWYudGltZW91dE1zLFxuICAgIGVudmlyb25tZW50OiBkZWYuZW52aXJvbm1lbnQsXG4gIH0pKTtcbn1cblxuZnVuY3Rpb24gYnVpbGRBZ2VudHMoYWRhcHRlcnM/OiBzdHJpbmdbXSk6IEFnZW50UmVnaXN0cmF0aW9uW10ge1xuICBjb25zdCBhZGFwdGVyS2V5cyA9IGFkYXB0ZXJzPy5sZW5ndGggPyBhZGFwdGVycyA6IFsnY2xhdWRlLWNvZGUnLCAnY29kZXgnXTtcbiAgcmV0dXJuIGFkYXB0ZXJLZXlzLm1hcCgoa2V5KSA9PiB7XG4gICAgY29uc3QgYWRhcHRlciA9IGFkYXB0ZXJSZWdpc3RyeS5nZXQoa2V5KTtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHJhbmRvbVVVSUQoKSxcbiAgICAgIGFkYXB0ZXJLZXk6IGFkYXB0ZXIua2V5LFxuICAgICAgc3RhdHVzOiAnaWRsZScsXG4gICAgICBjYXBhYmlsaXRpZXM6IGFkYXB0ZXIuY2FwYWJpbGl0aWVzKCksXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB9IHNhdGlzZmllcyBBZ2VudFJlZ2lzdHJhdGlvbjtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkQXR0YWNobWVudHMoaW5wdXQ6IENyZWF0ZVNlc3Npb25JbnB1dFsnYXR0YWNobWVudHMnXSkge1xuICByZXR1cm4gKGlucHV0IHx8IFtdKS5tYXAoKGF0dGFjaG1lbnQpID0+ICh7XG4gICAgaWQ6IHJhbmRvbVVVSUQoKSxcbiAgICB0eXBlOiBhdHRhY2htZW50LnR5cGUsXG4gICAgbmFtZTogYXR0YWNobWVudC5uYW1lLFxuICAgIHNpemU6IGF0dGFjaG1lbnQuc2l6ZSxcbiAgICBjb250ZW50VHlwZTogYXR0YWNobWVudC5jb250ZW50VHlwZSxcbiAgICBwdXJwb3NlOiBhdHRhY2htZW50LnB1cnBvc2UsXG4gICAgcmV0ZW50aW9uOiBhdHRhY2htZW50LnJldGVudGlvbiB8fCAnc3RhbmRhcmQtMzY1ZCcsXG4gICAgdXJpOiBhdHRhY2htZW50LnVyaSxcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgfSkpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9yY2hlc3RyYXRvckRlcGVuZGVuY2llcyB7XG4gIHdvcmt0cmVlRW5naW5lOiBXb3JrdHJlZUVuZ2luZTtcbiAgbWV0cmljczogU0xPTWV0cmljcztcbn1cblxuZXhwb3J0IGNsYXNzIENyeXN0YWxTZXNzaW9uT3JjaGVzdHJhdG9yIHtcbiAgcHJpdmF0ZSBzZXNzaW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBDcnlzdGFsU2Vzc2lvbj4oKTtcbiAgcHJpdmF0ZSBydW5Mb2dFbWl0dGVycyA9IG5ldyBNYXA8c3RyaW5nLCBSdW5Mb2dFbWl0dGVyPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlcHM6IE9yY2hlc3RyYXRvckRlcGVuZGVuY2llcztcblxuICBjb25zdHJ1Y3RvcihkZXBzPzogUGFydGlhbDxPcmNoZXN0cmF0b3JEZXBlbmRlbmNpZXM+KSB7XG4gICAgdGhpcy5kZXBzID0ge1xuICAgICAgd29ya3RyZWVFbmdpbmUsXG4gICAgICBtZXRyaWNzOiBzbG9NZXRyaWNzLFxuICAgICAgLi4uZGVwcyxcbiAgICB9IGFzIE9yY2hlc3RyYXRvckRlcGVuZGVuY2llcztcbiAgfVxuXG4gIGxpc3RTZXNzaW9ucygpOiBDcnlzdGFsU2Vzc2lvbltdIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnNlc3Npb25zLnZhbHVlcygpKS5tYXAoKHNlc3Npb24pID0+IGNsb25lKHNlc3Npb24pKTtcbiAgfVxuXG4gIGdldFNlc3Npb24oaWQ6IHN0cmluZyk6IENyeXN0YWxTZXNzaW9uIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9ucy5nZXQoaWQpO1xuICAgIHJldHVybiBzZXNzaW9uID8gY2xvbmUoc2Vzc2lvbikgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBnZXRBZGFwdGVycygpIHtcbiAgICByZXR1cm4gYWRhcHRlclJlZ2lzdHJ5Lmxpc3QoKS5tYXAoKGFkYXB0ZXIpID0+ICh7XG4gICAgICBrZXk6IGFkYXB0ZXIua2V5LFxuICAgICAgbmFtZTogYWRhcHRlci5uYW1lLFxuICAgICAgZGVzY3JpcHRpb246IGAke2FkYXB0ZXIubmFtZX0gYWRhcHRlcmAsXG4gICAgICBjYXBhYmlsaXRpZXM6IGFkYXB0ZXIuY2FwYWJpbGl0aWVzKCksXG4gICAgfSkpO1xuICB9XG5cbiAgZ2V0Q29zdFNuYXBzaG90KCkge1xuICAgIHJldHVybiB0aGlzLmRlcHMubWV0cmljcy5nZXRDb3N0U25hcHNob3QoKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24oaW5wdXQ6IENyZWF0ZVNlc3Npb25JbnB1dCk6IFByb21pc2U8Q3J5c3RhbFNlc3Npb24+IHtcbiAgICBpZiAoIWlucHV0LnByb2plY3RQYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2plY3RQYXRoIGlzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgd29ya3RyZWUgPSBhd2FpdCB0aGlzLmRlcHMud29ya3RyZWVFbmdpbmUuY3JlYXRlKHtcbiAgICAgIHNlc3Npb25JZDogJ3BlbmRpbmcnLFxuICAgICAgcHJvamVjdFBhdGg6IGlucHV0LnByb2plY3RQYXRoLFxuICAgICAgbWFpbkJyYW5jaDogaW5wdXQubWFpbkJyYW5jaCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJ1blNjcmlwdHMgPSBidWlsZFJ1blNjcmlwdHMoaW5wdXQucnVuU2NyaXB0cyk7XG4gICAgY29uc3QgYWdlbnRzID0gYnVpbGRBZ2VudHMoaW5wdXQuYWRhcHRlcnMpO1xuICAgIGNvbnN0IHBhbmVscyA9IGJ1aWxkUGFuZWxzKGlucHV0LnBhbmVsUHJlc2V0cyk7XG4gICAgY29uc3QgYXR0YWNobWVudHMgPSBidWlsZEF0dGFjaG1lbnRzKGlucHV0LmF0dGFjaG1lbnRzKTtcblxuICAgIGNvbnN0IHNlc3Npb25JZCA9IHJhbmRvbVVVSUQoKTtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgY29uc3QgcHJvdmVuYW5jZSA9IHByb3ZlbmFuY2VMZWRnZXIucmVjb3JkKCdjcnlzdGFsJywgJ3Nlc3Npb24tY3JlYXRlZCcsIHtcbiAgICAgIHNlc3Npb25JZCxcbiAgICAgIHdvcmt0cmVlSWQ6IHdvcmt0cmVlLmlkLFxuICAgICAgcHJvamVjdFBhdGg6IGlucHV0LnByb2plY3RQYXRoLFxuICAgICAgYWdlbnRzOiBhZ2VudHMubWFwKChhZ2VudCkgPT4gYWdlbnQuYWRhcHRlcktleSksXG4gICAgfSk7XG5cbiAgICBjb25zdCBzZXNzaW9uOiBDcnlzdGFsU2Vzc2lvbiA9IHtcbiAgICAgIGlkOiBzZXNzaW9uSWQsXG4gICAgICBuYW1lOiBpbnB1dC5uYW1lLFxuICAgICAgZGVzY3JpcHRpb246IGlucHV0LmRlc2NyaXB0aW9uLFxuICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcbiAgICAgIHRoZW1lOiBpbnB1dC50aGVtZSB8fCAnbGlnaHQnLFxuICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICB1cGRhdGVkQXQ6IG5vdyxcbiAgICAgIHB1cnBvc2VUYWdzOiBpbnB1dC5wdXJwb3NlVGFncz8ubGVuZ3RoID8gaW5wdXQucHVycG9zZVRhZ3MgOiBbJ2ludmVzdGlnYXRpb24nXSxcbiAgICAgIHJldGVudGlvbjogaW5wdXQucmV0ZW50aW9uIHx8ICdzdGFuZGFyZC0zNjVkJyxcbiAgICAgIHdvcmt0cmVlLFxuICAgICAgcGFuZWxzLFxuICAgICAgYXR0YWNobWVudHMsXG4gICAgICBydW5TY3JpcHRzLFxuICAgICAgcnVuczogW10sXG4gICAgICBhZ2VudHMsXG4gICAgICBtZXNzYWdlczogW10sXG4gICAgICBwcm92ZW5hbmNlSWQ6IHByb3ZlbmFuY2UuaWQsXG4gICAgICBzbG86IHRoaXMuZGVwcy5tZXRyaWNzLmdldFNMT1NuYXBzaG90KCksXG4gICAgICBjb3N0OiB0aGlzLmRlcHMubWV0cmljcy5nZXRDb3N0U25hcHNob3QoKSxcbiAgICB9O1xuXG4gICAgdGhpcy5zZXNzaW9ucy5zZXQoc2Vzc2lvbklkLCBzZXNzaW9uKTtcbiAgICB0aGlzLmRlcHMubWV0cmljcy5yZWNvcmRDb3N0KCdkZXYnLCAyNSk7XG4gICAgdGhpcy5kZXBzLm1ldHJpY3Mub2JzZXJ2ZUdhdGV3YXkoJ3dyaXRlJywgMTIwKTtcblxuICAgIHJldHVybiBjbG9uZShzZXNzaW9uKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0UnVuKGlucHV0OiBTdGFydFJ1bklucHV0KTogUHJvbWlzZTxSdW5FeGVjdXRpb24+IHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5yZXF1aXJlU2Vzc2lvbihpbnB1dC5zZXNzaW9uSWQpO1xuICAgIGNvbnN0IGRlZmluaXRpb24gPSBzZXNzaW9uLnJ1blNjcmlwdHMuZmluZCgoc2NyaXB0KSA9PiBzY3JpcHQuaWQgPT09IGlucHV0LnJ1bkRlZmluaXRpb25JZCk7XG4gICAgaWYgKCFkZWZpbml0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gcnVuIHNjcmlwdCAke2lucHV0LnJ1bkRlZmluaXRpb25JZH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb21tYW5kID0gaW5wdXQub3ZlcnJpZGVzPy5jb21tYW5kIHx8IGRlZmluaXRpb24uY29tbWFuZDtcbiAgICBjb25zdCBlbnZpcm9ubWVudCA9IHtcbiAgICAgIC4uLmRlZmluaXRpb24uZW52aXJvbm1lbnQsXG4gICAgICAuLi5pbnB1dC5vdmVycmlkZXM/LmVudmlyb25tZW50LFxuICAgIH07XG4gICAgY29uc3QgdGltZW91dE1zID0gaW5wdXQub3ZlcnJpZGVzPy50aW1lb3V0TXMgPz8gZGVmaW5pdGlvbi50aW1lb3V0TXMgPz8gNSAqIDYwICogMTAwMDtcblxuICAgIGNvbnN0IHJ1bklkID0gcmFuZG9tVVVJRCgpO1xuICAgIGNvbnN0IHN0YXJ0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICBjb25zdCBwcm92ZW5hbmNlID0gcHJvdmVuYW5jZUxlZGdlci5yZWNvcmQoJ2NyeXN0YWwnLCAncnVuLXN0YXJ0ZWQnLCB7XG4gICAgICBzZXNzaW9uSWQ6IHNlc3Npb24uaWQsXG4gICAgICBydW5JZCxcbiAgICAgIGNvbW1hbmQsXG4gICAgICBlbnZpcm9ubWVudCxcbiAgICAgIHRpbWVvdXRNcyxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJ1bjogUnVuRXhlY3V0aW9uID0ge1xuICAgICAgaWQ6IHJ1bklkLFxuICAgICAgZGVmaW5pdGlvbklkOiBkZWZpbml0aW9uLmlkLFxuICAgICAgc3RhdHVzOiAncnVubmluZycsXG4gICAgICBzdGFydGVkQXQsXG4gICAgICBwcm92ZW5hbmNlSWQ6IHByb3ZlbmFuY2UuaWQsXG4gICAgICBsb2dzOiBbXSxcbiAgICB9O1xuXG4gICAgc2Vzc2lvbi5ydW5zID0gW3J1biwgLi4uc2Vzc2lvbi5ydW5zXTtcbiAgICB0aGlzLnRvdWNoKHNlc3Npb24pO1xuXG4gICAgY29uc3QgZW1pdHRlciA9IHRoaXMuZ2V0RW1pdHRlcihzZXNzaW9uLmlkLCBydW4uaWQpO1xuICAgIGNvbnN0IHB1c2hMb2cgPSAoc3RyZWFtOiBSdW5Mb2dFbnRyeVsnc3RyZWFtJ10sIG1lc3NhZ2U6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgZW50cnk6IFJ1bkxvZ0VudHJ5ID0ge1xuICAgICAgICBpZDogcmFuZG9tVVVJRCgpLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgc3RyZWFtLFxuICAgICAgICBtZXNzYWdlLFxuICAgICAgfTtcbiAgICAgIHJ1bi5sb2dzLnB1c2goZW50cnkpO1xuICAgICAgZW1pdHRlci5lbWl0TG9nKHsgc2Vzc2lvbklkOiBzZXNzaW9uLmlkLCBydW5JZDogcnVuLmlkLCBlbnRyeSB9KTtcbiAgICB9O1xuXG4gICAgcHVzaExvZygnc3lzdGVtJywgYFJ1bm5pbmcgJHtjb21tYW5kfWApO1xuICAgIGNvbnN0IHBoYXNlcyA9IGNvbW1hbmQuc3BsaXQoJyYmJykubWFwKChzZWdtZW50KSA9PiBzZWdtZW50LnRyaW0oKSk7XG4gICAgZm9yIChjb25zdCBwaGFzZSBvZiBwaGFzZXMpIHtcbiAgICAgIHB1c2hMb2coJ3N0ZG91dCcsIGAkICR7cGhhc2V9YCk7XG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAwKSk7XG4gICAgfVxuXG4gICAgcHVzaExvZygnc3Rkb3V0JywgJ0V4ZWN1dGlvbiBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuICAgIHJ1bi5zdGF0dXMgPSAnc3VjY2VlZGVkJztcbiAgICBydW4uZXhpdENvZGUgPSAwO1xuICAgIHJ1bi5jb21wbGV0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICB0aGlzLnRvdWNoKHNlc3Npb24pO1xuXG4gICAgdGhpcy5kZXBzLm1ldHJpY3Mub2JzZXJ2ZUdhdGV3YXkoJ3JlYWQnLCAxODApO1xuICAgIHRoaXMuZGVwcy5tZXRyaWNzLm9ic2VydmVHcmFwaCgyLCAyNDApO1xuICAgIHRoaXMuZGVwcy5tZXRyaWNzLnJlY29yZENvc3QoJ2RldicsIDUpO1xuXG4gICAgcHJvdmVuYW5jZUxlZGdlci5yZWNvcmQoJ2NyeXN0YWwnLCAncnVuLWNvbXBsZXRlZCcsIHtcbiAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5pZCxcbiAgICAgIHJ1bklkOiBydW4uaWQsXG4gICAgICBleGl0Q29kZTogcnVuLmV4aXRDb2RlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNsb25lKHJ1bik7XG4gIH1cblxuICBhc3luYyByZWNvcmRNZXNzYWdlKGlucHV0OiBSZWNvcmRNZXNzYWdlSW5wdXQpOiBQcm9taXNlPEFzc2lzdGFudE1lc3NhZ2U+IHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5yZXF1aXJlU2Vzc2lvbihpbnB1dC5zZXNzaW9uSWQpO1xuICAgIGNvbnN0IGFnZW50ID0gc2Vzc2lvbi5hZ2VudHMuZmluZCgoY2FuZGlkYXRlKSA9PiBjYW5kaWRhdGUuaWQgPT09IGlucHV0LmFnZW50SWQpO1xuICAgIGlmICghYWdlbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBhZ2VudCAke2lucHV0LmFnZW50SWR9YCk7XG4gICAgfVxuICAgIGNvbnN0IGFkYXB0ZXIgPSBhZGFwdGVyUmVnaXN0cnkuZ2V0KGFnZW50LmFkYXB0ZXJLZXkpO1xuXG4gICAgY29uc3Qgcm9sZSA9IGlucHV0LnJvbGUgPT09ICdzeXN0ZW0nID8gJ3N5c3RlbScgOiAndXNlcic7XG4gICAgY29uc3QgdXNlck1lc3NhZ2U6IEFzc2lzdGFudE1lc3NhZ2UgPSB7XG4gICAgICBpZDogcmFuZG9tVVVJRCgpLFxuICAgICAgYWdlbnRJZDogYWdlbnQuaWQsXG4gICAgICByb2xlLFxuICAgICAgY29udGVudDogaW5wdXQuY29udGVudCxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgYXR0YWNobWVudElkczogaW5wdXQuYXR0YWNobWVudElkcyxcbiAgICAgIHJpY2hPdXRwdXQ6IGlucHV0LnJpY2hPdXRwdXQsXG4gICAgfTtcbiAgICBzZXNzaW9uLm1lc3NhZ2VzLnB1c2godXNlck1lc3NhZ2UpO1xuICAgIHByb3ZlbmFuY2VMZWRnZXIucmVjb3JkKCdjcnlzdGFsJywgJ3VzZXItbWVzc2FnZScsIHVzZXJNZXNzYWdlKTtcblxuICAgIGNvbnN0IGFzc2lzdGFudE1lc3NhZ2UgPSBhd2FpdCBhZGFwdGVyLnNlbmRNZXNzYWdlKHtcbiAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5pZCxcbiAgICAgIGFnZW50SWQ6IGFnZW50LmlkLFxuICAgICAgY29udGVudDogaW5wdXQuY29udGVudCxcbiAgICAgIGF0dGFjaG1lbnRzOiBpbnB1dC5hdHRhY2htZW50SWRzLFxuICAgIH0pO1xuICAgIHNlc3Npb24ubWVzc2FnZXMucHVzaChhc3Npc3RhbnRNZXNzYWdlKTtcbiAgICBhZ2VudC5zdGF0dXMgPSAnaWRsZSc7XG4gICAgdGhpcy50b3VjaChzZXNzaW9uKTtcblxuICAgIHRoaXMuZGVwcy5tZXRyaWNzLm9ic2VydmVHYXRld2F5KCdyZWFkJywgMTUwKTtcbiAgICB0aGlzLmRlcHMubWV0cmljcy5yZWNvcmRDb3N0KCdsbG0nLCAxLjIpO1xuXG4gICAgcmV0dXJuIGNsb25lKGFzc2lzdGFudE1lc3NhZ2UpO1xuICB9XG5cbiAgYXN5bmMgc3VtbWFyaXplKHNlc3Npb25JZDogc3RyaW5nLCBhZ2VudElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5yZXF1aXJlU2Vzc2lvbihzZXNzaW9uSWQpO1xuICAgIGNvbnN0IGFnZW50ID0gc2Vzc2lvbi5hZ2VudHMuZmluZCgoY2FuZGlkYXRlKSA9PiBjYW5kaWRhdGUuaWQgPT09IGFnZW50SWQpO1xuICAgIGlmICghYWdlbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBhZ2VudCAke2FnZW50SWR9YCk7XG4gICAgfVxuICAgIGNvbnN0IGFkYXB0ZXIgPSBhZGFwdGVyUmVnaXN0cnkuZ2V0KGFnZW50LmFkYXB0ZXJLZXkpO1xuICAgIHJldHVybiBhZGFwdGVyLnN1bW1hcml6ZVRocmVhZChzZXNzaW9uSWQsIGFnZW50SWQpO1xuICB9XG5cbiAgdXBkYXRlUGFuZWxzKGlucHV0OiBVcGRhdGVQYW5lbHNJbnB1dCk6IENyeXN0YWxTZXNzaW9uIHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5yZXF1aXJlU2Vzc2lvbihpbnB1dC5zZXNzaW9uSWQpO1xuICAgIGNvbnN0IGxheW91dE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBQYW5lbExheW91dD4oXG4gICAgICBpbnB1dC5wYW5lbHMubWFwKChwYW5lbCkgPT4gW3BhbmVsLnBhbmVsSWQsIHBhbmVsLmxheW91dF0pXG4gICAgKTtcbiAgICBzZXNzaW9uLnBhbmVscyA9IHNlc3Npb24ucGFuZWxzLm1hcCgocGFuZWwpID0+XG4gICAgICBsYXlvdXRNYXAuaGFzKHBhbmVsLmlkKVxuICAgICAgICA/IHsgLi4ucGFuZWwsIGxheW91dDogbGF5b3V0TWFwLmdldChwYW5lbC5pZCkhIH1cbiAgICAgICAgOiBwYW5lbFxuICAgICk7XG4gICAgdGhpcy50b3VjaChzZXNzaW9uKTtcbiAgICBwcm92ZW5hbmNlTGVkZ2VyLnJlY29yZCgnY3J5c3RhbCcsICdwYW5lbC1sYXlvdXQtdXBkYXRlZCcsIHtcbiAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5pZCxcbiAgICAgIHBhbmVsczogaW5wdXQucGFuZWxzLFxuICAgIH0pO1xuICAgIHJldHVybiBjbG9uZShzZXNzaW9uKTtcbiAgfVxuXG4gIGFzeW5jIGNsb3NlU2Vzc2lvbihpbnB1dDogQ2xvc2VTZXNzaW9uSW5wdXQpOiBQcm9taXNlPENyeXN0YWxTZXNzaW9uPiB7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucmVxdWlyZVNlc3Npb24oaW5wdXQuc2Vzc2lvbklkKTtcbiAgICBzZXNzaW9uLnN0YXR1cyA9ICdjbG9zaW5nJztcbiAgICB0aGlzLnRvdWNoKHNlc3Npb24pO1xuICAgIGF3YWl0IHRoaXMuZGVwcy53b3JrdHJlZUVuZ2luZS5kZWxldGVRdWV1ZWQoc2Vzc2lvbi53b3JrdHJlZS5pZCk7XG4gICAgc2Vzc2lvbi5zdGF0dXMgPSAnY2xvc2VkJztcbiAgICB0aGlzLnRvdWNoKHNlc3Npb24pO1xuICAgIHByb3ZlbmFuY2VMZWRnZXIucmVjb3JkKCdjcnlzdGFsJywgJ3Nlc3Npb24tY2xvc2VkJywgeyBzZXNzaW9uSWQ6IHNlc3Npb24uaWQgfSk7XG4gICAgcmV0dXJuIGNsb25lKHNlc3Npb24pO1xuICB9XG5cbiAgc3Vic2NyaWJlVG9SdW5Mb2dzKFxuICAgIHNlc3Npb25JZDogc3RyaW5nLFxuICAgIHJ1bklkOiBzdHJpbmcsXG4gICAgbGlzdGVuZXI6IChldmVudDogUnVuTG9nRXZlbnQpID0+IHZvaWRcbiAgKTogKCkgPT4gdm9pZCB7XG4gICAgY29uc3QgZW1pdHRlciA9IHRoaXMuZ2V0RW1pdHRlcihzZXNzaW9uSWQsIHJ1bklkKTtcbiAgICByZXR1cm4gZW1pdHRlci5vbkxvZyhsaXN0ZW5lcik7XG4gIH1cblxuICBwcml2YXRlIGdldEVtaXR0ZXIoc2Vzc2lvbklkOiBzdHJpbmcsIHJ1bklkOiBzdHJpbmcpOiBSdW5Mb2dFbWl0dGVyIHtcbiAgICBjb25zdCBrZXkgPSBgJHtzZXNzaW9uSWR9OiR7cnVuSWR9YDtcbiAgICBpZiAoIXRoaXMucnVuTG9nRW1pdHRlcnMuaGFzKGtleSkpIHtcbiAgICAgIHRoaXMucnVuTG9nRW1pdHRlcnMuc2V0KGtleSwgbmV3IFJ1bkxvZ0VtaXR0ZXIoKSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnJ1bkxvZ0VtaXR0ZXJzLmdldChrZXkpITtcbiAgfVxuXG4gIHByaXZhdGUgcmVxdWlyZVNlc3Npb24oaWQ6IHN0cmluZyk6IENyeXN0YWxTZXNzaW9uIHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9ucy5nZXQoaWQpO1xuICAgIGlmICghc2Vzc2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIHNlc3Npb24gJHtpZH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHNlc3Npb247XG4gIH1cblxuICBwcml2YXRlIHRvdWNoKHNlc3Npb246IENyeXN0YWxTZXNzaW9uKSB7XG4gICAgc2Vzc2lvbi51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgc2Vzc2lvbi5zbG8gPSB0aGlzLmRlcHMubWV0cmljcy5nZXRTTE9TbmFwc2hvdCgpO1xuICAgIHNlc3Npb24uY29zdCA9IHRoaXMuZGVwcy5tZXRyaWNzLmdldENvc3RTbmFwc2hvdCgpO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBjcnlzdGFsT3JjaGVzdHJhdG9yID0gbmV3IENyeXN0YWxTZXNzaW9uT3JjaGVzdHJhdG9yKCk7XG4iXSwidmVyc2lvbiI6M30=