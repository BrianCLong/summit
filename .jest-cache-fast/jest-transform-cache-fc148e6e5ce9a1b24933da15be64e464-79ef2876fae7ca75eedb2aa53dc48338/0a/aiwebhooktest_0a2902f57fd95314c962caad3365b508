ed006bf4cc7a1ae8d4e0b8f8f9d2e8b3
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const supertest_1 = __importDefault(require("supertest"));
const crypto_1 = __importDefault(require("crypto"));
const app_1 = require("../app"); // assumes your express app export
const SECRET = process.env.ML_WEBHOOK_SECRET || "test-secret";
function sign(body) {
    const raw = JSON.stringify(body);
    const h = crypto_1.default.createHmac("sha256", SECRET).update(raw).digest("hex");
    return { raw, sig: h };
}
describe("AI webhook", () => {
    let app;
    beforeAll(async () => {
        app = await (0, app_1.createApp)();
    });
    it("accepts signed webhook and creates insights", async () => {
        const body = {
            job_id: "11111111-1111-1111-1111-111111111111",
            kind: "link_prediction",
            predictions: [{ u: "a", v: "b", score: 3 }]
        };
        const { sig } = sign(body);
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", sig)
            .send(body);
        expect(res.status).toBe(200);
        expect(res.body.ok).toBe(true);
    });
    it("rejects webhook with invalid signature", async () => {
        const body = {
            job_id: "22222222-2222-2222-2222-222222222222",
            kind: "nlp_entities",
            results: []
        };
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", "invalid-signature")
            .send(body);
        expect(res.status).toBe(401);
        expect(res.body.error).toBe("invalid signature");
    });
    it("handles entity resolution webhook", async () => {
        const body = {
            job_id: "33333333-3333-3333-3333-333333333333",
            kind: "entity_resolution",
            links: [["entity1", "entity2", 0.95]]
        };
        const { sig } = sign(body);
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", sig)
            .send(body);
        expect(res.status).toBe(200);
    });
    it("handles community detection webhook", async () => {
        const body = {
            job_id: "44444444-4444-4444-4444-444444444444",
            kind: "community_detect",
            communities: [
                { community_id: "c1", members: ["node1", "node2", "node3"] },
                { community_id: "c2", members: ["node4", "node5"] }
            ]
        };
        const { sig } = sign(body);
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", sig)
            .send(body);
        expect(res.status).toBe(200);
    });
    it("handles NLP entities webhook", async () => {
        const body = {
            job_id: "55555555-5555-5555-5555-555555555555",
            kind: "nlp_entities",
            results: [
                {
                    doc_id: "doc1",
                    entities: [
                        { text: "John Doe", label: "PERSON", confidence: 0.95 },
                        { text: "New York", label: "GPE", confidence: 0.89 }
                    ]
                }
            ]
        };
        const { sig } = sign(body);
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", sig)
            .send(body);
        expect(res.status).toBe(200);
    });
    it("handles malformed webhook gracefully", async () => {
        const body = { invalid: "data" };
        const { sig } = sign(body);
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", sig)
            .send(body);
        // Should still return 200 but handle the malformed data gracefully
        expect(res.status).toBe(200);
    });
    it("verifies timing-safe signature comparison", async () => {
        const body = { job_id: "test", kind: "test", results: [] };
        const validSig = crypto_1.default.createHmac("sha256", SECRET).update(JSON.stringify(body)).digest("hex");
        const almostValidSig = validSig.slice(0, -1) + "x"; // Change last char
        const res = await (0, supertest_1.default)(app)
            .post("/ai/webhook")
            .set("X-IntelGraph-Signature", almostValidSig)
            .send(body);
        expect(res.status).toBe(401);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvdGVzdHMvYWkud2ViaG9vay50ZXN0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMERBQWdDO0FBQ2hDLG9EQUE0QjtBQUM1QixnQ0FBbUMsQ0FBQyxrQ0FBa0M7QUFFdEUsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxhQUFhLENBQUM7QUFFOUQsU0FBUyxJQUFJLENBQUMsSUFBUztJQUNyQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLE1BQU0sQ0FBQyxHQUFHLGdCQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3hFLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO0FBQ3pCLENBQUM7QUFFRCxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtJQUMxQixJQUFJLEdBQUcsQ0FBQztJQUVSLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixHQUFHLEdBQUcsTUFBTSxJQUFBLGVBQVMsR0FBRSxDQUFDO0lBQzFCLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDZDQUE2QyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzNELE1BQU0sSUFBSSxHQUFHO1lBQ1gsTUFBTSxFQUFFLHNDQUFzQztZQUM5QyxJQUFJLEVBQUUsaUJBQWlCO1lBQ3ZCLFdBQVcsRUFBRSxDQUFDLEVBQUMsQ0FBQyxFQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUMsR0FBRyxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQUMsQ0FBQztTQUN2QyxDQUFDO1FBQ0YsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQixNQUFNLEdBQUcs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LENBQUMsQ0FBQztRQUNkLG1FQUFtRTtRQUNuRSxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQywyQ0FBMkMsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN6RCxNQUFNLElBQUksR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDM0QsTUFBTSxRQUFRLEdBQUcsZ0JBQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hHLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsbUJBQW1CO1FBRXZFLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQzthQUMzQixJQUFJLENBQUMsYUFBYSxDQUFDO2FBQ25CLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxjQUFjLENBQUM7YUFDN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvYnJpYW5sb25nL0RldmVsb3Blci9zdW1taXQvc2VydmVyL3NyYy90ZXN0cy9haS53ZWJob29rLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSBcInN1cGVydGVzdFwiO1xuaW1wb3J0IGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQgeyBjcmVhdGVBcHAgfSBmcm9tIFwiLi4vYXBwXCI7IC8vIGFzc3VtZXMgeW91ciBleHByZXNzIGFwcCBleHBvcnRcblxuY29uc3QgU0VDUkVUID0gcHJvY2Vzcy5lbnYuTUxfV0VCSE9PS19TRUNSRVQgfHwgXCJ0ZXN0LXNlY3JldFwiO1xuXG5mdW5jdGlvbiBzaWduKGJvZHk6IGFueSl7XG4gIGNvbnN0IHJhdyA9IEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuICBjb25zdCBoID0gY3J5cHRvLmNyZWF0ZUhtYWMoXCJzaGEyNTZcIiwgU0VDUkVUKS51cGRhdGUocmF3KS5kaWdlc3QoXCJoZXhcIik7XG4gIHJldHVybiB7IHJhdywgc2lnOiBoIH07XG59XG5cbmRlc2NyaWJlKFwiQUkgd2ViaG9va1wiLCAoKSA9PiB7XG4gIGxldCBhcHA7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBhcHAgPSBhd2FpdCBjcmVhdGVBcHAoKTtcbiAgfSk7XG5cbiAgaXQoXCJhY2NlcHRzIHNpZ25lZCB3ZWJob29rIGFuZCBjcmVhdGVzIGluc2lnaHRzXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBib2R5ID0geyBcbiAgICAgIGpvYl9pZDogXCIxMTExMTExMS0xMTExLTExMTEtMTExMS0xMTExMTExMTExMTFcIiwgXG4gICAgICBraW5kOiBcImxpbmtfcHJlZGljdGlvblwiLCBcbiAgICAgIHByZWRpY3Rpb25zOiBbe3U6XCJhXCIsIHY6XCJiXCIsIHNjb3JlOjN9XSBcbiAgICB9O1xuICAgIGNvbnN0IHsgc2lnIH0gPSBzaWduKGJvZHkpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgLnBvc3QoXCIvYWkvd2ViaG9va1wiKVxuICAgICAgLnNldChcIlgtSW50ZWxHcmFwaC1TaWduYXR1cmVcIiwgc2lnKVxuICAgICAgLnNlbmQoYm9keSk7XG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICBleHBlY3QocmVzLmJvZHkub2spLnRvQmUodHJ1ZSk7XG4gIH0pO1xuXG4gIGl0KFwicmVqZWN0cyB3ZWJob29rIHdpdGggaW52YWxpZCBzaWduYXR1cmVcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGJvZHkgPSB7IFxuICAgICAgam9iX2lkOiBcIjIyMjIyMjIyLTIyMjItMjIyMi0yMjIyLTIyMjIyMjIyMjIyMlwiLCBcbiAgICAgIGtpbmQ6IFwibmxwX2VudGl0aWVzXCIsIFxuICAgICAgcmVzdWx0czogW10gXG4gICAgfTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgIC5wb3N0KFwiL2FpL3dlYmhvb2tcIilcbiAgICAgIC5zZXQoXCJYLUludGVsR3JhcGgtU2lnbmF0dXJlXCIsIFwiaW52YWxpZC1zaWduYXR1cmVcIilcbiAgICAgIC5zZW5kKGJvZHkpO1xuICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDQwMSk7XG4gICAgZXhwZWN0KHJlcy5ib2R5LmVycm9yKS50b0JlKFwiaW52YWxpZCBzaWduYXR1cmVcIik7XG4gIH0pO1xuXG4gIGl0KFwiaGFuZGxlcyBlbnRpdHkgcmVzb2x1dGlvbiB3ZWJob29rXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBib2R5ID0geyBcbiAgICAgIGpvYl9pZDogXCIzMzMzMzMzMy0zMzMzLTMzMzMtMzMzMy0zMzMzMzMzMzMzMzNcIiwgXG4gICAgICBraW5kOiBcImVudGl0eV9yZXNvbHV0aW9uXCIsIFxuICAgICAgbGlua3M6IFtbXCJlbnRpdHkxXCIsIFwiZW50aXR5MlwiLCAwLjk1XV0gXG4gICAgfTtcbiAgICBjb25zdCB7IHNpZyB9ID0gc2lnbihib2R5KTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgIC5wb3N0KFwiL2FpL3dlYmhvb2tcIilcbiAgICAgIC5zZXQoXCJYLUludGVsR3JhcGgtU2lnbmF0dXJlXCIsIHNpZylcbiAgICAgIC5zZW5kKGJvZHkpO1xuICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMCk7XG4gIH0pO1xuXG4gIGl0KFwiaGFuZGxlcyBjb21tdW5pdHkgZGV0ZWN0aW9uIHdlYmhvb2tcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGJvZHkgPSB7IFxuICAgICAgam9iX2lkOiBcIjQ0NDQ0NDQ0LTQ0NDQtNDQ0NC00NDQ0LTQ0NDQ0NDQ0NDQ0NFwiLCBcbiAgICAgIGtpbmQ6IFwiY29tbXVuaXR5X2RldGVjdFwiLCBcbiAgICAgIGNvbW11bml0aWVzOiBbXG4gICAgICAgIHsgY29tbXVuaXR5X2lkOiBcImMxXCIsIG1lbWJlcnM6IFtcIm5vZGUxXCIsIFwibm9kZTJcIiwgXCJub2RlM1wiXSB9LFxuICAgICAgICB7IGNvbW11bml0eV9pZDogXCJjMlwiLCBtZW1iZXJzOiBbXCJub2RlNFwiLCBcIm5vZGU1XCJdIH1cbiAgICAgIF1cbiAgICB9O1xuICAgIGNvbnN0IHsgc2lnIH0gPSBzaWduKGJvZHkpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgLnBvc3QoXCIvYWkvd2ViaG9va1wiKVxuICAgICAgLnNldChcIlgtSW50ZWxHcmFwaC1TaWduYXR1cmVcIiwgc2lnKVxuICAgICAgLnNlbmQoYm9keSk7XG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgfSk7XG5cbiAgaXQoXCJoYW5kbGVzIE5MUCBlbnRpdGllcyB3ZWJob29rXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBib2R5ID0geyBcbiAgICAgIGpvYl9pZDogXCI1NTU1NTU1NS01NTU1LTU1NTUtNTU1NS01NTU1NTU1NTU1NTVcIiwgXG4gICAgICBraW5kOiBcIm5scF9lbnRpdGllc1wiLCBcbiAgICAgIHJlc3VsdHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIGRvY19pZDogXCJkb2MxXCIsXG4gICAgICAgICAgZW50aXRpZXM6IFtcbiAgICAgICAgICAgIHsgdGV4dDogXCJKb2huIERvZVwiLCBsYWJlbDogXCJQRVJTT05cIiwgY29uZmlkZW5jZTogMC45NSB9LFxuICAgICAgICAgICAgeyB0ZXh0OiBcIk5ldyBZb3JrXCIsIGxhYmVsOiBcIkdQRVwiLCBjb25maWRlbmNlOiAwLjg5IH1cbiAgICAgICAgICBdXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9O1xuICAgIGNvbnN0IHsgc2lnIH0gPSBzaWduKGJvZHkpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgLnBvc3QoXCIvYWkvd2ViaG9va1wiKVxuICAgICAgLnNldChcIlgtSW50ZWxHcmFwaC1TaWduYXR1cmVcIiwgc2lnKVxuICAgICAgLnNlbmQoYm9keSk7XG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgfSk7XG5cbiAgaXQoXCJoYW5kbGVzIG1hbGZvcm1lZCB3ZWJob29rIGdyYWNlZnVsbHlcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGJvZHkgPSB7IGludmFsaWQ6IFwiZGF0YVwiIH07XG4gICAgY29uc3QgeyBzaWcgfSA9IHNpZ24oYm9keSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAucG9zdChcIi9haS93ZWJob29rXCIpXG4gICAgICAuc2V0KFwiWC1JbnRlbEdyYXBoLVNpZ25hdHVyZVwiLCBzaWcpXG4gICAgICAuc2VuZChib2R5KTtcbiAgICAvLyBTaG91bGQgc3RpbGwgcmV0dXJuIDIwMCBidXQgaGFuZGxlIHRoZSBtYWxmb3JtZWQgZGF0YSBncmFjZWZ1bGx5XG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgfSk7XG5cbiAgaXQoXCJ2ZXJpZmllcyB0aW1pbmctc2FmZSBzaWduYXR1cmUgY29tcGFyaXNvblwiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgYm9keSA9IHsgam9iX2lkOiBcInRlc3RcIiwga2luZDogXCJ0ZXN0XCIsIHJlc3VsdHM6IFtdIH07XG4gICAgY29uc3QgdmFsaWRTaWcgPSBjcnlwdG8uY3JlYXRlSG1hYyhcInNoYTI1NlwiLCBTRUNSRVQpLnVwZGF0ZShKU09OLnN0cmluZ2lmeShib2R5KSkuZGlnZXN0KFwiaGV4XCIpO1xuICAgIGNvbnN0IGFsbW9zdFZhbGlkU2lnID0gdmFsaWRTaWcuc2xpY2UoMCwgLTEpICsgXCJ4XCI7IC8vIENoYW5nZSBsYXN0IGNoYXJcbiAgICBcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgIC5wb3N0KFwiL2FpL3dlYmhvb2tcIilcbiAgICAgIC5zZXQoXCJYLUludGVsR3JhcGgtU2lnbmF0dXJlXCIsIGFsbW9zdFZhbGlkU2lnKVxuICAgICAgLnNlbmQoYm9keSk7XG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoNDAxKTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=