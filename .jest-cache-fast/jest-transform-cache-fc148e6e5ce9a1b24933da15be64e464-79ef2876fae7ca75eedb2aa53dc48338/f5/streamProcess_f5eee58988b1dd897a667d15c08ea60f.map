{"file":"/Users/brianlong/Developer/summit/server/src/conductor/steps/streamProcess.ts","mappings":";;AAIA,sCAaC;AAjBD,2BAA0B;AAE1B,MAAM,EAAE,GAAG,IAAI,SAAI,CAAC,EAAE,gBAAgB,EAAE,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC,CAAC;AAE7D,KAAK,UAAU,aAAa,CAAC,GAAQ,EAAE,IAAS,EAAE,GAA6C;IACpG,MAAM,KAAK,GAAG,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE,CAAC;IACrD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK,CAAC,OAAO,EAAE,CAAC;IACzC,IAAI,IAAI,CAAC,SAAS,EAAE,WAAW,IAAI,GAAG,GAAG,gBAAgB,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,EAAE,CAAC;QACtF,MAAM,EAAE,CAAC,KAAK,CACZ;0EACoE,EACpE,CAAC,GAAG,CAAC,EAAE,EAAE,IAAI,CAAC,EAAE,EAAE,KAAK,EAAE,GAAG,CAAC,CAC9B,CAAC;QACF,OAAO,CAAC,OAAO;IACjB,CAAC;IACD,MAAM,GAAG,GAAG,EAAE,GAAG,CAAC,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,IAAI,IAAI,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,IAAI,EAAE,CAAC,EAAE,IAAI,EAAE,GAAG,CAAC,GAAG,EAAE,CAAC;IACpH,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC;AAC/B,CAAC;AAED,SAAS,gBAAgB,CAAC,CAAS;IACjC,MAAM,CAAC,GAAG,iBAAiB,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC;IAC1C,MAAM,CAAC,GAAG,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;IAC9B,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC;IACxB,OAAO,CAAC,GAAG,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC;AAChF,CAAC","names":[],"sources":["/Users/brianlong/Developer/summit/server/src/conductor/steps/streamProcess.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pg = new Pool({ connectionString: process.env.DATABASE_URL });\n\nexport async function streamProcess(ctx: any, step: any, msg: { key: string; value: any; ts?: string }) {\n  const srcTs = msg.ts ? new Date(msg.ts) : new Date();\n  const age = Date.now() - srcTs.getTime();\n  if (step.freshness?.freshWithin && age > parseISODuration(step.freshness.freshWithin)) {\n    await pg.query(\n      `INSERT INTO data_freshness(run_id,step_id,source_ts,age_ms) VALUES ($1,$2,$3,$4)\n       ON CONFLICT (run_id,step_id) DO UPDATE SET source_ts=$3, age_ms=$4`,\n      [ctx.id, step.id, srcTs, age],\n    );\n    return; // gate\n  }\n  const out = { ...(typeof msg.value === 'string' ? JSON.parse(msg.value || '{}') : msg.value || {}), _key: msg.key };\n  ctx.setOutputs(step.id, out);\n}\n\nfunction parseISODuration(s: string) {\n  const m = /^(\\d+)([smhd])$/.exec(s || '');\n  const n = Number(m?.[1] || 0);\n  const u = m?.[2] || 's';\n  return n * (u === 's' ? 1 : u === 'm' ? 60 : u === 'h' ? 3600 : 86400) * 1000;\n}\n\n"],"version":3}