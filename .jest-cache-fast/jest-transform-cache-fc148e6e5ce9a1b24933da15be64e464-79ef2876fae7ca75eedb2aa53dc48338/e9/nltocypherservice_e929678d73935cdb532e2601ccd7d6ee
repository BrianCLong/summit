3d2e9e434dce2e3ef32e8dcba4b88584
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NlToCypherService = void 0;
const crypto_1 = require("crypto");
const pino_1 = __importDefault(require("pino"));
const logger = (0, pino_1.default)({ name: 'nl-to-cypher' });
class NlToCypherService {
    adapter;
    promptCache = new Map();
    executionHistory = [];
    constructor(adapter) {
        this.adapter = adapter;
    }
    async translateWithPreview(prompt, userId, tenantId) {
        const startTime = Date.now();
        const queryId = (0, crypto_1.randomUUID)();
        // Check cache first
        const cacheKey = `${tenantId}:${prompt.trim().toLowerCase()}`;
        if (this.promptCache.has(cacheKey)) {
            logger.info({ queryId, userId, tenantId, cached: true }, 'Returning cached NL→Cypher translation');
            return this.promptCache.get(cacheKey);
        }
        try {
            // Generate Cypher
            const generatedCypher = await this.generateCypher(prompt);
            // Validate syntax
            const validation = this.validateCypher(generatedCypher);
            // Estimate cost
            const costEstimate = this.estimateCost(generatedCypher);
            // Assess policy risk
            const policyRisk = this.assessPolicyRisk(generatedCypher, userId, tenantId);
            const response = {
                id: queryId,
                originalPrompt: prompt,
                generatedCypher,
                validation,
                costEstimate,
                policyRisk,
                canExecute: validation.isValid && costEstimate.costClass !== 'very-high' && policyRisk.riskLevel !== 'high',
                timestamp: new Date()
            };
            // Cache the response
            this.promptCache.set(cacheKey, response);
            // Emit metrics
            const parseTime = Date.now() - startTime;
            logger.info({
                queryId,
                userId,
                tenantId,
                parseTimeMs: parseTime,
                validity: validation.isValid,
                estimatedRows: costEstimate.estimatedRows,
                costClass: costEstimate.costClass,
                riskLevel: policyRisk.riskLevel
            }, 'NL→Cypher translation completed');
            return response;
        }
        catch (error) {
            logger.error({ queryId, userId, tenantId, error }, 'NL→Cypher translation failed');
            throw error;
        }
    }
    async executeSandbox(queryId, cypher, options = {
        readOnly: true,
        timeout: 30000,
        maxRows: 100
    }) {
        const startTime = Date.now();
        try {
            // Validate the query is safe for sandbox
            if (!options.readOnly && this.containsMutations(cypher)) {
                return {
                    success: false,
                    executionTimeMs: 0,
                    error: 'Mutations not allowed in sandbox mode',
                    warnings: []
                };
            }
            // Add LIMIT clause if not present
            const safeCypher = this.makeSafe(cypher, options.maxRows);
            if (options.dryRun) {
                return {
                    success: true,
                    executionTimeMs: Date.now() - startTime,
                    warnings: [`Dry run - would execute: ${safeCypher}`]
                };
            }
            // TODO: Integrate with actual Neo4j sandbox connection
            // For now, simulate execution
            const mockRows = this.simulateExecution(safeCypher);
            const executionTime = Date.now() - startTime;
            // Record execution history for cost estimation improvements
            this.executionHistory.push({
                queryId,
                executionTime,
                rowCount: mockRows.length
            });
            logger.info({
                queryId,
                executionTimeMs: executionTime,
                rowCount: mockRows.length,
                safeCypher
            }, 'Sandbox execution completed');
            return {
                success: true,
                rows: mockRows,
                executionTimeMs: executionTime,
                warnings: []
            };
        }
        catch (error) {
            logger.error({ queryId, error }, 'Sandbox execution failed');
            return {
                success: false,
                executionTimeMs: Date.now() - startTime,
                error: error instanceof Error ? error.message : 'Unknown execution error',
                warnings: []
            };
        }
    }
    async generateCypher(prompt) {
        // Enhanced pattern matching for common queries
        if (/show all nodes/i.test(prompt)) {
            return 'MATCH (n) RETURN n LIMIT 25';
        }
        if (/count nodes/i.test(prompt)) {
            return 'MATCH (n) RETURN count(n) AS count';
        }
        if (/find.*connected.*to/i.test(prompt)) {
            return 'MATCH (a)-[r]-(b) WHERE a.name = $name RETURN a, r, b LIMIT 50';
        }
        if (/shortest.*path/i.test(prompt)) {
            return 'MATCH p = shortestPath((a)-[*..5]-(b)) WHERE a.id = $startId AND b.id = $endId RETURN p';
        }
        if (/neighbors.*of/i.test(prompt)) {
            return 'MATCH (n)-[r]-(neighbor) WHERE n.id = $nodeId RETURN neighbor, r LIMIT 100';
        }
        // Fallback to model adapter
        return this.adapter.generate(prompt);
    }
    validateCypher(cypher) {
        const errors = [];
        const warnings = [];
        // Basic syntax validation
        if (!cypher.trim()) {
            errors.push('Empty query');
        }
        if (!cypher.toUpperCase().includes('MATCH') && !cypher.toUpperCase().includes('CREATE')) {
            warnings.push('Query does not contain MATCH or CREATE clause');
        }
        // Check for potential issues
        if (!cypher.toUpperCase().includes('LIMIT') && cypher.toUpperCase().includes('MATCH')) {
            warnings.push('No LIMIT clause found - query may return large result sets');
        }
        if (cypher.includes('*') && cypher.includes('[') && cypher.includes(']')) {
            warnings.push('Variable length path detected - may be expensive');
        }
        // Check for dangerous operations
        const dangerousOps = ['DELETE', 'DETACH DELETE', 'DROP', 'REMOVE'];
        for (const op of dangerousOps) {
            if (cypher.toUpperCase().includes(op)) {
                errors.push(`Dangerous operation detected: ${op}`);
            }
        }
        return {
            isValid: errors.length === 0,
            syntaxErrors: errors,
            warnings
        };
    }
    estimateCost(cypher) {
        let estimatedRows = 100;
        let costClass = 'low';
        let executionTimeMs = 50;
        let memoryMb = 10;
        const upperCypher = cypher.toUpperCase();
        // Analyze query complexity
        if (upperCypher.includes('*')) {
            estimatedRows *= 10;
            costClass = 'high';
            executionTimeMs *= 20;
            memoryMb *= 5;
        }
        if (upperCypher.includes('SHORTESTPATH')) {
            estimatedRows *= 2;
            costClass = costClass === 'high' ? 'very-high' : 'medium';
            executionTimeMs *= 5;
            memoryMb *= 2;
        }
        // Check for cartesian products
        const matchCount = (cypher.match(/MATCH/gi) || []).length;
        if (matchCount > 1 && !upperCypher.includes('WHERE')) {
            estimatedRows *= Math.pow(10, matchCount - 1);
            costClass = 'very-high';
            executionTimeMs *= 50;
            memoryMb *= 10;
        }
        // Use historical data if available
        const avgHistory = this.getAverageExecutionTime(cypher);
        if (avgHistory) {
            executionTimeMs = Math.max(executionTimeMs, avgHistory);
        }
        return {
            estimatedRows,
            costClass,
            executionTimeMs,
            memoryMb
        };
    }
    assessPolicyRisk(cypher, userId, tenantId) {
        const risks = [];
        let riskLevel = 'low';
        let piiAccess = false;
        const sensitiveOperations = [];
        const upperCypher = cypher.toUpperCase();
        // Check for PII access patterns
        const piiFields = ['EMAIL', 'PHONE', 'SSN', 'ADDRESS', 'NAME'];
        for (const field of piiFields) {
            if (upperCypher.includes(field)) {
                piiAccess = true;
                risks.push(`Query accesses potentially sensitive field: ${field}`);
                riskLevel = 'medium';
            }
        }
        // Check for broad data access
        if (!upperCypher.includes('WHERE') && upperCypher.includes('MATCH')) {
            risks.push('Query lacks WHERE clause - may access all data');
            riskLevel = 'medium';
        }
        // Check for mutation operations
        const mutations = ['CREATE', 'DELETE', 'SET', 'REMOVE', 'MERGE'];
        for (const mutation of mutations) {
            if (upperCypher.includes(mutation)) {
                sensitiveOperations.push(mutation);
                risks.push(`Query contains mutation operation: ${mutation}`);
                riskLevel = 'high';
            }
        }
        return {
            riskLevel,
            risks,
            piiAccess,
            sensitiveOperations
        };
    }
    containsMutations(cypher) {
        const mutations = ['CREATE', 'DELETE', 'SET', 'REMOVE', 'MERGE', 'DROP'];
        const upperCypher = cypher.toUpperCase();
        return mutations.some(op => upperCypher.includes(op));
    }
    makeSafe(cypher, maxRows) {
        let safeCypher = cypher.trim();
        // Add LIMIT if not present
        if (!safeCypher.toUpperCase().includes('LIMIT')) {
            safeCypher += ` LIMIT ${maxRows}`;
        }
        return safeCypher;
    }
    simulateExecution(cypher) {
        // Mock execution for demo purposes
        const mockData = [
            { id: '1', name: 'Node 1', type: 'Person' },
            { id: '2', name: 'Node 2', type: 'Organization' },
            { id: '3', name: 'Node 3', type: 'Event' }
        ];
        // Return subset based on query type
        if (cypher.toUpperCase().includes('COUNT')) {
            return [{ count: mockData.length }];
        }
        return mockData.slice(0, Math.min(3, 100));
    }
    getAverageExecutionTime(cypher) {
        // Simple pattern matching for historical data
        const similarQueries = this.executionHistory.filter(h => {
            // This is a simplified similarity check
            return cypher.includes('MATCH') && cypher.includes('RETURN');
        });
        if (similarQueries.length === 0)
            return null;
        const avgTime = similarQueries.reduce((sum, q) => sum + q.executionTime, 0) / similarQueries.length;
        return avgTime;
    }
    // Method for computing diff between generated and user-edited Cypher
    diffCypher(original, edited) {
        // Simple diff implementation
        const originalLines = original.split('\n').map(l => l.trim());
        const editedLines = edited.split('\n').map(l => l.trim());
        const additions = [];
        const deletions = [];
        const modifications = [];
        // Basic line-by-line comparison
        editedLines.forEach(line => {
            if (!originalLines.includes(line)) {
                additions.push(line);
            }
        });
        originalLines.forEach(line => {
            if (!editedLines.includes(line)) {
                deletions.push(line);
            }
        });
        return { additions, deletions, modifications };
    }
    // Cleanup method for cache management
    clearCache() {
        this.promptCache.clear();
        logger.info('NL→Cypher cache cleared');
    }
    // Legacy method for backward compatibility
    async translate(prompt) {
        const result = await this.translateWithPreview(prompt, 'system', 'default');
        return result.generatedCypher;
    }
}
exports.NlToCypherService = NlToCypherService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvYWkvbmwtdG8tY3lwaGVyL25sLXRvLWN5cGhlci5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLG1DQUE4QztBQUM5QyxnREFBd0I7QUFFeEIsTUFBTSxNQUFNLEdBQUcsSUFBQSxjQUFJLEVBQUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztBQWdEOUMsTUFBYSxpQkFBaUI7SUFJQztJQUhaLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBOEIsQ0FBQztJQUNwRCxnQkFBZ0IsR0FBd0UsRUFBRSxDQUFDO0lBRTVHLFlBQTZCLE9BQXFCO1FBQXJCLFlBQU8sR0FBUCxPQUFPLENBQWM7SUFBRyxDQUFDO0lBRXRELEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxNQUFjLEVBQUUsTUFBYyxFQUFFLFFBQWdCO1FBQ3pFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixNQUFNLE9BQU8sR0FBRyxJQUFBLG1CQUFNLEdBQUUsQ0FBQztRQUV6QixvQkFBb0I7UUFDcEIsTUFBTSxRQUFRLEdBQUcsR0FBRyxRQUFRLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7UUFDOUQsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQ25DLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUUsd0NBQXdDLENBQUMsQ0FBQztZQUNuRyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBRSxDQUFDO1FBQ3pDLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDSCxrQkFBa0I7WUFDbEIsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FB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QUNGO0FBaFhELDhDQWdYQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvYnJpYW5sb25nL0RldmVsb3Blci9zdW1taXQvc2VydmVyL3NyYy9haS9ubC10by1jeXBoZXIvbmwtdG8tY3lwaGVyLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBNb2RlbEFkYXB0ZXIgfSBmcm9tICcuL21vZGVsLWFkYXB0ZXInO1xuaW1wb3J0IHsgcmFuZG9tVVVJRCBhcyB1dWlkdjQgfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHBpbm8gZnJvbSAncGlubyc7XG5cbmNvbnN0IGxvZ2dlciA9IHBpbm8oeyBuYW1lOiAnbmwtdG8tY3lwaGVyJyB9KTtcblxuZXhwb3J0IGludGVyZmFjZSBDeXBoZXJWYWxpZGF0aW9uUmVzdWx0IHtcbiAgaXNWYWxpZDogYm9vbGVhbjtcbiAgc3ludGF4RXJyb3JzOiBzdHJpbmdbXTtcbiAgd2FybmluZ3M6IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvc3RFc3RpbWF0ZSB7XG4gIGVzdGltYXRlZFJvd3M6IG51bWJlcjtcbiAgY29zdENsYXNzOiAnbG93JyB8ICdtZWRpdW0nIHwgJ2hpZ2gnIHwgJ3ZlcnktaGlnaCc7XG4gIGV4ZWN1dGlvblRpbWVNczogbnVtYmVyO1xuICBtZW1vcnlNYjogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBvbGljeVJpc2sge1xuICByaXNrTGV2ZWw6ICdsb3cnIHwgJ21lZGl1bScgfCAnaGlnaCc7XG4gIHJpc2tzOiBzdHJpbmdbXTtcbiAgcGlpQWNjZXNzOiBib29sZWFuO1xuICBzZW5zaXRpdmVPcGVyYXRpb25zOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBObFRvQ3lwaGVyUmVzcG9uc2Uge1xuICBpZDogc3RyaW5nO1xuICBvcmlnaW5hbFByb21wdDogc3RyaW5nO1xuICBnZW5lcmF0ZWRDeXBoZXI6IHN0cmluZztcbiAgdmFsaWRhdGlvbjogQ3lwaGVyVmFsaWRhdGlvblJlc3VsdDtcbiAgY29zdEVzdGltYXRlOiBDb3N0RXN0aW1hdGU7XG4gIHBvbGljeVJpc2s6IFBvbGljeVJpc2s7XG4gIGNhbkV4ZWN1dGU6IGJvb2xlYW47XG4gIHRpbWVzdGFtcDogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTYW5kYm94RXhlY3V0aW9uT3B0aW9ucyB7XG4gIHJlYWRPbmx5OiBib29sZWFuO1xuICB0aW1lb3V0OiBudW1iZXI7XG4gIG1heFJvd3M6IG51bWJlcjtcbiAgZHJ5UnVuPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTYW5kYm94RXhlY3V0aW9uUmVzdWx0IHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgcm93cz86IGFueVtdO1xuICBleGVjdXRpb25UaW1lTXM6IG51bWJlcjtcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIHdhcm5pbmdzOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGNsYXNzIE5sVG9DeXBoZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBwcm9tcHRDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBObFRvQ3lwaGVyUmVzcG9uc2U+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXhlY3V0aW9uSGlzdG9yeTogQXJyYXk8eyBxdWVyeUlkOiBzdHJpbmc7IGV4ZWN1dGlvblRpbWU6IG51bWJlcjsgcm93Q291bnQ6IG51bWJlciB9PiA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYWRhcHRlcjogTW9kZWxBZGFwdGVyKSB7fVxuXG4gIGFzeW5jIHRyYW5zbGF0ZVdpdGhQcmV2aWV3KHByb21wdDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZywgdGVuYW50SWQ6IHN0cmluZyk6IFByb21pc2U8TmxUb0N5cGhlclJlc3BvbnNlPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBxdWVyeUlkID0gdXVpZHY0KCk7XG5cbiAgICAvLyBDaGVjayBjYWNoZSBmaXJzdFxuICAgIGNvbnN0IGNhY2hlS2V5ID0gYCR7dGVuYW50SWR9OiR7cHJvbXB0LnRyaW0oKS50b0xvd2VyQ2FzZSgpfWA7XG4gICAgaWYgKHRoaXMucHJvbXB0Q2FjaGUuaGFzKGNhY2hlS2V5KSkge1xuICAgICAgbG9nZ2VyLmluZm8oeyBxdWVyeUlkLCB1c2VySWQsIHRlbmFudElkLCBjYWNoZWQ6IHRydWUgfSwgJ1JldHVybmluZyBjYWNoZWQgTkzihpJDeXBoZXIgdHJhbnNsYXRpb24nKTtcbiAgICAgIHJldHVybiB0aGlzLnByb21wdENhY2hlLmdldChjYWNoZUtleSkhO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBHZW5lcmF0ZSBDeXBoZXJcbiAgICAgIGNvbnN0IGdlbmVyYXRlZEN5cGhlciA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVDeXBoZXIocHJvbXB0KTtcblxuICAgICAgLy8gVmFsaWRhdGUgc3ludGF4XG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUN5cGhlcihnZW5lcmF0ZWRDeXBoZXIpO1xuXG4gICAgICAvLyBFc3RpbWF0ZSBjb3N0XG4gICAgICBjb25zdCBjb3N0RXN0aW1hdGUgPSB0aGlzLmVzdGltYXRlQ29zdChnZW5lcmF0ZWRDeXBoZXIpO1xuXG4gICAgICAvLyBBc3Nlc3MgcG9saWN5IHJpc2tcbiAgICAgIGNvbnN0IHBvbGljeVJpc2sgPSB0aGlzLmFzc2Vzc1BvbGljeVJpc2soZ2VuZXJhdGVkQ3lwaGVyLCB1c2VySWQsIHRlbmFudElkKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2U6IE5sVG9DeXBoZXJSZXNwb25zZSA9IHtcbiAgICAgICAgaWQ6IHF1ZXJ5SWQsXG4gICAgICAgIG9yaWdpbmFsUHJvbXB0OiBwcm9tcHQsXG4gICAgICAgIGdlbmVyYXRlZEN5cGhlcixcbiAgICAgICAgdmFsaWRhdGlvbixcbiAgICAgICAgY29zdEVzdGltYXRlLFxuICAgICAgICBwb2xpY3lSaXNrLFxuICAgICAgICBjYW5FeGVjdXRlOiB2YWxpZGF0aW9uLmlzVmFsaWQgJiYgY29zdEVzdGltYXRlLmNvc3RDbGFzcyAhPT0gJ3ZlcnktaGlnaCcgJiYgcG9saWN5Umlzay5yaXNrTGV2ZWwgIT09ICdoaWdoJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpXG4gICAgICB9O1xuXG4gICAgICAvLyBDYWNoZSB0aGUgcmVzcG9uc2VcbiAgICAgIHRoaXMucHJvbXB0Q2FjaGUuc2V0KGNhY2hlS2V5LCByZXNwb25zZSk7XG5cbiAgICAgIC8vIEVtaXQgbWV0cmljc1xuICAgICAgY29uc3QgcGFyc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIGxvZ2dlci5pbmZvKHtcbiAgICAgICAgcXVlcnlJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB0ZW5hbnRJZCxcbiAgICAgICAgcGFyc2VUaW1lTXM6IHBhcnNlVGltZSxcbiAgICAgICAgdmFsaWRpdHk6IHZhbGlkYXRpb24uaXNWYWxpZCxcbiAgICAgICAgZXN0aW1hdGVkUm93czogY29zdEVzdGltYXRlLmVzdGltYXRlZFJvd3MsXG4gICAgICAgIGNvc3RDbGFzczogY29zdEVzdGltYXRlLmNvc3RDbGFzcyxcbiAgICAgICAgcmlza0xldmVsOiBwb2xpY3lSaXNrLnJpc2tMZXZlbFxuICAgICAgfSwgJ05M4oaSQ3lwaGVyIHRyYW5zbGF0aW9uIGNvbXBsZXRlZCcpO1xuXG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcih7IHF1ZXJ5SWQsIHVzZXJJZCwgdGVuYW50SWQsIGVycm9yIH0sICdOTOKGkkN5cGhlciB0cmFuc2xhdGlvbiBmYWlsZWQnKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVTYW5kYm94KFxuICAgIHF1ZXJ5SWQ6IHN0cmluZyxcbiAgICBjeXBoZXI6IHN0cmluZyxcbiAgICBvcHRpb25zOiBTYW5kYm94RXhlY3V0aW9uT3B0aW9ucyA9IHtcbiAgICAgIHJlYWRPbmx5OiB0cnVlLFxuICAgICAgdGltZW91dDogMzAwMDAsXG4gICAgICBtYXhSb3dzOiAxMDBcbiAgICB9XG4gICk6IFByb21pc2U8U2FuZGJveEV4ZWN1dGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gVmFsaWRhdGUgdGhlIHF1ZXJ5IGlzIHNhZmUgZm9yIHNhbmRib3hcbiAgICAgIGlmICghb3B0aW9ucy5yZWFkT25seSAmJiB0aGlzLmNvbnRhaW5zTXV0YXRpb25zKGN5cGhlcikpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBleGVjdXRpb25UaW1lTXM6IDAsXG4gICAgICAgICAgZXJyb3I6ICdNdXRhdGlvbnMgbm90IGFsbG93ZWQgaW4gc2FuZGJveCBtb2RlJyxcbiAgICAgICAgICB3YXJuaW5nczogW11cbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIExJTUlUIGNsYXVzZSBpZiBub3QgcHJlc2VudFxuICAgICAgY29uc3Qgc2FmZUN5cGhlciA9IHRoaXMubWFrZVNhZmUoY3lwaGVyLCBvcHRpb25zLm1heFJvd3MpO1xuXG4gICAgICBpZiAob3B0aW9ucy5kcnlSdW4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIGV4ZWN1dGlvblRpbWVNczogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgICB3YXJuaW5nczogW2BEcnkgcnVuIC0gd291bGQgZXhlY3V0ZTogJHtzYWZlQ3lwaGVyfWBdXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIFRPRE86IEludGVncmF0ZSB3aXRoIGFjdHVhbCBOZW80aiBzYW5kYm94IGNvbm5lY3Rpb25cbiAgICAgIC8vIEZvciBub3csIHNpbXVsYXRlIGV4ZWN1dGlvblxuICAgICAgY29uc3QgbW9ja1Jvd3MgPSB0aGlzLnNpbXVsYXRlRXhlY3V0aW9uKHNhZmVDeXBoZXIpO1xuXG4gICAgICBjb25zdCBleGVjdXRpb25UaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcblxuICAgICAgLy8gUmVjb3JkIGV4ZWN1dGlvbiBoaXN0b3J5IGZvciBjb3N0IGVzdGltYXRpb24gaW1wcm92ZW1lbnRzXG4gICAgICB0aGlzLmV4ZWN1dGlvbkhpc3RvcnkucHVzaCh7XG4gICAgICAgIHF1ZXJ5SWQsXG4gICAgICAgIGV4ZWN1dGlvblRpbWUsXG4gICAgICAgIHJvd0NvdW50OiBtb2NrUm93cy5sZW5ndGhcbiAgICAgIH0pO1xuXG4gICAgICBsb2dnZXIuaW5mbyh7XG4gICAgICAgIHF1ZXJ5SWQsXG4gICAgICAgIGV4ZWN1dGlvblRpbWVNczogZXhlY3V0aW9uVGltZSxcbiAgICAgICAgcm93Q291bnQ6IG1vY2tSb3dzLmxlbmd0aCxcbiAgICAgICAgc2FmZUN5cGhlclxuICAgICAgfSwgJ1NhbmRib3ggZXhlY3V0aW9uIGNvbXBsZXRlZCcpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICByb3dzOiBtb2NrUm93cyxcbiAgICAgICAgZXhlY3V0aW9uVGltZU1zOiBleGVjdXRpb25UaW1lLFxuICAgICAgICB3YXJuaW5nczogW11cbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcih7IHF1ZXJ5SWQsIGVycm9yIH0sICdTYW5kYm94IGV4ZWN1dGlvbiBmYWlsZWQnKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBleGVjdXRpb25UaW1lTXM6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGV4ZWN1dGlvbiBlcnJvcicsXG4gICAgICAgIHdhcm5pbmdzOiBbXVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdlbmVyYXRlQ3lwaGVyKHByb21wdDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAvLyBFbmhhbmNlZCBwYXR0ZXJuIG1hdGNoaW5nIGZvciBjb21tb24gcXVlcmllc1xuICAgIGlmICgvc2hvdyBhbGwgbm9kZXMvaS50ZXN0KHByb21wdCkpIHtcbiAgICAgIHJldHVybiAnTUFUQ0ggKG4pIFJFVFVSTiBuIExJTUlUIDI1JztcbiAgICB9XG5cbiAgICBpZiAoL2NvdW50IG5vZGVzL2kudGVzdChwcm9tcHQpKSB7XG4gICAgICByZXR1cm4gJ01BVENIIChuKSBSRVRVUk4gY291bnQobikgQVMgY291bnQnO1xuICAgIH1cblxuICAgIGlmICgvZmluZC4qY29ubmVjdGVkLip0by9pLnRlc3QocHJvbXB0KSkge1xuICAgICAgcmV0dXJuICdNQVRDSCAoYSktW3JdLShiKSBXSEVSRSBhLm5hbWUgPSAkbmFtZSBSRVRVUk4gYSwgciwgYiBMSU1JVCA1MCc7XG4gICAgfVxuXG4gICAgaWYgKC9zaG9ydGVzdC4qcGF0aC9pLnRlc3QocHJvbXB0KSkge1xuICAgICAgcmV0dXJuICdNQVRDSCBwID0gc2hvcnRlc3RQYXRoKChhKS1bKi4uNV0tKGIpKSBXSEVSRSBhLmlkID0gJHN0YXJ0SWQgQU5EIGIuaWQgPSAkZW5kSWQgUkVUVVJOIHAnO1xuICAgIH1cblxuICAgIGlmICgvbmVpZ2hib3JzLipvZi9pLnRlc3QocHJvbXB0KSkge1xuICAgICAgcmV0dXJuICdNQVRDSCAobiktW3JdLShuZWlnaGJvcikgV0hFUkUgbi5pZCA9ICRub2RlSWQgUkVUVVJOIG5laWdoYm9yLCByIExJTUlUIDEwMCc7XG4gICAgfVxuXG4gICAgLy8gRmFsbGJhY2sgdG8gbW9kZWwgYWRhcHRlclxuICAgIHJldHVybiB0aGlzLmFkYXB0ZXIuZ2VuZXJhdGUocHJvbXB0KTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVDeXBoZXIoY3lwaGVyOiBzdHJpbmcpOiBDeXBoZXJWYWxpZGF0aW9uUmVzdWx0IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBCYXNpYyBzeW50YXggdmFsaWRhdGlvblxuICAgIGlmICghY3lwaGVyLnRyaW0oKSkge1xuICAgICAgZXJyb3JzLnB1c2goJ0VtcHR5IHF1ZXJ5Jyk7XG4gICAgfVxuXG4gICAgaWYgKCFjeXBoZXIudG9VcHBlckNhc2UoKS5pbmNsdWRlcygnTUFUQ0gnKSAmJiAhY3lwaGVyLnRvVXBwZXJDYXNlKCkuaW5jbHVkZXMoJ0NSRUFURScpKSB7XG4gICAgICB3YXJuaW5ncy5wdXNoKCdRdWVyeSBkb2VzIG5vdCBjb250YWluIE1BVENIIG9yIENSRUFURSBjbGF1c2UnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgcG90ZW50aWFsIGlzc3Vlc1xuICAgIGlmICghY3lwaGVyLnRvVXBwZXJDYXNlKCkuaW5jbHVkZXMoJ0xJTUlUJykgJiYgY3lwaGVyLnRvVXBwZXJDYXNlKCkuaW5jbHVkZXMoJ01BVENIJykpIHtcbiAgICAgIHdhcm5pbmdzLnB1c2goJ05vIExJTUlUIGNsYXVzZSBmb3VuZCAtIHF1ZXJ5IG1heSByZXR1cm4gbGFyZ2UgcmVzdWx0IHNldHMnKTtcbiAgICB9XG5cbiAgICBpZiAoY3lwaGVyLmluY2x1ZGVzKCcqJykgJiYgY3lwaGVyLmluY2x1ZGVzKCdbJykgJiYgY3lwaGVyLmluY2x1ZGVzKCddJykpIHtcbiAgICAgIHdhcm5pbmdzLnB1c2goJ1ZhcmlhYmxlIGxlbmd0aCBwYXRoIGRldGVjdGVkIC0gbWF5IGJlIGV4cGVuc2l2ZScpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBkYW5nZXJvdXMgb3BlcmF0aW9uc1xuICAgIGNvbnN0IGRhbmdlcm91c09wcyA9IFsnREVMRVRFJywgJ0RFVEFDSCBERUxFVEUnLCAnRFJPUCcsICdSRU1PVkUnXTtcbiAgICBmb3IgKGNvbnN0IG9wIG9mIGRhbmdlcm91c09wcykge1xuICAgICAgaWYgKGN5cGhlci50b1VwcGVyQ2FzZSgpLmluY2x1ZGVzKG9wKSkge1xuICAgICAgICBlcnJvcnMucHVzaChgRGFuZ2Vyb3VzIG9wZXJhdGlvbiBkZXRlY3RlZDogJHtvcH1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNWYWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIHN5bnRheEVycm9yczogZXJyb3JzLFxuICAgICAgd2FybmluZ3NcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBlc3RpbWF0ZUNvc3QoY3lwaGVyOiBzdHJpbmcpOiBDb3N0RXN0aW1hdGUge1xuICAgIGxldCBlc3RpbWF0ZWRSb3dzID0gMTAwO1xuICAgIGxldCBjb3N0Q2xhc3M6IENvc3RFc3RpbWF0ZVsnY29zdENsYXNzJ10gPSAnbG93JztcbiAgICBsZXQgZXhlY3V0aW9uVGltZU1zID0gNTA7XG4gICAgbGV0IG1lbW9yeU1iID0gMTA7XG5cbiAgICBjb25zdCB1cHBlckN5cGhlciA9IGN5cGhlci50b1VwcGVyQ2FzZSgpO1xuXG4gICAgLy8gQW5hbHl6ZSBxdWVyeSBjb21wbGV4aXR5XG4gICAgaWYgKHVwcGVyQ3lwaGVyLmluY2x1ZGVzKCcqJykpIHtcbiAgICAgIGVzdGltYXRlZFJvd3MgKj0gMTA7XG4gICAgICBjb3N0Q2xhc3MgPSAnaGlnaCc7XG4gICAgICBleGVjdXRpb25UaW1lTXMgKj0gMjA7XG4gICAgICBtZW1vcnlNYiAqPSA1O1xuICAgIH1cblxuICAgIGlmICh1cHBlckN5cGhlci5pbmNsdWRlcygnU0hPUlRFU1RQQVRIJykpIHtcbiAgICAgIGVzdGltYXRlZFJvd3MgKj0gMjtcbiAgICAgIGNvc3RDbGFzcyA9IGNvc3RDbGFzcyA9PT0gJ2hpZ2gnID8gJ3ZlcnktaGlnaCcgOiAnbWVkaXVtJztcbiAgICAgIGV4ZWN1dGlvblRpbWVNcyAqPSA1O1xuICAgICAgbWVtb3J5TWIgKj0gMjtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgY2FydGVzaWFuIHByb2R1Y3RzXG4gICAgY29uc3QgbWF0Y2hDb3VudCA9IChjeXBoZXIubWF0Y2goL01BVENIL2dpKSB8fCBbXSkubGVuZ3RoO1xuICAgIGlmIChtYXRjaENvdW50ID4gMSAmJiAhdXBwZXJDeXBoZXIuaW5jbHVkZXMoJ1dIRVJFJykpIHtcbiAgICAgIGVzdGltYXRlZFJvd3MgKj0gTWF0aC5wb3coMTAsIG1hdGNoQ291bnQgLSAxKTtcbiAgICAgIGNvc3RDbGFzcyA9ICd2ZXJ5LWhpZ2gnO1xuICAgICAgZXhlY3V0aW9uVGltZU1zICo9IDUwO1xuICAgICAgbWVtb3J5TWIgKj0gMTA7XG4gICAgfVxuXG4gICAgLy8gVXNlIGhpc3RvcmljYWwgZGF0YSBpZiBhdmFpbGFibGVcbiAgICBjb25zdCBhdmdIaXN0b3J5ID0gdGhpcy5nZXRBdmVyYWdlRXhlY3V0aW9uVGltZShjeXBoZXIpO1xuICAgIGlmIChhdmdIaXN0b3J5KSB7XG4gICAgICBleGVjdXRpb25UaW1lTXMgPSBNYXRoLm1heChleGVjdXRpb25UaW1lTXMsIGF2Z0hpc3RvcnkpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBlc3RpbWF0ZWRSb3dzLFxuICAgICAgY29zdENsYXNzLFxuICAgICAgZXhlY3V0aW9uVGltZU1zLFxuICAgICAgbWVtb3J5TWJcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3Nlc3NQb2xpY3lSaXNrKGN5cGhlcjogc3RyaW5nLCB1c2VySWQ6IHN0cmluZywgdGVuYW50SWQ6IHN0cmluZyk6IFBvbGljeVJpc2sge1xuICAgIGNvbnN0IHJpc2tzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGxldCByaXNrTGV2ZWw6IFBvbGljeVJpc2tbJ3Jpc2tMZXZlbCddID0gJ2xvdyc7XG4gICAgbGV0IHBpaUFjY2VzcyA9IGZhbHNlO1xuICAgIGNvbnN0IHNlbnNpdGl2ZU9wZXJhdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBjb25zdCB1cHBlckN5cGhlciA9IGN5cGhlci50b1VwcGVyQ2FzZSgpO1xuXG4gICAgLy8gQ2hlY2sgZm9yIFBJSSBhY2Nlc3MgcGF0dGVybnNcbiAgICBjb25zdCBwaWlGaWVsZHMgPSBbJ0VNQUlMJywgJ1BIT05FJywgJ1NTTicsICdBRERSRVNTJywgJ05BTUUnXTtcbiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHBpaUZpZWxkcykge1xuICAgICAgaWYgKHVwcGVyQ3lwaGVyLmluY2x1ZGVzKGZpZWxkKSkge1xuICAgICAgICBwaWlBY2Nlc3MgPSB0cnVlO1xuICAgICAgICByaXNrcy5wdXNoKGBRdWVyeSBhY2Nlc3NlcyBwb3RlbnRpYWxseSBzZW5zaXRpdmUgZmllbGQ6ICR7ZmllbGR9YCk7XG4gICAgICAgIHJpc2tMZXZlbCA9ICdtZWRpdW0nO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBicm9hZCBkYXRhIGFjY2Vzc1xuICAgIGlmICghdXBwZXJDeXBoZXIuaW5jbHVkZXMoJ1dIRVJFJykgJiYgdXBwZXJDeXBoZXIuaW5jbHVkZXMoJ01BVENIJykpIHtcbiAgICAgIHJpc2tzLnB1c2goJ1F1ZXJ5IGxhY2tzIFdIRVJFIGNsYXVzZSAtIG1heSBhY2Nlc3MgYWxsIGRhdGEnKTtcbiAgICAgIHJpc2tMZXZlbCA9ICdtZWRpdW0nO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBtdXRhdGlvbiBvcGVyYXRpb25zXG4gICAgY29uc3QgbXV0YXRpb25zID0gWydDUkVBVEUnLCAnREVMRVRFJywgJ1NFVCcsICdSRU1PVkUnLCAnTUVSR0UnXTtcbiAgICBmb3IgKGNvbnN0IG11dGF0aW9uIG9mIG11dGF0aW9ucykge1xuICAgICAgaWYgKHVwcGVyQ3lwaGVyLmluY2x1ZGVzKG11dGF0aW9uKSkge1xuICAgICAgICBzZW5zaXRpdmVPcGVyYXRpb25zLnB1c2gobXV0YXRpb24pO1xuICAgICAgICByaXNrcy5wdXNoKGBRdWVyeSBjb250YWlucyBtdXRhdGlvbiBvcGVyYXRpb246ICR7bXV0YXRpb259YCk7XG4gICAgICAgIHJpc2tMZXZlbCA9ICdoaWdoJztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcmlza0xldmVsLFxuICAgICAgcmlza3MsXG4gICAgICBwaWlBY2Nlc3MsXG4gICAgICBzZW5zaXRpdmVPcGVyYXRpb25zXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgY29udGFpbnNNdXRhdGlvbnMoY3lwaGVyOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBtdXRhdGlvbnMgPSBbJ0NSRUFURScsICdERUxFVEUnLCAnU0VUJywgJ1JFTU9WRScsICdNRVJHRScsICdEUk9QJ107XG4gICAgY29uc3QgdXBwZXJDeXBoZXIgPSBjeXBoZXIudG9VcHBlckNhc2UoKTtcbiAgICByZXR1cm4gbXV0YXRpb25zLnNvbWUob3AgPT4gdXBwZXJDeXBoZXIuaW5jbHVkZXMob3ApKTtcbiAgfVxuXG4gIHByaXZhdGUgbWFrZVNhZmUoY3lwaGVyOiBzdHJpbmcsIG1heFJvd3M6IG51bWJlcik6IHN0cmluZyB7XG4gICAgbGV0IHNhZmVDeXBoZXIgPSBjeXBoZXIudHJpbSgpO1xuXG4gICAgLy8gQWRkIExJTUlUIGlmIG5vdCBwcmVzZW50XG4gICAgaWYgKCFzYWZlQ3lwaGVyLnRvVXBwZXJDYXNlKCkuaW5jbHVkZXMoJ0xJTUlUJykpIHtcbiAgICAgIHNhZmVDeXBoZXIgKz0gYCBMSU1JVCAke21heFJvd3N9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gc2FmZUN5cGhlcjtcbiAgfVxuXG4gIHByaXZhdGUgc2ltdWxhdGVFeGVjdXRpb24oY3lwaGVyOiBzdHJpbmcpOiBhbnlbXSB7XG4gICAgLy8gTW9jayBleGVjdXRpb24gZm9yIGRlbW8gcHVycG9zZXNcbiAgICBjb25zdCBtb2NrRGF0YSA9IFtcbiAgICAgIHsgaWQ6ICcxJywgbmFtZTogJ05vZGUgMScsIHR5cGU6ICdQZXJzb24nIH0sXG4gICAgICB7IGlkOiAnMicsIG5hbWU6ICdOb2RlIDInLCB0eXBlOiAnT3JnYW5pemF0aW9uJyB9LFxuICAgICAgeyBpZDogJzMnLCBuYW1lOiAnTm9kZSAzJywgdHlwZTogJ0V2ZW50JyB9XG4gICAgXTtcblxuICAgIC8vIFJldHVybiBzdWJzZXQgYmFzZWQgb24gcXVlcnkgdHlwZVxuICAgIGlmIChjeXBoZXIudG9VcHBlckNhc2UoKS5pbmNsdWRlcygnQ09VTlQnKSkge1xuICAgICAgcmV0dXJuIFt7IGNvdW50OiBtb2NrRGF0YS5sZW5ndGggfV07XG4gICAgfVxuXG4gICAgcmV0dXJuIG1vY2tEYXRhLnNsaWNlKDAsIE1hdGgubWluKDMsIDEwMCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBdmVyYWdlRXhlY3V0aW9uVGltZShjeXBoZXI6IHN0cmluZyk6IG51bWJlciB8IG51bGwge1xuICAgIC8vIFNpbXBsZSBwYXR0ZXJuIG1hdGNoaW5nIGZvciBoaXN0b3JpY2FsIGRhdGFcbiAgICBjb25zdCBzaW1pbGFyUXVlcmllcyA9IHRoaXMuZXhlY3V0aW9uSGlzdG9yeS5maWx0ZXIoaCA9PiB7XG4gICAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCBzaW1pbGFyaXR5IGNoZWNrXG4gICAgICByZXR1cm4gY3lwaGVyLmluY2x1ZGVzKCdNQVRDSCcpICYmIGN5cGhlci5pbmNsdWRlcygnUkVUVVJOJyk7XG4gICAgfSk7XG5cbiAgICBpZiAoc2ltaWxhclF1ZXJpZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IGF2Z1RpbWUgPSBzaW1pbGFyUXVlcmllcy5yZWR1Y2UoKHN1bSwgcSkgPT4gc3VtICsgcS5leGVjdXRpb25UaW1lLCAwKSAvIHNpbWlsYXJRdWVyaWVzLmxlbmd0aDtcbiAgICByZXR1cm4gYXZnVGltZTtcbiAgfVxuXG4gIC8vIE1ldGhvZCBmb3IgY29tcHV0aW5nIGRpZmYgYmV0d2VlbiBnZW5lcmF0ZWQgYW5kIHVzZXItZWRpdGVkIEN5cGhlclxuICBkaWZmQ3lwaGVyKG9yaWdpbmFsOiBzdHJpbmcsIGVkaXRlZDogc3RyaW5nKTogeyBhZGRpdGlvbnM6IHN0cmluZ1tdOyBkZWxldGlvbnM6IHN0cmluZ1tdOyBtb2RpZmljYXRpb25zOiBzdHJpbmdbXSB9IHtcbiAgICAvLyBTaW1wbGUgZGlmZiBpbXBsZW1lbnRhdGlvblxuICAgIGNvbnN0IG9yaWdpbmFsTGluZXMgPSBvcmlnaW5hbC5zcGxpdCgnXFxuJykubWFwKGwgPT4gbC50cmltKCkpO1xuICAgIGNvbnN0IGVkaXRlZExpbmVzID0gZWRpdGVkLnNwbGl0KCdcXG4nKS5tYXAobCA9PiBsLnRyaW0oKSk7XG5cbiAgICBjb25zdCBhZGRpdGlvbnM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZGVsZXRpb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IG1vZGlmaWNhdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBCYXNpYyBsaW5lLWJ5LWxpbmUgY29tcGFyaXNvblxuICAgIGVkaXRlZExpbmVzLmZvckVhY2gobGluZSA9PiB7XG4gICAgICBpZiAoIW9yaWdpbmFsTGluZXMuaW5jbHVkZXMobGluZSkpIHtcbiAgICAgICAgYWRkaXRpb25zLnB1c2gobGluZSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBvcmlnaW5hbExpbmVzLmZvckVhY2gobGluZSA9PiB7XG4gICAgICBpZiAoIWVkaXRlZExpbmVzLmluY2x1ZGVzKGxpbmUpKSB7XG4gICAgICAgIGRlbGV0aW9ucy5wdXNoKGxpbmUpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgYWRkaXRpb25zLCBkZWxldGlvbnMsIG1vZGlmaWNhdGlvbnMgfTtcbiAgfVxuXG4gIC8vIENsZWFudXAgbWV0aG9kIGZvciBjYWNoZSBtYW5hZ2VtZW50XG4gIGNsZWFyQ2FjaGUoKTogdm9pZCB7XG4gICAgdGhpcy5wcm9tcHRDYWNoZS5jbGVhcigpO1xuICAgIGxvZ2dlci5pbmZvKCdOTOKGkkN5cGhlciBjYWNoZSBjbGVhcmVkJyk7XG4gIH1cblxuICAvLyBMZWdhY3kgbWV0aG9kIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gIGFzeW5jIHRyYW5zbGF0ZShwcm9tcHQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy50cmFuc2xhdGVXaXRoUHJldmlldyhwcm9tcHQsICdzeXN0ZW0nLCAnZGVmYXVsdCcpO1xuICAgIHJldHVybiByZXN1bHQuZ2VuZXJhdGVkQ3lwaGVyO1xuICB9XG59Il0sInZlcnNpb24iOjN9