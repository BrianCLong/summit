7ac1286bdd823b4f68581391bf2b814c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BehavioralDnaNetwork = void 0;
exports.correlateBehavioralDna = correlateBehavioralDna;
const events_1 = require("events");
/**
 * Maps behavioral events into a continuously updated vector space.
 * Emits `update` events whenever an entity's embedding changes.
 */
class BehavioralDnaNetwork extends events_1.EventEmitter {
    anomalyThreshold;
    history = new Map();
    embeddings = new Map();
    constructor(anomalyThreshold = 3) {
        super();
        this.anomalyThreshold = anomalyThreshold;
    }
    /**
     * Ingest a behavior event, update embeddings and perform anomaly detection.
     */
    ingest(event) {
        const normalized = this.normalize(event.vector);
        const history = this.history.get(event.entityId) ?? [];
        const anomaly = this.detectAnomaly(event.entityId, normalized, history);
        history.push(normalized);
        this.history.set(event.entityId, history);
        this.embeddings.set(event.entityId, this.mean(history));
        this.emit("update", {
            entityId: event.entityId,
            embedding: this.embeddings.get(event.entityId),
            anomaly,
        });
        return anomaly;
    }
    /**
     * Retrieve the latest embedding for an entity.
     */
    getEmbedding(entityId) {
        return this.embeddings.get(entityId);
    }
    /**
     * Predict the next behavior vector based on recent trend.
     */
    predictNext(entityId) {
        const history = this.history.get(entityId);
        if (!history || history.length < 2)
            return undefined;
        const last = history[history.length - 1];
        const prev = history[history.length - 2];
        const trend = last.map((v, i) => v - prev[i]);
        return last.map((v, i) => v + trend[i]);
    }
    /**
     * Normalize a raw vector.
     */
    normalize(vector) {
        const magnitude = Math.sqrt(vector.reduce((s, v) => s + v * v, 0));
        if (magnitude === 0)
            return vector.map(() => 0);
        return vector.map((v) => v / magnitude);
    }
    mean(vectors) {
        const length = vectors[0]?.length ?? 0;
        const sum = new Array(length).fill(0);
        vectors.forEach((vec) => {
            for (let i = 0; i < length; i++) {
                sum[i] += vec[i];
            }
        });
        return sum.map((v) => v / vectors.length);
    }
    detectAnomaly(entityId, vector, history) {
        if (history.length === 0) {
            return { entityId, isAnomaly: false, score: 0 };
        }
        const meanVec = this.mean(history);
        const distance = this.distance(vector, meanVec);
        const stdDev = this.stdDev(history, meanVec);
        const isAnomaly = stdDev === 0 ? distance > 0 : distance > this.anomalyThreshold * stdDev;
        const score = stdDev === 0 ? distance : distance / stdDev;
        return { entityId, isAnomaly, score };
    }
    stdDev(history, meanVec) {
        const distances = history.map((vec) => this.distance(vec, meanVec));
        const avg = distances.reduce((a, b) => a + b, 0) / distances.length;
        const variance = distances.reduce((a, b) => a + (b - avg) ** 2, 0) / distances.length;
        return Math.sqrt(variance);
    }
    distance(a, b) {
        return Math.sqrt(a.reduce((sum, v, i) => sum + (v - b[i]) ** 2, 0));
    }
}
exports.BehavioralDnaNetwork = BehavioralDnaNetwork;
// Legacy placeholder to maintain backward compatibility with existing tests.
function correlateBehavioralDna() {
    return 0;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvYWkvYmVoYXZpb3JhbERuYU5ldHdvcmsudHMiLCJtYXBwaW5ncyI6Ijs7O0FBd0hBLHdEQUVDO0FBMUhELG1DQUFzQztBQWlCdEM7OztHQUdHO0FBQ0gsTUFBYSxvQkFBcUIsU0FBUSxxQkFBWTtJQUloQztJQUhaLE9BQU8sR0FBNEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUM3QyxVQUFVLEdBQTBCLElBQUksR0FBRyxFQUFFLENBQUM7SUFFdEQsWUFBb0IsbUJBQW1CLENBQUM7UUFDdEMsS0FBSyxFQUFFLENBQUM7UUFEVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQUk7SUFFeEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQW9CO1FBQ3pCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUV4RSxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFeEQsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRO1lBQ3hCLFNBQVMsRUFBRSxJQUFJLENBQUMs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QUFRLENBQUMsQ0FBVyxFQUFFLENBQVc7UUFDdkMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7Q0FDRjtBQWhHRCxvREFnR0M7QUFFRCw2RUFBNkU7QUFDN0UsU0FBZ0Isc0JBQXNCO0lBQ3BDLE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvYnJpYW5sb25nL0RldmVsb3Blci9zdW1taXQvc2VydmVyL3NyYy9haS9iZWhhdmlvcmFsRG5hTmV0d29yay50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmVoYXZpb3JFdmVudCB7XG4gIGVudGl0eUlkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBSYXcgYmVoYXZpb3IgdmVjdG9yIGJlZm9yZSB0cmFuc2Zvcm1hdGlvbi5cbiAgICovXG4gIHZlY3RvcjogbnVtYmVyW107XG4gIHRpbWVzdGFtcD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBbm9tYWx5RGV0ZWN0aW9uUmVzdWx0IHtcbiAgZW50aXR5SWQ6IHN0cmluZztcbiAgaXNBbm9tYWx5OiBib29sZWFuO1xuICBzY29yZTogbnVtYmVyO1xufVxuXG4vKipcbiAqIE1hcHMgYmVoYXZpb3JhbCBldmVudHMgaW50byBhIGNvbnRpbnVvdXNseSB1cGRhdGVkIHZlY3RvciBzcGFjZS5cbiAqIEVtaXRzIGB1cGRhdGVgIGV2ZW50cyB3aGVuZXZlciBhbiBlbnRpdHkncyBlbWJlZGRpbmcgY2hhbmdlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIEJlaGF2aW9yYWxEbmFOZXR3b3JrIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgcHJpdmF0ZSBoaXN0b3J5OiBNYXA8c3RyaW5nLCBudW1iZXJbXVtdPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBlbWJlZGRpbmdzOiBNYXA8c3RyaW5nLCBudW1iZXJbXT4gPSBuZXcgTWFwKCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhbm9tYWx5VGhyZXNob2xkID0gMykge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICAvKipcbiAgICogSW5nZXN0IGEgYmVoYXZpb3IgZXZlbnQsIHVwZGF0ZSBlbWJlZGRpbmdzIGFuZCBwZXJmb3JtIGFub21hbHkgZGV0ZWN0aW9uLlxuICAgKi9cbiAgaW5nZXN0KGV2ZW50OiBCZWhhdmlvckV2ZW50KTogQW5vbWFseURldGVjdGlvblJlc3VsdCB7XG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IHRoaXMubm9ybWFsaXplKGV2ZW50LnZlY3Rvcik7XG4gICAgY29uc3QgaGlzdG9yeSA9IHRoaXMuaGlzdG9yeS5nZXQoZXZlbnQuZW50aXR5SWQpID8/IFtdO1xuICAgIGNvbnN0IGFub21hbHkgPSB0aGlzLmRldGVjdEFub21hbHkoZXZlbnQuZW50aXR5SWQsIG5vcm1hbGl6ZWQsIGhpc3RvcnkpO1xuXG4gICAgaGlzdG9yeS5wdXNoKG5vcm1hbGl6ZWQpO1xuICAgIHRoaXMuaGlzdG9yeS5zZXQoZXZlbnQuZW50aXR5SWQsIGhpc3RvcnkpO1xuICAgIHRoaXMuZW1iZWRkaW5ncy5zZXQoZXZlbnQuZW50aXR5SWQsIHRoaXMubWVhbihoaXN0b3J5KSk7XG5cbiAgICB0aGlzLmVtaXQoXCJ1cGRhdGVcIiwge1xuICAgICAgZW50aXR5SWQ6IGV2ZW50LmVudGl0eUlkLFxuICAgICAgZW1iZWRkaW5nOiB0aGlzLmVtYmVkZGluZ3MuZ2V0KGV2ZW50LmVudGl0eUlkKSxcbiAgICAgIGFub21hbHksXG4gICAgfSk7XG5cbiAgICByZXR1cm4gYW5vbWFseTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZSB0aGUgbGF0ZXN0IGVtYmVkZGluZyBmb3IgYW4gZW50aXR5LlxuICAgKi9cbiAgZ2V0RW1iZWRkaW5nKGVudGl0eUlkOiBzdHJpbmcpOiBudW1iZXJbXSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuZW1iZWRkaW5ncy5nZXQoZW50aXR5SWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZWRpY3QgdGhlIG5leHQgYmVoYXZpb3IgdmVjdG9yIGJhc2VkIG9uIHJlY2VudCB0cmVuZC5cbiAgICovXG4gIHByZWRpY3ROZXh0KGVudGl0eUlkOiBzdHJpbmcpOiBudW1iZXJbXSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgaGlzdG9yeSA9IHRoaXMuaGlzdG9yeS5nZXQoZW50aXR5SWQpO1xuICAgIGlmICghaGlzdG9yeSB8fCBoaXN0b3J5Lmxlbmd0aCA8IDIpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY29uc3QgbGFzdCA9IGhpc3RvcnlbaGlzdG9yeS5sZW5ndGggLSAxXTtcbiAgICBjb25zdCBwcmV2ID0gaGlzdG9yeVtoaXN0b3J5Lmxlbmd0aCAtIDJdO1xuICAgIGNvbnN0IHRyZW5kID0gbGFzdC5tYXAoKHYsIGkpID0+IHYgLSBwcmV2W2ldKTtcbiAgICByZXR1cm4gbGFzdC5tYXAoKHYsIGkpID0+IHYgKyB0cmVuZFtpXSk7XG4gIH1cblxuICAvKipcbiAgICogTm9ybWFsaXplIGEgcmF3IHZlY3Rvci5cbiAgICovXG4gIHByaXZhdGUgbm9ybWFsaXplKHZlY3RvcjogbnVtYmVyW10pOiBudW1iZXJbXSB7XG4gICAgY29uc3QgbWFnbml0dWRlID0gTWF0aC5zcXJ0KHZlY3Rvci5yZWR1Y2UoKHMsIHYpID0+IHMgKyB2ICogdiwgMCkpO1xuICAgIGlmIChtYWduaXR1ZGUgPT09IDApIHJldHVybiB2ZWN0b3IubWFwKCgpID0+IDApO1xuICAgIHJldHVybiB2ZWN0b3IubWFwKCh2KSA9PiB2IC8gbWFnbml0dWRlKTtcbiAgfVxuXG4gIHByaXZhdGUgbWVhbih2ZWN0b3JzOiBudW1iZXJbXVtdKTogbnVtYmVyW10ge1xuICAgIGNvbnN0IGxlbmd0aCA9IHZlY3RvcnNbMF0/Lmxlbmd0aCA/PyAwO1xuICAgIGNvbnN0IHN1bSA9IG5ldyBBcnJheShsZW5ndGgpLmZpbGwoMCk7XG4gICAgdmVjdG9ycy5mb3JFYWNoKCh2ZWMpID0+IHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc3VtW2ldICs9IHZlY1tpXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gc3VtLm1hcCgodikgPT4gdiAvIHZlY3RvcnMubGVuZ3RoKTtcbiAgfVxuXG4gIHByaXZhdGUgZGV0ZWN0QW5vbWFseShcbiAgICBlbnRpdHlJZDogc3RyaW5nLFxuICAgIHZlY3RvcjogbnVtYmVyW10sXG4gICAgaGlzdG9yeTogbnVtYmVyW11bXSxcbiAgKTogQW5vbWFseURldGVjdGlvblJlc3VsdCB7XG4gICAgaWYgKGhpc3RvcnkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4geyBlbnRpdHlJZCwgaXNBbm9tYWx5OiBmYWxzZSwgc2NvcmU6IDAgfTtcbiAgICB9XG4gICAgY29uc3QgbWVhblZlYyA9IHRoaXMubWVhbihoaXN0b3J5KTtcbiAgICBjb25zdCBkaXN0YW5jZSA9IHRoaXMuZGlzdGFuY2UodmVjdG9yLCBtZWFuVmVjKTtcbiAgICBjb25zdCBzdGREZXYgPSB0aGlzLnN0ZERldihoaXN0b3J5LCBtZWFuVmVjKTtcbiAgICBjb25zdCBpc0Fub21hbHkgPVxuICAgICAgc3RkRGV2ID09PSAwID8gZGlzdGFuY2UgPiAwIDogZGlzdGFuY2UgPiB0aGlzLmFub21hbHlUaHJlc2hvbGQgKiBzdGREZXY7XG4gICAgY29uc3Qgc2NvcmUgPSBzdGREZXYgPT09IDAgPyBkaXN0YW5jZSA6IGRpc3RhbmNlIC8gc3RkRGV2O1xuICAgIHJldHVybiB7IGVudGl0eUlkLCBpc0Fub21hbHksIHNjb3JlIH07XG4gIH1cblxuICBwcml2YXRlIHN0ZERldihoaXN0b3J5OiBudW1iZXJbXVtdLCBtZWFuVmVjOiBudW1iZXJbXSk6IG51bWJlciB7XG4gICAgY29uc3QgZGlzdGFuY2VzID0gaGlzdG9yeS5tYXAoKHZlYykgPT4gdGhpcy5kaXN0YW5jZSh2ZWMsIG1lYW5WZWMpKTtcbiAgICBjb25zdCBhdmcgPSBkaXN0YW5jZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBkaXN0YW5jZXMubGVuZ3RoO1xuICAgIGNvbnN0IHZhcmlhbmNlID1cbiAgICAgIGRpc3RhbmNlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyAoYiAtIGF2ZykgKiogMiwgMCkgLyBkaXN0YW5jZXMubGVuZ3RoO1xuICAgIHJldHVybiBNYXRoLnNxcnQodmFyaWFuY2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXN0YW5jZShhOiBudW1iZXJbXSwgYjogbnVtYmVyW10pOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLnNxcnQoYS5yZWR1Y2UoKHN1bSwgdiwgaSkgPT4gc3VtICsgKHYgLSBiW2ldKSAqKiAyLCAwKSk7XG4gIH1cbn1cblxuLy8gTGVnYWN5IHBsYWNlaG9sZGVyIHRvIG1haW50YWluIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCBleGlzdGluZyB0ZXN0cy5cbmV4cG9ydCBmdW5jdGlvbiBjb3JyZWxhdGVCZWhhdmlvcmFsRG5hKCk6IG51bWJlciB7XG4gIHJldHVybiAwO1xufVxuIl0sInZlcnNpb24iOjN9