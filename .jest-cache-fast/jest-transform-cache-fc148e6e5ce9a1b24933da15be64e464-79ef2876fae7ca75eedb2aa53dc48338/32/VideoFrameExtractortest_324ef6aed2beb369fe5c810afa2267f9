0e9c92f1b216fb0397cc3d25949caeaa
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// Mock ffmpeg and fs/promises
jest.mock('fluent-ffmpeg');
jest.mock('fs/promises');
const VideoFrameExtractor_1 = require("../VideoFrameExtractor");
const fluent_ffmpeg_1 = __importDefault(require("fluent-ffmpeg"));
const promises_1 = __importDefault(require("fs/promises"));
describe('VideoFrameExtractor', () => {
    let extractor;
    const mockFfmpegPath = '/usr/bin/ffmpeg';
    const mockFfprobePath = '/usr/bin/ffprobe';
    const mockTempDir = '/tmp/test-temp';
    const mockVideoPath = '/path/to/test-video.mp4';
    beforeEach(() => {
        extractor = new VideoFrameExtractor_1.VideoFrameExtractor(mockFfmpegPath, mockFfprobePath, mockTempDir);
        // Reset mocks
        fluent_ffmpeg_1.default.mockClear();
        promises_1.default.mkdir.mockClear();
        promises_1.default.rm.mockClear();
        // Mock ffmpeg chainable methods
        fluent_ffmpeg_1.default.mockImplementation(() => ({
            seekInput: jest.fn().mockReturnThis(),
            duration: jest.fn().mockReturnThis(),
            fps: jest.fn().mockReturnThis(),
            addOption: jest.fn().mockReturnThis(),
            output: jest.fn().mockReturnThis(),
            noVideo: jest.fn().mockReturnThis(),
            audioCodec: jest.fn().mockReturnThis(),
            on: jest.fn((event, callback) => {
                if (event === 'end') {
                    // Simulate successful end
                    callback();
                }
                else if (event === 'filenames') {
                    // Simulate filenames being emitted
                    callback(['frame-0.000.png', 'frame-1.000.png']);
                }
                return this;
            }),
            run: jest.fn(),
        }));
        // Mock ffprobe
        fluent_ffmpeg_1.default.ffprobe.mockImplementation((_path, callback) => {
            callback(null, { format: { duration: 10 } }); // Mock video duration
        });
    });
    it('should extract frames with default options', async () => {
        const { frames, audio } = await extractor.extract(mockVideoPath);
        expect(promises_1.default.mkdir).toHaveBeenCalledWith(expect.stringContaining(mockTempDir), { recursive: true });
        expect(fluent_ffmpeg_1.default).toHaveBeenCalledWith(mockVideoPath);
        expect(fluent_ffmpeg_1.default.mock.results[0].value.fps).toHaveBeenCalledWith(1); // Default fps
        expect(fluent_ffmpeg_1.default.mock.results[0].value.output).toHaveBeenCalledWith(expect.stringContaining('frame-%s.png'));
        expect(fluent_ffmpeg_1.default.mock.results[0].value.run).toHaveBeenCalled();
        expect(frames.length).toBe(2);
        expect(frames[0].framePath).toContain('frame-0.000.png');
        expect(frames[1].framePath).toContain('frame-1.000.png');
        expect(audio).toBeUndefined();
    });
    it('should extract frames with specified frameRate', async () => {
        await extractor.extract(mockVideoPath, { frameRate: 5 });
        expect(fluent_ffmpeg_1.default.mock.results[0].value.fps).toHaveBeenCalledWith(5);
    });
    it('should extract frames with specified interval', async () => {
        await extractor.extract(mockVideoPath, { interval: 2 });
        expect(fluent_ffmpeg_1.default.mock.results[0].value.addOption).toHaveBeenCalledWith('-vf', 'fps=1/2');
    });
    it('should extract audio when extractAudio is true', async () => {
        const { audio } = await extractor.extract(mockVideoPath, { extractAudio: true });
        expect(audio).toBeDefined();
        expect(audio?.audioPath).toContain('audio-');
        expect(audio?.audioPath).toContain('.mp3');
        expect(audio?.duration).toBe(10);
        expect(fluent_ffmpeg_1.default.mock.results[1].value.noVideo).toHaveBeenCalled(); // Second ffmpeg call for audio
        expect(fluent_ffmpeg_1.default.mock.results[1].value.audioCodec).toHaveBeenCalledWith('libmp3lame');
    });
    it('should clean up temporary directory', async () => {
        const tempDirToClean = '/tmp/some-temp-dir';
        await extractor.cleanup(tempDirToClean);
        expect(promises_1.default.rm).toHaveBeenCalledWith(tempDirToClean, { recursive: true, force: true });
    });
    it('should handle ffmpeg errors during frame extraction', async () => {
        fluent_ffmpeg_1.default.mockImplementationOnce(() => ({
            seekInput: jest.fn().mockReturnThis(),
            duration: jest.fn().mockReturnThis(),
            fps: jest.fn().mockReturnThis(),
            addOption: jest.fn().mockReturnThis(),
            output: jest.fn().mockReturnThis(),
            on: jest.fn((event, callback) => {
                if (event === 'error') {
                    callback(new Error('ffmpeg test error'));
                }
                return this;
            }),
            run: jest.fn(),
        }));
        await expect(extractor.extract(mockVideoPath)).rejects.toThrow('ffmpeg test error');
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvYWkvZW5naW5lcy9fX3Rlc3RzX18vVmlkZW9GcmFtZUV4dHJhY3Rvci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBS0EsOEJBQThCO0FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztBQVB6QixnRUFBNkQ7QUFDN0Qsa0VBQW1DO0FBQ25DLDJEQUE2QjtBQU83QixRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO0lBQ25DLElBQUksU0FBOEIsQ0FBQztJQUNuQyxNQUFNLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQztJQUN6QyxNQUFNLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQztJQUMzQyxNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQztJQUNyQyxNQUFNLGFBQWEsR0FBRyx5QkFBeUIsQ0FBQztJQUVoRCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsU0FBUyxHQUFHLElBQUkseUNBQW1CLENBQUMsY0FBYyxFQUFFLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNsRixjQUFjO1FBQ2IsdUJBQXFDLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbEQsa0JBQUUsQ0FBQyxLQUFtQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ25DLGtCQUFFLENBQUMsRUFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUVqQyxnQ0FBZ0M7UUFDL0IsdUJBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3hDLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ3JDLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ3BDLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQy9CLFNBQVMsRUFBRSxJ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QkFDdEIsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztnQkFDM0MsQ0FBQztnQkFDRCxPQUFPLElBQUksQ0FBQztZQUNkLENBQUMsQ0FBQztZQUNGLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ2YsQ0FBQyxDQUFDLENBQUM7UUFFSixNQUFNLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3RGLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvYWkvZW5naW5lcy9fX3Rlc3RzX18vVmlkZW9GcmFtZUV4dHJhY3Rvci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFZpZGVvRnJhbWVFeHRyYWN0b3IgfSBmcm9tICcuLi9WaWRlb0ZyYW1lRXh0cmFjdG9yJztcbmltcG9ydCBmZm1wZWcgZnJvbSAnZmx1ZW50LWZmbXBlZyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbi8vIE1vY2sgZmZtcGVnIGFuZCBmcy9wcm9taXNlc1xuamVzdC5tb2NrKCdmbHVlbnQtZmZtcGVnJyk7XG5qZXN0Lm1vY2soJ2ZzL3Byb21pc2VzJyk7XG5cbmRlc2NyaWJlKCdWaWRlb0ZyYW1lRXh0cmFjdG9yJywgKCkgPT4ge1xuICBsZXQgZXh0cmFjdG9yOiBWaWRlb0ZyYW1lRXh0cmFjdG9yO1xuICBjb25zdCBtb2NrRmZtcGVnUGF0aCA9ICcvdXNyL2Jpbi9mZm1wZWcnO1xuICBjb25zdCBtb2NrRmZwcm9iZVBhdGggPSAnL3Vzci9iaW4vZmZwcm9iZSc7XG4gIGNvbnN0IG1vY2tUZW1wRGlyID0gJy90bXAvdGVzdC10ZW1wJztcbiAgY29uc3QgbW9ja1ZpZGVvUGF0aCA9ICcvcGF0aC90by90ZXN0LXZpZGVvLm1wNCc7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZXh0cmFjdG9yID0gbmV3IFZpZGVvRnJhbWVFeHRyYWN0b3IobW9ja0ZmbXBlZ1BhdGgsIG1vY2tGZnByb2JlUGF0aCwgbW9ja1RlbXBEaXIpO1xuICAgIC8vIFJlc2V0IG1vY2tzXG4gICAgKGZmbXBlZyBhcyBqZXN0Lk1vY2tlZDx0eXBlb2YgZmZtcGVnPikubW9ja0NsZWFyKCk7XG4gICAgKGZzLm1rZGlyIGFzIGplc3QuTW9jaykubW9ja0NsZWFyKCk7XG4gICAgKGZzLnJtIGFzIGplc3QuTW9jaykubW9ja0NsZWFyKCk7XG5cbiAgICAvLyBNb2NrIGZmbXBlZyBjaGFpbmFibGUgbWV0aG9kc1xuICAgIChmZm1wZWcgYXMgYW55KS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICAgIHNlZWtJbnB1dDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBkdXJhdGlvbjogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBmcHM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgYWRkT3B0aW9uOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIG91dHB1dDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBub1ZpZGVvOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGF1ZGlvQ29kZWM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgb246IGplc3QuZm4oKGV2ZW50LCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBpZiAoZXZlbnQgPT09ICdlbmQnKSB7XG4gICAgICAgICAgLy8gU2ltdWxhdGUgc3VjY2Vzc2Z1bCBlbmRcbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50ID09PSAnZmlsZW5hbWVzJykge1xuICAgICAgICAgIC8vIFNpbXVsYXRlIGZpbGVuYW1lcyBiZWluZyBlbWl0dGVkXG4gICAgICAgICAgY2FsbGJhY2soWydmcmFtZS0wLjAwMC5wbmcnLCAnZnJhbWUtMS4wMDAucG5nJ10pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfSksXG4gICAgICBydW46IGplc3QuZm4oKSxcbiAgICB9KSk7XG5cbiAgICAvLyBNb2NrIGZmcHJvYmVcbiAgICAoZmZtcGVnLmZmcHJvYmUgYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb24oKF9wYXRoLCBjYWxsYmFjaykgPT4ge1xuICAgICAgY2FsbGJhY2sobnVsbCwgeyBmb3JtYXQ6IHsgZHVyYXRpb246IDEwIH0gfSk7IC8vIE1vY2sgdmlkZW8gZHVyYXRpb25cbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBleHRyYWN0IGZyYW1lcyB3aXRoIGRlZmF1bHQgb3B0aW9ucycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB7IGZyYW1lcywgYXVkaW8gfSA9IGF3YWl0IGV4dHJhY3Rvci5leHRyYWN0KG1vY2tWaWRlb1BhdGgpO1xuXG4gICAgZXhwZWN0KGZzLm1rZGlyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZyhtb2NrVGVtcERpciksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIGV4cGVjdChmZm1wZWcpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKG1vY2tWaWRlb1BhdGgpO1xuICAgIGV4cGVjdCgoZmZtcGVnIGFzIGFueSkubW9jay5yZXN1bHRzWzBdLnZhbHVlLmZwcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoMSk7IC8vIERlZmF1bHQgZnBzXG4gICAgZXhwZWN0KChmZm1wZWcgYXMgYW55KS5tb2NrLnJlc3VsdHNbMF0udmFsdWUub3V0cHV0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygnZnJhbWUtJXMucG5nJykpO1xuICAgIGV4cGVjdCgoZmZtcGVnIGFzIGFueSkubW9jay5yZXN1bHRzWzBdLnZhbHVlLnJ1bikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChmcmFtZXMubGVuZ3RoKS50b0JlKDIpO1xuICAgIGV4cGVjdChmcmFtZXNbMF0uZnJhbWVQYXRoKS50b0NvbnRhaW4oJ2ZyYW1lLTAuMDAwLnBuZycpO1xuICAgIGV4cGVjdChmcmFtZXNbMV0uZnJhbWVQYXRoKS50b0NvbnRhaW4oJ2ZyYW1lLTEuMDAwLnBuZycpO1xuICAgIGV4cGVjdChhdWRpbykudG9CZVVuZGVmaW5lZCgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGV4dHJhY3QgZnJhbWVzIHdpdGggc3BlY2lmaWVkIGZyYW1lUmF0ZScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBleHRyYWN0b3IuZXh0cmFjdChtb2NrVmlkZW9QYXRoLCB7IGZyYW1lUmF0ZTogNSB9KTtcbiAgICBleHBlY3QoKGZmbXBlZyBhcyBhbnkpLm1vY2sucmVzdWx0c1swXS52YWx1ZS5mcHMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDUpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGV4dHJhY3QgZnJhbWVzIHdpdGggc3BlY2lmaWVkIGludGVydmFsJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGV4dHJhY3Rvci5leHRyYWN0KG1vY2tWaWRlb1BhdGgsIHsgaW50ZXJ2YWw6IDIgfSk7XG4gICAgZXhwZWN0KChmZm1wZWcgYXMgYW55KS5tb2NrLnJlc3VsdHNbMF0udmFsdWUuYWRkT3B0aW9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnLXZmJywgJ2Zwcz0xLzInKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBleHRyYWN0IGF1ZGlvIHdoZW4gZXh0cmFjdEF1ZGlvIGlzIHRydWUnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgeyBhdWRpbyB9ID0gYXdhaXQgZXh0cmFjdG9yLmV4dHJhY3QobW9ja1ZpZGVvUGF0aCwgeyBleHRyYWN0QXVkaW86IHRydWUgfSk7XG4gICAgZXhwZWN0KGF1ZGlvKS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChhdWRpbz8uYXVkaW9QYXRoKS50b0NvbnRhaW4oJ2F1ZGlvLScpO1xuICAgIGV4cGVjdChhdWRpbz8uYXVkaW9QYXRoKS50b0NvbnRhaW4oJy5tcDMnKTtcbiAgICBleHBlY3QoYXVkaW8/LmR1cmF0aW9uKS50b0JlKDEwKTtcbiAgICBleHBlY3QoKGZmbXBlZyBhcyBhbnkpLm1vY2sucmVzdWx0c1sxXS52YWx1ZS5ub1ZpZGVvKS50b0hhdmVCZWVuQ2FsbGVkKCk7IC8vIFNlY29uZCBmZm1wZWcgY2FsbCBmb3IgYXVkaW9cbiAgICBleHBlY3QoKGZmbXBlZyBhcyBhbnkpLm1vY2sucmVzdWx0c1sxXS52YWx1ZS5hdWRpb0NvZGVjKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbGlibXAzbGFtZScpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNsZWFuIHVwIHRlbXBvcmFyeSBkaXJlY3RvcnknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgdGVtcERpclRvQ2xlYW4gPSAnL3RtcC9zb21lLXRlbXAtZGlyJztcbiAgICBhd2FpdCBleHRyYWN0b3IuY2xlYW51cCh0ZW1wRGlyVG9DbGVhbik7XG4gICAgZXhwZWN0KGZzLnJtKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh0ZW1wRGlyVG9DbGVhbiwgeyByZWN1cnNpdmU6IHRydWUsIGZvcmNlOiB0cnVlIH0pO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGhhbmRsZSBmZm1wZWcgZXJyb3JzIGR1cmluZyBmcmFtZSBleHRyYWN0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIChmZm1wZWcgYXMgYW55KS5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+ICh7XG4gICAgICBzZWVrSW5wdXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgZHVyYXRpb246IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgZnBzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGFkZE9wdGlvbjogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBvdXRwdXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgb246IGplc3QuZm4oKGV2ZW50LCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBpZiAoZXZlbnQgPT09ICdlcnJvcicpIHtcbiAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ2ZmbXBlZyB0ZXN0IGVycm9yJykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfSksXG4gICAgICBydW46IGplc3QuZm4oKSxcbiAgICB9KSk7XG5cbiAgICBhd2FpdCBleHBlY3QoZXh0cmFjdG9yLmV4dHJhY3QobW9ja1ZpZGVvUGF0aCkpLnJlamVjdHMudG9UaHJvdygnZmZtcGVnIHRlc3QgZXJyb3InKTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==