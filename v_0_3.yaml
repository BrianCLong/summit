# ────────────────────────────────────────────────────────────────────────────────
# MC v0.3.5 Observability Enhancements
# 1) Grafana tiles: composite canary score, JWS failure SLO, Budget v2 noise
# 2) Prometheus recording rules & alerts for the new SLOs/metrics
# ────────────────────────────────────────────────────────────────────────────────
---
kind: file
name: observability/grafana/dashboards/mc-v035-tiles.json
content: |
  {
    "schemaVersion": 39,
    "title": "MC v0.3.5 Tiles — Adaptive · Attest · Budget",
    "refresh": "10s",
    "tags": ["mc","v0.3.5","adaptive","attest","budget"],
    "templating": {"list": [
      {"type":"datasource","name":"DS_PROM","query":"prometheus","label":"Prometheus"},
      {"type":"query","name":"tenant","label":"Tenant","datasource":"$DS_PROM","query":"label_values(mc_autonomy_success_total, tenant)","includeAll":true},
      {"type":"constant","name":"svc","label":"Service","query":"agent-workbench"}
    ]},
    "panels": [
      {
        "type": "stat",
        "title": "Composite Canary Score",
        "gridPos": {"w":8,"h":4,"x":0,"y":0},
        "datasource": "$DS_PROM",
        "targets": [{"expr": "mc_canary_composite_score{service='$svc'}"}],
        "options": {
          "reduceOptions": {"calcs":["lastNotNull"]},
          "colorMode": "value",
          "thresholds": {"mode":"absolute","steps":[
            {"color":"#d93f0b","value":0.0},
            {"color":"#f2cc0c","value":0.7},
            {"color":"#56A64B","value":0.85}
          ]}
        }
      },
      {
        "type": "timeseries",
        "title": "Composite Score (10m window)",
        "gridPos": {"w":16,"h":6,"x":8,"y":0},
        "datasource": "$DS_PROM",
        "targets": [{"expr": "mc_canary_composite_score{service='$svc'}"}]
      },
      {
        "type": "stat",
        "title": "JWS Failure Rate (15m)",
        "gridPos": {"w":8,"h":4,"x":0,"y":4},
        "datasource": "$DS_PROM",
        "targets": [{"expr": "100 * mc_attest_jws_failure_rate_15m{service='$svc',tenant=~'$tenant'}"}],
        "options": {
          "reduceOptions": {"calcs":["lastNotNull"]},
          "thresholds": {"mode":"absolute","steps":[
            {"color":"#d93f0b","value":0.1},
            {"color":"#56A64B","value":0.0}
          ]},
          "fieldOptions": {"min":0,"max":5}
        }
      },
      {
        "type": "timeseries",
        "title": "JWS Attempts/Failures",
        "gridPos": {"w":16,"h":6,"x":8,"y":4},
        "datasource": "$DS_PROM",
        "targets": [
          {"expr": "sum(rate(mc_attest_jws_fail_total{service='$svc',tenant=~'$tenant'}[5m]))"},
          {"expr": "sum(rate(mc_attest_jws_attempt_total{service='$svc',tenant=~'$tenant'}[5m]))"}
        ]
      },
      {
        "type": "stat",
        "title": "Budget v2 Noise (FP %) (15m)",
        "gridPos": {"w":8,"h":4,"x":0,"y":10},
        "datasource": "$DS_PROM",
        "targets": [{"expr": "100 * mc_budget_v2_noise_fp_rate_15m{service='$svc',tenant=~'$tenant'}"}],
        "options": {
          "reduceOptions": {"calcs":["lastNotNull"]},
          "thresholds": {"mode":"absolute","steps":[
            {"color":"#d93f0b","value":5},
            {"color":"#56A64B","value":0}
          ]}
        }
      },
      {
        "type": "timeseries",
        "title": "Budget Throttle Events (TP/FP per 5m)",
        "gridPos": {"w":16,"h":6,"x":8,"y":10},
        "datasource": "$DS_PROM",
        "targets": [
          {"expr": "sum(rate(mc_budget_throttle_tp_total{service='$svc',tenant=~'$tenant'}[5m]))"},
          {"expr": "sum(rate(mc_budget_throttle_fp_total{service='$svc',tenant=~'$tenant'}[5m]))"}
        ]
      }
    ]
  }
---
kind: file
name: prom/rules/mc-v035-recording.rules.yaml
content: |
  groups:
    - name: mc-v035-recording
      interval: 15s
      rules:
        # JWS failure rate over 15m
        - record: mc_attest_jws_failure_rate_15m
          expr: |
            sum(rate(mc_attest_jws_fail_total[15m]))
            /
            clamp_min(sum(rate(mc_attest_jws_attempt_total[15m])), 1)

        # Budget v2 noise (false-positive) rate over 15m
        - record: mc_budget_v2_noise_fp_rate_15m
          expr: |
            sum(rate(mc_budget_throttle_fp_total[15m]))
            /
            clamp_min(sum(rate(mc_budget_throttle_total[15m])), 1)

        # Optional composite score passthrough (if controller exports it)
        # Else, you can replace this with a computed score from p95, error, cost, p99.
        - record: mc_canary_composite_score
          expr: clamp_max(max(mc_canary_composite_score), 1)
---
kind: file
name: prom/alerts/mc-v035-slo.alerts.yaml
content: |
  groups:
    - name: mc-v035-slo-alerts
      interval: 30s
      rules:
        - alert: AttestationJWSFailureBudget
          expr: mc_attest_jws_failure_rate_15m > 0.001
          for: 15m
          labels:
            severity: page
            service: agent-workbench
            slo: jws-failure-rate
          annotations:
            summary: "JWS attestation failures >0.1%"
            description: |
              JWS failure rate over 15m is {{ $value | printf "%.4f" }} (>0.1%).
              Investigate signing/verification pipeline, JWKS, and response attestations.

        - alert: BudgetV2NoiseHigh
          expr: mc_budget_v2_noise_fp_rate_15m > 0.05
          for: 15m
          labels:
            severity: warn
            service: agent-workbench
            slo: budget-noise
          annotations:
            summary: "Budget v2 false-positive rate >5%"
            description: |
              Budget v2 noise (FP) rate is {{ $value | printf "%.2%" }} over 15m.
              Tune ML thresholds/dampening or fall back to static budgets.

        - alert: CanaryCompositeScoreLow
          expr: mc_canary_composite_score < 0.85
          for: 10m
          labels:
            severity: page
            service: agent-workbench
            slo: canary-composite
          annotations:
            summary: "Composite canary score below promote threshold"
            description: |
              Composite score is {{ $value | printf "%.2f" }} (<0.85). Auto‑HOLD expected.
              Inspect p95/error/cost/p99 contributors and extend bake or roll back.
---
kind: file
name: observability/README-v035-tiles.md
content: |
  # v0.3.5 Observability Tiles — How to Enable

  ## 1) Load recording rules & alerts
  ```bash
  promtool check rules prom/rules/mc-v035-recording.rules.yaml
  promtool check rules prom/alerts/mc-v035-slo.alerts.yaml
  # Apply via your Prometheus config reloader or ConfigMap update
  ```

  ## 2) Import the dashboard
  ```bash
  scripts/import-grafana-dashboard.sh https://grafana.example.com $GRAFANA_TOKEN \
    < observability/grafana/dashboards/mc-v035-tiles.json
  ```

  ## 3) Expected metrics
  - `mc_canary_composite_score` (exported by adaptive canary controller)
  - `mc_attest_jws_fail_total`, `mc_attest_jws_attempt_total`
  - `mc_budget_throttle_total`, `mc_budget_throttle_fp_total`, `mc_budget_throttle_tp_total`

  ## 4) SLOs
  - JWS failure rate < 0.1% over 15m (page otherwise)
  - Budget v2 noise (FP) < 5% over 15m (warn otherwise)
  - Composite score ≥ 0.85 (page if lower for 10m)
