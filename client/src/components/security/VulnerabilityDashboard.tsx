/**
 * Vulnerability Management Dashboard
 * @module client/src/components/security/VulnerabilityDashboard
 *
 * Air-gapped vulnerability management dashboard with SBOM viewing,
 * vulnerability tracking, and compliance reporting.
 */

import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Grid,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Chip,
  LinearProgress,
  Alert,
  Button,
  Tab,
  Tabs,
  IconButton,
  Tooltip,
  TextField,
  InputAdornment,
  CircularProgress,
} from '@mui/material';
import {
  Security as SecurityIcon,
  Warning as WarningIcon,
  Error as ErrorIcon,
  CheckCircle as CheckCircleIcon,
  Refresh as RefreshIcon,
  Search as SearchIcon,
  Download as DownloadIcon,
  TrendingUp as TrendingUpIcon,
  TrendingDown as TrendingDownIcon,
  Description as DescriptionIcon,
} from '@mui/icons-material';

// Types
interface VulnerabilitySummary {
  totalScans: number;
  totalVulnerabilities: number;
  criticalCount: number;
  highCount: number;
  mediumCount: number;
  lowCount: number;
  fixableCount: number;
  sbomCount: number;
  attestationCount: number;
  lastScanTime?: string;
  policyPassRate: number;
}

interface Vulnerability {
  id: string;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'unknown';
  title: string;
  affectedPackages: string[];
  cvssScore?: number;
  fixedVersions: Record<string, string>;
  exploitAvailable?: boolean;
  cisaKev?: boolean;
}

interface SBOMEntry {
  id: string;
  name: string;
  version: string;
  timestamp: string;
  componentCount: number;
  digest: string;
  signatureValid?: boolean;
  attestationId?: string;
  vulnerabilities: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
}

interface ScanHistoryEntry {
  id: string;
  timestamp: string;
  target: string;
  scanner: string;
  status: 'success' | 'failed' | 'partial';
  duration: number;
  summary: {
    total: number;
    critical: number;
    high: number;
    medium: number;
    low: number;
    fixable: number;
  };
  policyPassed: boolean;
}

interface TrendDataPoint {
  date: string;
  critical: number;
  high: number;
  medium: number;
  low: number;
}

interface DashboardData {
  summary: VulnerabilitySummary;
  recentScans: ScanHistoryEntry[];
  sboms: SBOMEntry[];
  topVulnerabilities: Vulnerability[];
  trendData: TrendDataPoint[];
}

// Severity colors
const severityColors = {
  critical: '#d32f2f',
  high: '#f57c00',
  medium: '#fbc02d',
  low: '#388e3c',
  unknown: '#9e9e9e',
};

// API functions
const fetchDashboardData = async (): Promise<DashboardData> => {
  const response = await fetch('/api/security/dashboard');
  if (!response.ok) throw new Error('Failed to fetch dashboard data');
  return response.json();
};

const searchVulnerabilities = async (query: string): Promise<Vulnerability[]> => {
  const response = await fetch(`/api/security/vulnerabilities?package=${encodeURIComponent(query)}`);
  if (!response.ok) throw new Error('Failed to search vulnerabilities');
  const data = await response.json();
  return data.vulnerabilities;
};

// Components
interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel({ children, value, index }: TabPanelProps) {
  return (
    <div role="tabpanel" hidden={value !== index}>
      {value === index && <Box sx={{ pt: 2 }}>{children}</Box>}
    </div>
  );
}

interface SeverityChipProps {
  severity: Vulnerability['severity'];
  count?: number;
}

function SeverityChip({ severity, count }: SeverityChipProps) {
  return (
    <Chip
      label={count !== undefined ? `${severity.toUpperCase()}: ${count}` : severity.toUpperCase()}
      size="small"
      sx={{
        backgroundColor: severityColors[severity],
        color: 'white',
        fontWeight: 'bold',
      }}
    />
  );
}

interface StatCardProps {
  title: string;
  value: number | string;
  icon: React.ReactNode;
  color?: string;
  trend?: 'up' | 'down' | 'stable';
  subtitle?: string;
}

function StatCard({ title, value, icon, color = '#1976d2', trend, subtitle }: StatCardProps) {
  return (
    <Card sx={{ height: '100%' }}>
      <CardContent>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
          <Box>
            <Typography color="textSecondary" variant="body2" gutterBottom>
              {title}
            </Typography>
            <Typography variant="h4" sx={{ color, fontWeight: 'bold' }}>
              {value}
            </Typography>
            {subtitle && (
              <Typography variant="caption" color="textSecondary">
                {subtitle}
              </Typography>
            )}
          </Box>
          <Box sx={{ color, opacity: 0.8 }}>
            {icon}
            {trend && (
              <Box sx={{ mt: 1, display: 'flex', justifyContent: 'center' }}>
                {trend === 'up' && <TrendingUpIcon color="error" fontSize="small" />}
                {trend === 'down' && <TrendingDownIcon color="success" fontSize="small" />}
              </Box>
            )}
          </Box>
        </Box>
      </CardContent>
    </Card>
  );
}

// Main Dashboard Component
export function VulnerabilityDashboard() {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<DashboardData | null>(null);
  const [tabValue, setTabValue] = useState(0);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<Vulnerability[] | null>(null);
  const [searching, setSearching] = useState(false);

  const loadData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const dashboardData = await fetchDashboardData();
      setData(dashboardData);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load data');
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const handleSearch = async () => {
    if (!searchQuery.trim()) {
      setSearchResults(null);
      return;
    }

    try {
      setSearching(true);
      const results = await searchVulnerabilities(searchQuery);
      setSearchResults(results);
    } catch (err) {
      console.error('Search failed:', err);
    } finally {
      setSearching(false);
    }
  };

  const handleExportReport = async () => {
    try {
      const response = await fetch('/api/security/compliance-report');
      const report = await response.json();
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `compliance-report-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error('Export failed:', err);
    }
  };

  if (loading && !data) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 400 }}>
        <CircularProgress />
      </Box>
    );
  }

  if (error) {
    return (
      <Alert severity="error" action={<Button onClick={loadData}>Retry</Button>}>
        {error}
      </Alert>
    );
  }

  if (!data) return null;

  const { summary, recentScans, sboms, topVulnerabilities, trendData } = data;

  return (
    <Box sx={{ p: 3 }}>
      {/* Header */}
      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
          <SecurityIcon sx={{ fontSize: 40, color: 'primary.main' }} />
          <Box>
            <Typography variant="h4">Vulnerability Management</Typography>
            <Typography variant="body2" color="textSecondary">
              Air-Gapped Security Dashboard
            </Typography>
          </Box>
        </Box>
        <Box sx={{ display: 'flex', gap: 1 }}>
          <Tooltip title="Export Compliance Report">
            <IconButton onClick={handleExportReport}>
              <DownloadIcon />
            </IconButton>
          </Tooltip>
          <Tooltip title="Refresh">
            <IconButton onClick={loadData} disabled={loading}>
              <RefreshIcon />
            </IconButton>
          </Tooltip>
        </Box>
      </Box>

      {/* Summary Cards */}
      <Grid container spacing={2} sx={{ mb: 3 }}>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard
            title="Critical Vulnerabilities"
            value={summary.criticalCount}
            icon={<ErrorIcon sx={{ fontSize: 40 }} />}
            color={severityColors.critical}
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard
            title="High Vulnerabilities"
            value={summary.highCount}
            icon={<WarningIcon sx={{ fontSize: 40 }} />}
            color={severityColors.high}
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard
            title="Policy Pass Rate"
            value={`${summary.policyPassRate.toFixed(1)}%`}
            icon={<CheckCircleIcon sx={{ fontSize: 40 }} />}
            color={summary.policyPassRate >= 90 ? '#388e3c' : '#f57c00'}
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard
            title="SBOMs Generated"
            value={summary.sbomCount}
            icon={<DescriptionIcon sx={{ fontSize: 40 }} />}
            subtitle={`${summary.attestationCount} attested`}
          />
        </Grid>
      </Grid>

      {/* Vulnerability Breakdown */}
      <Card sx={{ mb: 3 }}>
        <CardContent>
          <Typography variant="h6" gutterBottom>
            Vulnerability Summary
          </Typography>
          <Grid container spacing={2}>
            <Grid item xs={12} md={8}>
              <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                <SeverityChip severity="critical" count={summary.criticalCount} />
                <SeverityChip severity="high" count={summary.highCount} />
                <SeverityChip severity="medium" count={summary.mediumCount} />
                <SeverityChip severity="low" count={summary.lowCount} />
              </Box>
              <Box sx={{ mt: 2 }}>
                <Typography variant="body2" color="textSecondary">
                  Fixable: {summary.fixableCount} / {summary.totalVulnerabilities}
                </Typography>
                <LinearProgress
                  variant="determinate"
                  value={(summary.fixableCount / Math.max(summary.totalVulnerabilities, 1)) * 100}
                  sx={{ mt: 1, height: 8, borderRadius: 4 }}
                />
              </Box>
            </Grid>
            <Grid item xs={12} md={4}>
              <Typography variant="body2" color="textSecondary">
                Last Scan: {summary.lastScanTime ? new Date(summary.lastScanTime).toLocaleString() : 'Never'}
              </Typography>
              <Typography variant="body2" color="textSecondary">
                Total Scans: {summary.totalScans}
              </Typography>
            </Grid>
          </Grid>
        </CardContent>
      </Card>

      {/* Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
        <Tabs value={tabValue} onChange={(_, v) => setTabValue(v)}>
          <Tab label="Top Vulnerabilities" />
          <Tab label="Recent Scans" />
          <Tab label="SBOMs" />
          <Tab label="Search" />
        </Tabs>
      </Box>

      {/* Top Vulnerabilities Tab */}
      <TabPanel value={tabValue} index={0}>
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>ID</TableCell>
                <TableCell>Severity</TableCell>
                <TableCell>Title</TableCell>
                <TableCell>CVSS</TableCell>
                <TableCell>Affected Packages</TableCell>
                <TableCell>Flags</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {topVulnerabilities.map((vuln) => (
                <TableRow key={vuln.id} hover>
                  <TableCell>
                    <Typography variant="body2" sx={{ fontFamily: 'monospace' }}>
                      {vuln.id}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <SeverityChip severity={vuln.severity} />
                  </TableCell>
                  <TableCell>{vuln.title}</TableCell>
                  <TableCell>{vuln.cvssScore?.toFixed(1) || '-'}</TableCell>
                  <TableCell>
                    <Typography variant="body2" noWrap sx={{ maxWidth: 200 }}>
                      {vuln.affectedPackages.join(', ')}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Box sx={{ display: 'flex', gap: 0.5 }}>
                      {vuln.exploitAvailable && (
                        <Chip label="Exploit" size="small" color="error" variant="outlined" />
                      )}
                      {vuln.cisaKev && (
                        <Chip label="KEV" size="small" color="warning" variant="outlined" />
                      )}
                      {Object.keys(vuln.fixedVersions).length > 0 && (
                        <Chip label="Fix Available" size="small" color="success" variant="outlined" />
                      )}
                    </Box>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      </TabPanel>

      {/* Recent Scans Tab */}
      <TabPanel value={tabValue} index={1}>
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Timestamp</TableCell>
                <TableCell>Target</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Vulnerabilities</TableCell>
                <TableCell>Policy</TableCell>
                <TableCell>Duration</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {recentScans.map((scan) => (
                <TableRow key={scan.id} hover>
                  <TableCell>{new Date(scan.timestamp).toLocaleString()}</TableCell>
                  <TableCell>
                    <Typography variant="body2" sx={{ fontFamily: 'monospace' }}>
                      {scan.target}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={scan.status}
                      size="small"
                      color={scan.status === 'success' ? 'success' : scan.status === 'failed' ? 'error' : 'warning'}
                    />
                  </TableCell>
                  <TableCell>
                    <Box sx={{ display: 'flex', gap: 0.5 }}>
                      {scan.summary.critical > 0 && <SeverityChip severity="critical" count={scan.summary.critical} />}
                      {scan.summary.high > 0 && <SeverityChip severity="high" count={scan.summary.high} />}
                      {scan.summary.medium > 0 && <SeverityChip severity="medium" count={scan.summary.medium} />}
                    </Box>
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={scan.policyPassed ? 'Passed' : 'Failed'}
                      size="small"
                      color={scan.policyPassed ? 'success' : 'error'}
                    />
                  </TableCell>
                  <TableCell>{(scan.duration / 1000).toFixed(1)}s</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      </TabPanel>

      {/* SBOMs Tab */}
      <TabPanel value={tabValue} index={2}>
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Name</TableCell>
                <TableCell>Version</TableCell>
                <TableCell>Generated</TableCell>
                <TableCell>Components</TableCell>
                <TableCell>Vulnerabilities</TableCell>
                <TableCell>Status</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {sboms.map((sbom) => (
                <TableRow key={sbom.id} hover>
                  <TableCell>
                    <Typography variant="body2" fontWeight="medium">
                      {sbom.name}
                    </Typography>
                  </TableCell>
                  <TableCell>{sbom.version}</TableCell>
                  <TableCell>{new Date(sbom.timestamp).toLocaleString()}</TableCell>
                  <TableCell>{sbom.componentCount}</TableCell>
                  <TableCell>
                    <Box sx={{ display: 'flex', gap: 0.5 }}>
                      {sbom.vulnerabilities.critical > 0 && (
                        <SeverityChip severity="critical" count={sbom.vulnerabilities.critical} />
                      )}
                      {sbom.vulnerabilities.high > 0 && (
                        <SeverityChip severity="high" count={sbom.vulnerabilities.high} />
                      )}
                    </Box>
                  </TableCell>
                  <TableCell>
                    <Box sx={{ display: 'flex', gap: 0.5 }}>
                      {sbom.signatureValid && (
                        <Chip label="Signed" size="small" color="success" variant="outlined" />
                      )}
                      {sbom.attestationId && (
                        <Chip label="Attested" size="small" color="primary" variant="outlined" />
                      )}
                    </Box>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      </TabPanel>

      {/* Search Tab */}
      <TabPanel value={tabValue} index={3}>
        <Box sx={{ mb: 2 }}>
          <TextField
            fullWidth
            placeholder="Search by package name..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <SearchIcon />
                </InputAdornment>
              ),
              endAdornment: searching && (
                <InputAdornment position="end">
                  <CircularProgress size={20} />
                </InputAdornment>
              ),
            }}
          />
        </Box>

        {searchResults && (
          <TableContainer component={Paper}>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>ID</TableCell>
                  <TableCell>Severity</TableCell>
                  <TableCell>Title</TableCell>
                  <TableCell>CVSS</TableCell>
                  <TableCell>Fix Available</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {searchResults.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={5} align="center">
                      No vulnerabilities found
                    </TableCell>
                  </TableRow>
                ) : (
                  searchResults.map((vuln) => (
                    <TableRow key={vuln.id} hover>
                      <TableCell sx={{ fontFamily: 'monospace' }}>{vuln.id}</TableCell>
                      <TableCell>
                        <SeverityChip severity={vuln.severity} />
                      </TableCell>
                      <TableCell>{vuln.title}</TableCell>
                      <TableCell>{vuln.cvssScore?.toFixed(1) || '-'}</TableCell>
                      <TableCell>
                        {Object.keys(vuln.fixedVersions).length > 0 ? (
                          <CheckCircleIcon color="success" />
                        ) : (
                          '-'
                        )}
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
          </TableContainer>
        )}
      </TabPanel>
    </Box>
  );
}

export default VulnerabilityDashboard;
