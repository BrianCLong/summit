name: Post-deploy validation

on:
  deployment_status:

permissions:
  contents: read
  pull-requests: write
  deployments: read

jobs:
  smoke-and-load:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install --workspaces

      - name: Run smoke tests
        id: smoke
        run: npm run smoke
        continue-on-error: true

      - name: Run load tests
        id: load
        run: npm run load
        continue-on-error: true

      - name: Publish PR status comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const statuses = {
              smoke: '${{ steps.smoke.outcome }}',
              load: '${{ steps.load.outcome }}',
            };
            const icons = { success: '✅', failure: '❌', cancelled: '⚠️' };
            const sha = context.payload.deployment?.sha ?? context.sha;
            const prs = await github.paginate(
              github.rest.repos.listPullRequestsAssociatedWithCommit,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: sha,
              },
            );
            const body = [
              `Post-deploy smoke/load validation for ${sha.slice(0, 7)}:`,
              `- Smoke: ${icons[statuses.smoke] ?? '⚠️'} (${statuses.smoke})`,
              `- Load: ${icons[statuses.load] ?? '⚠️'} (${statuses.load})`,
            ].join('\n');

            if (prs.length === 0) {
              core.info('No PRs associated with this deployment commit; skipping comment.');
              return;
            }

            for (const pr of prs) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body,
              });
            }
