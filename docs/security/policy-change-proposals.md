# Policy Change Proposal Specification

## Overview

A **Policy Change Proposal** is a structured artifact generated by the Policy Auto-Tuning Engine. It represents a suggested modification to the system's security configuration or policy files. Proposals are **never automatically applied**; they must be reviewed and approved by a human operator (or a high-level governance bot) and then applied via a standard Pull Request workflow.

## Data Model

The core data model is defined in `server/src/policy-engine/proposal-types.ts` using Zod schemas.

### `PolicyChangeProposal`

| Field | Type | Description |
| :--- | :--- | :--- |
| `id` | `string` | Unique identifier (UUID or deterministic hash). |
| `createdAt` | `datetime` | ISO 8601 timestamp. |
| `createdBy` | `string` | Identity of the creator (e.g., `system:policy-engine`). |
| `inputEvidenceRefs` | `string[]` | References to the alerts, incidents, or logs that triggered this proposal. |
| `rationale` | `string` | Human-readable explanation of *why* this change is proposed. |
| `machineRationale` | `object` | Structured data used by the engine (trigger type, confidence score, feature vectors). |
| `proposedChanges` | `ProposedChange[]` | List of specific mutations to configuration files. |
| `riskAssessment` | `RiskAssessment` | Evaluation of potential downside (blast radius, false positives). |
| `verification` | `Verification` | Instructions on how to verify the change works as expected. |
| `status` | `enum` | `proposed`, `approved`, `rejected`, `applied`. |

### `ProposedChange`

| Field | Type | Description |
| :--- | :--- | :--- |
| `target` | `string` | Relative path to the file being modified (e.g., `policy/allowlist.yaml`). |
| `keyPath` | `string` | Dot-notation path to the specific key (e.g., `exceptions[4]`). |
| `operation` | `enum` | `add`, `remove`, `replace`. |
| `value` | `any` | The new value to insert or set. |
| `originalValue` | `any` | (Optional) The value being replaced, for safety checks. |

## Workflow

1.  **Generation**: The engine analyzes `SecurityEvidence` (logs, metrics) and generates a `PolicyChangeProposal` with status `proposed`.
2.  **Storage**: The proposal is stored (e.g., as a JSON file in `.security/proposals/` or a database).
3.  **Review**: A human operator reviews the proposal via CLI or API.
4.  **Approval**: The operator approves the proposal (status -> `approved`).
5.  **Application**: A patch generator converts the `approved` proposal into a Git Diff or a Pull Request.
6.  **Merge**: Standard CI/CD checks run on the PR.

## Verification & Rollback

Every proposal must include:
*   **Verification Commands**: e.g., `curl -X POST ...` to confirm the new allowlist entry works.
*   **Rollback Steps**: Instructions to revert the change (usually `git revert`).

## Constraints

*   **Deterministic**: Running the engine on the same evidence must produce the same proposal ID and content.
*   **Safe**: Proposals cannot target protected files (e.g., source code, secrets).
*   **Auditable**: The chain of evidence from Alert -> Proposal -> Approval -> PR must be preserved.
