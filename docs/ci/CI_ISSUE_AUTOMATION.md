# CI Issue Automation

This repository uses automated scripts to identify and draft GitHub issues for regressing CI failures.

## Overview

The `weekly-ci-trends.yml` workflow runs weekly (Sunday 1 AM UTC) to analyze failure trends. If it identifies P0 or P1 failures with significant regression (high count, high delta), it generates issue drafts.

## Components

1.  **Trend Report**: A JSON report (`artifacts/ci-trends/report.json`) generated by the analysis phase (currently simulated).
2.  **Taxonomy**: `docs/ci/FAILURE_TAXONOMY.yml` defines known failure codes, categories, severities, and next steps.
3.  **Drafter Script**: `scripts/ci/draft_ci_failure_issues.mjs` parses the report and taxonomy to generate issues.
4.  **Policy**: `scripts/ci/ci_issue_policy.json` controls thresholds and execution mode (`draft` vs `apply`).

## Configuration

The behavior is controlled by `scripts/ci/ci_issue_policy.json`:

```json
{
  "ci_issue_automation": {
    "enabled": true,
    "mode": "draft",          // "draft" (files only) or "apply" (GitHub API)
    "min_count": 10,          // Minimum failures to trigger
    "min_regression_delta": 5, // Minimum increase vs last week
    "max_issues_per_week": 5  // Cap to prevent spam
  }
}
```

## Modes

*   **Draft Mode**: Generates Markdown files in `artifacts/ci-issues/drafts/` and a digest in `artifacts/ci-issues/digest.md`. No changes are made to GitHub Issues.
*   **Apply Mode**:
    *   Creates new issues for new failure codes.
    *   Updates existing open issues (matched by failure code) with the latest trend stats.

## How to use

1.  **Review Drafts**: Check the "CI Issue Automation Digest" in the workflow summary or download the `ci-issues-drafts` artifact.
2.  **Tune Taxonomy**: Add new known failure codes to `docs/ci/FAILURE_TAXONOMY.yml` to ensure they are categorized correctly.
3.  **Assign Owners**: Add mappings to `docs/ci/FAILURE_OWNERS.yml` (optional) to auto-assign owners in the issue body.

## Deduplication Logic

The automation avoids duplicates by searching for existing open issues with the label `ci-failure` and the failure code in the title or body (e.g., `[CI-INFRA-001]`). If found, it appends the new trend data instead of creating a new issue.
