# Redaction Health Badge

**Status:** Active (MVP-4)
**Owner:** Platform Engineering
**Last Updated:** 2026-01-08

---

## Overview

The Redaction Health Badge provides an at-a-glance status indicator for the Release Ops publication pipeline. It appears on:

- The Release Ops Single Page (markdown and HTML)
- The Pages landing index (`index.html`)

The badge shows one of three states:

| Level    | Badge | Meaning                                  |
| -------- | ----- | ---------------------------------------- |
| **OK**   | ✅    | No issues - safe to publish              |
| **WARN** | ⚠️    | Thresholds exceeded - review recommended |
| **FAIL** | ❌    | Critical - forbidden patterns detected   |

---

## What Triggers Each Level

### FAIL (Blocking)

A FAIL status means **forbidden patterns remain after sanitization**. This blocks Pages deployment.

Triggers:

- `forbidden_hits > 0` - Raw patterns detected in sanitized output

### WARN (Non-Blocking)

A WARN status means **threshold limits were exceeded**. This does not block deployment but indicates elevated risk.

Triggers:

- `tokens_redacted > 50` - High number of token redactions
- `internal_domains_redacted > 10` - Many internal domain references
- `issue_links_redacted > 100` - Many issue link redactions
- `pr_links_redacted > 25` - Many PR discussion link redactions
- Day-over-day spike exceeds 200% for any metric

### OK

An OK status means all checks passed and counts are within normal thresholds.

---

## Where It Appears

### Single Page (Markdown/HTML)

Appears after the header as a dedicated section:

```markdown
## Redaction Health

✅ **OK**

| Metric   | Value      |
| -------- | ---------- |
| Status   | OK         |
| Date     | 2026-01-08 |
| Triggers | none       |

**Reports:** [Diff Report](redaction_diff_report.md) | [Trend](redaction_metrics_trend.html)
```

### Pages Landing Index

Appears as a banner at the top of the page:

```
┌─────────────────────────────────────────────────┐
│  ✅ Redaction Health: OK        [View Report]   │
└─────────────────────────────────────────────────┘
```

With color coding:

- Green background for OK
- Yellow background for WARN
- Red background for FAIL

---

## Data Source

The badge is driven by `redaction_health.json`:

```json
{
  "version": "1.0",
  "level": "OK",
  "reasons": [],
  "date_utc": "2026-01-08",
  "run_id": 20806007405,
  "counts": {
    "forbidden_hits": 0,
    "tokens_redacted": 12,
    "domains_redacted": 4,
    "issue_links_redacted": 31,
    "pr_links_redacted": 8,
    "state_refs_redacted": 2,
    "run_ids_redacted": 15,
    "sections_collapsed": 4
  }
}
```

This file is generated by `scripts/release/compute_redaction_health.sh` and is **safe for public visibility** (contains only counts and codes, no raw patterns or sensitive strings).

---

## Generating Health Status

### During Build

The `build_release_ops_site.sh` script automatically generates `redaction_health.json` after redaction:

```bash
scripts/release/compute_redaction_health.sh \
  --diff-report site/release-ops/redaction_diff_report.json \
  --out site/release-ops/redaction_health.json
```

### Manual Generation

```bash
# From alert report
scripts/release/compute_redaction_health.sh \
  --alert-report site/release-ops/redaction_alert_report.json \
  --out health.json

# Output markdown badge
scripts/release/compute_redaction_health.sh \
  --diff-report report.json \
  --markdown
```

---

## Remediation

### For FAIL Status

1. **Do not force deploy** - FAIL blocks deployment for safety
2. **Check workflow logs** for which pattern was detected
3. **Run redaction tests locally**:
   ```bash
   scripts/release/tests/redaction_layer.test.sh --verbose
   ```
4. **Review recent changes** to:
   - Source content (new patterns introduced?)
   - Redaction policy (patterns missing?)
   - Allowlist (files changed?)
5. **Fix the issue** and re-run

### For WARN Status

1. **Review the counts** - is this expected?
2. **Check for new content** that increased redaction volume
3. **Adjust thresholds** only if justified and documented
4. **Monitor trends** over time for patterns

---

## Styling

### CSS Classes

```css
.health-ok {
  background: #dafbe1;
  color: #1a7f37;
  border: 1px solid #1a7f37;
}

.health-warn {
  background: #fff8c5;
  color: #9a6700;
  border: 1px solid #d4a72c;
}

.health-fail {
  background: #ffebe9;
  color: #cf222e;
  border: 1px solid #cf222e;
}

.health-unknown {
  background: #f6f8fa;
  color: #57606a;
  border: 1px solid #d0d7de;
}
```

---

## References

- **Health Script**: `scripts/release/compute_redaction_health.sh`
- **Time Series Collector**: `scripts/release/update_redaction_metrics_timeseries.sh`
- **Trend Renderer**: `scripts/release/render_redaction_metrics_trend.sh`
- **Single Page Generator**: `scripts/release/generate_release_ops_single_page.sh`
- **HTML Renderer**: `scripts/release/render_release_ops_single_page_html.mjs`
- **Build Script**: `scripts/release/build_release_ops_site.sh`
- **Redaction Documentation**: `docs/ci/RELEASE_OPS_REDACTION.md`
- **Trend Documentation**: `docs/ci/REDACTION_METRICS_TRENDS.md`

---

## Change History

| Version | Date       | Changes                             |
| ------- | ---------- | ----------------------------------- |
| 1.0.0   | 2026-01-08 | Initial health badge implementation |

---

**Document Authority**: Platform Engineering
**Next Review**: 2026-02-08 (or before MVP-5 kickoff)
