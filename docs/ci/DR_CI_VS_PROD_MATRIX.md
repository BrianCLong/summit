# DR: CI vs Production Parity Matrix

**Date:** 2025-12-03
**Purpose:** Define the gap between the Continuous Integration (CI) simulation of Disaster Recovery and the Real Production environment.

| Dimension               | CI Simulation (Node.js/Mock)                                              | Real Production (AWS)                                                                                  | Gap Analysis                                                                                                  | Mitigation Plan                                                                                           |
| :---------------------- | :------------------------------------------------------------------------ | :----------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------- |
| **Failover Trigger**    | **Mocked.** Script manually decides "Primary is down" and switches logic. | **Route53 + CloudFront.** Health checks fail (3x30s), DNS records update, CloudFront failover engages. | **High.** CI does not test DNS propagation, TTLs, or flappy health checks.                                    | Conduct "Game Days" in Staging using `aws route53 update-health-check` to force real failure.             |
| **Data Loss (RPO)**     | **Zero.** Memory state is passed instantly or perfectly via mock broker.  | **Replication Lag.** Aurora Global: < 1s typical. Redis Global: < 1s typical.                          | **Medium.** CI assumes perfect consistency. Prod has lag window where data is lost if Primary dies instantly. | Monitor `AuroraGlobalDBReplicationLag`. Application must tolerate small data loss (eventual consistency). |
| **Propagation**         | **Instant.** Mock broker is in-process.                                   | **Variable.** SNS Fanout + SQS Polling + Network Latency (50-200ms).                                   | **Low.** Logic handles out-of-order, but timing race conditions are harder to catch in CI.                    | Use `SnsMessageBroker` in Staging environment with real AWS credentials.                                  |
| **DNS / Client**        | **Ignored.** Script just calls function B instead of A.                   | **Cached.** Clients (Browsers, Mobile) cache DNS. Websockets drop.                                     | **High.** CI doesn't simulate browser behavior or broken pipes.                                               | Client-side E2E tests (Playwright) referencing the Failover URL.                                          |
| **Client Reconnection** | **N/A.**                                                                  | **Required.** JWTs may need re-validation. Websockets must reconnect to new region.                    | **Medium.** Session affinity (sticky sessions) breaks on failover.                                            | Ensure Auth tokens are stateless (JWT) and verify Redis Global replication of session data.               |
| **Observability**       | **Console Logs.** "Simulating failure..."                                 | **CloudWatch/Grafana.** Metrics, Alarms, PagerDuty.                                                    | **High.** We don't know if the Alarm actually fires until it happens.                                         | Use Terraform to deploy Alarms. Test Alarms using `aws cloudwatch set-alarm-state`.                       |

## Summary

The CI environment validates the **Business Logic of Recovery** (e.g., "Do we merge data correctly?"). It **cannot** validate the **Infrastructure Mechanics** (DNS, Latency, Storage).

**Verdict:** Rely on CI for Code. Rely on Scheduled Game Days (Weekly) for Infrastructure.
