# Test Strategy, Coverage, and Flake Governance Review - 2026-01-14

## 1. Test Health Ground Truth Snapshot

*   **Flake Registry:** Currently clean (0 quarantined tests).
    *   *Emerging Signal:* `server/tests/auth/flow.test.ts` showed 2 failures in last 50 runs (timing/race condition).
*   **Slow Suites:**
    *   `packages/ai-ml-suite` (Integration): ~45s
    *   `connectors/esri_connector` (Unit): ~15s (due to large fixture loading)
*   **Coverage Posture:**
    *   Server Core: High (>90%)
    *   Connectors: Variable. `stix-taxii` is high, `rss-news` is medium.
    *   **Gap:** "Node-Native Verification" (Track 2) is missing for the `connectors/` directory structure compliance.
*   **Tooling:**
    *   Dual-track strategy (Jest + `tsx/node:assert`) is working well.
    *   `pnpm verify` suite is stable.

## 2. Objectives

1.  **Preempt Flakiness in Auth Flow:** Refactor `server/tests/auth/flow.test.ts` to use explicit event waits instead of timeouts, eliminating the emerging flake signal.
2.  **Standardize Connector Verification:** Implement a new structural verification script (`server/scripts/verify-connector-structure.ts`) to enforce `registry.json` schema and file layout for all 13 connectors.
3.  **Optimize ESRI Test Performance:** Refactor ESRI connector tests to load fixtures lazily, targeting a 50% reduction in suite time.

## 3. Execution Plan

| Task ID | Prio | Agent | Category | Files Touched | Fix Strategy | Acceptance |
|:---|:---:|:---:|:---|:---|:---|:---|
| `TEST-20260114-01` | P1 | Codex CLI | Flake | `server/tests/auth/flow.test.ts` | Replace `sleep()` with `waitFor(event)` | 100 iterations without failure. |
| `TEST-20260114-02` | P1 | Antigravity | Governance | `server/scripts/verify-connector-structure.ts` | Create new script using `zod` or `ajv` | `pnpm verify` passes and catches bad registry entries. |
| `TEST-20260114-03` | P2 | Codex CLI | Performance | `connectors/esri_connector/__tests__/*` | Lazy-load large JSON fixtures | Suite time < 8s. |
| `TEST-20260114-04` | P3 | Claude Code | Coverage | `connectors/rss_news_connector/` | Add unit tests for content filters | Increased coverage > 80%. |

## 4. Decisions & Rationale

*   **Connector Governance:** As the number of connectors grows (13+), manual review of `registry.json` is error-prone. Automated structural verification (Track 2) is the correct solution.
*   **Auth Flake:** Even low-frequency flakes in auth are P1 because they block critical paths in development.
*   **No Quarantine:** We are not quarantining the auth test yet; we are fixing it forward immediately.

## 5. Cross-System Actions

*   [ ] **GitHub Projects:** Create "Connector Governance" card in Test Health lane.
*   [ ] **Linear:** Log `TEST-20260114-01` as a "Quality/Flake" task.
*   [ ] **Jira:** Create task for ESRI performance optimization.
*   [ ] **Notion:** Update `TESTING.md` to mention the new `verify-connector-structure.ts` script once added.
