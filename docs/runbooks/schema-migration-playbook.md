# Runbook: Schema Migrations

## Context

Use this runbook to apply or roll back PostgreSQL/Neo4j schema changes in the Summit stack. Migrations are driven from the `server` workspace and executed through the pnpm scripts wired into CI.

## Preconditions

- Local stack is running (`make up`) or target environment is reachable.
- Database connection strings are set in `.env` (generated by `make bootstrap`).
- Backups validated for the target environment.
- Migration scripts live alongside the service (`server/migrations` or `scripts/neo4j-migrate.js`).

## Steps: Apply a Migration

1. **Add migration files**
   - PostgreSQL: place files under `server/migrations/postgres/`.
   - Neo4j: update `scripts/neo4j-migrate.js` or add to `server/migrations/neo4j/`.
2. **Run locally against the dev stack**
   ```bash
   make up               # if services are not running
   pnpm db:migrate       # applies server migrations to Postgres
   pnpm db:neo4j:migrate # optional Neo4j migrations
   ```
3. **Seed and smoke test**
   ```bash
   pnpm db:seed
   make smoke            # validates the golden path post-migration
   ```
4. **Open PR with results**
   - Capture migration output and `make smoke` results in the PR description.
   - Ensure CI `make bootstrap && make up && make smoke` passes.
5. **Promote**
   - After approval and merge, allow CI/CD to run the same scripts in staging/production. Do not run ad-hoc SQL unless documented in the PR.

## Steps: Roll Back a Migration

1. **Assess trigger**
   - Roll back on failing health probes, golden path errors, or alerts tied to the deployment.
2. **Execute down scripts**
   ```bash
   pnpm db:knex:rollback   # Postgres down migrations
   # or
   pnpm db:neo4j:migrate   # apply the previous stable graph schema
   ```
3. **Re-seed or restore data if needed**
   ```bash
   pnpm db:seed
   ```
4. **Verification**
   - `make smoke` passes locally or in the target environment.
   - Health endpoints respond: `curl -sf http://localhost:4000/health`.
5. **Communicate**
   - Record the rollback reason and the migration IDs in the incident/PR thread.

## Common failures & fixes

- **Migrations hang because services are down**: ensure `make up` completed and databases are healthy before running pnpm commands.
- **Permission errors**: verify DB credentials in `.env` and that containers were restarted after edits (`make down && make up`).
- **Seed data fails after migration**: adjust seed scripts alongside schema changes and rerun `pnpm db:seed` before smoke tests.
- **Neo4j driver version mismatch**: run `make bootstrap` to refresh dependencies before re-attempting `pnpm db:neo4j:migrate`.
