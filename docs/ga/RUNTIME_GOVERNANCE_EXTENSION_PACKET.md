# Compliance Evidence Bundle Extension Packet: Runtime Governance Enforcement

## A) Evidence Items (new)

These items define the verifiable surface for Runtime Governance. They will be registered in `docs/ga/evidence_map.yml`.

| ID | Description | Path Template | Producer | Verifier | Required Fields (JSON) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `governance_verdict_schema_json` | JSON Schema definition for governance verdicts. | `artifacts/governance/runtime/${sha}/verdict_schema.json` | `scripts/governance/generate_schema.ts` | `json` | `definitions`, `$schema`, `type` |
| `runtime_governance_contract_doc` | Human-readable contract for runtime governance. | `artifacts/governance/runtime/${sha}/contract.md` | `cp docs/governance/runtime_control_map.md` | `exists` | N/A |
| `runtime_governance_boot_snapshot` | Snapshot of boot-time configuration & policy version. | `artifacts/governance/runtime/${sha}/boot_snapshot.json` | `scripts/governance/generate_boot_snapshot.ts` | `json` | `policy_version`, `kill_switch_state`, `timestamp` |
| `runtime_governance_stamp` | Cryptographic stamp proving governance checks ran. | `artifacts/governance/runtime/${sha}/governance.stamp` | `scripts/ci/governance_unified_gate.mjs` | `sha256` | N/A |
| `tenant_isolation_test_report` | Test results verifying tenant isolation enforcement. | `artifacts/governance/runtime/${sha}/tenant_isolation_report.json` | `pnpm test:governance:runtime` | `json` | `passed`, `failed`, `scenarios` |
| `kill_switch_test_report` | Test results verifying global kill switch functionality. | `artifacts/governance/runtime/${sha}/kill_switch_report.json` | `pnpm test:kill-switch` | `json` | `kill_switch_enabled`, `requests_blocked` |
| `policy_validation_stamp` | Validation result of the OPA/Governance policy bundle. | `artifacts/governance/runtime/${sha}/policy_validation.stamp` | `scripts/governance/validate_policy.sh` | `exists` | N/A |
| `runtime_governance_observability_contract_doc` | Documentation of required governance metrics/logs. | `artifacts/governance/runtime/${sha}/observability_contract.md` | `cp docs/ops/RUNTIME_GOVERNANCE_PACKET.md` | `exists` | N/A |
| `governance_metrics_snapshot` | Snapshot of governance metrics definitions. | `artifacts/governance/runtime/${sha}/metrics_snapshot.json` | `scripts/governance/dump_metrics.ts` | `json` | `metric_names`, `labels` |
| `drift_reconciliation_report` | Report on drift detection and reconciliation. | `artifacts/governance/runtime/${sha}/drift_report.json` | `scripts/release/reconcile_drift_issue.cjs` | `json` | `drift_detected`, `reconciled` |

## B) Producer Plan

This section details how each artifact is generated in CI.

1.  **Schema & Contracts**
    *   **Script:** `scripts/governance/generate_runtime_evidence.ts` (New Script)
    *   **Action:**
        *   Extracts `GovernanceVerdict` schema from `server/src/governance/types.ts` using `typescript-json-schema`.
        *   Copies `docs/governance/runtime_control_map.md` and `docs/ops/RUNTIME_GOVERNANCE_PACKET.md` to artifacts.
    *   **CI Job:** "Governance / Runtime Enforcement Tests"

2.  **Boot Snapshot & Stamps**
    *   **Script:** `scripts/governance/generate_boot_snapshot.ts` (New Script)
    *   **Action:** Simulates server boot, reads `docs/governance/policies/policy_version.txt`, checks Kill Switch env vars, outputs JSON.
    *   **Stamp:** Generated by `scripts/ci/governance_unified_gate.mjs` upon successful completion of checks.
    *   **CI Job:** "Governance / Unified Gate"

3.  **Test Reports (Tenant Isolation & Kill Switch)**
    *   **Command:** `pnpm test:governance:runtime` (New NPM Script)
    *   **Action:** Runs specific test suites (`tests/governance/tenant-isolation.test.ts`, `tests/governance/kill-switch.test.ts`) using `node:test` and a custom reporter that outputs JSON to `artifacts/governance/runtime/${sha}/`.
    *   **CI Job:** "Governance / Runtime Enforcement Tests"

4.  **Policy Validation**
    *   **Script:** Existing logic in `scripts/ci/governance_unified_gate.mjs` extended to touch `policy_validation.stamp` on success.
    *   **CI Job:** "Governance / Unified Gate"

5.  **Drift Report**
    *   **Script:** `scripts/release/reconcile_drift_issue.cjs` (Existing)
    *   **Action:** Update script to output a JSON summary to `artifacts/governance/runtime/${sha}/drift_report.json` in addition to its current issue handling.
    *   **CI Job:** "Governance - Branch Protection" (Note: This runs on separate triggers but artifacts should be accessible).

## C) Verifier Updates

We will implement a rigorous verifier `scripts/ga/verify_evidence_map.ts` (replacing or extending `verify-ga-surface.mjs`) that consumes `docs/ga/evidence_map.yml`.

**Verification Logic:**
1.  **Existence:** Check if file exists at `path` (resolving `${sha}`).
2.  **Type Check:**
    *   `json`: Parse as JSON. Fail if invalid.
    *   `sha256`: Verify file content matches expected hash (if provided) or just exists as a non-empty file.
    *   `exists`: Simple file presence check.
3.  **Content Validation:**
    *   For `json` types, check that all keys in `required_fields` are present and non-null.
    *   **Secret Scanning:** Run a heuristic scan on all new JSON artifacts to ensure no values match known secret patterns (e.g., `sk_live_`, `ghp_`).

**Updates to `docs/ga/evidence_map.yml`:**
*   Create this file as the master registry.
*   Structure:
    ```yaml
    evidence:
      - id: governance_verdict_schema_json
        path: artifacts/governance/runtime/${sha}/verdict_schema.json
        type: json
        required_fields: ["definitions", "$schema"]
      ...
    ```

## D) CI Wiring

We will wire these producers into `.github/workflows/ci.yml`.

**Job: Governance / Runtime Enforcement Tests**
*   **Step 1:** Install dependencies.
*   **Step 2:** Run `pnpm run generate:runtime-evidence` (calls `scripts/governance/generate_runtime_evidence.ts` & `generate_boot_snapshot.ts`).
*   **Step 3:** Run `pnpm run test:governance:runtime` (Isolation & Kill Switch tests).
*   **Step 4:** Upload Artifacts:
    ```yaml
    - uses: actions/upload-artifact@v4
      with:
        name: runtime-governance-evidence
        path: artifacts/governance/runtime/
    ```

**Job: Governance / Unified Gate**
*   **Step 1:** Depends on "Governance / Runtime Enforcement Tests".
*   **Step 2:** Download artifacts from previous job.
*   **Step 3:** Run `scripts/ci/governance_unified_gate.mjs`.
*   **Step 4:** Run `scripts/ga/verify_evidence_map.ts` to verify the bundle is complete and valid.
*   **Step 5:** Generate `runtime_governance_stamp`.
*   **Step 6:** Upload final stamped bundle.

## E) Documentation Update Plan

1.  **`docs/ga/evidence_map.yml` (New)**
    *   Create the authoritative YAML registry for all evidence items defined in Section A.

2.  **`docs/ga/RUNTIME_GOVERNANCE_EVIDENCE.md` (New)**
    *   Detailed explanation of what each evidence item proves, how to interpret the JSON reports, and how to verify the cryptographic stamps manually.

3.  **`docs/ga/verification-map.json` (Update)**
    *   Add entries for "Runtime Governance Enforcement" pointing to the new evidence items.

4.  **Release Captain Runbook**
    *   Update `docs/release_playbook/release_captain_runbook.md` to include a step: "Verify Runtime Governance Evidence Bundle" using the new verification script.

## F) PR Work Plan (PR-sized)

1.  **PR 1: Define Evidence Map & Contracts**
    *   **Scope:** Create `docs/ga/evidence_map.yml` and `docs/ga/RUNTIME_GOVERNANCE_EVIDENCE.md`.
    *   **Acceptance:** Files exist and document the 10 evidence items.
    *   **Verify:** `ls docs/ga/evidence_map.yml`

2.  **PR 2: Implement Evidence Producers (Schema & Snapshots)**
    *   **Scope:** Create `scripts/governance/generate_runtime_evidence.ts` and `scripts/governance/generate_boot_snapshot.ts`.
    *   **Acceptance:** Scripts run locally and produce valid JSON artifacts in `artifacts/governance/runtime/local/`.
    *   **Verify:** `pnpm run generate:runtime-evidence && cat artifacts/.../verdict_schema.json`

3.  **PR 3: Implement Runtime Governance Tests (JSON Output)**
    *   **Scope:** Create/Update `tests/governance/` tests to output JSON reports (Isolation & Kill Switch). Add `test:governance:runtime` script.
    *   **Acceptance:** Tests pass and generate `tenant_isolation_report.json`.
    *   **Verify:** `pnpm run test:governance:runtime && cat artifacts/.../tenant_isolation_report.json`

4.  **PR 4: Implement Evidence Map Verifier**
    *   **Scope:** Create `scripts/ga/verify_evidence_map.ts`.
    *   **Acceptance:** Script reads YAML, checks artifacts, and passes/fails correctly.
    *   **Verify:** `node scripts/ga/verify_evidence_map.ts` (should fail until artifacts exist).

5.  **PR 5: CI Integration**
    *   **Scope:** Update `.github/workflows/ci.yml` to run producers and verification.
    *   **Acceptance:** CI passes and uploads `runtime-governance-evidence` artifact.
    *   **Verify:** Check GitHub Actions run for new artifacts.

6.  **PR 6: Compliance Control Map Linkage**
    *   **Scope:** Update `compliance/control-map.yaml` to reference these new artifacts under relevant controls (e.g., CC6.1, CC7.1).
    *   **Acceptance:** `scripts/compliance/generate_evidence.ts` picks up the new files.
    *   **Verify:** `node scripts/compliance/generate_evidence.ts --control CC6.1`
