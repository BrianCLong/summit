# Evidence Bundle Schema (GA)

This schema defines the deterministic evidence bundle generated by
`pnpm ci:evidence:bundle`. The bundle is intended for offline validation and
repeatable audit checks without external dependencies.

## Bundle Layout

```
artifacts/evidence/<sha>/
├── sbom/
│   ├── monorepo.cdx.json
│   └── workspaces/
│       └── <workspaceId>.cdx.json
├── provenance/
│   ├── ci.json
│   ├── hashes.json
│   └── slsa-provenance.json
├── manifest.json
└── receipt.json
```

### Workspace ID Normalization

Workspace SBOM file names use the package name when available, normalized as:

- `@scope/name` → `scope__name`
- `/` replaced with `__`
- other non-alphanumeric characters replaced with `-`

If a package name is missing, the workspace path is used.

## File Schemas

### `sbom/monorepo.cdx.json`

- **Format**: CycloneDX JSON (v1.5)
- **Determinism**: no timestamps or UUIDs, sorted components and dependencies
- **Scope**: all packages from `pnpm-lock.yaml`

### `sbom/workspaces/<workspaceId>.cdx.json`

- **Format**: CycloneDX JSON (v1.5)
- **Scope**: workspace component plus direct dependencies from lockfile importers

### `provenance/ci.json`

- **Purpose**: CI metadata (workflow, run IDs, actor, runner, node/pnpm versions)
- **Notes**: contains CI identifiers and timestamps; excluded from manifest hashing

### `provenance/hashes.json`

- **Schema**:
  - `schema_version`: `1.0`
  - `algorithm`: `sha256`
  - `files`: ordered list of `{ path, sha256, size }`
- **Paths**: repository-relative, forward-slash normalized

### `provenance/slsa-provenance.json`

- **Format**: SLSA provenance statement (in-toto Statement v1)
- **Determinism**:
  - build timestamps pinned to commit timestamp
  - builder ID is static (`summit-ci`)

### `manifest.json`

- **Schema**:
  - `schema_version`: `1.0`
  - `repo`: repository URL
  - `sha`: git commit
  - `ref`: git ref
  - `policy_sha256`: sha256 of `docs/ga/EVIDENCE_BUNDLE_POLICY.yml`
  - `tooling`: node + pnpm versions
  - `files`: sorted list of `{ path, sha256, size }`
- **Determinism**: excludes `provenance/ci.json` and `receipt.json` per policy

### `receipt.json`

- **Purpose**: bundle generation receipt
- **Fields**:
  - `status`: `passed` or `failed`
  - `started_at`, `finished_at`: ISO timestamps
  - `summary`: counts for SBOMs, workspaces, hashed artifacts

## Verification Rules

The verifier (`pnpm ci:evidence:verify`) enforces:

1. Required files and directories exist per policy.
2. SBOMs parse as CycloneDX JSON with specVersion 1.x.
3. Manifest file list is sorted, complete, and all hashes match.
4. Provenance files contain required fields and are scanned for secret patterns.
5. Files excluded in `manifest_exclude` are present but not hashed.

## Policy Source of Truth

- Policy file: `docs/ga/EVIDENCE_BUNDLE_POLICY.yml`
- Note: this policy is JSON-compatible YAML, enabling dependency-free parsing.
