# System Meta-Patterns & Abstractions

**Status:** Auto-Generated by Jules (Universal Pattern Recognizer)
**Date:** 2025-10-27

## 1. Observed Patterns

### Behavioral Patterns
*   **Guardrail Pipeline:** `ValidateInput` → `Execute` → `ValidateOutput`. Seen in `SecuredLLMService`.
*   **Retry with Backoff:** `try/catch` loop with `setTimeout` and exponential backoff. Seen in `LLMService`.
*   **Feature Flagging:** Runtime checks for `process.env` or `config` flags (e.g., `skipGuardrails`).
*   **L1/L2 Caching:** In-memory L1 cache + Redis L2 cache. Seen in `cacheService.ts`.

### Structural Patterns
*   **Service Wrapper:** A TypeScript class wrapping a legacy JavaScript class to provide type safety and enhanced functionality.
*   **Singleton Exports:** `export const serviceName = new ServiceName();` pattern for global instances.
*   **Config Object Injection:** Constructors accepting a `config` object with defaults from `process.env`.
*   **Metric Instrumentation:** Manual increment of counters vs `PrometheusMetrics` wrapper.

### Anti-Patterns (To Be Resolved)
*   **Dual Implementation:** `CacheService.ts` (PascalCase, standard) vs `cacheService.ts` (camelCase, custom).
*   **Logger Fragmentation:**
    *   `winston` via `server/src/utils/logger.ts`
    *   `pino` via `server/src/config/logger.ts`
    *   Missing/Phantom import `server/src/observability/logger.js` in `SecuredLLMService.ts`
*   **Mixed Module Systems:** CommonJS/ESM hybrids.
*   **Hardcoded Providers:** `switch` statements for providers instead of a Strategy pattern.

## 2. Proposed Meta-Abstractions

To address these patterns, the following abstractions are introduced:

### `BaseService<Config>`
A canonical base class for all services that standardizes:
*   Configuration loading.
*   Logger initialization (standardized to `pino`).
*   Metrics initialization (`this.metrics`).
*   Health check protocol (`getHealth()`).

### `GuardrailPipeline<Input, Output>`
A generalized implementation of the Guardrail pattern:
*   `addInputGuard(guard)`
*   `addOutputGuard(guard)`
*   `execute(input, coreFunction)`

### `Result<T, E>`
A standard result type to avoid `throw` for expected errors (not yet widespread, but recommended).

## 3. Ontology Updates

*   **Service:** A stateful singleton that manages a specific domain.
*   **Guardrail:** A side-effect-free validator/transformer for data flow.
*   **Provider:** An interchangeable implementation of a capability (e.g., OpenAI vs Anthropic).
*   **Strategy:** A selectable logic path (e.g., Cache Strategy).
