apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: intelgraph-v2.7-alerts
  namespace: monitoring
  labels:
    app: intelgraph
    version: v2.7
    prometheus: kube-prometheus
spec:
  groups:
  - name: intelgraph.v2.7.critical
    rules:
    - alert: ExportFailureSpike
      expr: rate(export_jobs_failed_total[15m]) > 0.01
      for: 15m
      labels:
        severity: critical
        component: export-system
      annotations:
        summary: "Export failure rate > 1% over 15 minutes"
        description: "Export job failure rate is {{ $value | humanizePercentage }} which is above the 1% threshold"
        runbook_url: "https://docs.intelgraph.com/runbooks/export-failures"
        
    - alert: SubscriptionDisconnectSpike
      expr: rate(subscription_disconnects_total[10m]) > 0.05
      for: 10m
      labels:
        severity: critical
        component: notifications
      annotations:
        summary: "Subscription disconnects > 5% of clients over 10 minutes"
        description: "WebSocket subscription disconnect rate is {{ $value | humanizePercentage }}"
        runbook_url: "https://docs.intelgraph.com/runbooks/subscription-issues"

    - alert: SearchLatencyDegraded
      expr: histogram_quantile(0.95, search_duration_seconds) > 2.0
      for: 5m
      labels:
        severity: critical
        component: search
      annotations:
        summary: "Search p95 latency > 2s"
        description: "Search response time p95 is {{ $value }}s, exceeding 2s threshold"
        runbook_url: "https://docs.intelgraph.com/runbooks/search-performance"

    - alert: APIErrorRateHigh
      expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        component: api
      annotations:
        summary: "API error rate > 5%"
        description: "API 5xx error rate is {{ $value | humanizePercentage }}"
        runbook_url: "https://docs.intelgraph.com/runbooks/api-errors"

  - name: intelgraph.v2.7.warning
    rules:
    - alert: GraphRenderPerformance
      expr: avg(graph_render_fps) < 50
      for: 15m
      labels:
        severity: warning
        component: graph-visualization
      annotations:
        summary: "Graph render FPS below 50 on synthetic tests"
        description: "Average graph rendering FPS is {{ $value }}, below 50fps threshold"
        runbook_url: "https://docs.intelgraph.com/runbooks/graph-performance"
        
    - alert: ErrorBoundaryTriggersElevated
      expr: rate(error_boundary_triggered_total[1h]) > 0.001
      for: 1h
      labels:
        severity: warning
        component: client
      annotations:
        summary: "Error boundary activation rate elevated"
        description: "Error boundary trigger rate is {{ $value }} per second"
        runbook_url: "https://docs.intelgraph.com/runbooks/client-errors"

    - alert: ExportQueueDepthHigh
      expr: export_queue_depth > 100
      for: 30m
      labels:
        severity: warning
        component: export-system
      annotations:
        summary: "Export queue depth > 100 jobs"
        description: "Export queue has {{ $value }} pending jobs"
        runbook_url: "https://docs.intelgraph.com/runbooks/export-queue"

    - alert: MemoryUsageHigh
      expr: avg(browser_memory_usage_mb) > 180
      for: 30m
      labels:
        severity: warning
        component: client
      annotations:
        summary: "Browser memory usage > 180MB per session"
        description: "Average browser memory usage is {{ $value }}MB per session"
        runbook_url: "https://docs.intelgraph.com/runbooks/memory-usage"

    - alert: DatabaseConnectionPoolHigh
      expr: (pg_stat_activity_count / pg_settings_max_connections) > 0.8
      for: 15m
      labels:
        severity: warning
        component: database
      annotations:
        summary: "Database connection pool > 80% utilization"
        description: "Database connection pool utilization is {{ $value | humanizePercentage }}"
        runbook_url: "https://docs.intelgraph.com/runbooks/database-connections"

  - name: intelgraph.v2.7.performance
    rules:
    - alert: BundleSizeBudgetExceeded
      expr: bundle_size_bytes > 450000
      for: 0m
      labels:
        severity: warning
        component: client
      annotations:
        summary: "Client bundle size exceeds 450KB budget"
        description: "Bundle size is {{ $value | humanize1024 }}, exceeding 450KB budget"
        runbook_url: "https://docs.intelgraph.com/runbooks/bundle-optimization"

    - alert: CDNCacheHitRateLow
      expr: cdn_cache_hit_rate < 0.85
      for: 30m
      labels:
        severity: warning
        component: cdn
      annotations:
        summary: "CDN cache hit rate < 85%"
        description: "CDN cache hit rate is {{ $value | humanizePercentage }}"
        runbook_url: "https://docs.intelgraph.com/runbooks/cdn-optimization"

    - alert: TimeToInteractiveHigh
      expr: avg(performance_tti_seconds) > 1.5
      for: 15m
      labels:
        severity: warning
        component: client
      annotations:
        summary: "Time to Interactive > 1.5s"
        description: "Average TTI is {{ $value }}s, exceeding 1.5s target"
        runbook_url: "https://docs.intelgraph.com/runbooks/client-performance"

  - name: intelgraph.v2.7.business
    rules:
    - alert: FeatureAdoptionLow
      expr: (advanced_search_usage_rate + graph_preview_usage_rate + export_usage_rate) / 3 < 0.1
      for: 24h
      labels:
        severity: info
        component: product
      annotations:
        summary: "New feature adoption < 10% after 24h"
        description: "Average adoption rate of v2.7 features is {{ $value | humanizePercentage }}"
        runbook_url: "https://docs.intelgraph.com/runbooks/feature-adoption"

    - alert: ExportVolumeUnexpected
      expr: rate(export_jobs_completed_total[1h]) > 1000 or rate(export_jobs_completed_total[1h]) < 10
      for: 2h
      labels:
        severity: info
        component: export-system
      annotations:
        summary: "Export volume outside expected range"
        description: "Export rate is {{ $value }} jobs/hour, outside 10-1000 range"
        runbook_url: "https://docs.intelgraph.com/runbooks/export-volume"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: intelgraph-v2.7-dashboard-config
  namespace: monitoring
data:
  dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "IntelGraph v2.7 - Operations Dashboard",
        "tags": ["intelgraph", "v2.7"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "API Response Time",
            "type": "stat",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, http_request_duration_seconds)",
                "legendFormat": "p95"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "min": 0,
                "max": 3,
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 1.5},
                    {"color": "red", "value": 2.0}
                  ]
                }
              }
            }
          },
          {
            "id": 2,
            "title": "Search Performance",
            "type": "timeseries",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, search_duration_seconds)",
                "legendFormat": "p50"
              },
              {
                "expr": "histogram_quantile(0.95, search_duration_seconds)",
                "legendFormat": "p95"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ms"
              }
            }
          },
          {
            "id": 3,
            "title": "Graph Rendering FPS",
            "type": "gauge",
            "targets": [
              {
                "expr": "avg(graph_render_fps)",
                "legendFormat": "Average FPS"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "min": 0,
                "max": 60,
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 30},
                    {"color": "green", "value": 50}
                  ]
                }
              }
            }
          },
          {
            "id": 4,
            "title": "Export Job Status",
            "type": "piechart",
            "targets": [
              {
                "expr": "sum(export_jobs_completed_total)",
                "legendFormat": "Completed"
              },
              {
                "expr": "sum(export_jobs_failed_total)",
                "legendFormat": "Failed"
              },
              {
                "expr": "sum(export_jobs_processing_total)",
                "legendFormat": "Processing"
              }
            ]
          },
          {
            "id": 5,
            "title": "Notification Delivery",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(notifications_sent_total[5m])",
                "legendFormat": "Sent/sec"
              },
              {
                "expr": "rate(notifications_delivered_total[5m])",
                "legendFormat": "Delivered/sec"
              }
            ]
          },
          {
            "id": 6,
            "title": "Investigation Activity",
            "type": "bargraph",
            "targets": [
              {
                "expr": "sum by (status) (investigations_total)",
                "legendFormat": "{{ status }}"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }