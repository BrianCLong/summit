apiVersion: v1
kind: ConfigMap
metadata:
  name: ig-prometheus-rules
  namespace: intelgraph
  labels:
    role: alert-rules
    app: prometheus
data:
  ig.rules.yaml: |
    groups:
      - name: slo-graphql
        rules:
          - alert: IG_HighQueryLatency
            expr: histogram_quantile(0.95, sum(rate(graphql_request_duration_seconds_bucket[5m])) by (le)) > 1.5
            for: 10m
            labels: { severity: page }
            annotations:
              summary: "p95 GraphQL latency high"
              runbook_url: "https://git.example.com/docs/runbooks/performance-troubleshooting.md"
          - alert: IG_ElevatedErrorRate
            expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.01
            for: 10m
            labels: { severity: page }
            annotations:
              summary: "HTTP 5xx > 1%"
      - name: db-health
        rules:
          - alert: IG_PostgresCPUHigh
            expr: avg(rate(container_cpu_usage_seconds_total{container=~".*postgres.*"}[5m])) by (pod) > 0.8
            for: 15m
            labels: { severity: ticket }
            annotations:
              summary: "Postgres CPU >80%"
          - alert: IG_Neo4jPageCacheMiss
            expr: neo4j_dbms_pagecache_hits_total / (neo4j_dbms_pagecache_hits_total + neo4j_dbms_pagecache_evictions_total) < 0.9
            for: 15m
            labels: { severity: ticket }
            annotations:
              summary: "Page cache hit ratio < 0.9"
