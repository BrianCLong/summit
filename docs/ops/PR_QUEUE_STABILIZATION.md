# PR Queue Stabilization & Triage Guide

This document outlines the usage of the **PR Queue Stabilizer** tool and the operational playbook for managing the PR backlog.

## Overview

The PR Queue Stabilizer is an automated tool that runs daily (and on-demand) to analyze all open Pull Requests. It produces a **PR Triage Report** that helps maintainers prioritize merges, identify conflicts early, and keep the backlog healthy.

## The Triage Report

The report is generated by `scripts/ops/pr_triage.ts` and output to `docs/ops/pr-triage/PR_TRIAGE_REPORT.md` (and `.json`). It contains:

1.  **Merge Train**: A recommended order for merging PRs to minimize risk and conflicts.
2.  **Conflict Hotspots**: A list of files modified by multiple open PRs, indicating potential merge conflicts.
3.  **Risk Analysis**: Each PR is assigned a **Risk Score** (0-100) based on:
    - **CI Status**: Failing or missing checks significantly increase risk.
    - **Overlaps**: Modifying "hotspot" files increases risk.
    - **Critical Paths**: Changes to infrastructure, security policies, or core config are higher risk.
    - **Size & Age**: Large or stale PRs are penalized.

## Operator Playbook

Maintainers should review the Triage Report daily and take the following actions based on the `Recommended Action`:

### 1. `MERGE_NOW` (Low Risk)

- **Criteria**: Low risk score (<20), CI passing, no conflicts.
- **Action**: Merge these PRs immediately to clear the queue. Follow the **Merge Train** order.

### 2. `NEEDS_REVIEW` (Medium Risk)

- **Criteria**: Moderate risk (20-50), usually due to size or complexity.
- **Action**: Prioritize these for code review. Ensure a domain expert reviews any critical path changes.

### 3. `NEEDS_REBASE`

- **Criteria**: Merge conflict detected (`mergeable_state: dirty`).
- **Action**: Ping the author to rebase on `main`. Do not review until conflicts are resolved.

### 4. `NEEDS_FIX`

- **Criteria**: CI is failing.
- **Action**: Ping the author to fix CI. If the failure is a known flake, re-trigger the check.

### 5. `HOLD` (High Risk)

- **Criteria**: High risk score (>80), often due to multiple negative factors (failing CI + overlaps + critical path).
- **Action**:
  - Do not merge.
  - Discuss with the author.
  - Consider breaking the PR into smaller, safer chunks.

### 6. `SPLIT`

- **Criteria**: Extremely large diffs (>500 lines or >20 files).
- **Action**: Request the author to split the PR into atomic units.

## Operational Procedures

### "Quiet Hours" & Batching

To avoid triggering rate limits on CI/CD bots:

- **Batch Merges**: Merge `MERGE_NOW` PRs in small batches (3-5) rather than one by one, if possible (e.g., using a merge queue if enabled, or manually spacing them out).
- **Quiet Hours**: Avoid mass-merging during peak operational times if production deployments are sensitive to churn.

### Handling Hotspots

If a file appears in the **Conflict Hotspots** list:

1.  Identify the "primary" PR that should claim the change (usually the one furthest along).
2.  Merge the primary PR first.
3.  Ask other authors to rebase immediately after.

## Running the Tool Locally

You can generate the report locally at any time:

```bash
# Requires GITHUB_TOKEN in environment
export GITHUB_TOKEN=your_token_here
npx tsx scripts/ops/pr_triage.ts
```

The report will be saved to `docs/ops/pr-triage/`.

## Integration

The tool runs automatically via GitHub Actions: `.github/workflows/pr-triage.yml`.
Artifacts are uploaded to the workflow run and a summary is posted to the job summary.
