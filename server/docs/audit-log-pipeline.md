# Audit Logging and Real-Time Analysis

This document describes the production-grade audit logging pipeline introduced for Summit/IntelGraph.

## Capabilities

- **Structured JSON logs** written to newline-delimited files with correlation, tenant, and user metadata.
- **Audit metadata extraction** (action, resource, outcome, compliance tags, IP, user agent) normalized for downstream tools.
- **Aggregation dashboard** exposed at `GET /observability/logs/dashboard` with live counters, recent events, and alerts.
- **Retention & compaction** with configurable aging, compression, and size caps for both application and audit streams.
- **Alert integration**: dashboard surfaces alerts generated by `LogAlertEngine` rules.

## File Layout

- Application logs: `logs/app-structured.log` (with separate error stream at `logs/app-error.log`).
- Audit stream: `logs/audit/audit-log.jsonl` (defaults; override with `AUDIT_LOG_DIR` and `AUDIT_LOG_STREAM`).

## Environment Variables

| Variable | Purpose | Default |
| --- | --- | --- |
| `LOG_LEVEL` | Logger level | `info` |
| `LOG_RETENTION_DAYS` | App log retention window | `30` |
| `LOG_COMPRESS_AFTER_DAYS` | App log compression threshold | `3` |
| `LOG_TOTAL_SIZE_MB` | App log size cap | `2048` |
| `AUDIT_LOG_RETENTION_DAYS` | Audit log retention window | `365` |
| `AUDIT_LOG_COMPRESS_AFTER_DAYS` | Audit compression threshold | `7` |
| `AUDIT_LOG_TOTAL_SIZE_MB` | Audit size cap | `4096` |
| `AUDIT_LOG_DIR` | Directory for audit logs | `logs/audit` (relative to repo) |
| `AUDIT_LOG_STREAM` | Stream name (filename prefix) | `audit-log` |

## Dashboard Contract

`GET /observability/logs/dashboard` returns:

```json
{
  "stream": "audit-log",
  "metrics": {
    "totalEvents": 123,
    "perLevel": { "info": 80, "error": 3 },
    "perTenant": { "tenant-1": 42 },
    "compliance": { "SOC2": 12, "HIPAA": 5 }
  },
  "recentEvents": [
    { "message": "user viewed record", "audit": { "action": "view" } }
  ],
  "alerts": [{ "ruleId": "error-burst", "name": "Error burst" }],
  "retention": { "retentionDays": 365, "compressAfterDays": 7, "maxTotalSizeMb": 4096, "directory": "logs/audit" }
}
```

## Operational Notes

- The pipeline mirrors all log events published to the shared `logEventBus`, ensuring parity between application and audit views.
- Retention enforcement runs on a configurable interval (`LOG_RETENTION_CHECK_MINUTES`) for both app and audit streams.
- Use `stopLogAggregation()` during shutdown or tests to detach the pipeline and alert engine cleanly.
