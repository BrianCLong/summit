
> intelgraph-server@4.0.1 test /Users/brianlong/Developer/summit/server
> jest --config jest.config.ts "tests/services/VectorStoreService.test.ts" "src/ai/copilot/__tests__/guardrails.service.test.ts" "src/hunting/__tests__/ThreatHuntingOrchestrator.test.ts"

ğŸš€ Starting Jest Global Setup...
âœ… Jest Global Setup completed successfully
  console.log
    [dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (../node_modules/.pnpm/dotenv@17.2.3/node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ“¡ add observability to secrets: https://dotenvx.com/ops

      at _log (../node_modules/.pnpm/dotenv@17.2.3/node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ” prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (../node_modules/.pnpm/dotenv@17.2.3/node_modules/dotenv/lib/main.js:142:11)

{"level":30,"time":1767420140697,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","config":{"requireCitations":true,"minCitationsRequired":1,"minConfidenceThreshold":0.1,"logRiskyPrompts":true,"riskScoreThreshold":0.1,"blockHighRiskPrompts":true,"maxAnswerLength":10000,"deniedKeywords":["delete all","drop database","export credentials","bypass","ignore restrictions"]},"msg":"Guardrail config updated"}
{"level":30,"time":1767420140809,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"1f36da4c-3702-498e-8d95-dbd91ac09dc8","field":"citation_[1]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["PII"],"timestamp":"2026-01-03T06:02:20.808Z"},{"decisionId":"183e070d-9bd8-492e-aae0-c681b95e1150","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["PII"],"timestamp":"2026-01-03T06:02:20.809Z"},{"decisionId":"ca8a991c-aa04-4b9c-8021-fd2c3c0ffd80","field":"provenance","redacted":true,"reason":"Removed references to redacted content","policyLabels":[],"timestamp":"2026-01-03T06:02:20.809Z"}],"msg":"Redaction applied to answer"}
FAIL src/ai/copilot/__tests__/guardrails.service.test.ts (11.248 s)
  GuardrailsService
    Citation Requirements
      âœ“ should pass validation when answer has citations (17 ms)
      âœ“ should generate refusal for injection in original prompt (33 ms)
      âœ“ should fail validation when answer has no citations (2 ms)
      âœ“ should fail when citations below minimum threshold (1 ms)
      âœ“ should pass when citations disabled
    Prompt Injection Detection
      âœ“ should block prompts with instruction override attempts (3 ms)
      âœ“ should block prompts asking for system prompt (1 ms)
      âœ“ should block role manipulation attempts (1 ms)
      âœ“ should block jailbreak attempts (1 ms)
      âœ“ should allow legitimate queries (1 ms)
      âœ“ should allow complex but legitimate queries
    Denied Keywords
      âœ“ should block prompts with denied keywords (2 ms)
      âœ“ should block "export credentials" requests (1 ms)
      âœ“ should block bypass attempts
    Risky Prompt Logging
      âœ“ should log high-risk prompts for review (2 ms)
      âœ“ should track blocked prompts (1 ms)
      âœ“ should categorize risk levels (11 ms)
      âœ“ should return prompts requiring review
      âœ“ should allow marking prompts as reviewed
    Answer Content Validation
      âœ“ should fail validation for empty answers (2 ms)
      âœ“ should fail validation for very short answers
      âœ“ should pass validation for substantive answers
    Refusal Generation
      âœ“ should generate refusal for citation failures
      âœ• should generate refusal for injection in original prompt (2 ms)
      âœ“ should include helpful suggestions in refusals (2 ms)
      âœ“ should create policy refusal with audit ID
    Configuration
      âœ“ should allow updating configuration (1 ms)
      âœ“ should return current configuration
  RedactionService
    Policy Label Redaction
      âœ“ should redact citations with denied policy labels (3 ms)
      âœ“ should not redact citations with allowed policy labels
      âœ“ should redact citations above user clearance level (1 ms)
    PII Pattern Detection
      âœ“ should redact SSN patterns in answer text
      âœ“ should redact email addresses
      âœ“ should redact phone numbers
      âœ“ should redact classification markers (1 ms)
    Uncertainty Indication
      âœ“ should indicate low uncertainty for minimal redaction
      âœ“ should indicate high uncertainty for extensive redaction
      âœ“ should update answer warnings for redaction uncertainty (1 ms)
    Provenance Adjustment
      âœ“ should remove redacted entity IDs from provenance (1 ms)
      âœ“ should adjust chain confidence for redacted provenance (1 ms)
    Policy Updates
      âœ“ should allow updating redaction policy
      âœ“ should return current policy (1 ms)

  â— GuardrailsService â€º Refusal Generation â€º should generate refusal for injection in original prompt

    expect(received).toBeDefined()

    Received: undefined

      372 |       // But wait the test is "should generate refusal".
      373 |       expect(result.valid).toBe(true);
    > 374 |       expect(result.refusal).toBeDefined();
          |                              ^
      375 |       expect(result.refusal?.category).toBe('policy_violation');
      376 |     });
      377 |

      at Object.<anonymous> (src/ai/copilot/__tests__/guardrails.service.test.ts:374:30)

{"level":40,"time":1767420140725,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"16149391-685f-4fd7-a003-d439788115d7","riskLevel":"critical","riskFactors":["no_injection_detected"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":30,"time":1767420140730,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","config":{"requireCitations":true,"minCitationsRequired":1,"minConfidenceThreshold":0.1,"logRiskyPrompts":true,"riskScoreThreshold":0.1,"blockHighRiskPrompts":false,"maxAnswerLength":10000,"deniedKeywords":["delete all","drop database","export credentials","bypass","ignore restrictions"]},"msg":"Guardrail config updated"}
{"level":40,"time":1767420140732,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"2fc504b2-2814-4b26-aa87-14a82422edba","riskLevel":"high","riskFactors":["has_citations"],"blocked":false,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140734,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"ad1f4701-1f62-4aee-b34e-ef0c4a81ac6e","riskLevel":"critical","riskFactors":["show\\s+(me\\s+)?(the\\s+)?(system\\s+)?(prompt|instructions|rules)","guard-service-detection"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140737,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"82e2f839-0315-4aa9-b803-d2b5384a90d9","riskLevel":"critical","riskFactors":["what\\s+(is|are)\\s+(your\\s+)?(system\\s+)?(prompt|instructions|rules)","guard-service-detection"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140739,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"f5712daa-aea3-4395-8b72-10523ad9bc03","riskLevel":"critical","riskFactors":["you\\s+are\\s+now\\s+(a|an)\\s+\\w+","pretend\\s+(to\\s+be|you\\s+are)","(DAN|STAN)(\\s+mode)?"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140740,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"3b6e2bf0-bca5-430b-bfc2-282aa0d14aae","riskLevel":"critical","riskFactors":["developer\\s+mode"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140742,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"9623e435-1699-4d66-9938-2d7941531749","riskLevel":"high","riskFactors":["denied_keyword:delete all"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140743,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"ece3d75d-0bb4-4200-88c0-61020ac92517","riskLevel":"high","riskFactors":["denied_keyword:export credentials"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140744,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"8aaf2e31-7f2e-4861-abc7-8bc8e4a5d8d6","riskLevel":"high","riskFactors":["denied_keyword:bypass"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140747,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"661a5508-db53-4681-9203-a02a9d0d7166","riskLevel":"critical","riskFactors":["ignore\\s+(previous|prior|above|all)\\s+(instructions|prompts|rules|context)","guard-service-detection"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140747,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"c10fc8a1-8c30-42a3-8f5c-14bce112c69d","riskLevel":"high","riskFactors":["denied_keyword:delete all"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140748,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"1d3fca60-f1bd-43b5-88b5-f9a0731e6faa","riskLevel":"high","riskFactors":["denied_keyword:delete all"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140760,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"487af5cd-6a73-4638-a4cf-75036add0c51","riskLevel":"critical","riskFactors":["ignore\\s+(previous|prior|above|all)\\s+(instructions|prompts|rules|context)","guard-service-detection"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140760,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"0f0d92d0-30e7-41be-88e2-6418fda36870","riskLevel":"high","riskFactors":["denied_keyword:bypass"],"blocked":true,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140760,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"96d23c85-dc51-4501-a459-ffb4dbcb875c","riskLevel":"high","riskFactors":["answer_not_empty"],"blocked":false,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140762,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"4f8771a1-45ad-46f3-bb8d-02e15d5860d0","riskLevel":"high","riskFactors":["answer_not_empty"],"blocked":false,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140762,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"78363965-aedc-4c12-b822-97a09a7af62d","riskLevel":"high","riskFactors":["has_citations"],"blocked":false,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140805,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","logId":"ac4791cd-6cf0-4364-9b1e-da2f4ab720e3","riskLevel":"high","riskFactors":["has_citations"],"blocked":false,"requiresReview":true,"msg":"Risky prompt logged for review"}
{"level":40,"time":1767420140806,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","reason":"User lacks authorization","context":{"userId":"user-123"},"msg":"Policy refusal created"}
{"level":30,"time":1767420140806,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"guardrails-service","config":{"requireCitations":true,"minCitationsRequired":5,"minConfidenceThreshold":0.1,"logRiskyPrompts":true,"riskScoreThreshold":0.5,"blockHighRiskPrompts":false,"maxAnswerLength":10000,"deniedKeywords":["delete all","drop database","export credentials","bypass","ignore restrictions"]},"msg":"Guardrail config updated"}
{"level":30,"time":1767420140810,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"0602e82a-4b9e-4d0c-8fdb-7e2062db07ef","field":"citation_[1]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["TOP_SECRET"],"timestamp":"2026-01-03T06:02:20.810Z"},{"decisionId":"01dc8565-facb-4e05-b901-337386876a2d","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["TOP_SECRET"],"timestamp":"2026-01-03T06:02:20.810Z"},{"decisionId":"4dcf4fb7-d306-47fd-ba15-de6053bdbce8","field":"provenance","redacted":true,"reason":"Removed references to redacted content","policyLabels":[],"timestamp":"2026-01-03T06:02:20.810Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140811,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"6c27e4eb-2f5f-44d4-b785-9638fb6a93ff","field":"answer_text_SSN","redacted":true,"reason":"Pattern SSN detected and redacted","policyLabels":[],"timestamp":"2026-01-03T06:02:20.811Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140811,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"568e45bb-acd7-4d43-a1fb-b7961dda91b2","field":"answer_text_EMAIL","redacted":true,"reason":"Pattern EMAIL detected and redacted","policyLabels":[],"timestamp":"2026-01-03T06:02:20.811Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140811,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"73d7f19b-7f8d-497f-bbb6-878f1cea4a4d","field":"answer_text_PHONE","redacted":true,"reason":"Pattern PHONE detected and redacted","policyLabels":[],"timestamp":"2026-01-03T06:02:20.811Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140812,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"ca64c15c-990d-47ef-8b24-51c9b2d7cb62","field":"answer_text_CLASSIFICATION_MARKER","redacted":true,"reason":"Pattern CLASSIFICATION_MARKER detected and redacted","policyLabels":[],"timestamp":"2026-01-03T06:02:20.811Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140812,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"medium","decisions":[{"decisionId":"fc096d6a-468b-4b96-aada-2847720d953d","field":"citation_[3]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["PII"],"timestamp":"2026-01-03T06:02:20.812Z"},{"decisionId":"a1d07666-2ace-4db3-a1d9-a1dfed079308","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["PII"],"timestamp":"2026-01-03T06:02:20.812Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140812,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":2,"uncertaintyLevel":"high","decisions":[{"decisionId":"598ea62f-37ee-40b6-9b11-97db435f0c1e","field":"citation_[1]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["CLASSIFIED"],"timestamp":"2026-01-03T06:02:20.812Z"},{"decisionId":"0dacb790-d53b-481e-8040-dae585745b75","field":"citation_[2]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["RESTRICTED"],"timestamp":"2026-01-03T06:02:20.812Z"},{"decisionId":"5e6a7672-b63e-4051-ac26-0bd11b19879a","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["CLASSIFIED","RESTRICTED"],"timestamp":"2026-01-03T06:02:20.812Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140812,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"547817c4-54c4-47ff-a1c1-510cfaa89cf7","field":"citation_[1]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["PII"],"timestamp":"2026-01-03T06:02:20.812Z"},{"decisionId":"18430bd3-c36d-46bc-aa20-81061d56804a","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["PII"],"timestamp":"2026-01-03T06:02:20.812Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140814,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"22536a91-a694-4238-a71d-98ca099357e3","field":"citation_[1]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["CLASSIFIED"],"timestamp":"2026-01-03T06:02:20.814Z"},{"decisionId":"c2a1f268-482e-4545-858a-85e38d771932","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["CLASSIFIED"],"timestamp":"2026-01-03T06:02:20.814Z"},{"decisionId":"a62794c1-bb76-45be-8e76-9590c33e17e9","field":"provenance","redacted":true,"reason":"Removed references to redacted content","policyLabels":[],"timestamp":"2026-01-03T06:02:20.814Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140814,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","answerId":"test-answer-123","redactedCount":1,"uncertaintyLevel":"high","decisions":[{"decisionId":"170b7272-81db-41ed-a947-63f738680ba3","field":"citation_[1]","redacted":true,"reason":"Policy labels require redaction","policyLabels":["CLASSIFIED"],"timestamp":"2026-01-03T06:02:20.814Z"},{"decisionId":"df7fbdda-5e28-4f64-9737-32027b6a2808","field":"answer_text","redacted":true,"reason":"Policy labels require redaction","policyLabels":["CLASSIFIED"],"timestamp":"2026-01-03T06:02:20.814Z"},{"decisionId":"a932941a-ebde-4ce3-932f-17805f622d58","field":"provenance","redacted":true,"reason":"Removed references to redacted content","policyLabels":[],"timestamp":"2026-01-03T06:02:20.814Z"}],"msg":"Redaction applied to answer"}
{"level":30,"time":1767420140815,"pid":48133,"hostname":"Brians-MacBook-Pro.local","name":"redaction-service","policy":{"userClearance":"SECRET","allowedPolicyLabels":["PUBLIC","UNCLASSIFIED"],"deniedPolicyLabels":["PII","CLASSIFIED","RESTRICTED"],"showPartialContent":false,"redactionPlaceholder":"[REDACTED]","auditRedactions":true},"msg":"Redaction policy updated"}
FAIL tests/services/VectorStoreService.test.ts
  â— Test suite failed to run

    ReferenceError: Cannot access 'mockPoolFactory' before initialization

      24 | jest.mock('../../src/db/postgres.js', () => ({
      25 |   __esModule: true,
    > 26 |   getPostgresPool: jest.fn().mockReturnValue(mockPoolFactory()),
         |                                              ^
      27 | }));
      28 |
      29 | describe('VectorStoreService', () => {

      at tests/services/VectorStoreService.test.ts:26:46
      at Object.<anonymous> (src/services/VectorStoreService.ts:1:1)
      at Object.<anonymous> (tests/services/VectorStoreService.test.ts:2:1)

FAIL src/hunting/__tests__/ThreatHuntingOrchestrator.test.ts
  â— Test suite failed to run

    ReferenceError: Cannot access 'mockCypherTemplateEngineFactory' before initialization

      120 | });
      121 | jest.mock('../CypherTemplateEngine', () => {
    > 122 |   const engine = mockCypherTemplateEngineFactory();
          |                  ^
      123 |   return {
      124 |     cypherTemplateEngine: engine,
      125 |     CypherTemplateEngine: jest.fn(() => engine),

      at src/hunting/__tests__/ThreatHuntingOrchestrator.test.ts:122:18
      at Object.<anonymous> (src/hunting/ThreatHuntingOrchestrator.ts:12:1)
      at Object.<anonymous> (src/hunting/__tests__/ThreatHuntingOrchestrator.test.ts:7:1)

Test Suites: 3 failed, 3 total
Tests:       1 failed, 41 passed, 42 total
Snapshots:   0 total
Time:        18.796 s, estimated 29 s
Ran all test suites matching /tests\/services\/VectorStoreService.test.ts|src\/ai\/copilot\/__tests__\/guardrails.service.test.ts|src\/hunting\/__tests__\/ThreatHuntingOrchestrator.test.ts/i.
ğŸ§¹ Starting Jest Global Teardown...
ğŸ—‘ï¸ Cleaning up temporary directories...
ğŸ”Œ Closing global connections...
âœ… Jest Global Teardown completed successfully
â€‰ELIFECYCLEâ€‰ Test failed. See above for more details.
