[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Path              /workspace/summit/server/logs/*.log
    Tag               summit.app
    Mem_Buf_Limit     10MB
    Skip_Long_Lines   On
    Refresh_Interval  5
    Read_from_Head    Off

[FILTER]
    Name                parser
    Match               summit.app
    Key_Name            log
    Parser              json

[FILTER]
    Name          kubernetes
    Match         summit.app
    Merge_Log     On
    K8S-Logging.Parser On
    K8S-Logging.Exclude Off

[FILTER]
    Name            record_modifier
    Match           summit.app
    Record          service summit-api
    Record          environment ${ENVIRONMENT}

[FILTER]
    Name   modify
    Match  summit.app
    Add    hostname ${HOSTNAME}

[OUTPUT]
    Name            forward
    Match           summit.app
    Host            ${LOGSTASH_HOST}
    Port            ${LOGSTASH_PORT}
    tls             On
    tls.verify      Off

[OUTPUT]
    Name            es
    Match           summit.app
    Host            ${ELASTIC_HOST}
    Port            ${ELASTIC_PORT}
    HTTP_User       ${ELASTIC_USER}
    HTTP_Passwd     ${ELASTIC_PASSWORD}
    Index           summit-logs
    Type            _doc
    Logstash_Format On
    Replace_Dots    On
    Retry_Limit     False

[OUTPUT]
    Name            loki
    Match           summit.app
    Host            ${LOKI_HOST}
    Port            ${LOKI_PORT}
    labels          job="summit",service="api"
    line_format     json

[OUTPUT]
    Name            s3
    Match           summit.app
    bucket          ${S3_LOG_BUCKET}
    region          ${AWS_REGION}
    total_file_size 50M
    upload_timeout  2m
    use_put_object  On
    s3_key_format   /logs/$TAG/%Y/%m/%d/%H/%M/$UUID.gz
    compression     gzip
