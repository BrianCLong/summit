apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: at-evidence-gql-web
  namespace: intelgraph-production
spec:
  args:
    - name: mcUrl
    - name: service
    - name: releaseId
  metrics:
    - name: evidence-ok
      interval: 60s
      successCondition: result.ok == true
      failureLimit: 1
      provider:
        web:
          url: "{{args.mcUrl}}/graphql"
          method: POST
          timeout: 15s
          headers:
            - key: Content-Type
              value: application/json
            - key: Authorization
              valueFrom:
                secretKeyRef: { name: mc-api-token, key: token }
          jsonBody:
            queryFrom:
              configMapKeyRef: { name: mc-evidence-query, key: query.graphql }
            variables:
              service: "{{args.service}}"
              releaseId: "{{args.releaseId}}"
          jsonPath: "$.data.evidenceOk"

