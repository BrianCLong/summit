# Canonical Graph Schema Extensions
# GA-ready entity types and ER pipeline

# Extended entity types aligned with Council Wishbook
enum CanonicalEntityType {
  PERSON
  ORGANIZATION
  LOCATION
  ASSET
  ACCOUNT
  EVENT
  DOCUMENT
  COMMUNICATION
  DEVICE
  VEHICLE
  INFRASTRUCTURE
  FINANCIAL_INSTRUMENT
  INDICATOR
  CLAIM
  CASE
  NARRATIVE
  CAMPAIGN
  LICENSE
  AUTHORITY
  SENSOR
  RUNBOOK
  EVIDENCE
  HYPOTHESIS
}

# Policy & Governance
enum SensitivityLevel {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
  TOP_SECRET
}

enum ClearanceLevel {
  PUBLIC
  AUTHORIZED
  CONFIDENTIAL
  SECRET
  TOP_SECRET
}

enum RetentionClass {
  TRANSIENT
  SHORT_TERM
  MEDIUM_TERM
  LONG_TERM
  PERMANENT
  LEGAL_HOLD
}

type PolicyLabels {
  origin: String!
  sensitivity: SensitivityLevel!
  clearance: ClearanceLevel!
  legalBasis: String!
  needToKnow: [String!]!
  purposeLimitation: [String!]!
  retentionClass: RetentionClass!
}

input PolicyLabelsInput {
  origin: String!
  sensitivity: SensitivityLevel!
  clearance: ClearanceLevel!
  legalBasis: String!
  needToKnow: [String!]!
  purposeLimitation: [String!]!
  retentionClass: RetentionClass!
}

# Bitemporal Fields
type TemporalFields {
  validFrom: DateTime!
  validTo: DateTime
  observedAt: DateTime!
  recordedAt: DateTime!
}

# Base Entity Interface
interface CanonicalEntity {
  id: ID!
  tenantId: String!
  entityType: CanonicalEntityType!
  policyLabels: PolicyLabels!
  temporal: TemporalFields!
  properties: JSON
}

# Concrete Entity Types (Simplified for schema brevity, mapped to JSON where complex)
type Person implements CanonicalEntity {
  id: ID!
  tenantId: String!
  entityType: CanonicalEntityType!
  policyLabels: PolicyLabels!
  temporal: TemporalFields!
  name: JSON!
  identifiers: JSON
  demographics: JSON
  status: String
  properties: JSON
}

type Organization implements CanonicalEntity {
  id: ID!
  tenantId: String!
  entityType: CanonicalEntityType!
  policyLabels: PolicyLabels!
  temporal: TemporalFields!
  name: String!
  registration: JSON
  orgType: String
  properties: JSON
}

type Claim implements CanonicalEntity {
  id: ID!
  tenantId: String!
  entityType: CanonicalEntityType!
  policyLabels: PolicyLabels!
  temporal: TemporalFields!
  statement: String!
  claimType: String!
  subjects: JSON!
  sources: JSON!
  verification: JSON
  relatedClaims: JSON
  properties: JSON
}

# Generic fallback for other types
type GenericEntity implements CanonicalEntity {
  id: ID!
  tenantId: String!
  entityType: CanonicalEntityType!
  policyLabels: PolicyLabels!
  temporal: TemporalFields!
  properties: JSON
}

# Provenance
enum VerificationStatus {
  UNVERIFIED
  PARTIAL
  VERIFIED
  DISPUTED
  INVALIDATED
}

enum ProvenanceAction {
  INGEST
  TRANSFORM
  ENRICH
  MERGE
  SPLIT
  VALIDATE
  REGISTER_CLAIM
  CREATE_UPDATE_ENTITY
  CREATE_RELATIONSHIP
}

type ProvenanceEntry {
  id: ID!
  tenantId: String!
  sequenceNumber: String!
  previousHash: String!
  currentHash: String!
  timestamp: DateTime!
  actionType: String!
  resourceType: String!
  resourceId: String!
  actorId: String!
  actorType: String!
  payload: JSON
  metadata: JSON
  signature: String
}

type LedgerVerification {
  valid: Boolean!
  totalEntries: Int!
  brokenChains: Int!
  invalidHashes: Int!
  verificationTime: Float!
}

# Queries
extend type Query {
  # Graph Core
  canonicalEntity(id: ID!, asOf: DateTime): CanonicalEntity

  # Provenance Ledger
  provenanceEntries(
    resourceId: ID
    actionType: String
    limit: Int = 50
  ): [ProvenanceEntry!]!

  verifyLedgerIntegrity: LedgerVerification!

  exportLedger(format: String): String!
}

# Mutations
extend type Mutation {
  # Graph Core
  createCanonicalEntity(
    entityType: CanonicalEntityType!
    data: JSON!
    policyLabels: PolicyLabelsInput!
  ): CanonicalEntity!

  updateCanonicalEntity(
    id: ID!
    data: JSON!
    policyLabels: PolicyLabelsInput
  ): CanonicalEntity!

  createRelationship(
    fromId: ID!
    toId: ID!
    relationType: String!
    properties: JSON
  ): JSON!

  # Claims
  registerClaim(
    statement: String!
    subjects: JSON!
    sources: JSON!
    policyLabels: PolicyLabelsInput!
    relatedClaims: JSON
  ): Claim!

  linkEvidenceToClaim(
    claimId: ID!
    evidenceId: ID!
    weight: Float!
    description: String!
  ): JSON!
}
