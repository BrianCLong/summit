FROM node:22-alpine

WORKDIR /app

# Install build dependencies for native modules like canvas
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    cairo-dev \
    jpeg-dev \
    pango-dev \
    musl-dev \
    giflib-dev \
    pixman-dev \
    pangomm-dev \
    libjpeg-turbo-dev \
    freetype-dev \
    curl

# Install nodemon globally
RUN npm install -g pnpm nodemon

# Create a non-root user
RUN addgroup --system appgroup && adduser --system --ingroup appgroup appuser

# Set npm/pnpm resilience
ENV PUPPETEER_SKIP_DOWNLOAD=1 \
    NPM_CONFIG_AUDIT=false \
    NPM_CONFIG_FUND=false \
    NPM_CONFIG_ENGINE_STRICT=false

# Copy workspace configuration
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY server/package.json ./server/
COPY packages/maestro-core/package.json ./packages/maestro-core/
COPY packages/telemetry-config/package.json ./packages/telemetry-config/
COPY packages/feature-flags/package.json ./packages/feature-flags/
COPY services/osint-collector/package.json ./services/osint-collector/

# Install dependencies for the server workspace
RUN pnpm install --filter intelgraph-server... --frozen-lockfile || pnpm install --filter intelgraph-server...

# Copy the rest of the code
COPY . .

# Set permissions
RUN mkdir -p server/uploads server/logs && chown -R appuser:appgroup /app

# Switch to the server directory for execution
WORKDIR /app/server

# Switch to non-root user
USER appuser

HEALTHCHECK --interval=30s --timeout=10s --retries=3 CMD curl -f http://localhost:4000/health/ready || exit 1

# Expose ports
EXPOSE 4000 9229

# Start development server
CMD ["pnpm", "run", "dev"]
