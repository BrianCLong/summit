package emergency
import future.keywords.if
import future.keywords.in


# Emergency Policy: 2026-01-27
# CVE-2026-21509 (Office Zero-Day) & CVE-2026-22709 (vm2 Sandbox Escape)

default allow := false

# Deny any usage of vulnerable vm2 versions in dependencies
deny_vm2_vulnerability if {
    input.resource.type == "dependency"
    input.resource.name == "vm2"
    semver.compare(input.resource.version, "3.10.2") < 0
}

# Block all usage of vm2 in high-autonomy agents until patched
deny_vm2_autonomy if {
    input.action.autonomy > 0
    input.resource.type == "library"
    input.resource.name == "vm2"
    # Even if patched, we might want to restrict usage in critical envs for now
    input.environment.production == true
}

# Flag Office process spawning as critical risk
high_risk_office_spawn if {
    input.action.category == "spawn_process"
    input.resource.type == "application"
    input.resource.name in ["winword.exe", "excel.exe", "powerpnt.exe", "outlook.exe"]
}

# Require explicit human approval for Office interactions
requires_approval if {
    high_risk_office_spawn
}

# Supply Chain: Block download from flagged SEO poisoning domains
# (Assuming input.source.domain is available in context)
deny_seo_poisoned_source if {
    input.action.category == "download"
    input.source.reputation_score < 50
    input.source.tags in ["seo_poisoning", "suspicious"]
}

# Governance: All "vm2" usage must be logged with high severity
audit_alert if {
    input.resource.name == "vm2"
    message := "Use of vm2 sandbox detected - verify version >= 3.10.2 immediately"
}
