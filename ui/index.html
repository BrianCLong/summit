<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CompanyOS Control Surface</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        background-color: #020617;
      }

      .bg-grid {
        background-image: linear-gradient(
            rgba(255, 255, 255, 0.05) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 40px 40px;
      }

      .glass-panel {
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 30px 60px rgba(2, 6, 23, 0.45);
        backdrop-filter: blur(24px);
      }

      .gradient-ring {
        position: relative;
      }

      .gradient-ring::before {
        content: '';
        position: absolute;
        inset: -1px;
        border-radius: 9999px;
        padding: 1px;
        background: linear-gradient(120deg, rgba(56, 189, 248, 0.7), rgba(129, 140, 248, 0.7));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      mermaid.initialize({
        startOnLoad: true,
        theme: 'neutral',
        securityLevel: 'loose',
        fontFamily: 'Inter, "Segoe UI", system-ui, -apple-system, sans-serif',
      });

      const cfgFromEnv = () => ({
        PROXY_BASE:
          window.__SYMPHONY_CFG__?.PROXY_BASE ||
          new URLSearchParams(window.location.search).get('proxy') ||
          'http://127.0.0.1:8787',
        LITELLM_BASE:
          window.__SYMPHONY_CFG__?.LITELLM_BASE ||
          new URLSearchParams(window.location.search).get('litellm') ||
          'http://127.0.0.1:4000',
        OLLAMA_BASE:
          window.__SYMPHONY_CFG__?.OLLAMA_BASE ||
          new URLSearchParams(window.location.search).get('ollama') ||
          'http://127.0.0.1:11434',
      });

      const formatTime = (value) =>
        value
          ? new Date(value).toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
            })
          : '--';

      const formatNumber = (value) => {
        if (value === null || value === undefined) return '--';
        return new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(value);
      };

      const formatPercent = (part, total) => {
        if (!total || total === 0) return 0;
        return Math.round((part / total) * 100);
      };

      const useInterval = (fn, delay) => {
        const savedFn = useRef(fn);
        useEffect(() => {
          savedFn.current = fn;
        }, [fn]);
        useEffect(() => {
          if (!delay && delay !== 0) return;
          const id = setInterval(() => savedFn.current(), delay);
          return () => clearInterval(id);
        }, [delay]);
      };

      const api = {
        async fetch(endpoint, options = {}) {
          const config = cfgFromEnv();
          const url = endpoint.startsWith('/') ? `${config.PROXY_BASE}${endpoint}` : endpoint;
          try {
            const response = await fetch(url, {
              headers: { 'Content-Type': 'application/json', ...options.headers },
              ...options,
            });
            if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
            return await response.json();
          } catch (error) {
            console.error('API Error:', error);
            throw error;
          }
        },
        getHealth: () => api.fetch('/health'),
        getBudgets: () => api.fetch('/budgets'),
        getModels: () => api.fetch('/models'),
        getStatus: () => api.fetch('/status.json'),
        ragQuery: (question, limit = 5) =>
          api.fetch('/rag/query', {
            method: 'POST',
            body: JSON.stringify({ question, limit }),
          }),
        ragStats: () => api.fetch('/rag/stats'),
        routePlan: (task, meta = {}) =>
          api.fetch('/route/plan', {
            method: 'POST',
            body: JSON.stringify({ task, meta }),
          }),
        routeExecute: (task, meta = {}, input = '') =>
          api.fetch('/route/execute', {
            method: 'POST',
            body: JSON.stringify({ task, meta, input }),
          }),
        runNeo4jGuard: (keepDb = false) =>
          api.fetch('/neo4j/guard', {
            method: 'POST',
            body: JSON.stringify({ keep_db: keepDb }),
          }),
        createGovernanceRecord: (type, title, details) =>
          api.fetch('/governance/record', {
            method: 'POST',
            body: JSON.stringify({ type, title, details }),
          }),
        getPolicy: () => api.fetch('/policy'),
        updatePolicy: (policy) =>
          api.fetch('/policy', {
            method: 'PUT',
            body: JSON.stringify(policy),
          }),
        getLogs: (tail = 100, filter = '') => api.fetch(`/logs?tail=${tail}&filter=${filter}`),
        runCommand: (cmd) =>
          api.fetch('/run', {
            method: 'POST',
            body: JSON.stringify({ cmd }),
          }),
      };

      const Toast = ({ toast, onClose }) => {
        useEffect(() => {
          if (!toast) return;
          const timer = setTimeout(() => onClose(), 4000);
          return () => clearTimeout(timer);
        }, [toast, onClose]);

        if (!toast) return null;
        return (
          <div className="fixed bottom-8 right-8 z-[999]">
            <div
              className={`glass-panel rounded-2xl px-5 py-4 border-l-4 ${
                toast.type === 'error'
                  ? 'border-red-400 text-red-200'
                  : toast.type === 'success'
                    ? 'border-emerald-400 text-emerald-200'
                    : 'border-sky-400 text-sky-200'
              }`}
            >
              <div className="flex items-start gap-3">
                <span className="text-lg">
                  {toast.type === 'error' ? '‚ö†Ô∏è' : toast.type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}
                </span>
                <div>
                  <p className="text-sm font-semibold tracking-wide uppercase text-slate-100">{toast.title}</p>
                  <p className="text-sm text-slate-200/80">{toast.message}</p>
                </div>
                <button className="text-xs text-slate-400 hover:text-slate-200" onClick={onClose}>
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      };

      const Card = ({ title, description, actions, children, className = '' }) => (
        <div className={`glass-panel rounded-3xl border border-white/5 shadow-2xl shadow-slate-950/50 ${className}`}>
          {(title || actions) && (
            <div className="flex flex-col gap-2 border-b border-white/5 px-6 py-5 sm:flex-row sm:items-center sm:justify-between">
              <div>
                {title && <h3 className="text-sm font-semibold tracking-[0.16em] uppercase text-slate-200">{title}</h3>}
                {description && <p className="text-xs text-slate-400">{description}</p>}
              </div>
              {actions && <div className="flex items-center gap-2">{actions}</div>}
            </div>
          )}
          <div className={`${title ? 'px-6 pb-6 pt-5' : 'p-6'}`}>{children}</div>
        </div>
      );

      const Metric = ({ label, value, delta, intent = 'info', caption }) => (
        <Card className="p-0">
          <div className="space-y-3">
            <p className="text-xs uppercase tracking-[0.3em] text-slate-400">{label}</p>
            <p className="text-3xl font-semibold text-slate-100">{value}</p>
            {caption && <p className="text-xs text-slate-400">{caption}</p>}
            {delta && (
              <span
                className={`inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium ${
                  intent === 'success'
                    ? 'bg-emerald-500/15 text-emerald-300'
                    : intent === 'warning'
                      ? 'bg-amber-500/15 text-amber-300'
                      : 'bg-sky-500/15 text-sky-300'
                }`}
              >
                {intent === 'success' ? '‚ñ≤' : intent === 'warning' ? '‚ñ≥' : '‚óè'} {delta}
              </span>
            )}
          </div>
        </Card>
      );

      const StatusPill = ({ label, status, detail }) => (
        <div className="flex items-center justify-between rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs text-slate-200/90">
          <div className="flex items-center gap-2">
            <span
              className={`h-2.5 w-2.5 rounded-full ${
                status === 'up'
                  ? 'bg-emerald-400 shadow-[0_0_0_4px_rgba(52,211,153,0.25)]'
                  : status === 'warn'
                    ? 'bg-amber-300 shadow-[0_0_0_4px_rgba(252,211,77,0.25)]'
                    : 'bg-rose-400 shadow-[0_0_0_4px_rgba(251,113,133,0.25)]'
              }`}
            ></span>
            <span className="font-medium uppercase tracking-[0.18em] text-slate-300">{label}</span>
          </div>
          <span className="text-[11px] text-slate-400">{detail}</span>
        </div>
      );

      const SectionHeading = ({ title, description }) => (
        <div className="flex flex-col gap-1">
          <h2 className="text-2xl font-semibold text-slate-100">{title}</h2>
          {description && <p className="text-sm text-slate-400">{description}</p>}
        </div>
      );

      const SymphonyApp = () => {
        const config = useMemo(cfgFromEnv, []);
        const [activeSection, setActiveSection] = useState('overview');
        const [systemStatus, setSystemStatus] = useState(null);
        const [budgets, setBudgets] = useState(null);
        const [models, setModels] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [lastUpdated, setLastUpdated] = useState(null);
        const [toast, setToast] = useState(null);

        const sections = [
          { id: 'overview', label: 'Overview', icon: 'üéõÔ∏è', description: 'Pulse of all systems and budgets.' },
          { id: 'routing', label: 'AI Routing Studio', icon: 'üéØ', description: 'Craft and execute orchestration runs.' },
          { id: 'knowledge', label: 'Knowledge Console', icon: 'üß†', description: 'RAG console with source visibility.' },
          { id: 'graph', label: 'Graph Guard', icon: 'üõ°Ô∏è', description: 'Manage Neo4j migrations & safeguards.' },
          { id: 'finance', label: 'Budgets & Spend', icon: 'üí∞', description: 'Provider spend, quotas, and resets.' },
          { id: 'governance', label: 'Governance & LOA', icon: 'üìú', description: 'Policies, approvals, and state machines.' },
          { id: 'observability', label: 'Observability', icon: 'üëÅÔ∏è', description: 'Streaming logs, metrics, and alerts.' },
          { id: 'automation', label: 'Automation & Ops', icon: '‚öôÔ∏è', description: 'Runbooks, CLI, and blast radius controls.' },
          { id: 'docs', label: 'Docs & Runbooks', icon: 'üìö', description: 'Reference architecture and procedures.' },
        ];

        const bootstrap = async () => {
          setLoading(true);
          setError('');
          try {
            const [healthResp, budgetsResp, modelsResp] = await Promise.allSettled([
              api.getHealth(),
              api.getBudgets(),
              api.getModels(),
            ]);

            if (healthResp.status === 'fulfilled') {
              setSystemStatus(healthResp.value);
              setLastUpdated(new Date());
            }

            if (budgetsResp.status === 'fulfilled') {
              setBudgets(budgetsResp.value);
            }

            if (modelsResp.status === 'fulfilled') {
              const payload = modelsResp.value;
              const list = Array.isArray(payload)
                ? payload
                : Array.isArray(payload?.models)
                  ? payload.models
                  : [];
              setModels(list);
            }
          } catch (err) {
            console.error(err);
            setError(err.message || 'Failed to load initial data');
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          bootstrap();
        }, []);

        useInterval(async () => {
          try {
            const health = await api.getHealth();
            setSystemStatus(health);
            setLastUpdated(new Date());
          } catch (err) {
            console.error('Health refresh failed', err);
          }
        }, 10000);

        const handleRunAction = async (action) => {
          if (!action?.cmd) return;
          setToast({ type: 'info', title: action.label || 'Running', message: action.cmd });
          try {
            const result = await api.runCommand(action.cmd);
            setToast({
              type: 'success',
              title: 'Completed',
              message:
                result?.output?.split('\n').slice(-3).join(' ‚Ä¢ ') || 'Command completed successfully',
            });
          } catch (err) {
            setToast({ type: 'error', title: 'Command Failed', message: err.message });
          }
        };

        const renderSection = () => {
          switch (activeSection) {
            case 'overview':
              return (
                <OverviewSection
                  systemStatus={systemStatus}
                  budgets={budgets}
                  models={models}
                  onRunAction={handleRunAction}
                />
              );
            case 'routing':
              return <RoutingSection models={models} />;
            case 'knowledge':
              return <KnowledgeSection />;
            case 'graph':
              return <GraphGuardSection />;
            case 'finance':
              return <FinanceSection budgets={budgets} onRefresh={bootstrap} loading={loading} />;
            case 'governance':
              return <GovernanceSection />;
            case 'observability':
              return <ObservabilitySection />;
            case 'automation':
              return <AutomationSection onRunAction={handleRunAction} />;
            case 'docs':
              return <DocsSection />;
            default:
              return null;
          }
        };

        return (
          <div className="relative min-h-screen overflow-hidden bg-slate-950">
            <div className="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.18),_transparent_55%)]"></div>
            <div className="pointer-events-none absolute inset-0 bg-grid opacity-40"></div>

            <div className="relative mx-auto flex min-h-screen max-w-[1600px] gap-6 px-6 py-10 xl:px-10">
              <aside className="hidden w-72 shrink-0 flex-col gap-6 lg:flex">
                <div className="glass-panel rounded-3xl border border-white/10 px-6 py-6 shadow-xl">
                  <div className="flex items-center gap-3">
                    <div className="gradient-ring rounded-full bg-slate-950 p-[2px]">
                      <div className="flex h-12 w-12 items-center justify-center rounded-full bg-slate-900 text-2xl">üè¢</div>
                    </div>
                    <div>
                      <p className="text-xs uppercase tracking-[0.3em] text-slate-400">CompanyOS</p>
                      <h1 className="text-xl font-semibold text-slate-100">Control Surface</h1>
                    </div>
                  </div>
                  <div className="mt-6 space-y-3 text-xs text-slate-400">
                    <p>
                      Environment: <span className="text-slate-200">dev</span>
                    </p>
                    <p>
                      Proxy Base: <span className="text-slate-300">{config.PROXY_BASE}</span>
                    </p>
                    <p>
                      LiteLLM Base: <span className="text-slate-300">{config.LITELLM_BASE}</span>
                    </p>
                    <p>
                      Ollama Base: <span className="text-slate-300">{config.OLLAMA_BASE}</span>
                    </p>
                  </div>
                </div>

                <nav className="glass-panel flex-1 rounded-3xl border border-white/10 px-3 py-4 shadow-xl">
                  <div className="space-y-1">
                    {sections.map((section) => (
                      <button
                        key={section.id}
                        onClick={() => setActiveSection(section.id)}
                        className={`w-full rounded-2xl px-4 py-3 text-left transition ${
                          activeSection === section.id
                            ? 'bg-sky-500/15 text-sky-100 shadow-lg shadow-sky-900/40'
                            : 'text-slate-300 hover:bg-white/5 hover:text-slate-100'
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <span className="text-xl">{section.icon}</span>
                          <div>
                            <p className="text-sm font-medium">{section.label}</p>
                            <p className="text-xs text-slate-400">{section.description}</p>
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>
                </nav>
              </aside>
              <main className="flex-1 space-y-8">
                <header className="glass-panel flex flex-col gap-6 rounded-3xl border border-white/10 px-6 py-6 shadow-xl lg:flex-row lg:items-center lg:justify-between">
                  <div>
                    <p className="text-xs uppercase tracking-[0.28em] text-slate-400">Executive Console</p>
                    <h2 className="mt-2 text-3xl font-semibold text-slate-100">
                      {sections.find((s) => s.id === activeSection)?.label || 'Overview'}
                    </h2>
                    <p className="text-sm text-slate-400">
                      {sections.find((s) => s.id === activeSection)?.description || ''}
                    </p>
                  </div>
                  <div className="flex flex-wrap items-center gap-3 text-xs">
                    <StatusPill
                      label="Models"
                      status={systemStatus?.models ? 'up' : 'warn'}
                      detail={`${systemStatus?.models || models.length || 0} ready`}
                    />
                    <StatusPill
                      label="LiteLLM"
                      status={systemStatus?.litellm ? 'up' : 'down'}
                      detail={systemStatus?.litellm ? 'connected' : 'offline'}
                    />
                    <StatusPill
                      label="Ollama"
                      status={systemStatus?.ollama ? 'up' : 'down'}
                      detail={systemStatus?.ollama ? 'online' : 'offline'}
                    />
                    <StatusPill
                      label="Neo4j"
                      status={systemStatus?.neo4j ? 'up' : 'warn'}
                      detail={systemStatus?.neo4j ? 'secured' : 'pending'}
                    />
                    <div className="rounded-full border border-white/10 bg-white/5 px-4 py-2 text-[11px] text-slate-400">
                      Last Sync ¬∑ {formatTime(lastUpdated)}
                    </div>
                  </div>
                </header>

                <div>{loading ? <LoadingState /> : renderSection()}</div>
              </main>

              <aside className="hidden w-[22rem] shrink-0 xl:block">
                <RightRail
                  systemStatus={systemStatus}
                  budgets={budgets}
                  models={models}
                  lastUpdated={lastUpdated}
                  onRefresh={bootstrap}
                />
              </aside>
            </div>

            <Toast toast={toast} onClose={() => setToast(null)} />
          </div>
        );
      };

      const LoadingState = () => (
        <div className="flex min-h-[40vh] items-center justify-center">
          <div className="glass-panel flex items-center gap-3 rounded-full px-6 py-3 text-sm text-slate-300">
            <span className="h-2 w-2 animate-pulse rounded-full bg-sky-400"></span>
            Booting orchestration surface‚Ä¶
          </div>
        </div>
      );

      const OverviewSection = ({ systemStatus, budgets, models, onRunAction }) => {
        const fallbackRoutes = [
          { ts: '15:05:21', task: 'nl2cypher', model: 'local/llama', loa: 1, cost: 0.0, tokens: 245, status: 'ok' },
          { ts: '15:03:14', task: 'rag', model: 'local/qwen', loa: 1, cost: 0.0, tokens: 180, status: 'ok' },
          { ts: '15:01:52', task: 'summarize', model: 'openrouter/gpt-4o-mini', loa: 2, cost: 0.02, tokens: 480, status: 'ok' },
        ];

        const quickActions = [
          { id: 'smoke', label: 'Run Smoke Test', cmd: 'npm run smoke', tone: 'info' },
          { id: 'chaos', label: 'Chaos Drill', cmd: 'npm run chaos:inject', tone: 'warn' },
          { id: 'validate', label: 'Validate Config', cmd: 'npm run validate:config', tone: 'success' },
        ];

        const modelList = Array.isArray(models) && models.length > 0 ? models : ['local/llama', 'local/qwen-coder', 'openrouter/gpt-4o-mini'];

        const serviceHealth = [
          { label: 'Proxy', status: 'up', detail: 'api gateway :8787' },
          {
            label: 'LiteLLM',
            status: systemStatus?.litellm ? 'up' : 'down',
            detail: systemStatus?.litellm ? 'connected' : 'offline',
          },
          { label: 'Ollama', status: systemStatus?.ollama ? 'up' : 'down', detail: systemStatus?.ollama ? 'listening :11434' : 'offline' },
          { label: 'RAG Index', status: 'up', detail: '4 docs / 7m fresh' },
        ];

        const budgetSummary = () => {
          if (!budgets) return { total: 0, limit: 100 };
          const entries = budgets?.daily_limits || budgets?.daily || budgets?.providers;
          if (!entries) return { total: 0, limit: 100 };
          if (Array.isArray(entries)) {
            const spent = entries.reduce((acc, item) => acc + (item?.spent || item?.usage || 0), 0);
            const limit = entries.reduce((acc, item) => acc + (item?.limit || 0), 0);
            return { total: spent, limit };
          }
          const keys = Object.keys(entries);
          const limit = keys.reduce((acc, key) => acc + (entries[key] || 0), 0);
          const spent = keys.reduce((acc, key) => acc + (budgets?.daily_spend?.[key] || budgets?.spend?.[key] || 0), 0);
          return { total: spent, limit };
        };

        const budgetTotals = budgetSummary();

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Operational Overview"
              description="Key vitals across routing, spend, and platform health."
            />

            <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
              <Metric
                label="Latency (p50)"
                value={`${systemStatus?.latency?.p50 || '120'} ms`}
                delta="Stable"
                intent="success"
                caption="Rolling 15 minute window"
              />
              <Metric
                label="Latency (p95)"
                value={`${systemStatus?.latency?.p95 || '480'} ms`}
                delta="-6%"
                intent="success"
                caption="Target under 600ms"
              />
              <Metric
                label="Requests/min"
                value={formatNumber(systemStatus?.rps || 74)}
                delta="Capacity 120"
                intent="info"
                caption="Across all gateways"
              />
              <Metric
                label="Daily Spend"
                value={`$${formatNumber(budgetTotals.total || 0)}`}
                delta={`Cap $${formatNumber(budgetTotals.limit || 0)}`}
                intent="warning"
                caption="Resets at 00:00Z"
              />
            </div>

            <div className="grid gap-6 xl:grid-cols-3">
              <Card
                title="Service Health"
                description="Live connectivity across orchestration stack."
                className="xl:col-span-2"
              >
                <div className="grid gap-3 md:grid-cols-2">
                  {serviceHealth.map((item) => (
                    <StatusPill key={item.label} label={item.label} status={item.status} detail={item.detail} />
                  ))}
                </div>
                <div className="mt-6 grid gap-4 md:grid-cols-2">
                  <div>
                    <p className="text-xs uppercase tracking-[0.24em] text-slate-400">Models Ready</p>
                    <ul className="mt-3 space-y-2 text-sm text-slate-300">
                      {modelList.slice(0, 5).map((model) => (
                        <li
                          key={model}
                          className="flex items-center justify-between rounded-2xl border border-white/5 bg-white/5 px-4 py-2"
                        >
                          <span className="font-medium text-slate-100">{model}</span>
                          <span className="text-[11px] text-slate-400">ready</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                  <div>
                    <p className="text-xs uppercase tracking-[0.24em] text-slate-400">Alerts</p>
                    <div className="mt-3 rounded-2xl border border-amber-500/30 bg-amber-500/10 px-4 py-3 text-xs text-amber-200">
                      No active incidents. Next chaos drill scheduled for 16:30Z.
                    </div>
                  </div>
                </div>
              </Card>

              <Card title="Quick Actions" description="One-click operational routines">
                <div className="space-y-3">
                  {quickActions.map((action) => (
                    <button
                      key={action.id}
                      onClick={() => onRunAction(action)}
                      className={`w-full rounded-2xl px-4 py-3 text-sm font-medium transition ${
                        action.tone === 'warn'
                          ? 'bg-rose-500/15 text-rose-100 hover:bg-rose-500/25'
                          : action.tone === 'success'
                            ? 'bg-emerald-500/15 text-emerald-100 hover:bg-emerald-500/25'
                            : 'bg-sky-500/15 text-sky-100 hover:bg-sky-500/25'
                      }`}
                    >
                      {action.label}
                    </button>
                  ))}
                </div>
              </Card>
            </div>

            <div className="grid gap-6 xl:grid-cols-3">
              <Card
                title="Recent Routes"
                description="Latest orchestration decisions"
                className="xl:col-span-2"
              >
                <div className="overflow-hidden rounded-2xl border border-white/5">
                  <table className="min-w-full divide-y divide-white/5 text-sm">
                    <thead className="bg-white/5 text-xs uppercase tracking-[0.22em] text-slate-400">
                      <tr>
                        <th className="px-4 py-3 text-left">Time</th>
                        <th className="px-4 py-3 text-left">Task</th>
                        <th className="px-4 py-3 text-left">Model</th>
                        <th className="px-4 py-3 text-left">LOA</th>
                        <th className="px-4 py-3 text-left">Tokens</th>
                        <th className="px-4 py-3 text-left">Cost</th>
                        <th className="px-4 py-3 text-left">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-white/5 text-slate-300">
                      {fallbackRoutes.map((route) => (
                        <tr key={`${route.ts}-${route.task}`} className="hover:bg-white/3">
                          <td className="px-4 py-3 font-mono text-xs text-slate-400">{route.ts}</td>
                          <td className="px-4 py-3 font-medium text-slate-100">{route.task}</td>
                          <td className="px-4 py-3 text-slate-300">{route.model}</td>
                          <td className="px-4 py-3">{route.loa}</td>
                          <td className="px-4 py-3">{route.tokens}</td>
                          <td className="px-4 py-3">${route.cost.toFixed(3)}</td>
                          <td className="px-4 py-3">
                            <span className="rounded-full bg-emerald-500/10 px-3 py-1 text-[11px] uppercase tracking-[0.18em] text-emerald-200">
                              {route.status}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </Card>

              <Card title="Activity Stream" description="Operational logbook">
                <div className="space-y-4 text-sm text-slate-300">
                  <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                    <p className="font-semibold text-slate-100">15:05</p>
                    <p className="text-slate-300">model local/llama p95 480ms (steady)</p>
                  </div>
                  <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                    <p className="font-semibold text-slate-100">15:03</p>
                    <p className="text-slate-300">neo4j guard applied 001_init</p>
                  </div>
                  <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                    <p className="font-semibold text-slate-100">14:58</p>
                    <p className="text-slate-300">rag refresh completed (4 docs)</p>
                  </div>
                </div>
              </Card>
            </div>
          </div>
        );
      };
      const RoutingSection = ({ models }) => {
        const [task, setTask] = useState('generate incident runbook for latency spike');
        const [tenant, setTenant] = useState('default');
        const [loa, setLoa] = useState('1');
        const [costCap, setCostCap] = useState('0.10');
        const [plan, setPlan] = useState(null);
        const [execution, setExecution] = useState(null);
        const [loadingPlan, setLoadingPlan] = useState(false);
        const [loadingExec, setLoadingExec] = useState(false);
        const [input, setInput] = useState('');

        const modelList = Array.isArray(models) && models.length > 0 ? models : ['local/llama', 'local/qwen', 'openrouter/gpt-4o-mini'];

        const handlePlan = async () => {
          if (!task.trim()) return;
          setLoadingPlan(true);
          setExecution(null);
          try {
            const meta = { loa: Number(loa), tenant, cost_cap: costCap };
            const response = await api.routePlan(task, meta);
            setPlan(response);
          } catch (err) {
            setPlan({
              decision: { model: 'local/llama', confidence: 0.82 },
              steps: [
                { id: 1, action: 'Evaluate policy constraints', result: 'LOA within allowance' },
                { id: 2, action: 'Select local/llama', result: 'Best latency/cost for dev' },
              ],
            });
          } finally {
            setLoadingPlan(false);
          }
        };

        const handleExecute = async () => {
          if (!task.trim()) return;
          setLoadingExec(true);
          try {
            const meta = { loa: Number(loa), tenant, cost_cap: costCap, model_hint: plan?.decision?.model };
            const response = await api.routeExecute(task, meta, input);
            setExecution(response);
          } catch (err) {
            setExecution({
              output: 'Executed locally. Tokens: 245. Cost: $0.000',
            });
          } finally {
            setLoadingExec(false);
          }
        };

        return (
          <div className="space-y-8">
            <SectionHeading
              title="AI Routing Studio"
              description="Plan, simulate, and execute orchestration requests with full policy visibility."
            />

            <div className="grid gap-6 xl:grid-cols-3">
              <Card title="Request Parameters" description="Define task scope and guardrails" className="xl:col-span-2">
                <div className="grid gap-5 md:grid-cols-2">
                  <div className="space-y-2">
                    <label className="text-xs uppercase tracking-[0.24em] text-slate-400">Task</label>
                    <textarea
                      value={task}
                      onChange={(e) => setTask(e.target.value)}
                      rows={5}
                      className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-400 focus:outline-none"
                      placeholder="Describe the orchestration task"
                    />
                  </div>
                  <div className="space-y-4">
                    <div className="space-y-2">
                      <label className="text-xs uppercase tracking-[0.24em] text-slate-400">LOA</label>
                      <select
                        value={loa}
                        onChange={(e) => setLoa(e.target.value)}
                        className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100"
                      >
                        <option value="0">0 - read only</option>
                        <option value="1">1 - local only</option>
                        <option value="2">2 - hosted allowed</option>
                        <option value="3">3 - full escalation</option>
                      </select>
                    </div>
                    <div className="space-y-2">
                      <label className="text-xs uppercase tracking-[0.24em] text-slate-400">Tenant</label>
                      <select
                        value={tenant}
                        onChange={(e) => setTenant(e.target.value)}
                        className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100"
                      >
                        <option value="default">default</option>
                        <option value="staging">staging</option>
                        <option value="prod">prod</option>
                      </select>
                    </div>
                    <div className="space-y-2">
                      <label className="text-xs uppercase tracking-[0.24em] text-slate-400">Cost Cap ($)</label>
                      <input
                        value={costCap}
                        onChange={(e) => setCostCap(e.target.value)}
                        className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100"
                      />
                    </div>
                  </div>
                </div>
                <div className="mt-6 flex flex-wrap items-center gap-3">
                  <button
                    onClick={handlePlan}
                    disabled={loadingPlan}
                    className="rounded-2xl bg-sky-500/20 px-5 py-3 text-sm font-medium text-sky-100 shadow shadow-sky-900/40 transition hover:bg-sky-500/30 disabled:opacity-40"
                  >
                    {loadingPlan ? 'Planning‚Ä¶' : 'Generate Plan'}
                  </button>
                  <button
                    onClick={handleExecute}
                    disabled={loadingExec}
                    className="rounded-2xl bg-emerald-500/20 px-5 py-3 text-sm font-medium text-emerald-100 shadow shadow-emerald-900/40 transition hover:bg-emerald-500/30 disabled:opacity-40"
                  >
                    {loadingExec ? 'Executing‚Ä¶' : 'Execute Route'}
                  </button>
                </div>
              </Card>

              <Card title="Model Catalog" description="Available models & throughput">
                <div className="space-y-3 text-sm text-slate-300">
                  {modelList.map((model) => (
                    <div key={model} className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                      <p className="font-medium text-slate-100">{model}</p>
                      <p className="text-xs text-slate-400">Latency 120ms p50 ‚Ä¢ Tokens/min 600</p>
                    </div>
                  ))}
                </div>
              </Card>
            </div>

            <div className="grid gap-6 xl:grid-cols-2">
              <Card title="Routing Plan" description="Transparent decision path">
                {plan ? (
                  <div className="space-y-4 text-sm text-slate-300">
                    <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                      <p className="text-xs uppercase tracking-[0.2em] text-slate-400">Decision</p>
                      <p className="mt-1 text-lg font-semibold text-slate-100">{plan?.decision?.model || 'local/llama'}</p>
                      <p className="text-xs text-slate-400">Confidence {plan?.decision?.confidence || 0.82}</p>
                    </div>
                    <ol className="space-y-3">
                      {(plan?.steps || []).map((step, index) => (
                        <li key={step.id || index} className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                          <p className="text-xs uppercase tracking-[0.2em] text-slate-400">Step {index + 1}</p>
                          <p className="mt-1 text-slate-200">{step.action}</p>
                          <p className="text-xs text-slate-400">{step.result}</p>
                        </li>
                      ))}
                      {!plan?.steps && <p className="text-xs text-slate-400">Plan details unavailable.</p>}
                    </ol>
                  </div>
                ) : (
                  <p className="text-sm text-slate-400">Generate a plan to view model decisions and guardrails.</p>
                )}
              </Card>

              <Card title="Execution Output" description="Live response from selected route">
                <div className="space-y-4">
                  <textarea
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    rows={4}
                    placeholder="Optional: provide input payload to execute"
                    className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100"
                  />
                  <div className="rounded-2xl border border-white/5 bg-slate-950/60 px-4 py-4 font-mono text-xs text-slate-300">
                    {loadingExec ? 'Executing route‚Ä¶' : execution?.output || '# awaiting execution'}
                  </div>
                </div>
              </Card>
            </div>
          </div>
        );
      };
      const KnowledgeSection = () => {
        const [query, setQuery] = useState('how do we run neo4j guard?');
        const [response, setResponse] = useState(null);
        const [loading, setLoading] = useState(false);
        const [stats, setStats] = useState({ files: 4, updated: '10m ago' });

        useEffect(() => {
          const loadStats = async () => {
            try {
              const result = await api.ragStats();
              setStats({ files: result?.files || 4, updated: result?.last_updated || '10m ago' });
            } catch (err) {
              console.warn('RAG stats unavailable');
            }
          };
          loadStats();
        }, []);

        const handleQuery = async () => {
          if (!query.trim()) return;
          setLoading(true);
          try {
            const result = await api.ragQuery(query);
            setResponse(result);
          } catch (err) {
            setResponse({
              answer:
                'Use neo4j guard CLI (scripts/run-neo4j-guard). Ensure Docker is available and migrations are in db/migrations.',
              context: [
                {
                  id: 1,
                  text: 'Invoke ./scripts/run-neo4j-guard.sh to apply migrations inside disposable Neo4j container.',
                },
                { id: 2, text: 'Set KEEP_DB=1 to persist data; defaults to ephemeral guard database.' },
              ],
              sources: [{ file: 'neo4j_guard.md' }, { file: 'docs/runbooks/neo4j.md' }],
            });
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Knowledge Console"
              description="Contextual retrieval with full traceability and controls."
            />

            <Card
              title={`Corpus ‚Ä¢ ${stats.files} files ‚Ä¢ Updated ${stats.updated}`}
              description="Search the indexed documentation and runbooks"
            >
              <div className="grid gap-6 xl:grid-cols-2">
                <div className="space-y-4">
                  <div className="space-y-2">
                    <label className="text-xs uppercase tracking-[0.24em] text-slate-400">Query</label>
                    <textarea
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      rows={5}
                      className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100"
                      placeholder="Ask anything about the platform"
                    />
                  </div>
                  <div className="flex flex-wrap items-center gap-3 text-xs text-slate-400">
                    <button
                      onClick={handleQuery}
                      disabled={loading}
                      className="rounded-2xl bg-sky-500/20 px-5 py-3 text-sm font-medium text-sky-100 hover:bg-sky-500/30 disabled:opacity-40"
                    >
                      {loading ? 'Searching‚Ä¶' : 'Run Query'}
                    </button>
                    <span>Limit 5 chunks ‚Ä¢ rerank enabled</span>
                  </div>
                </div>
                <div className="space-y-3">
                  <label className="text-xs uppercase tracking-[0.24em] text-slate-400">Answer</label>
                  <div className="min-h-[180px] rounded-2xl border border-white/5 bg-slate-950/60 px-5 py-4 text-sm text-slate-200">
                    {loading ? 'Querying embeddings‚Ä¶' : response?.answer || 'No answer yet'}
                  </div>
                </div>
              </div>
            </Card>

            <div className="grid gap-6 xl:grid-cols-2">
              <Card title="Context Windows" description="Top ranked passages with inline citations">
                <div className="space-y-3 text-sm text-slate-300">
                  {response?.context?.length ? (
                    response.context.slice(0, 5).map((chunk, index) => (
                      <div
                        key={chunk.id || index}
                        className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3"
                      >
                        <p className="text-xs uppercase tracking-[0.2em] text-slate-400">[{index + 1}]</p>
                        <p className="text-slate-200">{chunk.text?.slice(0, 140) || 'context snippet unavailable'}</p>
                      </div>
                    ))
                  ) : (
                    <p className="text-xs text-slate-500">Run a query to see retrieved passages.</p>
                  )}
                </div>
              </Card>

              <Card title="Source Files" description="Exact documents contributing to the answer">
                <div className="space-y-2 text-sm text-slate-300">
                  {response?.sources?.length ? (
                    response.sources.map((source, index) => (
                      <div
                        key={source.file || index}
                        className="flex items-center justify-between rounded-2xl border border-white/5 bg-white/5 px-4 py-2"
                      >
                        <span className="font-mono text-xs text-sky-200">rag/corpus/{source.file}</span>
                        <span className="text-[11px] text-slate-400">open</span>
                      </div>
                    ))
                  ) : (
                    <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3 text-xs text-slate-400">
                      No sources yet.
                    </div>
                  )}
                </div>
              </Card>
            </div>
          </div>
        );
      };

      const GraphGuardSection = () => {
        const [keepDb, setKeepDb] = useState(false);
        const [running, setRunning] = useState(false);
        const [output, setOutput] = useState('');
        const migrations = [
          { name: '001_init.cypher', status: 'applied' },
          { name: '002_people.cypher', status: 'pending' },
          { name: '003_relationships.cypher', status: 'pending' },
        ];

        const runGuard = async () => {
          setRunning(true);
          setOutput('> run\nApplying 001_init.cypher‚Ä¶ OK\nBolt ready at :7687');
          try {
            const result = await api.runNeo4jGuard(keepDb);
            setOutput((prev) => `${prev}\n${result.output || 'Guard completed successfully'}`);
          } catch (err) {
            setOutput((prev) => `${prev}\nError: ${err.message}`);
          } finally {
            setRunning(false);
          }
        };

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Neo4j Guard"
              description="Apply migrations safely with disposable databases and audit trails."
            />

            <Card
              title="Migration Controls"
              description="Review pending migrations and execute guard"
              actions={
                <label className="flex items-center gap-2 text-xs text-slate-300">
                  <input
                    type="checkbox"
                    checked={keepDb}
                    onChange={(e) => setKeepDb(e.target.checked)}
                    className="rounded border-white/10 bg-slate-900"
                  />
                  KEEP_DB
                </label>
              }
            >
              <div className="grid gap-6 xl:grid-cols-2">
                <div className="space-y-3 text-sm text-slate-300">
                  {migrations.map((migration) => (
                    <div
                      key={migration.name}
                      className="flex items-center justify-between rounded-2xl border border-white/5 bg-white/5 px-4 py-3"
                    >
                      <span className="font-mono text-xs text-slate-200">{migration.name}</span>
                      <span
                        className={`rounded-full px-3 py-1 text-[11px] uppercase tracking-[0.18em] ${
                          migration.status === 'applied'
                            ? 'bg-emerald-500/15 text-emerald-200'
                            : 'bg-amber-500/15 text-amber-200'
                        }`}
                      >
                        {migration.status}
                      </span>
                    </div>
                  ))}
                </div>
                <div className="space-y-4 text-sm text-slate-300">
                  <div className="rounded-2xl border border-white/5 bg-slate-950/60 px-4 py-4 font-mono text-xs">
                    {running ? 'Running guard‚Ä¶' : output || '# ready'}
                  </div>
                  <button
                    onClick={runGuard}
                    disabled={running}
                    className="rounded-2xl bg-sky-500/20 px-5 py-3 text-sm font-medium text-sky-100 hover:bg-sky-500/30 disabled:opacity-40"
                  >
                    {running ? 'Executing‚Ä¶' : 'Run Neo4j Guard'}
                  </button>
                </div>
              </div>
            </Card>
          </div>
        );
      };
      const FinanceSection = ({ budgets, onRefresh, loading }) => {
        const entries = (() => {
          if (!budgets) {
            return [
              { provider: 'openrouter', spent: 0, limit: 10 },
              { provider: 'anthropic', spent: 2.3, limit: 25 },
              { provider: 'vertex', spent: 1.1, limit: 15 },
            ];
          }
          if (Array.isArray(budgets?.daily)) {
            return budgets.daily.map((item) => ({
              provider: item.provider || item.name,
              spent: item.spent || item.usage || 0,
              limit: item.limit || item.budget || 0,
            }));
          }
          if (budgets?.daily_limits) {
            return Object.keys(budgets.daily_limits).map((key) => ({
              provider: key,
              limit: budgets.daily_limits[key] || 0,
              spent: budgets.daily_spend?.[key] || budgets.spent?.[key] || 0,
            }));
          }
          if (budgets?.providers) {
            return budgets.providers.map((item) => ({
              provider: item.name,
              spent: item.spend,
              limit: item.limit,
            }));
          }
          return [];
        })();

        const totalSpent = entries.reduce((acc, item) => acc + (item.spent || 0), 0);
        const totalLimit = entries.reduce((acc, item) => acc + (item.limit || 0), 0);

        const rpmUsage = [
          { model: 'local/llama', used: 14, limit: 60 },
          { model: 'local/qwen-coder', used: 10, limit: 60 },
          { model: 'openrouter/gpt-4o-mini', used: 5, limit: 45 },
        ];

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Budgets & Spend"
              description="Track spend, utilization, and reset windows across providers."
            />

            <Card
              title="Daily Budgets"
              description="Financial guardrails with real-time usage"
              actions={
                <button
                  onClick={onRefresh}
                  className="rounded-full border border-white/10 px-4 py-2 text-xs text-slate-300 hover:border-sky-400 hover:text-sky-200"
                >
                  Refresh
                </button>
              }
            >
              <div className="space-y-4">
                {entries.length ? (
                  entries.map((entry) => {
                    const percent = entry.limit ? Math.min(100, Math.round((entry.spent / entry.limit) * 100)) : 0;
                    return (
                      <div key={entry.provider}>
                        <div className="flex items-center justify-between text-sm text-slate-300">
                          <span className="font-medium text-slate-100">{entry.provider}</span>
                          <span>
                            ${formatNumber(entry.spent || 0)} / ${formatNumber(entry.limit || 0)} ({percent}%)
                          </span>
                        </div>
                        <div className="mt-2 h-2 rounded-full bg-white/5">
                          <div className="h-2 rounded-full bg-sky-400" style={{ width: `${percent}%` }}></div>
                        </div>
                      </div>
                    );
                  })
                ) : (
                  <p className="text-sm text-slate-400">No budget data available.</p>
                )}
                <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3 text-xs text-slate-400">
                  Total spend ${formatNumber(totalSpent)} / ${formatNumber(totalLimit)} ¬∑ Reset at 00:00Z
                </div>
              </div>
            </Card>

            <Card title="RPM Burndown" description="Requests per minute vs capacity">
              <div className="space-y-4 text-sm text-slate-300">
                {rpmUsage.map((item) => {
                  const percent = Math.min(100, Math.round((item.used / item.limit) * 100));
                  return (
                    <div key={item.model}>
                      <div className="flex items-center justify-between">
                        <span className="font-medium text-slate-100">{item.model}</span>
                        <span className="text-xs text-slate-400">{item.used}/{item.limit} rpm</span>
                      </div>
                      <div className="mt-2 h-2 rounded-full bg-white/5">
                        <div className="h-2 rounded-full bg-emerald-400" style={{ width: `${percent}%` }}></div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>

            <Card title="Spend Ledger" description="Recent financial events">
              <div className="space-y-3 text-sm text-slate-300">
                <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                  <p className="font-semibold text-slate-100">15:04</p>
                  <p className="text-xs text-slate-400">openrouter spend $0.00 ‚Ä¢ tokens 0</p>
                </div>
                <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                  <p className="font-semibold text-slate-100">14:59</p>
                  <p className="text-xs text-slate-400">anthropic spend $0.48 ‚Ä¢ tokens 880</p>
                </div>
              </div>
            </Card>
          </div>
        );
      };

      const GovernanceSection = () => {
        const [policy, setPolicy] = useState('');
        const [message, setMessage] = useState('');
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          const loadPolicy = async () => {
            try {
              const data = await api.getPolicy();
              if (typeof data === 'string') {
                setPolicy(data);
              } else if (data) {
                setPolicy(JSON.stringify(data, null, 2));
              }
            } catch (err) {
              setPolicy(`# Symphony Orchestration Policy
env: dev
kill_switch: false
max_loa:
  dev: 3
  staging: 2
  prod: 1

routing_rules:
  - when:
      task: "nl2cypher"
      env: "dev"
    then:
      prefer_local: true
      max_cost: 0.01
  - when:
      env: "prod"
    then:
      hosted_allowed: false

budgets:
  daily_limits:
    openrouter: 10.00
    anthropic: 25.00`);
            }
          };
          loadPolicy();
        }, []);

        useEffect(() => {
          const timer = setTimeout(() => {
            if (typeof mermaid !== 'undefined') {
              mermaid.init(undefined, '.mermaid');
            }
          }, 200);
          return () => clearTimeout(timer);
        }, [policy]);

        const savePolicy = async () => {
          setLoading(true);
          try {
            await api.updatePolicy(policy);
            setMessage('Policy saved successfully.');
          } catch (err) {
            setMessage(`Error saving policy: ${err.message}`);
          } finally {
            setLoading(false);
            setTimeout(() => setMessage(''), 4000);
          }
        };

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Governance & LOA"
              description="Edit policy, review LOA states, and document approvals."
            />

            <Card
              title="Orchestration Policy"
              description="YAML/JSON policy powering routing and LOA"
              actions={
                <button
                  onClick={savePolicy}
                  disabled={loading}
                  className="rounded-full bg-sky-500/20 px-4 py-2 text-xs font-medium text-sky-100 hover:bg-sky-500/30 disabled:opacity-40"
                >
                  {loading ? 'Saving‚Ä¶' : 'Save Policy'}
                </button>
              }
            >
              <textarea
                value={policy}
                onChange={(e) => setPolicy(e.target.value)}
                rows={18}
                className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 font-mono text-xs text-slate-100"
              />
              {message && (
                <p className={`mt-3 text-xs ${message.startsWith('Error') ? 'text-rose-300' : 'text-emerald-300'}`}>
                  {message}
                </p>
              )}
            </Card>

            <div className="grid gap-6 xl:grid-cols-2">
              <Card title="LOA State Machine" description="Mermaid visualization of allowable transitions">
                <div className="mermaid text-slate-900">
                  {`stateDiagram-v2
    [*] --> Ready
    Ready --> KillOn : kill_switch=1
    KillOn --> Ready : kill_switch=0

    Ready --> LOA0 : LOA=0
    Ready --> LOA1 : policy.max_loa>=1
    Ready --> LOA2 : policy.max_loa>=2
    Ready --> LOA3 : policy.max_loa>=3

    LOA0 --> Ready
    LOA1 --> Ready
    LOA2 --> Ready
    LOA3 --> Ready`}
                </div>
              </Card>

              <Card title="Approvals & Audit" description="Latest governance changes">
                <div className="space-y-3 text-sm text-slate-300">
                  <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                    <p className="font-semibold text-slate-100">15:00</p>
                    <p className="text-xs text-slate-400">LOA increased to 2 for staging ‚Ä¢ approved by ops</p>
                  </div>
                  <div className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                    <p className="font-semibold text-slate-100">14:45</p>
                    <p className="text-xs text-slate-400">Kill switch tested ‚Ä¢ result: pass</p>
                  </div>
                </div>
              </Card>
            </div>
          </div>
        );
      };
      const ObservabilitySection = () => {
        const [logs, setLogs] = useState([]);
        const [filter, setFilter] = useState('');
        const [autoRefresh, setAutoRefresh] = useState(true);

        const loadLogs = async () => {
          try {
            const result = await api.getLogs(200, filter);
            setLogs(
              result.logs || [
                { ts: new Date().toISOString(), level: 'info', msg: 'Gateway up on :4000' },
                { ts: new Date().toISOString(), level: 'info', msg: 'Ollama listening :11434' },
                { ts: new Date().toISOString(), level: 'info', msg: 'RAG index ready (4 docs)' },
              ],
            );
          } catch (error) {
            console.error('Failed to load logs:', error);
          }
        };

        useEffect(() => {
          loadLogs();
        }, [filter]);

        useInterval(() => {
          if (autoRefresh) loadLogs();
        }, 2000);

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Observability"
              description="Metrics and live logs across orchestration services."
            />

            <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
              <Metric label="RPS" value="1.2" delta="target 1.5" caption="requests/sec" />
              <Metric label="Latency" value="120ms / 480ms" delta="p50 / p95" intent="info" />
              <Metric label="Queue Depth" value="12" delta="< 30 target" intent="warning" />
              <Metric label="Error Rate" value="0" delta="(15m window)" intent="success" />
            </div>

            <Card
              title="Live Stream"
              description="Tail logs with filtering"
              actions={
                <div className="flex items-center gap-3">
                  <input
                    type="text"
                    placeholder="Filter"
                    value={filter}
                    onChange={(e) => setFilter(e.target.value)}
                    className="rounded-full border border-white/10 bg-slate-950/60 px-4 py-2 text-xs text-slate-100"
                  />
                  <label className="flex items-center gap-2 text-xs text-slate-300">
                    <input
                      type="checkbox"
                      checked={autoRefresh}
                      onChange={(e) => setAutoRefresh(e.target.checked)}
                      className="rounded border-white/10 bg-slate-900"
                    />
                    Auto
                  </label>
                </div>
              }
            >
              <div className="h-96 overflow-auto rounded-2xl border border-white/5 bg-black px-4 py-3 font-mono text-xs text-emerald-400">
                {logs.map((log, index) => (
                  <div key={index} className="mb-1">
                    <span className="text-slate-500">{formatTime(log.ts)}</span>
                    <span
                      className={`ml-2 ${
                        log.level === 'error'
                          ? 'text-rose-400'
                          : log.level === 'warn'
                            ? 'text-amber-300'
                            : 'text-emerald-400'
                      }`}
                    >
                      [{(log.level || 'info').toUpperCase()}]
                    </span>
                    <span className="ml-2 text-slate-200">{log.msg}</span>
                  </div>
                ))}
              </div>
            </Card>
          </div>
        );
      };

      const AutomationSection = ({ onRunAction }) => {
        const [output, setOutput] = useState('');
        const [running, setRunning] = useState(false);
        const [customCommand, setCustomCommand] = useState('npm run smoke');

        const actions = [
          { id: 'smoke', label: 'Run Smoke', cmd: 'npm run smoke' },
          { id: 'chaos', label: 'Inject Chaos', cmd: 'npm run chaos:inject' },
          { id: 'validate', label: 'Validate Config', cmd: 'npm run validate:config' },
          { id: 'restart-proxy', label: 'Restart Proxy', cmd: 'pm2 restart proxy' },
        ];

        const runCustom = async () => {
          if (!customCommand.trim()) return;
          setRunning(true);
          setOutput(`# ${customCommand}\n`);
          try {
            const result = await api.runCommand(customCommand);
            setOutput((prev) => prev + (result.output || 'Command executed'));
          } catch (err) {
            setOutput((prev) => prev + `Error: ${err.message}`);
          } finally {
            setRunning(false);
          }
        };

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Automation & Ops"
              description="Trigger scripted runbooks and ad-hoc commands with full visibility."
            />

            <Card title="Runbook Library" description="Predefined operational commands">
              <div className="grid gap-3 md:grid-cols-2">
                {actions.map((action) => (
                  <button
                    key={action.id}
                    onClick={() => onRunAction(action)}
                    className="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-left text-sm text-slate-200 transition hover:border-sky-400 hover:text-sky-100"
                  >
                    <p className="font-medium">{action.label}</p>
                    <p className="text-xs text-slate-400">{action.cmd}</p>
                  </button>
                ))}
              </div>
            </Card>

            <Card title="Command Console" description="Execute custom commands against automation runner">
              <div className="space-y-4">
                <input
                  value={customCommand}
                  onChange={(e) => setCustomCommand(e.target.value)}
                  className="w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-100"
                />
                <div className="flex gap-3">
                  <button
                    onClick={runCustom}
                    disabled={running}
                    className="rounded-2xl bg-sky-500/20 px-5 py-3 text-sm font-medium text-sky-100 hover:bg-sky-500/30 disabled:opacity-40"
                  >
                    {running ? 'Running‚Ä¶' : 'Execute'}
                  </button>
                  <button
                    onClick={() => setOutput('')}
                    className="rounded-2xl border border-white/10 px-5 py-3 text-sm text-slate-300 hover:border-sky-400 hover:text-sky-200"
                  >
                    Clear
                  </button>
                </div>
                <div className="min-h-[200px] rounded-2xl border border-white/5 bg-black px-4 py-3 font-mono text-xs text-emerald-400">
                  {running ? 'Running command‚Ä¶' : output || '# awaiting command'}
                </div>
              </div>
            </Card>
          </div>
        );
      };

      const DocsSection = () => {
        const sections = [
          {
            title: 'Onboarding',
            items: ['Quick Start Guide', 'Architecture Overview', 'Local Development Setup', 'Model Configuration'],
          },
          {
            title: 'Incident Playbooks',
            items: ['Model Outage Response', 'High Latency Troubleshooting', 'Budget Limit Exceeded', 'RAG Index Corruption'],
          },
          {
            title: 'Release Checklist',
            items: ['Pre-deployment Verification', 'Model Validation Tests', 'Performance Benchmarks', 'Rollback Procedures'],
          },
        ];

        useEffect(() => {
          const timer = setTimeout(() => {
            if (typeof mermaid !== 'undefined') {
              mermaid.init(undefined, '.mermaid');
            }
          }, 150);
          return () => clearTimeout(timer);
        }, []);

        return (
          <div className="space-y-8">
            <SectionHeading
              title="Documentation & Runbooks"
              description="Reference architecture, onboarding, and incident response."
            />

            <Card title="Component & Deployment" description="Mermaid architecture diagram">
              <div className="mermaid text-slate-900">
                {`graph LR
  subgraph Browser
    UI[CompanyOS Executive UI]
  end

  subgraph LocalHost
    PX[Local Proxy /api]
    LL[LiteLLM Gateway :4000]
    OL[Ollama :11434]
    RG[RAG DuckDB + index]
    NG[Neo4j Guard]
    BD[Burndown Generator]
  end

  subgraph External
    OR[OpenRouter]
    HF[HuggingFace Inference]
  end

  UI <--> PX
  PX <--> LL
  LL <--> OL
  PX <--> RG
  PX <--> NG
  LL --> OR
  LL --> HF
  PX --> BD`}
              </div>
            </Card>

            <div className="grid gap-6 md:grid-cols-3">
              {sections.map((section) => (
                <Card key={section.title} title={section.title}>
                  <ul className="space-y-2 text-sm text-slate-300">
                    {section.items.map((item) => (
                      <li key={item}>
                        <a href="#" className="text-sky-200 hover:text-sky-100 hover:underline">
                          {item}
                        </a>
                      </li>
                    ))}
                  </ul>
                </Card>
              ))}
            </div>
          </div>
        );
      };

      const RightRail = ({ systemStatus, budgets, models, lastUpdated, onRefresh }) => {
        const services = [
          { name: 'Proxy', status: 'up', detail: 'Ready' },
          { name: 'LiteLLM', status: systemStatus?.litellm ? 'up' : 'down', detail: systemStatus?.litellm ? 'Connected' : 'Offline' },
          { name: 'Ollama', status: systemStatus?.ollama ? 'up' : 'down', detail: systemStatus?.ollama ? 'Online' : 'Offline' },
          { name: 'Neo4j', status: systemStatus?.neo4j ? 'up' : 'warn', detail: systemStatus?.neo4j ? 'Secured' : 'Pending' },
        ];

        const budgetsSummary = (() => {
          if (!budgets) return [];
          if (Array.isArray(budgets?.daily)) return budgets.daily;
          if (budgets?.daily_limits) {
            return Object.keys(budgets.daily_limits).map((key) => ({
              provider: key,
              limit: budgets.daily_limits[key],
              spent: budgets.daily_spend?.[key] || budgets.spent?.[key] || 0,
            }));
          }
          return [];
        })();

        const modelsList = Array.isArray(models) && models.length ? models : ['local/llama', 'local/qwen'];

        return (
          <div className="sticky top-10 space-y-6">
            <Card
              title="Status"
              description="Live service availability"
              actions={
                <button
                  onClick={onRefresh}
                  className="rounded-full border border-white/10 px-4 py-2 text-xs text-slate-300 hover:border-sky-400 hover:text-sky-200"
                >
                  Refresh
                </button>
              }
            >
              <div className="space-y-3 text-sm text-slate-300">
                {services.map((service) => (
                  <StatusPill key={service.name} label={service.name} status={service.status} detail={service.detail} />
                ))}
                <p className="text-[11px] text-slate-500">Last updated {formatTime(lastUpdated)}</p>
              </div>
            </Card>

            <Card title="Budget Snapshot" description="Spend vs limits">
              <div className="space-y-3 text-sm text-slate-300">
                {budgetsSummary.length ? (
                  budgetsSummary.map((entry) => {
                    const limit = entry.limit || entry.budget || 0;
                    const spent = entry.spent || entry.usage || 0;
                    const percent = limit ? Math.min(100, Math.round((spent / limit) * 100)) : 0;
                    return (
                      <div key={entry.provider || entry.name || entry.id}>
                        <div className="flex items-center justify-between text-xs text-slate-400">
                          <span>{entry.provider || entry.name}</span>
                          <span>
                            ${formatNumber(spent)} / ${formatNumber(limit)}
                          </span>
                        </div>
                        <div className="mt-1 h-1.5 rounded-full bg-white/5">
                          <div className="h-1.5 rounded-full bg-sky-400" style={{ width: `${percent}%` }}></div>
                        </div>
                      </div>
                    );
                  })
                ) : (
                  <p className="text-xs text-slate-500">No budget data.</p>
                )}
              </div>
            </Card>

            <Card title="Model Highlights" description="Top orchestrated models">
              <div className="space-y-3 text-sm text-slate-300">
                {modelsList.slice(0, 4).map((model) => (
                  <div key={model} className="rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
                    <p className="font-medium text-slate-100">{model}</p>
                    <p className="text-xs text-slate-400">p95 480ms ‚Ä¢ cost $0.000</p>
                  </div>
                ))}
              </div>
            </Card>
          </div>
        );
      };

      ReactDOM.render(<SymphonyApp />, document.getElementById('root'));
    </script>
  </body>
</html>
