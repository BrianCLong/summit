<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Symphony Orchestra - AI Orchestration Platform</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      // Initialize Mermaid
      mermaid.initialize({
        startOnLoad: true,
        theme: 'neutral',
        securityLevel: 'loose',
        fontFamily:
          'ui-monospace, SFMono-Regular, "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace',
      });

      // Configuration from environment
      const cfgFromEnv = () => ({
        PROXY_BASE:
          window.__SYMPHONY_CFG__?.PROXY_BASE ||
          new URLSearchParams(window.location.search).get('proxy') ||
          'http://127.0.0.1:8787',
        LITELLM_BASE:
          window.__SYMPHONY_CFG__?.LITELLM_BASE ||
          new URLSearchParams(window.location.search).get('litellm') ||
          'http://127.0.0.1:4000',
        OLLAMA_BASE:
          window.__SYMPHONY_CFG__?.OLLAMA_BASE ||
          new URLSearchParams(window.location.search).get('ollama') ||
          'http://127.0.0.1:11434',
      });

      // Utility functions
      const formatTime = (date) => new Date(date).toLocaleTimeString();
      const formatPercent = (val, total) =>
        total > 0 ? Math.round((val / total) * 100) : 0;

      // Custom hooks
      const useInterval = (fn, delay) => {
        const savedFn = useRef(fn);
        useEffect(() => {
          savedFn.current = fn;
        }, [fn]);
        useEffect(() => {
          if (!delay && delay !== 0) return;
          const id = setInterval(() => savedFn.current(), delay);
          return () => clearInterval(id);
        }, [delay]);
      };

      const useCountdown = (targetDate) => {
        const [remaining, setRemaining] = useState(
          targetDate.getTime() - Date.now(),
        );
        useEffect(() => {
          const id = setInterval(
            () => setRemaining(targetDate.getTime() - Date.now()),
            1000,
          );
          return () => clearInterval(id);
        }, [targetDate]);
        const s = Math.max(0, Math.floor(remaining / 1000));
        return `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
      };

      // API Layer
      const api = {
        async fetch(endpoint, options = {}) {
          const config = cfgFromEnv();
          const url = endpoint.startsWith('/')
            ? `${config.PROXY_BASE}${endpoint}`
            : endpoint;
          try {
            const response = await fetch(url, {
              headers: {
                'Content-Type': 'application/json',
                ...options.headers,
              },
              ...options,
            });
            if (!response.ok)
              throw new Error(`${response.status} ${response.statusText}`);
            return await response.json();
          } catch (error) {
            console.error('API Error:', error);
            throw error;
          }
        },

        // Core endpoints
        getHealth: () => api.fetch('/health'),
        getBudgets: () => api.fetch('/budgets'),
        getModels: () => api.fetch('/models'),
        getStatus: () => api.fetch('/status.json'),

        // RAG endpoints
        ragQuery: (question, limit = 5) =>
          api.fetch('/rag/query', {
            method: 'POST',
            body: JSON.stringify({ question, limit }),
          }),
        ragStats: () => api.fetch('/rag/stats'),

        // Routing endpoints
        routePlan: (task, meta = {}) =>
          api.fetch('/route/plan', {
            method: 'POST',
            body: JSON.stringify({ task, meta }),
          }),
        routeExecute: (task, meta = {}, input = '') =>
          api.fetch('/route/execute', {
            method: 'POST',
            body: JSON.stringify({ task, meta, input }),
          }),

        // Neo4j Guard
        runNeo4jGuard: (keepDb = false) =>
          api.fetch('/neo4j/guard', {
            method: 'POST',
            body: JSON.stringify({ keep_db: keepDb }),
          }),

        // Governance
        createGovernanceRecord: (type, title, details) =>
          api.fetch('/governance/record', {
            method: 'POST',
            body: JSON.stringify({ type, title, details }),
          }),

        // Policy management
        getPolicy: () => api.fetch('/policy'),
        updatePolicy: (policy) =>
          api.fetch('/policy', {
            method: 'PUT',
            body: JSON.stringify(policy),
          }),

        // Logs and monitoring
        getLogs: (tail = 100, filter = '') =>
          api.fetch(`/logs?tail=${tail}&filter=${filter}`),
        runCommand: (cmd) =>
          api.fetch('/run', {
            method: 'POST',
            body: JSON.stringify({ cmd }),
          }),
      };

      // Main App Component
      const SymphonyApp = () => {
        const [activeTab, setActiveTab] = useState('dashboard');
        const [systemStatus, setSystemStatus] = useState(null);
        const [lastUpdate, setLastUpdate] = useState(new Date());
        const config = useMemo(cfgFromEnv, []);

        const tabs = [
          { id: 'dashboard', name: 'Dashboard', icon: '🏠' },
          { id: 'routing', name: 'Routing Studio', icon: '🎯' },
          { id: 'rag', name: 'RAG Console', icon: '🔍' },
          { id: 'neo4j', name: 'Neo4j Guard', icon: '🛡️' },
          { id: 'budgets', name: 'Budgets & Burndown', icon: '💰' },
          { id: 'policies', name: 'Policies & LOA', icon: '📋' },
          { id: 'observability', name: 'Observability', icon: '👁️' },
          { id: 'ci-chaos', name: 'CI & Chaos', icon: '⚡' },
          { id: 'docs', name: 'Docs & Runbooks', icon: '📚' },
        ];

        // Auto-refresh system status
        useInterval(async () => {
          try {
            const health = await api.getHealth();
            setSystemStatus(health);
            setLastUpdate(new Date());
          } catch (error) {
            console.error('Health check failed:', error);
          }
        }, 5000);

        return (
          <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between h-16">
                  <div className="flex items-center space-x-4">
                    <div className="flex items-center space-x-2">
                      <span className="text-2xl">🎼</span>
                      <h1 className="text-xl font-bold text-gray-900">
                        SYMPHONY
                      </h1>
                      <span className="text-sm text-gray-500">
                        ▸ {tabs.find((t) => t.id === activeTab)?.name}
                      </span>
                    </div>
                    <StatusBadges status={systemStatus} />
                  </div>
                  <div className="flex items-center space-x-2 text-sm text-gray-500">
                    <span>ENV: dev</span>
                    <span>LOA: 1</span>
                    <span>Kill: OFF</span>
                    <span>{formatTime(lastUpdate)}</span>
                  </div>
                </div>

                {/* Navigation Tabs */}
                <div className="flex space-x-1 pb-2 overflow-x-auto">
                  {tabs.map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`flex items-center space-x-2 px-3 py-2 text-sm font-medium rounded-lg whitespace-nowrap ${
                        activeTab === tab.id
                          ? 'bg-blue-100 text-blue-700'
                          : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'
                      }`}
                    >
                      <span>{tab.icon}</span>
                      <span>{tab.name}</span>
                    </button>
                  ))}
                </div>
              </div>
            </header>

            {/* Main Content */}
            <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              {activeTab === 'dashboard' && <Dashboard />}
              {activeTab === 'routing' && <RoutingStudio />}
              {activeTab === 'rag' && <RAGConsole />}
              {activeTab === 'neo4j' && <Neo4jGuard />}
              {activeTab === 'budgets' && <BudgetsBurndown />}
              {activeTab === 'policies' && <PoliciesLOA />}
              {activeTab === 'observability' && <Observability />}
              {activeTab === 'ci-chaos' && <CIChaos />}
              {activeTab === 'docs' && <DocsRunbooks />}
            </main>
          </div>
        );
      };

      // Status Badges Component
      const StatusBadges = ({ status }) => {
        const services = [
          { name: 'Models', count: status?.models || 7, status: 'up' },
          { name: 'Ollama', status: status?.ollama ? 'up' : 'down' },
          { name: 'LiteLLM', status: status?.litellm ? 'up' : 'down' },
          { name: 'Neo4j', status: status?.neo4j ? 'up' : 'down' },
          { name: 'Federation', status: 'ready' },
        ];

        return (
          <div className="flex items-center space-x-3 text-sm">
            {services.map((service, index) => (
              <div key={index} className="flex items-center space-x-1">
                <div
                  className={`status-indicator ${
                    service.status === 'up' || service.status === 'ready'
                      ? 'bg-green-500'
                      : 'bg-red-500'
                  }`}
                ></div>
                <span className="text-gray-600">
                  {service.name}
                  {service.count ? `: ${service.count}` : ''}:{' '}
                  {service.status.toUpperCase()}
                </span>
              </div>
            ))}
          </div>
        );
      };

      // Card Component
      const Card = ({ title, children, actions, className = '' }) => (
        <div className={`glass-card rounded-xl shadow-lg ${className}`}>
          <div className="flex items-center justify-between p-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
            {actions && (
              <div className="flex items-center space-x-2">{actions}</div>
            )}
          </div>
          <div className="p-4">{children}</div>
        </div>
      );

      // Dashboard Component (matches wireframe layout)
      const Dashboard = () => {
        const [health, setHealth] = useState(null);
        const [budgets, setBudgets] = useState(null);
        const [recentRoutes] = useState([
          {
            task: 'nl2cy',
            model: 'local/llama',
            loa: 1,
            cost: 0.0,
            tokens: 245,
          },
          {
            task: 'rag',
            model: 'local/qwen-coder',
            loa: 1,
            cost: 0.0,
            tokens: 180,
          },
        ]);
        const [recentLogs] = useState([
          '15:05 model=local/llama p95=120ms',
          '15:04 route plan ok',
          '15:03 neo4j guard applied 001_init',
        ]);

        useEffect(() => {
          Promise.all([api.getHealth(), api.getBudgets()])
            .then(([h, b]) => {
              setHealth(h);
              setBudgets(b);
            })
            .catch(console.error);
        }, []);

        return (
          <div className="space-y-6">
            {/* Health & Performance Row (matches wireframe) */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <Card title="Health: GREEN" className="lg:col-span-2">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                  <div>
                    <div className="text-2xl font-bold text-green-600">
                      120ms
                    </div>
                    <div className="text-sm text-gray-500">p50</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-green-600">
                      480ms
                    </div>
                    <div className="text-sm text-gray-500">p95</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-blue-600">1.2</div>
                    <div className="text-sm text-gray-500">RPS</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-purple-600">7m</div>
                    <div className="text-sm text-gray-500">RAG Fresh</div>
                  </div>
                </div>
                <div className="p-3 bg-green-50 rounded-lg text-sm">
                  <strong>[Budgets]</strong> OpenRouter: $0 / $10 (0%) reset
                  00:12:32
                </div>
              </Card>

              <Card title="Queue / Errors">
                <div className="space-y-4">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-blue-600">12</div>
                    <div className="text-sm text-gray-500">Queue</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-green-600">0</div>
                    <div className="text-sm text-gray-500">Errors(15m)</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-gray-400">0</div>
                    <div className="text-sm text-gray-500">DLQ</div>
                  </div>
                </div>
              </Card>
            </div>

            {/* Quick Actions & Burndown Row */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <Card title="Quick Actions">
                <div className="space-y-2">
                  <button className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Run Smoke
                  </button>
                  <button className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Chaos Drill
                  </button>
                  <button className="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    ValidateCfg
                  </button>
                </div>
              </Card>

              <Card
                title="Burndown (last 60s / 1h / daily)"
                className="lg:col-span-2"
              >
                <div className="space-y-3">
                  <div className="flex items-center space-x-3">
                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                      <div
                        className="bg-blue-600 h-4 rounded-full"
                        style={{ width: '35%' }}
                      ></div>
                    </div>
                    <span className="text-sm text-gray-600">
                      rpm cap... reset m:00
                    </span>
                  </div>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <strong>model: local/llama</strong> req:14 p50 90ms
                    </div>
                    <div>
                      <strong>model: ...cpu</strong> req:10 p50 180ms
                    </div>
                  </div>
                </div>
              </Card>
            </div>

            {/* Recent Activity Row (matches wireframe table layout) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card title="Recent Routes (10)">
                <div className="space-y-2">
                  <div className="grid grid-cols-5 gap-2 text-xs font-semibold text-gray-500 pb-2 border-b">
                    <div>task</div>
                    <div>model</div>
                    <div>LOA</div>
                    <div>cost</div>
                    <div>tok</div>
                  </div>
                  {recentRoutes.map((route, index) => (
                    <div key={index} className="grid grid-cols-5 gap-2 text-sm">
                      <div className="font-mono">{route.task}</div>
                      <div className="font-mono text-blue-600">
                        …/{route.model.split('/')[1]}
                      </div>
                      <div>{route.loa}</div>
                      <div>${route.cost.toFixed(3)}</div>
                      <div>{route.tokens}</div>
                    </div>
                  ))}
                </div>
              </Card>

              <Card title="Recent Logs (tail)">
                <div className="space-y-1 font-mono text-sm">
                  {recentLogs.map((log, index) => (
                    <div key={index} className="text-gray-700">
                      {log}
                    </div>
                  ))}
                </div>
              </Card>
            </div>
          </div>
        );
      };

      // Routing Studio Component (matches wireframe exactly)
      const RoutingStudio = () => {
        const [task, setTask] = useState('nl2cypher');
        const [loa, setLoa] = useState('1');
        const [tenant, setTenant] = useState('default');
        const [costCap, setCostCap] = useState('$0.00');
        const [routeDecision, setRouteDecision] = useState(null);
        const [promptPreview, setPromptPreview] = useState(
          '[system] You are Orion…\n[user] Graph schema: … → produce Cypher',
        );

        const runDryRun = async () => {
          try {
            const result = await api.routePlan(task, { loa, tenant, costCap });
            setRouteDecision(result);
          } catch (error) {
            console.error('Route planning failed:', error);
            setRouteDecision({ model: 'local/llama', confidence: 0.82 });
          }
        };

        const executeNow = async () => {
          try {
            const result = await api.routeExecute(
              task,
              { loa, tenant, costCap },
              promptPreview,
            );
            console.log('Execution result:', result);
          } catch (error) {
            console.error('Route execution failed:', error);
          }
        };

        return (
          <div className="space-y-6">
            {/* Task Configuration (matches wireframe) */}
            <Card
              title="Routing Studio"
              actions={
                <div className="flex space-x-2">
                  <button
                    onClick={runDryRun}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    [Run Dry-Run]
                  </button>
                  <button
                    onClick={executeNow}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                  >
                    [Execute Now]
                  </button>
                </div>
              }
            >
              <div className="mb-4">
                <h4 className="font-semibold mb-3">Task Meta</h4>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Task:
                    </label>
                    <select
                      value={task}
                      onChange={(e) => setTask(e.target.value)}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2"
                    >
                      <option>nl2cypher</option>
                      <option>rag</option>
                      <option>coding</option>
                      <option>general</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      LOA:
                    </label>
                    <select
                      value={loa}
                      onChange={(e) => setLoa(e.target.value)}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2"
                    >
                      <option>1</option>
                      <option>2</option>
                      <option>3</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Tenant:
                    </label>
                    <select
                      value={tenant}
                      onChange={(e) => setTenant(e.target.value)}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2"
                    >
                      <option>default</option>
                      <option>prod</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Cost Cap:
                    </label>
                    <input
                      type="text"
                      value={costCap}
                      onChange={(e) => setCostCap(e.target.value)}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2"
                    />
                  </div>
                </div>
              </div>
            </Card>

            {/* Rule Preview and Prompt Preview (matches wireframe) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card title="Rule Preview">
                <div className="space-y-2 font-mono text-sm">
                  <div>when env=prod → hosted:off</div>
                  <div>when task=nl2cypher → model…</div>
                  <div className="text-gray-500">
                    // Dynamic rules based on policy
                  </div>
                </div>
              </Card>

              <Card title="Prompt Preview">
                <textarea
                  value={promptPreview}
                  onChange={(e) => setPromptPreview(e.target.value)}
                  className="w-full h-32 border border-gray-300 rounded-lg px-3 py-2 font-mono text-sm"
                />
              </Card>
            </div>

            {/* Model Decision (matches wireframe) */}
            <Card title="Model Candidates & Decision">
              <div className="space-y-4">
                <div>
                  <strong>Model Candidates:</strong> local/llama (p50 90ms),
                  …/cpu (p50 180ms), openrouter/…
                </div>
                <div className="flex items-center space-x-4">
                  <div>
                    <strong>Decision:</strong>{' '}
                    {routeDecision?.model || 'local/llama'}
                  </div>
                  <div>
                    <strong>Confidence:</strong> 0.82
                  </div>
                  <button className="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    [Explain]
                  </button>
                </div>
              </div>
            </Card>
          </div>
        );
      };

      // RAG Console Component (matches wireframe exactly)
      const RAGConsole = () => {
        const [query, setQuery] = useState('how do we run neo4j guard?');
        const [response, setResponse] = useState(null);
        const [loading, setLoading] = useState(false);
        const [ragStats, setRagStats] = useState({
          files: 4,
          updated: '10m ago',
        });

        const handleQuery = async () => {
          if (!query.trim()) return;

          setLoading(true);
          try {
            const result = await api.ragQuery(query);
            setResponse(result);
          } catch (error) {
            setResponse({
              answer: 'Use cypher-shell in disposable DB…',
              context: [
                { text: 'cypher-shell migration guide...', id: 1 },
                { text: 'migrations directory structure...', id: 2 },
              ],
              sources: [{ file: 'neo4j_guard.txt' }, { file: 'docs/...' }],
            });
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="space-y-6">
            <Card
              title={`RAG Console - Index: ${ragStats.files} files • Updated: ${ragStats.updated}`}
            >
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Query Section */}
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Query
                    </label>
                    <textarea
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      placeholder="[ how do we run neo4j… ]"
                      className="w-full h-20 border border-gray-300 rounded-lg px-3 py-2"
                    />
                  </div>
                  <div className="flex space-x-2">
                    <button
                      onClick={handleQuery}
                      disabled={loading}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                    >
                      [ Ask ]
                    </button>
                    <button className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                      [ Settings ]
                    </button>
                  </div>
                </div>

                {/* Answer Section */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Answer{' '}
                    {response?.context?.length ? `(with [1][2] cites)` : ''}
                  </label>
                  <div className="bg-gray-50 border border-gray-300 rounded-lg p-3 min-h-[120px]">
                    {loading ? (
                      <div className="text-gray-500">Searching...</div>
                    ) : response?.answer ? (
                      <div className="text-sm whitespace-pre-wrap">
                        {response.answer}
                      </div>
                    ) : (
                      <div className="text-gray-500">No response yet</div>
                    )}
                  </div>
                </div>
              </div>
            </Card>

            {/* Context and Sources (matches wireframe) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card title="Top Context Chunks [1..5]">
                <div className="space-y-2 text-sm">
                  {response?.context?.length ? (
                    response.context.slice(0, 5).map((chunk, index) => (
                      <div
                        key={index}
                        className="p-2 bg-gray-50 rounded border-l-4 border-blue-500"
                      >
                        <div className="font-bold">[{index + 1}]</div>
                        <div className="text-gray-700">
                          {chunk.text?.substring(0, 100) ||
                            `… ${chunk.id === 1 ? 'cypher-shell…' : 'migrations…'}`}
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-gray-500">
                      No context chunks available
                    </div>
                  )}
                </div>
              </Card>

              <Card title="Source Files">
                <div className="space-y-1 text-sm">
                  {response?.sources?.length ? (
                    response.sources.map((source, index) => (
                      <div key={index} className="font-mono text-blue-600">
                        rag/corpus/{source.file || 'unknown.txt'}
                      </div>
                    ))
                  ) : (
                    <>
                      <div className="font-mono text-blue-600">
                        rag/corpus/neo4j_guard.txt
                      </div>
                      <div className="font-mono text-blue-600">docs/…</div>
                    </>
                  )}
                </div>
              </Card>
            </div>
          </div>
        );
      };

      // Neo4j Guard Component (matches wireframe exactly)
      const Neo4jGuard = () => {
        const [keepDb, setKeepDb] = useState(false);
        const [running, setRunning] = useState(false);
        const [output, setOutput] = useState('');
        const [migrations] = useState([
          { name: '001_init.cypher', status: 'completed' },
          { name: '002_people.cypher', status: 'pending' },
        ]);

        const runGuard = async () => {
          setRunning(true);
          setOutput('> Run\nApplying 001… OK\nBolt ready at :7687\n');

          try {
            const result = await api.runNeo4jGuard(keepDb);
            setOutput(
              (prev) =>
                prev + '\n' + (result.output || 'Guard completed successfully'),
            );
          } catch (error) {
            setOutput((prev) => prev + '\nError: ' + error.message);
          } finally {
            setRunning(false);
          }
        };

        return (
          <div className="space-y-6">
            <Card
              title="Neo4j Guard"
              actions={
                <div className="flex items-center space-x-4">
                  <div className="text-sm text-gray-600">
                    MIG_DIR: db/migrations
                  </div>
                  <label className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      checked={keepDb}
                      onChange={(e) => setKeepDb(e.target.checked)}
                      className="rounded"
                    />
                    <span className="text-sm">KEEP_DB: [ ]</span>
                  </label>
                </div>
              }
            >
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Migrations List */}
                <div>
                  <h4 className="font-medium text-gray-900 mb-3">Migrations</h4>
                  <div className="space-y-2">
                    {migrations.map((migration, index) => (
                      <div key={index} className="flex items-center space-x-3">
                        <span
                          className={`w-4 h-4 rounded flex items-center justify-center text-xs ${
                            migration.status === 'completed'
                              ? 'bg-green-500 text-white'
                              : 'bg-gray-300'
                          }`}
                        >
                          {migration.status === 'completed' ? '✓' : ''}
                        </span>
                        <span className="font-mono text-sm">
                          {migration.name}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Console Output */}
                <div>
                  <h4 className="font-medium text-gray-900 mb-3">Console</h4>
                  <div className="bg-black text-green-400 font-mono text-sm p-4 rounded-lg min-h-[200px] overflow-auto">
                    <button
                      onClick={runGuard}
                      disabled={running}
                      className="mb-2 px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 disabled:opacity-50"
                    >
                      > Run
                    </button>
                    <pre className="whitespace-pre-wrap">
                      {output || '# Ready to run migrations...'}
                    </pre>
                    {running && <div className="animate-pulse">▋</div>}
                  </div>
                </div>
              </div>
            </Card>
          </div>
        );
      };

      // Budgets & Burndown Component (matches wireframe exactly)
      const BudgetsBurndown = () => {
        const [budgets, setBudgets] = useState(null);
        const nextMinute = useMemo(() => {
          const d = new Date();
          d.setSeconds(60, 0);
          return d;
        }, []);
        const nextMidnight = useMemo(() => {
          const d = new Date();
          d.setUTCHours(24, 0, 0, 0);
          return d;
        }, []);
        const minuteCountdown = useCountdown(nextMinute);
        const dailyCountdown = useCountdown(nextMidnight);

        useEffect(() => {
          api.getBudgets().then(setBudgets).catch(console.error);
        }, []);

        return (
          <div className="space-y-6">
            <Card title="Burndown & Budgets">
              {/* Minute Window (matches wireframe) */}
              <div className="mb-6">
                <h4 className="font-medium text-gray-900 mb-3">
                  Minute Window (reset {formatTime(nextMinute)})
                </h4>
                <div className="space-y-3">
                  <div className="flex items-center space-x-4">
                    <span className="text-sm font-medium w-32">
                      local/llama
                    </span>
                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                      <div
                        className="bg-blue-600 h-4 rounded-full"
                        style={{ width: '23%' }}
                      ></div>
                    </div>
                    <span className="text-sm text-gray-500">
                      14/60 rpm p50 90ms
                    </span>
                  </div>

                  <div className="flex items-center space-x-4">
                    <span className="text-sm font-medium w-32">
                      local/llama-cpu
                    </span>
                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                      <div
                        className="bg-green-600 h-4 rounded-full"
                        style={{ width: '17%' }}
                      ></div>
                    </div>
                    <span className="text-sm text-gray-500">
                      10/60 rpm p50 180ms
                    </span>
                  </div>
                </div>
              </div>

              {/* Daily Budgets (matches wireframe) */}
              <div>
                <h4 className="font-medium text-gray-900 mb-3">
                  Daily Budgets (reset 00:00Z)
                </h4>
                <div className="space-y-3">
                  <div className="flex items-center space-x-4">
                    <span className="text-sm font-medium w-32">openrouter</span>
                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                      <div
                        className="bg-purple-600 h-4 rounded-full"
                        style={{ width: '0%' }}
                      ></div>
                    </div>
                    <span className="text-sm text-gray-500">$0 / $10 (0%)</span>
                  </div>
                </div>
              </div>
            </Card>
          </div>
        );
      };

      // Policies & LOA Component
      const PoliciesLOA = () => {
        const [policy, setPolicy] = useState('');
        const [loading, setLoading] = useState(false);
        const [message, setMessage] = useState('');

        useEffect(() => {
          setPolicy(`# Symphony Orchestration Policy
env: dev
kill_switch: false
max_loa:
  dev: 3
  staging: 2
  prod: 1

routing_rules:
  - when:
      task: "nl2cypher"
      env: "dev"
    then:
      prefer_local: true
      max_cost: 0.01
  - when:
      env: "prod"
    then:
      hosted_allowed: false

budgets:
  daily_limits:
    openrouter: 10.00
    anthropic: 25.00`);
        }, []);

        const savePolicy = async () => {
          setLoading(true);
          try {
            await api.updatePolicy(policy);
            setMessage('Policy saved successfully ✓');
            setTimeout(() => setMessage(''), 3000);
          } catch (error) {
            setMessage('Error saving policy: ' + error.message);
          } finally {
            setLoading(false);
          }
        };

        // Initialize Mermaid after component mounts
        useEffect(() => {
          const timer = setTimeout(() => {
            if (typeof mermaid !== 'undefined') {
              mermaid.init(undefined, '.mermaid');
            }
          }, 100);
          return () => clearTimeout(timer);
        }, []);

        return (
          <div className="space-y-6">
            <Card
              title="Orchestration Policy"
              actions={
                <div className="flex space-x-2">
                  <button
                    onClick={savePolicy}
                    disabled={loading}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    Save Policy
                  </button>
                </div>
              }
            >
              <div className="space-y-4">
                <textarea
                  value={policy}
                  onChange={(e) => setPolicy(e.target.value)}
                  className="w-full h-96 font-mono text-sm border border-gray-300 rounded-lg p-4"
                  placeholder="Loading policy..."
                />
                {message && (
                  <div
                    className={`text-sm ${message.includes('Error') ? 'text-red-600' : 'text-green-600'}`}
                  >
                    {message}
                  </div>
                )}
              </div>
            </Card>

            {/* LOA State Diagram */}
            <Card title="LOA State Machine">
              <div className="mermaid">
                {`stateDiagram-v2
    [*] --> Ready
    Ready --> KillOn : kill_switch=1
    KillOn --> Ready : kill_switch=0

    Ready --> LOA0 : LOA=0 or env=prod & policy.max_loa=0
    Ready --> LOA1 : policy.max_loa>=1
    Ready --> LOA2 : policy.max_loa>=2
    Ready --> LOA3 : policy.max_loa>=3

    LOA0 --> Ready
    LOA1 --> Ready
    LOA2 --> Ready
    LOA3 --> Ready`}
              </div>
            </Card>
          </div>
        );
      };

      // Observability Component (matches wireframe KPIs)
      const Observability = () => {
        const [logs, setLogs] = useState([]);
        const [filter, setFilter] = useState('');
        const [autoRefresh, setAutoRefresh] = useState(true);

        const loadLogs = async () => {
          try {
            const result = await api.getLogs(200, filter);
            setLogs(
              result.logs || [
                {
                  ts: new Date().toISOString(),
                  level: 'info',
                  msg: 'Gateway up on :4000',
                },
                {
                  ts: new Date().toISOString(),
                  level: 'info',
                  msg: 'Ollama listening :11434',
                },
                {
                  ts: new Date().toISOString(),
                  level: 'info',
                  msg: 'RAG index ready (4 docs)',
                },
              ],
            );
          } catch (error) {
            console.error('Failed to load logs:', error);
          }
        };

        useEffect(() => {
          loadLogs();
        }, [filter]);

        useInterval(() => {
          if (autoRefresh) loadLogs();
        }, 2000);

        return (
          <div className="space-y-6">
            {/* KPIs Row (matches wireframe) */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card title="RPS">
                <div className="text-center">
                  <div className="text-3xl font-bold text-blue-600">1.2</div>
                  <div className="text-sm text-gray-500">requests/sec</div>
                </div>
              </Card>
              <Card title="Latency">
                <div className="text-center space-y-1">
                  <div>
                    <span className="text-lg font-bold">120ms</span>{' '}
                    <span className="text-sm text-gray-500">p50</span>
                  </div>
                  <div>
                    <span className="text-lg font-bold">480ms</span>{' '}
                    <span className="text-sm text-gray-500">p95</span>
                  </div>
                </div>
              </Card>
              <Card title="Queue Depth">
                <div className="text-center">
                  <div className="text-3xl font-bold text-yellow-600">12</div>
                  <div className="text-sm text-gray-500">pending</div>
                </div>
              </Card>
              <Card title="Error Rate (15m)">
                <div className="text-center">
                  <div className="text-3xl font-bold text-green-600">0</div>
                  <div className="text-sm text-gray-500">errors</div>
                </div>
              </Card>
            </div>

            {/* Live Stream Logs */}
            <Card
              title="Live Stream"
              actions={
                <div className="flex items-center space-x-3">
                  <input
                    type="text"
                    placeholder="Search/Filters"
                    value={filter}
                    onChange={(e) => setFilter(e.target.value)}
                    className="px-3 py-1 border border-gray-300 rounded-lg text-sm"
                  />
                  <label className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      checked={autoRefresh}
                      onChange={(e) => setAutoRefresh(e.target.checked)}
                      className="rounded"
                    />
                    <span className="text-sm">Auto</span>
                  </label>
                </div>
              }
            >
              <div className="bg-black text-green-400 font-mono text-sm p-4 rounded-lg h-96 overflow-auto">
                {logs.map((log, index) => (
                  <div key={index} className="mb-1">
                    <span className="text-gray-500">{formatTime(log.ts)}</span>
                    <span
                      className={`ml-2 ${
                        log.level === 'error'
                          ? 'text-red-400'
                          : log.level === 'warn'
                            ? 'text-yellow-400'
                            : 'text-green-400'
                      }`}
                    >
                      [{log.level.toUpperCase()}]
                    </span>
                    <span className="ml-2">{log.msg}</span>
                  </div>
                ))}
              </div>
            </Card>
          </div>
        );
      };

      // CI & Chaos Component (matches wireframe buttons)
      const CIChaos = () => {
        const [running, setRunning] = useState(null);
        const [output, setOutput] = useState('');

        const runCommand = async (cmd, label) => {
          setRunning(label);
          setOutput('');
          try {
            const result = await api.runCommand(cmd);
            setOutput(
              result.stdout +
                (result.stderr ? '\n[stderr]\n' + result.stderr : ''),
            );
          } catch (error) {
            setOutput('Error: ' + error.message);
          } finally {
            setRunning(null);
          }
        };

        const actions = [
          {
            id: 'validate',
            label: 'Config Validate',
            cmd: 'just orchestra-validate',
            color: 'blue',
          },
          {
            id: 'smoke',
            label: 'Smoke Test',
            cmd: 'just orchestra-smoke',
            color: 'green',
          },
          {
            id: 'chaos',
            label: 'Chaos Drills',
            cmd: 'just chaos',
            color: 'red',
          },
        ];

        return (
          <div className="space-y-6">
            <Card title="CI & Chaos">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                {actions.map((action) => (
                  <button
                    key={action.id}
                    onClick={() => runCommand(action.cmd, action.label)}
                    disabled={running === action.label}
                    className={`p-4 rounded-lg border-2 border-dashed text-center transition-colors ${
                      action.color === 'blue'
                        ? 'border-blue-300 hover:border-blue-500 hover:bg-blue-50'
                        : action.color === 'green'
                          ? 'border-green-300 hover:border-green-500 hover:bg-green-50'
                          : 'border-red-300 hover:border-red-500 hover:bg-red-50'
                    } disabled:opacity-50`}
                  >
                    <div className="text-lg font-semibold">
                      {action.id === 'validate' && '✅'}
                      {action.id === 'smoke' && '🧪'}
                      {action.id === 'chaos' && '⚡'} {action.label}
                    </div>
                    <div className="text-sm text-gray-500 mt-1">
                      {action.cmd}
                    </div>
                  </button>
                ))}
              </div>

              {/* Output Console */}
              <div className="bg-black text-green-400 font-mono text-sm p-4 rounded-lg min-h-[300px] overflow-auto">
                {running ? (
                  <div className="animate-pulse">Running {running}...</div>
                ) : output ? (
                  <pre className="whitespace-pre-wrap">{output}</pre>
                ) : (
                  <div className="text-gray-500">
                    # Select an action to run...
                  </div>
                )}
              </div>
            </Card>
          </div>
        );
      };

      // Docs & Runbooks Component (with Mermaid architecture diagram)
      const DocsRunbooks = () => {
        const sections = [
          {
            title: 'Onboarding',
            items: [
              'Quick Start Guide',
              'Architecture Overview',
              'Local Development Setup',
              'Model Configuration',
            ],
          },
          {
            title: 'Incident Playbooks',
            items: [
              'Model Outage Response',
              'High Latency Troubleshooting',
              'Budget Limit Exceeded',
              'RAG Index Corruption',
            ],
          },
          {
            title: 'Release Checklist',
            items: [
              'Pre-deployment Verification',
              'Model Validation Tests',
              'Performance Benchmarks',
              'Rollback Procedures',
            ],
          },
        ];

        // Initialize Mermaid after component mounts
        useEffect(() => {
          const timer = setTimeout(() => {
            if (typeof mermaid !== 'undefined') {
              mermaid.init(undefined, '.mermaid');
            }
          }, 100);
          return () => clearTimeout(timer);
        }, []);

        return (
          <div className="space-y-6">
            {/* Architecture Diagram (matches wireframe) */}
            <Card title="Component & Deployment">
              <div className="mermaid">
                {`graph LR
  subgraph Browser
    UI[Symphony UI Dashboard/Studio]
  end

  subgraph LocalHost
    PX[Local Proxy /api, CORS, allowlist]
    LL[LiteLLM Gateway :4000]
    OL[Ollama :11434]
    RG[RAG DuckDB + index]
    NG[Neo4j Guard Script + Docker]
    BD[Burndown Generator usage_burndown.py]
  end

  subgraph External [optional]
    OR[OpenRouter]
    HF[HuggingFace Inference]
  end

  UI <--> PX
  PX <--> LL
  LL <--> OL
  PX <--> RG
  PX <--> NG
  LL --> OR
  LL --> HF
  PX --> BD`}
              </div>
            </Card>

            {/* Documentation Sections (matches wireframe) */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {sections.map((section, index) => (
                <Card key={index} title={section.title}>
                  <ul className="space-y-2">
                    {section.items.map((item, itemIndex) => (
                      <li key={itemIndex}>
                        <a
                          href="#"
                          className="text-blue-600 hover:text-blue-800 hover:underline"
                        >
                          {item}
                        </a>
                      </li>
                    ))}
                  </ul>
                </Card>
              ))}
            </div>
          </div>
        );
      };

      // Render the app
      ReactDOM.render(<SymphonyApp />, document.getElementById('root'));
    </script>
  </body>
</html>
