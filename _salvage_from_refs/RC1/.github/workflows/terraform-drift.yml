name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 0 * * MON' # Run every Monday at midnight UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  drift-detection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.x.x # Specify your Terraform version

      - name: Run Terraform fmt
        run: terraform fmt -check -recursive

      - name: Run Terraform validate
        run: terraform validate

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.0 # Use a specific version
        with:
          soft_fail: true # Allow tfsec to fail without failing CI

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12 # Use a specific version
        with:
          directory: terraform/environments/ # Scan all Terraform environments
          soft_fail: true # Allow Checkov to fail without failing CI

      - name: Run OPA (conftest) for Terraform policies (Placeholder)
        run: echo "OPA conftest for Terraform policies would run here"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Adjust as needed

      - name: Run Terraform Drift Detection for Dev
        working-directory: terraform/environments/dev
        run: |
          terraform init
          terraform plan -detailed-exitcode
        continue-on-error: true # Allow other environments to be checked

      - name: Run Terraform Drift Detection for Staging
        working-directory: terraform/environments/staging
        run: |
          terraform init
          terraform plan -detailed-exitcode
        continue-on-error: true

      - name: Run Terraform Drift Detection for Prod
        working-directory: terraform/environments/prod
        run: |
          terraform init
          terraform plan -detailed-exitcode
        continue-on-error: true

      - name: Generate Terraform Plan Preview
        working-directory: terraform/environments/prod # Or a specific environment
        run: |
          terraform init
          terraform plan -out=tfplan.out
          # Placeholder for cost estimation tool integration (e.g., Infracost, Terragrunt)
          echo "Cost estimation for this plan would be generated here."
          echo "Upload tfplan.out as an artifact for review."

      - name: Report Drift (Placeholder)
        run: echo "Report any detected drift to Slack/Teams"