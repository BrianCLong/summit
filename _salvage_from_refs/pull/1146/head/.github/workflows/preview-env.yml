name: Preview Environment

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Deploy sandbox chart
        run: |
          helm upgrade --install sandbox-${{ github.event.number }} ./k8s/sandbox --namespace sandbox-${{ github.event.number }} --create-namespace

  smoke-test:
    needs: deploy-preview
    runs-on: ubuntu-latest
    steps:
      - name: Run smoke tests
        run: |
          curl -f http://sandbox-${{ github.event.number }}.example.com

  update-pr:
    needs: smoke-test
    runs-on: ubuntu-latest
    steps:
      - name: Update PR with preview URL
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.number }} --body "Preview environment is ready at http://sandbox-${{ github.event.number }}.example.com"

  teardown:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Teardown preview environment
        run: |
          helm uninstall sandbox-${{ github.event.number }} --namespace sandbox-${{ github.event.number }}
          kubectl delete namespace sandbox-${{ github.event.number }}
