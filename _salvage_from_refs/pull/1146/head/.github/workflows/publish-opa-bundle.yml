name: publish-opa-bundle

permissions:
  contents: read
on:
  push:
    branches: [ main ]
    paths: [ 'policies/opa/**' ]
  tags:
    - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    environment:
      name: policies
      url: https://ghcr.io/${{ github.repository_owner }}/composer-policy-bundle
    concurrency:
      group: policy-bundles
      cancel-in-progress: false
    permissions:
      contents: read
      packages: write
      id-token: write # For keyless signing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OPA
        uses: open-policy-agent/setup-opa@v2

      - name: Build OPA Bundle
        run: opa build -b policies/opa -o bundle.tar.gz

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push OPA Bundle (on main)
        if: startsWith(github.ref, 'refs/heads/')
        run: |
          opa push bundle.tar.gz ghcr.io/${{ github.repository_owner }}/composer-policy-bundle:latest
          opa push bundle.tar.gz ghcr.io/${{ github.repository_owner }}/composer-policy-bundle:sha-${{ github.sha }}

      - name: Push OPA Bundle (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          opa push bundle.tar.gz ghcr.io/${{ github.repository_owner }}/composer-policy-bundle:${{ github.ref_name }}
          opa push bundle.tar.gz ghcr.io/${{ github.repository_owner }}/composer-policy-bundle:latest

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Sign the policy bundle
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          cosign sign --yes ghcr.io/${{ github.repository_owner }}/composer-policy-bundle:latest

      - name: Cosign verify (keyless, pin identity)
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          IDENTITY_RE="https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/.+" 
          ISSUER="https://token.actions.githubusercontent.com"
          cosign verify \
            --certificate-identity-regexp "$IDENTITY_RE" \
            --certificate-oidc-issuer "$ISSUER" \
            ghcr.io/${{ github.repository_owner }}/composer-policy-bundle:latest