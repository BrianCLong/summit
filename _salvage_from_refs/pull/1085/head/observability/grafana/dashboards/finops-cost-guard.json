{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "type": "datasource",
      "pluginId": "prometheus"
    },
    {
      "name": "DS_ATHENA",
      "label": "Athena",
      "type": "datasource",
      "pluginId": "athena"
    }
  ],
  "folder": {
    "name": "/Platform/FinOps"
  },
  "title": "FinOps â€” Cost Guard (Prod)",
  "templating": {
    "list": [
      {
        "name": "tenant",
        "type": "query",
        "label": "Tenant",
        "query": "label_values(cost_cents_total, tenant)",
        "datasource": "DS_PROMETHEUS"
      },
      {
        "name": "service",
        "type": "query",
        "label": "Service",
        "query": "label_values(cost_cents_total, component)",
        "datasource": "DS_PROMETHEUS"
      }
    ]
  },
  "panels": [
    {
      "title": "Total Monthly Cost (CUR)",
      "type": "timeseries",
      "datasource": "DS_ATHENA",
      "targets": [
        {
          "rawSql": "SELECT date_trunc('month', line_item_usage_start_date) AS time, sum(COALESCE(blended_cost, line_item_blended_cost)) AS cost_usd FROM aws_cur.cur_all WHERE $__timeFilter(line_item_usage_start_date) GROUP BY 1 ORDER BY 1",
          "format": "time_series"
        }
      ]
    },
    {
      "title": "Service Breakdown (CUR)",
      "type": "table",
      "datasource": "DS_ATHENA",
      "targets": [
        {
          "rawSql": "SELECT product_product_name AS service, sum(COALESCE(blended_cost, line_item_blended_cost)) AS cost_usd FROM aws_cur.cur_all WHERE $__timeFilter(line_item_usage_start_date) GROUP BY 1 ORDER BY cost_usd DESC LIMIT 20",
          "format": "table"
        }
      ]
    },
    {
      "title": "EKS/EC2 by Namespace/Tenant (CUR)",
      "type": "table",
      "datasource": "DS_ATHENA",
      "targets": [
        {
          "rawSql": "SELECT resource_tags_user_namespace AS namespace, resource_tags_user_tenant AS tenant, sum(COALESCE(blended_cost, line_item_blended_cost)) AS cost_usd FROM aws_cur.cur_all WHERE $__timeFilter(line_item_usage_start_date) AND product_product_name IN ('Amazon Elastic Kubernetes Service','Amazon Elastic Compute Cloud') AND resource_tags_user_tenant = '${tenant:singlequote}' GROUP BY 1,2 ORDER BY cost_usd DESC LIMIT 50",
          "format": "table"
        }
      ]
    },
    {
        "title": "S3 Cost by Storage Class (CUR)",
        "type": "table",
        "datasource": "DS_ATHENA",
        "targets": [
            {
                "rawSql": "SELECT product_storage_class AS storage_class, sum(COALESCE(blended_cost, line_item_blended_cost)) AS cost_usd FROM aws_cur.cur_all WHERE $__timeFilter(line_item_usage_start_date) AND product_product_name='Amazon Simple Storage Service' GROUP BY 1 ORDER BY cost_usd DESC",
                "format": "table"
            }
        ]
    },
    {
        "title": "KMS API Costs (CUR)",
        "type": "table",
        "datasource": "DS_ATHENA",
        "targets": [
            {
                "rawSql": "SELECT product_usagetype AS usage_type, sum(COALESCE(blended_cost, line_item_blended_cost)) AS cost_usd FROM aws_cur.cur_all WHERE $__timeFilter(line_item_usage_start_date) AND product_product_name='AWS Key Management Service' GROUP BY 1 ORDER BY cost_usd DESC",
                "format": "table"
            }
        ]
    },
    {
        "title": "Data Transfer Costs (CUR)",
        "type": "table",
        "datasource": "DS_ATHENA",
        "targets": [
            {
                "rawSql": "SELECT product_usagetype AS usage_type, sum(COALESCE(blended_cost, line_item_blended_cost)) AS cost_usd FROM aws_cur.cur_all WHERE $__timeFilter(line_item_usage_start_date) AND product_product_name LIKE 'AWS Data Transfer%' GROUP BY 1 ORDER BY cost_usd DESC",
                "format": "table"
            }
        ]
    },
    {
      "title": "Per-Tenant App Cost (Prometheus)",
      "type": "timeseries",
      "datasource": "DS_PROMETHEUS",
      "targets": [
        {
          "expr": "sum by (tenant,expert) (rate(cost_cents_total{tenant=~\"$tenant\"}[1h])) / 100"
        }
      ]
    },
    {
        "title": "Cost Guard Breaches (24h)",
        "type": "stat",
        "datasource": "DS_PROMETHEUS",
        "targets": [
            {
                "expr": "sum(increase(cost_guard_breach_total[24h])) by (tenant)"
            }
        ]
    }
  ]
}