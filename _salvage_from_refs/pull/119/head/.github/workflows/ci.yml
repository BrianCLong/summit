name: CI
on:
  pull_request:
  push:
    branches: [ main ]
permissions:
  contents: read
  security-events: write
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Node
      - if: ${{ hashFiles('**/package.json') != '' }}
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          npm ci
          npm -s run -s lint || echo "no lint script"
          npx -y eslint . || true
          npx -y tsc --noEmit || true
          npm test --if-present

      # Python
      - if: ${{ hashFiles('**/requirements.txt','**/pyproject.toml') != '' }}
        uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - if: ${{ hashFiles('**/requirements.txt','**/pyproject.toml') != '' }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install ruff bandit pytest pip-audit
          ruff . || true
          bandit -q -r . || true
          pip-audit || true
          pytest -q || true

      # Go
      - if: ${{ hashFiles('**/go.mod') != '' }}
        uses: actions/setup-go@v5
        with: { go-version: '1.22' }
      - if: ${{ hashFiles('**/go.mod') != '' }}
        run: |
          go vet ./...
          go test ./...

      # Rust
      - if: ${{ hashFiles('**/Cargo.toml') != '' }}
        uses: dtolnay/rust-toolchain@stable
      - if: ${{ hashFiles('**/Cargo.toml') != '' }}
        run: |
          cargo clippy -- -D warnings || true
          cargo test || true

      # Java/Gradle
      - if: ${{ hashFiles('**/pom.xml') != '' }}
        uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '21' }
      - if: ${{ hashFiles('**/pom.xml') != '' }}
        run: mvn -B -ntp test
      - if: ${{ hashFiles('**/build.gradle','**/build.gradle.kts') != '' }}
        uses: gradle/actions/setup-gradle@v4
      - if: ${{ hashFiles('**/build.gradle','**/build.gradle.kts') != '' }}
        run: ./gradlew test

      # Docker
      - if: ${{ hashFiles('**/Dockerfile') != '' }}
        run: |
          if command -v hadolint >/dev/null; then hadolint **/Dockerfile; fi