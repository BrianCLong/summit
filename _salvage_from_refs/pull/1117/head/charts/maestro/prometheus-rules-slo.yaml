apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: maestro-slo-rules
spec:
  groups:
    - name: slo-burn
      rules:
        - record: job:slo_requests:rate5m
          expr: sum by (job)(rate(http_requests_total{job="maestro-gw"}[5m]))
        - record: job:slo_errors:rate5m
          expr: sum by (job)(rate(http_requests_total{job="maestro-gw",code=~"5..|4.."}[5m]))
        - record: job:slo_error_ratio:5m
          expr: job:slo_errors:rate5m / job:slo_requests:rate5m

        - alert: SLOBurnRateHighFast
          expr: job:slo_error_ratio:5m > (1 - 0.995) * 14 # 14x budget burn for fast window
          for: 2m
          labels: { severity: critical, slo: api-latency-200ms, objective: '99.5' }
          annotations:
            summary: 'Fast SLO burn (API latency)'
            runbook_url: https://…/runbooks/slo-api-latency.md

        - alert: SLOBurnRateHighSlow
          expr: avg_over_time(job:slo_error_ratio:5m[1h]) > (1 - 0.995) * 6 # 6x budget burn slow
          for: 15m
          labels: { severity: warning, slo: api-latency-200ms, objective: '99.5' }
          annotations:
            summary: 'Slow SLO burn (API latency)'
            runbook_url: https://…/runbooks/slo-api-latency.md

        - alert: BlackboxProbeFailing
          expr: probe_success == 0
          for: 1m
          labels: { severity: critical }
          annotations:
            summary: 'Blackbox probe failed for {{ $labels.instance }}'
            description: 'Probe to {{ $labels.__param_target }} is failing. Check target availability and Blackbox Exporter logs.'
            runbook_url: https://…/runbooks/probe-failing.md

        - alert: BlackboxProbeTTFBHigh
          expr: histogram_quantile(0.95, probe_duration_seconds_bucket{phase="resolve"}) > 0.5 # Adjust threshold as needed
          for: 5m
          labels: { severity: warning }
          annotations:
            summary: 'High TTFB for blackbox probe {{ $labels.instance }}'
            description: 'Time to first byte for {{ $labels.__param_target }} is high ({{ $value | humanizeDuration }}).'
            runbook_url: https://…/runbooks/probe-ttfb-high.md

    - name: tenant-cost-guards
      rules:
        - record: tenant:monthly_cost:sum
          expr: sum by (tenant)(maestro_cost_usd_total_monthly)

        - alert: TenantCostGuardBreaching80Percent
          expr: tenant:monthly_cost:sum / on(tenant) group_left() maestro_budget_limit{type="hard"} > 0.8
          for: 10m
          labels: { severity: warning, threshold: '80%' }
          annotations:
            summary: 'Tenant {{ $labels.tenant }} monthly cost is at 80% of budget'
            description: 'Tenant {{ $labels.tenant }} has spent {{ $value | humanizePercentage }} of their monthly budget of {{ $labels.budget_limit }}.'
            runbook_url: https://…/runbooks/tenant-cost-guard.md
            grafana_dashboard_url: '{{grafanaBase}}/d/maestro-cost?var-tenant={{ $labels.tenant }}'
            maestro_link: '{{maestroBase}}/maestro/tenants/costs?tenant={{ $labels.tenant }}'

        - alert: TenantCostGuardBreaching90Percent
          expr: tenant:monthly_cost:sum / on(tenant) group_left() maestro_budget_limit{type="hard"} > 0.9
          for: 5m
          labels: { severity: critical, threshold: '90%' }
          annotations:
            summary: 'Tenant {{ $labels.tenant }} monthly cost is at 90% of budget'
            description: 'Tenant {{ $labels.tenant }} has spent {{ $value | humanizePercentage }} of their monthly budget of {{ $labels.budget_limit }}. Immediate action may be required.'
            runbook_url: https://…/runbooks/tenant-cost-guard.md
            grafana_dashboard_url: '{{grafanaBase}}/d/maestro-cost?var-tenant={{ $labels.tenant }}'
            maestro_link: '{{maestroBase}}/maestro/tenants/costs?tenant={{ $labels.tenant }}'

        - alert: TenantCostGuardBreaching100Percent
          expr: tenant:monthly_cost:sum / on(tenant) group_left() maestro_budget_limit{type="hard"} > 1
          for: 1m
          labels: { severity: critical, threshold: '100%' }
          annotations:
            summary: 'Tenant {{ $labels.tenant }} monthly cost exceeded budget'
            description: 'Tenant {{ $labels.tenant }} has exceeded their monthly budget of {{ $labels.budget_limit }}. Workloads may be halted.'
            runbook_url: https://…/runbooks/tenant-cost-guard.md
            grafana_dashboard_url: '{{grafanaBase}}/d/maestro-cost?var-tenant={{ $labels.tenant }}'
            maestro_link: '{{maestroBase}}/maestro/tenants/costs?tenant={{ $labels.tenant }}'
