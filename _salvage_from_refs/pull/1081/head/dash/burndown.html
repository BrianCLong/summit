<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Symphony Burndown</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { margin: 10px 0; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .bar { height: 10px; background:#eee; border-radius:6px; overflow:hidden; }
    .fill { height:100%; background:#4f46e5; width:0%; transition:width .3s; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .muted { color:#666; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <h2>Symphony Burndown & Performance</h2>
  <div id="perf" class="card"></div>
  <div class="grid">
    <div class="card"><h3>1 Minute</h3><div id="m1"></div></div>
    <div class="card"><h3>1 Hour</h3><div id="h1"></div></div>
  </div>
  <div class="card"><h3>1 Day</h3><div id="d1"></div></div>
  <div class="card"><h3>Daily Budgets</h3><div id="budgets"></div></div>

<script>
const fmt = n => n==null? "—" : (typeof n==="number"? n.toFixed(3).replace(/\.?0+$/,''): n);
const pct = x => x==null? "—" : Math.round(x*100)+'%';
const rel = s => s? new Date(s).toLocaleTimeString() : "—";

function meterRow(name, used, cap, extra){
  const frac = (cap && cap>0) ? Math.min(1, used/cap) : null;
  const w = frac==null ? 0 : Math.round(frac*100);
  return `
  <div class="row">
    <div><b>${name}</b> ${cap? `<span class="muted">(cap ${cap})</span>`:''} ${extra||''}</div>
    <div class="bar"><div class="fill" style="width:${w}%"></div></div>
    <div class="muted mono">${used} used ${cap? `/ ${cap} (${w}%)` : ''}</div>
  </div>`;
}

function modelBlock(win){
  const el = document.getElementById(win);
  return data => {
    const W = data.windows[win];
    const per = W.per_model || {};
    let html = `<div class="muted">Resets at ${rel(W.reset_at)}</div>`;
    const names = Object.keys(per).sort();
    names.forEach(m=>{
      const v = per[m];
      const cap = (v.caps && v.caps.minute_rpm_cap) ? v.caps.minute_rpm_cap : null;
      html += meterRow(m, v.req, cap, `<span class="muted">p50 ${fmt(v.p50_ms)}ms · p95 ${fmt(v.p95_ms)}ms · tok ${v.tokens}</span>`);
    });
    el.innerHTML = html || '<div class="muted">No data.</div>';
  };
}

function renderPerf(d){
  const el = document.getElementById('perf');
  el.innerHTML = `
    <b>Instant Perf (last 60s)</b><br/>
    RPS: <span class="mono">${fmt(d.perf.rps_last_60s)}</span> &nbsp;·&nbsp;
    p50: <span class="mono">${fmt(d.perf.p50_ms_last_60s)} ms</span> &nbsp;·&nbsp;
    p95: <span class="mono">${fmt(d.perf.p95_ms_last_60s)} ms</span>
    <div class="muted">Updated ${new Date(d.generated_at).toLocaleTimeString()}</div>
  `;
}

function renderBudgets(d){
  const el = document.getElementById('budgets');
  const B = d.budgets || {};
  const names = Object.keys(B);
  if(!names.length){ el.innerHTML = '<div class="muted">No budgets configured.</div>'; return; }
  el.innerHTML = names.map(p=>{
    const b = B[p];
    const frac = b.fraction_used==null? 0 : Math.round(b.fraction_used*100);
    return `
      <div class="row">
        <div><b>${p}</b> <span class="muted">resets ${rel(b.resets_at)}</span></div>
        <div class="bar"><div class="fill" style="width:${frac}%"></div></div>
        <div class="muted mono">${fmt(b.spent_usd)} / ${fmt(b.daily_budget_usd)} (${frac}%)</div>
      </div>`;
  }).join('');
}

async function tick(){
  try{
    const r = await fetch('/status/burndown.json?_=' + Date.now());
    const d = await r.json();
    renderPerf(d);
    modelBlock('m1')(d);
    modelBlock('h1')(d);
    modelBlock('d1')(d);
    renderBudgets(d);
  }catch(e){
    console.error(e);
  }finally{
    setTimeout(tick, 5000);
  }
}
tick();
</script>
</body>
</html>