# IntelGraph v2.7 SRE Deployment Runbook

## Pre-deployment Checklist

### Infrastructure Readiness
- [ ] Kubernetes cluster health check passed
- [ ] Database migration scripts validated
- [ ] CDN configuration updated for new asset paths
- [ ] Monitoring dashboards deployed
- [ ] Alert rules configured and tested

### Feature Flag Configuration
- [ ] `notifications_audio` enabled for beta tenants only
- [ ] `export_limits` set to 50MB per job, 10 concurrent per tenant
- [ ] `graph_physics_simulation` enabled globally
- [ ] `advanced_search_dsl` enabled for power users

### Performance Baselines
- [ ] Current API p95 latency: ___ms
- [ ] Current search response time: ___ms
- [ ] Current error rate: ___%
- [ ] Current memory usage: ___MB per session

## Deployment Commands

### 1. Database Migration
```bash
# Apply investigation management schema
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph -f /migrations/v2.7/001_investigation_tables.sql

# Add indexes for search performance
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph -f /migrations/v2.7/002_search_indexes.sql

# Verify migration success
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph -c "\dt investigations;"
```

### 2. GraphQL Schema Update
```bash
# Deploy updated schema with subscriptions
kubectl apply -f k8s/graphql-server-v2.7.yaml

# Verify schema introspection
curl -X POST https://api.intelgraph.com/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __schema { queryType { name } } }"}'
```

### 3. Frontend Deployment
```bash
# Build and push new image
docker build -t intelgraph/client:v2.7 .
docker push intelgraph/client:v2.7

# Deploy with canary annotations
kubectl patch deployment client-deployment \
  --patch '{"spec": {"template": {"metadata": {"annotations": {"deployment.kubernetes.io/revision": "v2.7"}}}}}'

# Set canary traffic split (10% initially)
kubectl annotate service client-service "traffic.sidecar.istio.io/canary=10"
```

### 4. Worker Services
```bash
# Deploy export processing workers
kubectl apply -f k8s/export-workers-v2.7.yaml

# Scale to handle increased load
kubectl scale deployment export-workers --replicas=5

# Deploy notification service
kubectl apply -f k8s/notification-service-v2.7.yaml
```

## Rollout Phases

### Phase 1: Canary (10% traffic, 2 hours)
```bash
# Set traffic split
kubectl annotate service client-service "traffic.sidecar.istio.io/canary=10"

# Monitor key metrics
kubectl logs -f deployment/client-deployment | grep -E "(ERROR|WARN)"

# Check export queue
kubectl exec -it deploy/redis -- redis-cli llen export_queue
```

**Go/No-Go Criteria:**
- Error rate < 2%
- Export success rate > 98%
- Search response time < 200ms p95

### Phase 2: Expanded (50% traffic, 2 hours)
```bash
# Increase traffic split
kubectl annotate service client-service "traffic.sidecar.istio.io/canary=50"

# Monitor subscription health
kubectl exec -it deploy/graphql-server -- netstat -an | grep :4000 | wc -l
```

**Go/No-Go Criteria:**
- Subscription connection rate stable
- Memory usage < 200MB per session
- No critical alerts triggered

### Phase 3: Full Rollout (100% traffic)
```bash
# Complete rollout
kubectl annotate service client-service "traffic.sidecar.istio.io/canary=100"

# Remove canary annotations
kubectl annotate service client-service traffic.sidecar.istio.io/canary-
```

## Monitoring Commands

### Real-time Health Check
```bash
# API health
curl -f https://api.intelgraph.com/healthz

# GraphQL introspection
curl -X POST https://api.intelgraph.com/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __typename }"}'

# Export queue status
kubectl exec -it deploy/redis -- redis-cli info stats | grep "expired_keys"
```

### Performance Metrics
```bash
# Search latency
kubectl exec -it deploy/prometheus -- \
  promtool query instant 'histogram_quantile(0.95, search_duration_seconds)'

# Graph rendering performance
kubectl logs deployment/client-deployment | grep "graph_fps" | tail -10

# Export job success rate
kubectl exec -it deploy/prometheus -- \
  promtool query instant 'rate(export_jobs_completed_total[5m]) / rate(export_jobs_started_total[5m])'
```

### Error Analysis
```bash
# Client-side errors
kubectl logs deployment/client-deployment | grep -E "ERROR|Exception" | tail -20

# Server-side errors  
kubectl logs deployment/graphql-server | grep -E "ERROR|WARN" | tail -20

# Database slow queries
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph \
  -c "SELECT query, mean_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
```

## Rollback Procedures

### Emergency Rollback (< 5 minutes)
```bash
# Immediate traffic revert
kubectl annotate service client-service "traffic.sidecar.istio.io/canary=0"

# Rollback deployment
kubectl rollout undo deployment/client-deployment
kubectl rollout undo deployment/graphql-server

# Verify rollback
kubectl rollout status deployment/client-deployment
kubectl rollout status deployment/graphql-server
```

### Database Rollback
```bash
# Revert schema changes (if necessary)
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph -f /rollbacks/v2.7/revert_schema.sql

# Rebuild indexes
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph -c "REINDEX DATABASE intelgraph;"
```

## Alert Conditions

### Critical (Immediate Page)
- API error rate > 5% for 5 minutes
- Export failure rate > 10% for 10 minutes  
- Search response time p95 > 3 seconds for 5 minutes
- Subscription disconnect rate > 20% for 5 minutes

### Warning (Slack Alert)
- Memory usage > 180MB per session
- Graph rendering FPS < 50 on synthetic tests
- Database connection pool > 80% utilization
- CDN cache hit rate < 85%

## Post-deployment Tasks

### Immediate (0-4 hours)
- [ ] Validate all smoke test scenarios
- [ ] Review error logs for new error patterns
- [ ] Confirm monitoring dashboards show expected metrics
- [ ] Test export functionality end-to-end
- [ ] Verify notification delivery works

### Short-term (4-24 hours)
- [ ] Analyze user adoption of new features
- [ ] Review performance baselines
- [ ] Optimize export worker concurrency
- [ ] Fine-tune notification categories
- [ ] Update documentation with lessons learned

### Medium-term (1-7 days)
- [ ] A/B test notification audio settings
- [ ] Optimize bundle splitting based on usage patterns
- [ ] Review search query accuracy
- [ ] Plan next iteration improvements
- [ ] Conduct post-mortem if issues occurred

## Troubleshooting Guide

### Search Performance Issues
```bash
# Check database indexes
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph \
  -c "SELECT schemaname, tablename, indexname, idx_tup_read, idx_tup_fetch FROM pg_stat_user_indexes WHERE idx_tup_read > 0 ORDER BY idx_tup_read DESC;"

# Analyze slow queries
kubectl exec -it deploy/postgres -- psql -U postgres -d intelgraph \
  -c "SELECT query, calls, total_time, mean_time FROM pg_stat_statements WHERE query LIKE '%search%' ORDER BY mean_time DESC LIMIT 5;"
```

### Export Job Failures
```bash
# Check worker logs
kubectl logs deployment/export-workers | grep -E "(ERROR|FAILED)" | tail -20

# Queue depth analysis
kubectl exec -it deploy/redis -- redis-cli llen export_queue
kubectl exec -it deploy/redis -- redis-cli llen export_processing

# Storage space check
kubectl exec -it deploy/minio -- df -h /data
```

### Notification Delivery Issues
```bash
# WebSocket connection count
kubectl exec -it deploy/graphql-server -- netstat -an | grep :4000 | grep ESTABLISHED | wc -l

# Subscription event logs
kubectl logs deployment/graphql-server | grep "subscription" | tail -20

# Redis pub/sub stats
kubectl exec -it deploy/redis -- redis-cli info replication
```

## Emergency Contacts

- **SRE On-call:** +1-XXX-XXX-XXXX
- **Engineering Lead:** +1-XXX-XXX-XXXX  
- **Product Manager:** +1-XXX-XXX-XXXX
- **Security Team:** security@intelgraph.com

## Version Information

- **Release:** v2.7
- **Deployment Date:** 2025-08-28
- **Git Commit:** `git rev-parse HEAD`
- **Docker Images:**
  - `intelgraph/client:v2.7`
  - `intelgraph/server:v2.7`
  - `intelgraph/workers:v2.7`