name: ci-reusable-build
on:
  workflow_call:
    inputs:
      language: { required: true, type: string }
      cache-key: { required: false, type: string, default: default }
    secrets:
      REGISTRY_USER: { required: true }
      REGISTRY_TOKEN: { required: true }
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Setup toolchain
        uses: actions/setup-node@v4
        if: ${{ inputs.language == 'node' }}
        with: { node-version: '22.x', cache: 'npm' }
      - name: Compute cache key
        id: cache
        run: echo "key=${{ inputs.cache-key }}-${{ hashFiles('**/package-lock.json','**/pnpm-lock.yaml','**/yarn.lock','**/poetry.lock','**/Cargo.lock') }}" >> $GITHUB_OUTPUT
      - uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/pip
            ~/.cache/yarn
          key: ${{ steps.cache.outputs.key }}
      - name: Build
        run: |
          # TODO: replace with your build command
          npm ci && npm run build
      - name: Docker build (provenance)
        uses: docker/build-push-action@v6
        with:
          push: false
          load: true
          tags: local/app:pr-${{ github.run_number }}
          provenance: true
