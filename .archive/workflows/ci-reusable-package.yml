name: wf-reuse-package
on:
  workflow_call:
    secrets:
      COSIGN_PRIVATE_KEY: { required: true }
      COSIGN_PASSWORD: { required: true }
jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Docker build (root Dockerfile)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          provenance: true
      - name: SBOM
        run: ./.ci/scripts/sbom_cyclonedx.sh
      - name: Sign image
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_PRIVATE_KEY" > cosign.key
          cosign sign --key cosign.key ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
