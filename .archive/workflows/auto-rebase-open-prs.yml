name: Auto Rebase Open PRs

on:
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-rebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto rebase PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr list --state open --json number,headRefName --jq '.[] | select(.headRefName != "main")' | while read -r pr_info; do
            PR_NUMBER=$(echo "$pr_info" | jq -r '.number')
            HEAD_REF=$(echo "$pr_info" | jq -r '.headRefName')
            
            echo "Attempting to rebase PR #$PR_NUMBER ($HEAD_REF)"
            
            # Fetch main and rebase
            git fetch origin main:main
            git checkout $HEAD_REF
            if git rebase main; then
              echo "Successfully rebased PR #$PR_NUMBER"
              git push --force-with-lease origin $HEAD_REF
            else
              echo "Failed to rebase PR #$PR_NUMBER. Manual intervention required."
              git rebase --abort || true
            fi
            git checkout -
          done
