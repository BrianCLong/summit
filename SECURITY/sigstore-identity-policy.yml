# Sigstore Identity Policy
#
# Defines allowed signing identities for governance and release artifacts.
# This policy is used by signature verification scripts to enforce identity pinning.
#
# Authority: docs/ci/GOVERNANCE_SIGNING.md
# Version: 1.0.0

version: "1.0.0"

# Governance signing identity constraints
governance_signing:
  description: "Identities allowed to sign governance lockfiles"

  # GitHub Actions OIDC issuer
  oidc_issuer: "https://token.actions.githubusercontent.com"

  # Allowed identity patterns (regex)
  # These match the workflow URL that created the signature
  identity_regexp: "https://github.com/.*/summit/.github/workflows/(ga-release|rc-release|build-ga-bundle|build-promotion-bundle).*"

  # Allowed workflows (explicit list)
  allowed_workflows:
    - ".github/workflows/ga-release.yml"
    - ".github/workflows/rc-release.yml"
    - ".github/workflows/build-ga-bundle.yml"
    - ".github/workflows/build-promotion-bundle.yml"
    - ".github/workflows/governance-lockfile-sign.yml"

  # Allowed subject patterns for tags
  # These match against the @refs/tags pattern in the certificate
  allowed_subject_patterns:
    - "refs/tags/v[0-9]+\\.[0-9]+\\.[0-9]+"           # GA tags (v1.2.3)
    - "refs/tags/v[0-9]+\\.[0-9]+\\.[0-9]+-rc\\.[0-9]+"  # RC tags (v1.2.3-rc.1)
    - "refs/heads/main"                                 # Main branch (for testing)

# Release artifact signing identity constraints
release_signing:
  description: "Identities allowed to sign release artifacts"

  oidc_issuer: "https://token.actions.githubusercontent.com"

  identity_regexp: "https://github.com/.*/summit/.github/workflows/(ga-release|rc-release).*"

  allowed_workflows:
    - ".github/workflows/ga-release.yml"
    - ".github/workflows/rc-release.yml"

# Container image signing (for reference)
container_signing:
  description: "Identities allowed to sign container images"

  oidc_issuer: "https://token.actions.githubusercontent.com"

  identity_regexp: "https://github.com/.*/summit/.github/workflows/(build-and-push|release-container).*"

  allowed_workflows:
    - ".github/workflows/build-and-push.yml"
    - ".github/workflows/release-container.yml"

# Policy metadata
policy_metadata:
  created_at: "2026-01-08"
  updated_at: "2026-01-08"
  owner: "Platform Engineering"
  review_cadence: "quarterly"
  next_review: "2026-04-08"

# Verification instructions
verification:
  governance:
    command: |
      cosign verify-blob \
        --signature governance/signatures/governance_SHA256SUMS.sig \
        --certificate governance/signatures/governance_SHA256SUMS.cert \
        --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
        --certificate-identity-regexp "https://github.com/.*/summit/.github/workflows/(ga-release|rc-release).*" \
        governance/governance_SHA256SUMS

  release_artifact:
    command: |
      cosign verify-blob \
        --signature <artifact>.sig \
        --certificate <artifact>.cert \
        --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
        --certificate-identity-regexp "https://github.com/.*/summit/.github/workflows/(ga-release|rc-release).*" \
        <artifact>
