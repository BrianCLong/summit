.PHONY: db/up db/wait db/migrate
db/up: ## Start the PostgreSQL database using docker-compose.db.yml
	docker compose -f docker-compose.db.yml up -d

db/wait: ## Wait for the PostgreSQL database to be ready
	@echo "Waiting for postgres on 127.0.0.1:5432 ..."
	until PGPASSWORD=devpassword psql -h 127.0.0.1 -U intelgraph -d intelgraph_dev -c 'select 1' >/dev/null 2>&1; do \
		sleep 1; \
	done
	@echo "postgres is ready"

db/migrate: db/up db/wait ## Run database migrations
	export DATABASE_URL=postgres://intelgraph:devpassword@127.0.0.1:5432/intelgraph_dev PGSSLMODE=disable; cd server && npm run db:migrate
