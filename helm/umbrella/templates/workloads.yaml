{{- $defaults := .Values.defaults -}}
{{- $blueGreen := .Values.blueGreen -}}
{{- range $name, $cfg := .Values.workloads }}
{{- if $cfg.enabled }}
{{- $colors := list $blueGreen.activeColor $blueGreen.standbyColor -}}
{{- if not $blueGreen.enabled }}
{{- $colors = list "" -}}
{{- end }}
{{- range $color := $colors }}
{{- $colorLabel := ternary (ternary $color $blueGreen.activeColor (ne $color "")) "primary" $blueGreen.enabled -}}
{{- $workloadName := include "umbrella.workloadName" (list (printf "%s-%s" $name (default "primary" $colorLabel)) $) -}}
{{- $serviceName := ternary (printf "%s-%s" $name $colorLabel) $name $blueGreen.enabled -}}
{{- $resources := include "umbrella.merge" (list $defaults.resources (default dict $cfg.resources)) | fromYaml -}}
{{- $networkPolicy := default (dict) $cfg.networkPolicy -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $workloadName }}
  namespace: {{ $.Values.namespace }}
  labels:
    app.kubernetes.io/name: {{ $name }}
    app.kubernetes.io/instance: {{ include "umbrella.fullname" $ }}
    app.kubernetes.io/component: workload
    app.kubernetes.io/version: {{ $.Chart.AppVersion }}
    app.kubernetes.io/managed-by: Helm
    deployment-color: {{ ternary $color $blueGreen.activeColor (ne $color "") }}
  {{- with (include "umbrella.merge" (list $defaults.mesh.annotations (default dict $cfg.mesh.annotations))) | fromYaml }}
  annotations:
{{ toYaml . | indent 4 }}
  {{- end }}
spec:
  replicas: {{ default 1 $cfg.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ $name }}
      deployment-color: {{ ternary $color $blueGreen.activeColor (ne $color "") }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $name }}
        app.kubernetes.io/instance: {{ include "umbrella.fullname" $ }}
        deployment-color: {{ ternary $color $blueGreen.activeColor (ne $color "") }}
      {{- with (include "umbrella.merge" (list $defaults.mesh.annotations (default dict $cfg.mesh.annotations))) | fromYaml }}
      annotations:
{{ toYaml . | indent 8 }}
      {{- end }}
    spec:
      containers:
        - name: {{ $name }}
          image: {{ $cfg.image.repository }}:{{ $cfg.image.tag | default "latest" }}
          imagePullPolicy: {{ default $defaults.imagePullPolicy $cfg.imagePullPolicy }}
          ports:
            - name: http
              containerPort: {{ default $defaults.service.targetPort $cfg.service.targetPort | int }}
          env:
          {{- range $cfg.env }}
            - name: {{ .name }}
              value: {{ .value | quote }}
          {{- end }}
          {{- if $cfg.envFromSecret }}
          envFrom:
            - secretRef:
                name: {{ $cfg.envFromSecret }}
          {{- end }}
          {{- $lprobe := (include "umbrella.merge" (list $defaults.probes.liveness (default dict $cfg.probes.liveness))) | fromYaml }}
          livenessProbe:
            httpGet:
              path: {{ $lprobe.path }}
              port: {{ $lprobe.port }}
            initialDelaySeconds: {{ $lprobe.initialDelaySeconds | default 10 }}
            periodSeconds: {{ $lprobe.periodSeconds | default 10 }}
            timeoutSeconds: {{ $lprobe.timeoutSeconds | default 3 }}
            failureThreshold: {{ $lprobe.failureThreshold | default 5 }}
          {{- $rprobe := (include "umbrella.merge" (list $defaults.probes.readiness (default dict $cfg.probes.readiness))) | fromYaml }}
          readinessProbe:
            httpGet:
              path: {{ $rprobe.path }}
              port: {{ $rprobe.port }}
            initialDelaySeconds: {{ $rprobe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ $rprobe.periodSeconds | default 5 }}
            timeoutSeconds: {{ $rprobe.timeoutSeconds | default 3 }}
            failureThreshold: {{ $rprobe.failureThreshold | default 3 }}
          {{- if or $defaults.probes.startup.enabled (and $cfg.probes (hasKey $cfg.probes "startup")) }}
          {{- $sprobe := (include "umbrella.merge" (list $defaults.probes.startup (default dict $cfg.probes.startup))) | fromYaml }}
          startupProbe:
            httpGet:
              path: {{ $sprobe.path }}
              port: {{ $sprobe.port }}
            failureThreshold: {{ $sprobe.failureThreshold | default 30 }}
            periodSeconds: {{ $sprobe.periodSeconds | default 5 }}
          {{- end }}
          resources:
{{ toYaml $resources | indent 12 }}
      {{- with $cfg.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
      {{- end }}
      {{- with $cfg.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
      {{- end }}
      {{- with $cfg.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $serviceName }}
  namespace: {{ $.Values.namespace }}
  labels:
    app.kubernetes.io/name: {{ $name }}
    deployment-color: {{ ternary $color $blueGreen.activeColor (ne $color "") }}
  {{- with (default dict $cfg.service.annotations) }}
  annotations:
{{ toYaml . | indent 4 }}
  {{- end }}
spec:
  type: {{ default $defaults.service.type $cfg.service.type }}
  selector:
    app.kubernetes.io/name: {{ $name }}
    deployment-color: {{ ternary $color $blueGreen.activeColor (ne $color "") }}
  ports:
    - name: http
      port: {{ default $defaults.service.port $cfg.service.port }}
      targetPort: {{ default $defaults.service.targetPort $cfg.service.targetPort }}
---
{{- if and $.Values.defaults.ingress.enabled (or (and $cfg.ingress $cfg.ingress.enabled)) }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ printf "%s-ingress" $serviceName }}
  namespace: {{ $.Values.namespace }}
  annotations:
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: {{ default $.Values.defaults.ingress.clusterIssuer $cfg.ingress.clusterIssuer }}
    {{- with $cfg.ingress.annotations }}
{{ toYaml . | indent 4 }}
    {{- end }}
spec:
  ingressClassName: {{ default $.Values.defaults.ingress.className $cfg.ingress.className }}
  tls:
    - hosts:
        - {{ $cfg.ingress.host }}
      secretName: {{ default (tpl $.Values.defaults.ingress.tlsSecretTemplate (dict "name" $name)) $cfg.ingress.tlsSecret }}
  rules:
    - host: {{ $cfg.ingress.host }}
      http:
        paths:
          - path: {{ default "/" $cfg.ingress.path }}
            pathType: Prefix
            backend:
              service:
                name: {{ $serviceName }}
                port:
                  number: {{ default $defaults.service.port $cfg.service.port }}
---
{{- end }}
{{- if and $cfg.hpa (or $defaults.hpa.enabled $cfg.hpa.enabled) }}
{{- $hpaMetrics := default $defaults.hpa.metrics $cfg.hpa.metrics -}}
{{- $extraMetrics := default $defaults.hpa.extraMetrics $cfg.hpa.extraMetrics -}}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ printf "%s-hpa" $serviceName }}
  namespace: {{ $.Values.namespace }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ $workloadName }}
  minReplicas: {{ default $defaults.hpa.minReplicas $cfg.hpa.minReplicas }}
  maxReplicas: {{ default $defaults.hpa.maxReplicas $cfg.hpa.maxReplicas }}
  metrics:
{{ toYaml (concat $hpaMetrics $extraMetrics) | indent 4 }}
---
{{- end }}
{{- if and $.Values.defaults.mesh.enabled (not (eq (default true $cfg.mesh.enabled) false)) }}
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: {{ printf "%s-peerauth" $serviceName }}
  namespace: {{ $.Values.namespace }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ $name }}
  mtls:
    mode: {{ default $.Values.defaults.mesh.peerAuthentication.mtlsMode $cfg.mesh.peerAuthentication.mtlsMode }}
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ printf "%s-destrule" $serviceName }}
  namespace: {{ $.Values.namespace }}
spec:
  host: {{ $serviceName }}
  trafficPolicy:
{{ toYaml (default $.Values.defaults.mesh.destinationRule.trafficPolicy $cfg.mesh.destinationRule.trafficPolicy) | indent 4 }}
---
{{- end }}
{{- if and $.Values.defaults.networkPolicy.enabled (or (and $cfg.networkPolicy $cfg.networkPolicy.enabled)) }}
{{- $allowIstio := default $.Values.defaults.networkPolicy.allowIstioIngress $networkPolicy.allowIstioIngress -}}
{{- $ingressFrom := default $.Values.defaults.networkPolicy.ingressFrom $networkPolicy.ingressFrom -}}
{{- if $allowIstio }}
{{- $ingressFrom = concat $ingressFrom (list (dict "podSelector" (dict "matchLabels" (dict "istio" "ingressgateway")))) -}}
{{- end }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ printf "%s-netpol" $serviceName }}
  namespace: {{ $.Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ $name }}
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
{{ toYaml $ingressFrom | indent 8 }}
      ports:
        - port: {{ default $defaults.service.port $cfg.service.port }}
  egress:
{{ toYaml (default $.Values.defaults.networkPolicy.egress $networkPolicy.egress) | indent 4 }}
---
{{- end }}
{{- if and $.Values.defaults.externalSecret.enabled $cfg.externalSecrets }}
{{- range $secret := $cfg.externalSecrets }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $secret.name }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: {{ default $.Values.defaults.externalSecret.refreshInterval $secret.refreshInterval }}
  secretStoreRef:
{{ toYaml (default $.Values.defaults.externalSecret.secretStoreRef $secret.secretStoreRef) | indent 4 }}
  target:
    name: {{ default $secret.name $secret.targetName }}
    creationPolicy: Owner
  data:
{{ toYaml $secret.data | indent 4 }}
---
{{- end }}
{{- end }}
{{- end }}
{{- if $blueGreen.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: {{ $name }}
  namespace: {{ $.Values.namespace }}
  labels:
    app.kubernetes.io/name: {{ $name }}
    role: stable
spec:
  type: {{ default $defaults.service.type $cfg.service.type }}
  selector:
    app.kubernetes.io/name: {{ $name }}
    deployment-color: {{ $blueGreen.activeColor }}
  ports:
    - name: http
      port: {{ default $defaults.service.port $cfg.service.port }}
      targetPort: {{ default $defaults.service.targetPort $cfg.service.targetPort }}
---
{{- end }}
{{- end }}
