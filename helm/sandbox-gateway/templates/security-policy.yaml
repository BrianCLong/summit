{{- if and .Values.gatewayApi.enabled .Values.gatewayApi.policies.cors.enabled }}
---
# SecurityPolicy for CORS
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: {{ include "sandbox-gateway.fullname" . }}-cors
  labels:
    {{- include "sandbox-gateway.labels" . | nindent 4 }}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ include "sandbox-gateway.fullname" . }}
  cors:
    allowOrigins:
      {{- range .Values.gatewayApi.policies.cors.allowOrigins }}
      - type: {{ .type | default "Exact" }}
        value: {{ .value | quote }}
      {{- end }}
    allowMethods:
      {{- toYaml .Values.gatewayApi.policies.cors.allowMethods | nindent 6 }}
    allowHeaders:
      {{- toYaml .Values.gatewayApi.policies.cors.allowHeaders | nindent 6 }}
    {{- if .Values.gatewayApi.policies.cors.exposeHeaders }}
    exposeHeaders:
      {{- toYaml .Values.gatewayApi.policies.cors.exposeHeaders | nindent 6 }}
    {{- end }}
    maxAge: {{ .Values.gatewayApi.policies.cors.maxAge | default "86400s" }}
    allowCredentials: {{ .Values.gatewayApi.policies.cors.allowCredentials | default true }}
{{- end }}

{{- if and .Values.gatewayApi.enabled .Values.gatewayApi.policies.ipAllowlist.enabled }}
---
# SecurityPolicy for IP allowlist
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: {{ include "sandbox-gateway.fullname" . }}-ip-allowlist
  labels:
    {{- include "sandbox-gateway.labels" . | nindent 4 }}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ include "sandbox-gateway.fullname" . }}
  authorization:
    defaultAction: Deny
    rules:
      - name: allow-configured-cidrs
        action: Allow
        principal:
          clientCIDRs:
            {{- range .Values.gatewayApi.policies.ipAllowlist.cidrs }}
            - cidr: {{ . | quote }}
            {{- end }}
{{- end }}

{{- if and .Values.gatewayApi.enabled .Values.gatewayApi.policies.jwt.enabled }}
---
# SecurityPolicy for JWT authentication
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: {{ include "sandbox-gateway.fullname" . }}-jwt
  labels:
    {{- include "sandbox-gateway.labels" . | nindent 4 }}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ include "sandbox-gateway.fullname" . }}
  jwt:
    providers:
      - name: {{ .Values.gatewayApi.policies.jwt.providerName | default "summit-auth" }}
        issuer: {{ .Values.gatewayApi.policies.jwt.issuer | quote }}
        audiences:
          {{- toYaml .Values.gatewayApi.policies.jwt.audiences | nindent 10 }}
        remoteJWKS:
          uri: {{ .Values.gatewayApi.policies.jwt.jwksUri | quote }}
          cacheDuration: {{ .Values.gatewayApi.policies.jwt.cacheDuration | default "300s" }}
        {{- if .Values.gatewayApi.policies.jwt.claimToHeaders }}
        claimToHeaders:
          {{- range .Values.gatewayApi.policies.jwt.claimToHeaders }}
          - claim: {{ .claim }}
            header: {{ .header }}
          {{- end }}
        {{- end }}
    optional: {{ .Values.gatewayApi.policies.jwt.optional | default false }}
{{- end }}
