apiVersion: v1
kind: ConfigMap
metadata:
  name: conductor-slo-burn-dashboard
  labels:
    grafana_dashboard: "1"
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
data:
  conductor-slo-burn.json: |
    {
      "uid": "conductor-slo-burn",
      "title": "Conductor — SLO Burn & QoS",
      "schemaVersion": 38,
      "version": 1,
      "tags": ["conductor", "slo", "qos"],
      "timezone": "browser",
      "templating": {
        "list": [
          {
            "name": "expert",
            "type": "query",
            "label": "Expert",
            "datasource": "Prometheus",
            "refresh": 1,
            "query": "label_values(slo:burn_rate5m:ratio, expert)",
            "includeAll": true,
            "multi": true
          },
          {
            "name": "tier",
            "type": "query",
            "label": "Tenant Tier",
            "datasource": "Prometheus",
            "refresh": 1,
            "query": "label_values(slo:burn_rate5m:ratio, tenant_tier)",
            "includeAll": true,
            "multi": true
          }
        ]
      },
      "panels": [
        {
          "type": "timeseries",
          "title": "Error Budget Burn — Fast vs Slow",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
          "targets": [
            {"expr": "slo:burn_rate5m:ratio{expert=~\"$expert\",tenant_tier=~\"$tier\"}", "legendFormat": "{{expert}}/{{tenant_tier}} — 5m"},
            {"expr": "slo:burn_rate1h:ratio{expert=~\"$expert\",tenant_tier=~\"$tier\"}",  "legendFormat": "{{expert}}/{{tenant_tier}} — 1h"}
          ]
        },
        {
          "type": "timeseries",
          "title": "Target Error Ratio vs Actual",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8},
          "targets": [
            {"expr": "slo:target_error_ratio{expert=~\"$expert\",tenant_tier=~\"$tier\"}", "legendFormat": "target {{expert}}/{{tenant_tier}}"},
            {"expr": "slo:error_ratio:observed{expert=~\"$expert\",tenant_tier=~\"$tier\"}", "legendFormat": "observed {{expert}}/{{tenant_tier}}"}
          ]
        },
        {
          "type": "table",
          "title": "Top offenders (Burn Rate 1h)",
          "gridPos": {"h": 7, "w": 24, "x": 0, "y": 16},
          "targets": [
            {"expr": "topk(10, slo:burn_rate1h:ratio)", "legendFormat": "{{expert}}/{{tenant_tier}}"}
          ]
        }
      ]
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: conductor-routing-quality-dashboard
  labels:
    grafana_dashboard: "1"
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
data:
  conductor-routing-quality.json: |
    {
      "uid": "conductor-routing-quality",
      "title": "Conductor — Routing Quality",
      "schemaVersion": 38,
      "version": 1,
      "tags": ["conductor", "routing"],
      "templating": {"list": []},
      "panels": [
        {
          "type": "timeseries",
          "title": "+Win‑Rate vs Baseline (Golden Sets)",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
          "targets": [
            {"expr": "conductor_routing_winrate_delta_pp", "legendFormat": "Δpp"}
          ]
        },
        {
          "type": "stat",
          "title": "Exploration % (current)",
          "gridPos": {"h": 6, "w": 8, "x": 0, "y": 8},
          "targets": [{"expr": "avg(conductor_router_exploration_ratio)"}]
        },
        {
          "type": "stat",
          "title": "Reward Latency p95 (ms)",
          "gridPos": {"h": 6, "w": 8, "x": 8, "y": 8},
          "targets": [{"expr": "histogram_quantile(0.95, sum(rate(conductor_reward_latency_ms_bucket[5m])) by (le))"}]
        },
        {
          "type": "stat",
          "title": "Golden Gate False‑Negative %",
          "gridPos": {"h": 6, "w": 8, "x": 16, "y": 8},
          "targets": [{"expr": "conductor_eval_gate_false_negative_ratio"}]
        }
      ]
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: conductor-alertmanager-routes
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
data:
  alertmanager-routes.yaml: |
    route:
      receiver: default
      group_by: [alertname, expert, tenant_tier]
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        - matchers:
            - alertname =~ "SLOBurn_.*"
          receiver: pagerduty
          continue: true
        - matchers:
            - severity = "page"
          receiver: pagerduty
        - matchers:
            - severity = "warn"
          receiver: slack
    receivers:
      - name: default
        slack_configs:
          - channel: "#conductor-ops"
            send_resolved: true
            title: "[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}"
            text: "{{ range .Alerts }}• {{ .Annotations.summary }} ({{ .Labels.expert }}/{{ .Labels.tenant_tier }})\n{{ end }}"
      - name: pagerduty
        pagerduty_configs:
          - routing_key: "<PD_ROUTING_KEY>"
            severity: "error"
      - name: slack
        slack_configs:
          - channel: "#conductor-warnings"
            send_resolved: true
