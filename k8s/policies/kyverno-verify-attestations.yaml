apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-slsa-provenance
  annotations:
    policies.kyverno.io/title: Verify SLSA provenance for summit-company images
    policies.kyverno.io/category: Supply Chain Security
    policies.kyverno.io/severity: high
spec:
  validationFailureAction: Enforce # use Audit to monitor before enforcing
  background: true
  webhookTimeoutSeconds: 15
  rules:
    - name: verify-slsa-provenance-keyless-github
      match:
        any:
          - resources:
              kinds: ['Pod']
              namespaces: ['companyos']
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - cert-manager
                - ingress-nginx
                - external-dns
                - argocd
      verifyImages:
        - image: '*dkr.ecr.*.amazonaws.com/summit-company/*'
          # Require keyless signatures issued by GitHub OIDC
          keyless:
            issuer: 'https://token.actions.githubusercontent.com'
            subject: 'https://github.com/*/*'
          # Require a SLSA provenance attestation (cosign attest)
          attestations:
            - type: slsaprovenance
              conditions:
                all:
                  # Predicate must be SLSA v1
                  - key: '{{ payload.predicate.buildType }}'
                    operator: Equals
                    value: 'https://slsa.dev/provenance/v1'

                  # Built by GitHub Actions runner (cosign's default predicate)
                  - key: '{{ payload.predicate.builder.id }}'
                    operator: Equals
                    value: 'https://github.com/actions/runner'

                  # (Optional but recommended) Gate on your workflow name / path
                  # Adjust to match your repo (e.g., build-and-push.yml or release-prod.yml)
                  - key: '{{ payload.predicate.invocation.parameters.workflow }}'
                    operator: In
                    value:
                      [
                        'build-and-push.yml',
                        'release-prod.yml',
                        'attest-provenance.yml',
                      ]

                  # Sanity: ensure the subject refers to your images
                  - key: '{{ payload.subject[0].name }}'
                    operator: Contains
                    value: 'summit-company'
