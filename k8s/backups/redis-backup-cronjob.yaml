apiVersion: batch/v1
kind: CronJob
metadata:
  name: redis-backup
  namespace: default
spec:
  schedule: "0 */6 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: redis-backup
              image: redis:7
              command: ["/bin/sh","-lc"]
              args:
                - apt-get update && apt-get install -y awscli curl bash && 
                  curl -fsSL https://raw.githubusercontent.com/BrianCLong/intelgraph/main/scripts/backups/redis_backup.sh -o /redis_backup.sh || true && 
                  bash /redis_backup.sh
              env:
                - name: REDIS_HOST
                  value: redis
                - name: REDIS_PORT
                  value: "6379"
                - name: BACKUP_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: backup-dest
                      key: bucket
              volumeMounts:
                - name: redis-data
                  mountPath: /data
          volumes:
            - name: redis-data
              persistentVolumeClaim:
                claimName: redis-data

