# =============================================================================
# ENHANCED HEALTH CHECKS - LIVENESS, READINESS, AND STARTUP PROBES
# =============================================================================
# Comprehensive health check configurations for all services
# Implements best practices for probe configuration
# =============================================================================

---
# =============================================================================
# DEPLOYMENT: API Server with Enhanced Probes
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
  namespace: intelgraph-production
  labels:
    app: api-server
    component: backend
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-server
  template:
    metadata:
      labels:
        app: api-server
        component: backend
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "4000"
        prometheus.io/path: "/metrics"
    spec:
      # Security context for pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault

      # Termination grace period
      terminationGracePeriodSeconds: 60

      containers:
      - name: api-server
        image: ghcr.io/brianclong/summit/api-server:latest
        imagePullPolicy: IfNotPresent

        ports:
        - name: http
          containerPort: 4000
          protocol: TCP
        - name: metrics
          containerPort: 9090
          protocol: TCP

        # Container security context
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1001
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true

        # Resource limits and requests
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
            ephemeral-storage: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
            ephemeral-storage: 5Gi

        # Volume mounts for writable directories
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
        - name: logs
          mountPath: /app/logs

        # Environment variables
        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "4000"
        - name: LOG_LEVEL
          value: "info"

        # =================================================================
        # STARTUP PROBE
        # =================================================================
        # Protects slow-starting containers from being killed by liveness probe
        # Gives the application time to initialize
        startupProbe:
          httpGet:
            path: /health/startup
            port: http
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 30  # 30 * 10s = 5 minutes to start

        # =================================================================
        # LIVENESS PROBE
        # =================================================================
        # Restarts the container if this probe fails
        # Checks if application is alive and can recover
        livenessProbe:
          httpGet:
            path: /health/live
            port: http
            scheme: HTTP
            httpHeaders:
            - name: X-Probe-Type
              value: Liveness
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 10
          successThreshold: 1
          failureThreshold: 3  # Restart after 3 failures

        # =================================================================
        # READINESS PROBE
        # =================================================================
        # Removes pod from service endpoints if probe fails
        # Checks if application can handle traffic
        readinessProbe:
          httpGet:
            path: /health/ready
            port: http
            scheme: HTTP
            httpHeaders:
            - name: X-Probe-Type
              value: Readiness
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3  # Remove from service after 3 failures

        # Lifecycle hooks
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]

      volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir:
          sizeLimit: 1Gi
      - name: logs
        emptyDir:
          sizeLimit: 2Gi

---
# =============================================================================
# DEPLOYMENT: Web Frontend with Enhanced Probes
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-frontend
  namespace: intelgraph-production
  labels:
    app: web-frontend
    component: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web-frontend
  template:
    metadata:
      labels:
        app: web-frontend
        component: frontend
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        fsGroup: 101
        seccompProfile:
          type: RuntimeDefault

      terminationGracePeriodSeconds: 30

      containers:
      - name: nginx
        image: ghcr.io/brianclong/summit/web-frontend:latest
        imagePullPolicy: IfNotPresent

        ports:
        - name: http
          containerPort: 80
          protocol: TCP

        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 101
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

        volumeMounts:
        - name: cache
          mountPath: /var/cache/nginx
        - name: run
          mountPath: /var/run

        # Startup probe for nginx
        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 10

        # Liveness probe
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3

        # Readiness probe
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 2

        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 10 && nginx -s quit"]

      volumes:
      - name: cache
        emptyDir: {}
      - name: run
        emptyDir: {}

---
# =============================================================================
# STATEFULSET: Database with TCP Probes
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: intelgraph-production
  labels:
    app: postgres
    component: database
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
        component: database
    spec:
      securityContext:
        fsGroup: 999
        runAsNonRoot: true
        runAsUser: 999

      terminationGracePeriodSeconds: 60

      containers:
      - name: postgres
        image: postgres:16-alpine
        imagePullPolicy: IfNotPresent

        ports:
        - name: postgres
          containerPort: 5432
          protocol: TCP

        env:
        - name: POSTGRES_DB
          value: "intelgraph"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata

        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 4000m
            memory: 8Gi

        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data

        # Startup probe using pg_isready
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 30

        # Liveness probe
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 10
          successThreshold: 1
          failureThreshold: 5

        # Readiness probe with actual query
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - psql -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT 1"
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3

  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "ssd"
      resources:
        requests:
          storage: 100Gi

---
# =============================================================================
# DEPLOYMENT: Worker with gRPC Probes
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  namespace: intelgraph-production
  labels:
    app: worker
    component: worker
spec:
  replicas: 2
  selector:
    matchLabels:
      app: worker
  template:
    metadata:
      labels:
        app: worker
        component: worker
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001

      terminationGracePeriodSeconds: 90

      containers:
      - name: worker
        image: ghcr.io/brianclong/summit/worker:latest
        imagePullPolicy: IfNotPresent

        ports:
        - name: grpc
          containerPort: 9000
          protocol: TCP

        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 4Gi

        # Startup probe for gRPC
        startupProbe:
          grpc:
            port: 9000
            service: health  # gRPC health check service
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 30

        # Liveness probe
        livenessProbe:
          grpc:
            port: 9000
            service: health
          initialDelaySeconds: 30
          periodSeconds: 20
          timeoutSeconds: 10
          successThreshold: 1
          failureThreshold: 3

        # Readiness probe
        readinessProbe:
          grpc:
            port: 9000
            service: health
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3

        # Graceful shutdown
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "kill -SIGTERM 1 && sleep 60"]

---
# =============================================================================
# CONFIGMAP: Health Check Endpoint Examples
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: health-check-examples
  namespace: intelgraph-production
data:
  # Example Node.js/Express health check implementation
  healthcheck.js: |
    const express = require('express');
    const router = express.Router();

    // Startup probe - minimal check
    router.get('/health/startup', (req, res) => {
      // Check if app has finished initialization
      if (global.appReady) {
        res.status(200).json({ status: 'started' });
      } else {
        res.status(503).json({ status: 'starting' });
      }
    });

    // Liveness probe - is the app alive?
    router.get('/health/live', (req, res) => {
      // Check if app is deadlocked or in unrecoverable state
      res.status(200).json({
        status: 'alive',
        timestamp: new Date().toISOString()
      });
    });

    // Readiness probe - can the app handle traffic?
    router.get('/health/ready', async (req, res) => {
      try {
        // Check critical dependencies
        await checkDatabase();
        await checkRedis();
        await checkExternalAPIs();

        res.status(200).json({
          status: 'ready',
          checks: {
            database: 'healthy',
            redis: 'healthy',
            externalAPIs: 'healthy'
          }
        });
      } catch (error) {
        res.status(503).json({
          status: 'not ready',
          error: error.message
        });
      }
    });

    module.exports = router;

  # Example Python/Flask health check
  healthcheck.py: |
    from flask import Flask, jsonify
    import time

    app = Flask(__name__)
    start_time = time.time()

    @app.route('/health/startup')
    def startup():
        """Startup probe - check if app is initialized"""
        if app_initialized:
            return jsonify({'status': 'started'}), 200
        return jsonify({'status': 'starting'}), 503

    @app.route('/health/live')
    def liveness():
        """Liveness probe - check if app is alive"""
        uptime = time.time() - start_time
        return jsonify({
            'status': 'alive',
            'uptime': uptime
        }), 200

    @app.route('/health/ready')
    def readiness():
        """Readiness probe - check if app can handle traffic"""
        try:
            check_database()
            check_cache()
            return jsonify({
                'status': 'ready',
                'checks': {
                    'database': 'healthy',
                    'cache': 'healthy'
                }
            }), 200
        except Exception as e:
            return jsonify({
                'status': 'not ready',
                'error': str(e)
            }), 503
