{{- if and .Values.databaseFailover.enabled .Values.databaseFailover.neo4j.enabled }}
{{- $neo := .Values.databaseFailover.neo4j }}
{{- $cluster := $neo.cluster }}
{{- $metrics := $cluster.metrics }}
apiVersion: neo4j.com/v1
kind: Neo4j
metadata:
  name: {{ $cluster.name }}
  namespace: {{ $neo.operator.namespace }}
  labels:
    app.kubernetes.io/name: {{ $cluster.name }}
    app.kubernetes.io/part-of: summit-data-plane
spec:
  adminUser:
    name: NEO4J_AUTH
    valueFrom:
      secretKeyRef:
        name: {{ $cluster.authSecretName }}
        key: password
  deploymentMode: CausalCluster
  disablePodMonitor: false
  image: {{ $cluster.image }}
  core:
    numberOfServers: {{ $cluster.coreServers }}
    persistentVolumeClaim:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: {{ $cluster.coreStorage }}
    resources:
{{ toYaml $cluster.coreResources | nindent 6 }}
  replica:
    numberOfServers: {{ $cluster.replicaServers }}
    persistentVolumeClaim:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: {{ $cluster.replicaStorage }}
    resources:
{{ toYaml $cluster.replicaResources | nindent 6 }}
  routing:
    enabled: true
    serviceType: ClusterIP
  config:
    dbms.mode: CORE
    dbms.cluster.raft.minimum_core_cluster_size_at_runtime: "{{ $cluster.coreServers }}"
    dbms.routing.enabled: "true"
  podSpec:
    containers:
      - name: neo4j
        env:
          - name: NEO4J_ACCEPT_LICENSE_AGREEMENT
            value: "yes"
        ports:
          - containerPort: 7474
            name: http
          - containerPort: 7687
            name: bolt
        readinessProbe:
          httpGet:
            path: /ready
            port: 7474
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /live
            port: 7474
          initialDelaySeconds: 60
          periodSeconds: 30
    sidecars:
      - name: metrics
        image: {{ $metrics.image }}
        ports:
          - name: metrics
            containerPort: {{ $metrics.port }}
        env:
          - name: NEO4J_URI
            value: bolt://localhost:7687
          - name: NEO4J_USERNAME
            valueFrom:
              secretKeyRef:
                name: {{ $cluster.authSecretName }}
                key: username
          - name: NEO4J_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ $cluster.authSecretName }}
                key: password
{{- end }}
