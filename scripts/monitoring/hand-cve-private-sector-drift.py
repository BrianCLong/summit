import json
import os
import sys

# Ensure project root is in path
sys.path.append(os.getcwd())

from summit.vuln.types import VulnRecord
from summit.vuln.drift.compute_drift import compute_drift

def main():
    input_file = "artifacts/vuln-intel/hand-cve-private-sector/vuln_records.jsonl"
    output_file = "artifacts/vuln-intel/hand-cve-private-sector/drift_report.json"

    if not os.path.exists(input_file):
        print(f"Input file {input_file} not found. Run ingestion first.")
        return

    records = []
    with open(input_file, "r") as f:
        for line in f:
            if line.strip():
                records.append(VulnRecord.model_validate_json(line))

    # Mock "known CVEs" for demonstration
    # In a real app, this would come from a database or another feed
    known_cves = ["CVE-2023-32681"]

    drift_report = compute_drift(records, known_cves)

    with open(output_file, "w") as f:
        json.dump(drift_report, f, sort_keys=True, indent=2)

    print(f"Drift report generated at {output_file}")

if __name__ == "__main__":
    main()
