#!/bin/bash
#
# CI SBOM Generation and Vulnerability Gate Script
# 
# This script generates Software Bill of Materials (SBOM) for the Summit platform
# and performs vulnerability scanning before allowing deployment.

set -euo pipefail

# Configuration
readonly REPO_ROOT=$(git rev-parse --show-toplevel)
readonly TEMP_DIR=$(mktemp -d)
readonly TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
readonly BUILD_ID=${GITHUB_RUN_NUMBER:-$(date +%s)}
readonly OUTPUT_DIR="${REPO_ROOT}/sbom-output"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

# Severity thresholds
readonly CRITICAL_THRESHOLD=0
readonly HIGH_THRESHOLD=5
readonly MEDIUM_THRESHOLD=10

# Cleanup function
cleanup() {
    echo "Cleaning up temporary files..."
    rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

# Print colored output
print_status() {
    local color=$1
    shift
    echo -e "${color}$*${NC}"
}

# Check prerequisites
check_prerequisites() {
    print_status $YELLOW "Checking prerequisites..."

    local missing_tools=()
    
    command -v syft >/dev/null 2>&1 || missing_tools+=("syft")
    command -v grype >/dev/null 2>&1 || missing_tools+=("grype")
    command -v jq >/dev/null 2>&1 || missing_tools+=("jq")
    command -v trivy >/dev/null 2>&1 || missing_tools+=("trivy")
    
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        print_status $RED "Missing required tools: ${missing_tools[*]}"
        print_status $YELLOW "Install them with: brew install anchore/syft/syft anchore/grype/grype jq aquasecurity/trivy/trivy"
        exit 1
    fi

    print_status $GREEN "âœ“ Prerequisites met"
}

# Generate SBOM using Syft
generate_sbom() {
    print_status $YELLOW "Generating SBOM using Syft..."

    # Create output directory
    mkdir -p "$OUTPUT_DIR"

    # Generate SBOM in CycloneDX format
    syft packages dir:"$REPO_ROOT" \
        --output cyclonedx-json \
        --file "$OUTPUT_DIR/sbom.cyclonedx.json" \
        --exclude '**/node_modules/**' \
        --exclude '**/.git/**' \
        --exclude '**/dist/**' \
        --exclude '**/build/**' \
        --exclude '**/target/**'

    # Generate SBOM in SPDX format
    syft packages dir:"$REPO_ROOT" \
        --output spdx-json \
        --file "$OUTPUT_DIR/sbom.spdx.json" \
        --exclude '**/node_modules/**' \
        --exclude '**/.git/**' \
        --exclude '**/dist/**' \
        --exclude '**/build/**' \
        --exclude '**/target/**'

    # Generate SBOM in Syft table format
    syft packages dir:"$REPO_ROOT" \
        --output table \
        --file "$OUTPUT_DIR/sbom.table.txt" \
        --exclude '**/node_modules/**' \
        --exclude '**/.git/**' \
        --exclude '**/dist/**' \
        --exclude '**/build/**' \
        --exclude '**/target/**'

    print_status $GREEN "âœ“ SBOM generated successfully"
    echo "SBOMs saved to: $OUTPUT_DIR/"
}

# Run vulnerability scan with Grype
run_vulnerability_scan() {
    print_status $YELLOW "Running vulnerability scan with Grype..."

    # Scan the directory
    grype dir:"$REPO_ROOT" \
        --output json \
        --file "$OUTPUT_DIR/vulnerabilities.grype.json" \
        --exclude '**/node_modules/**' \
        --exclude '**/.git/**' \
        --exclude '**/dist/**' \
        --exclude '**/build/**' \
        --exclude '**/target/**'

    # Also run Trivy scan for comparison
    if command -v trivy >/dev/null 2>&1; then
        trivy fs \
            --format json \
            --output "$OUTPUT_DIR/vulnerabilities.trivy.json" \
            --timeout 10m \
            "$REPO_ROOT"
    fi

    print_status $GREEN "âœ“ Vulnerability scan completed"
}

# Analyze vulnerabilities and enforce gates
analyze_vulnerabilities() {
    print_status $YELLOW "Analyzing vulnerabilities and enforcing gates..."

    local critical_count=0
    local high_count=0
    local medium_count=0
    local low_count=0

    if [[ -f "$OUTPUT_DIR/vulnerabilities.grype.json" ]]; then
        # Count vulnerabilities by severity
        critical_count=$(jq -r '.matches[]?.vulnerability.severity // empty' "$OUTPUT_DIR/vulnerabilities.grype.json" 2>/dev/null | grep -c "Critical" || true)
        high_count=$(jq -r '.matches[]?.vulnerability.severity // empty' "$OUTPUT_DIR/vulnerabilities.grype.json" 2>/dev/null | grep -c "High" || true)
        medium_count=$(jq -r '.matches[]?.vulnerability.severity // empty' "$OUTPUT_DIR/vulnerabilities.grype.json" 2>/dev/null | grep -c "Medium" || true)
        low_count=$(jq -r '.matches[]?.vulnerability.severity // empty' "$OUTPUT_DIR/vulnerabilities.grype.json" 2>/dev/null | grep -c "Low" || true)
    fi

    echo "Vulnerability Summary:"
    echo "  Critical: $critical_count (Threshold: $CRITICAL_THRESHOLD)"
    echo "  High:     $high_count (Threshold: $HIGH_THRESHOLD)"
    echo "  Medium:   $medium_count (Threshold: $MEDIUM_THRESHOLD)"
    echo "  Low:      $low_count"

    # Check gates
    local gate_passed=true

    if [[ $critical_count -gt $CRITICAL_THRESHOLD ]]; then
        print_status $RED "âœ— FAIL: Critical vulnerabilities exceed threshold ($critical_count > $CRITICAL_THRESHOLD)"
        gate_passed=false
    else
        print_status $GREEN "âœ“ PASS: Critical vulnerabilities within threshold"
    fi

    if [[ $high_count -gt $HIGH_THRESHOLD ]]; then
        print_status $RED "âœ— FAIL: High vulnerabilities exceed threshold ($high_count > $HIGH_THRESHOLD)"
        gate_passed=false
    else
        print_status $GREEN "âœ“ PASS: High vulnerabilities within threshold"
    fi

    if [[ $medium_count -gt $MEDIUM_THRESHOLD ]]; then
        print_status $RED "âœ— FAIL: Medium vulnerabilities exceed threshold ($medium_count > $MEDIUM_THRESHOLD)"
        gate_passed=false
    else
        print_status $GREEN "âœ“ PASS: Medium vulnerabilities within threshold"
    fi

    if [[ "$gate_passed" == false ]]; then
        print_status $RED "Vulnerability gate failed. Blocking deployment."
        print_status $YELLOW "Run the following to see detailed results:"
        echo "  cat $OUTPUT_DIR/vulnerabilities.grype.json | jq '.'"
        exit 1
    fi

    print_status $GREEN "âœ“ All vulnerability gates passed"
}

# Generate SBOM and vulnerability summary report
generate_summary_report() {
    print_status $YELLOW "Generating SBOM and vulnerability summary report..."

    cat > "$OUTPUT_DIR/summary.md" << EOF
# SBOM and Vulnerability Summary Report

**Build ID:** $BUILD_ID  
**Timestamp:** $TIMESTAMP  
**Repository:** $(git remote get-url origin | sed 's/git@\(.*\):\(.*\)\.git/https:\/\/\1\/\2/')  
**Commit:** $(git rev-parse HEAD)  

## SBOM Generation
- Generated using: Syft v$(syft version 2>/dev/null || echo "unknown")
- Formats: CycloneDX JSON, SPDX JSON, Table
- Excluded directories: node_modules, .git, dist, build, target

## Vulnerability Scan Results
- Scanner: Grype v$(grype version 2>/dev/null || echo "unknown")
- Critical vulnerabilities: $critical_count
- High vulnerabilities: $high_count  
- Medium vulnerabilities: $medium_count
- Low vulnerabilities: $low_count

## Gate Status
EOF

    if [[ -f "$OUTPUT_DIR/vulnerabilities.grype.json" ]] && jq -e '.matches | length > 0' "$OUTPUT_DIR/vulnerabilities.grype.json" >/dev/null 2>&1; then
        echo "- Result: âŒ FAILED (vulnerabilities found)" >> "$OUTPUT_DIR/summary.md"
    else
        echo "- Result: âœ… PASSED (no critical/high vulnerabilities found)" >> "$OUTPUT_DIR/summary.md"
    fi

    cat >> "$OUTPUT_DIR/summary.md" << EOF

## Next Steps
1. Review full SBOMs in \`$OUTPUT_DIR/\`
2. Address any identified vulnerabilities
3. Re-run this pipeline after fixes

## Artifacts
- SBOM (CycloneDX): [sbom.cyclonedx.json]($OUTPUT_DIR/sbom.cyclonedx.json)
- SBOM (SPDX): [sbom.spdx.json]($OUTPUT_DIR/sbom.spdx.json)
- Grype Results: [vulnerabilities.grype.json]($OUTPUT_DIR/vulnerabilities.grype.json)
EOF

    print_status $GREEN "âœ“ Summary report generated: $OUTPUT_DIR/summary.md"
}

# Main execution
main() {
    echo "Starting CI SBOM Generation and Vulnerability Gate..."
    echo "Repository Root: $REPO_ROOT"
    echo "Build ID: $BUILD_ID"
    echo ""

    check_prerequisites
    generate_sbom
    run_vulnerability_scan  
    analyze_vulnerabilities
    generate_summary_report

    print_status $GREEN "ðŸŽ‰ SBOM and Vulnerability Gate completed successfully!"
    echo "Outputs saved to: $OUTPUT_DIR/"
}

# Run main function
main "$@"