#!/bin/bash
# scripts/add-critical-roadmap-items.sh
# Purpose: Add critical roadmap items to the backlog
# Generated by Jules for comprehensive roadmap alignment

set -e

BACKLOG_FILE="planning/BACKLOG.yaml"
ROADMAP_SOURCE="planning/CRITICAL_COMPANY_SUCCESS_ROADMAP_ITEMS.md"

if [ ! -f "$ROADMAP_SOURCE" ]; then
    echo "Error: Source file $ROADMAP_SOURCE not found."
    exit 1
fi

echo "Adding critical roadmap items to backlog..."

# Check if BACKLOG.yaml exists, if not create it with header
if [ ! -f "$BACKLOG_FILE" ]; then
    echo "Creating new backlog file: $BACKLOG_FILE"
    echo "# Company Backlog" > "$BACKLOG_FILE"
    echo "items:" >> "$BACKLOG_FILE"
fi

# Determine current count of items to generate IDs if needed (simple approximation)
CURRENT_COUNT=$(grep -c "- id:" "$BACKLOG_FILE" || true)

# Read the source file line by line
while IFS= read -r line; do
    # Look for lines starting with a number and dot (e.g., "1. GTM: ...")
    if [[ "$line" =~ ^[0-9]+\.\ (.*) ]]; then
        ITEM_TEXT="${BASH_REMATCH[1]}"

        # Simple ID generation
        CURRENT_COUNT=$((CURRENT_COUNT + 1))
        ITEM_ID="TASK-$(printf "%04d" $CURRENT_COUNT)"

        # Categorize based on prefix
        CATEGORY="General"
        if [[ "$ITEM_TEXT" == GTM:* ]]; then CATEGORY="GTM"; fi
        if [[ "$ITEM_TEXT" == "Customer Success:"* ]]; then CATEGORY="Customer Success"; fi
        if [[ "$ITEM_TEXT" == "Product-Market Fit:"* ]]; then CATEGORY="Product-Market Fit"; fi
        if [[ "$ITEM_TEXT" == "Enterprise:"* ]]; then CATEGORY="Enterprise"; fi
        if [[ "$ITEM_TEXT" == "Monetization:"* ]]; then CATEGORY="Monetization"; fi
        if [[ "$ITEM_TEXT" == "Operations:"* ]]; then CATEGORY="Operations"; fi
        if [[ "$ITEM_TEXT" == "Partnership:"* ]]; then CATEGORY="Partnership"; fi
        if [[ "$ITEM_TEXT" == "Finance:"* ]]; then CATEGORY="Finance"; fi

        # Append to yaml
        echo "  - id: $ITEM_ID" >> "$BACKLOG_FILE"
        echo "    title: \"$ITEM_TEXT\"" >> "$BACKLOG_FILE"
        echo "    status: open" >> "$BACKLOG_FILE"
        echo "    priority: critical" >> "$BACKLOG_FILE"
        echo "    category: \"$CATEGORY\"" >> "$BACKLOG_FILE"
        echo "    source: \"CRITICAL_COMPANY_SUCCESS_ROADMAP_ITEMS.md\"" >> "$BACKLOG_FILE"

        echo "Added: $ITEM_ID - $ITEM_TEXT"
    fi
done < "$ROADMAP_SOURCE"

echo "Successfully processed roadmap items."
