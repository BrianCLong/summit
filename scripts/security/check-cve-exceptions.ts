#!/usr/bin/env tsx
/**
 * CVE Exception Expiry Checker
 *
 * Validates that CVE exceptions in .security/deps/policy.yaml have not expired
 * and warns when exceptions are approaching expiry.
 *
 * Exit codes:
 * 0 - All exceptions valid
 * 1 - Expired exceptions found
 * 2 - Exceptions expiring soon (within 14 days)
 */

import { readFileSync } from 'fs';
import { parse as parseYaml } from 'yaml';

interface CVEOverride {
  package: string;
  version_regex?: string;
  cve?: string;
  justification: string;
  ticket: string;
  expires: string;
}

interface DepPolicy {
  policy: {
    metadata: {
      owner: string;
      updated: string;
      description: string;
    };
    allow_overrides?: CVEOverride[];
  };
}

const POLICY_FILE = '.security/deps/policy.yaml';
const WARN_DAYS_BEFORE_EXPIRY = 14;

function main() {
  console.log('--- CVE Exception Expiry Check ---\n');

  let policyContent: string;
  try {
    policyContent = readFileSync(POLICY_FILE, 'utf-8');
  } catch (err) {
    console.error(`❌ Failed to read ${POLICY_FILE}`);
    process.exit(1);
  }

  let policy: DepPolicy;
  try {
    policy = parseYaml(policyContent);
  } catch (err) {
    console.error(`❌ Failed to parse ${POLICY_FILE} as YAML`);
    process.exit(1);
  }

  const overrides = policy.policy.allow_overrides || [];

  if (overrides.length === 0) {
    console.log('✅ No CVE exceptions found - all clear!');
    process.exit(0);
  }

  console.log(`Found ${overrides.length} CVE exception(s)\n`);

  const now = new Date();
  const warnThreshold = new Date(now.getTime() + WARN_DAYS_BEFORE_EXPIRY * 24 * 60 * 60 * 1000);

  let expiredCount = 0;
  let warnCount = 0;
  let validCount = 0;

  for (const override of overrides) {
    const expiryDate = new Date(override.expires);
    const daysUntilExpiry = Math.floor((expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));

    const status =
      expiryDate < now ? 'EXPIRED' :
      expiryDate < warnThreshold ? 'EXPIRING SOON' :
      'VALID';

    const icon =
      status === 'EXPIRED' ? '❌' :
      status === 'EXPIRING SOON' ? '⚠️ ' :
      '✅';

    console.log(`${icon} ${override.cve || override.package}`);
    console.log(`   Package: ${override.package}`);
    if (override.version_regex) {
      console.log(`   Version: ${override.version_regex}`);
    }
    console.log(`   Expires: ${override.expires} (${daysUntilExpiry} days)`);
    console.log(`   Ticket: ${override.ticket}`);
    console.log(`   Reason: ${override.justification}`);
    console.log('');

    if (status === 'EXPIRED') {
      expiredCount++;
    } else if (status === 'EXPIRING SOON') {
      warnCount++;
    } else {
      validCount++;
    }
  }

  console.log('--- Summary ---');
  console.log(`✅ Valid: ${validCount}`);
  console.log(`⚠️  Expiring soon (< ${WARN_DAYS_BEFORE_EXPIRY} days): ${warnCount}`);
  console.log(`❌ Expired: ${expiredCount}`);
  console.log('');

  if (expiredCount > 0) {
    console.error('❌ FAILURE: Expired CVE exceptions found!');
    console.error('Action required: Remove expired exceptions or renew with updated justification and Security Lead approval.');
    process.exit(1);
  }

  if (warnCount > 0) {
    console.warn('⚠️  WARNING: CVE exceptions expiring soon!');
    console.warn('Action required: Review exceptions and either:');
    console.warn('  1. Remove the exception if the vulnerability is now fixed');
    console.warn('  2. Renew with updated justification and Security Lead approval');
    process.exit(2);
  }

  console.log('✅ All CVE exceptions are valid');
  process.exit(0);
}

main();
