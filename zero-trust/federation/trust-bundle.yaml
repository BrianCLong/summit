# Zero Trust Multi-Cluster Trust Bundle Configuration
# Manages trust relationships between federated clusters
apiVersion: trust.intelgraph.io/v1
kind: TrustBundle
metadata:
  name: intelgraph-federation-bundle
  namespace: zero-trust-system
  labels:
    app.kubernetes.io/name: zero-trust
    app.kubernetes.io/component: federation
spec:
  # Primary trust domain for this cluster
  trustDomain: cluster.local

  # Federation policy
  federationPolicy:
    mode: mesh  # mesh | hub-spoke | hierarchical
    trustModel: explicit  # explicit | transitive

  # Federated clusters with trust relationships
  federatedClusters:
    - name: primary-cluster
      trustDomain: primary.intelgraph.io
      endpoint: https://spire-server.primary.intelgraph.io:8081
      trustLevel: full
      bundleEndpoint:
        url: https://bundle.primary.intelgraph.io:443
        profile: https_spiffe
      capabilities:
        - identity-issuance
        - policy-enforcement
        - audit-collection
      labels:
        region: us-east-1
        environment: production
        classification: secret

    - name: secondary-cluster
      trustDomain: secondary.intelgraph.io
      endpoint: https://spire-server.secondary.intelgraph.io:8081
      trustLevel: full
      bundleEndpoint:
        url: https://bundle.secondary.intelgraph.io:443
        profile: https_spiffe
      capabilities:
        - identity-issuance
        - policy-enforcement
        - audit-collection
      labels:
        region: us-west-2
        environment: production
        classification: secret

    - name: dr-cluster
      trustDomain: dr.intelgraph.io
      endpoint: https://spire-server.dr.intelgraph.io:8081
      trustLevel: limited
      bundleEndpoint:
        url: https://bundle.dr.intelgraph.io:443
        profile: https_spiffe
      capabilities:
        - identity-issuance
        - audit-collection
      labels:
        region: eu-west-1
        environment: dr
        classification: secret

    - name: analytics-cluster
      trustDomain: analytics.intelgraph.io
      endpoint: https://spire-server.analytics.intelgraph.io:8081
      trustLevel: restricted
      bundleEndpoint:
        url: https://bundle.analytics.intelgraph.io:443
        profile: https_spiffe
      capabilities:
        - identity-issuance
      labels:
        region: us-east-1
        environment: production
        classification: confidential

  # Trust bundle refresh configuration
  refreshPolicy:
    interval: 5m
    retryBackoff:
      initialInterval: 1s
      maxInterval: 30s
      multiplier: 2
    failureThreshold: 3

  # Cross-cluster identity mapping
  identityMapping:
    # Map external trust domains to internal namespaces
    rules:
      - from:
          trustDomain: primary.intelgraph.io
          spiffeIdPattern: "spiffe://primary.intelgraph.io/ns/*/sa/*"
        to:
          trustDomain: cluster.local
          namespaceMapping: preserve  # preserve | flatten | custom

      - from:
          trustDomain: secondary.intelgraph.io
          spiffeIdPattern: "spiffe://secondary.intelgraph.io/ns/*/sa/*"
        to:
          trustDomain: cluster.local
          namespaceMapping: preserve

      - from:
          trustDomain: analytics.intelgraph.io
          spiffeIdPattern: "spiffe://analytics.intelgraph.io/ns/analytics/sa/*"
        to:
          trustDomain: cluster.local
          namespaceMapping: custom
          customNamespace: analytics-federation

  # Trust verification settings
  verification:
    certificateValidation:
      enabled: true
      checkRevocation: true
      ocspResponder: https://ocsp.intelgraph.io
      crlDistributionPoints:
        - https://crl.intelgraph.io/federation.crl
    bundleValidation:
      minSignatures: 2
      requireTrustAnchor: true

  # Security constraints for federated identities
  securityConstraints:
    maxCertificateLifetime: 24h
    requireMtls: true
    minimumTlsVersion: "1.3"
    allowedCipherSuites:
      - TLS_AES_256_GCM_SHA384
      - TLS_CHACHA20_POLY1305_SHA256
    pinnedPublicKeys: []

---
apiVersion: trust.intelgraph.io/v1
kind: TrustPropagationPolicy
metadata:
  name: federation-propagation-policy
  namespace: zero-trust-system
spec:
  # How trust decisions propagate across clusters
  propagationMode: eventual  # immediate | eventual | on-demand

  # Consensus requirements for cross-cluster trust
  consensus:
    minClusters: 2
    timeout: 30s
    quorumType: majority  # majority | unanimous | weighted

  # Trust decision caching
  caching:
    enabled: true
    ttl: 5m
    maxEntries: 10000
    evictionPolicy: lru

  # Conflict resolution
  conflictResolution:
    strategy: most-restrictive  # most-restrictive | most-permissive | primary-wins
    notifyOnConflict: true

  # Propagation filters
  filters:
    # Only propagate trust for specific namespaces
    namespaceSelector:
      matchLabels:
        federation: enabled
    # Only propagate trust for specific service accounts
    serviceAccountSelector:
      matchExpressions:
        - key: federation.intelgraph.io/propagate
          operator: In
          values: ["true"]

  # Audit trail for trust propagation
  audit:
    enabled: true
    destination: trust-propagation-audit
    retention: 90d

---
apiVersion: trust.intelgraph.io/v1
kind: CrossClusterAuthorizationPolicy
metadata:
  name: federation-authz-policy
  namespace: zero-trust-system
spec:
  # Authorization rules for cross-cluster access
  rules:
    # Allow primary cluster full access
    - name: primary-cluster-full-access
      from:
        clusters:
          - primary-cluster
        principals:
          - "spiffe://primary.intelgraph.io/ns/intelgraph/sa/api-gateway"
          - "spiffe://primary.intelgraph.io/ns/intelgraph/sa/api-server"
      to:
        services:
          - name: "*"
            namespace: intelgraph
        operations:
          - methods: ["*"]
            paths: ["*"]
      when:
        - key: request.headers[x-cluster-auth]
          values: ["verified"]

    # Allow secondary cluster read access to shared services
    - name: secondary-cluster-read-access
      from:
        clusters:
          - secondary-cluster
        principals:
          - "spiffe://secondary.intelgraph.io/ns/intelgraph/sa/*"
      to:
        services:
          - name: entity-service
            namespace: intelgraph
          - name: relationship-service
            namespace: intelgraph
          - name: graph-query-service
            namespace: intelgraph
        operations:
          - methods: ["GET"]
            paths: ["/api/v1/*"]
          - methods: ["POST"]
            paths: ["/api/v1/query/*"]
      when:
        - key: request.headers[x-cluster-auth]
          values: ["verified"]

    # Analytics cluster restricted to analytics endpoints
    - name: analytics-cluster-restricted
      from:
        clusters:
          - analytics-cluster
        principals:
          - "spiffe://analytics.intelgraph.io/ns/analytics/sa/analytics-worker"
      to:
        services:
          - name: analytics-api
            namespace: intelgraph
          - name: metrics-service
            namespace: observability
        operations:
          - methods: ["GET", "POST"]
            paths: ["/api/v1/analytics/*", "/api/v1/metrics/*"]
      when:
        - key: request.headers[x-cluster-auth]
          values: ["verified"]
        - key: request.time
          values: ["08:00-22:00"]  # Business hours only

    # DR cluster - emergency access only
    - name: dr-cluster-emergency
      from:
        clusters:
          - dr-cluster
        principals:
          - "spiffe://dr.intelgraph.io/ns/*/sa/*"
      to:
        services:
          - name: "*"
            namespace: intelgraph
        operations:
          - methods: ["*"]
            paths: ["*"]
      when:
        - key: request.headers[x-emergency-mode]
          values: ["active"]
        - key: request.headers[x-break-glass-token]
          notValues: [""]

  # Default deny for unlisted cross-cluster access
  defaultAction: DENY

  # Audit all cross-cluster authorization decisions
  audit:
    logDenied: true
    logAllowed: true
