#!/bin/bash
set -e

# Summit Developer Experience CLI
# Usage: ./dev [command]

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

function echo_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

function echo_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

function echo_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

function echo_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

function check_dependencies() {
    echo_info "Checking dependencies..."
    MISSING=0

    if ! command -v docker &> /dev/null; then
        echo_error "docker is not installed."
        MISSING=1
    fi

    if ! command -v pnpm &> /dev/null; then
        echo_error "pnpm is not installed."
        MISSING=1
    fi

    if ! command -v node &> /dev/null; then
        echo_error "node is not installed."
        MISSING=1
    fi

    if [ $MISSING -eq 1 ]; then
        exit 1
    fi
    echo_success "Dependencies checked."
}

function setup() {
    echo_info "Setting up local environment..."

    # Check dependencies first
    check_dependencies

    # Install dependencies
    echo_info "Installing dependencies via pnpm..."
    pnpm install

    # Create .env if not exists
    if [ ! -f .env ]; then
        echo_warn ".env not found. Creating from .env.example..."
        cp .env.example .env
        echo_success ".env created."
    fi

    # Build packages
    echo_info "Building packages..."
    pnpm build

    # Setup Databases / Seeds
    echo_info "Running database setup..."
    # Assuming make bootstrap handles this well, using it as a fallback or primary
    make bootstrap

    echo_success "Setup complete! Run './dev up' to start the environment."
}

function up() {
    echo_info "Starting services..."
    make up
}

function down() {
    echo_info "Stopping services..."
    make down
}

function restart() {
    down
    up
}

function test() {
    echo_info "Running tests..."
    if [ "$1" == "server" ]; then
        pnpm --filter intelgraph-server test
    elif [ "$1" == "client" ]; then
        pnpm --filter client test
    elif [ "$1" == "unit" ]; then
        pnpm test:unit
    elif [ "$1" == "e2e" ]; then
        pnpm test:e2e
    else
        pnpm test
    fi
}

function lint() {
    echo_info "Linting code..."
    pnpm lint
}

function logs() {
    echo_info "Tailing logs..."
    make logs
}

function doctor() {
    echo_info "Running system diagnosis..."
    check_dependencies

    echo_info "Checking Docker containers..."
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

    echo_info "Checking Node version..."
    node -v

    echo_info "Checking pnpm version..."
    pnpm -v

    echo_success "Doctor check complete."
}

function deploy() {
    echo_info "Deploying (simulation)..."
    ./scripts/blue-green-deploy.sh "$@"
}

function rollback() {
    echo_info "Rolling back..."
    ./scripts/rollback.sh "$@"
}

function help() {
    echo "Usage: ./dev [command]"
    echo ""
    echo "Commands:"
    echo "  setup       One-command setup (install deps, build, db setup)"
    echo "  up          Start development environment (hot-reload)"
    echo "  down        Stop development environment"
    echo "  restart     Restart development environment"
    echo "  test [type] Run tests (all, server, client, unit, e2e)"
    echo "  lint        Lint code"
    echo "  logs        View logs"
    echo "  doctor      Check system health"
    echo "  deploy      Simulate blue/green deployment"
    echo "  rollback    Rollback a service"
    echo "  help        Show this help message"
}

# Main dispatch
case "$1" in
    setup)
        setup
        ;;
    up)
        up
        ;;
    down)
        down
        ;;
    restart)
        restart
        ;;
    test)
        shift
        test "$@"
        ;;
    lint)
        lint
        ;;
    logs)
        logs
        ;;
    doctor)
        doctor
        ;;
    deploy)
        shift
        deploy "$@"
        ;;
    rollback)
        shift
        rollback "$@"
        ;;
    *)
        help
        ;;
esac
