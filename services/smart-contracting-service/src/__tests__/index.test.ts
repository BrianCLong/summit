/**
 * Unit tests for Smart Contracting Service
 */

import { describe, it, expect } from '@jest/globals';
import request from 'supertest';
import express from 'express';

// Create a minimal test app
const createTestApp = () => {
  const app = express();
  app.use(express.json());

  const contracts = new Map<string, any>();

  // Health endpoint
  app.get('/health', (_req, res) => {
    res.json({ status: 'healthy', service: 'smart-contracting-service' });
  });

  // Contract generation
  app.post('/api/contracts/generate', (req, res) => {
    const { forecastIds, priority = 'routine' } = req.body;
    const contract = {
      id: `contract-${Date.now()}`,
      contractNumber: `W91CRB-2025-C-0001`,
      title: 'Auto-Generated Contract',
      status: 'draft',
      priority,
      totalValue: 50000,
      autoGenerated: true,
      sourceForecastIds: forecastIds,
    };
    contracts.set(contract.id, contract);
    res.status(201).json({ data: contract });
  });

  // Get contracts
  app.get('/api/contracts', (_req, res) => {
    res.json({ data: Array.from(contracts.values()) });
  });

  // Get recommended vendors
  app.get('/api/vendors/recommended', (_req, res) => {
    res.json({
      data: [
        { id: 'VENDOR-001', name: 'Approved Defense Supplier', rating: 4.8 },
        { id: 'VENDOR-002', name: 'Military Logistics Partners', rating: 4.5 },
      ],
    });
  });

  return app;
};

describe('Smart Contracting Service', () => {
  const app = createTestApp();

  describe('Health Check', () => {
    it('should return healthy status', async () => {
      const response = await request(app).get('/health');
      expect(response.status).toBe(200);
      expect(response.body.status).toBe('healthy');
      expect(response.body.service).toBe('smart-contracting-service');
    });
  });

  describe('Contract Generation', () => {
    it('should generate a contract from forecast IDs', async () => {
      const response = await request(app)
        .post('/api/contracts/generate')
        .send({
          forecastIds: ['forecast-001', 'forecast-002'],
          priority: 'priority',
        });

      expect(response.status).toBe(201);
      expect(response.body.data).toHaveProperty('id');
      expect(response.body.data).toHaveProperty('contractNumber');
      expect(response.body.data.status).toBe('draft');
      expect(response.body.data.autoGenerated).toBe(true);
      expect(response.body.data.priority).toBe('priority');
    });
  });

  describe('Vendor Recommendations', () => {
    it('should return recommended vendors', async () => {
      const response = await request(app).get('/api/vendors/recommended');

      expect(response.status).toBe(200);
      expect(response.body.data).toHaveLength(2);
      expect(response.body.data[0]).toHaveProperty('id');
      expect(response.body.data[0]).toHaveProperty('name');
      expect(response.body.data[0]).toHaveProperty('rating');
    });
  });
});
