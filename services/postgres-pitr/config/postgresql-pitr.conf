# PostgreSQL PITR Configuration
# Optimized for RPO â‰¤ 5 minutes

# WAL Configuration
wal_level = replica
archive_mode = on
archive_command = '/usr/local/bin/wal-archive.sh %p %f'
archive_timeout = 60  # Force WAL switch every 60 seconds

# Replication and Standby
max_wal_senders = 10
wal_keep_size = 1GB
hot_standby = on
hot_standby_feedback = on

# Checkpoint Configuration
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 1GB

# Recovery Configuration
restore_command = '/usr/local/bin/wal-restore.sh %f %p'
recovery_target_timeline = 'latest'

# Performance Tuning
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 1GB           # Favor HNSW/vector index builds
work_mem = 64MB                      # Higher per-query memory for ANN search
max_parallel_workers_per_gather = 4  # Enable parallel query execution
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
parallel_leader_participation = on

# Logging for Recovery Monitoring
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# Statistics
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Extensions
shared_preload_libraries = 'pg_partman_bgw'
pg_partman_bgw.interval = 3600
pg_partman_bgw.role = 'postgres'
pg_partman_bgw.dbname = 'maestro'
