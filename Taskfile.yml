version: '3'

tasks:
  doctor:
    cmds:
      - node scripts/doctor.js
    desc: Run health checks for the development environment

  bootstrap:
    cmds:
      - pnpm install
    desc: Install project dependencies

  policy:apply:
    desc: 'Apply Gatekeeper/Kyverno policies'
    cmds:
      - kubectl apply -f k8s/policy/gatekeeper/
      - kubectl apply -f k8s/policy/kyverno/

  observability:apply:
    desc: 'Apply Prometheus alerts and Grafana dashboards'
    cmds:
      - kubectl create configmap prom-alerts --from-file=observability/prometheus/alerts.yml -n monitoring --dry-run=client -o yaml | kubectl apply -f -
      - kubectl create configmap grafana-build-platform --from-file=observability/grafana/dashboards/build-platform.json -n monitoring --dry-run=client -o yaml | kubectl apply -f -

  otel:apply:
    desc: 'Deploy or update OTel Collector config'
    cmds:
      - kubectl create configmap otel-collector-config --from-file=observability/otel/collector-config.yaml -n observability --dry-run=client -o yaml | kubectl apply -f -

  # --- Deployment & Infra Tasks ---

  infra:init:
    desc: 'Initialize Terraform for Production'
    dir: terraform/environments/prod
    cmds:
      - terraform init

  infra:apply:
    desc: 'Provision Production Infrastructure (AWS)'
    dir: terraform/environments/prod
    cmds:
      - terraform apply

  secrets:init:
    desc: 'Bootstrap production secrets (DB, API Keys)'
    cmds:
      - ./scripts/aws-init-secrets.sh

  deploy:aws:
    desc: 'Manual deployment of all services to AWS EKS'
    cmds:
      - helm upgrade --install maestro charts/universal-app --namespace default --values charts/universal-app/values.yaml --set image.repository=$ECR_REGISTRY/summit/maestro --set image.tag=latest
      - helm upgrade --install prov-ledger charts/universal-app --namespace default --values charts/universal-app/values.yaml --set image.repository=$ECR_REGISTRY/summit/prov-ledger --set image.tag=latest

