#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -euo pipefail

BRANCH="$(git rev-parse --abbrev-ref HEAD)"

# Strict on protected branches, soft otherwise
if [ "$BRANCH" = "main" ] || echo "$BRANCH" | grep -Eq '^release/|^hotfix/'; then
  STRICT=true BASE_REF="origin/main" MAX_FILES=200 MAX_FILE_MB=5 bash scripts/pr_guard.sh --strict || exit 1
else
  BASE_REF="origin/main" bash scripts/pr_guard.sh || true
fi

# Chain Git LFS pre-push if available
if command -v git-lfs >/dev/null 2>&1; then
  git lfs pre-push "$@"
fi

run_quick_tests() {
  if command -v pnpm >/dev/null 2>&1; then
    pnpm run test:quick
  else
    npm run --if-present test:quick
  fi
}

# Fast sanity tests (lightweight)
if [ "$BRANCH" = "main" ] || echo "$BRANCH" | grep -Eq '^release/|^hotfix/'; then
  run_quick_tests
else
  run_quick_tests || true
fi
