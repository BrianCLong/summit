#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -euo pipefail

start_ts=$(date +%s)
repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$repo_root"

echo "ğŸ” Running pre-push checks (precodegen â†’ persist:queries â†’ verify:safelist â†’ lint)"

# 0) Detect package manager (defaults to npm)
PKG="${PKG:-npm}"

# 1) Precodegen: fail fast on duplicate GraphQL operation names
echo "ğŸ§© Precodegen: checking for duplicate operation names..."
if ! node scripts/find-duplicate-ops.mjs; then
  echo "âŒ Duplicate GraphQL operation names detected. Fix and retry."
  exit 1
fi

# 2) Persisted ops + types (pin concurrency) with snapshot fallback when live API is unavailable
echo "ğŸ“ Regenerating GraphQL types and persisted operations (live schema)..."
if ! GRAPHQL_CODEGEN_CONCURRENCY=1 "$PKG" -w client run persist:queries; then
  echo "âš ï¸ Live schema codegen failed; retrying with snapshot (client/schema.graphql)..."
  if ! CODEGEN_SCHEMA=client/schema.graphql GRAPHQL_CODEGEN_CONCURRENCY=1 "$PKG" -w client run persist:queries; then
    echo "âŒ GraphQL codegen/persist failed even with snapshot."
    exit 1
  fi
fi

# 3) Safelist verification (APQ parity)
echo "âœ… Verifying safelist covers all client operations..."
if ! "$PKG" run verify:safelist; then
  echo "âŒ Safelist verification failed."
  exit 1
fi

# 4) Lint (includes .graphql)
echo "ğŸ”§ Linting client to catch raw gql literals and style issues..."
if ! "$PKG" -w client run lint; then
  echo "âŒ Client lint failed."
  exit 1
fi

end_ts=$(date +%s)
echo "âœ… Pre-push checks passed in $((end_ts - start_ts))s"
