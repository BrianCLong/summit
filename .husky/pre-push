#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -euo pipefail

echo "🔍 Running pre-push checks (precodegen → persist:queries → verify:safelist → lint)"

# 1) Precodegen: fail fast on duplicate GraphQL operation names
echo "🧩 Precodegen: checking for duplicate operation names..."
node scripts/find-duplicate-ops.mjs

# 2) Persisted queries + types: ensure artifacts are up to date
echo "📝 Regenerating GraphQL types and persisted operations..."
npm run -w client persist:queries

# 3) Safelist verification (APQ parity)
echo "✅ Verifying safelist covers all client operations..."
npm run verify:safelist

# 4) Lint (includes .graphql via client config)
echo "🔧 Linting client to catch raw gql literals and style errors..."
npm run -w client lint

echo "✅ Pre-push checks passed!"
