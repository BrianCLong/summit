#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -euo pipefail

start_ts=$(date +%s)
repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$repo_root"

echo "🔍 Running pre-push checks (precodegen → persist:queries → verify:safelist → lint)"

# 0) Detect package manager (defaults to npm)
PKG="${PKG:-npm}"

# 1) Precodegen: fail fast on duplicate GraphQL operation names
echo "🧩 Precodegen: checking for duplicate operation names..."
if ! node scripts/find-duplicate-ops.mjs; then
  echo "❌ Duplicate GraphQL operation names detected. Fix and retry."
  exit 1
fi

# 2) Persisted ops + types (pin concurrency) with snapshot fallback when live API is unavailable
echo "📝 Regenerating GraphQL types and persisted operations (live schema)..."
if ! GRAPHQL_CODEGEN_CONCURRENCY=1 "$PKG" -w client run persist:queries; then
  echo "⚠️ Live schema codegen failed; retrying with snapshot (client/schema.graphql)..."
  if ! CODEGEN_SCHEMA=client/schema.graphql GRAPHQL_CODEGEN_CONCURRENCY=1 "$PKG" -w client run persist:queries; then
    echo "❌ GraphQL codegen/persist failed even with snapshot."
    exit 1
  fi
fi

# 3) Safelist verification (APQ parity)
echo "✅ Verifying safelist covers all client operations..."
if ! "$PKG" run verify:safelist; then
  echo "❌ Safelist verification failed."
  exit 1
fi

# 4) Lint (includes .graphql)
echo "🔧 Linting client to catch raw gql literals and style issues..."
if ! "$PKG" -w client run lint; then
  echo "❌ Client lint failed."
  exit 1
fi

end_ts=$(date +%s)
echo "✅ Pre-push checks passed in $((end_ts - start_ts))s"
