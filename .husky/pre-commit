#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ==============================================================================
# Pre-commit hook - FAST checks only (< 5 seconds target)
#
# This hook is designed to be fast. Slow checks (tests, typecheck, screenshots)
# are intentionally NOT run here. Use 'make ci-fast' before pushing.
#
# See docs/dev/DEV_EXPERIENCE_FAST_LANE.md for details.
# ==============================================================================

echo "ğŸ”’ Pre-commit: Running fast checks..."

# 1. Secret scanning (fast - only checks staged files)
# Run gitleaks if available (preferred)
if command -v gitleaks >/dev/null 2>&1; then
  echo "ğŸ” Scanning for secrets..."
  gitleaks protect --staged --verbose || {
    echo "âŒ Secret detected! Remove sensitive data before committing."
    exit 1
  }
# Fallback to custom scanner
elif [ -f "scripts/scan_secrets.py" ]; then
  python3 scripts/scan_secrets.py || {
    echo "âŒ Secrets detected by scanner!"
    exit 1
  }
fi

# 2. Lint-staged (fast - only checks staged files)
echo "ğŸ” Running lint-staged..."
pnpm exec lint-staged || {
  echo "âŒ Lint-staged failed. Run 'make format' to auto-fix."
  exit 1
}

echo "âœ… Pre-commit checks passed!"

# ==============================================================================
# NOTE: Screenshot generation has been moved to CI.
#
# If you need to generate screenshots locally, run:
#   npx tsx server/scripts/generate-screenshots.ts
#
# This change keeps commits fast while ensuring screenshots are still generated
# in the CI pipeline before deployment.
# ==============================================================================
