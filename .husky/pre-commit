#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

LOG_FILE="git-hook.log"

log() {
  echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] $1" >> "$LOG_FILE"
  echo "$1"
}

log "üîí Running pre-commit checks..."

# Run custom secret scanner
log "üîç Running custom secret scanner..."
if [ -f "scripts/scan_secrets.py" ]; then
    python3 scripts/scan_secrets.py || {
      log "‚ùå Secrets detected by custom scanner!"
      exit 1
    }
fi

# Run gitleaks if available
if command -v gitleaks >/dev/null 2>&1; then
  log "üîç Scanning for secrets with gitleaks..."
  gitleaks protect --staged --verbose || {
    log "‚ùå Secret detected by gitleaks!"
    exit 1
  }
fi

# Run lint-staged
log "üîç Running lint-staged..."
pnpm exec lint-staged || {
  log "‚ùå Lint-staged failed."
  exit 1
}

# Run screenshots (robust)
log "üì∏ Generating screenshots..."
CMD="npx tsx server/scripts/generate-screenshots.ts"

# Use timeout if available, otherwise rely on script's internal timeout
if command -v timeout >/dev/null 2>&1; then
  timeout 35s $CMD >> "$LOG_FILE" 2>&1 || log "‚ö†Ô∏è Screenshot generation failed (check logs)"
else
  $CMD >> "$LOG_FILE" 2>&1 || log "‚ö†Ô∏è Screenshot generation failed (check logs)"
fi

log "‚úÖ All checks passed!"
