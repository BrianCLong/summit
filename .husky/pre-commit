LOG_FILE="git-hook.log"

log() {
  echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] $1" >> "$LOG_FILE"
  echo "$1"
}

log "ğŸ”’ Running pre-commit checks..."

# Run gitleaks if available
if command -v gitleaks >/dev/null 2>&1; then
  log "ğŸ” Scanning for secrets with gitleaks..."
  gitleaks protect --staged --verbose --config .gitleaks.toml || {
    log "âŒ Secret detected by gitleaks!"
    exit 1
  }
else
  log "âš ï¸ gitleaks not found. Skipping secret scan."
fi

# Check CJS files don't contain ESM syntax
log "ğŸ” Checking CJS files for ESM syntax..."
node scripts/check-cjs-commonjs.cjs --quiet 2>/dev/null || node scripts/check-cjs-commonjs.cjs || {
  log "âŒ ESM syntax found in .cjs files. Run 'pnpm lint:cjs' for details."
  exit 1
}

# Run lint-staged
# This handles eslint, prettier, and ruff (configured in package.json)
log "ğŸ” Running lint-staged..."
pnpm exec lint-staged || {
  log "âŒ lint-staged failed."
  exit 1
}

log "âœ… All checks passed!"
