#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

LOG_FILE="git-hook.log"

log() {
  echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] $1" >> "$LOG_FILE"
  echo "$1"
}

log "ğŸ”’ Running pre-commit checks (staged files only)..."

log "ğŸ” Running secret scanner..."
if [ -f "scripts/scan_secrets.py" ]; then
  python3 scripts/scan_secrets.py || {
    log "âŒ Secrets detected by custom scanner!"
    exit 1
  }
fi

if command -v gitleaks >/dev/null 2>&1; then
  log "ğŸ” Scanning for secrets with gitleaks..."
  gitleaks protect --staged --verbose || {
    log "âŒ Secret detected by gitleaks!"
    exit 1
  }
else
  log "â„¹ï¸  Skipping gitleaks (not installed)"
fi

log "ğŸ§¹ Running lint-staged..."
if command -v pnpm >/dev/null 2>&1; then
  pnpm lint-staged || {
    log "âŒ Lint-staged failed."
    exit 1
  }
else
  npx lint-staged || {
    log "âŒ Lint-staged failed."
    exit 1
  }
fi

log "âœ… Pre-commit checks completed."
