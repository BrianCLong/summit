#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”’ Running security checks..."

# Run gitleaks to detect secrets
echo "ğŸ” Scanning for secrets..."
if command -v gitleaks &> /dev/null; then
  gitleaks protect --staged --verbose || {
    echo "âŒ Secret detected! Please remove sensitive data before committing."
    exit 1
  }
else
  echo "âš ï¸  Gitleaks not installed. Install with: brew install gitleaks (macOS) or see https://github.com/gitleaks/gitleaks"
fi

# Run security linting on staged files
echo "ğŸ” Running security linting..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "Linting staged files: $STAGED_FILES"
  pnpm exec eslint --config .eslintrc.security.cjs $STAGED_FILES --max-warnings 10 || {
    echo "âŒ Security linting failed. Please fix the issues before committing."
    exit 1
  }
fi

# Run standard linting
echo "ğŸ” Running standard linting..."
pnpm run lint || {
  echo "âŒ Linting failed. Please fix the issues before committing."
  exit 1
}

# Run type checking
echo "ğŸ” Running type checking..."
pnpm run typecheck || {
  echo "âŒ Type checking failed. Please fix the issues before committing."
  exit 1
}

# Run dependency audit (warning only, don't fail)
echo "ğŸ” Running dependency audit..."
pnpm audit --audit-level=high || {
  echo "âš ï¸  High severity vulnerabilities found. Consider addressing them."
}

echo "âœ… All security checks passed!"
