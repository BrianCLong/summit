# Tests

## K6 Rollout Canary Validation

The `tests/k6/rollout-canary.js` scenario generates synthetic traffic that mirrors the
Prometheus guardrails enforced by the Argo Rollouts analysis templates. It sends
requests to both the stable and canary services (or through a routing gateway) and
records success rate, 5xx rate, and p95 latency so CI jobs can halt a rollout if the
canary breaches thresholds.

### Running the scenario

```bash
k6 run tests/k6/rollout-canary.js \
  --env TEST_DURATION=10m \
  --env REQUEST_RATE=40 \
  --env CANARY_TRAFFIC_FRACTION=0.2 \
  --env ROUTER_URL=http://conductor-router.intelgraph.svc.cluster.local \
  --env ROUTER_HEADER=x-rollouts-route \
  --env STABLE_HEADER_VALUE=stable \
  --env CANARY_HEADER_VALUE=canary
```

If you do not have a routing layer, omit the `ROUTER_URL` variables and provide
explicit service URLs instead:

```bash
k6 run tests/k6/rollout-canary.js \
  --env STABLE_URL=http://conductor-active.intelgraph.svc.cluster.local:8000 \
  --env CANARY_URL=http://conductor-preview.intelgraph.svc.cluster.local:8000
```

### Environment variables

| Variable | Description | Default |
| --- | --- | --- |
| `TEST_DURATION` | Total test length. | `5m` |
| `REQUEST_RATE` | Requests per second generated by the scenario. | `20` |
| `VUS` | Pre-allocated virtual users. | `15` |
| `CANARY_TRAFFIC_FRACTION` | Portion of traffic routed to the canary. | `0.1` |
| `REQUEST_PATH` | Path appended to the target service. | `/health` |
| `ROUTER_URL` | Optional gateway URL used with header-based routing. | _unset_ |
| `ROUTER_HEADER` | Header used to direct traffic through the router. | `x-rollouts-route` |
| `STABLE_HEADER_VALUE` | Header value that targets the stable release. | `stable` |
| `CANARY_HEADER_VALUE` | Header value that targets the canary release. | `canary` |
| `STABLE_URL` | Direct URL for the stable service (used when `ROUTER_URL` is unset). | `http://conductor-active:8000` |
| `CANARY_URL` | Direct URL for the canary service (used when `ROUTER_URL` is unset). | `http://conductor-preview:8000` |
| `SLEEP_SECONDS` | Think time between requests. | `1` |

### Metrics and thresholds

The scenario exports the following custom metrics in addition to the built-in K6
HTTP metrics:

- `rollout_canary_success_rate`
- `rollout_canary_error_rate`
- `rollout_canary_latency`
- `rollout_stable_success_rate`
- `rollout_stable_error_rate`
- `rollout_stable_latency`

Thresholds are configured to fail the run when the canary success rate drops below
95%, the 5xx rate rises above 5%, or the p95 latency exceeds 2 seconds, matching the
Argo AnalysisTemplate guardrails. The built-in `http_req_failed` and
`http_req_duration` metrics are also filtered with the `deployment=canary` tag so you
can inspect the canaryâ€™s behavior in dashboards or CI output.

