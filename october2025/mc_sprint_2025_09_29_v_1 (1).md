---
slug: mc-sprint-2025-09-29-v1
version: 1.0.0
owner: Platform Eng • DevSecOps (MC)
date: 2025-09-29
status: Proposed
confidentiality: Internal
---

# MC Sprint Plan — Maestro Conductor (Build/Release Orchestration)

> **Prime directive:** Protect people, data, funds, infra, and brand. Assume breach; minimize blast radius; make every change testable, reversible, and observable.

**Scope anchor:** `/orchestrations/mc/build.yaml`  
**Artifact hash:** `d44e5a5665f6939c9462d4e79bdd43bcee33ff0a784938f808e53370b9a8ff94`  
**Related CI:** `.github/workflows/*` (security, provenance, SBOM, image build)

---

## 0) Executive Summary

We will harden and productize MC (Maestro Conductor) as the single, declarative pipeline for all services. This sprint delivers:

- **Declarative-to-executable bridge** (validated schema + engine adapter) for `BuildPipeline` CRD.
- **Provenance & SBOM gates** enforced **by default** (dev/staging/prod profiles) with cosign verification.
- **Unified security workflow** (reusable Actions) wired to MC stages; findings fail the build with clear remediation.
- **Deterministic artifacts** (digests, attestations) with environment promotion rules.
- **Operator UX**: status dashboard + logs/trace correlation; dry-run + rollback.

**Definition of Done (DOD):** All MC-managed repos build via MC; merges gated on provenance+SBOM, secrets=0 in diff, policy bundle passes; rollback plan documented and tested.

---

## 1) Swimlanes

### A. Orchestration Engine (Owner: Platform Eng)
- Validate and compile `BuildPipeline` (v27) → execution plan.
- Add **profile awareness** (`dev/staging/prod`) from `spec.env` to toggle gates (already hinted in `build.yaml`).
- Implement **fail-fast matrix** with dependency graph (topo sort) + partial retry.

### B. Supply Chain Security (Owner: DevSecOps)
- **Cosign verify** for artifacts & SBOMs before publish.
- **SLSA-aligned provenance** generation + verification step.
- **SBOM generation** (syft/CycloneDX) + policy: disallow CRITICAL vulns unless waived.

### C. CI/CD Integration (Owner: CI Guild)
- Consolidate `.github/workflows` to a single **reusable** entrypoint called by MC.
- Paths-based trigger and concurrency controls; merge-queue compatibility.

### D. Observability (Owner: SRE)
- Structured logs + trace links for each MC step; Grafana panels; Prometheus counters.
- Artifact registry audit dashboard (digests, signatures, provenance status).

### E. Developer Experience (Owner: DX)
- `mc` CLI: validate, render plan, dry-run, scaffold, and open logs.
- Authoring docs and examples; quickstarts per service type (api, gateway, web, nlq).

---

## 2) Sprint Goal & Non-Goals

**Goal:** Ship MC v27.1 as the default path from source to signed, attestable artifacts with mandatory gates and clear rollback.

**Non-goals:** Rewrite individual service builds; change runtime K8s deployment toolchain beyond adding provenance verification in ArgoCD/Helm.

---

## 3) Backlog (User Stories & Acceptance Criteria)

> ID format: `MC-<lane>-<n>`

### A) Orchestration Engine
1. **MC-ORCH-1** — *Schema & validation for BuildPipeline v27.1*
   - **AC:** JSONSchema published; `mc validate` fails on unknown fields; sample pipelines pass.
   - **Artifacts:** `schema/buildpipeline.v27.1.json`, tests.
2. **MC-ORCH-2** — *Planner computes DAG with env profiles*
   - **AC:** Given `dependencies`, engine runs topologically; `fail_fast` honored; retries ≤ 2.
   - **Artifacts:** `pkg/planner/*`, unit tests.
3. **MC-ORCH-3** — *Dev/Staging/Prod feature flags*
   - **AC:** `require_provenance=true` enforced in prod; dev can skip with annotation + waiver record.

### B) Supply Chain Security
4. **MC-SC-1** — *Cosign sign & verify steps standardized*
   - **AC:** All `dist/*` artifacts produce `.sig` & `.pem`; verify gates fail on mismatch; keys are keyless (OIDC).
   - **Artifacts:** Reusable Action `action-cosign-verify@v1`.
5. **MC-SC-2** — *SBOM (syft) + policy gate (grype/CycloneDX)*
   - **AC:** Build fails on CRITICAL/HIGH unless waiver; SBOM uploaded & attested.
   - **Artifacts:** `policy/opa/supplychain.rego`, `actions/sbom-scan@v1`.
6. **MC-SC-3** — *SLSA provenance attest and verify*
   - **AC:** `cosign verify-attestation` passes before release; provenance stored alongside image.

### C) CI/CD Integration
7. **MC-CI-1** — *Reusable workflow consolidation*
   - **AC:** `.github/workflows/ci-main.yml` calls `_reusable-ci-security.yml`; MC invokes via `workflow_call`.
   - **Artifacts:** Updated workflows; docs.
8. **MC-CI-2** — *Merge-queue & paths-filter*
   - **AC:** Only affected packages build; merge queue status reflects MC gates.

### D) Observability
9. **MC-OBS-1** — *Structured logging + trace ids*
   - **AC:** All MC steps emit `trace_id`, `artifact_digest`, `env`; Grafana shows per-run chart.
10. **MC-OBS-2** — *Registry attestation view*
    - **AC:** Dashboard lists images, digests, signature status, SBOM link.

### E) Developer Experience
11. **MC-DX-1** — *`mc` CLI scaffold & validate*
    - **AC:** `mc init` creates `build.yaml` template; `mc validate` checks against schema.
12. **MC-DX-2** — *Docs and examples*
    - **AC:** "Getting Started" page; examples for `api`, `gateway`, `web`, `nlq` using real paths from repo.

---

## 4) Deliverables & Artifacts

- **Spec & Policy**
  - `schema/buildpipeline.v27.1.json`
  - `policy/opa/supplychain.rego`, `policy/waivers.yaml`
- **CI/CD**
  - `.github/workflows/ci-main.yml` (calls `_reusable-ci-security.yml`)
  - `actions/sbom-scan@v1`, `actions/cosign-verify@v1`
- **CLI**
  - `cmd/mc` (Go/Node) + `mc` npm package (if Node) or binary
- **Docs**
  - `/docs/mc/*` including architecture, runbooks, quickstarts
- **Dashboards**
  - Grafana JSON: `dashboards/mc-overview.json`, `dashboards/registry-attest.json`

---

## 5) Scaffolds (proposed new files & templates)

```
/orchestrations/mc/
  build.yaml                      # current (anchored)
  schema/
    buildpipeline.v27.1.json      # strict schema with profiles
  policy/
    supplychain.rego              # OPA gates for SBOM & provenance
    waivers.yaml                  # explicit, time-boxed waivers
  actions/
    sbom-scan/action.yml          # syft + grype + upload-artifact
    cosign-verify/action.yml      # verify .sig & attestation
  cmd/mc/
    main.{go|ts}                  # CLI: validate, plan, render, run
  examples/
    api/build.yaml
    gateway/build.yaml
    web/build.yaml
  docs/
    README.md
    getting-started.md
    authoring-guide.md
```

---

## 6) Risk Register (top 8)

1. **Signature sprawl / trust confusion** — *Mitigation:* keyless OIDC + single trust policy; publish roots; verify in CI and CD.
2. **False positives from scanners** — *Mitigation:* waiver process w/ expiry; allow-list by digest; nightly re-scan job.
3. **Breaking existing teams** — *Mitigation:* staged rollout with advisory-only mode for first week; per-repo opt-in flag.
4. **Long CI times** — *Mitigation:* paths-filter; cached SBOM; parallel jobs by component.
5. **Undocumented failure modes** — *Mitigation:* runbooks, dry-run, and automatic artifact retention with logs.
6. **Policy drift** — *Mitigation:* OPA bundle versioned; policy tests; PR checks.
7. **Missing provenance on legacy images** — *Mitigation:* backfill job; mark as non-promotable until attested.
8. **Registry quota limits** — *Mitigation:* retention policy; daily prune.

---

## 7) DOD, Gates & Rollback

**DOD Checklist**
- [ ] `mc validate` green; schema v27.1.
- [ ] SBOM (CycloneDX) produced and uploaded.
- [ ] Cosign signatures & SLSA provenance verified.
- [ ] OPA supply-chain policy pass; waivers documented.
- [ ] Secrets scanner on diff = 0 findings.
- [ ] Observability dashboards live with sample data.
- [ ] Dry-run + rollback tested on a canary repo.

**Merge Gates (advisory → enforce)**
- Advisory week: warnings only; PR comment bundle.
- Enforce: block until `provenance=verified ∧ sbom=clean ∧ secrets=0 leaks`.

**Rollback Plan**
- Feature flags: `MC_ENFORCE=false` at org level.
- Revert workflows via PR; documented in runbook.
- Keep last-known-good policy bundle; restore within 15 minutes.

---

## 8) Timeline & Cadence (2-week sprint)

- **Day 1–2:** Schema, CLI validate, reusable actions skeleton.
- **Day 3–5:** Gates wired (SBOM, cosign, provenance); policy tests.
- **Day 6–8:** CI consolidation, paths-filter, merge-queue.
- **Day 9–10:** Dashboards, docs, dry-run on 2 services (`services/api`, `services/gateway`).

Ceremonies: daily standup; mid-sprint review (Day 6); demo & retro (Day 10).

---

## 9) Story Pointing & Effort (T-shirt)

- ORCH (M+M+S) ≈ 7 pts
- SC (M+M+M) ≈ 8 pts
- CI (M+S) ≈ 5 pts
- OBS (S+M) ≈ 4 pts
- DX (M+S) ≈ 4 pts
**Total:** ~28 pts (team of 4–5, 2 weeks)

---

## 10) Policy & Test Snippets (ready-to-apply)

### A) OPA: supply-chain policy (CycloneDX severities)
```rego
package supplychain

# Block on CRITICAL/HIGH unless waiver exists and not expired
violation[msg] {
  some finding in input.findings
  sev := finding.severity
  sev == "CRITICAL" or sev == "HIGH"
  not allowed(finding.component.digest)
  msg := sprintf("Blocked: %s %s", [finding.component.name, sev])
}

allowed(digest) {
  some w in input.waivers
  w.digest == digest
  time.now_ns() < time.add_ns(w.created, w.ttl_ns)
}
```

### B) GitHub Actions: cosign verify reusable
```yaml
name: Cosign Verify
on:
  workflow_call:
    inputs:
      artifact_glob:
        required: true
        type: string
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: sigstore/cosign-installer@v3
      - name: Verify
        run: |
          for a in $(ls ${{ inputs.artifact_glob }}); do
            cosign verify-blob \
              --certificate $a.pem \
              --signature $a.sig \
              $a || exit 1
          done
```

### C) Paths filter (build only what changed)
```yaml
jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      gateway: ${{ steps.filter.outputs.gateway }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'services/api/**'
            gateway:
              - 'services/gateway/**'
```

---

## 11) Documentation & Runbooks

- **Getting Started** — authoring `build.yaml`, profiles, waivers.
- **Operator Runbook** — triggering runs, reading logs, promoting artifacts, handling failures.
- **Incident Playbook** — containment (disable tokens, revoke roles), eradication (patch & rebuild), recovery gates.

---

## 12) Owners & Approvals

- Platform Eng (Lead): @owner-platform
- DevSecOps: @owner-sec
- CI Guild: @owner-ci
- SRE: @owner-sre
- DX: @owner-dx

**Approvals required to enforce gates:** Platform Eng Lead, DevSecOps Lead, Release Manager.

---

## 13) Appendix: Evidence & Pointers

- `orchestrations/mc/build.yaml` (v27.0.0) — source of truth for current pipeline.
- `.github/workflows/_reusable-ci-security.yml` — security & provenance steps.
- Example services present: `services/api`, `services/gateway`, `apps/web`, `services/nlq` (SBOM targets in build file).

*Prepared: 2025-09-29 (America/Denver)*



---

## 14) Ticket Seed (importable)

> Create issues quickly by pasting the following into GitHub (YAML frontmatter supported by `gh issue create -F`).

```yaml
# file: .project/tickets/mc-sprint-2025-09-29.yaml
sprint: mc-2025-09-29
board:
  columns:
    - name: Backlog
    - name: Ready
    - name: In Progress
    - name: Review
    - name: Blocked
    - name: Done
issues:
  - id: MC-ORCH-1
    title: BuildPipeline v27.1 schema and validator
    labels: [mc, orchestration, schema, sprint]
    assignees: [owner-platform]
    acceptance:
      - JSONSchema validates examples/api|gateway|web
      - mc validate fails on unknown fields
      - CI job publishes schema artifact
  - id: MC-ORCH-2
    title: Planner DAG with env profiles and fail-fast
    labels: [mc, orchestration]
    assignees: [owner-platform]
    acceptance:
      - topo execution order proven by unit tests
      - fail_fast halts downstream, retries <= 2
  - id: MC-ORCH-3
    title: Env profiles (dev/staging/prod) with feature flags
    labels: [mc, orchestration]
    assignees: [owner-platform]
    acceptance:
      - prod requires provenance; dev can waive with annotation
  - id: MC-SC-1
    title: Cosign sign & verify reusable action
    labels: [mc, supply-chain, cosign]
    assignees: [owner-sec]
    acceptance:
      - signatures + certs uploaded per artifact
      - verify step fails on mismatch
  - id: MC-SC-2
    title: SBOM generation and policy gate (CycloneDX)
    labels: [mc, supply-chain, sbom]
    assignees: [owner-sec]
    acceptance:
      - CRITICAL/HIGH block unless waiver
      - SBOM attached to run artifacts
  - id: MC-SC-3
    title: SLSA provenance attest + verify
    labels: [mc, supply-chain, slsa]
    assignees: [owner-sec]
    acceptance:
      - verify-attestation passes prior to release
  - id: MC-CI-1
    title: Consolidate to reusable workflow with workflow_call
    labels: [mc, ci]
    assignees: [owner-ci]
    acceptance:
      - repos call .github/workflows/_reusable-ci-security.yml
  - id: MC-CI-2
    title: Paths-filter + merge queue status wiring
    labels: [mc, ci]
    assignees: [owner-ci]
    acceptance:
      - only changed packages build; merge queue reports MC gates
  - id: MC-OBS-1
    title: Structured logs + trace correlation
    labels: [mc, observability]
    assignees: [owner-sre]
    acceptance:
      - logs include trace_id, env, artifact_digest
  - id: MC-OBS-2
    title: Registry attestation dashboard
    labels: [mc, observability]
    assignees: [owner-sre]
    acceptance:
      - dashboard lists images, digests, signature status
  - id: MC-DX-1
    title: mc CLI (init, validate, plan, dry-run)
    labels: [mc, developer-experience]
    assignees: [owner-dx]
    acceptance:
      - mc init scaffolds build.yaml; mc validate checks schema
  - id: MC-DX-2
    title: Docs + examples per service type
    labels: [mc, documentation]
    assignees: [owner-dx]
    acceptance:
      - getting-started.md published; examples compile
```

---

## 15) GitHub Project & Swimlanes (automation)

```json
// file: .project/project.json
{
  "name": "MC Sprint 2025-09-29",
  "fields": [
    {"name": "Severity", "type": "single-select", "options": ["P0","P1","P2"]},
    {"name": "Lane", "type": "single-select", "options": ["Orchestration","Supply Chain","CI","Observability","DX"]},
    {"name": "Story Points", "type": "number"}
  ],
  "views": [
    {"type": "board", "groupBy": "Lane", "columns": ["Backlog","Ready","In Progress","Review","Blocked","Done"]}
  ]
}
```

---

## 16) Reusable Workflows (ready to drop in)

```yaml
# file: .github/workflows/_reusable-ci-security.yml
name: Reusable CI + Security
on:
  workflow_call:
    inputs:
      runs:
        required: true
        type: string
      artifact_glob:
        required: true
        type: string
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            any_changed:
              - '**'
  build_and_scan:
    if: needs.prepare.outputs.changed == 'true'
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Build
        run: ${{ inputs.runs }}
      - name: SBOM + Scan
        uses: ./actions/sbom-scan
      - name: Sign artifacts
        run: |
          for a in $(ls ${{ inputs.artifact_glob }}); do
            cosign sign-blob --yes $a
          done
  verify:
    needs: build_and_scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: sigstore/cosign-installer@v3
      - name: Verify signatures & provenance
        run: |
          for a in $(ls ${{ inputs.artifact_glob }}); do
            cosign verify-blob --certificate $a.pem --signature $a.sig $a
          done
```

```yaml
# file: .github/workflows/ci-main.yml
name: CI Main
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  call-reusable:
    uses: ./.github/workflows/_reusable-ci-security.yml
    with:
      runs: 'npm ci && npm run build'
      artifact_glob: 'dist/**/*'
```

---

## 17) OPA Policy & Tests (supply chain)

```rego
# file: policy/opa/supplychain.rego
package supplychain

default allow := false

critical_or_high(f) {
  f.severity == "CRITICAL"; f.fixed_version == ""
} or {
  f.severity == "HIGH"; f.fixed_version == ""
}

violation[msg] {
  some f in input.findings
  critical_or_high(f)
  not waived(f.component.digest)
  msg := sprintf("Blocked: %s %s", [f.component.name, f.severity])
}

waived(d) {
  some w in input.waivers
  w.digest == d
  time.now_ns() < time.add_ns(w.created, w.ttl_ns)
}

allow {
  count(violation) == 0
}
```

```yaml
# file: policy/tests/supplychain_test.yaml
input:
  findings:
    - component: { name: log4j-core, digest: sha256:bad }
      severity: CRITICAL
      fixed_version: ""
  waivers: []
expect:
  allow: false
  violation:
    - "Blocked: log4j-core CRITICAL"
```

---

## 18) ArgoCD/Helm Promotion Gate (verify signatures)

```yaml
# file: helm/overlays/prod/values-verify.yaml
image:
  repository: ghcr.io/acme/service
  tag: "sha256:..."
policy:
  requireSignature: true
  trustRoots:
    - https://fulcio.sigstore.dev
    - https://rekor.sigstore.dev
```

```yaml
# file: helm/templates/verify-provenance.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: verify-provenance
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: cosign
          image: cgr.dev/chainguard/cosign
          args:
            - "verify"
            - "ghcr.io/acme/service@$(IMAGE_DIGEST)"
            - "--certificate-oidc-issuer=https://token.actions.githubusercontent.com"
```

---

## 19) `mc` CLI Skeleton (Go)

```go
// file: cmd/mc/main.go
package main
import (
  "flag"; "fmt"; "os"
)
func main(){
  cmd := flag.String("cmd","validate","validate|plan|dry-run")
  file := flag.String("f","orchestrations/mc/build.yaml","pipeline file")
  flag.Parse()
  switch *cmd {
  case "validate": fmt.Println("valid:", *file)
  case "plan": fmt.Println("plan DAG for", *file)
  case "dry-run": fmt.Println("dry-run", *file)
  default: os.Exit(2)
  }
}
```

---

## 20) PR Comment Bundle (advisory mode)

```md
### MC Gate Report
- Provenance: ✅ Verified
- Signatures: ✅ All artifacts signed
- SBOM: ❌ 1 HIGH (no fix) — *blocking in enforce mode*
- Secrets: ✅ 0 leaks in diff
- Policy: ✅ OPA bundle v1.4.2

<details><summary>Findings</summary>
- pkg X — CVE-2025-XXXX (HIGH) — no fixed version
</details>

**Next:** add waiver in `policy/waivers.yaml` with TTL=7d *or* replace dependency.
```

---

## 21) Incident Playbooks (condensed)

**Containment**
1. Disable CI tokens (GitHub → OIDC only).  
2. Lock artifact promotion: `MC_ENFORCE=true; PROMOTE=false`.  
3. Isolate workloads via NetworkPolicy; scale canary to zero.

**Eradication**
- Patch deps; rebuild; re-generate SBOM; rotate secrets; re-sign.

**Recovery**
- Gradual traffic restore: 1% → 10% → 50% → 100%; monitor SLOs.  
- Post-incident review with evidence packet (logs, digests, attestations).

---

## 22) Verification Matrix

- Unit: planner DAG, schema validator, OPA tests.  
- Policy: `conftest` run on SBOM samples.  
- E2E: canary repo executes full MC with advisory → enforce.  
- SLO: build failure attribution < 2 min; median CI < 12 min.

---

## 23) Comms Plan

- Kickoff note (Slack #eng): goals, gates, rollback.  
- Mid-sprint update (Day 6): progress, risks, waivers.  
- Demo (Day 10): walkthrough + Q&A.  
- Doc links: `/docs/mc/*`.

---

## 24) Versioning & Changelog

- Bump `version: 1.0.1` on first merged artifact.  
- Tag repo `mc-sprint-2025-09-29-v1`.  
- Maintain `CHANGELOG.md` with Added/Changed/Fixed.



---

## 25) Repository Review (evidence-driven)

**Input:** `/mnt/data/summit-main (1).zip` (scanned locally)

**Key artifacts present**
- `orchestrations/mc/build.yaml` — **sha256** `d44e5a5665f6939c9462d4e79bdd43bcee33ff0a784938f808e53370b9a8ff94` (10,139 bytes).
- `.github/workflows/_reusable-ci-security.yml` — **sha256** `185c9d5afe5e81d403dc4c9792199b76c87c52dfbf8a786e65796c6c5101cba1`.
- `.github/workflows/gitleaks.yml` — **sha256** `83ea02954516c9b88c153b3aa0f198f58f8d07fcc86cef3a0c167ea522e37d6d`.
- `SECURITY/policy/trust-policy.yaml` — **sha256** `d3ee914a08ee78fdfaf0f138af52abe80c77072e1640002a7dddd67b0ce9c345`.
- Policies found: `SECURITY/policy/opa/*.rego` (ABAC, export, retention); conftest scaffolds present in salvage branches.
- Helm/ArgoCD overlays and numerous Grafana dashboards exist in archives/salvage paths.

**Gaps** (vs. Sprint Goals)
- Cosign **verify** job not enforced in active `_reusable-ci-security.yml` (cosign appears in archived/salvage branches only).
- No SLSA **provenance verification** step wired before release.
- SBOM produced by CycloneDX is present in workflow, but **policy gate** (OPA/waiver TTL) not enforced.
- Trust policy exists but is **not referenced** by CI/CD.
- Grafana dashboards exist, but no **MC-specific** dashboard JSON committed in active tree.

**Action:** The PR diffs below implement these missing links minimally and reversibly.

---

## 26) Ready-to-Commit PR Diffs (minimal, auditable)

> Apply as a single PR `feat(mc): enforce supply-chain gates + mc bootstrap`.

### A) `_reusable-ci-security.yml` — add SBOM gate, cosign verify, provenance
```diff
 name: CI Security
 on:
   workflow_call:
 
 permissions:
   contents: read
+  id-token: write
 
 jobs:
   security:
     name: Security and provenance checks
     runs-on: ubuntu-latest
     permissions:
-      contents: read
+      contents: read
+      id-token: write
     steps:
       - name: Checkout
         uses: actions/checkout@v4
@@
       - name: CycloneDX SBOM
         run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json
 
       - name: Upload SBOM
         uses: actions/upload-artifact@v4
         with:
           name: sbom
           path: sbom.json
+
+      - name: OPA Supply-chain Policy (SBOM gate)
+        uses: open-policy-agent/conftest-action@v1
+        with:
+          files: sbom.json
+          policy: SECURITY/policy/opa
+          quiet: true
+
+      - name: Install cosign
+        uses: sigstore/cosign-installer@v3
+
+      - name: Sign dist artifacts (keyless)
+        if: ${{ hashFiles('dist/**/*') != '' }}
+        run: |
+          for a in $(ls dist/**/* 2>/dev/null || true); do
+            cosign sign-blob --yes "$a"
+          done
+
+      - name: Verify signatures (gate)
+        if: ${{ hashFiles('dist/**/*') != '' }}
+        run: |
+          for a in $(ls dist/**/* 2>/dev/null || true); do
+            cosign verify-blob --certificate "$a.pem" --signature "$a.sig" "$a"
+          done
+
+      - name: Verify SLSA provenance (gate)
+        if: ${{ env.IMAGE_DIGEST != '' }}
+        run: |
+          cosign verify-attestation ghcr.io/${{ github.repository }}@${IMAGE_DIGEST} \
+            --certificate-oidc-issuer=https://token.actions.githubusercontent.com
```

### B) New: `policy/opa/supplychain.rego` (CycloneDX gate)
```diff
+package supplychain
+
+default allow := false
+
+critical(f) { f.severity == "CRITICAL" }
+high(f)     { f.severity == "HIGH" }
+
+blocked[msg] {
+  some f in input.findings
+  (critical(f) or high(f))
+  not waived(f.component.digest)
+  msg := sprintf("Blocked: %s %s", [f.component.name, f.severity])
+}
+
+waived(d) {
+  some w in input.waivers
+  w.digest == d
+  time.now_ns() < time.add_ns(w.created, w.ttl_ns)
+}
+
+allow { count(blocked) == 0 }
```

### C) New: `policy/waivers.yaml`
```yaml
waivers:
  - digest: sha256:REPLACE_ME
    reason: temporary unblock for X
    created: 2025-09-29T00:00:00Z
    ttl_ns: 604800000000000   # 7d
```

### D) New: `.github/workflows/release-verify.yml` (CD gate)
```yaml
name: Release Verify
on:
  workflow_dispatch:
    inputs:
      image_digest: { description: 'ghcr image digest', required: true }
jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: sigstore/cosign-installer@v3
      - name: Verify signature & provenance
        run: |
          export IMAGE="ghcr.io/${{ github.repository }}@${{ inputs.image_digest }}"
          cosign verify "$IMAGE" --certificate-oidc-issuer=https://token.actions.githubusercontent.com
          cosign verify-attestation "$IMAGE" --certificate-oidc-issuer=https://token.actions.githubusercontent.com
```

---

## 27) CODEOWNERS & Merge Settings

```gitignore
# file: .github/CODEOWNERS
/orchestrations/mc/ @owner-platform @owner-sec
/SECURITY/policy/** @owner-sec
/.github/workflows/** @owner-ci @owner-sec
/docs/mc/** @owner-dx
```

```yaml
# file: .github/merge_queue.yml
require_status_checks:
  - CI Main
  - CI Security
  - Release Verify
max_parallel: 2
``` 

---

## 28) Freeze Windows & Change Management

```yaml
# file: .github/freeze-windows.yml
windows:
  - name: EOM Accounting Freeze
    from: '2025-09-29T00:00:00Z'
    to:   '2025-09-30T23:59:59Z'
    applies_to: [prod]
```

```yaml
# file: .github/workflows/freeze-check.yml
name: Freeze Check
on: [pull_request]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msickel/freeze-window-action@v2
        with:
          config: .github/freeze-windows.yml
```

---

## 29) DLP/Redaction & Step-Up Auth Hooks

```yaml
# file: .github/workflows/dlp-redaction.yml
name: DLP Redaction
on: [pull_request]
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: zricethezav/gitleaks-action@v2
      - name: Require WebAuthn step-up for high-risk changes
        if: contains(github.event.pull_request.changed_files, 'SECURITY/')
        run: echo "Require security approver with WebAuthn (manual policy)"
```

---

## 30) Conftest Harness (policy tests)

```yaml
# file: policy/conftest.yaml
namespaces:
  - supplychain
```

```bash
# file: policy/test.sh
set -euo pipefail
conftest test --policy policy/opa sbom_samples/*.json
```

---

## 31) Observability: Dashboard & Alerts (stubs)

```json
// file: dashboards/mc-overview.json
{ "title": "MC Overview", "panels": [
  {"type":"stat","title":"Runs","targets":[{"expr":"sum(mc_runs_total)"}]},
  {"type":"graph","title":"Gate Failures","targets":[{"expr":"rate(mc_gate_failures_total[5m])"}]},
  {"type":"table","title":"Artifacts","targets":[{"expr":"mc_artifact_signed{env=~\".*\"}"}]}
]}
```

```yaml
# file: alerts/mc-rules.yaml
groups:
  - name: mc
    rules:
      - alert: MCGateFailureSpike
        expr: rate(mc_gate_failures_total[10m]) > 0.5
        for: 10m
        labels: { severity: page }
        annotations: { summary: "MC gate failures spiking" }
```

---

## 32) Test Scaffolds (k6 + Playwright)

```js
// file: tests/perf/k6-smoke.js
import http from 'k6/http';
import { sleep } from 'k6';
export const options = { vus: 5, duration: '1m' };
export default function () { http.get(__ENV.TARGET || 'https://example.org'); sleep(1); }
```

```ts
// file: tests/smoke/playwright.spec.ts
import { test, expect } from '@playwright/test';
 test('homepage', async ({ page }) => { await page.goto('/'); await expect(page).toHaveTitle(/./); });
```

---

## 33) RACI & Approvals

| Activity | R | A | C | I |
|---|---|---|---|---|
| Policy changes (OPA) | DevSecOps | CISO | Platform, CI | All devs |
| Workflow gates | CI Guild | DevSecOps Lead | Platform | SRE |
| Release verification | Platform | Release Mgr | DevSecOps | Exec |

Approval checklist lives in PR template.

```md
<!-- file: .github/pull_request_template.md -->
- [ ] Gates: provenance, signatures, SBOM policy ✅
- [ ] Rollback plan documented ✅
- [ ] Owners approved (CODEOWNERS) ✅
```

---

## 34) Secret Scanning & Baseline

```toml
# file: .gitleaks.toml
[allowlist]
  regexTarget = "match"
  description = "Test keys"
  regexes = ["^TEST_KEY_"]
```

---

## 35) Waiver Template & TTL Enforcement

```md
<!-- file: policy/WAIVER_TEMPLATE.md -->
- Digest: sha256:...
- Reason: 
- Owner: 
- Created: 2025-09-29
- TTL: 7d
```

---

## 36) ArgoCD Hook (verify before sync)

```yaml
# file: argo/hooks/verify-provenance.yaml
apiVersion: batch/v1
kind: Job
metadata: { name: verify-provenance, annotations: { "argocd.argoproj.io/hook": PreSync } }
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: cosign
          image: cgr.dev/chainguard/cosign
          args: ["verify", "$(IMAGE)", "--certificate-oidc-issuer=https://token.actions.githubusercontent.com"]
```

---

## 37) Sprint Close Evidence Pack

- Attach: workflow run URLs, artifact digests, signature verification logs, OPA test outputs, dashboard screenshots.
- Store under: `docs/mc/evidence/2025-09-29/`.

