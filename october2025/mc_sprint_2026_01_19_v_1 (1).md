---
slug: mc-sprint-2026-01-19-v1
version: 1.0.0
date: 2026-01-19
status: Proposed
owner: Platform Eng • DevSecOps (MC)
confidentiality: Internal
---

# MC Sprint Plan — v28.1 Zero‑Trust Deploys & Provenance Graph

> Theme: **End‑to‑end zero trust from CI → CD → runtime, with explorable provenance/lineage.** Tighten deploy‑time authZ, lock egress, enrich attestations, and stand up a queryable graph for audits and incident response.

**Scope anchor:** `/orchestrations/mc`  
**Prereqs:** v28.0 unified policy bundle pinned; OIDC‑only & hermetic pilot complete  
**Timebox:** 2 weeks (Jan 19–Jan 30, 2026, America/Denver)

---

## 0) Retro Snapshot (from 2026‑01‑05)

- ✅ Bundle v28.0 pinned; OIDC‑only in CI; linter catching unpinned actions.
- ⚠️ Hermetic builds green for 1 service; 2nd service needs proxy for toolchain fetch.
- ❌ No runtime ABAC yet; provenance data siloed in logs/artifacts (not queryable).

---

## 1) Sprint Goals (Outcomes)

1. **Zero‑trust deploys**: runtime admission evaluates **identity, repo, env, digest, provenance** (deny by default).
2. **Egress controls**: per‑namespace/tenant allow‑lists applied and observable.
3. **Provenance graph**: ingest SBOM + attestations + gate results into **Neo4j**, with queries and dashboards.
4. **Attestation enrichment**: include build inputs (pinned versions), hermetic flag, policy bundle version, waiver refs.
5. **Operator tooling**: `mc graph` CLI to answer _“why is this in prod?”_ in ≤ 5 seconds.

---

## 2) Swimlanes

### A) Runtime ABAC & Admission (Owner: SRE + DevSecOps)

- Gatekeeper/Kyverno policy: **subject (OIDC claim) ↔ repo ↔ env** mapping; verify digest & provenance; honor waiver TTL.

### B) Network/Egress Controls (Owner: Platform)

- Namespace NetworkPolicies and egress proxies; allow‑lists per tenant; CI/CD to push labels to cluster.

### C) Provenance & Lineage Graph (Owner: CI Guild + Data/Graph)

- Ingest CycloneDX SBOMs, cosign attestations, gate results → Neo4j; build queries and a minimal UI.

### D) Attestation Enrichment (Owner: DevSecOps)

- Extend SLSA attestation payload with policy bundle version, hermetic flag, waiver digests.

### E) Developer Experience (Owner: DX)

- `mc graph` commands; PR comment deep links; authoring guide for ABAC annotations.

---

## 3) User Stories & Acceptance Criteria

> ID: `MC9-<lane>-<n>`

### Runtime ABAC & Admission

1. **MC9-RUN-1** — _ABAC at admission_
   - **AC:** Deploy denied unless OIDC subject ∧ repo ∧ env match policy; image digest verified; provenance present.
2. **MC9-RUN-2** — _Waiver TTL enforced_
   - **AC:** Expired waiver → deny; event records digest, rule, owner.

### Network/Egress Controls

3. **MC9-NET-1** — _Per‑tenant egress allow‑list_
   - **AC:** Only allow to ghcr.io, GitHub APIs, and declared deps; violations alert; exceptions via waiver with TTL.

### Provenance & Lineage Graph

4. **MC9-GRAPH-1** — _Ingest pipeline → Neo4j_
   - **AC:** Given an image digest, query returns: repo@commit, PR, artifacts, SBOM top deps, waivers, policy bundle.
5. **MC9-GRAPH-2** — _UI/Dashboard_
   - **AC:** Panel shows path to prod; time to promote; gate failures by rule; link back to runs.

### Attestation Enrichment

6. **MC9-ATT-1** — _Extended fields_
   - **AC:** Attestations include `bundle_version`, `hermetic`, `waiver_ids[]`; verified by cosign.

### Developer Experience

7. **MC9-DX-1** — _`mc graph why`_
   - **AC:** `mc graph why ghcr.io/org/app@sha256:...` prints lineage in ≤ 5s; links to PR and evidence pack.

---

## 4) Deliverables & Artifacts

- Policies: `k8s/policy/abac-verify.yaml`, `k8s/policy/egress-allowlist.yaml`.
- Graph: `graph/ingest/*` (ETL), `dashboards/mc-lineage.json`.
- CLI: `cmd/mc/graph/*` with `why`, `deps`, `owners`.
- Attestation schema extension: `policy/slsa/extensions/v28.1.json`.
- Runbooks: ABAC rollout + rollback, egress waivers, graph troubleshooting.

---

## 5) Scaffolds & Snippets

### A) Kyverno ABAC + Provenance Verify

```yaml
# file: k8s/policy/abac-verify.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata: { name: abac-verify }
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: enforce-abac-provenance
      match: { resources: { kinds: [Deployment, StatefulSet, Job] } }
      context:
        - name: repo
          variable:
            jmesPath: "request.object.metadata.labels['mc.repo']"
        - name: env
          variable:
            jmesPath: "request.object.metadata.labels['mc.env']"
      verifyImages:
        - imageReferences: ['ghcr.io/org/*']
          verifyDigest: true
          required: true
          attestations:
            - type: https://slsa.dev/attestation/v1
              conditions:
                - all:
                    - key: 'bundle_version'
                      operator: Equals
                      value: 'v28.0'
```

### B) Namespace Egress Allow‑list

```yaml
# file: k8s/policy/egress-allowlist.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: egress-allowlist
  namespace: tenant-a
spec:
  podSelector: {}
  policyTypes: [Egress]
  egress:
    - to:
        [
          {
            namespaceSelector:
              { matchLabels: { kubernetes.io/metadata.name: kube-system } },
          },
        ]
      ports: [{ protocol: TCP, port: 443 }]
    - to:
        - ipBlock: { cidr: 140.82.0.0/16 } # GitHub
        - ipBlock: { cidr: 140.82.121.33/32 } # ghcr.io (example)
      ports: [{ protocol: TCP, port: 443 }]
```

### C) Attestation Extension (example payload)

```json
// file: policy/slsa/extensions/v28.1.json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "bundle_version": { "type": "string" },
    "hermetic": { "type": "boolean" },
    "waiver_ids": { "type": "array", "items": { "type": "string" } }
  },
  "required": ["bundle_version"]
}
```

### D) Ingest to Neo4j (Node/TS)

```ts
// file: graph/ingest/ingest.ts
import neo4j from 'neo4j-driver';
import fs from 'node:fs';
const drv = neo4j.driver(
  process.env.NEO4J_URI!,
  neo4j.auth.basic(process.env.NEO4J_USER!, process.env.NEO4J_PASS!),
);
const sbom = JSON.parse(fs.readFileSync('sbom.json', 'utf8'));
const att = JSON.parse(fs.readFileSync('attestation.json', 'utf8'));
const session = drv.session();
await session.executeWrite(async (tx) => {
  await tx.run('MERGE (i:Image {digest:$d}) SET i.bundle=$b, i.hermetic=$h', {
    d: att.subject,
    b: att.bundle_version,
    h: !!att.hermetic,
  });
  for (const c of sbom.components || []) {
    await tx.run(
      'MERGE (p:Package {purl:$p}) MERGE (p)-[:IN]->(:SBOM {digest:$d})',
      { p: c.purl, d: att.subject },
    );
  }
});
await session.close();
await drv.close();
```

### E) `mc graph why` (CLI skeleton)

```ts
// file: cmd/mc/graph/why.ts
import neo4j from 'neo4j-driver';
export default async function why(digest: string) {
  const d = neo4j.driver(
    process.env.NEO4J_URI!,
    neo4j.auth.basic(process.env.NEO4J_USER!, process.env.NEO4J_PASS!),
  );
  const s = d.session();
  const q = `MATCH (i:Image {digest:$d})<-[:BUILT]-(r:Run)-[:FROM]->(c:Commit)<-[:MERGED]-(p:PR)
             RETURN p.number as pr, c.sha as sha LIMIT 1`;
  const res = await s.run(q, { d: digest });
  console.log({
    pr: res.records[0]?.get('pr'),
    sha: res.records[0]?.get('sha'),
  });
  await s.close();
  await d.close();
}
```

### F) Actionlint + Unpinned Actions Gate (reuse from v28.0, enforce)

```yaml
# file: .github/workflows/actionlint.yml
name: Actionlint
on: [pull_request]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/actionlint@v1
      - name: Enforce pinned actions
        run: |
          if grep -R "uses: .*@main" -n .github/workflows; then echo "Unpinned actions" && exit 1; fi
```

---

## 6) Observability & Dashboards

```json
// file: dashboards/mc-lineage.json
{
  "title": "MC Lineage & Deploy Trust",
  "panels": [
    {
      "type": "stat",
      "title": "Denied Deploys (ABAC)",
      "targets": [{ "expr": "increase(mc_admission_denied_abac_total[1d])" }]
    },
    {
      "type": "graph",
      "title": "Egress Violations",
      "targets": [{ "expr": "rate(mc_egress_violations_total[1h])" }]
    },
    {
      "type": "table",
      "title": "Why is it in prod?",
      "targets": [{ "expr": "mc_lineage_paths" }]
    }
  ]
}
```

---

## 7) Risks & Mitigations

1. **Over‑blocking at admission** — start in `Audit` for 48h; canary namespaces; explicit rollback; owner approvals.
2. **Egress false positives** — begin with observability only; iterate allow‑lists; provide emergency waiver TTL ≤ 2h.
3. **Graph scale/cost** — aggregate high‑cardinality data; TTL for raw run nodes; nightly compaction.
4. **Attestation schema drift** — version the extension; verify at gates; reject unknown fields in prod.

---

## 8) DOD, Gates & Rollback

**DOD**

- [ ] Admission ABAC enforced (or Audit→Enforce) with evidence.
- [ ] Egress policies active; violations observable; exceptions tracked.
- [ ] Neo4j lineage populated; `mc graph why` returns PR+commit in ≤ 5s.
- [ ] Attestations enriched and verified.
- [ ] Runbooks published.

**Rollback**

- Set `validationFailureAction: Audit`; remove egress policy from non‑critical namespaces; disable graph ingest job.

---

## 9) Timeline & Capacity (2 weeks)

- **D1–D2:** ABAC policy in Audit; egress allow‑lists as observability.
- **D3–D5:** Enrich attestation; build ingest; stand up Neo4j.
- **D6–D8:** Enforce ABAC on canary; rollout egress; CLI `why`.
- **D9–D10:** Dashboards, docs, demo & retro.

**Estimate:** 27–31 pts across Platform, Sec, CI, SRE, DX.

---

## 10) Ticket Seed (importable)

```yaml
# file: .project/tickets/mc-sprint-2026-01-19.yaml
sprint: mc-2026-01-19
board:
  columns: [Backlog, Ready, In Progress, Review, Blocked, Done]
issues:
  - id: MC9-RUN-1
    title: Enforce ABAC + provenance at admission
    labels: [mc, runtime, policy]
    assignees: [owner-sre, owner-sec]
    points: 8
  - id: MC9-NET-1
    title: Per-tenant egress allow-lists
    labels: [mc, network]
    assignees: [owner-platform]
    points: 5
  - id: MC9-GRAPH-1
    title: Provenance/lineage ingest → Neo4j
    labels: [mc, data, graph]
    assignees: [owner-ci]
    points: 6
  - id: MC9-ATT-1
    title: Enrich SLSA attestations (v28.1)
    labels: [mc, supply-chain]
    assignees: [owner-sec]
    points: 3
  - id: MC9-DX-1
    title: mc graph why/deps/owners
    labels: [mc, dx]
    assignees: [owner-dx]
    points: 3
```

---

## 11) Evidence & Reporting

- KPIs: admission denials (true vs. false positive), egress violations, lineage query latency, enriched attestation coverage.
- Artifacts: policy CRs, ingest logs, Neo4j dump, CLI outputs, dashboard screenshots.
- Store under `docs/mc/evidence/2026-01-19/`.

---

## 12) Changelog

- **Added:** ABAC admission; egress allow‑lists; provenance graph; attestation enrichment; `mc graph` CLI.
- **Changed:** Deploy trust is evaluated end‑to‑end; dashboards expose lineage.
- **Fixed:** Lack of queryable provenance and permissive runtime authZ.
