---
slug: mc-sprint-2025-10-27-v1
version: 1.0.0
date: 2025-10-27
status: Proposed
owner: Platform Eng • DevSecOps (MC)
confidentiality: Internal
---

# MC Sprint Plan — v27.3 Hardening & Runtime Gates

> Theme: **From CI gates to runtime guarantees.** Tighten promotion controls, admission policies, and drift detection. Continue org-wide adoption to 95% and optimize build latency.

**Scope anchor:** `/orchestrations/mc`  
**Prereqs:** `mc-sprint-2025-10-13-v1` complete or in enforce for prod  
**Timebox:** 2 weeks (Oct 27–Nov 7, 2025, America/Denver)

---

## 0) Retro Snapshot (from 2025‑10‑13)

- ✅ Enforcement toggled for prod; waiver TTL checks landed; backfill report shipped.
- ⚠️Partial: adoption at ~84%; dashboards v2 live but missing P95 build latency.
- ❌Not done: Argo PreSync verify in all apps; promotion block for non‑attestable legacy images in Helm.

**Carry‑over risks:** false positives causing friction; legacy repos without CODEOWNERS; monorepo CI duration.

---

## 1) Sprint Goals (Outcomes)

1. **Adoption ≥ 95%** of active repos on MC reusable workflow (measured by CI runs this sprint).
2. **Runtime admission**: cluster‑level policy blocks unsigned/unattested images.
3. **Promotion control**: ArgoCD PreSync verify across 100% prod apps.
4. **Latency**: median CI ≤ 10 min for top 5 repos; P95 ≤ 18 min (measured weekly).
5. **Drift detection**: detect & alert when runtime image digest ≠ last verified digest.

---

## 2) Swimlanes

### A) Runtime Policy & Admission (Owner: SRE + DevSecOps)

- Deploy Sigstore/cosign policy-controller or Kyverno/OPA Gatekeeper policies.
- Admission blocks: unsigned images, missing SLSA provenance, stale waivers.

### B) CD Enforcement (Owner: Platform)

- Argo PreSync verify job standardized; required in all prod apps.
- Promotion labels: `promotable=true` only if verify passes.

### C) CI Latency & Scale (Owner: CI Guild)

- Paths-filter refinement; test shard; cache correctness & warmers; SBOM diffing.

### D) Observability v3 (Owner: SRE)

- Add build latency panels (p50/p95), adoption %, drift alerts, waiver expiry burndown.

### E) Developer Experience v3 (Owner: DX)

- `mc` CLI: `promote`, `scoreboard` (adoption/latency), `open-run`.

---

## 3) User Stories & Acceptance Criteria

> ID format: `MC3-<lane>-<n>`

### Runtime Policy & Admission

1. **MC3-RUN-1** — _Admission: verify signatures & provenance_
   - **AC:** Unsigned or unverifiable images are denied in clusters `prod-*`.
   - **Artifacts:** `k8s/policy/cosign-policy.yaml` (or Kyverno rules), runbook with rollback.
2. **MC3-RUN-2** — _Waiver TTL respected at admission_
   - **AC:** Expired waiver → deny deploy; event logged with component digest & owner.

### CD Enforcement

3. **MC3-CD-1** — _Argo PreSync verify enforced org-wide_
   - **AC:** All prod apps include `argo/hooks/verify-provenance.yaml`; sync fails on verify error.
4. **MC3-CD-2** — _Promotion labels_
   - **AC:** Only images labeled `promotable=true` in registry can be deployed in prod.

### CI Latency & Scale

5. **MC3-CI-1** — _Sharded tests + cache warmer_
   - **AC:** p50 CI time reduced by 15% on `services/api`, `services/gateway`.
6. **MC3-CI-2** — _SBOM diffing_
   - **AC:** No-resolved-diff runs skip full scan; still enforce policy on new/changed components.

### Observability v3

7. **MC3-OBS-1** — _Drift detection & alert_
   - **AC:** Alert fires when deployed digest ≠ last MC-verified digest for 10m.
8. **MC3-OBS-2** — _Latency dashboards_
   - **AC:** Grafana shows p50/p95 CI durations and gate failure rates per repo.

### Developer Experience v3

9. **MC3-DX-1** — _CLI: promote & scoreboard_
   - **AC:** `mc promote --digest <sha>` verifies + sets label; `mc scoreboard` prints adoption and latency table.

---

## 4) Deliverables & Artifacts

- `k8s/policy/cosign-policy.yaml` or `k8s/policy/kyverno-verify.yaml` (choose per cluster).
- `argo/hooks/verify-provenance.yaml` rolled to all prod apps.
- `.github/workflows/cache-warmer.yml`, test sharding in top repos.
- `dashboards/mc-overview-v3.json`, `alerts/mc-rules-v3.yaml`.
- `cmd/mc` updates: promote, scoreboard, open-run.
- Evidence: `docs/mc/evidence/2025-10-27/*.md`.

---

## 5) Scaffolds, Policies & Snippets

### A) Kyverno policy (verify image signatures + provenance)

```yaml
# file: k8s/policy/kyverno-verify.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-signature-and-provenance
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: verify-signature
      match:
        {
          resources:
            { kinds: [Pod, Deployment, StatefulSet, DaemonSet, Job, CronJob] },
        }
      verifyImages:
        - imageReferences:
            - 'ghcr.io/acme/*'
          attestations:
            - type: https://slsa.dev/attestation/v1
          verifyDigest: true
          required: true
          authorities:
            - keyless:
                issuer: 'https://token.actions.githubusercontent.com'
                subjectRegExp: '.*'
```

### B) Argo PreSync verify (standardized)

```yaml
# file: argo/hooks/verify-provenance.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: verify-provenance
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: verifier
      containers:
        - name: cosign
          image: cgr.dev/chainguard/cosign
          args:
            - 'verify'
            - '$(IMAGE)'
            - '--certificate-oidc-issuer=https://token.actions.githubusercontent.com'
```

### C) Registry labeler (promotable=true)

```bash
# file: scripts/label-promotable.sh
set -euo pipefail
IMG="$1" # ghcr.io/org/repo@sha256:...
cosign verify "$IMG" --certificate-oidc-issuer=https://token.actions.githubusercontent.com
cosign verify-attestation "$IMG" --certificate-oidc-issuer=https://token.actions.githubusercontent.com
# label via ghcr API (placeholder; implement with gh api)
echo "labeled $IMG promotable=true"
```

### D) CI cache warmer (Node example)

```yaml
# file: .github/workflows/cache-warmer.yml
name: Cache Warmer
on:
  schedule: [{ cron: '0 */6 * * *' }]
jobs:
  warm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '22', cache: 'npm' }
      - run: npm ci --prefer-offline --no-audit --no-fund
```

### E) Test sharding (Playwright)

```yaml
# file: .github/workflows/ci-main.yml
jobs:
  tests:
    strategy:
      fail-fast: false
      matrix: { shard: [1, 2, 3, 4] }
    steps:
      - uses: actions/checkout@v4
      - run: npx playwright test --shard=${{ matrix.shard }}/4
```

### F) SBOM diffing (CycloneDX CLI)

```bash
# file: scripts/sbom-diff.sh
set -euo pipefail
OLD=${1:-sbom-prev.json}
NEW=${2:-sbom.json}
cyclonedx diff --input-files "$OLD" "$NEW" --format json > sbom-diff.json
jq '.differences | length' sbom-diff.json | grep -q '^0$' && echo "NO_DIFF" || echo "DIFF"
```

---

## 6) Observability v3 (dashboards & alerts)

```json
// file: dashboards/mc-overview-v3.json
{
  "title": "MC Overview v3",
  "panels": [
    {
      "type": "stat",
      "title": "Adoption %",
      "targets": [{ "expr": "100 * mc_repos_adopted / mc_repos_total" }]
    },
    {
      "type": "graph",
      "title": "CI Duration p50",
      "targets": [
        {
          "expr": "histogram_quantile(0.5, sum(rate(mc_ci_duration_seconds_bucket[5m])) by (le))"
        }
      ]
    },
    {
      "type": "graph",
      "title": "CI Duration p95",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(mc_ci_duration_seconds_bucket[5m])) by (le))"
        }
      ]
    },
    {
      "type": "graph",
      "title": "Gate Failures",
      "targets": [{ "expr": "rate(mc_gate_failures_total[10m])" }]
    },
    {
      "type": "table",
      "title": "Drift",
      "targets": [{ "expr": "mc_runtime_drift{env=\"prod\"}" }]
    }
  ]
}
```

```yaml
# file: alerts/mc-rules-v3.yaml
groups:
  - name: mc
    rules:
      - alert: MCAdoptionBelowTarget
        expr: (mc_repos_adopted / mc_repos_total) < 0.95
        for: 1h
        labels: { severity: ticket }
        annotations: { summary: 'MC adoption <95%' }
      - alert: MCRuntimeDrift
        expr: mc_runtime_drift{env="prod"} > 0
        for: 10m
        labels: { severity: page }
        annotations: { summary: 'Runtime digest drift detected' }
```

---

## 7) CLI Enhancements (Go)

```go
// file: cmd/mc/promote.go
package main
import "fmt"
func promote(digest string) error { fmt.Println("verifying & labeling:", digest); return nil }
```

```go
// file: cmd/mc/scoreboard.go
package main
import "fmt"
func scoreboard() { fmt.Println("adoption, latency table") }
```

---

## 8) Risks & Mitigations (v3)

1. **Admission outage** — _Mitigation:_ start in `Audit` mode; canary namespace; rollback plan; owner approvals.
2. **Argo hook failures block deploys** — _Mitigation:_ PreSync with retry + clear events; bypass doc for SEV‑1 only.
3. **CI flakiness from sharding** — _Mitigation:_ seed stable; retry policy; flaky test quarantine.
4. **Developer friction** — _Mitigation:_ office hours; self‑service waivers with TTL; fast feedback via `mc scoreboard`.

---

## 9) DOD, Gates & Rollback

**DOD**

- [ ] 95% adoption reached.
- [ ] Admission policy enforced in prod clusters (or Audit→Enforce with evidence).
- [ ] Argo PreSync verify present in all prod apps.
- [ ] CI latency targets met for top repos.
- [ ] Drift alerts tested.

**Rollback**

- Admission: switch `validationFailureAction: Audit`; delete policy CR if needed.
- Argo: annotate app `argocd.argoproj.io/sync-options: SkipHooksOnFailure=true` temporarily.
- CI: disable sharding; revert cache-warmer via PR.

---

## 10) Timeline & Capacity (2 weeks)

- **D1–D2:** Admission policy (Audit) + Argo hook template; CLI stubs.
- **D3–D5:** Enforce in one prod cluster; rollout to all apps; start cache warmer.
- **D6–D8:** Shard tests; SBOM diffing; drift detector wiring.
- **D9–D10:** Metrics review; adoption push; demo & retro.

**Estimate:** 28–32 pts across Platform, Sec, CI, SRE, DX.

---

## 11) Ticket Seed (importable)

```yaml
# file: .project/tickets/mc-sprint-2025-10-27.yaml
sprint: mc-2025-10-27
board:
  columns: [Backlog, Ready, In Progress, Review, Blocked, Done]
issues:
  - id: MC3-RUN-1
    title: Enforce signature & provenance at admission
    labels: [mc, runtime, policy]
    assignees: [owner-sre, owner-sec]
    points: 8
  - id: MC3-RUN-2
    title: Waiver TTL enforcement at admission
    labels: [mc, runtime, policy]
    assignees: [owner-sec]
    points: 3
  - id: MC3-CD-1
    title: Argo PreSync verify across prod apps
    labels: [mc, cd]
    assignees: [owner-platform]
    points: 5
  - id: MC3-CD-2
    title: Registry promotable label flow
    labels: [mc, cd]
    assignees: [owner-ci]
    points: 3
  - id: MC3-CI-1
    title: Sharded tests + cache warmer
    labels: [mc, ci, perf]
    assignees: [owner-ci]
    points: 5
  - id: MC3-CI-2
    title: SBOM diffing path
    labels: [mc, supply-chain]
    assignees: [owner-sec]
    points: 3
  - id: MC3-OBS-1
    title: Drift detection + alerts
    labels: [mc, observability]
    assignees: [owner-sre]
    points: 3
  - id: MC3-DX-1
    title: mc CLI promote + scoreboard
    labels: [mc, developer-experience]
    assignees: [owner-dx]
    points: 2
```

---

## 12) Evidence & Reporting

- KPIs: adoption %, admission denials count (legit vs false-positive), p50/p95 CI duration, drift incidents.
- Artifacts: policy CRs, Argo app diffs, CI timing exports, alert screenshots.
- Store under `docs/mc/evidence/2025-10-27/`.

---

## 13) Changelog

- **Added:** Admission policies; Argo PreSync verify everywhere; drift detection.
- **Changed:** CI perf via sharding + cache warmer; SBOM diffing path.
- **Fixed:** Promotion of non‑attestable images.
