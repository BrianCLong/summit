```md
# Maestro Conductor (MC) — Sprint Plan *(v1.0.0)*

**Slug:** `mc-sprint-2025-11-10-v1`  
**Dates (America/Denver):** 2025-11-10 → 2025-11-21  
**Owner/DRI:** Architect‑General  
**Teams:** Orchestrator Platform, SRE, Security, Data, UX  
**Tracks:** A) Now‑value; B) Enduring moats  
**Prereq:** `mc-0.3.0` complete (dual‑region, signer svc, diff/promote, audit exports)

---

## 0) Context & Carry‑Forward
**Done**: Active/Active foundations, receipts replication, signer service, verify‑on‑read, versioning v2, event spine GA, compliance packs.  
**Carry‑forward**: finalize autoscaler SLO‑awareness edge cases; complete DB read‑replica failover tests; polish CLI `promote` UX.

---

## 1) Objectives & Key Results
| # | Objective | KR (measurable) |
|---|---|---|
| A1 | **Global Rate Limit & Fairness v1** | Per‑tenant, per‑token, and global limits enforced across regions; p95 authZ + limit check < **20ms** |
| A2 | **Policy Analytics & Explainability** | Export decisions to warehouse; deny reasons clustered; time‑to‑remediation median < **1 day** |
| A3 | **Workflow Packages & Catalog v1** | Pack/verify/install signed workflow packages; 20 curated templates published |
| B1 | **Provenance Index & Search** | Indexed receipts, digests, and decisions; query p95 < **300ms** on 10M docs |
| B2 | **Cost Anomaly Detection** | Drift detector flags outliers; false positive rate < **5%**; alert → auto‑throttle integration |
| B3 | **Runner Fleet Efficiency** | 30% lower idle cost via burstable pools + cold start cache; p95 queue wait unchanged |

---

## 2) Scope (In/Out)
**In**: Multi‑region rate limiter, ABAC→RBAC+quotas integration, analytics export + dbt models, signed workflow package format, provenance index service, anomaly detection pipeline, runner pool manager improvements, CLI/package ops, SLO/error‑budget automation.  
**Out**: Full UI console for analytics (API only); cross‑cloud runners; ML‑based pricing optimizer.

---

## 3) Epics, Swimlanes & Stories

### 3.1 Identity, Limits & Fairness
- **MC‑LIM‑901**: *Global limiter service*  
  **AC:** Token bucket w/ sliding window; per‑tenant + per‑token + global; region‑aware; consistent hashing.  
- **MC‑LIM‑902**: *OPA integration for limits*  
  **AC:** OPA input enriched w/ current usage; deny with `retryAfterMs` advice.  
- **MC‑LIM‑903**: *Fair‑share scheduler*  
  **AC:** Prevents tenant starvation at 5k conc; validates with load suite.

### 3.2 Policy Analytics & Explainability
- **MC‑ANL‑911**: *Decision export → warehouse*  
  **AC:** Hourly CDC to Parquet; dbt models for deny reasons, top violators.  
- **MC‑ANL‑912**: *Explain API*  
  **AC:** `GET /api/policy/explain?executionId=...` returns pack decisions, rules, and inputs (redacted).  
- **MC‑ANL‑913**: *Remediation hints*  
  **AC:** Regos annotated w/ `remediation` metadata; surfaced via API & CLI.

### 3.3 Workflow Packages & Catalog
- **MC‑PKG‑921**: *Package spec & signer*  
  **AC:** `*.mwpkg.tgz` format: manifest+docs+examples; cosign signature; `maestro pkg sign|verify`.  
- **MC‑PKG‑922**: *Catalog publish/install*  
  **AC:** `POST /api/packages` (publish), `POST /api/packages/{id}/install` (tenant‑scoped).  
- **MC‑PKG‑923**: *Curated templates*  
  **AC:** 20 signed packages in default catalog; CI validates.

### 3.4 Provenance Index & Search
- **MC‑PRX‑931**: *Index service*  
  **AC:** Ingest receipts/events; inverted index on digests, task ids, decision types.  
- **MC‑PRX‑932**: *Query API*  
  **AC:** `GET /api/provenance/search?q=...` and filters (time, tenant, pack, digest).

### 3.5 Cost Anomaly Detection
- **MC‑COST‑941**: *Detector pipeline*  
  **AC:** EWMA + seasonal baseline from receipts; alert to SRE + optional auto‑throttle via limiter.  
- **MC‑COST‑942**: *Evaluation harness*  
  **AC:** Backtest on 60d data; FP < 5%, FN < 10%.

### 3.6 Runner Fleet Efficiency
- **MC‑RUN‑951**: *Burstable pools*  
  **AC:** Scale‑to‑zero classes; warm cache for common task images; cold‑start p95 < 1.5s.  
- **MC‑RUN‑952**: *Placement hints*  
  **AC:** Affinity by package digest & region; 30% cache hit improvement.

### 3.7 SRE & Governance
- **MC‑SRE‑961**: *Error‑budget automation*  
  **AC:** Auto‑freeze + auto‑throttle when burn > policy; unfreeze rules implemented.  
- **MC‑GOV‑962**: *Policy pack signing & rotation*  
  **AC:** Bundle signatures rotated quarterly; verify in CI + on load.

---

## 4) Milestones (America/Denver)
- **Kickoff**: Mon 2025‑11‑10 10:00  
- **Design/ADR Review**: Tue 11‑11 15:00  
- **Mid‑sprint Evidence Review**: Fri 11‑14 16:00  
- **GameDay (Limiter fairness)**: Wed 11‑19 14:00  
- **Sprint Review & Release**: Fri 11‑21 15:00  
- **Retro**: Fri 11‑21 16:00

---

## 5) Artifacts & Scaffolds

### 5.1 OpenAPI (deltas)
```yaml
paths:
  /api/policy/explain:
    get:
      summary: Explain decisions for an execution
      parameters:
        - in: query
          name: executionId
          required: true
          schema: { type: string }
      responses:
        '200': { description: Decision details }
  /api/packages:
    post: { summary: Publish a signed workflow package }
    get: { summary: List available packages }
  /api/packages/{id}/install:
    post: { summary: Install package into tenant catalog }
  /api/provenance/search:
    get: { summary: Search receipts/provenance by query and filters }
```

### 5.2 Workflow Package Layout
```
myflow-0.1.0.mwpkg.tgz
├─ manifest.yaml
├─ README.md
├─ examples/
│  └─ minimal.yaml
└─ signatures/
   └─ cosign.sig
```

### 5.3 Limiter Service (proto)
```proto
syntax = "proto3";
package mc.limiter.v1;
message CheckRequest { string tenant = 1; string token = 2; string key = 3; uint32 cost = 4; }
message CheckResponse { bool allow = 1; uint32 retryAfterMs = 2; }
service Limiter { rpc Check(CheckRequest) returns (CheckResponse); }
```

### 5.4 OPA Rego (limit advice)
```rego
package mc.limits

import future.keywords.if

violation[msg] if {
  input.limits.allow == false
  msg := {"reason": "rate_limit", "retryAfterMs": input.limits.retryAfterMs}
}
```

### 5.5 DB/DDL (analytics, packages)
```sql
-- policy decisions warehouse table (staging)
create table if not exists policy_decisions_stg (
  ts timestamptz not null,
  tenant text not null,
  execution_id uuid not null,
  pack text not null,
  rule text not null,
  allow boolean not null,
  reason text,
  remediation text
);

-- packages catalog
create table if not exists packages (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  version text not null,
  digest text not null,
  created_at timestamptz default now(),
  unique(name, version)
);
create table if not exists tenant_packages (
  tenant_id uuid not null references tenants(id),
  package_id uuid not null references packages(id),
  installed_at timestamptz default now(),
  primary key (tenant_id, package_id)
);
```

### 5.6 dbt Model Skeleton (analytics)
```sql
-- models/policy_denies.sql
select date_trunc('day', ts) as day, tenant, pack, rule, count(*) as denies
from {{ ref('policy_decisions_stg') }}
where allow = false
group by 1,2,3,4
```

### 5.7 Anomaly Detector (pseudocode)
```ts
const alpha = 0.2
function ewma(prev: number, cur: number) { return alpha*cur + (1-alpha)*prev }
function isOutlier(baseline: number, value: number, sigma: number = 3) {
  return value > baseline + sigma*Math.sqrt(baseline)
}
```

### 5.8 Runner Pool Config (Helm)
```yaml
runners:
  pools:
    - name: burst-small
      class: small
      min: 0
      max: 200
      warmImages:
        - pkg:demo/echo@1.0.0
    - name: burst-medium
      class: medium
      min: 0
      max: 100
```

### 5.9 CLI (packages & explain)
```bash
maestro pkg sign myflow-0.1.0.mwpkg.tgz
maestro pkg verify myflow-0.1.0.mwpkg.tgz
maestro pkg publish myflow-0.1.0.mwpkg.tgz
maestro pkg install myflow@0.1.0 --tenant acme
maestro explain --execution exec_123
```

---

## 6) Observability & SLOs (adds)
- Metrics: `mc_rl_check_ms` (hist), `mc_rl_denies_total`, `mc_pkg_installs_total`, `mc_prov_search_ms`, `mc_cost_anomaly_total`.  
- Dashboards: Limiter fairness, Policy analytics freshness, Provenance search latency, Runner efficiency.  
- Alerts: limiter p95 > 20ms; warehouse lag > 2h; search p95 > 300ms; anomaly FP > 5% daily.

---

## 7) Security & Compliance
- All packages & bundles must be **signed & verified** (cosign) at publish & install.  
- Warehouse exports include PII‑redaction step; data contracts versioned.  
- Key rotation drill for package signer keys.

---

## 8) GameDay & Drills
- **Limiter fairness** under hostile tenant load (burst & sustained).  
- **Anomaly** injection: synthetic cost spikes; verify alert→throttle sequence.  
- **Index** failure: partial shard outage; search degrades but remains < 500ms p95.

---

## 9) Release & Rollback
- Tag: `mc-0.4.0`.  
- Canary: enable limiter in shadow, then enforce; enable provenance index read‑only then read‑write.  
- Rollback: feature flags to disable limiter enforcement, index writer, and anomaly auto‑throttle.

---

## 10) Jira Import (CSV)
```csv
Summary,Issue Type,Parent,Labels,Description
Global limiter service,Story,EPIC-MC-LIM,mc;limits,Token bucket limits across regions
OPA integration for limits,Story,EPIC-MC-LIM,mc;limits,Enrich input and return retryAfter advice
Fair-share scheduler,Story,EPIC-MC-LIM,mc;limits,Fairness at 5k conc with tests
Decision export to warehouse,Story,EPIC-MC-ANL,mc;analytics,Hourly export + dbt models
Explain API,Story,EPIC-MC-ANL,mc;analytics,Return decisions, rules, redacted inputs
Remediation hints annotations,Story,EPIC-MC-ANL,mc;analytics,Regos annotated with remediation
Workflow package spec & signer,Story,EPIC-MC-PKG,mc;packages,Signed .mwpkg format + CLI
Catalog publish/install,Story,EPIC-MC-PKG,mc;packages,API + tenant-scoped install
Curated templates (20),Story,EPIC-MC-PKG,mc;packages,Signed templates published
Provenance index service,Story,EPIC-MC-PRX,mc;provenance,Index receipts & events
Provenance search API,Story,EPIC-MC-PRX,mc;provenance,Query with filters
Cost anomaly detector,Story,EPIC-MC-COST,mc;cost,EWMA baseline + alerts + throttle
Runner burstable pools,Story,EPIC-MC-RUN,mc;runner,Burst pools with warm cache
Placement hints,Story,EPIC-MC-RUN,mc;runner,Affinity by digest & region
Error-budget automation,Story,EPIC-MC-SRE,mc;sre,Auto-freeze and unfreeze rules
Policy bundle signing rotation,Story,EPIC-MC-GOV,mc;security,Rotate & verify signatures
```

---

## 11) DoR / DoD (adds)
**Adds**: fairness test plan; warehouse data contract; search relevance tests; package signing verification logs; anomaly evaluation report.

---

## 12) Risks & Mitigations
| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Limiter hot path regressions | M | H | Sidecar cache; shadow mode; canary by tenant |
| Package supply chain risk | L | H | Mandatory signatures; verify on install & execute |
| Analytics PII leakage | L | H | Redaction lib + contracts + tests |
| Search index cost growth | M | M | Tiered storage; TTL on logs; shard rebalancing |

---

## 13) Evidence Links (populate during sprint)
- ADRs: `/docs/adr/ADR-02xx-*`  
- Warehouse freshness: `/docs/evidence/analytics-freshness/*`  
- Fairness GameDay: `/docs/evidence/limiter-gameday-2025-11-19/*`  
- Release: `releases/mc-0.4.0`

---

> Standardize the railhead: fairness, explainability, provenance search, and cost discipline that compounds.
```

