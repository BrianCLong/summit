# Templated OIDC Auth resources for staging/prod. Render with envsubst.
apiVersion: v1
kind: ConfigMap
metadata:
  name: oidc-auth-config
  namespace: maestro
data:
  auth-config.json: |
    {
      "oidc": {
        "enabled": true,
        "issuer": "${OIDC_ISSUER}",
        "clientId": "${OIDC_CLIENT_ID}",
        "scopes": ["openid", "profile", "email", "groups"],
        "responseType": "code",
        "redirectUri": "${REDIRECT_URL}",
        "postLogoutRedirectUri": "${POST_LOGOUT_URL}",
        "automaticSilentRenew": true,
        "validateSubOnSilentRenew": true
      },
      "rbac": {
        "enabled": true,
        "rolesClaim": "groups",
        "roles": {
          "admin": { "description": "Full administrative access", "permissions": ["*"] },
          "operator": { "description": "Operate workflows", "permissions": ["workflow:read","workflow:execute","workflow:create","task:read","task:execute","metrics:read"] },
          "analyst": { "description": "Read + execute", "permissions": ["workflow:read","workflow:execute","task:read","metrics:read"] },
          "viewer":  { "description": "Read only", "permissions": ["workflow:read","task:read","metrics:read"] }
        },
        "defaultRole": "viewer"
      },
      "session": { "timeout": 28800, "refreshThreshold": 300, "cookieSecure": true, "cookieSameSite": "strict" }
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: oidc-auth-secret
  namespace: maestro
type: Opaque
data:
  client-secret: ${OIDC_CLIENT_SECRET_B64}
  jwt-secret: ${JWT_SECRET_B64}
  session-key: ${SESSION_KEY_B64}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oidc-auth-proxy
  namespace: maestro
spec:
  replicas: 2
  selector:
    matchLabels: { app.kubernetes.io/name: oidc-auth-proxy }
  template:
    metadata:
      labels: { app.kubernetes.io/name: oidc-auth-proxy }
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        prometheus.io/path: '/metrics'
    spec:
      serviceAccountName: maestro-conductor
      containers:
        - name: oauth2-proxy
          image: quay.io/oauth2-proxy/oauth2-proxy:v7.4.0
          ports:
            - { containerPort: 4180, name: http }
            - { containerPort: 9090, name: metrics }
          env:
            - { name: OAUTH2_PROXY_HTTP_ADDRESS, value: '0.0.0.0:4180' }
            - { name: OAUTH2_PROXY_METRICS_ADDRESS, value: '0.0.0.0:9090' }
            - {
                name: OAUTH2_PROXY_UPSTREAMS,
                value: 'http://maestro-conductor:5000/',
              }
            - { name: OAUTH2_PROXY_PROVIDER, value: 'oidc' }
            - { name: OAUTH2_PROXY_OIDC_ISSUER_URL, value: '${OIDC_ISSUER}' }
            - { name: OAUTH2_PROXY_CLIENT_ID, value: '${OIDC_CLIENT_ID}' }
            - name: OAUTH2_PROXY_CLIENT_SECRET
              valueFrom:
                { secretKeyRef: { name: oidc-auth-secret, key: client-secret } }
            - name: OAUTH2_PROXY_COOKIE_SECRET
              valueFrom:
                { secretKeyRef: { name: oidc-auth-secret, key: session-key } }
            - { name: OAUTH2_PROXY_COOKIE_DOMAINS, value: '${COOKIE_DOMAIN}' }
            - { name: OAUTH2_PROXY_REDIRECT_URL, value: '${REDIRECT_URL}' }
            - { name: OAUTH2_PROXY_EMAIL_DOMAINS, value: '*' }
            - { name: OAUTH2_PROXY_SCOPE, value: 'openid profile email groups' }
            - { name: OAUTH2_PROXY_SET_XAUTHREQUEST, value: 'true' }
            - { name: OAUTH2_PROXY_PASS_ACCESS_TOKEN, value: 'true' }
            - { name: OAUTH2_PROXY_COOKIE_SECURE, value: 'true' }
            - { name: OAUTH2_PROXY_COOKIE_SAMESITE, value: 'strict' }
            - { name: OAUTH2_PROXY_SESSION_STORE_TYPE, value: 'redis' }
            - {
                name: OAUTH2_PROXY_REDIS_CONNECTION_URL,
                value: 'redis://redis-conductor:6379/1',
              }
          livenessProbe:
            {
              httpGet: { path: /ping, port: 4180 },
              initialDelaySeconds: 30,
              periodSeconds: 30,
            }
          readinessProbe:
            {
              httpGet: { path: /ready, port: 4180 },
              initialDelaySeconds: 10,
              periodSeconds: 10,
            }
---
apiVersion: v1
kind: Service
metadata:
  name: oidc-auth-proxy
  namespace: maestro
spec:
  type: ClusterIP
  selector: { app.kubernetes.io/name: oidc-auth-proxy }
  ports:
    - { port: 4180, targetPort: 4180, name: http, protocol: TCP }
    - { port: 9090, targetPort: 9090, name: metrics, protocol: TCP }
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: maestro-conductor-auth-ingress
  namespace: maestro
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: 'true'
    nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'
    nginx.ingress.kubernetes.io/backend-protocol: HTTP
    nginx.ingress.kubernetes.io/auth-url: 'http://oidc-auth-proxy.maestro.svc.cluster.local:4180/oauth2/auth'
    nginx.ingress.kubernetes.io/auth-signin: 'https://${HOST}/oauth2/start?rd=$escaped_request_uri'
    nginx.ingress.kubernetes.io/auth-response-headers: 'X-Auth-Request-User,X-Auth-Request-Email,X-Auth-Request-Groups,X-Auth-Request-Preferred-Username'
spec:
  tls:
    - hosts:
        - ${HOST}
      secretName: maestro-conductor-auth-tls
  rules:
    - host: ${HOST}
      http:
        paths:
          - path: /oauth2
            pathType: Prefix
            backend:
              { service: { name: oidc-auth-proxy, port: { number: 4180 } } }
          - path: /conductor
            pathType: Prefix
            backend:
              { service: { name: maestro-conductor, port: { number: 5000 } } }
          - path: /api
            pathType: Prefix
            backend:
              { service: { name: maestro-conductor, port: { number: 8080 } } }
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: oidc-auth-proxy
  namespace: maestro
spec:
  selector: { matchLabels: { app.kubernetes.io/name: oidc-auth-proxy } }
  endpoints:
    [{ port: metrics, interval: 30s, path: /metrics, honorLabels: true }]
