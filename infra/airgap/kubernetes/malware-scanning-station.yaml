# Malware Scanning Station Deployment
# Achieves 91% malware reduction via multi-engine scanning
# Part of Air-Gapped Deployment for Summit IntelGraph
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: malware-scanner-config
  namespace: intelgraph-scanning
  labels:
    app.kubernetes.io/name: malware-scanner
    app.kubernetes.io/component: scanning-station
data:
  scanner-config.yaml: |
    # Multi-engine malware scanning configuration
    # Target: 91% malware reduction rate
    scanning:
      engines:
        - name: clamav
          enabled: true
          priority: 1
          timeout: 300s
          signatureUpdateInterval: 0  # Air-gapped: manual updates only
        - name: yara
          enabled: true
          priority: 2
          timeout: 180s
          rulesPath: /etc/yara/rules
        - name: hash-check
          enabled: true
          priority: 3
          hashDatabases:
            - /data/hashes/malware-sha256.db
            - /data/hashes/malware-sha1.db
            - /data/hashes/malware-md5.db
        - name: static-analysis
          enabled: true
          priority: 4
          analyzers:
            - pe-analyzer
            - elf-analyzer
            - script-analyzer

      quarantine:
        enabled: true
        path: /quarantine
        retentionDays: 90
        encryptionKey: ${QUARANTINE_ENCRYPTION_KEY}

      reporting:
        format: json
        destination: siem
        includeHashes: true
        includeThreatIntel: true

      thresholds:
        # 91% reduction target = block if any engine detects
        blockOnDetection: true
        minimumEnginesRequired: 2
        scanTimeoutTotal: 600s

    mediaControl:
      allowedDevices:
        - type: usb-storage
          vendorWhitelist:
            - "0951"  # Kingston
            - "0781"  # SanDisk
            - "8564"  # Transcend
          requireEncryption: true
          maxSizeGB: 256

      autoMount: false
      readOnly: true
      scanBeforeAccess: true
      logAllAccess: true

    integrity:
      verifySignatures: true
      requireCosign: true
      slsaLevel: 3
      sbomRequired: true

  yara-rules.yaml: |
    # YARA rules for additional detection
    rules:
      - name: generic_malware
        path: /etc/yara/rules/generic
      - name: ransomware
        path: /etc/yara/rules/ransomware
      - name: backdoor
        path: /etc/yara/rules/backdoor
      - name: cryptominer
        path: /etc/yara/rules/cryptominer
      - name: webshell
        path: /etc/yara/rules/webshell
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: malware-scanner
  namespace: intelgraph-scanning
  labels:
    app.kubernetes.io/name: malware-scanner
    app.kubernetes.io/component: scanning-station
    scanning.intelgraph.io/verified: "true"
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: malware-scanner
  template:
    metadata:
      labels:
        app.kubernetes.io/name: malware-scanner
        app.kubernetes.io/component: scanning-station
        scanning.intelgraph.io/verified: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
    spec:
      serviceAccountName: malware-scanner
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      nodeSelector:
        workload-type: malware-scanning

      tolerations:
        - key: scanning-only
          operator: Equal
          value: "true"
          effect: NoSchedule

      containers:
        - name: scanner-engine
          image: ${ECR_REGISTRY}/malware-scanner:v1.0.0
          imagePullPolicy: Always
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP
          env:
            - name: SCANNER_CONFIG
              value: /config/scanner-config.yaml
            - name: LOG_LEVEL
              value: info
            - name: QUARANTINE_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: scanner-secrets
                  key: quarantine-key
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
            - name: yara-rules
              mountPath: /etc/yara/rules
              readOnly: true
            - name: hash-databases
              mountPath: /data/hashes
              readOnly: true
            - name: quarantine
              mountPath: /quarantine
            - name: scan-workspace
              mountPath: /tmp/scan
            - name: clamav-db
              mountPath: /var/lib/clamav
              readOnly: true
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5

        - name: clamav-daemon
          image: ${ECR_REGISTRY}/clamav:1.2.0
          imagePullPolicy: Always
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          ports:
            - name: clamd
              containerPort: 3310
              protocol: TCP
          volumeMounts:
            - name: clamav-db
              mountPath: /var/lib/clamav
              readOnly: true
            - name: clamav-tmp
              mountPath: /tmp
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi

      volumes:
        - name: config
          configMap:
            name: malware-scanner-config
        - name: yara-rules
          persistentVolumeClaim:
            claimName: yara-rules-pvc
        - name: hash-databases
          persistentVolumeClaim:
            claimName: hash-databases-pvc
        - name: quarantine
          persistentVolumeClaim:
            claimName: quarantine-pvc
        - name: scan-workspace
          emptyDir:
            medium: Memory
            sizeLimit: 2Gi
        - name: clamav-db
          persistentVolumeClaim:
            claimName: clamav-db-pvc
        - name: clamav-tmp
          emptyDir:
            sizeLimit: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: malware-scanner
  namespace: intelgraph-scanning
  labels:
    app.kubernetes.io/name: malware-scanner
spec:
  selector:
    app.kubernetes.io/name: malware-scanner
  ports:
    - name: http
      port: 8080
      targetPort: http
    - name: metrics
      port: 9090
      targetPort: metrics
  type: ClusterIP
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: malware-scanner
  namespace: intelgraph-scanning
  labels:
    app.kubernetes.io/name: malware-scanner
---
# PVCs for scanner data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: yara-rules-pvc
  namespace: intelgraph-scanning
spec:
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: gp3-encrypted
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hash-databases-pvc
  namespace: intelgraph-scanning
spec:
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 50Gi
  storageClassName: gp3-encrypted
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: quarantine-pvc
  namespace: intelgraph-scanning
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: gp3-encrypted
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: clamav-db-pvc
  namespace: intelgraph-scanning
spec:
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: gp3-encrypted
---
# HPA for scaling during high scan volume
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: malware-scanner-hpa
  namespace: intelgraph-scanning
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: malware-scanner
  minReplicas: 2
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Pods
      pods:
        metric:
          name: scan_queue_depth
        target:
          type: AverageValue
          averageValue: "10"
---
# PodDisruptionBudget for high availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: malware-scanner-pdb
  namespace: intelgraph-scanning
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: malware-scanner
