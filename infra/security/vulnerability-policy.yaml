# P27: Vulnerability Management Policy Configuration
# Defines handling policies for security vulnerabilities

apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerability-policy
  namespace: summit-security
  labels:
    app.kubernetes.io/part-of: summit
    app.kubernetes.io/component: security
data:
  policy.yaml: |
    # Vulnerability Management Policy
    version: "1.0"
    lastUpdated: "2025-01-01"

    # Severity definitions
    severityLevels:
      critical:
        cvssRange: [9.0, 10.0]
        slaHours: 24
        requiresApproval: true
        blocksDeploy: true
        alertChannels: ["slack-security", "pagerduty", "email-security-team"]

      high:
        cvssRange: [7.0, 8.9]
        slaHours: 72
        requiresApproval: true
        blocksDeploy: true
        alertChannels: ["slack-security", "email-security-team"]

      medium:
        cvssRange: [4.0, 6.9]
        slaHours: 168  # 7 days
        requiresApproval: false
        blocksDeploy: false
        alertChannels: ["slack-security"]

      low:
        cvssRange: [0.1, 3.9]
        slaHours: 720  # 30 days
        requiresApproval: false
        blocksDeploy: false
        alertChannels: []

      info:
        cvssRange: [0.0, 0.0]
        slaHours: null
        requiresApproval: false
        blocksDeploy: false
        alertChannels: []

    # Exception policies
    exceptions:
      maxDuration: 90  # days
      requiresJustification: true
      requiresApprover: "security-team"
      reviewCadence: 30  # days

    # Scanning configuration
    scanning:
      dependencyAudit:
        enabled: true
        frequency: "daily"
        failThreshold: "high"

      containerScan:
        enabled: true
        frequency: "on-build"
        failThreshold: "critical"
        ignoreUnfixed: true

      staticAnalysis:
        enabled: true
        frequency: "on-pr"
        failThreshold: "high"

      secretScan:
        enabled: true
        frequency: "on-commit"
        blockOnDetection: true

      infrastructureScan:
        enabled: true
        frequency: "daily"
        failThreshold: "high"

    # Allowed package sources
    trustedSources:
      npm:
        - "registry.npmjs.org"
        - "npm.pkg.github.com"
      docker:
        - "ghcr.io"
        - "docker.io"
        - "gcr.io"
      python:
        - "pypi.org"

    # Package restrictions
    restrictions:
      blockedPackages:
        - "event-stream"  # Known malicious
        - "flatmap-stream"
        - "ua-parser-js@<0.7.30"

      deprecatedPackages:
        action: "warn"
        maxAge: 365  # days

      unmaintainedPackages:
        action: "warn"
        maxInactivity: 730  # days (2 years)

    # Notification templates
    notifications:
      critical:
        title: "ðŸš¨ Critical Vulnerability Detected"
        template: |
          A critical vulnerability has been detected in the Summit platform.

          **Vulnerability:** {{.Title}}
          **Package:** {{.Package}}@{{.Version}}
          **CVSS Score:** {{.CVSS}}
          **SLA:** {{.SLAHours}} hours

          **Action Required:**
          - Immediate investigation required
          - Do not deploy until resolved

          **Details:** {{.URL}}

      report:
        title: "ðŸ“Š Weekly Vulnerability Report"
        template: |
          Weekly vulnerability summary for Summit platform.

          **Summary:**
          - Critical: {{.Critical}}
          - High: {{.High}}
          - Medium: {{.Medium}}
          - Low: {{.Low}}

          **New This Week:** {{.NewCount}}
          **Resolved:** {{.ResolvedCount}}
          **Outstanding:** {{.OutstandingCount}}

---
# Vulnerability tracking database schema
apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerability-schema
  namespace: summit-security
data:
  schema.sql: |
    -- Vulnerability tracking tables

    CREATE TABLE IF NOT EXISTS vulnerabilities (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      external_id VARCHAR(100) UNIQUE NOT NULL,
      title VARCHAR(500) NOT NULL,
      description TEXT,
      severity VARCHAR(20) NOT NULL,
      cvss_score DECIMAL(3,1),
      cwe_ids TEXT[],
      package_name VARCHAR(200),
      package_version VARCHAR(50),
      fixed_version VARCHAR(50),
      source VARCHAR(50) NOT NULL,
      source_url TEXT,
      detected_at TIMESTAMPTZ DEFAULT NOW(),
      status VARCHAR(20) DEFAULT 'open',
      assigned_to VARCHAR(100),
      resolved_at TIMESTAMPTZ,
      resolution_notes TEXT,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS vulnerability_exceptions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      vulnerability_id UUID REFERENCES vulnerabilities(id),
      justification TEXT NOT NULL,
      approved_by VARCHAR(100) NOT NULL,
      approved_at TIMESTAMPTZ DEFAULT NOW(),
      expires_at TIMESTAMPTZ NOT NULL,
      review_date TIMESTAMPTZ,
      status VARCHAR(20) DEFAULT 'active',
      created_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS vulnerability_occurrences (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      vulnerability_id UUID REFERENCES vulnerabilities(id),
      repository VARCHAR(200) NOT NULL,
      branch VARCHAR(100),
      file_path TEXT,
      line_number INTEGER,
      first_seen TIMESTAMPTZ DEFAULT NOW(),
      last_seen TIMESTAMPTZ DEFAULT NOW(),
      is_active BOOLEAN DEFAULT true
    );

    CREATE TABLE IF NOT EXISTS scan_history (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      scan_type VARCHAR(50) NOT NULL,
      repository VARCHAR(200),
      branch VARCHAR(100),
      commit_sha VARCHAR(40),
      started_at TIMESTAMPTZ DEFAULT NOW(),
      completed_at TIMESTAMPTZ,
      status VARCHAR(20),
      vulnerabilities_found INTEGER DEFAULT 0,
      critical_count INTEGER DEFAULT 0,
      high_count INTEGER DEFAULT 0,
      medium_count INTEGER DEFAULT 0,
      low_count INTEGER DEFAULT 0,
      report_url TEXT
    );

    -- Indexes
    CREATE INDEX idx_vulnerabilities_severity ON vulnerabilities(severity);
    CREATE INDEX idx_vulnerabilities_status ON vulnerabilities(status);
    CREATE INDEX idx_vulnerabilities_package ON vulnerabilities(package_name);
    CREATE INDEX idx_occurrences_repo ON vulnerability_occurrences(repository);
    CREATE INDEX idx_scan_history_repo ON scan_history(repository, started_at DESC);

    -- Views
    CREATE OR REPLACE VIEW active_vulnerabilities AS
    SELECT v.*, COUNT(vo.id) as occurrence_count
    FROM vulnerabilities v
    LEFT JOIN vulnerability_occurrences vo ON v.id = vo.vulnerability_id AND vo.is_active = true
    WHERE v.status = 'open'
    GROUP BY v.id;

    CREATE OR REPLACE VIEW vulnerability_metrics AS
    SELECT
      DATE(detected_at) as date,
      severity,
      COUNT(*) as count
    FROM vulnerabilities
    WHERE detected_at > NOW() - INTERVAL '90 days'
    GROUP BY DATE(detected_at), severity;
