apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-observability-dashboards
  namespace: observability
  labels:
    app.kubernetes.io/name: grafana-dashboards
    app.kubernetes.io/component: observability
    grafana_dashboard: "1"
data:
  agent-observability.json: |
    {
      "title": "Agent Observability & KPIs",
      "description": "Agent runtime success, cost, correlation coverage, and profiling health",
      "panels": [
        {
          "type": "stat",
          "title": "Agent Success Rate",
          "gridPos": { "w": 6, "h": 4, "x": 0, "y": 0 },
          "targets": [
            {
              "expr": "1 - (sum(rate(agent_requests_total{status=\"failed\"}[5m])) / sum(rate(agent_requests_total[5m])))",
              "legendFormat": "success rate"
            }
          ],
          "options": { "colorMode": "value", "reduceOptions": { "calcs": ["lastNotNull"] } }
        },
        {
          "type": "stat",
          "title": "Runtime Cost (30m)",
          "gridPos": { "w": 6, "h": 4, "x": 6, "y": 0 },
          "targets": [
            {
              "expr": "increase(agent_runtime_cost_total[30m])",
              "legendFormat": "cost ($)"
            }
          ],
          "options": { "colorMode": "value", "reduceOptions": { "calcs": ["lastNotNull"] } }
        },
        {
          "type": "graph",
          "title": "Agent Latency (p95)",
          "gridPos": { "w": 12, "h": 8, "x": 0, "y": 4 },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(agent_request_duration_seconds_bucket[5m])) by (le))",
              "legendFormat": "p95 latency"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Agent Failure Rate",
          "gridPos": { "w": 12, "h": 8, "x": 12, "y": 4 },
          "targets": [
            {
              "expr": "sum(rate(agent_requests_total{status=\"failed\"}[5m])) / sum(rate(agent_requests_total[5m]))",
              "legendFormat": "failure rate"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Correlation Coverage",
          "gridPos": { "w": 12, "h": 8, "x": 0, "y": 12 },
          "targets": [
            {
              "expr": "1 - (sum(rate(otel_request_correlation_total{status=\"missing\"}[15m])) / sum(rate(otel_request_correlation_total[15m])))",
              "legendFormat": "coverage"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Audit Events",
          "gridPos": { "w": 12, "h": 8, "x": 12, "y": 12 },
          "targets": [
            {
              "expr": "rate(audit_events_total[5m])",
              "legendFormat": "audit events/s"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Profiling Samples Ingested (5m)",
          "gridPos": { "w": 6, "h": 4, "x": 0, "y": 20 },
          "targets": [
            {
              "expr": "sum(rate(pyroscope_samples_ingested_total[5m]))",
              "legendFormat": "samples/s"
            }
          ],
          "options": { "colorMode": "value", "reduceOptions": { "calcs": ["lastNotNull"] } }
        },
        {
          "type": "stat",
          "title": "Vector Pipeline Errors (5m)",
          "gridPos": { "w": 6, "h": 4, "x": 6, "y": 20 },
          "targets": [
            {
              "expr": "sum(rate(vector_errors_total[5m]))",
              "legendFormat": "errors"
            }
          ],
          "options": { "colorMode": "value", "reduceOptions": { "calcs": ["lastNotNull"] } }
        }
      ]
    }
  system-health.json: |
    {
      "title": "Mesh & System Health",
      "description": "Golden signals for API, mesh traffic, resource utilization, collectors, and logging",
      "panels": [
        {
          "type": "graph",
          "title": "API Latency p99",
          "gridPos": { "w": 12, "h": 8, "x": 0, "y": 0 },
          "targets": [
            {
              "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job=\"intelgraph-api\"}[5m])) by (le))",
              "legendFormat": "api p99"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Mesh Error Rate",
          "gridPos": { "w": 12, "h": 8, "x": 12, "y": 0 },
          "targets": [
            {
              "expr": "sum(rate(istio_requests_total{response_code=~\"5..\"}[5m])) / sum(rate(istio_requests_total[5m]))",
              "legendFormat": "5xx rate"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Collector & Vector Uptime",
          "gridPos": { "w": 12, "h": 8, "x": 0, "y": 8 },
          "targets": [
            { "expr": "avg(up{job=\"otel-collector\"})", "legendFormat": "otel-collector" },
            { "expr": "avg(up{job=\"vector\"})", "legendFormat": "vector" }
          ]
        },
        {
          "type": "graph",
          "title": "CPU Utilization (Agents Namespace)",
          "gridPos": { "w": 12, "h": 8, "x": 12, "y": 8 },
          "targets": [
            {
              "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"agents\", container!~\"POD|\"}[5m]))",
              "legendFormat": "agents cpu"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Memory Utilization (Agents Namespace)",
          "gridPos": { "w": 12, "h": 8, "x": 0, "y": 16 },
          "targets": [
            {
              "expr": "sum(container_memory_working_set_bytes{namespace=\"agents\", container!~\"POD|\"})",
              "legendFormat": "agents memory"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Log Shipping Throughput",
          "gridPos": { "w": 12, "h": 8, "x": 12, "y": 16 },
          "targets": [
            {
              "expr": "sum(rate(vector_processed_events_total{component_kind=\"sink\"}[5m]))",
              "legendFormat": "events/s"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Profiling Samples",
          "gridPos": { "w": 12, "h": 8, "x": 0, "y": 24 },
          "targets": [
            {
              "expr": "sum(rate(pyroscope_samples_ingested_total[5m]))",
              "legendFormat": "pyroscope"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Audit Event Rate",
          "gridPos": { "w": 12, "h": 8, "x": 12, "y": 24 },
          "targets": [
            {
              "expr": "rate(audit_events_total[5m])",
              "legendFormat": "audit"
            }
          ]
        }
      ]
    }
