apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging

data:
  vector.toml: |
    [sources.kubernetes_logs]
      type = "kubernetes_logs"
      auto_partial_merge = true
      pod_annotation_fields.pod_labels = ["app.kubernetes.io/name", "app.kubernetes.io/component", "app"]
      add_fields = {cluster = "summit", pipeline = "vector"}

    [transforms.enrich]
      type = "remap"
      inputs = ["kubernetes_logs"]
      source = <<'VRL'
        .correlation_id = coalesce!(.correlation_id, .headers["x-correlation-id"], .kubernetes.pod_annotations."correlation-id")
        .trace_id = coalesce!(.trace_id, .headers["x-b3-traceid"], .headers["traceparent"])
        .service = .kubernetes.pod_labels."app.kubernetes.io/name"
        .namespace = .kubernetes.namespace_name
VRL

    [sinks.loki]
      type = "loki"
      inputs = ["enrich"]
      endpoint = "http://loki:3100"
      labels.cluster = "summit"
      labels.service = "{{ service }}"
      labels.namespace = "{{ namespace }}"
      encoding.codec = "json"

    [sinks.otel]
      type = "opentelemetry"
      inputs = ["enrich"]
      endpoint = "http://otel-collector.observability.svc.cluster.local:4317"
      protocol = "grpc"
      tls.enabled = false
      resource.attributes.service = "{{ service }}"
      resource.attributes.namespace = "{{ namespace }}"
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: vector
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vector
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vector
        app.kubernetes.io/component: logging
    spec:
      serviceAccountName: vector
      tolerations:
        - operator: "Exists"
      containers:
        - name: vector
          image: timberio/vector:0.42.0-debian
          imagePullPolicy: IfNotPresent
          env:
            - name: VECTOR_SELF_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          volumeMounts:
            - name: config
              mountPath: /etc/vector
      volumes:
        - name: config
          configMap:
            name: vector-config
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vector
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging
