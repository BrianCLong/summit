apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging

data:
  vector.toml: |
    [api]
      enabled = true
      address = "0.0.0.0:8686"

    [sources.kubernetes_logs]
      type = "kubernetes_logs"
      auto_partial_merge = true
      pod_annotation_fields.pod_labels = ["app.kubernetes.io/name", "app.kubernetes.io/component", "app"]
      add_fields = {cluster = "summit", pipeline = "vector"}

    [transforms.enrich]
      type = "remap"
      inputs = ["kubernetes_logs"]
      source = <<'VRL'
        .correlation_id = coalesce!(.correlation_id, .headers["x-correlation-id"], .kubernetes.pod_annotations."correlation-id")
        .trace_id = coalesce!(.trace_id, .headers["x-b3-traceid"], .headers["traceparent"])
        .service = .kubernetes.pod_labels."app.kubernetes.io/name"
        .namespace = .kubernetes.namespace_name
        .retention_class = coalesce!(.retention_class, .kubernetes.pod_annotations."retention-class", "application")
        .pii_tags = coalesce!(.pii_tags, .kubernetes.pod_annotations."pii-tags")
VRL

    [sinks.loki]
      type = "loki"
      inputs = ["enrich"]
      endpoint = "http://loki:3100"
      labels.cluster = "summit"
      labels.service = "{{ service }}"
      labels.namespace = "{{ namespace }}"
      labels.correlation_id = "{{ correlation_id }}"
      labels.retention_class = "{{ retention_class }}"
      encoding.codec = "json"

    [sinks.otel]
      type = "opentelemetry"
      inputs = ["enrich"]
      endpoint = "http://otel-collector.observability.svc.cluster.local:4317"
      protocol = "grpc"
      tls.enabled = false
      resource.attributes.service = "{{ service }}"
      resource.attributes.namespace = "{{ namespace }}"
      resource.attributes.correlation_id = "{{ correlation_id }}"

    [sinks.prometheus]
      type = "prometheus_exporter"
      inputs = ["kubernetes_logs"]
      address = "0.0.0.0:9598"
      buckets = [0.1, 0.25, 0.5, 1.0, 2.5, 5, 10]

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: vector
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vector
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vector
        app.kubernetes.io/component: logging
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8686"
    spec:
      serviceAccountName: vector
      tolerations:
        - operator: "Exists"
      containers:
        - name: vector
          image: timberio/vector:0.42.0-debian
          imagePullPolicy: IfNotPresent
          env:
            - name: VECTOR_SELF_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          ports:
            - name: api
              containerPort: 8686
            - name: prom
              containerPort: 9598
          volumeMounts:
            - name: config
              mountPath: /etc/vector
      volumes:
        - name: config
          configMap:
            name: vector-config
---
apiVersion: v1
kind: Service
metadata:
  name: vector
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging
spec:
  selector:
    app.kubernetes.io/name: vector
  ports:
    - name: api
      port: 8686
      targetPort: api
    - name: prom
      port: 9598
      targetPort: prom
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vector
  namespace: observability
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/component: logging
