# Vulnerability Blocking Policies
# Target: 99%+ vulnerability block rate for Critical/High CVEs
#
# This configuration defines the security policies for blocking
# vulnerable images from being deployed to the cluster.

apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerability-policy
  namespace: harbor
  labels:
    app: harbor
    component: security-policy
data:
  # Main vulnerability policy
  vulnerability-policy.yaml: |
    # ==========================================================================
    # Vulnerability Blocking Policy
    # Target: 99%+ block rate for Critical and High severity vulnerabilities
    # ==========================================================================

    version: "1.0"
    name: "intelgraph-vuln-policy"
    description: "Enterprise vulnerability blocking policy for IntelGraph platform"

    # Global Settings
    global:
      # Enable vulnerability blocking
      enabled: true

      # Fail-closed on scanner errors
      failClosed: true

      # Scanner timeout
      scanTimeout: "10m"

      # Cache scan results
      cacheResults: true
      cacheTTL: "4h"

    # Severity-based blocking rules
    severityRules:
      # CRITICAL: Always block - 100% block rate
      critical:
        action: block
        exceptions: []
        maxAge: "0s"  # Must be fixed immediately
        alertLevel: critical
        notification:
          slack: true
          email: true
          pagerduty: true

      # HIGH: Block with minimal exceptions - 99% block rate
      high:
        action: block
        maxAge: "168h"  # 7 days grace period for existing deployments
        exceptions:
          # Temporary exceptions require approval and expiry
          - cve: "CVE-XXXX-XXXX"
            reason: "No fix available, compensating controls in place"
            approvedBy: "security-team"
            expiresAt: "2025-03-01T00:00:00Z"
        alertLevel: high
        notification:
          slack: true
          email: true

      # MEDIUM: Warn, track, remediate
      medium:
        action: warn
        maxAge: "720h"  # 30 days
        alertLevel: medium
        notification:
          slack: true

      # LOW: Log only
      low:
        action: log
        maxAge: "2160h"  # 90 days
        alertLevel: low

      # UNKNOWN: Investigate
      unknown:
        action: warn
        alertLevel: medium

    # CVSS Score-based rules (override severity if higher risk)
    cvssRules:
      # CVSS 9.0+ always blocked regardless of severity label
      - minScore: 9.0
        action: block
        priority: highest

      # CVSS 7.0-8.9 blocked unless excepted
      - minScore: 7.0
        maxScore: 8.9
        action: block
        priority: high

      # CVSS 4.0-6.9 warned
      - minScore: 4.0
        maxScore: 6.9
        action: warn
        priority: medium

    # Exploit availability rules
    exploitRules:
      # Known exploits in the wild - immediate block
      - condition: "exploit_available"
        action: block
        priority: critical
        maxAge: "0s"

      # Proof of concept available
      - condition: "poc_available"
        action: block
        priority: high
        maxAge: "72h"

    # Fix availability rules
    fixAvailabilityRules:
      # If fix is available, stricter timeline
      - condition: "fix_available"
        severityMultiplier: 0.5  # Half the allowed maxAge
        priority: high

      # No fix available - allow compensating controls
      - condition: "no_fix"
        allowCompensatingControls: true
        requireApproval: true

    # Package-specific rules
    packageRules:
      # Critical packages - zero tolerance
      - packages:
          - "openssl"
          - "openssh"
          - "sudo"
          - "kernel"
          - "glibc"
        minSeverity: medium
        action: block

      # Runtime packages
      - packages:
          - "node"
          - "npm"
          - "python"
          - "java"
        minSeverity: high
        action: block

    # Image-specific exemptions (use sparingly)
    imageExemptions:
      # System images that can't be easily updated
      - pattern: "registry.k8s.io/pause:*"
        reason: "Kubernetes system image"
        maxSeverity: medium

      - pattern: "registry.k8s.io/coredns/*"
        reason: "Kubernetes DNS - managed separately"
        maxSeverity: medium

    # Namespace-specific policies
    namespaceOverrides:
      # Development - warn only
      - namespace: "development"
        action: warn
        alertLevel: low

      # Staging - block high+
      - namespace: "staging"
        severityRules:
          critical:
            action: block
          high:
            action: warn

      # Production - strictest policy
      - namespace: "production"
        # Uses global rules (strictest)

    # Compliance mappings
    compliance:
      # Map CVEs to compliance frameworks
      frameworks:
        - name: "PCI-DSS"
          requirements:
            - "6.2"  # Security patches
            - "6.5"  # Secure coding
          severityMapping:
            critical: "immediate"
            high: "30-days"
            medium: "90-days"

        - name: "SOC2"
          requirements:
            - "CC6.1"  # Security
            - "CC7.1"  # Change management
          severityMapping:
            critical: "immediate"
            high: "14-days"

        - name: "NIST-800-53"
          requirements:
            - "SI-2"  # Flaw remediation
            - "RA-5"  # Vulnerability scanning
          severityMapping:
            critical: "immediate"
            high: "30-days"

    # Reporting configuration
    reporting:
      # Generate daily vulnerability reports
      dailyReport:
        enabled: true
        recipients:
          - security@intelgraph.local
          - platform-team@intelgraph.local
        includeMetrics: true
        includetrends: true

      # Weekly executive summary
      weeklyExecutive:
        enabled: true
        recipients:
          - ciso@intelgraph.local
          - cto@intelgraph.local

      # Real-time alerts for critical
      realTimeAlerts:
        enabled: true
        channels:
          - type: slack
            webhook: "${SLACK_SECURITY_WEBHOOK}"
          - type: pagerduty
            serviceKey: "${PAGERDUTY_SERVICE_KEY}"

    # Metrics
    metrics:
      enabled: true
      path: "/metrics/vulnerabilities"
      labels:
        - severity
        - namespace
        - image
        - fix_available

  # Scanner configuration
  scanner-config.yaml: |
    # Trivy Scanner Configuration
    trivy:
      # Vulnerability databases
      databases:
        # Primary vulnerability database
        - name: "trivy-db"
          url: "ghcr.io/aquasecurity/trivy-db"
          updateInterval: "12h"

        # Java vulnerability database
        - name: "trivy-java-db"
          url: "ghcr.io/aquasecurity/trivy-java-db"
          updateInterval: "24h"

      # Scan settings
      settings:
        # Types of vulnerabilities to scan
        vulnTypes:
          - os
          - library

        # Severities to report
        severities:
          - CRITICAL
          - HIGH
          - MEDIUM
          - LOW
          - UNKNOWN

        # Ignore unfixed vulnerabilities in reports (but still track)
        ignoreUnfixed: false

        # Skip specific files/directories
        skipDirs:
          - /proc
          - /sys
          - /dev

        # Timeout per image
        timeout: "10m"

        # Cache directory
        cacheDir: "/var/cache/trivy"

        # Offline mode for air-gapped
        offlineMode: false

      # Secret scanning
      secretScanning:
        enabled: true
        configPath: "/etc/trivy/secret-config.yaml"

      # License scanning
      licenseScanning:
        enabled: true
        # Block these licenses
        forbiddenLicenses:
          - GPL-3.0
          - AGPL-3.0

      # Misconfigurations
      misconfigScanning:
        enabled: true
        policies:
          - /etc/trivy/policies

  # Block rate tracking
  block-rate-metrics.yaml: |
    # Vulnerability Block Rate Metrics
    # Target: 99%+ for Critical/High

    metrics:
      # Total vulnerabilities detected
      - name: vulnerabilities_detected_total
        type: counter
        labels: [severity, namespace]

      # Vulnerabilities blocked
      - name: vulnerabilities_blocked_total
        type: counter
        labels: [severity, namespace, action]

      # Block rate gauge
      - name: vulnerability_block_rate
        type: gauge
        labels: [severity]
        calculation: "blocked / detected * 100"

      # Time to remediation
      - name: vulnerability_remediation_time_seconds
        type: histogram
        labels: [severity]
        buckets: [3600, 86400, 604800, 2592000]  # 1h, 1d, 7d, 30d

      # Exceptions granted
      - name: vulnerability_exceptions_total
        type: counter
        labels: [severity, reason]

      # SLA compliance
      - name: vulnerability_sla_compliance
        type: gauge
        labels: [severity, compliance_framework]

    # Alerting rules
    alerts:
      # Block rate below target
      - name: VulnerabilityBlockRateLow
        condition: "vulnerability_block_rate{severity='critical'} < 100"
        severity: critical
        message: "Critical vulnerability block rate below 100%"

      - name: VulnerabilityBlockRateLow
        condition: "vulnerability_block_rate{severity='high'} < 99"
        severity: high
        message: "High vulnerability block rate below 99%"

      # Too many exceptions
      - name: TooManyExceptions
        condition: "rate(vulnerability_exceptions_total[7d]) > 5"
        severity: warning
        message: "High rate of vulnerability exceptions granted"
