# Harbor Registry Configuration for Air-Gapped Deployments
# Version: 2.10.x
# Purpose: Secure container registry with proxy cache for offline/air-gapped environments
#
# SECURITY NOTICE: This configuration enforces:
# - Mandatory image signing via cosign
# - SLSA Level 3 provenance verification
# - 99%+ vulnerability blocking (Critical/High CVEs blocked)
# - Network isolation for air-gapped deployments

expose:
  type: ingress
  tls:
    enabled: true
    certSource: secret
    secret:
      secretName: harbor-tls
      notarySecretName: notary-tls
  ingress:
    hosts:
      core: registry.intelgraph.local
      notary: notary.intelgraph.local
    className: nginx
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "0"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "900"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "900"
      # Security headers
      nginx.ingress.kubernetes.io/configuration-snippet: |
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";

externalURL: https://registry.intelgraph.local

persistence:
  enabled: true
  resourcePolicy: "keep"
  persistentVolumeClaim:
    registry:
      storageClass: "fast-ssd"
      size: 500Gi
    chartmuseum:
      storageClass: "fast-ssd"
      size: 50Gi
    jobservice:
      storageClass: "standard"
      size: 10Gi
    database:
      storageClass: "fast-ssd"
      size: 50Gi
    redis:
      storageClass: "standard"
      size: 5Gi
    trivy:
      storageClass: "standard"
      size: 20Gi

# Harbor Core Configuration
harborAdminPassword: "" # Set via secret HARBOR_ADMIN_PASSWORD

# Database Configuration (PostgreSQL)
database:
  type: external
  external:
    host: "harbor-postgresql"
    port: "5432"
    username: "harbor"
    password: "" # Set via secret DATABASE_PASSWORD
    coreDatabase: "harbor_core"
    notaryServerDatabase: "harbor_notary_server"
    notarySignerDatabase: "harbor_notary_signer"
    sslmode: "require"

# Redis Configuration
redis:
  type: external
  external:
    addr: "harbor-redis:6379"
    password: "" # Set via secret REDIS_PASSWORD

# Security Scanner - Trivy
trivy:
  enabled: true
  gitHubToken: "" # Optional for rate limiting
  skipUpdate: true # Air-gapped: use offline DB
  offlineScan: true
  securityCheck: "vuln,config,secret"
  severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
  timeout: "10m"
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# Notary (Content Trust)
notary:
  enabled: true
  server:
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
  signer:
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"

# Core Service
core:
  replicas: 2
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  # Secret key for encryption
  secretKey: "" # Set via secret CORE_SECRET_KEY
  # XSRF key
  xsrfKey: "" # Set via secret CORE_XSRF_KEY

# Job Service
jobservice:
  replicas: 1
  maxJobWorkers: 10
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# Registry
registry:
  replicas: 2
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  # Garbage collection
  relativeurls: false
  credentials:
    username: "harbor_registry_user"
    password: "" # Set via secret REGISTRY_PASSWORD
    htpasswdString: "" # Set via secret REGISTRY_HTPASSWD

# Portal
portal:
  replicas: 1
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "512Mi"
      cpu: "250m"

# Proxy Cache Configuration (for air-gapped sync)
proxy:
  httpProxy: ""
  httpsProxy: ""
  noProxy: "127.0.0.1,localhost,.local,.internal"

# Metrics
metrics:
  enabled: true
  core:
    path: /metrics
    port: 8001
  registry:
    path: /metrics
    port: 8001
  jobservice:
    path: /metrics
    port: 8001
  exporter:
    path: /metrics
    port: 8001

# Pod Security
podSecurityContext:
  runAsUser: 10000
  runAsGroup: 10000
  fsGroup: 10000

containerSecurityContext:
  runAsNonRoot: true
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Update Strategy
updateStrategy:
  type: RollingUpdate

# Network Policies
networkPolicy:
  enabled: true

# Service Account
serviceAccount:
  create: true
  annotations: {}

# Priority Class
priorityClassName: "system-cluster-critical"

# Tolerations for dedicated nodes
tolerations:
  - key: "registry"
    operator: "Equal"
    value: "harbor"
    effect: "NoSchedule"

# Node Affinity
nodeSelector:
  node-role.kubernetes.io/registry: "true"

# Pod Disruption Budget
podDisruptionBudget:
  core:
    minAvailable: 1
  portal:
    minAvailable: 1
  registry:
    minAvailable: 1
