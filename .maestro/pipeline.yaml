version: 1
pipeline:
  name: intelgraph-main
  environment: development
  budgets: { hard_cap_usd: 25.00 }
  steps:
    - id: setup-toolchains
      run: just setup && pnpm -v && python -V
    - id: build-all
      run: just build-all
    - id: sbom-and-scan
      run: just sbom && just trivy
    - id: slo-burn-check
      run: ./.ci/scripts/otel_wrap.sh --name slo-burn-check -- just slo-check
      when: event == "push" || event == "pull_request"
    - id: migration-gate
      run: just migration-gate
      when: files_changed("migrations/**")
    - id: canary-deploy
      run: just deploy --strategy=canary --weight=10
      when: branch == "main" || tag != ""
    - id: canary-analyze
      run: ./.ci/scripts/otel_wrap.sh --name canary-analyze -- just canary-analyze --budget .maestro/ci_budget.json
      when: step_succeeded("canary-deploy") && step_succeeded("slo-burn-check")
    - id: promote-or-rollback
      run: ./.ci/scripts/otel_wrap.sh --name promote-or-rollback -- just promote || just rollback
      when: step_succeeded("canary-analyze")
