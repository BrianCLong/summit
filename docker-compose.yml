services:
  neo4j:
    image: neo4j:2025.01
    environment:
      - NEO4J_AUTH=neo4j/test1234
    ports: [ "7474:7474", "7687:7687" ]
    volumes:
      - neo4j_data:/data
    networks:
      - default
      - observability
      - intelgraph

  redis:
    image: redis:7-alpine
    ports: [ "6379:6379" ]
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - default
      - observability
      - intelgraph

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_PASSWORD=postgres
    ports: [ "5432:5432" ]
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - default
      - observability
      - intelgraph

  prov-ledger:
    build: ./services/prov-ledger
    command: node dist/index.js
    ports: [ "4010:4010" ]
    depends_on: [ redis ]
    networks:
      - default
      - observability

  policy-lac:
    build: ./gateway/policy-lac
    command: node dist/index.js
    ports: [ "4011:4000" ]
    networks:
      - default
      - observability

  nl2cypher:
    build: ./server/ai/nl2cypher
    command: node dist/index.js
    ports: [ "4020:4020" ]
    networks:
      - default
      - observability

  server:
    build:
      context: .
      dockerfile: server/Dockerfile.dev
    ports: [ "4001:4000" ]
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/postgres?sslmode=disable
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=test1234
      - REDIS_URL=redis://redis:6379
      - REDIS_HOST=redis
      - JWT_SECRET=dev-secret-do-not-use-in-prod-and-longer
      - JWT_REFRESH_SECRET=another-dev-secret-refresh-key-32-chars
      - SESSION_SECRET=dev-secret-do-not-use-in-prod
      - NODE_ENV=development
      - ENABLE_INSECURE_DEV_AUTH=true
      - AI_ENABLED=false
      - GA_CLOUD=
      - OPENAI_API_KEY=dummy
      - JAEGER_ENDPOINT=http://jaeger-collector:14268/api/traces
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://otel-collector:4318/v1/traces
      - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://otel-collector:4318/v1/metrics
    depends_on:
      - postgres
      - neo4j
      - redis
    networks:
      - default
      - observability
      - intelgraph

  api-gateway:
    build: ./services/api-gateway
    ports: [ "4000:4000" ]
    environment:
      - POLICY_DRY_RUN=true
      - ENABLE_INSECURE_DEV_AUTH=true
      - GRAPH_SERVICE_URL=http://server:4000
    depends_on: [ redis ]
    networks:
      - default
      - observability

  gateway:
    build:
      context: .
      dockerfile: apps/gateway/Dockerfile
    ports: [ "8080:8080" ]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on: [ api-gateway ]
    networks:
      - default
      - observability

  backup-service:
    build: ./server/infrastructure/disaster-recovery
    volumes:
      - ./backups:/backups
      - redis_data:/redis_data
      - neo4j_data:/neo4j_data
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - REDIS_HOST=redis
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - S3_BUCKET
      - S3_REGION
      - S3_ENDPOINT
    depends_on:
      - postgres
      - redis
    networks:
      - default
      - observability

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    ports: [ "3000:3000" ]
    environment:
      - VITE_API_URL=http://localhost:4000/graphql
      - VITE_WS_URL=ws://localhost:4000/graphql
    networks:
      - default
      - observability
      - intelgraph

volumes:
  neo4j_data: {}
  pg_data: {}
  redis_data: {}

networks:
  observability:
    driver: bridge
  intelgraph:
    external: true
