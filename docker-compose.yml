version: '3.9'
services:
  v24-coherence:
    image: intelgraph-v24:latest
    environment:
      - COLLABORATION_MODE=true
      - ENGAGEMENT_INTENSITY=1.0
      - GLOBAL_IMPACT=1e15
      - INTEGRITY_THRESHOLD=0.0000000001
      - COMPLIANCE_STANDARD=true
      - OPPORTUNITY_PRECISION=0.0000000001
      - STABILIZATION_NEXUS=1.0
      - ENGAGEMENT_INTENSITY=1.0
      - COHERENCE_SCALE=10000000000000
    volumes:
      - neo4j-data:/data
    networks:
      - isolated
  neo4j-perf:
    image: neo4j:5.17
    profiles:
      - graph-perf
    environment:
      NEO4J_AUTH: neo4j/test-password
      NEO4J_dbms_memory_heap_initial__size: 1G
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G
      NEO4J_dbms_logs_debug_level: INFO
    ports:
      - '7474:7474'
      - '7687:7687'
    volumes:
      - neo4j-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'cypher-shell -u neo4j -p test-password "RETURN 1"']
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - isolated
  redis-perf:
    image: redis:7-alpine
    profiles:
      - graph-perf
    command: redis-server --save '' --appendonly no
    ports:
      - '6379:6379'
    networks:
      - isolated
  graphql-perf:
    build:
      context: server
      dockerfile: Dockerfile
    profiles:
      - graph-perf
    depends_on:
      neo4j-perf:
        condition: service_healthy
      redis-perf:
        condition: service_started
    environment:
      GRAPHQL_PORT: 4000
      NEO4J_URI: bolt://neo4j-perf:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: test-password
      REDIS_URL: redis://redis-perf:6379
      GRAPH_TRAVERSAL_RADIUS: 3
      GRAPH_TRAVERSAL_MIN_NODES: 100
    ports:
      - '4000:4000'
    networks:
      - isolated
  k6-graph-perf:
    image: grafana/k6:0.49.0
    profiles:
      - graph-perf
    depends_on:
      graphql-perf:
        condition: service_started
    environment:
      GRAPHQL_URL: http://graphql-perf:4000/graphql
      GRAPH_TRAVERSAL_INVESTIGATION_ID: investigation-001
      GRAPH_TRAVERSAL_ENTITY_IDS: entity-001
      GRAPH_TRAVERSAL_RADIUS: 3
      K6_STATSD_ENABLE_TAGS: 'true'
    volumes:
      - ./perf/k6:/scripts
    entrypoint:
      - k6
      - run
      - /scripts/graph-traversal-benchmark.js
    networks:
      - isolated
networks:
  isolated:
    driver: bridge
volumes:
  neo4j-data:
