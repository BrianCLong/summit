This add-on bundle completes the sprint: **Renovate** for safe dependency upgrades (policy-aware, canaried), **dashboards-as-code** (Grafana JSON + OTEL resource attributes), and a **Clean Main Sentinel** that freezes merges when `main` is red and pings owners with remediation steps.

---

## File Map

```
.renovaterc.json
.github/workflows/renovate-selfhosted.yml   # optional if using app token
.github/workflows/clean-main-sentinel.yml
.ci/otel/resource-attrs.env
observability/grafana/
  dashboard_overview.json
  dashboard_slo_service.json
  alerts_slo.yaml
docs/observability/README.md
```

---

## Renovate Config (safe-by-default, canary-aware)

### `.renovaterc.json`

```json
{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":semanticCommits",
    ":separateMultipleMajorReleases",
    ":enableVulnerabilityAlertsWithLabel(security)",
    "group:lintersAllNonMajor",
    "workarounds:all"
  ],
  "timezone": "America/Denver",
  "prConcurrentLimit": 5,
  "prHourlyLimit": 4,
  "schedule": ["after 7am and before 5pm every weekday"],
  "labels": ["dependencies", "automerge/canary"],
  "rangeStrategy": "bump",
  "semanticCommits": "enabled",
  "commitBody": "Generated by Renovate; will deploy via canary and auto‑rollback on breach.",
  "packageRules": [
    {
      "matchManagers": ["npm"],
      "enabled": true,
      "rangeStrategy": "bump",
      "postUpdateOptions": ["npmDedupe"],
      "labels": ["npm"],
      "stabilityDays": 1
    },
    {
      "matchManagers": ["pip_requirements", "poetry"],
      "labels": ["python"],
      "stabilityDays": 1
    },
    {
      "matchPackagePatterns": ["^@types/"],
      "groupName": "types",
      "automerge": true,
      "automergeType": "branch"
    },
    {
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": false,
      "prBodyNotes": [
        "This PR will roll out via canary using the release train."
      ]
    },
    {
      "matchUpdateTypes": ["major"],
      "labels": ["major"],
      "prCreation": "not-pending",
      "stabilityDays": 3,
      "automerge": false
    },
    {
      "matchManagers": ["npm", "pip_requirements", "poetry"],
      "matchDepTypes": ["devDependencies", "dev"],
      "groupName": "dev-deps",
      "separateMinorPatch": true
    }
  ],
  "vulnerabilityAlerts": {
    "labels": ["security"],
    "assignees": ["@your-org/secops"],
    "schedule": ["at any time"]
  },
  "prBodyTemplate": "{{{header}}}\n\n{{{table}}}\n\n**Rollout**: This change is deployed via canary (5→25→50→100) with auto‑rollback.\n**SLO Gates**: p95, error rate, saturation.\n{{{notes}}}"
}
```

> If using Renovate App, no workflow is needed. If self-hosting, add the workflow below.

### `.github/workflows/renovate-selfhosted.yml`

```yaml
name: renovate
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: {}
jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - uses: renovatebot/github-action@v40.1.11
        with:
          configurationFile: .renovaterc.json
        env:
          LOG_LEVEL: info
          RENOVATE_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
          GITHUB_COM_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
```

---

## Clean Main Sentinel (freeze merges when red)

### `.github/workflows/clean-main-sentinel.yml`

```yaml
name: clean-main-sentinel
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
permissions: { contents: read, pull-requests: write }
concurrency:
  group: sentinel-${{ github.event.pull_request.number }}
  cancel-in-progress: true
jobs:
  check-main:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest status of main
        id: status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: ref } = await github.rest.repos.getBranch({
              owner: context.repo.owner, repo: context.repo.repo, branch: 'main'
            })
            const protected = ref.protected
            // Treat non-success checks as red
            const { data: ws } = await github.rest.repos.listCommitStatusesForRef({
              owner: context.repo.owner, repo: context.repo.repo, ref: ref.commit.sha
            })
            const red = ws.some(s => s.state !== 'success')
            core.setOutput('red', red)
      - name: Freeze label & comment if red
        if: steps.status.outputs.red == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = { owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.pull_request.number }
            await github.rest.issues.addLabels({ ...issue, labels: ['freeze/main-red'] })
            await github.rest.issues.createComment({ ...issue, body: '⛔ Main is red. This PR is paused until `main` is green. Owners have been notified.' })
      - name: Notify CODEOWNERS when main red
        if: steps.status.outputs.red == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = 'Main is red; merges are frozen. Please remediate failing checks.'
            await github.rest.repos.createDispatchEvent({ owner: context.repo.owner, repo: context.repo.repo, event_type: 'main-red', client_payload: { body } })
```

> Pair this with a branch ruleset that blocks merging when `freeze/main-red` label is present (Repository Rules → Pull request → Block merge by label).

---

## OTEL Resource Attributes (tag builds, envs, PRs)

### `.ci/otel/resource-attrs.env`

```env
OTEL_SERVICE_NAME=summit
OTEL_RESOURCE_ATTRIBUTES=deployment.environment=${{ env.ENVIRONMENT }},ci.system=github,ci.workflow=${{ github.workflow }},ci.run_id=${{ github.run_id }},git.sha=${{ github.sha }},git.branch=${{ github.ref_name }},pr.number=${{ github.event.pull_request.number }}
```

- Load this file in build/test/deploy steps to make traces correlate across CI → app → deploy.

---

## Grafana Dashboards-as-Code

### `observability/grafana/dashboard_overview.json`

```json
{
  "title": "Summit — Golden Signals Overview",
  "timezone": "browser",
  "panels": [
    {
      "type": "stat",
      "title": "p95 Latency (ms)",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"summit\"}[5m])) by (le)) * 1000"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Error Rate (%)",
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{service=\"summit\",code=~\"5..\"}[5m])) / sum(rate(http_requests_total{service=\"summit\"}[5m])) * 100"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "Saturation (CPU)",
      "targets": [{ "expr": "avg(node_cpu_seconds_total{mode=\"idle\"})" }]
    }
  ],
  "schemaVersion": 39,
  "version": 1
}
```

### `observability/grafana/dashboard_slo_service.json`

```json
{
  "title": "Summit — Service SLO",
  "panels": [
    {
      "type": "timeseries",
      "title": "Latency p95 (ms)",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"summit\", environment=~\"stage|prod\"}[5m])) by (le, environment)) * 1000"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Error Budget Burn (1h/6h)",
      "targets": [
        {
          "expr": "(sum(rate(http_requests_total{service=\"summit\",code=~\"5..\",environment=\"prod\"}[1h])) / sum(rate(http_requests_total{service=\"summit\",environment=\"prod\"}[1h]))) / 0.01"
        }
      ]
    }
  ],
  "schemaVersion": 39,
  "version": 1
}
```

### `observability/grafana/alerts_slo.yaml`

```yaml
apiVersion: 1
groups:
  - name: slo-burn
    interval: 1m
    rules:
      - uid: slo-burn-fast
        title: SLO Burn > 2x (1h)
        condition: C
        data:
          - refId: A
            expr: |
              (sum(rate(http_requests_total{service="summit",code=~"5..",environment="prod"}[1h])) /
               sum(rate(http_requests_total{service="summit",environment="prod"}[1h]))) / 0.01
          - refId: C
            expr: A > 2
        for: 5m
        annotations:
          description: Error budget burn rate >2x in last hour.
          runbook_url: https://runbooks/slo
```

---

## Observability README

### `docs/observability/README.md`

```md
# Observability Setup

- Import Grafana dashboards from `observability/grafana/*.json`.
- Load `.ci/otel/resource-attrs.env` in CI and application pods.
- Configure Prometheus scrape for `/metrics` and attach `service="summit"`, `environment` labels.
- Alerts from `observability/grafana/alerts_slo.yaml` feed on-call.
```

---

## Wiring Notes

- Add a repository **Ruleset** to block merges when label `freeze/main-red` is present.
- In CI, `source ./.ci/otel/resource-attrs.env` before build/test/deploy steps (GitHub Actions supports `${{ env.* }}` interpolation via `env:` blocks).
- Grafana JSONs are intentionally minimal—expand with your service‑specific metrics and labels.
