{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Canonical Audit Event",
  "description": "Immutable, queryable, privacy-aware access auditing record",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0"
    },
    "event_id": {
      "type": "string",
      "format": "uuid"
    },
    "ts": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 timestamp"
    },
    "actor": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "enum": ["user", "svc"] },
        "roles": { "type": "array", "items": { "type": "string" } },
        "mfa": { "type": "string", "description": "e.g., webauthn, totp" }
      },
      "required": ["id", "type", "roles"]
    },
    "tenant": {
      "type": "string"
    },
    "resource": {
      "type": "object",
      "properties": {
        "type": { "type": "string" },
        "id": { "type": "string" },
        "classification": { "type": "string", "enum": ["restricted", "confidential", "internal", "public"] }
      },
      "required": ["type", "id"]
    },
    "action": {
      "type": "string",
      "enum": ["read", "get", "export", "delete", "impersonate", "admin"]
    },
    "rfa": {
      "type": "object",
      "properties": {
        "required": { "type": "boolean" },
        "reason": { "type": "string" },
        "ticket": { "type": "string" }
      }
    },
    "authz": {
      "type": "object",
      "properties": {
        "decision": { "type": "string", "enum": ["allow", "deny"] },
        "policy_bundle": { "type": "string" },
        "reasons": { "type": "array", "items": { "type": "string" } },
        "opa_trace_id": { "type": "string" }
      },
      "required": ["decision"]
    },
    "request": {
      "type": "object",
      "properties": {
        "ip": { "type": "string" },
        "ua": { "type": "string" },
        "method": { "type": "string" },
        "route": { "type": "string" }
      }
    },
    "trace": {
      "type": "object",
      "properties": {
        "trace_id": { "type": "string" },
        "span_id": { "type": "string" },
        "release": { "type": "string" }
      }
    },
    "outcome": {
      "type": "object",
      "properties": {
        "status": { "type": "string", "enum": ["success", "failure"] },
        "http": { "type": "integer" },
        "latency_ms": { "type": "number" }
      },
      "required": ["status", "http"]
    },
    "hash_chain": {
      "type": "object",
      "properties": {
        "prev": { "type": "string" },
        "self": { "type": "string" }
      }
    }
  },
  "required": [
    "version", "event_id", "ts", "actor", "tenant", "resource", "action", "authz", "outcome"
  ]
}
