a49e0f65cd2d0e2cabea66ea5676393c
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.redactData = redactData;
const pino_1 = __importDefault(require("pino"));
const logger = (0, pino_1.default)();
// Define PII types and their associated properties/paths
// This should ideally be driven by a central schema or configuration
const PII_DEFINITIONS = {
    EMAIL: ['email', 'properties.email'],
    PHONE: ['phone', 'properties.phone'],
    SSN: ['ssn', 'properties.ssn'],
    CREDIT_CARD: ['creditCard', 'properties.creditCard'],
    NAME: ['name', 'label', 'properties.name'],
    ADDRESS: ['address', 'properties.address'],
    IP_ADDRESS: ['ipAddress', 'properties.ipAddress'],
    DATE_OF_BIRTH: ['dob', 'properties.dob'],
    // Add more as needed
};
// Define redaction strategies
var RedactionStrategy;
(function (RedactionStrategy) {
    RedactionStrategy["REDACT"] = "[REDACTED]";
    RedactionStrategy["MASK_PARTIAL"] = "MASK_PARTIAL";
    RedactionStrategy["HASH"] = "HASH";
    RedactionStrategy[RedactionStrategy["NULL"] = null] = "NULL";
})(RedactionStrategy || (RedactionStrategy = {}));
// Define roles and their associated redaction policies
// This is a simplified example; a real system would have more granular policies
const REDACTION_POLICIES_BY_ROLE = {
    ADMIN: {
    // Admins see everything, no redaction by default
    },
    ANALYST: {
        EMAIL: RedactionStrategy.MASK_PARTIAL,
        PHONE: RedactionStrategy.MASK_PARTIAL,
        SSN: RedactionStrategy.REDACT,
        CREDIT_CARD: RedactionStrategy.REDACT,
        // Other PII types might not be redacted for analysts
    },
    VIEWER: {
        EMAIL: RedactionStrategy.REDACT,
        PHONE: RedactionStrategy.REDACT,
        SSN: RedactionStrategy.REDACT,
        CREDIT_CARD: RedactionStrategy.REDACT,
        NAME: RedactionStrategy.MASK_PARTIAL,
        ADDRESS: RedactionStrategy.REDACT,
        IP_ADDRESS: RedactionStrategy.REDACT,
        DATE_OF_BIRTH: RedactionStrategy.REDACT,
    },
};
/**
 * Redacts PII from data based on user role and defined policies.
 * @param data The data object to redact.
 * @param user The user performing the export.
 * @param sensitivity Optional sensitivity level for the data (e.g., 'high', 'medium').
 * @returns The redacted data object.
 */
function redactData(data, user, sensitivity) {
    if (!data)
        return data;
    const userRole = user.role || 'VIEWER'; // Default to VIEWER if no role
    const policy = REDACTION_POLICIES_BY_ROLE[userRole.toUpperCase()] || {};
    // Deep clone data to avoid modifying original object
    const redactedData = JSON.parse(JSON.stringify(data));
    let piiRedactedCount = 0;
    const piiFieldsRedacted = [];
    const applyRedaction = (obj, path) => {
        if (typeof obj !== 'object' || obj === null)
            return;
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                const currentPath = [...path, key];
                const fullPath = currentPath.join('.');
                for (const piiType in PII_DEFINITIONS) {
                    const piiPaths = PII_DEFINITIONS[piiType];
                    if (piiPaths.includes(fullPath)) {
                        const strategy = policy[piiType];
                        if (strategy) {
                            obj[key] = applyStrategy(obj[key], piiType, strategy);
                            piiRedactedCount++;
                            piiFieldsRedacted.push(fullPath);
                            logger.debug(`Redacted PII field: ${fullPath} with strategy: ${strategy}`);
                        }
                    }
                }
                // Recursively apply redaction to nested objects/arrays
                if (typeof obj[key] === 'object') {
                    applyRedaction(obj[key], currentPath);
                }
            }
        }
    };
    applyRedaction(redactedData, []);
    logger.info(`Data redaction complete for user ${user.id} (role: ${userRole}). Redacted ${piiRedactedCount} PII fields.`);
    // You might want to audit this redaction event
    // auditService.logRedaction(user.id, userRole, piiFieldsRedacted, sensitivity);
    return redactedData;
}
function applyStrategy(value, piiType, strategy) {
    if (value === undefined || value === null)
        return value;
    switch (strategy) {
        case RedactionStrategy.REDACT:
            return RedactionStrategy.REDACT;
        case RedactionStrategy.MASK_PARTIAL:
            return maskPartial(String(value), piiType);
        case RedactionStrategy.HASH:
            return hashValue(String(value));
        case RedactionStrategy.NULL:
            return null;
        default:
            return value;
    }
}
function maskPartial(value, piiType) {
    switch (piiType) {
        case 'EMAIL':
            const atIndex = value.indexOf('@');
            if (atIndex > 0) {
                return `${value.substring(0, 3)}***${value.substring(atIndex)}`;
            }
            return '***';
        case 'PHONE':
            if (value.length > 4) {
                return `***-***-${value.substring(value.length - 4)}`;
            }
            return '***';
        case 'NAME':
            if (value.length > 2) {
                return `${value.substring(0, 1)}***${value.substring(value.length - 1)}`;
            }
            return '***';
        default:
            return '[MASKED]';
    }
}
function hashValue(value) {
    // In a real application, use a strong, secure hashing algorithm
    // For demonstration, a simple SHA-256 like hash
    const crypto = require('crypto');
    return crypto.createHash('sha256').update(value).digest('hex');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvdXRpbHMvZGF0YVJlZGFjdGlvbi50cyIsIm1hcHBpbmdzIjoiOzs7OztBQTJEQSxnQ0FnREM7QUExR0QsZ0RBQXdCO0FBRXhCLE1BQU0sTUFBTSxHQUFHLElBQUEsY0FBSSxHQUFFLENBQUM7QUFFdEIseURBQXlEO0FBQ3pELHFFQUFxRTtBQUNyRSxNQUFNLGVBQWUsR0FBRztJQUN0QixLQUFLLEVBQUUsQ0FBQyxPQUFPLEVBQUUsa0JBQWtCLENBQUM7SUFDcEMsS0FBSyxFQUFFLENBQUMsT0FBTyxFQUFFLGtCQUFrQixDQUFDO0lBQ3BDLEdBQUcsRUFBRSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQztJQUM5QixXQUFXLEVBQUUsQ0FBQyxZQUFZLEVBQUUsdUJBQXVCLENBQUM7SUFDcEQsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsQ0FBQztJQUMxQyxPQUFPLEVBQUUsQ0FBQyxTQUFTLEVBQUUsb0JBQW9CLENBQUM7SUFDMUMsVUFBVSxFQUFFLENBQUMsV0FBVyxFQUFFLHNCQUFzQixDQUFDO0lBQ2pELGFBQWEsRUFBRSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQztJQUN4QyxxQkFBcUI7Q0FDdEIsQ0FBQztBQUVGLDhCQUE4QjtBQUM5QixJQUFLLGlCQUtKO0FBTEQsV0FBSyxpQkFBaUI7SUFDcEIsMENBQXFCLENBQUE7SUFDckIsa0RBQTZCLENBQUE7SUFDN0Isa0NBQWEsQ0FBQTtJQUNiLDhDQUFPLElBQUksVUFBQSxDQUFBO0FBQ2IsQ0FBQyxFQUxJLGlCQUFpQixLQUFqQixpQkFBaUIsUUFLckI7QUFFRCx1REFBdUQ7QUFDdkQsZ0ZBQWdGO0FBQ2hGLE1BQU0sMEJBQTBCLEdBQUc7SUFDakMsS0FBSyxFQUFFO0lBQ0wsaURBQWlEO0tBQ2xEO0lBQ0QsT0FBTyxFQUFFO1FBQ1AsS0FBSyxFQUFFLGlCQUFpQixDQUFDLFlBQVk7UUFDckMsS0FBSyxFQUFFLGlC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S0FBSyxDQUFDO1FBQ2YsS0FBSyxPQUFPO1lBQ1YsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNyQixPQUFPLFdBQVcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDeEQsQ0FBQztZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsS0FBSyxNQUFNO1lBQ1QsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNyQixPQUFPLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDM0UsQ0FBQztZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2Y7WUFDRSxPQUFPLFVBQVUsQ0FBQztJQUN0QixDQUFDO0FBQ0gsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLEtBQWE7SUFDOUIsZ0VBQWdFO0lBQ2hFLGdEQUFnRDtJQUNoRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakMsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDakUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvYnJpYW5sb25nL0RldmVsb3Blci9zdW1taXQvc2VydmVyL3NyYy91dGlscy9kYXRhUmVkYWN0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi90eXBlcy9jb250ZXh0JzsgLy8gQXNzdW1pbmcgVXNlciB0eXBlIGlzIGRlZmluZWQgaGVyZVxuaW1wb3J0IHBpbm8gZnJvbSAncGlubyc7XG5cbmNvbnN0IGxvZ2dlciA9IHBpbm8oKTtcblxuLy8gRGVmaW5lIFBJSSB0eXBlcyBhbmQgdGhlaXIgYXNzb2NpYXRlZCBwcm9wZXJ0aWVzL3BhdGhzXG4vLyBUaGlzIHNob3VsZCBpZGVhbGx5IGJlIGRyaXZlbiBieSBhIGNlbnRyYWwgc2NoZW1hIG9yIGNvbmZpZ3VyYXRpb25cbmNvbnN0IFBJSV9ERUZJTklUSU9OUyA9IHtcbiAgRU1BSUw6IFsnZW1haWwnLCAncHJvcGVydGllcy5lbWFpbCddLFxuICBQSE9ORTogWydwaG9uZScsICdwcm9wZXJ0aWVzLnBob25lJ10sXG4gIFNTTjogWydzc24nLCAncHJvcGVydGllcy5zc24nXSxcbiAgQ1JFRElUX0NBUkQ6IFsnY3JlZGl0Q2FyZCcsICdwcm9wZXJ0aWVzLmNyZWRpdENhcmQnXSxcbiAgTkFNRTogWyduYW1lJywgJ2xhYmVsJywgJ3Byb3BlcnRpZXMubmFtZSddLFxuICBBRERSRVNTOiBbJ2FkZHJlc3MnLCAncHJvcGVydGllcy5hZGRyZXNzJ10sXG4gIElQX0FERFJFU1M6IFsnaXBBZGRyZXNzJywgJ3Byb3BlcnRpZXMuaXBBZGRyZXNzJ10sXG4gIERBVEVfT0ZfQklSVEg6IFsnZG9iJywgJ3Byb3BlcnRpZXMuZG9iJ10sXG4gIC8vIEFkZCBtb3JlIGFzIG5lZWRlZFxufTtcblxuLy8gRGVmaW5lIHJlZGFjdGlvbiBzdHJhdGVnaWVzXG5lbnVtIFJlZGFjdGlvblN0cmF0ZWd5IHtcbiAgUkVEQUNUID0gJ1tSRURBQ1RFRF0nLFxuICBNQVNLX1BBUlRJQUwgPSAnTUFTS19QQVJUSUFMJywgLy8gZS5nLiwgZW1haWw6IHVzZXIqKipAZXhhbXBsZS5jb21cbiAgSEFTSCA9ICdIQVNIJywgLy8gZS5nLiwgZW1haWw6IHNoYTI1Nih1c2VyQGV4YW1wbGUuY29tKVxuICBOVUxMID0gbnVsbCxcbn1cblxuLy8gRGVmaW5lIHJvbGVzIGFuZCB0aGVpciBhc3NvY2lhdGVkIHJlZGFjdGlvbiBwb2xpY2llc1xuLy8gVGhpcyBpcyBhIHNpbXBsaWZpZWQgZXhhbXBsZTsgYSByZWFsIHN5c3RlbSB3b3VsZCBoYXZlIG1vcmUgZ3JhbnVsYXIgcG9saWNpZXNcbmNvbnN0IFJFREFDVElPTl9QT0xJQ0lFU19CWV9ST0xFID0ge1xuICBBRE1JTjoge1xuICAgIC8vIEFkbWlucyBzZWUgZXZlcnl0aGluZywgbm8gcmVkYWN0aW9uIGJ5IGRlZmF1bHRcbiAgfSxcbiAgQU5BTFlTVDoge1xuICAgIEVNQUlMOiBSZWRhY3Rpb25TdHJhdGVneS5NQVNLX1BBUlRJQUwsXG4gICAgUEhPTkU6IFJlZGFjdGlvblN0cmF0ZWd5Lk1BU0tfUEFSVElBTCxcbiAgICBTU046IFJlZGFjdGlvblN0cmF0ZWd5LlJFREFDVCxcbiAgICBDUkVESVRfQ0FSRDogUmVkYWN0aW9uU3RyYXRlZ3kuUkVEQUNULFxuICAgIC8vIE90aGVyIFBJSSB0eXBlcyBtaWdodCBub3QgYmUgcmVkYWN0ZWQgZm9yIGFuYWx5c3RzXG4gIH0sXG4gIFZJRVdFUjoge1xuICAgIEVNQUlMOiBSZWRhY3Rpb25TdHJhdGVneS5SRURBQ1QsXG4gICAgUEhPTkU6IFJlZGFjdGlvblN0cmF0ZWd5LlJFREFDVCxcbiAgICBTU046IFJlZGFjdGlvblN0cmF0ZWd5LlJFREFDVCxcbiAgICBDUkVESVRfQ0FSRDogUmVkYWN0aW9uU3RyYXRlZ3kuUkVEQUNULFxuICAgIE5BTUU6IFJlZGFjdGlvblN0cmF0ZWd5Lk1BU0tfUEFSVElBTCxcbiAgICBBRERSRVNTOiBSZWRhY3Rpb25TdHJhdGVneS5SRURBQ1QsXG4gICAgSVBfQUREUkVTUzogUmVkYWN0aW9uU3RyYXRlZ3kuUkVEQUNULFxuICAgIERBVEVfT0ZfQklSVEg6IFJlZGFjdGlvblN0cmF0ZWd5LlJFREFDVCxcbiAgfSxcbn07XG5cbi8qKlxuICogUmVkYWN0cyBQSUkgZnJvbSBkYXRhIGJhc2VkIG9uIHVzZXIgcm9sZSBhbmQgZGVmaW5lZCBwb2xpY2llcy5cbiAqIEBwYXJhbSBkYXRhIFRoZSBkYXRhIG9iamVjdCB0byByZWRhY3QuXG4gKiBAcGFyYW0gdXNlciBUaGUgdXNlciBwZXJmb3JtaW5nIHRoZSBleHBvcnQuXG4gKiBAcGFyYW0gc2Vuc2l0aXZpdHkgT3B0aW9uYWwgc2Vuc2l0aXZpdHkgbGV2ZWwgZm9yIHRoZSBkYXRhIChlLmcuLCAnaGlnaCcsICdtZWRpdW0nKS5cbiAqIEByZXR1cm5zIFRoZSByZWRhY3RlZCBkYXRhIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlZGFjdERhdGEoZGF0YTogYW55LCB1c2VyOiBVc2VyLCBzZW5zaXRpdml0eT86IHN0cmluZyk6IGFueSB7XG4gIGlmICghZGF0YSkgcmV0dXJuIGRhdGE7XG5cbiAgY29uc3QgdXNlclJvbGUgPSB1c2VyLnJvbGUgfHwgJ1ZJRVdFUic7IC8vIERlZmF1bHQgdG8gVklFV0VSIGlmIG5vIHJvbGVcbiAgY29uc3QgcG9saWN5ID0gUkVEQUNUSU9OX1BPTElDSUVTX0JZX1JPTEVbdXNlclJvbGUudG9VcHBlckNhc2UoKV0gfHwge307XG5cbiAgLy8gRGVlcCBjbG9uZSBkYXRhIHRvIGF2b2lkIG1vZGlmeWluZyBvcmlnaW5hbCBvYmplY3RcbiAgY29uc3QgcmVkYWN0ZWREYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkYXRhKSk7XG5cbiAgbGV0IHBpaVJlZGFjdGVkQ291bnQgPSAwO1xuICBjb25zdCBwaWlGaWVsZHNSZWRhY3RlZDogc3RyaW5nW10gPSBbXTtcblxuICBjb25zdCBhcHBseVJlZGFjdGlvbiA9IChvYmo6IGFueSwgcGF0aDogc3RyaW5nW10pID0+IHtcbiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsKSByZXR1cm47XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmopIHtcbiAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb25zdCBjdXJyZW50UGF0aCA9IFsuLi5wYXRoLCBrZXldO1xuICAgICAgICBjb25zdCBmdWxsUGF0aCA9IGN1cnJlbnRQYXRoLmpvaW4oJy4nKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHBpaVR5cGUgaW4gUElJX0RFRklOSVRJT05TKSB7XG4gICAgICAgICAgY29uc3QgcGlpUGF0aHMgPSBQSUlfREVGSU5JVElPTlNbcGlpVHlwZSBhcyBrZXlvZiB0eXBlb2YgUElJX0RFRklOSVRJT05TXTtcbiAgICAgICAgICBpZiAocGlpUGF0aHMuaW5jbHVkZXMoZnVsbFBhdGgpKSB7XG4gICAgICAgICAgICBjb25zdCBzdHJhdGVneSA9IHBvbGljeVtwaWlUeXBlIGFzIGtleW9mIHR5cGVvZiBwb2xpY3ldO1xuICAgICAgICAgICAgaWYgKHN0cmF0ZWd5KSB7XG4gICAgICAgICAgICAgIG9ialtrZXldID0gYXBwbHlTdHJhdGVneShvYmpba2V5XSwgcGlpVHlwZSBhcyBrZXlvZiB0eXBlb2YgUElJX0RFRklOSVRJT05TLCBzdHJhdGVneSk7XG4gICAgICAgICAgICAgIHBpaVJlZGFjdGVkQ291bnQrKztcbiAgICAgICAgICAgICAgcGlpRmllbGRzUmVkYWN0ZWQucHVzaChmdWxsUGF0aCk7XG4gICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgUmVkYWN0ZWQgUElJIGZpZWxkOiAke2Z1bGxQYXRofSB3aXRoIHN0cmF0ZWd5OiAke3N0cmF0ZWd5fWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlY3Vyc2l2ZWx5IGFwcGx5IHJlZGFjdGlvbiB0byBuZXN0ZWQgb2JqZWN0cy9hcnJheXNcbiAgICAgICAgaWYgKHR5cGVvZiBvYmpba2V5XSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICBhcHBseVJlZGFjdGlvbihvYmpba2V5XSwgY3VycmVudFBhdGgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGFwcGx5UmVkYWN0aW9uKHJlZGFjdGVkRGF0YSwgW10pO1xuXG4gIGxvZ2dlci5pbmZvKGBEYXRhIHJlZGFjdGlvbiBjb21wbGV0ZSBmb3IgdXNlciAke3VzZXIuaWR9IChyb2xlOiAke3VzZXJSb2xlfSkuIFJlZGFjdGVkICR7cGlpUmVkYWN0ZWRDb3VudH0gUElJIGZpZWxkcy5gKTtcbiAgLy8gWW91IG1pZ2h0IHdhbnQgdG8gYXVkaXQgdGhpcyByZWRhY3Rpb24gZXZlbnRcbiAgLy8gYXVkaXRTZXJ2aWNlLmxvZ1JlZGFjdGlvbih1c2VyLmlkLCB1c2VyUm9sZSwgcGlpRmllbGRzUmVkYWN0ZWQsIHNlbnNpdGl2aXR5KTtcblxuICByZXR1cm4gcmVkYWN0ZWREYXRhO1xufVxuXG5mdW5jdGlvbiBhcHBseVN0cmF0ZWd5KHZhbHVlOiBhbnksIHBpaVR5cGU6IGtleW9mIHR5cGVvZiBQSUlfREVGSU5JVElPTlMsIHN0cmF0ZWd5OiBSZWRhY3Rpb25TdHJhdGVneSk6IGFueSB7XG4gIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSByZXR1cm4gdmFsdWU7XG5cbiAgc3dpdGNoIChzdHJhdGVneSkge1xuICAgIGNhc2UgUmVkYWN0aW9uU3RyYXRlZ3kuUkVEQUNUOlxuICAgICAgcmV0dXJuIFJlZGFjdGlvblN0cmF0ZWd5LlJFREFDVDtcbiAgICBjYXNlIFJlZGFjdGlvblN0cmF0ZWd5Lk1BU0tfUEFSVElBTDpcbiAgICAgIHJldHVybiBtYXNrUGFydGlhbChTdHJpbmcodmFsdWUpLCBwaWlUeXBlKTtcbiAgICBjYXNlIFJlZGFjdGlvblN0cmF0ZWd5LkhBU0g6XG4gICAgICByZXR1cm4gaGFzaFZhbHVlKFN0cmluZyh2YWx1ZSkpO1xuICAgIGNhc2UgUmVkYWN0aW9uU3RyYXRlZ3kuTlVMTDpcbiAgICAgIHJldHVybiBudWxsO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdmFsdWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gbWFza1BhcnRpYWwodmFsdWU6IHN0cmluZywgcGlpVHlwZToga2V5b2YgdHlwZW9mIFBJSV9ERUZJTklUSU9OUyk6IHN0cmluZyB7XG4gIHN3aXRjaCAocGlpVHlwZSkge1xuICAgIGNhc2UgJ0VNQUlMJzpcbiAgICAgIGNvbnN0IGF0SW5kZXggPSB2YWx1ZS5pbmRleE9mKCdAJyk7XG4gICAgICBpZiAoYXRJbmRleCA+IDApIHtcbiAgICAgICAgcmV0dXJuIGAke3ZhbHVlLnN1YnN0cmluZygwLCAzKX0qKioke3ZhbHVlLnN1YnN0cmluZyhhdEluZGV4KX1gO1xuICAgICAgfVxuICAgICAgcmV0dXJuICcqKionO1xuICAgIGNhc2UgJ1BIT05FJzpcbiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiA0KSB7XG4gICAgICAgIHJldHVybiBgKioqLSoqKi0ke3ZhbHVlLnN1YnN0cmluZyh2YWx1ZS5sZW5ndGggLSA0KX1gO1xuICAgICAgfVxuICAgICAgcmV0dXJuICcqKionO1xuICAgIGNhc2UgJ05BTUUnOlxuICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgcmV0dXJuIGAke3ZhbHVlLnN1YnN0cmluZygwLCAxKX0qKioke3ZhbHVlLnN1YnN0cmluZyh2YWx1ZS5sZW5ndGggLSAxKX1gO1xuICAgICAgfVxuICAgICAgcmV0dXJuICcqKionO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gJ1tNQVNLRURdJztcbiAgfVxufVxuXG5mdW5jdGlvbiBoYXNoVmFsdWUodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG4gIC8vIEluIGEgcmVhbCBhcHBsaWNhdGlvbiwgdXNlIGEgc3Ryb25nLCBzZWN1cmUgaGFzaGluZyBhbGdvcml0aG1cbiAgLy8gRm9yIGRlbW9uc3RyYXRpb24sIGEgc2ltcGxlIFNIQS0yNTYgbGlrZSBoYXNoXG4gIGNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuICByZXR1cm4gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZSh2YWx1ZSkuZGlnZXN0KCdoZXgnKTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==