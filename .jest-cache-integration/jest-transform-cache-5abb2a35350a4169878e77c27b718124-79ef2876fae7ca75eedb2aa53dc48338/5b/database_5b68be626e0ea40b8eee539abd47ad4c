695f34b4c73b1c0757c9f15465f62db4
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.connectNeo4j = connectNeo4j;
exports.connectPostgres = connectPostgres;
exports.connectRedis = connectRedis;
exports.getNeo4jDriver = getNeo4jDriver;
exports.getPostgresPool = getPostgresPool;
exports.getRedisClient = getRedisClient;
exports.closeConnections = closeConnections;
const neo4j_driver_1 = __importDefault(require("neo4j-driver"));
const pg_1 = require("pg");
const ioredis_1 = __importDefault(require("ioredis"));
const index_js_1 = __importDefault(require("./index.js"));
const logger_js_1 = __importDefault(require("../utils/logger.js"));
let neo4jDriver = null;
let postgresPool = null;
let redisClient = null;
// Neo4j Connection
async function connectNeo4j() {
    try {
        neo4jDriver = neo4j_driver_1.default.driver(index_js_1.default.neo4j.uri, neo4j_driver_1.default.auth.basic(index_js_1.default.neo4j.username, index_js_1.default.neo4j.password));
        // Test connection
        const session = neo4jDriver.session();
        await session.run("RETURN 1");
        await session.close();
        // Run migrations to set up constraints and indexes
        await runNeo4jMigrations();
        logger_js_1.default.info("✅ Connected to Neo4j");
        return neo4jDriver;
    }
    catch (error) {
        logger_js_1.default.error("❌ Failed to connect to Neo4j:", error);
        throw error;
    }
}
async function runNeo4jMigrations() {
    try {
        // Import migration manager lazily to avoid circular dependencies
        const { migrationManager } = await Promise.resolve().then(() => __importStar(require("../db/migrations/index.js")));
        await migrationManager.migrate();
        logger_js_1.default.info("Neo4j migrations completed successfully");
    }
    catch (error) {
        logger_js_1.default.warn("Migration system not available, falling back to legacy constraints");
        await createNeo4jConstraints();
    }
}
async function createNeo4jConstraints() {
    if (!neo4jDriver)
        throw new Error("Neo4j driver not initialized");
    const session = neo4jDriver.session();
    try {
        const constraints = [
            "CREATE CONSTRAINT entity_id IF NOT EXISTS FOR (e:Entity) REQUIRE e.id IS UNIQUE",
            "CREATE CONSTRAINT entity_uuid IF NOT EXISTS FOR (e:Entity) REQUIRE e.uuid IS UNIQUE",
            "CREATE CONSTRAINT user_id IF NOT EXISTS FOR (u:User) REQUIRE u.id IS UNIQUE",
            "CREATE CONSTRAINT user_email IF NOT EXISTS FOR (u:User) REQUIRE u.email IS UNIQUE",
            "CREATE CONSTRAINT investigation_id IF NOT EXISTS FOR (i:Investigation) REQUIRE i.id IS UNIQUE",
            "CREATE CONSTRAINT relationship_id IF NOT EXISTS FOR ()-[r:RELATIONSHIP]-() REQUIRE r.id IS UNIQUE",
        ];
        for (const constraint of constraints) {
            try {
                await session.run(constraint);
            }
            catch (error) {
                if (!error.message.includes("already exists")) {
                    logger_js_1.default.warn("Failed to create constraint:", constraint, error.message);
                }
            }
        }
        const indexes = [
            "CREATE INDEX entity_type IF NOT EXISTS FOR (e:Entity) ON (e.type)",
            "CREATE INDEX entity_label IF NOT EXISTS FOR (e:Entity) ON (e.label)",
            "CREATE INDEX entity_created IF NOT EXISTS FOR (e:Entity) ON (e.createdAt)",
            "CREATE INDEX investigation_status IF NOT EXISTS FOR (i:Investigation) ON (i.status)",
            "CREATE INDEX user_username IF NOT EXISTS FOR (u:User) ON (u.username)",
            "CREATE FULLTEXT INDEX entity_search IF NOT EXISTS FOR (e:Entity) ON EACH [e.label, e.description]",
            "CREATE FULLTEXT INDEX investigation_search IF NOT EXISTS FOR (i:Investigation) ON EACH [i.title, i.description]",
        ];
        for (const index of indexes) {
            try {
                await session.run(index);
            }
            catch (error) {
                if (!error.message.includes("already exists")) {
                    logger_js_1.default.warn("Failed to create index:", index, error.message);
                }
            }
        }
        logger_js_1.default.info("Neo4j constraints and indexes created");
    }
    catch (error) {
        logger_js_1.default.error("Failed to create Neo4j constraints:", error);
    }
    finally {
        await session.close();
    }
}
// PostgreSQL Connection
async function connectPostgres() {
    try {
        postgresPool = new pg_1.Pool({
            host: index_js_1.default.postgres.host,
            port: index_js_1.default.postgres.port,
            database: index_js_1.default.postgres.database,
            user: index_js_1.default.postgres.username,
            password: index_js_1.default.postgres.password,
            max: 20,
            idleTimeoutMillis: 30000,
            connectionTimeoutMillis: 2000,
        });
        const client = await postgresPool.connect();
        await client.query("SELECT NOW()");
        client.release();
        await createPostgresTables();
        logger_js_1.default.info("✅ Connected to PostgreSQL");
        return postgresPool;
    }
    catch (error) {
        logger_js_1.default.error("❌ Failed to connect to PostgreSQL:", error);
        throw error;
    }
}
async function createPostgresTables() {
    if (!postgresPool)
        throw new Error("PostgreSQL pool not initialized");
    const client = await postgresPool.connect();
    try {
        // Users table
        await client.query(`
      CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        email VARCHAR(255) UNIQUE NOT NULL,
        username VARCHAR(100) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        first_name VARCHAR(100) NOT NULL,
        last_name VARCHAR(100) NOT NULL,
        role VARCHAR(50) NOT NULL DEFAULT 'ANALYST',
        is_active BOOLEAN DEFAULT true,
        last_login TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
        // Audit logs table
        await client.query(`
      CREATE TABLE IF NOT EXISTS audit_logs (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID REFERENCES users(id),
        action VARCHAR(100) NOT NULL,
        resource_type VARCHAR(100) NOT NULL,
        resource_id VARCHAR(255),
        details JSONB,
        ip_address INET,
        user_agent TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
        // Sessions table
        await client.query(`
      CREATE TABLE IF NOT EXISTS user_sessions (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID REFERENCES users(id) ON DELETE CASCADE,
        refresh_token VARCHAR(500) UNIQUE NOT NULL,
        expires_at TIMESTAMP NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        last_used TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
        // Analysis results table
        await client.query(`
      CREATE TABLE IF NOT EXISTS analysis_results (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        investigation_id VARCHAR(255) NOT NULL,
        analysis_type VARCHAR(100) NOT NULL,
        algorithm VARCHAR(100) NOT NULL,
        results JSONB NOT NULL,
        confidence_score DECIMAL(3,2),
        created_by UUID REFERENCES users(id),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
        await client.query("CREATE INDEX IF NOT EXISTS idx_audit_logs_user_id ON audit_logs(user_id)");
        await client.query("CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at)");
        await client.query("CREATE INDEX IF NOT EXISTS idx_sessions_user_id ON user_sessions(user_id)");
        await client.query("CREATE INDEX IF NOT EXISTS idx_analysis_investigation ON analysis_results(investigation_id)");
        logger_js_1.default.info("PostgreSQL tables created");
    }
    catch (error) {
        logger_js_1.default.error("Failed to create PostgreSQL tables:", error);
    }
    finally {
        client.release();
    }
}
// Redis Connection
async function connectRedis() {
    try {
        const redisConfig = {
            host: index_js_1.default.redis.host,
            port: index_js_1.default.redis.port,
            db: index_js_1.default.redis.db,
            retryDelayOnFailover: 100,
            maxRetriesPerRequest: 3,
            connectTimeout: 10000,
            lazyConnect: true,
            keepAlive: 30000,
            family: 4,
            enableOfflineQueue: false,
            reconnectOnError: (err) => {
                const targetError = "READONLY";
                return err.message.includes(targetError);
            },
            retryStrategy: (times) => {
                const delay = Math.min(times * 50, 2000);
                return delay;
            },
        };
        // Add password if provided
        if (index_js_1.default.redis.password) {
            redisConfig.password = index_js_1.default.redis.password;
        }
        redisClient = new ioredis_1.default(redisConfig);
        redisClient.on("error", (error) => {
            logger_js_1.default.error("Redis error:", error.message);
        });
        redisClient.on("connect", () => {
            logger_js_1.default.info("Redis connected");
        });
        redisClient.on("ready", () => {
            logger_js_1.default.info("✅ Redis ready");
        });
        redisClient.on("reconnecting", () => {
            logger_js_1.default.info("Redis reconnecting...");
        });
        redisClient.on("end", () => {
            logger_js_1.default.warn("Redis connection ended");
        });
        await redisClient.connect();
        await redisClient.ping();
        logger_js_1.default.info("✅ Connected to Redis");
        return redisClient;
    }
    catch (error) {
        logger_js_1.default.error("❌ Failed to connect to Redis:", error.message);
        // Don't throw error to allow server to start without Redis if needed
        logger_js_1.default.warn("Server will continue without Redis caching");
        return null;
    }
}
function getNeo4jDriver() {
    if (!neo4jDriver)
        throw new Error("Neo4j driver not initialized");
    return neo4jDriver;
}
function getPostgresPool() {
    if (!postgresPool)
        throw new Error("PostgreSQL pool not initialized");
    return postgresPool;
}
function getRedisClient() {
    if (!redisClient) {
        logger_js_1.default.warn("Redis client not available");
        return null;
    }
    return redisClient;
}
async function closeConnections() {
    if (neo4jDriver) {
        await neo4jDriver.close();
        logger_js_1.default.info("Neo4j connection closed");
    }
    if (postgresPool) {
        await postgresPool.end();
        logger_js_1.default.info("PostgreSQL connection closed");
    }
    if (redisClient) {
        redisClient.disconnect();
        logger_js_1.default.info("Redis connection closed");
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvY29uZmlnL2RhdGFiYXNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBMFRFLG9DQUFZO0FBQ1osMENBQWU7QUFDZixvQ0FBWTtBQUNaLHdDQUFjO0FBQ2QsMENBQWU7QUFDZix3Q0FBYztBQUNkLDRDQUFnQjtBQWhVbEIsZ0VBQXNEO0FBQ3RELDJCQUFzQztBQUN0QyxzREFBNEI7QUFDNUIsMERBQWdDO0FBQ2hDLG1FQUF3QztBQUV4QyxJQUFJLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0FBQ3RDLElBQUksWUFBWSxHQUFnQixJQUFJLENBQUM7QUFDckMsSUFBSSxXQUFXLEdBQWlCLElBQUksQ0FBQztBQUVyQyxtQkFBbUI7QUFDbkIsS0FBSyxVQUFVLFlBQVk7SUFDekIsSUFBSSxDQUFDO1FBQ0gsV0FBVyxHQUFHLHNCQUFLLENBQUMsTUFBTSxDQUN4QixrQkFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQ2hCLHNCQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsa0JBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQy9ELENBQUM7UUFFRixrQkFBa0I7UUFDbEIsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUV0QixtREFBbUQ7UUFDbkQsTUFBTSxrQkFBa0IsRUFBRSxDQUFDO1FBRTNCLG1CQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDcEMsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixtQkFBTSxDQUFDLEtBQUssQ0FBQywrQkFB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O1FBQ2pCLE1BQU0sWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLG1CQUFNLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUNELElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3pCLG1CQUFNLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDekMsQ0FBQztBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2JyaWFubG9uZy9EZXZlbG9wZXIvc3VtbWl0L3NlcnZlci9zcmMvY29uZmlnL2RhdGFiYXNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZW80aiwgeyBEcml2ZXIsIFNlc3Npb24gfSBmcm9tIFwibmVvNGotZHJpdmVyXCI7XG5pbXBvcnQgeyBQb29sLCBQb29sQ2xpZW50IH0gZnJvbSBcInBnXCI7XG5pbXBvcnQgUmVkaXMgZnJvbSBcImlvcmVkaXNcIjtcbmltcG9ydCBjb25maWcgZnJvbSBcIi4vaW5kZXguanNcIjtcbmltcG9ydCBsb2dnZXIgZnJvbSBcIi4uL3V0aWxzL2xvZ2dlci5qc1wiO1xuXG5sZXQgbmVvNGpEcml2ZXI6IERyaXZlciB8IG51bGwgPSBudWxsO1xubGV0IHBvc3RncmVzUG9vbDogUG9vbCB8IG51bGwgPSBudWxsO1xubGV0IHJlZGlzQ2xpZW50OiBSZWRpcyB8IG51bGwgPSBudWxsO1xuXG4vLyBOZW80aiBDb25uZWN0aW9uXG5hc3luYyBmdW5jdGlvbiBjb25uZWN0TmVvNGooKTogUHJvbWlzZTxEcml2ZXI+IHtcbiAgdHJ5IHtcbiAgICBuZW80akRyaXZlciA9IG5lbzRqLmRyaXZlcihcbiAgICAgIGNvbmZpZy5uZW80ai51cmksXG4gICAgICBuZW80ai5hdXRoLmJhc2ljKGNvbmZpZy5uZW80ai51c2VybmFtZSwgY29uZmlnLm5lbzRqLnBhc3N3b3JkKSxcbiAgICApO1xuXG4gICAgLy8gVGVzdCBjb25uZWN0aW9uXG4gICAgY29uc3Qgc2Vzc2lvbiA9IG5lbzRqRHJpdmVyLnNlc3Npb24oKTtcbiAgICBhd2FpdCBzZXNzaW9uLnJ1bihcIlJFVFVSTiAxXCIpO1xuICAgIGF3YWl0IHNlc3Npb24uY2xvc2UoKTtcblxuICAgIC8vIFJ1biBtaWdyYXRpb25zIHRvIHNldCB1cCBjb25zdHJhaW50cyBhbmQgaW5kZXhlc1xuICAgIGF3YWl0IHJ1bk5lbzRqTWlncmF0aW9ucygpO1xuXG4gICAgbG9nZ2VyLmluZm8oXCLinIUgQ29ubmVjdGVkIHRvIE5lbzRqXCIpO1xuICAgIHJldHVybiBuZW80akRyaXZlcjtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCLinYwgRmFpbGVkIHRvIGNvbm5lY3QgdG8gTmVvNGo6XCIsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBydW5OZW80ak1pZ3JhdGlvbnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgLy8gSW1wb3J0IG1pZ3JhdGlvbiBtYW5hZ2VyIGxhemlseSB0byBhdm9pZCBjaXJjdWxhciBkZXBlbmRlbmNpZXNcbiAgICBjb25zdCB7IG1pZ3JhdGlvbk1hbmFnZXIgfSA9IGF3YWl0IGltcG9ydChcIi4uL2RiL21pZ3JhdGlvbnMvaW5kZXguanNcIik7XG4gICAgYXdhaXQgbWlncmF0aW9uTWFuYWdlci5taWdyYXRlKCk7XG4gICAgbG9nZ2VyLmluZm8oXCJOZW80aiBtaWdyYXRpb25zIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHlcIik7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLndhcm4oXG4gICAgICBcIk1pZ3JhdGlvbiBzeXN0ZW0gbm90IGF2YWlsYWJsZSwgZmFsbGluZyBiYWNrIHRvIGxlZ2FjeSBjb25zdHJhaW50c1wiLFxuICAgICk7XG4gICAgYXdhaXQgY3JlYXRlTmVvNGpDb25zdHJhaW50cygpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZU5lbzRqQ29uc3RyYWludHMoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGlmICghbmVvNGpEcml2ZXIpIHRocm93IG5ldyBFcnJvcihcIk5lbzRqIGRyaXZlciBub3QgaW5pdGlhbGl6ZWRcIik7XG4gIGNvbnN0IHNlc3Npb24gPSBuZW80akRyaXZlci5zZXNzaW9uKCk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBjb25zdHJhaW50cyA9IFtcbiAgICAgIFwiQ1JFQVRFIENPTlNUUkFJTlQgZW50aXR5X2lkIElGIE5PVCBFWElTVFMgRk9SIChlOkVudGl0eSkgUkVRVUlSRSBlLmlkIElTIFVOSVFVRVwiLFxuICAgICAgXCJDUkVBVEUgQ09OU1RSQUlOVCBlbnRpdHlfdXVpZCBJRiBOT1QgRVhJU1RTIEZPUiAoZTpFbnRpdHkpIFJFUVVJUkUgZS51dWlkIElTIFVOSVFVRVwiLFxuICAgICAgXCJDUkVBVEUgQ09OU1RSQUlOVCB1c2VyX2lkIElGIE5PVCBFWElTVFMgRk9SICh1OlVzZXIpIFJFUVVJUkUgdS5pZCBJUyBVTklRVUVcIixcbiAgICAgIFwiQ1JFQVRFIENPTlNUUkFJTlQgdXNlcl9lbWFpbCBJRiBOT1QgRVhJU1RTIEZPUiAodTpVc2VyKSBSRVFVSVJFIHUuZW1haWwgSVMgVU5JUVVFXCIsXG4gICAgICBcIkNSRUFURSBDT05TVFJBSU5UIGludmVzdGlnYXRpb25faWQgSUYgTk9UIEVYSVNUUyBGT1IgKGk6SW52ZXN0aWdhdGlvbikgUkVRVUlSRSBpLmlkIElTIFVOSVFVRVwiLFxuICAgICAgXCJDUkVBVEUgQ09OU1RSQUlOVCByZWxhdGlvbnNoaXBfaWQgSUYgTk9UIEVYSVNUUyBGT1IgKCktW3I6UkVMQVRJT05TSElQXS0oKSBSRVFVSVJFIHIuaWQgSVMgVU5JUVVFXCIsXG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgY29uc3RyYWludCBvZiBjb25zdHJhaW50cykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2Vzc2lvbi5ydW4oY29uc3RyYWludCk7XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGlmICghZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhcImFscmVhZHkgZXhpc3RzXCIpKSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgICAgICBcIkZhaWxlZCB0byBjcmVhdGUgY29uc3RyYWludDpcIixcbiAgICAgICAgICAgIGNvbnN0cmFpbnQsXG4gICAgICAgICAgICBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBpbmRleGVzID0gW1xuICAgICAgXCJDUkVBVEUgSU5ERVggZW50aXR5X3R5cGUgSUYgTk9UIEVYSVNUUyBGT1IgKGU6RW50aXR5KSBPTiAoZS50eXBlKVwiLFxuICAgICAgXCJDUkVBVEUgSU5ERVggZW50aXR5X2xhYmVsIElGIE5PVCBFWElTVFMgRk9SIChlOkVudGl0eSkgT04gKGUubGFiZWwpXCIsXG4gICAgICBcIkNSRUFURSBJTkRFWCBlbnRpdHlfY3JlYXRlZCBJRiBOT1QgRVhJU1RTIEZPUiAoZTpFbnRpdHkpIE9OIChlLmNyZWF0ZWRBdClcIixcbiAgICAgIFwiQ1JFQVRFIElOREVYIGludmVzdGlnYXRpb25fc3RhdHVzIElGIE5PVCBFWElTVFMgRk9SIChpOkludmVzdGlnYXRpb24pIE9OIChpLnN0YXR1cylcIixcbiAgICAgIFwiQ1JFQVRFIElOREVYIHVzZXJfdXNlcm5hbWUgSUYgTk9UIEVYSVNUUyBGT1IgKHU6VXNlcikgT04gKHUudXNlcm5hbWUpXCIsXG4gICAgICBcIkNSRUFURSBGVUxMVEVYVCBJTkRFWCBlbnRpdHlfc2VhcmNoIElGIE5PVCBFWElTVFMgRk9SIChlOkVudGl0eSkgT04gRUFDSCBbZS5sYWJlbCwgZS5kZXNjcmlwdGlvbl1cIixcbiAgICAgIFwiQ1JFQVRFIEZVTExURVhUIElOREVYIGludmVzdGlnYXRpb25fc2VhcmNoIElGIE5PVCBFWElTVFMgRk9SIChpOkludmVzdGlnYXRpb24pIE9OIEVBQ0ggW2kudGl0bGUsIGkuZGVzY3JpcHRpb25dXCIsXG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgaW5kZXggb2YgaW5kZXhlcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2Vzc2lvbi5ydW4oaW5kZXgpO1xuICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICBpZiAoIWVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoXCJhbHJlYWR5IGV4aXN0c1wiKSkge1xuICAgICAgICAgIGxvZ2dlci53YXJuKFwiRmFpbGVkIHRvIGNyZWF0ZSBpbmRleDpcIiwgaW5kZXgsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oXCJOZW80aiBjb25zdHJhaW50cyBhbmQgaW5kZXhlcyBjcmVhdGVkXCIpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBjcmVhdGUgTmVvNGogY29uc3RyYWludHM6XCIsIGVycm9yKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBzZXNzaW9uLmNsb3NlKCk7XG4gIH1cbn1cblxuLy8gUG9zdGdyZVNRTCBDb25uZWN0aW9uXG5hc3luYyBmdW5jdGlvbiBjb25uZWN0UG9zdGdyZXMoKTogUHJvbWlzZTxQb29sPiB7XG4gIHRyeSB7XG4gICAgcG9zdGdyZXNQb29sID0gbmV3IFBvb2woe1xuICAgICAgaG9zdDogY29uZmlnLnBvc3RncmVzLmhvc3QsXG4gICAgICBwb3J0OiBjb25maWcucG9zdGdyZXMucG9ydCxcbiAgICAgIGRhdGFiYXNlOiBjb25maWcucG9zdGdyZXMuZGF0YWJhc2UsXG4gICAgICB1c2VyOiBjb25maWcucG9zdGdyZXMudXNlcm5hbWUsXG4gICAgICBwYXNzd29yZDogY29uZmlnLnBvc3RncmVzLnBhc3N3b3JkLFxuICAgICAgbWF4OiAyMCxcbiAgICAgIGlkbGVUaW1lb3V0TWlsbGlzOiAzMDAwMCxcbiAgICAgIGNvbm5lY3Rpb25UaW1lb3V0TWlsbGlzOiAyMDAwLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2xpZW50ID0gYXdhaXQgcG9zdGdyZXNQb29sLmNvbm5lY3QoKTtcbiAgICBhd2FpdCBjbGllbnQucXVlcnkoXCJTRUxFQ1QgTk9XKClcIik7XG4gICAgY2xpZW50LnJlbGVhc2UoKTtcblxuICAgIGF3YWl0IGNyZWF0ZVBvc3RncmVzVGFibGVzKCk7XG5cbiAgICBsb2dnZXIuaW5mbyhcIuKchSBDb25uZWN0ZWQgdG8gUG9zdGdyZVNRTFwiKTtcbiAgICByZXR1cm4gcG9zdGdyZXNQb29sO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcihcIuKdjCBGYWlsZWQgdG8gY29ubmVjdCB0byBQb3N0Z3JlU1FMOlwiLCBlcnJvcik7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUG9zdGdyZXNUYWJsZXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGlmICghcG9zdGdyZXNQb29sKSB0aHJvdyBuZXcgRXJyb3IoXCJQb3N0Z3JlU1FMIHBvb2wgbm90IGluaXRpYWxpemVkXCIpO1xuICBjb25zdCBjbGllbnQgPSBhd2FpdCBwb3N0Z3Jlc1Bvb2wuY29ubmVjdCgpO1xuXG4gIHRyeSB7XG4gICAgLy8gVXNlcnMgdGFibGVcbiAgICBhd2FpdCBjbGllbnQucXVlcnkoYFxuICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdXNlcnMgKFxuICAgICAgICBpZCBVVUlEIFBSSU1BUlkgS0VZIERFRkFVTFQgZ2VuX3JhbmRvbV91dWlkKCksXG4gICAgICAgIGVtYWlsIFZBUkNIQVIoMjU1KSBVTklRVUUgTk9UIE5VTEwsXG4gICAgICAgIHVzZXJuYW1lIFZBUkNIQVIoMTAwKSBVTklRVUUgTk9UIE5VTEwsXG4gICAgICAgIHBhc3N3b3JkX2hhc2ggVkFSQ0hBUigyNTUpIE5PVCBOVUxMLFxuICAgICAgICBmaXJzdF9uYW1lIFZBUkNIQVIoMTAwKSBOT1QgTlVMTCxcbiAgICAgICAgbGFzdF9uYW1lIFZBUkNIQVIoMTAwKSBOT1QgTlVMTCxcbiAgICAgICAgcm9sZSBWQVJDSEFSKDUwKSBOT1QgTlVMTCBERUZBVUxUICdBTkFMWVNUJyxcbiAgICAgICAgaXNfYWN0aXZlIEJPT0xFQU4gREVGQVVMVCB0cnVlLFxuICAgICAgICBsYXN0X2xvZ2luIFRJTUVTVEFNUCxcbiAgICAgICAgY3JlYXRlZF9hdCBUSU1FU1RBTVAgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUCxcbiAgICAgICAgdXBkYXRlZF9hdCBUSU1FU1RBTVAgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUFxuICAgICAgKVxuICAgIGApO1xuXG4gICAgLy8gQXVkaXQgbG9ncyB0YWJsZVxuICAgIGF3YWl0IGNsaWVudC5xdWVyeShgXG4gICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBhdWRpdF9sb2dzIChcbiAgICAgICAgaWQgVVVJRCBQUklNQVJZIEtFWSBERUZBVUxUIGdlbl9yYW5kb21fdXVpZCgpLFxuICAgICAgICB1c2VyX2lkIFVVSUQgUkVGRVJFTkNFUyB1c2VycyhpZCksXG4gICAgICAgIGFjdGlvbiBWQVJDSEFSKDEwMCkgTk9UIE5VTEwsXG4gICAgICAgIHJlc291cmNlX3R5cGUgVkFSQ0hBUigxMDApIE5PVCBOVUxMLFxuICAgICAgICByZXNvdXJjZV9pZCBWQVJDSEFSKDI1NSksXG4gICAgICAgIGRldGFpbHMgSlNPTkIsXG4gICAgICAgIGlwX2FkZHJlc3MgSU5FVCxcbiAgICAgICAgdXNlcl9hZ2VudCBURVhULFxuICAgICAgICBjcmVhdGVkX2F0IFRJTUVTVEFNUCBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QXG4gICAgICApXG4gICAgYCk7XG5cbiAgICAvLyBTZXNzaW9ucyB0YWJsZVxuICAgIGF3YWl0IGNsaWVudC5xdWVyeShgXG4gICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB1c2VyX3Nlc3Npb25zIChcbiAgICAgICAgaWQgVVVJRCBQUklNQVJZIEtFWSBERUZBVUxUIGdlbl9yYW5kb21fdXVpZCgpLFxuICAgICAgICB1c2VyX2lkIFVVSUQgUkVGRVJFTkNFUyB1c2VycyhpZCkgT04gREVMRVRFIENBU0NBREUsXG4gICAgICAgIHJlZnJlc2hfdG9rZW4gVkFSQ0hBUig1MDApIFVOSVFVRSBOT1QgTlVMTCxcbiAgICAgICAgZXhwaXJlc19hdCBUSU1FU1RBTVAgTk9UIE5VTEwsXG4gICAgICAgIGNyZWF0ZWRfYXQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICAgIGxhc3RfdXNlZCBUSU1FU1RBTVAgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUFxuICAgICAgKVxuICAgIGApO1xuXG4gICAgLy8gQW5hbHlzaXMgcmVzdWx0cyB0YWJsZVxuICAgIGF3YWl0IGNsaWVudC5xdWVyeShgXG4gICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBhbmFseXNpc19yZXN1bHRzIChcbiAgICAgICAgaWQgVVVJRCBQUklNQVJZIEtFWSBERUZBVUxUIGdlbl9yYW5kb21fdXVpZCgpLFxuICAgICAgICBpbnZlc3RpZ2F0aW9uX2lkIFZBUkNIQVIoMjU1KSBOT1QgTlVMTCxcbiAgICAgICAgYW5hbHlzaXNfdHlwZSBWQVJDSEFSKDEwMCkgTk9UIE5VTEwsXG4gICAgICAgIGFsZ29yaXRobSBWQVJDSEFSKDEwMCkgTk9UIE5VTEwsXG4gICAgICAgIHJlc3VsdHMgSlNPTkIgTk9UIE5VTEwsXG4gICAgICAgIGNvbmZpZGVuY2Vfc2NvcmUgREVDSU1BTCgzLDIpLFxuICAgICAgICBjcmVhdGVkX2J5IFVVSUQgUkVGRVJFTkNFUyB1c2VycyhpZCksXG4gICAgICAgIGNyZWF0ZWRfYXQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVBcbiAgICAgIClcbiAgICBgKTtcblxuICAgIGF3YWl0IGNsaWVudC5xdWVyeShcbiAgICAgIFwiQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X2F1ZGl0X2xvZ3NfdXNlcl9pZCBPTiBhdWRpdF9sb2dzKHVzZXJfaWQpXCIsXG4gICAgKTtcbiAgICBhd2FpdCBjbGllbnQucXVlcnkoXG4gICAgICBcIkNSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9hdWRpdF9sb2dzX2NyZWF0ZWRfYXQgT04gYXVkaXRfbG9ncyhjcmVhdGVkX2F0KVwiLFxuICAgICk7XG4gICAgYXdhaXQgY2xpZW50LnF1ZXJ5KFxuICAgICAgXCJDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfc2Vzc2lvbnNfdXNlcl9pZCBPTiB1c2VyX3Nlc3Npb25zKHVzZXJfaWQpXCIsXG4gICAgKTtcbiAgICBhd2FpdCBjbGllbnQucXVlcnkoXG4gICAgICBcIkNSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9hbmFseXNpc19pbnZlc3RpZ2F0aW9uIE9OIGFuYWx5c2lzX3Jlc3VsdHMoaW52ZXN0aWdhdGlvbl9pZClcIixcbiAgICApO1xuXG4gICAgbG9nZ2VyLmluZm8oXCJQb3N0Z3JlU1FMIHRhYmxlcyBjcmVhdGVkXCIpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBjcmVhdGUgUG9zdGdyZVNRTCB0YWJsZXM6XCIsIGVycm9yKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBjbGllbnQucmVsZWFzZSgpO1xuICB9XG59XG5cbi8vIFJlZGlzIENvbm5lY3Rpb25cbmFzeW5jIGZ1bmN0aW9uIGNvbm5lY3RSZWRpcygpOiBQcm9taXNlPFJlZGlzIHwgbnVsbD4ge1xuICB0cnkge1xuICAgIGNvbnN0IHJlZGlzQ29uZmlnOiBhbnkgPSB7XG4gICAgICBob3N0OiBjb25maWcucmVkaXMuaG9zdCxcbiAgICAgIHBvcnQ6IGNvbmZpZy5yZWRpcy5wb3J0LFxuICAgICAgZGI6IGNvbmZpZy5yZWRpcy5kYixcbiAgICAgIHJldHJ5RGVsYXlPbkZhaWxvdmVyOiAxMDAsXG4gICAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdDogMyxcbiAgICAgIGNvbm5lY3RUaW1lb3V0OiAxMDAwMCxcbiAgICAgIGxhenlDb25uZWN0OiB0cnVlLFxuICAgICAga2VlcEFsaXZlOiAzMDAwMCxcbiAgICAgIGZhbWlseTogNCxcbiAgICAgIGVuYWJsZU9mZmxpbmVRdWV1ZTogZmFsc2UsXG4gICAgICByZWNvbm5lY3RPbkVycm9yOiAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgICBjb25zdCB0YXJnZXRFcnJvciA9IFwiUkVBRE9OTFlcIjtcbiAgICAgICAgcmV0dXJuIGVyci5tZXNzYWdlLmluY2x1ZGVzKHRhcmdldEVycm9yKTtcbiAgICAgIH0sXG4gICAgICByZXRyeVN0cmF0ZWd5OiAodGltZXM6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBkZWxheSA9IE1hdGgubWluKHRpbWVzICogNTAsIDIwMDApO1xuICAgICAgICByZXR1cm4gZGVsYXk7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICAvLyBBZGQgcGFzc3dvcmQgaWYgcHJvdmlkZWRcbiAgICBpZiAoY29uZmlnLnJlZGlzLnBhc3N3b3JkKSB7XG4gICAgICByZWRpc0NvbmZpZy5wYXNzd29yZCA9IGNvbmZpZy5yZWRpcy5wYXNzd29yZDtcbiAgICB9XG5cbiAgICByZWRpc0NsaWVudCA9IG5ldyBSZWRpcyhyZWRpc0NvbmZpZyk7XG5cbiAgICByZWRpc0NsaWVudC5vbihcImVycm9yXCIsIChlcnJvcikgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKFwiUmVkaXMgZXJyb3I6XCIsIGVycm9yLm1lc3NhZ2UpO1xuICAgIH0pO1xuXG4gICAgcmVkaXNDbGllbnQub24oXCJjb25uZWN0XCIsICgpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKFwiUmVkaXMgY29ubmVjdGVkXCIpO1xuICAgIH0pO1xuXG4gICAgcmVkaXNDbGllbnQub24oXCJyZWFkeVwiLCAoKSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbyhcIuKchSBSZWRpcyByZWFkeVwiKTtcbiAgICB9KTtcblxuICAgIHJlZGlzQ2xpZW50Lm9uKFwicmVjb25uZWN0aW5nXCIsICgpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKFwiUmVkaXMgcmVjb25uZWN0aW5nLi4uXCIpO1xuICAgIH0pO1xuXG4gICAgcmVkaXNDbGllbnQub24oXCJlbmRcIiwgKCkgPT4ge1xuICAgICAgbG9nZ2VyLndhcm4oXCJSZWRpcyBjb25uZWN0aW9uIGVuZGVkXCIpO1xuICAgIH0pO1xuXG4gICAgYXdhaXQgcmVkaXNDbGllbnQuY29ubmVjdCgpO1xuICAgIGF3YWl0IHJlZGlzQ2xpZW50LnBpbmcoKTtcblxuICAgIGxvZ2dlci5pbmZvKFwi4pyFIENvbm5lY3RlZCB0byBSZWRpc1wiKTtcbiAgICByZXR1cm4gcmVkaXNDbGllbnQ7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCLinYwgRmFpbGVkIHRvIGNvbm5lY3QgdG8gUmVkaXM6XCIsIGVycm9yLm1lc3NhZ2UpO1xuICAgIC8vIERvbid0IHRocm93IGVycm9yIHRvIGFsbG93IHNlcnZlciB0byBzdGFydCB3aXRob3V0IFJlZGlzIGlmIG5lZWRlZFxuICAgIGxvZ2dlci53YXJuKFwiU2VydmVyIHdpbGwgY29udGludWUgd2l0aG91dCBSZWRpcyBjYWNoaW5nXCIpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldE5lbzRqRHJpdmVyKCk6IERyaXZlciB7XG4gIGlmICghbmVvNGpEcml2ZXIpIHRocm93IG5ldyBFcnJvcihcIk5lbzRqIGRyaXZlciBub3QgaW5pdGlhbGl6ZWRcIik7XG4gIHJldHVybiBuZW80akRyaXZlcjtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zdGdyZXNQb29sKCk6IFBvb2wge1xuICBpZiAoIXBvc3RncmVzUG9vbCkgdGhyb3cgbmV3IEVycm9yKFwiUG9zdGdyZVNRTCBwb29sIG5vdCBpbml0aWFsaXplZFwiKTtcbiAgcmV0dXJuIHBvc3RncmVzUG9vbDtcbn1cblxuZnVuY3Rpb24gZ2V0UmVkaXNDbGllbnQoKTogUmVkaXMgfCBudWxsIHtcbiAgaWYgKCFyZWRpc0NsaWVudCkge1xuICAgIGxvZ2dlci53YXJuKFwiUmVkaXMgY2xpZW50IG5vdCBhdmFpbGFibGVcIik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcmV0dXJuIHJlZGlzQ2xpZW50O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjbG9zZUNvbm5lY3Rpb25zKCk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAobmVvNGpEcml2ZXIpIHtcbiAgICBhd2FpdCBuZW80akRyaXZlci5jbG9zZSgpO1xuICAgIGxvZ2dlci5pbmZvKFwiTmVvNGogY29ubmVjdGlvbiBjbG9zZWRcIik7XG4gIH1cbiAgaWYgKHBvc3RncmVzUG9vbCkge1xuICAgIGF3YWl0IHBvc3RncmVzUG9vbC5lbmQoKTtcbiAgICBsb2dnZXIuaW5mbyhcIlBvc3RncmVTUUwgY29ubmVjdGlvbiBjbG9zZWRcIik7XG4gIH1cbiAgaWYgKHJlZGlzQ2xpZW50KSB7XG4gICAgcmVkaXNDbGllbnQuZGlzY29ubmVjdCgpO1xuICAgIGxvZ2dlci5pbmZvKFwiUmVkaXMgY29ubmVjdGlvbiBjbG9zZWRcIik7XG4gIH1cbn1cblxuZXhwb3J0IHtcbiAgY29ubmVjdE5lbzRqLFxuICBjb25uZWN0UG9zdGdyZXMsXG4gIGNvbm5lY3RSZWRpcyxcbiAgZ2V0TmVvNGpEcml2ZXIsXG4gIGdldFBvc3RncmVzUG9vbCxcbiAgZ2V0UmVkaXNDbGllbnQsXG4gIGNsb3NlQ29ubmVjdGlvbnMsXG59O1xuIl0sInZlcnNpb24iOjN9