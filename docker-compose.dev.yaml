version: "3.9"
services:
  gateway:
    build:
      context: .
      dockerfile: apps/gateway/Dockerfile
    ports: [ "8080:8080" ]
    environment:
      FEATURE_LAC_ENFORCE: "true"
      COPILOT_NLQ: "true"
      UI_TRIPANE: "true"
      POLICY_COMPILER_URL: "http://policy-compiler:8080"
      OPA_DECISION_URL: "http://opa:8181/v1/data/policy/authz/abac/decision"
      TYPESENSE_HOST: "typesense"
      TYPESENSE_PORT: "8108"
      TYPESENSE_API_KEY: "xyz"
    depends_on:
      - policy-compiler
      - typesense

  ui:
    build: ./apps/ui
    ports: [ "3000:80" ]

  prov-ledger:
    build: ./services/prov-ledger
    ports: [ "8101:8080" ]

  policy-compiler:
    build: ./services/policy-compiler
    ports: [ "8102:8080" ]

  ai-nlq:
    build: ./services/ai-nlq
    ports: [ "8103:8080" ]

  er-service:
    build: ./services/er-service
    ports: [ "8104:8080" ]

  ingest:
    build: ./services/ingest
    ports: [ "8105:8080" ]

  zk-tx:
    build: ./services/zk-tx
    ports: [ "8106:8080" ]

  predictd:
    build:
      context: .
      dockerfile: services/predictd/Dockerfile
    ports:
      - "4001:4001"
    environment:
      - PREDICTD_PORT=4001

  typesense:
    image: typesense/typesense:0.25.2
    ports:
      - "8108:8108"
    environment:
      - TYPESENSE_DATA_DIR=/data
      - TYPESENSE_API_KEY=xyz
      - TYPESENSE_ENABLE_CORS=true
    volumes:
      - ./tmp/typesense-data:/data

  opa:
    image: openpolicyagent/opa:0.61.0
    ports:
      - "8181:8181"
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "/policies"
    volumes:
      - ./services/opa/policies:/policies
