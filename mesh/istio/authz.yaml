apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata: { name: web-jwt, namespace: prod }
spec:
  selector: { matchLabels: { app.kubernetes.io/name: web } }
  jwtRules:
    - issuer: https://auth.intelgraph
      audiences: [intelgraph]
      jwksUri: https://auth.intelgraph/.well-known/jwks.json
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata: { name: web-policy, namespace: prod }
spec:
  selector: { matchLabels: { app.kubernetes.io/name: web } }
  action: ALLOW
  rules:
    - from: [{ source: { principals: ['cluster.local/ns/prod/sa/api'] } }]
      when:
        - key: request.auth.claims[scope]
          values: ['read:web']
